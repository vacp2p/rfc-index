<!DOCTYPE HTML>
<html lang="en" class="ayu" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Vac RFC</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="custom.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('ayu')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="vac/index.html"><strong aria-hidden="true">1.</strong> Vac</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vac/1/coss.html"><strong aria-hidden="true">1.1.</strong> 1/COSS</a></li><li class="chapter-item expanded "><a href="vac/2/mvds.html"><strong aria-hidden="true">1.2.</strong> 2/MVDS</a></li><li class="chapter-item expanded "><a href="vac/3/remote-log.html"><strong aria-hidden="true">1.3.</strong> 3/Remote Log</a></li><li class="chapter-item expanded "><a href="vac/4/mvds-meta.html"><strong aria-hidden="true">1.4.</strong> 4/MVDS Meta</a></li><li class="chapter-item expanded "><a href="vac/25/libp2p-dns-discovery.html"><strong aria-hidden="true">1.5.</strong> 25/Libp2p DNS Discovery</a></li><li class="chapter-item expanded "><a href="vac/32/rln-v1.html"><strong aria-hidden="true">1.6.</strong> 32/RLN-V1</a></li><li class="chapter-item expanded "><a href="vac/raw/index.html"><strong aria-hidden="true">1.7.</strong> Raw</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vac/raw/consensus-hashgraphlike.html"><strong aria-hidden="true">1.7.1.</strong> Consensus Hashgraphlike</a></li><li class="chapter-item expanded "><a href="vac/raw/decentralized-messaging-ethereum.html"><strong aria-hidden="true">1.7.2.</strong> Decentralized Messaging Ethereum</a></li><li class="chapter-item expanded "><a href="vac/raw/eth-mls-offchain.html"><strong aria-hidden="true">1.7.3.</strong> ETH MLS Offchain</a></li><li class="chapter-item expanded "><a href="vac/raw/eth-mls-onchain.html"><strong aria-hidden="true">1.7.4.</strong> ETH MLS Onchain</a></li><li class="chapter-item expanded "><a href="vac/raw/deleted/eth-secpm.html"><strong aria-hidden="true">1.7.5.</strong> ETH SecPM</a></li><li class="chapter-item expanded "><a href="vac/raw/gossipsub-tor-push.html"><strong aria-hidden="true">1.7.6.</strong> Gossipsub Tor Push</a></li><li class="chapter-item expanded "><a href="vac/raw/logos-capability-discovery.html"><strong aria-hidden="true">1.7.7.</strong> Logos Capability Discovery</a></li><li class="chapter-item expanded "><a href="vac/raw/mix.html"><strong aria-hidden="true">1.7.8.</strong> Mix</a></li><li class="chapter-item expanded "><a href="vac/raw/noise-x3dh-double-ratchet.html"><strong aria-hidden="true">1.7.9.</strong> Noise X3DH Double Ratchet</a></li><li class="chapter-item expanded "><a href="vac/raw/rln-interep-spec.html"><strong aria-hidden="true">1.7.10.</strong> RLN Interep Spec</a></li><li class="chapter-item expanded "><a href="vac/raw/rln-stealth-commitments.html"><strong aria-hidden="true">1.7.11.</strong> RLN Stealth Commitments</a></li><li class="chapter-item expanded "><a href="vac/raw/rln-v2.html"><strong aria-hidden="true">1.7.12.</strong> RLN-V2</a></li><li class="chapter-item expanded "><a href="vac/raw/sds.html"><strong aria-hidden="true">1.7.13.</strong> SDS</a></li></ol></li><li class="chapter-item expanded "><a href="vac/template.html"><strong aria-hidden="true">1.8.</strong> Template</a></li></ol></li><li class="chapter-item expanded "><a href="waku/index.html"><strong aria-hidden="true">2.</strong> Waku</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="waku/standards/core/index.html"><strong aria-hidden="true">2.1.</strong> Standards - Core</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="waku/standards/core/10/waku2.html"><strong aria-hidden="true">2.1.1.</strong> 10/Waku2</a></li><li class="chapter-item expanded "><a href="waku/standards/core/11/relay.html"><strong aria-hidden="true">2.1.2.</strong> 11/Relay</a></li><li class="chapter-item expanded "><a href="waku/standards/core/12/filter.html"><strong aria-hidden="true">2.1.3.</strong> 12/Filter</a></li><li class="chapter-item expanded "><a href="waku/standards/core/13/store.html"><strong aria-hidden="true">2.1.4.</strong> 13/Store</a></li><li class="chapter-item expanded "><a href="waku/standards/core/14/message.html"><strong aria-hidden="true">2.1.5.</strong> 14/Message</a></li><li class="chapter-item expanded "><a href="waku/standards/core/15/bridge.html"><strong aria-hidden="true">2.1.6.</strong> 15/Bridge</a></li><li class="chapter-item expanded "><a href="waku/standards/core/17/rln-relay.html"><strong aria-hidden="true">2.1.7.</strong> 17/RLN Relay</a></li><li class="chapter-item expanded "><a href="waku/standards/core/19/lightpush.html"><strong aria-hidden="true">2.1.8.</strong> 19/Lightpush</a></li><li class="chapter-item expanded "><a href="waku/standards/core/31/enr.html"><strong aria-hidden="true">2.1.9.</strong> 31/ENR</a></li><li class="chapter-item expanded "><a href="waku/standards/core/33/discv5.html"><strong aria-hidden="true">2.1.10.</strong> 33/Discv5</a></li><li class="chapter-item expanded "><a href="waku/standards/core/34/peer-exchange.html"><strong aria-hidden="true">2.1.11.</strong> 34/Peer Exchange</a></li><li class="chapter-item expanded "><a href="waku/standards/core/36/bindings-api.html"><strong aria-hidden="true">2.1.12.</strong> 36/Bindings API</a></li><li class="chapter-item expanded "><a href="waku/standards/core/64/network.html"><strong aria-hidden="true">2.1.13.</strong> 64/Network</a></li><li class="chapter-item expanded "><a href="waku/standards/core/66/metadata.html"><strong aria-hidden="true">2.1.14.</strong> 66/Metadata</a></li></ol></li><li class="chapter-item expanded "><a href="waku/standards/application/index.html"><strong aria-hidden="true">2.2.</strong> Standards - Application</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="waku/standards/application/20/toy-eth-pm.html"><strong aria-hidden="true">2.2.1.</strong> 20/Toy ETH PM</a></li><li class="chapter-item expanded "><a href="waku/standards/application/26/payload.html"><strong aria-hidden="true">2.2.2.</strong> 26/Payload</a></li><li class="chapter-item expanded "><a href="waku/standards/application/53/x3dh.html"><strong aria-hidden="true">2.2.3.</strong> 53/X3DH</a></li><li class="chapter-item expanded "><a href="waku/standards/application/54/x3dh-sessions.html"><strong aria-hidden="true">2.2.4.</strong> 54/X3DH Sessions</a></li></ol></li><li class="chapter-item expanded "><a href="waku/standards/legacy/index.html"><strong aria-hidden="true">2.3.</strong> Standards - Legacy</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="waku/standards/legacy/6/waku1.html"><strong aria-hidden="true">2.3.1.</strong> 6/Waku1</a></li><li class="chapter-item expanded "><a href="waku/standards/legacy/7/data.html"><strong aria-hidden="true">2.3.2.</strong> 7/Data</a></li><li class="chapter-item expanded "><a href="waku/standards/legacy/8/mail.html"><strong aria-hidden="true">2.3.3.</strong> 8/Mail</a></li><li class="chapter-item expanded "><a href="waku/standards/legacy/9/rpc.html"><strong aria-hidden="true">2.3.4.</strong> 9/RPC</a></li></ol></li><li class="chapter-item expanded "><a href="waku/informational/index.html"><strong aria-hidden="true">2.4.</strong> Informational</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="waku/informational/22/toy-chat.html"><strong aria-hidden="true">2.4.1.</strong> 22/Toy Chat</a></li><li class="chapter-item expanded "><a href="waku/informational/23/topics.html"><strong aria-hidden="true">2.4.2.</strong> 23/Topics</a></li><li class="chapter-item expanded "><a href="waku/informational/27/peers.html"><strong aria-hidden="true">2.4.3.</strong> 27/Peers</a></li><li class="chapter-item expanded "><a href="waku/informational/29/config.html"><strong aria-hidden="true">2.4.4.</strong> 29/Config</a></li><li class="chapter-item expanded "><a href="waku/informational/30/adaptive-nodes.html"><strong aria-hidden="true">2.4.5.</strong> 30/Adaptive Nodes</a></li></ol></li><li class="chapter-item expanded "><a href="waku/deprecated/index.html"><strong aria-hidden="true">2.5.</strong> Deprecated</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="waku/deprecated/5/waku0.html"><strong aria-hidden="true">2.5.1.</strong> 5/Waku0</a></li><li class="chapter-item expanded "><a href="waku/deprecated/16/rpc.html"><strong aria-hidden="true">2.5.2.</strong> 16/RPC</a></li><li class="chapter-item expanded "><a href="waku/deprecated/18/swap.html"><strong aria-hidden="true">2.5.3.</strong> 18/Swap</a></li><li class="chapter-item expanded "><a href="waku/deprecated/fault-tolerant-store.html"><strong aria-hidden="true">2.5.4.</strong> Fault Tolerant Store</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="nomos/index.html"><strong aria-hidden="true">3.</strong> Nomos</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="nomos/raw/index.html"><strong aria-hidden="true">3.1.</strong> Raw</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="nomos/raw/nomosda-encoding.html"><strong aria-hidden="true">3.1.1.</strong> NomosDA Encoding</a></li><li class="chapter-item expanded "><a href="nomos/raw/nomosda-network.html"><strong aria-hidden="true">3.1.2.</strong> NomosDA Network</a></li><li class="chapter-item expanded "><a href="nomos/raw/p2p-hardware-requirements.html"><strong aria-hidden="true">3.1.3.</strong> P2P Hardware Requirements</a></li><li class="chapter-item expanded "><a href="nomos/raw/p2p-nat-solution.html"><strong aria-hidden="true">3.1.4.</strong> P2P NAT Solution</a></li><li class="chapter-item expanded "><a href="nomos/raw/p2p-network-bootstrapping.html"><strong aria-hidden="true">3.1.5.</strong> P2P Network Bootstrapping</a></li><li class="chapter-item expanded "><a href="nomos/raw/p2p-network.html"><strong aria-hidden="true">3.1.6.</strong> P2P Network</a></li><li class="chapter-item expanded "><a href="nomos/raw/sdp.html"><strong aria-hidden="true">3.1.7.</strong> SDP</a></li></ol></li><li class="chapter-item expanded "><a href="nomos/deprecated/index.html"><strong aria-hidden="true">3.2.</strong> Deprecated</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="nomos/deprecated/claro.html"><strong aria-hidden="true">3.2.1.</strong> Claro</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="codex/index.html"><strong aria-hidden="true">4.</strong> Codex</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="codex/raw/index.html"><strong aria-hidden="true">4.1.</strong> Raw</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="codex/raw/codex-block-exchange.html"><strong aria-hidden="true">4.1.1.</strong> Block Exchange</a></li><li class="chapter-item expanded "><a href="codex/raw/codex-marketplace.html"><strong aria-hidden="true">4.1.2.</strong> Marketplace</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="status/index.html"><strong aria-hidden="true">5.</strong> Status</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="status/24/curation.html"><strong aria-hidden="true">5.1.</strong> 24/Curation</a></li><li class="chapter-item expanded "><a href="status/28/featuring.html"><strong aria-hidden="true">5.2.</strong> 28/Featuring</a></li><li class="chapter-item expanded "><a href="status/55/1to1-chat.html"><strong aria-hidden="true">5.3.</strong> 55/1-to-1 Chat</a></li><li class="chapter-item expanded "><a href="status/56/communities.html"><strong aria-hidden="true">5.4.</strong> 56/Communities</a></li><li class="chapter-item expanded "><a href="status/61/community-history-service.html"><strong aria-hidden="true">5.5.</strong> 61/Community History Service</a></li><li class="chapter-item expanded "><a href="status/62/payloads.html"><strong aria-hidden="true">5.6.</strong> 62/Payloads</a></li><li class="chapter-item expanded "><a href="status/63/keycard-usage.html"><strong aria-hidden="true">5.7.</strong> 63/Keycard Usage</a></li><li class="chapter-item expanded "><a href="status/65/account-address.html"><strong aria-hidden="true">5.8.</strong> 65/Account Address</a></li><li class="chapter-item expanded "><a href="status/71/push-notification-server.html"><strong aria-hidden="true">5.9.</strong> 71/Push Notification Server</a></li><li class="chapter-item expanded "><a href="status/raw/index.html"><strong aria-hidden="true">5.10.</strong> Raw</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="status/raw/simple-scaling.html"><strong aria-hidden="true">5.10.1.</strong> Simple Scaling</a></li><li class="chapter-item expanded "><a href="status/raw/status-app-protocols.html"><strong aria-hidden="true">5.10.2.</strong> Status App Protocols</a></li><li class="chapter-item expanded "><a href="status/raw/status-mvds.html"><strong aria-hidden="true">5.10.3.</strong> Status MVDS</a></li><li class="chapter-item expanded "><a href="status/raw/url-data.html"><strong aria-hidden="true">5.10.4.</strong> URL Data</a></li><li class="chapter-item expanded "><a href="status/raw/url-scheme.html"><strong aria-hidden="true">5.10.5.</strong> URL Scheme</a></li></ol></li><li class="chapter-item expanded "><a href="status/deprecated/index.html"><strong aria-hidden="true">5.11.</strong> Deprecated</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="status/deprecated/3rd-party.html"><strong aria-hidden="true">5.11.1.</strong> 3rd Party</a></li><li class="chapter-item expanded "><a href="status/deprecated/account.html"><strong aria-hidden="true">5.11.2.</strong> Account</a></li><li class="chapter-item expanded "><a href="status/deprecated/client.html"><strong aria-hidden="true">5.11.3.</strong> Client</a></li><li class="chapter-item expanded "><a href="status/deprecated/dapp-browser-API-usage.html"><strong aria-hidden="true">5.11.4.</strong> Dapp Browser API Usage</a></li><li class="chapter-item expanded "><a href="status/deprecated/eips.html"><strong aria-hidden="true">5.11.5.</strong> EIPs</a></li><li class="chapter-item expanded "><a href="status/deprecated/ethereum-usage.html"><strong aria-hidden="true">5.11.6.</strong> Ethereum Usage</a></li><li class="chapter-item expanded "><a href="status/deprecated/group-chat.html"><strong aria-hidden="true">5.11.7.</strong> Group Chat</a></li><li class="chapter-item expanded "><a href="status/deprecated/IPFS-gateway-for-sticker-Pack.html"><strong aria-hidden="true">5.11.8.</strong> IPFS Gateway for Sticker Pack</a></li><li class="chapter-item expanded "><a href="status/deprecated/keycard-usage-for-wallet-and-chat-keys.html"><strong aria-hidden="true">5.11.9.</strong> Keycard Usage for Wallet and Chat Keys</a></li><li class="chapter-item expanded "><a href="status/deprecated/notifications.html"><strong aria-hidden="true">5.11.10.</strong> Notifications</a></li><li class="chapter-item expanded "><a href="status/deprecated/payloads.html"><strong aria-hidden="true">5.11.11.</strong> Payloads</a></li><li class="chapter-item expanded "><a href="status/deprecated/push-notification-server.html"><strong aria-hidden="true">5.11.12.</strong> Push Notification Server</a></li><li class="chapter-item expanded "><a href="status/deprecated/secure-transport.html"><strong aria-hidden="true">5.11.13.</strong> Secure Transport</a></li><li class="chapter-item expanded "><a href="status/deprecated/waku-mailserver.html"><strong aria-hidden="true">5.11.14.</strong> Waku Mailserver</a></li><li class="chapter-item expanded "><a href="status/deprecated/waku-usage.html"><strong aria-hidden="true">5.11.15.</strong> Waku Usage</a></li><li class="chapter-item expanded "><a href="status/deprecated/whisper-mailserver.html"><strong aria-hidden="true">5.11.16.</strong> Whisper Mailserver</a></li><li class="chapter-item expanded "><a href="status/deprecated/whisper-usage.html"><strong aria-hidden="true">5.11.17.</strong> Whisper Usage</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Vac RFC</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/vacp2p/rfc-index" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="vac-rfc-index"><a class="header" href="#vac-rfc-index">Vac RFC Index</a></h1>
<p>An IETF-style index of Vac-managed RFCs across Waku, Nomos, Codex, and Status. Use the filters below to jump straight to a specification.</p>
<div class="landing-hero">
  <div class="filter-row">
    <input id="rfc-search" type="search" placeholder="Search by number, title, status, project..." aria-label="Search RFCs">
    <div class="chips" id="status-chips">
      <span class="chip active" data-status="all" data-label="All">All</span>
      <span class="chip" data-status="stable" data-label="Stable">Stable</span>
      <span class="chip" data-status="draft" data-label="Draft">Draft</span>
      <span class="chip" data-status="raw" data-label="Raw">Raw</span>
      <span class="chip" data-status="deprecated" data-label="Deprecated">Deprecated</span>
      <span class="chip" data-status="deleted" data-label="Deleted">Deleted</span>
    </div>
  </div>
  <div class="filter-row">
    <div class="chips" id="project-chips">
      <span class="chip active" data-project="all" data-label="All projects">All projects</span>
      <span class="chip" data-project="vac" data-label="Vac">Vac</span>
      <span class="chip" data-project="waku" data-label="Waku">Waku</span>
      <span class="chip" data-project="status" data-label="Status">Status</span>
      <span class="chip" data-project="nomos" data-label="Nomos">Nomos</span>
      <span class="chip" data-project="codex" data-label="Codex">Codex</span>
    </div>
  </div>
  <div class="quick-links">
    <a href="./vac/1/coss.html">1/COSS (Process)</a>
    <a href="./vac/README.html">Vac index</a>
    <a href="./waku/README.html">Waku index</a>
    <a href="./status/README.html">Status index</a>
    <a href="./nomos/README.html">Nomos index</a>
    <a href="./codex/README.html">Codex index</a>
  </div>
</div>
<div class="results-row">
  <div id="results-count" class="results-count">Loading RFC index...</div>
  <div class="results-hint">Click a column to sort</div>
</div>
<div id="rfc-table-container" class="table-wrap"></div>
<noscript>
  <p class="noscript-note">JavaScript is required to load the RFC index table.</p>
</noscript>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vac-rfcs"><a class="header" href="#vac-rfcs">Vac RFCs</a></h1>
<p>Vac builds public good protocols for the decentralised web.
Vac acts as a custodian for the protocols that live in the RFC-Index repository.
With the goal of widespread adoption,
Vac will make sure the protocols adhere to a set of principles,
including but not limited to liberty, security, privacy, decentralisation and inclusivity.</p>
<p>To learn more, visit <a href="https://vac.dev/">Vac Research</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="1coss"><a class="header" href="#1coss">1/COSS</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Consensus-Oriented Specification System</td></tr>
<tr><th>Slug</th><td>1</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Category</th><td>Best Current Practice</td></tr>
<tr><th>Editor</th><td>Daniel Kaiser &lt;danielkaiser@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Oskar Thoren &lt;oskarth@titanproxy.com&gt;<br>Pieter Hintjens &lt;ph@imatix.com&gt;<br>André Rebentisch &lt;andre@openstandards.de&gt;<br>Alberto Barrionuevo &lt;abarrio@opentia.es&gt;<br>Chris Puttick &lt;chris.puttick@thehumanjourney.net&gt;<br>Yurii Rashkovskii &lt;yrashk@gmail.com&gt;<br>Jimmy Debe &lt;jimmy@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline"><a class="header" href="#timeline">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/1/coss.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/1/coss.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-11-04</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/dd397adc594c121ce3e10b7e81b5c2ed4818c0a6/vac/1/coss.md"><code>dd397ad</code></a> — Update Coss Date (#206)</li>
<li><strong>2024-10-09</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d5e0072498858c5d699ec091c41ae8961badcaee/vac/1/coss.md"><code>d5e0072</code></a> — cosmetic: fix external links in 1/COSS (#100)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/vac/1/coss.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-08-09</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/ed2c68f0722a88ec5781741e07bafc3920d1796a/vac/1/coss.md"><code>ed2c68f</code></a> — 1/COSS: New RFC Process (#4)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3eaccf93b593026f05c8bfc2dc3a9f5657398cd3/vac/1/coss.md"><code>3eaccf9</code></a> — Update and rename COSS.md to coss.md</li>
<li><strong>2024-01-30</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/990d940d92e3bbbfa41b1b57fbcbbea05d41834d/vac/1/COSS.md"><code>990d940</code></a> — Rename COSS.md to COSS.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/649507410e07e0d0a08f3122a625c86a12e38de0/vac/01/COSS.md"><code>6495074</code></a> — Rename vac/rfcs/01/README.md to vac/01/COSS.md</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/bab16a8463d343392f45defb79b6dddbe68eb636/vac/rfcs/01/README.md"><code>bab16a8</code></a> — Rename README.md to README.md</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/a9162f28df681781e9bc94b94e2b3a6425cf4428/vac/rfc/01/README.md"><code>a9162f2</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<p>This document describes a consensus-oriented specification system (COSS)
for building interoperable technical specifications.
COSS is based on a lightweight editorial process that
seeks to engage the widest possible range of interested parties and
move rapidly to consensus through working code.</p>
<p>This specification is based on <a href="https://github.com/unprotocols/rfc/blob/master/2/README.md">Unprotocols 2/COSS</a>,
used by the <a href="https://rfc.zeromq.org/">ZeromMQ</a> project.
It is equivalent except for some areas:</p>
<ul>
<li>recommending the use of a permissive licenses,
such as CC0 (with the exception of this document);</li>
<li>miscellaneous metadata, editor, and format/link updates;</li>
<li>more inheritance from the <a href="https://www.rfc-editor.org/rfc/rfc2026.txt">IETF Standards Process</a>,
e.g. using RFC categories: Standards Track, Informational, and Best Common Practice;</li>
<li>standards track specifications SHOULD
follow a specific structure that both streamlines editing,
and helps implementers to quickly comprehend the specification</li>
<li>specifications MUST feature a header providing specific meta information</li>
<li>raw specifications will not be assigned numbers</li>
<li>section explaining the <a href="https://free.technology/">IFT</a>
Request For Comments specification process managed by the Vac service department</li>
</ul>
<h2 id="license"><a class="header" href="#license">License</a></h2>
<p>Copyright (c) 2008-26 the Editor and Contributors.</p>
<p>This Specification is free software;
you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation;
either version 3 of the License, or (at your option) any later version.</p>
<p>This specification is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or
FITNESS FOR A PARTICULAR PURPOSE.
See the GNU General Public License for more details.</p>
<p>You should have received a copy of the GNU General Public License
along with this program;
if not, see <a href="http://www.gnu.org/licenses">gnu.org</a>.</p>
<h2 id="change-process"><a class="header" href="#change-process">Change Process</a></h2>
<p>This document is governed by the <a href="vac/1/./coss.html">1/COSS</a> (COSS).</p>
<h2 id="language"><a class="header" href="#language">Language</a></h2>
<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD",
"SHOULD NOT", "RECOMMENDED",  "MAY", and
"OPTIONAL" in this document are to be interpreted as described in
<a href="http://tools.ietf.org/html/rfc2119">RFC 2119</a>.</p>
<h2 id="goals"><a class="header" href="#goals">Goals</a></h2>
<p>The primary goal of COSS is to facilitate the process of writing, proving, and
improving new technical specifications.
A "technical specification" defines a protocol, a process, an API, a use of language,
a methodology, or any other aspect of a technical environment that
can usefully be documented for the purposes of technical or social interoperability.</p>
<p>COSS is intended to above all be economical and rapid,
so that it is useful to small teams with little time to spend on more formal processes.</p>
<p>Principles:</p>
<ul>
<li>We aim for rough consensus and running code; <a href="https://www.ietf.org/about/participate/tao/">inspired by the IETF Tao</a>.</li>
<li>Specifications are small pieces, made by small teams.</li>
<li>Specifications should have a clearly responsible editor.</li>
<li>The process should be visible, objective, and accessible to anyone.</li>
<li>The process should clearly separate experiments from solutions.</li>
<li>The process should allow deprecation of old specifications.</li>
</ul>
<p>Specifications should take minutes to explain, hours to design, days to write,
weeks to prove, months to become mature, and years to replace.
Specifications have no special status except that accorded by the community.</p>
<h2 id="architecture"><a class="header" href="#architecture">Architecture</a></h2>
<p>COSS is designed around fast, easy to use communications tools.
Primarily, COSS uses a wiki model for editing and publishing specifications texts.</p>
<ul>
<li>The <em>domain</em> is the conservancy for a set of specifications.</li>
<li>The <em>domain</em> is implemented as an Internet domain.</li>
<li>Each specification is a document together with references and attached resources.</li>
<li>A <em>sub-domain</em> is a initiative under a specific domain.</li>
</ul>
<p>Individuals can become members of the <em>domain</em>
by completing the necessary legal clearance.
The copyright, patent, and trademark policies of the domain must be clarified
in an Intellectual Property policy that applies to the domain.</p>
<p>Specifications exist as multiple pages, one page per version,
(discussed below in "Branching and Merging"),
which should be assigned URIs that MAY include an number identifier.</p>
<p>Thus, we refer to new specifications by specifying its domain,
its sub-domain and short name.
The syntax for a new specification reference is:</p>
<pre><code>&lt;domain&gt;/&lt;sub-domain&gt;/&lt;shortname&gt;
</code></pre>
<p>For example, this specification should be <strong>rfc.vac.dev/vac/COSS</strong>,
if the status were <strong>raw</strong>.</p>
<p>A number will be assigned to the specification when obtaining <strong>draft</strong> status.
New versions of the same specification will be assigned a new number.
The syntax for a specification reference is:</p>
<pre><code>&lt;domain&gt;/&lt;sub-domain&gt;/&lt;number&gt;/&lt;shortname&gt;
</code></pre>
<p>For example, this specification is <strong>rfc.vac.dev/vac/1/COSS</strong>.
The short form <strong>1/COSS</strong> may be used when referring to the specification
from other specifications in the same domain.</p>
<p>Specifications (excluding raw specifications)
carries a different number including branches.</p>
<h2 id="coss-lifecycle"><a class="header" href="#coss-lifecycle">COSS Lifecycle</a></h2>
<p>Every specification has an independent lifecycle that
documents clearly its current status.
For a specification to receive a lifecycle status,
a new specification SHOULD be presented by the team of the sub-domain.
After discussion amongst the contributors has reached a rough consensus,
as described in <a href="https://www.rfc-editor.org/rfc/rfc7282.html">RFC7282</a>,
the specification MAY begin the process to upgrade it's status.</p>
<p>A specification has five possible states that reflect its maturity and
contractual weight:</p>
<p><img src="vac/1/./images/lifecycle.png" alt="Lifecycle diagram" /></p>
<h3 id="raw-specifications"><a class="header" href="#raw-specifications">Raw Specifications</a></h3>
<p>All new specifications are <strong>raw</strong> specifications.
Changes to raw specifications can be unilateral and arbitrary.
A sub-domain MAY use the <strong>raw</strong> status for new specifications
that live under their domain.
Raw specifications have no contractual weight.</p>
<h3 id="draft-specifications"><a class="header" href="#draft-specifications">Draft Specifications</a></h3>
<p>When raw specifications can be demonstrated,
they become <strong>draft</strong> specifications and are assigned numbers.
Changes to draft specifications should be done in consultation with users.
Draft specifications are contracts between the editors and implementers.</p>
<h3 id="stable-specifications"><a class="header" href="#stable-specifications">Stable Specifications</a></h3>
<p>When draft specifications are used by third parties, they become <strong>stable</strong> specifications.
Changes to stable specifications should be restricted to cosmetic ones,
errata and clarifications.
Stable specifications are contracts between editors, implementers, and end-users.</p>
<h3 id="deprecated-specifications"><a class="header" href="#deprecated-specifications">Deprecated Specifications</a></h3>
<p>When stable specifications are replaced by newer draft specifications,
they become <strong>deprecated</strong> specifications.
Deprecated specifications should not be changed except
to indicate their replacements, if any.
Deprecated specifications are contracts between editors, implementers and end-users.</p>
<h3 id="retired-specifications"><a class="header" href="#retired-specifications">Retired Specifications</a></h3>
<p>When deprecated specifications are no longer used in products,
they become <strong>retired</strong> specifications.
Retired specifications are part of the historical record.
They should not be changed except to indicate their replacements, if any.
Retired specifications have no contractual weight.</p>
<h3 id="deleted-specifications"><a class="header" href="#deleted-specifications">Deleted Specifications</a></h3>
<p>Deleted specifications are those that have not reached maturity (stable) and
were discarded.
They should not be used and are only kept for their historical value.
Only Raw and Draft specifications can be deleted.</p>
<h2 id="editorial-control"><a class="header" href="#editorial-control">Editorial control</a></h2>
<p>A specification MUST have a single responsible editor,
the only person who SHALL change the status of the specification
through the lifecycle stages.</p>
<p>A specification MAY also have additional contributors who contribute changes to it.
It is RECOMMENDED to use a process similar to <a href="https://github.com/unprotocols/rfc/blob/master/1/README.md">C4 process</a>
to maximize the scale and diversity of contributions.</p>
<p>Unlike the original C4 process however,
it is RECOMMENDED to use CC0 as a more permissive license alternative.
We SHOULD NOT use GPL or GPL-like license.
One exception is this specification, as this was the original license for this specification.</p>
<p>The editor is responsible for accurately maintaining the state of specifications,
for retiring different versions that may live in other places and
for handling all comments on the specification.</p>
<h2 id="branching-and-merging"><a class="header" href="#branching-and-merging">Branching and Merging</a></h2>
<p>Any member of the domain MAY branch a specification at any point.
This is done by copying the existing text, and
creating a new specification with the same name and content, but a new number.
Since <strong>raw</strong> specifications are not assigned a number,
branching by any member of a sub-domain MAY differentiate specifications
based on date, contributors, or
version number within the document.
The ability to branch a specification is necessary in these circumstances:</p>
<ul>
<li>To change the responsible editor for a specification,
with or without the cooperation of the current responsible editor.</li>
<li>To rejuvenate a specification that is stable but needs functional changes.
This is the proper way to make a new version of a specification
that is in stable or deprecated status.</li>
<li>To resolve disputes between different technical opinions.</li>
</ul>
<p>The responsible editor of a branched specification is the person who makes the branch.</p>
<p>Branches, including added contributions, are derived works and
thus licensed under the same terms as the original specification.
This means that contributors are guaranteed the right to merge changes made in branches
back into their original specifications.</p>
<p>Technically speaking, a branch is a <em>different</em> specification,
even if it carries the same name.
Branches have no special status except that accorded by the community.</p>
<h2 id="conflict-resolution"><a class="header" href="#conflict-resolution">Conflict resolution</a></h2>
<p>COSS resolves natural conflicts between teams and
vendors by allowing anyone to define a new specification.
There is no editorial control process except
that practised by the editor of a new specification.
The administrators of a domain (moderators)
may choose to interfere in editorial conflicts,
and may suspend or ban individuals for behaviour they consider inappropriate.</p>
<h2 id="specification-structure"><a class="header" href="#specification-structure">Specification Structure</a></h2>
<h3 id="meta-information"><a class="header" href="#meta-information">Meta Information</a></h3>
<p>Specifications MUST contain the following metadata.
It is RECOMMENDED that specification metadata is specified as a YAML header
(where possible).
This will enable programmatic access to specification metadata.</p>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Value</th><th>Type</th><th>Example</th></tr></thead><tbody>
<tr><td><strong>shortname</strong></td><td>short name</td><td>string</td><td>1/COSS</td></tr>
<tr><td><strong>title</strong></td><td>full name</td><td>string</td><td>Consensus-Oriented Specification System</td></tr>
<tr><td><strong>status</strong></td><td>status</td><td>string</td><td>draft</td></tr>
<tr><td><strong>category</strong></td><td>category</td><td>string</td><td>Best Current Practice</td></tr>
<tr><td><strong>tags</strong></td><td>0 or several tags</td><td>list</td><td>waku-application, waku-core-protocol</td></tr>
<tr><td><strong>editor</strong></td><td>editor name/email</td><td>string</td><td>Oskar Thoren <a href="mailto:vac/1/oskarth@titanproxy.com">oskarth@titanproxy.com</a></td></tr>
<tr><td><strong>contributors</strong></td><td>contributors</td><td>list</td><td>- Pieter Hintjens <a href="mailto:vac/1/ph@imatix.com">ph@imatix.com</a> - André Rebentisch <a href="mailto:vac/1/andre@openstandards.de">andre@openstandards.de</a> - Alberto Barrionuevo <a href="mailto:vac/1/abarrio@opentia.es">abarrio@opentia.es</a> - Chris Puttick <a href="mailto:vac/1/chris.puttick@thehumanjourney.net">chris.puttick@thehumanjourney.net</a> - Yurii Rashkovskii <a href="mailto:vac/1/yrashk@gmail.com">yrashk@gmail.com</a></td></tr>
</tbody></table>
</div>
<h3 id="iftvac-rfc-process"><a class="header" href="#iftvac-rfc-process">IFT/Vac RFC Process</a></h3>
<blockquote>
<p>[!Note]
This section is introduced to allow contributors to understand the IFT
(Institute of Free Technology) Vac RFC specification process.
Other organizations may make changes to this section according to their needs.</p>
</blockquote>
<p>Vac is a department under the IFT organization that provides RFC (Request For Comments)
specification services.
This service works to help facilitate the RFC process, assuring standards are followed.
Contributors within the service SHOULD assist a <em>sub-domain</em> in creating a new specification,
editing a specification, and
promoting the status of a specification along with other tasks.
Once a specification reaches some level of maturity by rough consensus,
the specification SHOULD enter the <a href="https://rfc.vac.dev/">Vac RFC</a> process.
Similar to the IETF working group adoption described in <a href="https://www.rfc-editor.org/rfc/rfc6174.html">RFC6174</a>,
the Vac RFC process SHOULD facilitate all updates to the specification.</p>
<p>Specifications are introduced by projects,
under a specific <em>domain</em>, with the intention of becoming technically mature documents.
The IFT domain currently houses the following projects:</p>
<ul>
<li><a href="https://status.app/">Status</a></li>
<li><a href="https://waku.org/">Waku</a></li>
<li><a href="https://codex.storage/">Codex</a></li>
<li><a href="https://nimbus.team/">Nimbus</a></li>
<li><a href="https://nomos.tech/">Nomos</a></li>
</ul>
<p>When a specification is promoted to <em>draft</em> status,
the number that is assigned MAY be incremental
or by the <em>sub-domain</em> and the Vac RFC process.
Standards track specifications MUST be based on the
<a href="vac/1/../template.html">Vac RFC template</a> before obtaining a new status.
All changes, comments, and contributions SHOULD be documented.</p>
<h2 id="conventions"><a class="header" href="#conventions">Conventions</a></h2>
<p>Where possible editors and contributors are encouraged to:</p>
<ul>
<li>Refer to and build on existing work when possible, especially IETF specifications.</li>
<li>Contribute to existing specifications rather than reinvent their own.</li>
<li>Use collaborative branching and merging as a tool for experimentation.</li>
<li>Use Semantic Line Breaks: <a href="https://sembr.org/">sembr</a>.</li>
</ul>
<h2 id="appendix-a-color-coding"><a class="header" href="#appendix-a-color-coding">Appendix A. Color Coding</a></h2>
<p>It is RECOMMENDED to use color coding to indicate specification's status.
Color coded specifications SHOULD use the following color scheme:</p>
<ul>
<li><img src="https://raw.githubusercontent.com/unprotocols/rfc/master/2/raw.svg" alt="raw" /></li>
<li><img src="https://raw.githubusercontent.com/unprotocols/rfc/master/2/draft.svg" alt="draft" /></li>
<li><img src="https://raw.githubusercontent.com/unprotocols/rfc/master/2/stable.svg" alt="stable" /></li>
<li><img src="https://raw.githubusercontent.com/unprotocols/rfc/master/2/deprecated.svg" alt="deprecated" /></li>
<li><img src="https://raw.githubusercontent.com/unprotocols/rfc/master/2/retired.svg" alt="retired" /></li>
<li><img src="https://raw.githubusercontent.com/unprotocols/rfc/master/2/deleted.svg" alt="deleted" /></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="2mvds"><a class="header" href="#2mvds">2/MVDS</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Minimum Viable Data Synchronization</td></tr>
<tr><th>Slug</th><td>2</td></tr>
<tr><th>Status</th><td>stable</td></tr>
<tr><th>Editor</th><td>Sanaz Taheri &lt;sanaz@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Dean Eigenmann &lt;dean@status.im&gt;<br>Oskar Thorén &lt;oskarth@titanproxy.com&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-1"><a class="header" href="#timeline-1">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/2/mvds.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/2/mvds.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/vac/2/mvds.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-06-28</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/a5b24ac0a27da361312260f9da372a0e6e812212/vac/2/mvds.md"><code>a5b24ac</code></a> — fix_: broken image links (#81)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/0253d534ffa9b7994cf0c6c31a5591309dc336d3/vac/2/mvds.md"><code>0253d53</code></a> — Rename MVDS.md to mvds.md</li>
<li><strong>2024-01-30</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/70326d135bf660f2ec171aeba9eacd51eaadcd6b/vac/2/MVDS.md"><code>70326d1</code></a> — Rename MVDS.md to MVDS.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/472a7fd440882c195898d025c14357d875db6ff3/vac/02/MVDS.md"><code>472a7fd</code></a> — Rename vac/rfcs/02/README.md to vac/02/MVDS.md</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/4362a7b221ceb4e1f1a82536f350c8e77d8f03d4/vac/rfcs/02/README.md"><code>4362a7b</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<p>In this specification, we describe a minimum viable protocol for
data synchronization inspired by the Bramble Synchronization Protocol (<a href="https://code.briarproject.org/briar/briar-spec/blob/master/protocols/BSP.md">BSP</a>).
This protocol is designed to ensure reliable messaging
between peers across an unreliable peer-to-peer (P2P) network where
they may be unreachable or unresponsive.</p>
<p>We present a reference implementation<sup class="footnote-reference"><a href="#2">1</a></sup>
including a simulation to demonstrate its performance.</p>
<h2 id="definitions"><a class="header" href="#definitions">Definitions</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Term</th><th>Description</th></tr></thead><tbody>
<tr><td><strong>Peer</strong></td><td>The other nodes that a node is connected to.</td></tr>
<tr><td><strong>Record</strong></td><td>Defines a payload element of either the type <code>OFFER</code>, <code>REQUEST</code>, <code>MESSAGE</code> or <code>ACK</code></td></tr>
<tr><td><strong>Node</strong></td><td>Some process that is able to store data, do processing and communicate for MVDS.</td></tr>
</tbody></table>
</div>
<h2 id="wire-protocol"><a class="header" href="#wire-protocol">Wire Protocol</a></h2>
<h3 id="secure-transport"><a class="header" href="#secure-transport">Secure Transport</a></h3>
<p>This specification does not define anything related to the transport of packets.
It is assumed that this is abstracted in such a way that
any secure transport protocol could be easily implemented.
Likewise, properties such as confidentiality, integrity, authenticity and
forward secrecy are assumed to be provided by a layer below.</p>
<h3 id="payloads"><a class="header" href="#payloads">Payloads</a></h3>
<p>Payloads are implemented using <a href="https://developers.google.com/protocol-buffers/">protocol buffers v3</a>.</p>
<pre><code class="language-protobuf">syntax = "proto3";

package vac.mvds;

message Payload {
  repeated bytes acks = 5001;
  repeated bytes offers = 5002;
  repeated bytes requests = 5003;
  repeated Message messages = 5004;
}

message Message {
  bytes group_id = 6001;
  int64 timestamp = 6002;
  bytes body = 6003;
}
</code></pre>
<p><em>The payload field numbers are kept more "unique" to</em>
<em>ensure no overlap with other protocol buffers.</em></p>
<p>Each payload contains the following fields:</p>
<ul>
<li><strong>Acks:</strong> This field contains a list (can be empty)
of <code>message identifiers</code> informing the recipient that sender holds a specific message.</li>
<li><strong>Offers:</strong> This field contains a list (can be empty)
of <code>message identifiers</code> that the sender would like to give to the recipient.</li>
<li><strong>Requests:</strong> This field contains a list (can be empty)
of <code>message identifiers</code> that the sender would like to receive from the recipient.</li>
<li><strong>Messages:</strong> This field contains a list of messages (can be empty).</li>
</ul>
<p><strong>Message Identifiers:</strong> Each <code>message</code> has a message identifier calculated by
hashing the <code>group_id</code>, <code>timestamp</code> and <code>body</code> fields as follows:</p>
<pre><code class="language-js">HASH("MESSAGE_ID", group_id, timestamp, body);
</code></pre>
<p><strong>Group Identifiers:</strong> Each <code>message</code> is assigned into a <strong>group</strong>
using the <code>group_id</code> field,
groups are independent synchronization contexts between peers.</p>
<p>The current <code>HASH</code> function used is <code>sha256</code>.</p>
<h2 id="synchronization"><a class="header" href="#synchronization">Synchronization</a></h2>
<h3 id="state"><a class="header" href="#state">State</a></h3>
<p>We refer to <code>state</code> as set of records for the types <code>OFFER</code>, <code>REQUEST</code> and
<code>MESSAGE</code> that every node SHOULD store per peer.
<code>state</code> MUST NOT contain <code>ACK</code> records as we do not retransmit those periodically.
The following information is stored for records:</p>
<ul>
<li><strong>Type</strong> - Either <code>OFFER</code>, <code>REQUEST</code> or <code>MESSAGE</code></li>
<li><strong>Send Count</strong> - The amount of times a record has been sent to a peer.</li>
<li><strong>Send Epoch</strong> - The next epoch at which a record can be sent to a peer.</li>
</ul>
<h3 id="flow"><a class="header" href="#flow">Flow</a></h3>
<p>A maximum of one payload SHOULD be sent to peers per epoch,
this payload contains all <code>ACK</code>, <code>OFFER</code>, <code>REQUEST</code> and
<code>MESSAGE</code> records for the specific peer.
Payloads are created every epoch,
containing reactions to previously received records by peers or
new records being sent out by nodes.</p>
<p>Nodes MAY have two modes with which they can send records:
<code>BATCH</code> and <code>INTERACTIVE</code> mode.
The following rules dictate how nodes construct payloads
every epoch for any given peer for both modes.</p>
<blockquote>
<p><em><strong>NOTE:</strong> A node may send messages both in interactive and in batch mode.</em></p>
</blockquote>
<h4 id="interactive-mode"><a class="header" href="#interactive-mode">Interactive Mode</a></h4>
<ul>
<li>A node initially offers a <code>MESSAGE</code> when attempting to send it to a peer.
This means an <code>OFFER</code> is added to the next payload and state for the given peer.</li>
<li>When a node receives an <code>OFFER</code>, a <code>REQUEST</code> is added to the next payload and
state for the given peer.</li>
<li>When a node receives a <code>REQUEST</code> for a previously sent <code>OFFER</code>,
the <code>OFFER</code> is removed from the state and
the corresponding <code>MESSAGE</code> is added to the next payload and
state for the given peer.</li>
<li>When a node receives a <code>MESSAGE</code>, the <code>REQUEST</code> is removed from the state and
an <code>ACK</code> is added to the next payload for the given peer.</li>
<li>When a node receives an <code>ACK</code>,
the <code>MESSAGE</code> is removed from the state for the given peer.</li>
<li>All records that require retransmission are added to the payload,
given <code>Send Epoch</code> has been reached.</li>
</ul>
<p><img src="vac/2/./images/interactive.png" alt="notification" /></p>
<p>Figure 1: Delivery without retransmissions in interactive mode.</p>
<h4 id="batch-mode"><a class="header" href="#batch-mode">Batch Mode</a></h4>
<ol>
<li>When a node sends a <code>MESSAGE</code>,
it is added to the next payload and the state for the given peer.</li>
<li>When a node receives a <code>MESSAGE</code>,
an <code>ACK</code> is added to the next payload for the corresponding peer.</li>
<li>When a node receives an <code>ACK</code>,
the <code>MESSAGE</code> is removed from the state for the given peer.</li>
<li>All records that require retransmission are added to the payload,
given <code>Send Epoch</code> has been reached.</li>
</ol>
<!-- diagram -->
<p><img src="vac/2/./images/batch.png" alt="notification" /></p>
<p>Figure 2: Delivery without retransmissions in batch mode.</p>
<blockquote>
<p><em><strong>NOTE:</strong> Batch mode is higher bandwidth whereas interactive mode is higher latency.</em></p>
</blockquote>
<!-- Interactions with state, flow chart with retransmissions? -->
<h3 id="retransmission"><a class="header" href="#retransmission">Retransmission</a></h3>
<p>The record of the type <code>Type</code> SHOULD be retransmitted
every time <code>Send Epoch</code> is smaller than or equal to the current epoch.</p>
<p><code>Send Epoch</code> and <code>Send Count</code> MUST be increased every time a record is retransmitted.
Although no function is defined on how to increase <code>Send Epoch</code>,
it SHOULD be exponentially increased until reaching an upper bound
where it then goes back to a lower epoch in order to
prevent a record's <code>Send Epoch</code>'s from becoming too large.</p>
<blockquote>
<p><em><strong>NOTE:</strong> We do not retransmission <code>ACK</code>s as we do not know when they have arrived,
therefore we simply resend them every time we receive a <code>MESSAGE</code>.</em></p>
</blockquote>
<h2 id="formal-specification"><a class="header" href="#formal-specification">Formal Specification</a></h2>
<p>MVDS has been formally specified using TLA+: <a href="https://github.com/vacp2p/formalities/tree/master/MVDS">https://github.com/vacp2p/formalities/tree/master/MVDS</a>.</p>
<h2 id="acknowledgments"><a class="header" href="#acknowledgments">Acknowledgments</a></h2>
<ul>
<li>Preston van Loon</li>
<li>Greg Markou</li>
<li>Rene Nayman</li>
<li>Jacek Sieka</li>
</ul>
<h2 id="copyright"><a class="header" href="#copyright">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="footnotes"><a class="header" href="#footnotes">Footnotes</a></h2>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">1</sup>
<p><a href="https://github.com/vacp2p/mvds">https://github.com/vacp2p/mvds</a></p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="3remote-log"><a class="header" href="#3remote-log">3/REMOTE-LOG</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Remote log specification</td></tr>
<tr><th>Slug</th><td>3</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Oskar Thorén &lt;oskarth@titanproxy.com&gt;</td></tr>
<tr><th>Contributors</th><td>Dean Eigenmann &lt;dean@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-2"><a class="header" href="#timeline-2">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/3/remote-log.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/3/remote-log.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/vac/3/remote-log.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3fd8b5ac65996eb49a0da2a1e232678727c09a75/vac/3/remote-log.md"><code>3fd8b5a</code></a> — Update and rename README.md to remote-log.md</li>
<li><strong>2024-01-30</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/dce61fe029550810b83b075145e8a0130048344b/vac/3/README.md"><code>dce61fe</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<p>A remote log is a replication of a local log.
This means a node can read data that originally came from a node that is offline.</p>
<p>This specification is complemented by a proof of concept implementation<sup class="footnote-reference"><a href="#1">1</a></sup>.</p>
<h2 id="definitions-1"><a class="header" href="#definitions-1">Definitions</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Term</th><th>Definition</th></tr></thead><tbody>
<tr><td>CAS</td><td>Content-addressed storage. Stores data that can be addressed by its hash.</td></tr>
<tr><td>NS</td><td>Name system. Associates mutable data to a name.</td></tr>
<tr><td>Remote log</td><td>Replication of a local log at a different location.</td></tr>
</tbody></table>
</div>
<h2 id="wire-protocol-1"><a class="header" href="#wire-protocol-1">Wire Protocol</a></h2>
<h3 id="secure-transport-storage-and-name-system"><a class="header" href="#secure-transport-storage-and-name-system">Secure Transport, storage, and name system</a></h3>
<p>This specification does not define anything related to: secure transport,
content addressed storage, or the name system. It is assumed these capabilities
are abstracted away in such a way that any such protocol can easily be
implemented.</p>
<!-- TODO: Elaborate on properties required here. -->
<h3 id="payloads-1"><a class="header" href="#payloads-1">Payloads</a></h3>
<p>Payloads are implemented using <a href="https://developers.google.com/protocol-buffers/">protocol buffers v3</a>.</p>
<p><strong>CAS service</strong>:</p>
<pre><code class="language-protobuf">syntax = "proto3";

package vac.cas;

service CAS {
  rpc Add(Content) returns (Address) {}
  rpc Get(Address) returns (Content) {}
}

message Address {
  bytes id = 1;
}

message Content {
  bytes data = 1;
}
</code></pre>
<!-- XXX/TODO: Can we get rid of the id/data complication and just use bytes? -->
<p><strong>NS service</strong>:</p>
<pre><code class="language-protobuf">syntax = "proto3";

package vac.cas;

service NS {
  rpc Update(NameUpdate) returns (Response) {}
  rpc Fetch(Query) returns (Content) {}
}

message NameUpdate {
  string name = 1;
  bytes content = 2;
}

message Query {
  string name = 1;
}

message Content {
  bytes data = 1;
}

message Response {
  bytes data = 1;
}
</code></pre>
<!-- XXX: Response and data type a bit weird, Ok/Err enum? -->
<!-- TODO: Do we want NameInit here? -->
<p><strong>Remote log:</strong></p>
<pre><code class="language-protobuf">syntax = "proto3";

package vac.cas;

message RemoteLog {
  repeated Pair pair = 1;
  bytes tail = 2;

  message Pair {
    bytes remoteHash = 1;
    bytes localHash = 2;
    bytes data = 3;
  }
}
</code></pre>
<!-- TODO: Better name for Pair, Mapping? -->
<!-- TODO: Consider making more useful in conjunction with metadata field.
It makes sense to explicitly list what sequence a message is <local hash,
remote hash, data, seqid> this way I can easily sync a messages prior or
after a specific number.
To enable this to be dynamic it might make sense to add page info so
that I am aware which page I can find seqid on -->
<h2 id="synchronization-1"><a class="header" href="#synchronization-1">Synchronization</a></h2>
<h3 id="roles"><a class="header" href="#roles">Roles</a></h3>
<p>There are four fundamental roles:</p>
<ol>
<li>Alice</li>
<li>Bob</li>
<li>Name system (NS)</li>
<li>Content-addressed storage (CAS)</li>
</ol>
<p>The <em>remote log</em> protobuf is what is stored in the name system.</p>
<p>"Bob" can represent anything from 0 to N participants. Unlike Alice,
Bob only needs read-only access to NS and CAS.</p>
<!-- TODO: Document random node as remote log -->
<!-- TODO: Document how to find initial remote log (e.g. per sync contexts -->
<h3 id="flow-1"><a class="header" href="#flow-1">Flow</a></h3>
<!-- diagram -->
<p><img src="vac/3/./images/remote-log.png" alt="notification" /></p>
<!-- Document the flow wrt operations -->
<h3 id="remote-log"><a class="header" href="#remote-log">Remote log</a></h3>
<p>The remote log lets receiving nodes know what data they are missing. Depending
on the specific requirements and capabilities of the nodes and name system, the
information can be referred to differently. We distinguish between three rough
modes:</p>
<ol>
<li>Fully replicated log</li>
<li>Normal sized page with CAS mapping</li>
<li>"Linked list" mode - minimally sized page with CAS mapping</li>
</ol>
<p><strong>Data format:</strong></p>
<pre><code class="language-yaml">| H1_3 | H2_3 |
| H1_2 | H2_2 |
| H1_1 | H2_1 |
| ------------|
| next_page   |
</code></pre>
<p>Here the upper section indicates a list of ordered pairs, and the lower section
contains the address for the next page chunk. <code>H1</code> is the native hash function,
and <code>H2</code> is the one used by the CAS. The numbers corresponds to the messages.</p>
<p>To indicate which CAS is used, a remote log SHOULD use a multiaddr.</p>
<p><strong>Embedded data:</strong></p>
<p>A remote log MAY also choose to embed the wire payloads that corresponds to the
native hash. This bypasses the need for a dedicated CAS and additional
round-trips, with a trade-off in bandwidth usage.</p>
<pre><code class="language-yaml">| H1_3 | | C_3 |
| H1_2 | | C_2 |
| H1_1 | | C_1 |
| -------------|
| next_page    |
</code></pre>
<p>Here <code>C</code> stands for the content that would be stored at the CAS.</p>
<p>Both patterns can be used in parallel, e,g. by storing the last <code>k</code> messages
directly and use CAS pointers for the rest. Together with the <code>next_page</code> page
semantics, this gives users flexibility in terms of bandwidth and
latency/indirection, all the way from a simple linked list to a fully replicated
log. The latter is useful for things like backups on durable storage.</p>
<h3 id="next-page-semantics"><a class="header" href="#next-page-semantics">Next page semantics</a></h3>
<p>The pointer to the 'next page' is another remote log entry, at a previous point
in time.</p>
<!-- TODO: Determine requirement re overlapping, adjacent, 
and/or missing entries -->
<!-- TODO: Document message ordering append only requirements -->
<h3 id="interaction-with-mvds"><a class="header" href="#interaction-with-mvds">Interaction with MVDS</a></h3>
<p><a href="vac/3/../2/mvds.html">vac.mvds.Message</a> payloads are the only payloads
that MUST be uploaded.
Other messages types MAY be uploaded, depending on the implementation.</p>
<h2 id="acknowledgments-1"><a class="header" href="#acknowledgments-1">Acknowledgments</a></h2>
<p>TBD.</p>
<h2 id="copyright-1"><a class="header" href="#copyright-1">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="footnotes-1"><a class="header" href="#footnotes-1">Footnotes</a></h2>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p><a href="https://github.com/vacp2p/research/tree/master/remote_log">https://github.com/vacp2p/research/tree/master/remote_log</a></p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="4mvds-meta"><a class="header" href="#4mvds-meta">4/MVDS-META</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>MVDS Metadata Field</td></tr>
<tr><th>Slug</th><td>4</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Sanaz Taheri &lt;sanaz@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Dean Eigenmann &lt;dean@status.im&gt;<br>Andrea Maria Piana &lt;andreap@status.im&gt;<br>Oskar Thorén &lt;oskarth@titanproxy.com&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-3"><a class="header" href="#timeline-3">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/4/mvds-meta.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/4/mvds-meta.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/vac/4/mvds-meta.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3a396b5fb111e73750046afb2ca10d0c28e72e83/vac/4/mvds-meta.md"><code>3a396b5</code></a> — Update and rename README.md to mvds-meta.md</li>
<li><strong>2024-01-30</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2e80c3bb3dc69c45fb7a932bbfaedded3f116f71/vac/4/README.md"><code>2e80c3b</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<p>In this specification, we describe a method to construct message history that
will aid the consistency guarantees of <a href="vac/4/../2/mvds.html">2/MVDS</a>.
Additionally,
we explain how data sync can be used for more lightweight messages that
do not require full synchronization.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>In order for more efficient synchronization of conversational messages,
information should be provided allowing a node to more effectively synchronize
the dependencies for any given message.</p>
<h2 id="format"><a class="header" href="#format">Format</a></h2>
<p>We introduce the metadata message which is used to convey information about a message
and how it SHOULD be handled.</p>
<pre><code class="language-protobuf">package vac.mvds;

message Metadata {
  repeated bytes parents = 1;
  bool ephemeral = 2;
}
</code></pre>
<p>Nodes MAY transmit a <code>Metadata</code> message by extending the MVDS <a href="vac/4/../2/mvds.html">message</a>
with a <code>metadata</code> field.</p>
<pre><code class="language-diff">message Message {
  bytes group_id = 6001;
  int64 timestamp = 6002;
  bytes body = 6003;
+ Metadata metadata = 6004;
}
</code></pre>
<h3 id="fields"><a class="header" href="#fields">Fields</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody>
<tr><td><code>parents</code></td><td>list of parent <a href="vac/4/../2/mvds.html"><code>message identifier</code>s</a> for the specific message.</td></tr>
<tr><td><code>ephemeral</code></td><td>indicates whether a message is ephemeral or not.</td></tr>
</tbody></table>
</div>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<h3 id="parents"><a class="header" href="#parents"><code>parents</code></a></h3>
<p>This field contains a list of parent <a href="vac/4/../2/mvds.html"><code>message identifier</code>s</a>
for the specific message.
It MUST NOT contain any messages as parent whose <code>ack</code> flag was set to <code>false</code>.
This establishes a directed acyclic graph (DAG)[^2] of persistent messages.</p>
<p>Nodes MAY buffer messages until dependencies are satisfied for causal consistency[^3],
they MAY also pass the messages straight away for eventual consistency[^4].</p>
<p>A parent is any message before a new message that
a node is aware of that has no children.</p>
<p>The number of parents for a given message is bound by [0, N],
where N is the number of nodes participating in the conversation,
therefore the space requirements for the <code>parents</code> field is O(N).</p>
<p>If a message has no parents it is considered a root.
There can be multiple roots, which might be disconnected,
giving rise to multiple DAGs.</p>
<h3 id="ephemeral"><a class="header" href="#ephemeral"><code>ephemeral</code></a></h3>
<p>When the <code>ephemeral</code> flag is set to <code>false</code>,
a node MUST send an acknowledgment when they have received and processed a message.
If it is set to <code>true</code>, it SHOULD NOT send any acknowledgment.
The flag is <code>false</code> by default.</p>
<p>Nodes MAY decide to not persist ephemeral messages,
however they MUST NOT be shared as part of the message history.</p>
<p>Nodes SHOULD send ephemeral messages in batch mode.
As their delivery is not needed to be guaranteed.</p>
<h2 id="copyright-2"><a class="header" href="#copyright-2">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="footnotes-2"><a class="header" href="#footnotes-2">Footnotes</a></h2>
<p>1: <a href="vac/4/../2/mvds.html">2/MVDS</a>
2: <a href="https://en.wikipedia.org/wiki/Directed_acyclic_graph">directed_acyclic_graph</a>
3: Jepsen. <a href="https://jepsen.io/consistency/models/causal">Causal Consistency</a>
Jepsen, LLC.
4: <a href="https://en.wikipedia.org/wiki/Eventual_consistency">https://en.wikipedia.org/wiki/Eventual_consistency</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="25libp2p-dns-discovery"><a class="header" href="#25libp2p-dns-discovery">25/LIBP2P-DNS-DISCOVERY</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Libp2p Peer Discovery via DNS</td></tr>
<tr><th>Slug</th><td>25</td></tr>
<tr><th>Status</th><td>deleted</td></tr>
<tr><th>Editor</th><td>Hanno Cornelius &lt;hanno@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-4"><a class="header" href="#timeline-4">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/25/libp2p-dns-discovery.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/25/libp2p-dns-discovery.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/vac/25/libp2p-dns-discovery.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/vac/25/libp2p-dns-discovery.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-08</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/a3ad14e6400392ccbc83ab401a605d80a92a6542/vac/25/libp2p-dns-discovery.md"><code>a3ad14e</code></a> — Create libp2p-dns-discovery.md</li>
</ul>
<!-- timeline:end -->
<p><code>25/LIBP2P-DNS-DISCOVERY</code> specifies a scheme to implement <a href="https://libp2p.io/"><code>libp2p</code></a>
peer discovery via DNS for Waku v2.
The generalised purpose is to retrieve an arbitrarily long, authenticated,
updateable list of <a href="https://docs.libp2p.io/concepts/peer-id/"><code>libp2p</code> peers</a>
to bootstrap connection to a <code>libp2p</code> network.
Since <a href="vac/25/../../waku/standards/core/10/waku2.html"><code>10/WAKU2</code></a>
currently specifies use of <a href="https://docs.libp2p.io/concepts/peer-id/"><code>libp2p</code> peer identities</a>,
this method is suitable for a new Waku v2 node
to discover other Waku v2 nodes to connect to.</p>
<p>This specification is largely based on <a href="https://eips.ethereum.org/EIPS/eip-1459">EIP-1459</a>,
with the only deviation being the type of address being encoded (<code>multiaddr</code> vs <code>enr</code>).
Also see <a href="https://vac.dev/dns-based-discovery">this earlier explainer</a>
for more background on the suitability of DNS based discovery for Waku v2.</p>
<h2 id="list-encoding"><a class="header" href="#list-encoding">List encoding</a></h2>
<p>The peer list MUST be encoded as a <a href="https://www.wikiwand.com/en/Merkle_tree">Merkle tree</a>.
EIP-1459 specifies <a href="https://eips.ethereum.org/EIPS/eip-1459#specification">the URL scheme</a>
to refer to such a DNS node list.
This specification uses the same approach, but with a <code>matree</code> scheme:</p>
<pre><code class="language-yaml">matree://&lt;key&gt;@&lt;fqdn&gt;
</code></pre>
<p>where</p>
<ul>
<li><code>matree</code> is the selected <code>multiaddr</code> Merkle tree scheme</li>
<li><code>&lt;fqdn&gt;</code> is the fully qualified domain name on which the list can be found</li>
<li><code>&lt;key&gt;</code> is the base32 encoding of the compressed 32-byte binary public key
that signed the list.</li>
</ul>
<p>The example URL from EIP-1459, adapted to the above scheme becomes:</p>
<pre><code class="language-yaml">matree://AM5FCQLWIZX2QFPNJAP7VUERCCRNGRHWZG3YYHIUV7BVDQ5FDPRT2@peers.example.org
</code></pre>
<p>Each entry within the Merkle tree MUST be contained within a <a href="https://www.rfc-editor.org/rfc/rfc1035.txt">DNS TXT record</a>
and stored in a subdomain (except for the base URL <code>matree</code> entry).
The content of any TXT record
MUST be small enough to fit into the 512-byte limit imposed on UDP DNS packets,
which limits the number of hashes that can be contained within a branch entry.
The subdomain name for each entry
is the base32 encoding of the abbreviated keccak256 hash of its text content.
See <a href="https://eips.ethereum.org/EIPS/eip-1459#dns-record-structure">this example</a>
of a fully populated tree for more information.</p>
<h2 id="entry-types"><a class="header" href="#entry-types">Entry types</a></h2>
<p>The following entry types are derived from <a href="https://eips.ethereum.org/EIPS/eip-1459">EIP-1459</a>
and adapted for use with <code>multiaddrs</code>:</p>
<h2 id="root-entry"><a class="header" href="#root-entry">Root entry</a></h2>
<p>The tree root entry MUST use the following format:</p>
<pre><code class="language-yaml">matree-root:v1 m=&lt;ma-root&gt; l=&lt;link-root&gt; seq=&lt;sequence number&gt; sig=&lt;signature&gt;
</code></pre>
<p>where</p>
<ul>
<li><code>ma-root</code> and <code>link-root</code> refer to the root hashes of subtrees
containing <code>multiaddrs</code> and links to other subtrees, respectively</li>
<li><code>sequence-number</code> is the tree's update sequence number.
This number SHOULD increase with each update to the tree.</li>
<li><code>signature</code> is a 65-byte secp256k1 EC signature
over the keccak256 hash of the root record content,
excluding the <code>sig=</code> part,
encoded as URL-safe base64</li>
</ul>
<h2 id="branch-entry"><a class="header" href="#branch-entry">Branch entry</a></h2>
<p>Branch entries MUST take the format:</p>
<pre><code class="language-yaml">matree-branch:&lt;h₁&gt;,&lt;h₂&gt;,...,&lt;hₙ&gt;
</code></pre>
<p>where</p>
<ul>
<li><code>&lt;h₁&gt;,&lt;h₂&gt;,...,&lt;hₙ&gt;</code> are the hashes of other subtree entries</li>
</ul>
<h2 id="leaf-entries"><a class="header" href="#leaf-entries">Leaf entries</a></h2>
<p>There are two types of leaf entries:</p>
<h3 id="link-entries"><a class="header" href="#link-entries">Link entries</a></h3>
<p>For the subtree pointed to by <code>link-root</code>,
leaf entries MUST take the format:</p>
<pre><code class="language-yaml">matree://&lt;key&gt;@&lt;fqdn&gt;
</code></pre>
<p>which links to a different list located in another domain.</p>
<h3 id="multiaddr-entries"><a class="header" href="#multiaddr-entries"><code>multiaddr</code> entries</a></h3>
<p>For the subtree pointed to by <code>ma-root</code>,
leaf entries MUST take the format:</p>
<pre><code class="language-yaml">ma:&lt;multiaddr&gt;
</code></pre>
<p>which contains the <code>multiaddr</code> of a <code>libp2p</code> peer.</p>
<h2 id="client-protocol"><a class="header" href="#client-protocol">Client protocol</a></h2>
<p>A client MUST adhere to the <a href="https://eips.ethereum.org/EIPS/eip-1459#client-protocol">client protocol</a>
as specified in EIP-1459,
and adapted for usage with <code>multiaddr</code> entry types below:</p>
<p>To find nodes at a given DNS name a client MUST perform the following steps:</p>
<ol>
<li>Resolve the TXT record of the DNS name and
check whether it contains a valid <code>matree-root:v1</code> entry.</li>
<li>Verify the signature on the root against the known public key
and check whether the sequence number is larger than or
equal to any previous number seen for that name.</li>
<li>Resolve the TXT record of a hash subdomain indicated in the record
and verify that the content matches the hash.</li>
<li>If the resolved entry is of type:</li>
</ol>
<ul>
<li><code>matree-branch</code>: parse the list of hashes and continue resolving them (step 3).</li>
<li><code>ma</code>: import the <code>multiaddr</code> and add it to a local list of discovered nodes.</li>
</ul>
<h2 id="copyright-3"><a class="header" href="#copyright-3">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<ol>
<li><a href="vac/25/../../waku/standards/core/10/waku2.html"><code>10/WAKU2</code></a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-1459#client-protocol">EIP-1459: Client Protocol</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-1459">EIP-1459: Node Discovery via DNS</a></li>
<li><a href="https://libp2p.io/"><code>libp2p</code></a></li>
<li><a href="https://docs.libp2p.io/concepts/peer-id/"><code>libp2p</code> peer identity</a></li>
<li><a href="https://www.wikiwand.com/en/Merkle_tree">Merkle trees</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="32rln-v1"><a class="header" href="#32rln-v1">32/RLN-V1</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Rate Limit Nullifier</td></tr>
<tr><th>Slug</th><td>32</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Aaryamann Challani &lt;p1ge0nh8er@proton.me&gt;</td></tr>
<tr><th>Contributors</th><td>Barry Whitehat &lt;barrywhitehat@protonmail.com&gt;<br>Sanaz Taheri &lt;sanaz@status.im&gt;<br>Oskar Thorén &lt;oskarth@titanproxy.com&gt;<br>Onur Kilic &lt;onurkilic1004@gmail.com&gt;<br>Blagoj Dimovski &lt;blagoj.dimovski@yandex.com&gt;<br>Rasul Ibragimov &lt;curryrasul@gmail.com&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-5"><a class="header" href="#timeline-5">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/32/rln-v1.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/32/rln-v1.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/vac/32/rln-v1.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-08-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eb25cd06d679e94409072a96841de16a6b3910d5/vac/32/rln-v1.md"><code>eb25cd0</code></a> — chore: replace email addresses (#86)</li>
<li><strong>2024-06-06</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/cbefa483fca219c3787b0ff0e3c64a6436a6a8cc/vac/32/rln-v1.md"><code>cbefa48</code></a> — 32/RLN-V1: Move to Draft (#40)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/vac/32/rln-v1.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/94db40661ef4df3456e2e6996164a1bbc5427914/vac/32/rln-v1.md"><code>94db406</code></a> — Update rln-v1.md</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/a23299fe32f3ba780770f26dadfcf17118bd478c/vac/32/rln-v1.md"><code>a23299f</code></a> — Update and rename RLN-V1.md to rln-v1.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/539575b01ca2cff7e5e596ecae9a5c1fc035cd79/vac/32/RLN-V1.md"><code>539575b</code></a> — Create RLN-V1.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract"><a class="header" href="#abstract">Abstract</a></h2>
<p>The following specification covers the RLN construct
as well as some auxiliary libraries useful for interacting with it.
Rate limiting nullifier (RLN) is a construct based on zero-knowledge proofs that
provides an anonymous rate-limited signaling/messaging framework
suitable for decentralized (and centralized) environments.
Anonymity refers to the unlinkability of messages to their owner.</p>
<h2 id="motivation-1"><a class="header" href="#motivation-1">Motivation</a></h2>
<p>RLN guarantees a messaging rate is enforced cryptographically
while preserving the anonymity of the message owners.
A wide range of applications can benefit from RLN and
provide desirable security features.
For example,
an e-voting system can integrate RLN to contain the voting rate while
protecting the voters-vote unlinkability.
Another use case is to protect an anonymous messaging system against DDoS and
spam attacks by constraining messaging rate of users.
This latter use case is explained in <a href="vac/32/../../waku/standards/core/17/rln-relay.html">17/WAKU2-RLN-RELAY RFC</a>.</p>
<h2 id="wire-format-specification"><a class="header" href="#wire-format-specification">Wire Format Specification</a></h2>
<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”,
“SHOULD NOT”, “RECOMMENDED”, “MAY”, and
“OPTIONAL” in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">2119</a>.</p>
<h3 id="flow-2"><a class="header" href="#flow-2">Flow</a></h3>
<p>The users participate in the protocol by
first registering to an application-defined group referred by the <em>membership group</em>.
Registration to the group is mandatory for signaling in the application.
After registration, group members can generate a zero-knowledge proof of membership
for their signals and can participate in the application.
Usually, the membership requires a financial or
social stake which is beneficial for the prevention
of inclusion of Sybils within the <em>membership group</em>.
Group members are allowed to send one signal per external nullifier
(an identifier that groups signals and can be thought of as a voting booth).
If a user generates more signals than allowed,
the user risks being slashed - by revealing his membership secret credentials.
If the financial stake is put in place, the user also risks his stake being taken.</p>
<p>Generally the flow can be described by the following steps:</p>
<ol>
<li>Registration</li>
<li>Signaling</li>
<li>Verification and slashing</li>
</ol>
<h3 id="registration"><a class="header" href="#registration">Registration</a></h3>
<p>Depending on the application requirements,
the registration can be implemented in different ways, for example:</p>
<ul>
<li>centralized registrations, by using a central server</li>
<li>decentralized registrations, by using a smart contract</li>
</ul>
<p>The users' identity commitments
(explained in section <a href="vac/32/rln-v1.html#user-identity">User Identity</a>) are stored in a Merkle tree,
and the users can obtain a Merkle proof proving that they are part of the group.</p>
<p>Also depending on the application requirements,
usually a financial or social stake is introduced.
An example for financial stake is:</p>
<p>For each registration a certain amount of ETH is required.
An example for social stake is using <a href="https://interep.link/">Interep</a> as a registry,
users need to prove that they have a highly reputable social media account.</p>
<h4 id="implementation-notes"><a class="header" href="#implementation-notes">Implementation notes</a></h4>
<h5 id="user-identity"><a class="header" href="#user-identity">User identity</a></h5>
<p>The user's identity is composed of:</p>
<pre><code class="language-js">{
    identity_secret: [identity_nullifier, identity_trapdoor],
    identity_secret_hash: poseidonHash(identity_secret),
    identity_commitment: poseidonHash([identity_secret_hash])
}

</code></pre>
<p>For registration, the user MUST submit their <code>identity_commitment</code>
(along with any additional registration requirements) to the registry.
Upon registration, they SHOULD receive <code>leaf_index</code> value
which represents their position in the Merkle tree.
Receiving a <code>leaf_index</code> is not a hard requirement and is application specific.
The other way around is
the users calculating the <code>leaf_index</code> themselves upon successful registration.</p>
<h3 id="signaling"><a class="header" href="#signaling">Signaling</a></h3>
<p>After registration,
the users can participate in the application by
sending signals to the other participants in a decentralised manner or
to a centralised server.
Along with their signal,
they MUST generate a zero-knowledge proof by
using the circuit with the specification described above.</p>
<p>For generating a proof,
the users need to obtain the required parameters or compute them themselves,
depending on the application implementation and
client libraries supported by the application.
For example,
the users MAY store the membership Merkle tree on their end and
generate a Merkle proof whenever they want to generate a signal.</p>
<h4 id="implementation-notes-1"><a class="header" href="#implementation-notes-1">Implementation Notes</a></h4>
<h5 id="signal-hash"><a class="header" href="#signal-hash">Signal hash</a></h5>
<p>The signal hash can be generated by hashing the raw signal (or content)
using the <code>keccak256</code> hash function.</p>
<h5 id="external-nullifier"><a class="header" href="#external-nullifier">External nullifier</a></h5>
<p>The external nullifier MUST be computed as the Poseidon hash of the current epoch
(e.g. a value equal to or
derived from the current UNIX timestamp divided by the epoch length)
and the RLN identifier.</p>
<pre><code class="language-js">
external_nullifier = poseidonHash([epoch, rln_identifier]);

</code></pre>
<h5 id="obtaining-merkle-proof"><a class="header" href="#obtaining-merkle-proof">Obtaining Merkle proof</a></h5>
<p>The Merkle proof SHOULD be obtained locally or from a trusted third party.
By using the <a href="https://github.com/appliedzkp/incrementalquintree/blob/master/ts/IncrementalQuinTree.ts">incremental Merkle tree algorithm</a>,
the Merkle can be obtained by providing the <code>leaf_index</code> of the <code>identity_commitment</code>.
The proof (<code>Merkle_proof</code>) is composed of the following fields:</p>
<pre><code class="language-js">
{
    root: bigint,
    indices: number[],
    path_elements: bigint[][]
}

</code></pre>
<ol>
<li><strong>root</strong> - The root of membership group Merkle tree
at the time of publishing the message</li>
<li><strong>indices</strong> - The index fields of the leafs in the Merkle tree -
used by the Merkle tree algorithm for verification</li>
<li><strong>path_elements</strong> - Auxiliary data structure used for storing the path
to the leaf - used by the Merkle proof algorithm for verificaton</li>
</ol>
<h5 id="generating-proof"><a class="header" href="#generating-proof">Generating proof</a></h5>
<p>For proof generation,
the user MUST submit the following fields to the circuit:</p>
<pre><code class="language-js">
{
    identity_secret: identity_secret_hash,
    path_elements: Merkle_proof.path_elements,
    identity_path_index: Merkle_proof.indices,
    x: signal_hash,
    external_nullifier: external_nullifier
}

</code></pre>
<h5 id="calculating-output"><a class="header" href="#calculating-output">Calculating output</a></h5>
<p>The proof output is calculated locally,
in order for the required fields for proof verification
to be sent along with the proof.
The proof output is composed of the <code>y</code> share of the secret equation and the <code>internal_nullifier</code>.
The <code>internal_nullifier</code> represents a unique fingerprint of a user
for a given <code>epoch</code> and app.
The following fields are needed for proof output calculation:</p>
<pre><code class="language-js">{
    identity_secret_hash: bigint, 
    external_nullifier: bigint,
    x: bigint
}

</code></pre>
<p>The output <code>[y, internal_nullifier]</code> is calculated in the following way:</p>
<pre><code class="language-js">
a_0 = identity_secret_hash;
a_1 = poseidonHash([a0, external_nullifier]);

y = a_0 + x * a_1;

internal_nullifier = poseidonHash([a_1]);

</code></pre>
<p>It relies on the properties of the <a href="https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing">Shamir's Secret sharing scheme</a>.</p>
<h5 id="sending-the-output-message"><a class="header" href="#sending-the-output-message">Sending the output message</a></h5>
<p>The user's output message (<code>output_message</code>),
containing the signal SHOULD contain the following fields at minimum:</p>
<pre><code class="language-js">
{
    signal: signal, # non-hashed signal,
    proof: zk_proof,
    internal_nullifier: internal_nullifier,
    x: x, # signal_hash,
    y: y,
    rln_identifier: rln_identifier
}

</code></pre>
<p>Additionally depending on the application,
the following fields MAY be required:</p>
<pre><code class="language-js">
{
    root: Merkle_proof.root,
    epoch: epoch
}

</code></pre>
<h3 id="verification-and-slashing"><a class="header" href="#verification-and-slashing">Verification and slashing</a></h3>
<p>The slashing implementation is dependent on the type of application.
If the application is implemented in a centralised manner,
and everything is stored on a single server,
the slashing will be implemented only on the server.
Otherwise if the application is distributed,
the slashing will be implemented on each user's client.</p>
<h4 id="notes-from-implementation"><a class="header" href="#notes-from-implementation">Notes from Implementation</a></h4>
<p>Each user of the protocol
(server or otherwise) MUST store metadata for each message received by each user,
for the given <code>epoch</code>.
The data can be deleted when the <code>epoch</code> passes.
Storing metadata is REQUIRED,
so that if a user sends more than one unique signal per <code>epoch</code>,
they can be slashed and removed from the protocol.
The metadata stored contains the <code>x</code>, <code>y</code> shares and
the <code>internal_nullifier</code> for the user for each message.
If enough such shares are present, the user's secret can be retreived.</p>
<p>One way of storing received metadata (<code>messaging_metadata</code>) is the following format:</p>
<pre><code class="language-js">
{
    [external_nullifier]: {
        [internal_nullifier]: {
            x_shares: [],
            y_shares: []
        }
    }
}

</code></pre>
<h5 id="verification"><a class="header" href="#verification">Verification</a></h5>
<p>The output message verification consists of the following steps:</p>
<ul>
<li><code>external_nullifier</code> correctness</li>
<li>non-duplicate message check</li>
<li><code>zk_proof</code> zero-knowledge proof verification</li>
<li>spam verification</li>
</ul>
<p><strong>1. <code>external_nullifier</code> correctness</strong>
Upon received <code>output_message</code>,
first the <code>epoch</code> and <code>rln_identifier</code> fields are checked,
to ensure that the message matches the current <code>external_nullifier</code>.
If the <code>external_nullifier</code> is correct the verification continues, otherwise,
the message is discarded.</p>
<p><strong>2. non-duplicate message check</strong>
The received message is checked to ensure it is not duplicate.
The duplicate message check is performed by verifying that the <code>x</code> and <code>y</code>
fields do not exist in the <code>messaging_metadata</code> object.
If the <code>x</code> and <code>y</code> fields exist in the <code>x_shares</code> and
<code>y_shares</code> array for the <code>external_nullifier</code> and
the <code>internal_nullifier</code> the message can be considered as a duplicate.
Duplicate messages are discarded.</p>
<p><strong>3. <code>zk_proof</code> verification</strong></p>
<p>The <code>zk_proof</code> SHOULD be verified by providing the <code>zk_proof</code> field
to the circuit verifier along with the <code>public_signal</code>:</p>
<pre><code class="language-js">
[
    y,
    Merkle_proof.root,
    internal_nullifier,
    x, # signal_hash
    external_nullifier
]

</code></pre>
<p>If the proof verification is correct,
the verification continues, otherwise the message is discarded.</p>
<p><strong>4. Double signaling verification</strong>
After the proof is verified the <code>x</code>, and
<code>y</code> fields are added to the <code>x_shares</code> and <code>y_shares</code>
arrays of the <code>messaging_metadata</code> <code>external_nullifier</code> and
<code>internal_nullifier</code> object.
If the length of the arrays is equal to the signaling threshold (<code>limit</code>),
the user can be slashed.</p>
<h5 id="slashing"><a class="header" href="#slashing">Slashing</a></h5>
<p>After the verification,
the user SHOULD be slashed if two different shares are present
to reconstruct their <code>identity_secret_hash</code> from <code>x_shares</code> and
<code>y_shares</code> fields, for their <code>internal_nullifier</code>.
The secret can be retreived by the properties of the Shamir's secret sharing scheme.
In particular the secret (<code>a_0</code>) can be retrieved by computing <a href="https://en.wikipedia.org/wiki/Lagrange_polynomial">Lagrange polynomials</a>.</p>
<p>After the secret is retreived,
the user's <code>identity_commitment</code> SHOULD be generated from the secret and
it can be used for removing the user from the membership Merkle tree
(zeroing out the leaf that contains the user's <code>identity_commitment</code>).
Additionally, depending on the application the <code>identity_secret_hash</code>
MAY be used for taking the user's provided stake.</p>
<h3 id="technical-overview"><a class="header" href="#technical-overview">Technical overview</a></h3>
<p>The main RLN construct is implemented using a
<a href="https://z.cash/technology/zksnarks/">ZK-SNARK</a> circuit.
However, it is helpful to describe
the other necessary outside components for interaction with the circuit,
which together with the ZK-SNARK circuit enable the above mentioned features.</p>
<h4 id="terminology"><a class="header" href="#terminology">Terminology</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Term</th><th>Description</th></tr></thead><tbody>
<tr><td><strong>ZK-SNARK</strong></td><td><a href="https://z.cash/technology/zksnarks/">zksnarks</a></td></tr>
<tr><td><strong>Stake</strong></td><td>Financial or social stake required for registering in the RLN applications.  Common stake examples are: locking cryptocurrency (financial), linking reputable social identity.</td></tr>
<tr><td><strong>Identity secret</strong></td><td>An array of two unique random components (identity nullifier and identity trapdoor), which must be kept private by the user. Secret hash and identity commitment are derived from this array.</td></tr>
<tr><td><strong>Identity nullifier</strong></td><td>Random 32 byte value used as component for identity secret generation.</td></tr>
<tr><td><strong>Identity trapdoor</strong></td><td>Random 32 byte value used as component for identity secret generation.</td></tr>
<tr><td><strong>Identity secret hash</strong></td><td>The hash of the identity secret, obtained using the Poseidon hash function. It is used for deriving the identity commitment of the user, and as a private input for zero-knowledge proof generation. The secret hash should be kept private by the user.</td></tr>
<tr><td><strong>Identity commitment</strong></td><td>Hash obtained from the <code>Identity secret hash</code> by using the poseidon hash function. It is used by the users for registering in the protocol.</td></tr>
<tr><td><strong>Signal</strong></td><td>The message generated by a user. It is an arbitrary bit string that may represent a chat message, a URL request, protobuf message, etc.</td></tr>
<tr><td><strong>Signal hash</strong></td><td>Keccak256 hash of the signal modulo circuit's field characteristic, used as an input in the RLN circuit.</td></tr>
<tr><td><strong>RLN Identifier</strong></td><td>Random finite field value unique per RLN app. It is used for additional cross-application security. The role of the RLN identifier is protection of the user secrets from being compromised when signals are being generated with the same credentials in different apps.</td></tr>
<tr><td><strong>RLN membership tree</strong></td><td>Merkle tree data structure, filled with identity commitments of the users. Serves as a data structure that ensures user registrations.</td></tr>
<tr><td><strong>Merkle proof</strong></td><td>Proof that a user is member of the RLN membership tree.</td></tr>
</tbody></table>
</div>
<h4 id="rln-zero-knowledge-circuit-specific-terms"><a class="header" href="#rln-zero-knowledge-circuit-specific-terms">RLN Zero-Knowledge Circuit specific terms</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Term</th><th>Description</th></tr></thead><tbody>
<tr><td><strong>x</strong></td><td>Keccak hash of the signal, same as signal hash (Defined above).</td></tr>
<tr><td><strong>A0</strong></td><td>The identity secret hash.</td></tr>
<tr><td><strong>A1</strong></td><td>Poseidon hash of [A0, External nullifier] (see about External nullifier below).</td></tr>
<tr><td><strong>y</strong></td><td>The result of the polynomial equation (y = a0 + a1*x). The public output of the circuit.</td></tr>
<tr><td><strong>External nullifier</strong></td><td>Poseidon hash of [Epoch, RLN Identifier]. An identifier that groups signals and can be thought of as a voting booth.</td></tr>
<tr><td><strong>Internal nullifier</strong></td><td>Poseidon hash of [A1]. This field ensures that a user can send only one valid signal per external nullifier without risking being slashed. Public input of the circuit.</td></tr>
</tbody></table>
</div>
<h4 id="zero-knowledge-circuits-specification"><a class="header" href="#zero-knowledge-circuits-specification">Zero-Knowledge Circuits specification</a></h4>
<p>Anonymous signaling with a controlled rate limit
is enabled by proving that the user is part of a group
which has high barriers to entry (form of stake) and
enabling secret reveal if more than 1 unique signal is produced per external nullifier.
The membership part is implemented using
membership <a href="https://en.wikipedia.org/wiki/Merkle_tree">Merkle trees</a> and Merkle proofs,
while the secret reveal part is enabled by using the Shamir's Secret Sharing scheme.
Essentially the protocol requires the users to generate zero-knowledge proof
to be able to send signals and
participate in the application.
The zero knowledge proof proves that the user is member of a group,
but also enforces the user to share part of their secret
for each signal in an external nullifier.
The external nullifier is usually represented by timestamp or a time interval.
It can also be thought of as a voting booth in voting applications.</p>
<p>The zero-knowledge Circuit is implemented using a <a href="https://eprint.iacr.org/2016/260.pdf">Groth-16 ZK-SNARK</a>,
using the <a href="https://docs.circom.io/">circomlib</a> library.</p>
<h5 id="system-parameters"><a class="header" href="#system-parameters">System parameters</a></h5>
<ul>
<li><code>DEPTH</code> - Merkle tree depth</li>
</ul>
<h5 id="circuit-parameters"><a class="header" href="#circuit-parameters">Circuit parameters</a></h5>
<h6 id="public-inputs"><a class="header" href="#public-inputs">Public Inputs</a></h6>
<ul>
<li><code>x</code></li>
<li><code>external_nullifier</code></li>
</ul>
<h6 id="private-inputs"><a class="header" href="#private-inputs">Private Inputs</a></h6>
<ul>
<li><code>identity_secret_hash</code></li>
<li><code>path_elements</code> - rln membership proof component</li>
<li><code>identity_path_index</code> - rln membership proof component</li>
</ul>
<h6 id="outputs"><a class="header" href="#outputs">Outputs</a></h6>
<ul>
<li><code>y</code></li>
<li><code>root</code> - the rln membership tree root</li>
<li><code>internal_nullifier</code></li>
</ul>
<h5 id="hash-function"><a class="header" href="#hash-function">Hash function</a></h5>
<p>Canonical <a href="https://eprint.iacr.org/2019/458.pdf">Poseidon hash implementation</a>
is used,
as implemented in the <a href="https://github.com/iden3/circomlib/blob/master/circuits/poseidon.circom">circomlib library</a>,
according to the Poseidon paper.
This Poseidon hash version (canonical implementation) uses the following parameters:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Hash inputs</th><th style="text-align: center"><code>t</code></th><th style="text-align: center"><code>RF</code></th><th style="text-align: center"><code>RP</code></th></tr></thead><tbody>
<tr><td style="text-align: center">1</td><td style="text-align: center">2</td><td style="text-align: center">8</td><td style="text-align: center">56</td></tr>
<tr><td style="text-align: center">2</td><td style="text-align: center">3</td><td style="text-align: center">8</td><td style="text-align: center">57</td></tr>
<tr><td style="text-align: center">3</td><td style="text-align: center">4</td><td style="text-align: center">8</td><td style="text-align: center">56</td></tr>
<tr><td style="text-align: center">4</td><td style="text-align: center">5</td><td style="text-align: center">8</td><td style="text-align: center">60</td></tr>
<tr><td style="text-align: center">5</td><td style="text-align: center">6</td><td style="text-align: center">8</td><td style="text-align: center">60</td></tr>
<tr><td style="text-align: center">6</td><td style="text-align: center">7</td><td style="text-align: center">8</td><td style="text-align: center">63</td></tr>
<tr><td style="text-align: center">7</td><td style="text-align: center">8</td><td style="text-align: center">8</td><td style="text-align: center">64</td></tr>
<tr><td style="text-align: center">8</td><td style="text-align: center">9</td><td style="text-align: center">8</td><td style="text-align: center">63</td></tr>
</tbody></table>
</div>
<h5 id="membership-implementation"><a class="header" href="#membership-implementation">Membership implementation</a></h5>
<p>For a valid signal, a user's <code>identity_commitment</code>
(more on identity commitments below) must exist in identity membership tree.
Membership is proven by providing a membership proof (witness).
The fields from the membership proof REQUIRED for the verification are:
<code>path_elements</code> and <code>identity_path_index</code>.</p>
<p><a href="https://github.com/appliedzkp/incrementalquintree">IncrementalQuinTree</a>
algorithm is used for constructing the Membership Merkle tree.
The circuits are reused from this repository.
You can find out more details about the IncrementalQuinTree algorithm <a href="https://ethresear.ch/t/gas-and-circuit-constraint-benchmarks-of-binary-and-quinary-incremental-Merkle-trees-using-the-poseidon-hash-function/7446">here</a>.</p>
<h4 id="slashing-and-shamirs-secret-sharing"><a class="header" href="#slashing-and-shamirs-secret-sharing">Slashing and Shamir's Secret Sharing</a></h4>
<p>Slashing is enabled by using polynomials and <a href="https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing">Shamir's Secret sharing</a>.
In order to produce a valid proof,
<code>identity_secret_hash</code> as a private input to the circuit.
Then a secret equation is created in the form of:</p>
<pre><code class="language-js">
y = a_0 + x * a_1;

</code></pre>
<p>where <code>a_0</code> is the <code>identity_secret_hash</code> and <code>a_1 = hash(a_0, external nullifier)</code>.
Along with the generated proof,
the users MUST provide a <code>(x, y)</code> share which satisfies the line equation,
in order for their proof to be verified.
<code>x</code> is the hashed signal, while the <code>y</code> is the circuit output.
With more than one pair of unique shares, anyone can derive <code>a_0</code>, i.e. the <code>identity_secret_hash</code>.
The hash of a signal will be the evaluation point <code>x</code>.
In this way,
a member who sends more than one unique signal per <code>external_nullifier</code>
risks their identity secret being revealed.</p>
<p>Note that shares used in different epochs and
different RLN apps cannot be used to derive the <code>identity_secret_hash</code>.</p>
<p>Thanks to the <code>external_nullifier</code> definition,
also shares computed from same secret within same epoch but
in different RLN apps cannot be used to derive the identity secret hash.</p>
<p>The <code>rln_identifier</code> is a random value from a finite field, unique per RLN app,
and is used for additional cross-application security -
to protect the user secrets being compromised if they use
the same credentials accross different RLN apps.
If <code>rln_identifier</code> is not present,
the user uses the same credentials and
sends a different message for two different RLN apps using the same <code>external_nullifier</code>,
then their user signals can be grouped by the <code>internal_nullifier</code>
which could lead the user's secret revealed.
This is because two separate signals under the same <code>internal_nullifier</code>
can be treated as rate limiting violation.
With adding the <code>rln_identifier</code> field we obscure the <code>internal_nullifier</code>,
so this kind of attack can be hardened because
we don't have the same <code>internal_nullifier</code> anymore.</p>
<h4 id="identity-credentials-generation"><a class="header" href="#identity-credentials-generation">Identity credentials generation</a></h4>
<p>In order to be able to generate valid proofs,
the users MUST be part of the identity membership Merkle tree.
They are part of the identity membership Merkle tree if
their <code>identity_commitment</code> is placed in a leaf in the tree.</p>
<p>The identity credentials of a user are composed of:</p>
<ul>
<li><code>identity_secret</code></li>
<li><code>identity_secret_hash</code></li>
<li><code>identity_commitment</code></li>
</ul>
<h5 id="identity_secret"><a class="header" href="#identity_secret"><code>identity_secret</code></a></h5>
<p>The <code>identity_secret</code> is generated in the following way:</p>
<pre><code class="language-js">
identity_nullifier = random_32_byte_buffer;
identity_trapdoor = random_32_byte_buffer;
identity_secret = [identity_nullifier, identity_trapdoor];

</code></pre>
<p>The same secret SHOULD NOT be used accross different protocols,
because revealing the secret at one protocol
could break privacy for the user in the other protocols.</p>
<h5 id="identity_secret_hash"><a class="header" href="#identity_secret_hash"><code>identity_secret_hash</code></a></h5>
<p>The <code>identity_secret_hash</code> is generated by obtaining a Poseidon hash
of the <code>identity_secret</code> array:</p>
<pre><code class="language-js">
identity_secret_hash = poseidonHash(identity_secret);

</code></pre>
<h5 id="identity_commitment"><a class="header" href="#identity_commitment"><code>identity_commitment</code></a></h5>
<p>The <code>identity_commitment</code> is generated by obtaining a Poseidon hash of the <code>identity_secret_hash</code>:</p>
<pre><code class="language-js">
identity_commitment = poseidonHash([identity_secret_hash]);

</code></pre>
<h3 id="appendix-a-security-considerations"><a class="header" href="#appendix-a-security-considerations">Appendix A: Security Considerations</a></h3>
<p>RLN is an experimental and still un-audited technology.
This means that the circuits have not been yet audited.
Another consideration is the security of the underlying primitives.
zk-SNARKS require a trusted setup for generating a prover and verifier keys.
The standard for this is to use trusted
<a href="https://en.wikipedia.org/wiki/Secure_multi-party_computation">Multi-Party Computation (MPC)</a>
ceremony, which requires two phases.
Trusted MPC ceremony has not yet been performed for the RLN circuits.</p>
<h4 id="sss-security-assumptions"><a class="header" href="#sss-security-assumptions">SSS Security Assumptions</a></h4>
<p>Shamir-Secret Sharing requires polynomial coefficients
to be independent of each other.
However, <code>a_1</code> depends on <code>a_0</code> through the Poseidon hash algorithm.
Due to the design of Poseidon,
it is possible to
<a href="https://github.com/Rate-Limiting-Nullifier/rln-circuits/pull/7#issuecomment-1416085627">attack</a>
the protocol.<br />
It was decided <em>not</em> to change the circuits design,
since at the moment the attack is infeasible.
Therefore, implementers must be aware that the current version
provides approximately 160-bit security and not 254.
Possible improvements:</p>
<ul>
<li><a href="https://github.com/Rate-Limiting-Nullifier/rln-circuits/pull/7#issuecomment-1416085627">change the circuit</a>
to make coefficients independent;</li>
<li>switch to other hash function (Keccak, SHA);</li>
</ul>
<h3 id="appendix-b-identity-scheme-choice"><a class="header" href="#appendix-b-identity-scheme-choice">Appendix B: Identity Scheme Choice</a></h3>
<p>The hashing scheme used is based on the design decisions
which also include the Semaphore circuits.
Our goal was to ensure compatibility of the secrets for apps that use Semaphore and
RLN circuits while also not compromising on security because of using the same secrets.</p>
<p>For example, let's say there is a voting app that uses Semaphore,
and also a chat app that uses RLN.
The UX would be better if
the users would not need to care about complicated identity management
(secrets and commitments) they use for each app,
and it would be much better if they could use a single id commitment for this.
Also in some cases these kind of dependency is required -
RLN chat app using Interep as a registry (instead of using financial stake).
One potential concern about this interoperability is a slashed user
on the RLN app side having their security compromised
on the semaphore side apps as well.
i.e. obtaining the user's secret,
anyone would be able to generate valid semaphore proofs as the slashed user.
We don't want that,
and we should keep user's app specific security threats
in the domain of that app alone.</p>
<p>To achieve the above interoperability UX
while preventing the shared app security model
(i.e slashing user on an RLN app having impact on Semaphore apps),
we had to do the follow in regard the identity secret and identity commitment:</p>
<pre><code class="language-js">
identity_secret = [identity_nullifier, identity_trapdoor];
identity_secret_hash = poseidonHash(identity_secret);
identity_commitment = poseidonHash([identity_secret_hash]);

</code></pre>
<p>Secret components for generating Semaphore proof:</p>
<ul>
<li><code>identity_nullifier</code></li>
<li><code>identity_trapdoor</code></li>
</ul>
<p>Secret components for generting RLN proof:</p>
<ul>
<li><code>identity_secret_hash</code></li>
</ul>
<p>When a user is slashed on the RLN app side, their <code>identity_secret_hash</code> is revealed.
However, a semaphore proof can't be generated because
we do not know the user's <code>identity_nullifier</code> and <code>identity_trapdoor</code>.</p>
<p>With this design we achieve:</p>
<p><code>identity_commitment</code> (Semaphore) == <code>identity_commitment</code> (RLN)
secret (semaphore) != secret (RLN).</p>
<p>This is the only option we had for the scheme
in order to satisfy the properties described above.</p>
<p>Also, for RLN we do a single secret component input for the circuit.
Thus we need to hash the secret array (two components) to a secret hash,
and we use that as a secret component input.</p>
<h3 id="appendix-c-auxiliary-tooling"><a class="header" href="#appendix-c-auxiliary-tooling">Appendix C: Auxiliary Tooling</a></h3>
<p>There are few additional tools implemented for easier integrations and
usage of the RLN protocol.</p>
<p><a href="https://github.com/vacp2p/zerokit"><code>zerokit</code></a> is a set of Zero Knowledge modules,
written in Rust and designed to be used in many different environments.
Among different modules, it supports <code>Semaphore</code> and <code>RLN</code>.</p>
<p><a href="https://github.com/appliedzkp/zk-kit"><code>zk-kit</code></a>
is a typescript library which exposes APIs for identity credentials generation,
as well as proof generation.
It supports various protocols (<code>Semaphore</code>, <code>RLN</code>).</p>
<p><a href="https://github.com/akinovak/zk-keeper"><code>zk-keeper</code></a>
is a browser plugin which allows for safe credential storing and
proof generation.
You can think of MetaMask for zero-knowledge proofs.
It uses <code>zk-kit</code> under the hood.</p>
<h3 id="appendix-d-example-usage"><a class="header" href="#appendix-d-example-usage">Appendix D: Example Usage</a></h3>
<p>The following examples are code snippets using the <code>zerokit</code> RLN module.
The examples are written in <a href="https://www.rust-lang.org/">rust</a>.</p>
<h4 id="creating-a-rln-object"><a class="header" href="#creating-a-rln-object">Creating a RLN Object</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>use rln::protocol::*;
use rln::public::*;
use std::io::Cursor;
// We set the RLN parameters: 
// - the tree height;
// - the circuit resource folder (requires a trailing "/").
let tree_height = 20;
let resources = Cursor::new("../zerokit/rln/resources/tree_height_20/");
// We create a new RLN instance
let mut rln = RLN::new(tree_height, resources);

<span class="boring">}</span></code></pre></pre>
<h4 id="generating-identity-credentials"><a class="header" href="#generating-identity-credentials">Generating Identity Credentials</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>// We generate an identity tuple
let mut buffer = Cursor::new(Vec::&lt;u8&gt;::new());
rln.extended_key_gen(&amp;mut buffer).unwrap();
// We deserialize the keygen output to obtain
// the identiy_secret and id_commitment
let (identity_trapdoor, identity_nullifier, identity_secret_hash, id_commitment) = deserialize_identity_tuple(buffer.into_inner());

<span class="boring">}</span></code></pre></pre>
<h4 id="adding-id-commitment-to-the-rln-merkle-tree"><a class="header" href="#adding-id-commitment-to-the-rln-merkle-tree">Adding ID Commitment to the RLN Merkle Tree</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>// We define the tree index where id_commitment will be added
let id_index = 10;
// We serialize id_commitment and pass it to set_leaf
let mut buffer = Cursor::new(serialize_field_element(id_commitment));
rln.set_leaf(id_index, &amp;mut buffer).unwrap();

<span class="boring">}</span></code></pre></pre>
<h4 id="setting-epoch-and-signal"><a class="header" href="#setting-epoch-and-signal">Setting Epoch and Signal</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>// We generate epoch from a date seed and we ensure is
// mapped to a field element by hashing-to-field its content
let epoch = hash_to_field(b"Today at noon, this year");
// We set our signal 
let signal = b"RLN is awesome";

<span class="boring">}</span></code></pre></pre>
<h4 id="generating-proof-1"><a class="header" href="#generating-proof-1">Generating Proof</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>// We prepare input to the proof generation routine
let proof_input = prepare_prove_input(identity_secret, id_index, epoch, signal);
// We generate a RLN proof for proof_input
let mut in_buffer = Cursor::new(proof_input);
let mut out_buffer = Cursor::new(Vec::&lt;u8&gt;::new());
rln.generate_rln_proof(&amp;mut in_buffer, &amp;mut out_buffer)
    .unwrap();
// We get the public outputs returned by the circuit evaluation
let proof_data = out_buffer.into_inner();

<span class="boring">}</span></code></pre></pre>
<h4 id="verifiying-proof"><a class="header" href="#verifiying-proof">Verifiying Proof</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>// We prepare input to the proof verification routine
let verify_data = prepare_verify_input(proof_data, signal);
// We verify the zero-knowledge proof against the provided proof values
let mut in_buffer = Cursor::new(verify_data);
let verified = rln.verify(&amp;mut in_buffer).unwrap();
// We ensure the proof is valid
assert!(verified);

<span class="boring">}</span></code></pre></pre>
<p>For more details please visit the
<a href="https://github.com/vacp2p/zerokit"><code>zerokit</code></a> library.</p>
<h2 id="copyright-4"><a class="header" href="#copyright-4">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a></p>
<h2 id="references-1"><a class="header" href="#references-1">References</a></h2>
<ul>
<li><a href="vac/32/../../waku/standards/core/17/rln-relay.html">17/WAKU2-RLN-RELAY RFC</a></li>
<li><a href="https://interep.link/">Interep</a></li>
<li><a href="https://github.com/appliedzkp/incrementalquintree/blob/master/ts/IncrementalQuinTree.ts">incremental Merkle tree algorithm</a></li>
<li><a href="https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing">Shamir's Secret sharing scheme</a></li>
<li><a href="https://en.wikipedia.org/wiki/Lagrange_polynomial">Lagrange polynomials</a></li>
<li><a href="https://z.cash/technology/zksnarks/">ZK-SNARK</a></li>
<li><a href="https://en.wikipedia.org/wiki/Merkle_tree">Merkle trees</a></li>
<li><a href="https://eprint.iacr.org/2016/260.pdf">Groth-16 ZK-SNARK</a></li>
<li><a href="https://docs.circom.io/">circomlib</a></li>
<li><a href="https://eprint.iacr.org/2019/458.pdf">Poseidon hash implementation</a></li>
<li><a href="https://github.com/iden3/circomlib/blob/master/circuits/poseidon.circom">circomlib library</a></li>
<li><a href="https://github.com/appliedzkp/incrementalquintree">IncrementalQuinTree</a></li>
<li><a href="https://ethresear.ch/t/gas-and-circuit-constraint-benchmarks-of-binary-and-quinary-incremental-Merkle-trees-using-the-poseidon-hash-function/7446">IncrementalQuinTree algorithm</a></li>
<li><a href="https://en.wikipedia.org/wiki/Secure_multi-party_computation">Multi-Party Computation (MPC)</a></li>
<li><a href="https://github.com/Rate-Limiting-Nullifier/rln-circuits/pull/7#issuecomment-1416085627">Poseidon hash attack</a></li>
<li><a href="https://github.com/vacp2p/zerokit">zerokit</a></li>
<li><a href="https://github.com/appliedzkp/zk-kit">zk-kit</a></li>
<li><a href="https://github.com/akinovak/zk-keeper">zk-keeper</a></li>
<li><a href="https://www.rust-lang.org/">rust</a></li>
</ul>
<h3 id="informative"><a class="header" href="#informative">Informative</a></h3>
<ul>
<li>[1] <a href="https://medium.com/privacy-scaling-explorations/rate-limiting-nullifier-a-spam-protection-mechanism-for-anonymous-environments-bbe4006a57d">privacy-scaling-explorations</a></li>
<li>[2] <a href="https://research.nccgroup.com/2020/06/24/">security-considerations-of-zk-snark-parameter-multi-party-computation</a>security-considerations-of-zk-snark-parameter-multi-party-computation/</li>
<li>[3] <a href="https://github.com/Rate-Limiting-Nullifier/rln-circuits/">rln-circuits</a></li>
<li>[4] <a href="https://rate-limiting-nullifier.github.io/rln-docs/">rln docs</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vac-raw-specifications"><a class="header" href="#vac-raw-specifications">Vac Raw Specifications</a></h1>
<p>All Vac specifications that have not reached <strong>draft</strong> status will live in this repository.
To learn more about <strong>raw</strong> specifications, take a look at <a href="vac/raw/../1/coss.html">1/COSS</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hashgraphlike-consensus"><a class="header" href="#hashgraphlike-consensus">HASHGRAPHLIKE CONSENSUS</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Hashgraphlike Consensus Protocol</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Ugur Sen [ugur@status.im](mailto:ugur@status.im)</td></tr>
<tr><th>Contributors</th><td>s<br>e<br>e<br>m<br>e<br>n<br>k<br>i<br>n<br>a<br> <br>[<br>e<br>k<br>a<br>t<br>e<br>r<br>i<br>n<br>a<br>@<br>s<br>t<br>a<br>t<br>u<br>s<br>.<br>i<br>m<br>]<br>(<br>m<br>a<br>i<br>l<br>t<br>o<br>:<br>e<br>k<br>a<br>t<br>e<br>r<br>i<br>n<br>a<br>@<br>s<br>t<br>a<br>t<br>u<br>s<br>.<br>i<br>m<br>)</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-6"><a class="header" href="#timeline-6">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/raw/consensus-hashgraphlike.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/raw/consensus-hashgraphlike.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-09-15</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/f051117d3782f66d773aaf27845c60a066ac10b6/vac/raw/consensus-hashgraphlike.md"><code>f051117</code></a> — VAC-RAW/Consensus-hashgraphlike RFC (#142)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-1"><a class="header" href="#abstract-1">Abstract</a></h2>
<p>This document specifies a scalable, decentralized, and Byzantine Fault Tolerant (BFT)
consensus mechanism inspired by Hashgraph, designed for binary decision-making in P2P networks.</p>
<h2 id="motivation-2"><a class="header" href="#motivation-2">Motivation</a></h2>
<p>Consensus is one of the essential components of decentralization.
In particular, in the decentralized group messaging application is used for
binary decision-making to govern the group.
Therefore, each user contributes to the decision-making process.
Besides achieving decentralization, the consensus mechanism MUST be strong:</p>
<ul>
<li>
<p>Under the assumption of at least <code>2/3</code> honest users in the network.</p>
</li>
<li>
<p>Each user MUST conclude the same decision and scalability:
message propagation in the network MUST occur within <code>O(log n)</code> rounds,
where <code>n</code> is the total number of peers,
in order to preserve the scalability of the messaging application.</p>
</li>
</ul>
<h2 id="format-specification"><a class="header" href="#format-specification">Format Specification</a></h2>
<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”,
“SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL” in this document
are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">2119</a>.</p>
<h2 id="flow-3"><a class="header" href="#flow-3">Flow</a></h2>
<p>Any user in the group initializes the consensus by creating a proposal.
Next, the user broadcasts the proposal to the whole network.
Upon each user receives the proposal, validates the proposal,
adds its vote as yes or no and with its signature and timestamp.
The user then sends the proposal and vote to a random peer in a P2P setup,
or to a subscribed gossipsub channel if gossip-based messaging is used.
Therefore, each user first validates the signature and then adds its new vote.
Each sending message counts as a round.
After <code>log(n)</code> rounds all users in the network have the others vote
if at least <code>2/3</code> number of users are honest where honesty follows the protocol.</p>
<p>In general, the voting-based consensus consists of the following phases:</p>
<ol>
<li>Initialization of voting</li>
<li>Exchanging votes across the rounds</li>
<li>Counting the votes</li>
</ol>
<h3 id="assumptions"><a class="header" href="#assumptions">Assumptions</a></h3>
<ul>
<li>The users in the P2P network can discover the nodes or they are subscribing same channel in a gossipsub.</li>
<li>We MAY have non-reliable (silent) nodes.</li>
<li>Proposal owners MUST know the number of voters.</li>
</ul>
<h2 id="1-initialization-of-voting"><a class="header" href="#1-initialization-of-voting">1. Initialization of voting</a></h2>
<p>A user initializes the voting with the proposal payload which is
implemented using <a href="https://protobuf.dev/">protocol buffers v3</a> as follows:</p>
<pre><code class="language-bash">syntax = "proto3";

package vac.voting;

message Proposal {
  string name = 10;                  // Proposal name
  string payload = 11;               // Proposal description
  uint32 proposal_id = 12;           // Unique identifier of the proposal
  bytes proposal_owner = 13;         // Public key of the creator 
  repeated Votes = 14;               // Vote list in the proposal
  uint32 expected_voters_count = 15; // Maximum number of distinct voters
  uint32 round = 16;                 // Number of Votes 
  uint64 timestamp = 17;             // Creation time of proposal
  uint64 expiration_time = 18;       // The time interval that the proposal is active.  
  bool liveness_criteria_yes = 19;   // Shows how managing the silent peers vote
}

message Vote {
  uint32 vote_id = 20;            // Unique identifier of the vote
  bytes vote_owner = 21;          // Voter's public key
  uint32 proposal_id = 22;        // Linking votes and proposals
  int64 timestamp = 23;           // Time when the vote was cast
  bool vote = 24;                 // Vote bool value (true/false)
  bytes parent_hash = 25;         // Hash of previous owner's Vote
  bytes received_hash = 26;       // Hash of previous received Vote
  bytes vote_hash = 27;           // Hash of all previously defined fields in Vote
  bytes signature = 28;           // Signature of vote_hash
}

</code></pre>
<p>To initiate a consensus for a proposal,
a user MUST complete all the fields in the proposal, including attaching its <code>vote</code>
and the <code>payload</code> that shows the purpose of the proposal.
Notably, <code>parent_hash</code> and <code>received_hash</code> are empty strings because there is no previous or received hash.
Then the initialization section ends when the user who creates the proposal sends it
to the random peer from the network or sends it to the proposal to the specific channel.</p>
<h2 id="2-exchanging-votes-across-the-peers"><a class="header" href="#2-exchanging-votes-across-the-peers">2. Exchanging votes across the peers</a></h2>
<p>Once the peer receives the proposal message <code>P_1</code> from a 1-1 or a gossipsub channel does the following checks:</p>
<ol>
<li>
<p>Check the signatures of the each votes in proposal, in particular for proposal <code>P_1</code>,
verify the signature of <code>V_1</code> where <code>V_1 = P_1.votes[0]</code> with <code>V_1.signature</code> and <code>V_1.vote_owner</code></p>
</li>
<li>
<p>Do <code>parent_hash</code> check: If there are repeated votes from the same sender,
check that the hash of the former vote is equal to the <code>parent_hash</code> of the later vote.</p>
</li>
<li>
<p>Do <code>received_hash</code> check: If there are multiple votes in a proposal, check that the hash of a vote is equal to the <code>received_hash</code> of the next one.</p>
</li>
<li>
<p>After successful verification of the signature and hashes, the receiving peer proceeds to generate <code>P_2</code> containing a new vote <code>V_2</code> as following:</p>
<p>4.1. Add its public key as <code>P_2.vote_owner</code>.</p>
<p>4.2. Set <code>timestamp</code>.</p>
<p>4.3. Set boolean <code>vote</code>.</p>
<p>4.4. Define <code>V_2.parent_hash = 0</code> if there is no previous peer's vote, otherwise hash of previous owner's vote.</p>
<p>4.5. Set <code>V_2.received_hash = hash(P_1.votes[0])</code>.</p>
<p>4.6. Set <code>proposal_id</code> for the <code>vote</code>.</p>
<p>4.7. Calculate <code>vote_hash</code> by hash of all previously defined fields in Vote:
<code>V_2.vote_hash = hash(vote_id, owner, proposal_id, timestamp, vote, parent_hash, received_hash)</code></p>
<p>4.8. Sign <code>vote_hash</code> with its private key corresponding the public key as <code>vote_owner</code> component then adds <code>V_2.vote_hash</code>.</p>
</li>
<li>
<p>Create <code>P_2</code> with by adding <code>V_2</code> as follows:</p>
<p>5.1. Assign <code>P_2.name</code>, <code>P_2.proposal_id</code>, and <code>P_2.proposal_owner</code> to be identical to those in <code>P_1</code>.</p>
<p>5.2. Add the <code>V_2</code> to the <code>P_2.Votes</code> list.</p>
<p>5.3. Increase the round by one, namely <code>P_2.round = P_1.round + 1</code>.</p>
<p>5.4. Verify that the proposal has not expired by checking that: <code>P_2.timestamp - current_time &lt; P_1.expiration_time</code>.
If this does not hold, other peers ignore the message.</p>
</li>
</ol>
<p>After the peer creates the proposal <code>P_2</code> with its vote <code>V_2</code>,
sends it to the random peer from the network or
sends it to the proposal to the specific channel.</p>
<h2 id="3-determining-the-result"><a class="header" href="#3-determining-the-result">3. Determining the result</a></h2>
<p>Because consensus depends on meeting a quorum threshold,
each peer MUST verify the accumulated votes to determine whether the necessary conditions have been satisfied.
The voting result is set YES if the majority of the <code>2n/3</code> from the distinct peers vote YES.</p>
<p>To verify, the <code>findDistinctVoter</code> method processes the proposal by traversing its <code>Votes</code> list to determine the number of unique voters.</p>
<p>If this method returns true, the peer proceeds with strong validation,
which ensures that if any honest peer reaches a decision,
no other honest peer can arrive at a conflicting result.</p>
<ol>
<li>
<p>Check each <code>signature</code> in the vote as shown in the <a href="vac/raw/consensus-hashgraphlike.html#2-exchanging-votes-across-the-peers">Section 2</a>.</p>
</li>
<li>
<p>Check the <code>parent_hash</code> chain if there are multiple votes from the same owner namely <code>vote_i</code> and <code>vote_i+1</code> respectively,
the parent hash of <code>vote_i+1</code> should be the hash of <code>vote_i</code></p>
</li>
<li>
<p>Check the <code>previous_hash</code> chain, each received hash of <code>vote_i+1</code> should be equal to the hash of <code>vote_i</code>.</p>
</li>
<li>
<p>Check the <code>timestamp</code> against the replay attack.
In particular, the <code>timestamp</code> cannot be the old in the determined threshold.</p>
</li>
<li>
<p>Check that the liveness criteria defined in the Liveness section are satisfied.</p>
</li>
</ol>
<p>If a proposal is verified by all the checks,
the <code>countVote</code> method counts each YES vote from the list of Votes.</p>
<h2 id="4-properties"><a class="header" href="#4-properties">4. Properties</a></h2>
<p>The consensus mechanism satisfies liveness and security properties as follows:</p>
<h3 id="liveness"><a class="header" href="#liveness">Liveness</a></h3>
<p>Liveness refers to the ability of the protocol to eventually reach a decision when sufficient honest participation is present.
In this protocol, if <code>n &gt; 2</code> and more than <code>n/2</code> of the votes among at least <code>2n/3</code> distinct peers are YES,
then the consensus result is defined as YES; otherwise, when <code>n ≤ 2</code>, unanimous agreement (100% YES votes) is required.</p>
<p>The peer calculates the result locally as shown in the <a href="vac/raw/consensus-hashgraphlike.html#3-determining-the-result">Section 3</a>.
From the <a href="https://hedera.com/learning/hedera-hashgraph/what-is-hashgraph-consensus">hashgraph property</a>,
if a node could calculate the result of a proposal,
it implies that no peer can calculate the opposite of the result.
Still, reliability issues can cause some situations where peers cannot receive enough messages,
so they cannot calculate the consensus result.</p>
<p>Rounds are incremented when a peer adds and sends the new proposal.
Calculating the required number of rounds, <code>2n/3</code> from the distinct peers' votes is achieved in two ways:</p>
<ol>
<li><code>2n/3</code> rounds in pure P2P networks</li>
<li><code>2</code> rounds in gossipsub</li>
</ol>
<p>Since the message complexity is <code>O(1)</code> in the gossipsub channel,
in case the network has reliability issues,
the second round is used for the peers cannot receive all the messages from the first round.</p>
<p>If an honest and online peer has received at least one vote but not enough to reach consensus,
it MAY continue to propagate its own vote — and any votes it has received — to support message dissemination.
This process can continue beyond the expected round count,
as long as it remains within the expiration time defined in the proposal.
The expiration time acts as a soft upper bound to ensure that consensus is either reached or aborted within a bounded timeframe.</p>
<h4 id="equality-of-votes"><a class="header" href="#equality-of-votes">Equality of votes</a></h4>
<p>An equality of votes occurs when verifying at least <code>2n/3</code> distinct voters and
applying <code>liveness_criteria_yes</code> the number of YES and NO votes is equal.</p>
<p>Handling ties is an application-level decision. The application MUST define a deterministic tie policy:</p>
<p>RETRY: re-run the vote with a new proposal_id, optionally adjusting parameters.</p>
<p>REJECT: abort the proposal and return voting result as NO.</p>
<p>The chosen policy SHOULD be consistent for all peers via proposal's <code>payload</code> to ensure convergence on the same outcome.</p>
<h3 id="silent-node-management"><a class="header" href="#silent-node-management">Silent Node Management</a></h3>
<p>Silent nodes are the nodes that not participate the voting as YES or NO.
There are two possible counting votes for the silent peers.</p>
<ol>
<li><strong>Silent peers means YES:</strong>
Silent peers counted as YES vote, if the application prefer the strong rejection for NO votes.</li>
<li><strong>Silent peers means NO:</strong>
Silent peers counted as NO vote, if the application prefer the strong acception for NO votes.</li>
</ol>
<p>The proposal is set to default true, which means silent peers' votes are counted as YES namely <code>liveness_criteria_yes</code> is set true by default.</p>
<h3 id="security"><a class="header" href="#security">Security</a></h3>
<p>This RFC uses cryptographic primitives to prevent the
malicious behaviours as follows:</p>
<ul>
<li>Vote forgery attempt: creating unsigned invalid votes</li>
<li>Inconsistent voting: a malicious peer submits conflicting votes (e.g., YES to some peers and NO to others)
in different stages of the protocol, violating vote consistency and attempting to undermine consensus.</li>
<li>Integrity breaking attempt: tampering history by changing previous votes.</li>
<li>Replay attack: storing the old votes to maliciously use in fresh voting.</li>
</ul>
<h2 id="5-copyright"><a class="header" href="#5-copyright">5. Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a></p>
<h2 id="6-references"><a class="header" href="#6-references">6. References</a></h2>
<ul>
<li><a href="https://hedera.com/learning/hedera-hashgraph/what-is-hashgraph-consensus">Hedera Hashgraph</a></li>
<li><a href="https://docs.hedera.com/hedera/core-concepts/hashgraph-consensus-algorithms/gossip-about-gossip">Gossip about gossip</a></li>
<li><a href="https://github.com/conanwu777/hashgraph">Simple implementation of hashgraph consensus</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="eth-dcgka"><a class="header" href="#eth-dcgka">ETH-DCGKA</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Decentralized Key and Session Setup for Secure Messaging over Ethereum</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>informational</td></tr>
<tr><th>Editor</th><td>Ramses Fernandez-Valencia &lt;ramses@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-7"><a class="header" href="#timeline-7">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/raw/decentralized-messaging-ethereum.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/raw/decentralized-messaging-ethereum.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-04</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/517b63984c875670e437d50359f2f67331104974/vac/raw/decentralized-messaging-ethereum.md"><code>517b639</code></a> — Update the RFCs: Vac Raw RFC (#143)</li>
<li><strong>2024-10-03</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/c655980494a5943634c372009bbea71c13196a8f/vac/raw/decentralized-messaging-ethereum.md"><code>c655980</code></a> — Eth secpm splitted (#91)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/vac/raw/decentralized-messaging-ethereum.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-05-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/7e3a625812bd954696b7facc29a205053d1acc3c/vac/raw/decentralized-messaging-ethereum.md"><code>7e3a625</code></a> — ETH-SECPM-DEC (#28)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-2"><a class="header" href="#abstract-2">Abstract</a></h2>
<p>This document introduces a decentralized group messaging protocol
using Ethereum adresses as identifiers.
It is based in the proposal
<a href="https://eprint.iacr.org/2020/1281">DCGKA</a> by Weidner et al.
It includes also approximations to overcome limitations related to using PKI and
the multi-device setting.</p>
<h2 id="motivation-3"><a class="header" href="#motivation-3">Motivation</a></h2>
<p>The need for secure communications has become paramount.
Traditional centralized messaging protocols are susceptible to various security
threats, including unauthorized access, data breaches, and single points of
failure.
Therefore a decentralized approach to secure communication becomes increasingly
relevant, offering a robust solution to address these challenges.</p>
<p>Secure messaging protocols used should have the following key features:</p>
<ol>
<li>
<p><strong>Asynchronous Messaging:</strong> Users can send messages even if the recipients
are not online at the moment.</p>
</li>
<li>
<p><strong>Resilience to Compromise:</strong> If a user's security is compromised,
the protocol ensures that previous messages remain secure through forward
secrecy (FS). This means that messages sent before the compromise cannot be
decrypted by adversaries. Additionally, the protocol maintains post-compromise
security (PCS) by regularly updating keys, making it difficult for adversaries
to decrypt future communication.</p>
</li>
<li>
<p><strong>Dynamic Group Management:</strong> Users can easily add or remove group members
at any time, reflecting the flexible nature of communication within the app.</p>
</li>
</ol>
<p>In this field, there exists a <em>trilemma</em>, similar to what one observes in
blockchain, involving three key aspects:</p>
<ol>
<li>security,</li>
<li>scalability, and</li>
<li>decentralization.</li>
</ol>
<p>For instance, protocols like the <a href="https://messaginglayersecurity.rocks">MLS</a>
perform well in terms of scalability and security.
However, they falls short in decentralization.</p>
<p>Newer studies such as <a href="https://eprint.iacr.org/2022/251">CoCoa</a>
improve features related to security and scalability,
but they still rely on servers, which may not be fully trusted though they are necessary.</p>
<p>On the other hand,
older studies like <a href="https://mattweidner.com/assets/pdf/acs-dissertation.pdf">Causal TreeKEM</a>
exhibit decent scalability (logarithmic)
but lack forward secrecy and have weak post-compromise security (PCS).</p>
<p>The creators of <a href="https://eprint.iacr.org/2020/1281">DCGKA</a> introduce a decentralized,
asynchronous secure group messaging protocol that supports dynamic groups.
This protocol operates effectively on various underlying networks
without strict requirements on message ordering or latency.
It can be implemented in peer-to-peer or anonymity networks,
accommodating network partitions, high latency links, and
disconnected operation seamlessly.
Notably, the protocol doesn't rely on servers or
a consensus protocol for its functionality.</p>
<p>This proposal provides end-to-end encryption with forward secrecy and
post-compromise security,
even when multiple users concurrently modify the group state.</p>
<h2 id="theory"><a class="header" href="#theory">Theory</a></h2>
<h3 id="protocol-overview"><a class="header" href="#protocol-overview">Protocol overview</a></h3>
<p>This protocol makes use of ratchets to provide FS
by encrypting each message with a different key.</p>
<p>In the figure one can see the ratchet for encrypting a sequence of messages.
The sender requires an initial update secret <code>I_1</code>, which is introduced in a PRG.
The PRG will produce two outputs, namely a symmetric key for AEAD encryption, and
a seed for the next ratchet state.
The associated data needed in the AEAD encryption includes the message index <code>i</code>.
The ciphertext <code>c_i</code> associated to message <code>m_i</code>
is then broadcasted to all group members.
The next step requires deleting <code>I_1</code>, <code>k_i</code> and any old ratchet state.</p>
<p>After a period of time the sender may replace the ratchet state with new update secrets
<code>I_2</code>, <code>I_3</code>, and so on.</p>
<p>To start a post-compromise security update,
a user creates a new random value known as a seed secret and
shares it with every other group member through a secure two-party channel.
Upon receiving the seed secret,
each group member uses it to calculate an update secret for both the sender's ratchet
and their own.
Additionally, the recipient sends an unencrypted acknowledgment to the group
confirming the update.
Every member who receives the acknowledgment updates
not only the ratchet for the original sender but
also the ratchet for the sender of the acknowledgment.
Consequently, after sharing the seed secret through <code>n - 1</code> two-party messages and
confirming it with <code>n - 1</code> broadcast acknowledgments,
every group member has derived an update secret and updated their ratchet accordingly.</p>
<p>When removing a group member,
the user who initiates the removal conducts a post-compromise security update
by sending the update secret to all group members except the one being removed.
To add a new group member,
each existing group member shares the necessary state with the new user,
enabling them to derive their future update secrets.</p>
<p>Since group members may receive messages in various orders,
it's important to ensure that each sender's ratchet is updated consistently
with the same sequence of update secrets at each group member.</p>
<p>The network protocol used in this scheme ensures that messages from the same sender
are processed in the order they were sent.</p>
<h3 id="components-of-the-protocol"><a class="header" href="#components-of-the-protocol">Components of the protocol</a></h3>
<p>This protocol relies in 3 components:
authenticated causal broadcast (ACB),
decentralized group membership (DGM) and
2-party secure messaging (2SM).</p>
<h4 id="authenticated-causal-broadcast"><a class="header" href="#authenticated-causal-broadcast">Authenticated causal broadcast</a></h4>
<p>A causal order is a partial order relation <code>&lt;</code> on messages.
Two messages <code>m_1</code> and <code>m_2</code> are causally ordered, or
<code>m_1</code> causally precedes <code>m_2</code>
(denoted by <code>m_1 &lt; m_2</code>), if one of the following contiditions hold:</p>
<ol>
<li><code>m_1</code> and <code>m_2</code> were sent by the same group member, and
<code>m_1</code> was sent before <code>m_2</code>.</li>
<li><code>m_2</code> was sent by a group member U, and <code>m_1</code> was received and
processed by <code>U</code> before sending <code>m_2</code>.</li>
<li>There exists <code>m_3</code> such that <code>m_1 &lt; m_3</code> and <code>m_3 &lt; m_2</code>.</li>
</ol>
<p>Causal broadcast requires that before processing <code>m</code>, a group member must
process all preceding messages <code>{m' | m' &lt; m}</code>.</p>
<p>The causal broadcast module used in this protocol authenticates the sender of
each message, as well as its causal ordering metadata, using a digital
signature under the sender’s identity key.
This prevents a passive adversary from impersonating users or affecting
causally ordered delivery.</p>
<h4 id="decentralized-group-membership"><a class="header" href="#decentralized-group-membership">Decentralized group membership</a></h4>
<p>This protocol assumes the existence of a decentralized group membership
function (denoted as DGM) that takes a set of membership change messages and
their causal order relantionships, and returns the current set of group
members’ IDs. It needs to be deterministic and depend only on causal order, and
not exact order.</p>
<h4 id="2-party-secure-messaging-2sm"><a class="header" href="#2-party-secure-messaging-2sm">2-party secure messaging (2SM)</a></h4>
<p>This protocol makes use of bidirectional 2-party secure messaging schemes,
which consist of 3 algorithms: <code>2SM-Init</code>, <code>2SM-Send</code> and <code>2SM-Receive</code>.</p>
<h5 id="function-2sm-init"><a class="header" href="#function-2sm-init">Function 2SM-Init</a></h5>
<p>This function takes two IDs as inputs:
<code>ID1</code> representing the local user and <code>ID2</code> representing the other party.
It returns an initial protocol state <code>sigma</code>.
The 2SM protocol relies on a Public Key Infrastructure (PKI) or
a key server to map these IDs to their corresponding public keys.
In practice, the PKI should incorporate ephemeral prekeys.
This allows users to send messages to a new group member,
even if that member is currently offline.</p>
<h5 id="function-2sm-send"><a class="header" href="#function-2sm-send">Function 2SM-Send</a></h5>
<p>This function takes a state <code>sigma</code> and a plaintext <code>m</code> as inputs, and returns
a new state <code>sigma’</code> and a ciphertext <code>c</code>.</p>
<h5 id="function-2sm-receive"><a class="header" href="#function-2sm-receive">Function 2SM-Receive</a></h5>
<p>This function takes a state <code>sigma</code> and a ciphertext <code>c</code>, and
returns a new state <code>sigma’</code> and a plaintext <code>m</code>.</p>
<p>This function takes a state <code>sigma</code> and a ciphertext <code>c</code>, and returns a new
state <code>sigma’</code> and a plaintext <code>m</code>.</p>
<h4 id="function-2sm-syntax"><a class="header" href="#function-2sm-syntax">Function 2SM Syntax</a></h4>
<p>The variable <code>sigma</code> denotes the state consisting in the variables below:</p>
<pre><code class="language-text">sigma.mySks[0] = sk
sigma.nextIndex = 1 
sigma.receivedSk = empty_string
sigma.otherPk = pk`&lt;br&gt; 
sigma.otherPksender = “other”
sigma.otherPkIndex = 0

</code></pre>
<h4 id="2sm-init"><a class="header" href="#2sm-init">2SM-Init</a></h4>
<p>On input a key pair <code>(sk, pk)</code>, this functions otuputs a state <code>sigma</code>.</p>
<h4 id="2sm-send"><a class="header" href="#2sm-send">2SM-Send</a></h4>
<p>This function encrypts the message <code>m</code> using <code>sigma.otherPk</code>, which represents
the other party’s current public key.
This key is determined based on the last public key generated for the other
party or the last public key received from the other party,
whichever is more recent. <code>sigma.otherPkSender</code> is set to <code>me</code> in the former
case and <code>other</code> in the latter case.</p>
<p>Metadata including <code>otherPkSender</code> and <code>otherPkIndex</code> are included in the
message to indicate which of the recipient’s public keys is being utilized.</p>
<p>Additionally, this function generates a new key pair for the local user,
storing the secret key in <code>sigma.mySks</code> and sending the public key.
Similarly, it generates a new key pair for the other party,
sending the secret key (encrypted) and storing the public key in
<code>sigma.otherPk</code>.</p>
<pre><code class="language-text">sigma.mySks[sigma.nextIndex], myNewPk) = PKE-Gen()
(otherNewSk, otherNewPk) = PKE-Gen()
plaintext = (m, otherNewSk, sigma`.nextIndex, myNewPk)
msg = (PKE-Enc(sigma.otherPk, plaintext), sigma.otherPkSender, sigma.otherPkIndex)
sigma.nextIndex++
(sigma.otherPk, sigma.otherPkSender, sigma.otherPkIndex) = (otherNewPk, "me", empty_string)
return (sigma`, msg)

</code></pre>
<h4 id="2sm-receive"><a class="header" href="#2sm-receive">2SM-Receive</a></h4>
<p>This function utilizes the metadata of the message <code>c</code> to determine which
secret key to utilize for decryption, assigning it to <code>sk</code>.
If the secret key corresponds to one generated by ourselves,
that secret key along with all keys with lower index are deleted.
This deletion is indicated by <code>sigma.mySks[≤ keyIndex] = empty_string</code>.
Subsequently, the new public and secret keys contained in the message are
stored.</p>
<pre><code class="language-text">(ciphertext, keySender, keyIndex) = c
if keySender = "other" then 
sk = sigma.mySks[keyIndex] 
sigma.mySks[≤ keyIndex] = empty_string
else sk = sigma.receivedSk
(m, sigma.receivedSk, sigma.otherPkIndex, sigma.otherPk) = PKE-Dec(sk, ciphertext)
sigma.otherPkSender = "other"
return (sigma, m)

</code></pre>
<h3 id="pke-syntax"><a class="header" href="#pke-syntax">PKE Syntax</a></h3>
<p>The required PKE that MUST be used is ElGamal with a 2048-bit modulus <code>p</code>.</p>
<h4 id="parameters"><a class="header" href="#parameters">Parameters</a></h4>
<p>The following parameters must be used:</p>
<pre><code class="language-text">p = 308920927247127345254346920820166145569
g = 2

</code></pre>
<h4 id="pke-kgen"><a class="header" href="#pke-kgen">PKE-KGen</a></h4>
<p>Each user <code>u</code> MUST do the following:</p>
<pre><code class="language-text">PKE-KGen():
a = randint(2, p-2)
pk = (p, g, g^a)
sk = a
return (pk, sk)

</code></pre>
<h4 id="pke-enc"><a class="header" href="#pke-enc">PKE-Enc</a></h4>
<p>A user <code>v</code> encrypting a message <code>m</code> for <code>u</code> MUST follow these steps:</p>
<pre><code class="language-text">PKE-Enc(pk):
k = randint(2, p-2)
eta = g^k % p
delta = m * (g^a)^k % p
return ((eta, delta))

</code></pre>
<h4 id="pke-dec"><a class="header" href="#pke-dec">PKE-Dec</a></h4>
<p>The user <code>u</code> recovers a message <code>m</code> from a ciphertext <code>c</code>
by performing the following operations:</p>
<pre><code class="language-text">PKE-Dec(sk):
mu = eta^(p-1-sk) % p
return ((mu * delta) % p)

</code></pre>
<h3 id="dcgka-syntax"><a class="header" href="#dcgka-syntax">DCGKA Syntax</a></h3>
<h4 id="auxiliary-functions"><a class="header" href="#auxiliary-functions">Auxiliary functions</a></h4>
<p>There exist 6 functions that are auxiliary for the rest of components of the
protocol, namely:</p>
<h4 id="init"><a class="header" href="#init">init</a></h4>
<p>This function takes an <code>ID</code> as input and returns its associated initial state,
denoted by <code>gamma</code>:</p>
<pre><code class="language-text">gamma.myId = ID
gamma.mySeq = 0
gamma.history = empty
gamma.nextSeed = empty_string
gamma.2sm[·] = empty_string
gamma.memberSecret[·, ·, ·] = empty_string
gamma.ratchet[·] = empty_string
return (gamma)

</code></pre>
<h4 id="encrypt-to"><a class="header" href="#encrypt-to">encrypt-to</a></h4>
<p>Upon reception of the recipient’s <code>ID</code> and a plaintext, it encrypts a direct
message for another group member.
Should it be the first message for a particular <code>ID</code>,
then the <code>2SM</code> protocol state is initialized and stored in
<code>gamma.2sm[recipient.ID]</code>.
One then uses <code>2SM_Send</code> to encrypt the message and store the updated protocol
in <code>gamma</code>.</p>
<pre><code class="language-text">if gamma.2sm[recipient_ID] = empty_string then
 gamma.2sm[recipient_ID] = 2SM_Init(gamma.myID, recipient_ID)
(gamma.2sm[recipient_ID], ciphertext) = 2SM_Send(gamma.2sm[recipient_ID], plaintext)
return (gamma, ciphertext)

</code></pre>
<h4 id="decrypt-from"><a class="header" href="#decrypt-from">decrypt-from</a></h4>
<p>After receiving the sender’s <code>ID</code> and a ciphertext, it behaves as the reverse
function of <code>encrypt-to</code> and has a similar initialization:</p>
<pre><code class="language-text">if gamma.2sm[sender_ID] = empty_string then
gamma.2sm[sender_ID] = 2SM_Init(gamma.myID, sender_ID)
(gamma.2sm[sender_ID], plaintext) = 2SM_Receive(gamma.2sm[sender_ID], ciphertext)
return (gamma, plaintext)

</code></pre>
<h4 id="update-ratchet"><a class="header" href="#update-ratchet">update-ratchet</a></h4>
<p>This function generates the next update secret <code>I_update</code> for the group member
<code>ID</code>.
The ratchet state is stored in <code>gamma.ratchet[ID]</code>.
It is required to use a HMAC-based key derivation function HKDF to combine the
ratchet state with an input, returning an update secret and a new ratchet
state.</p>
<pre><code class="language-text">(updateSecret, gamma.ratchet[ID]) = HKDF(gamma.ratchet[ID], input)
return (gamma, updateSecret)

</code></pre>
<h4 id="member-view"><a class="header" href="#member-view">member-view</a></h4>
<p>This function calculates the set of group members
based on the most recent control message sent by the specified user <code>ID</code>.
It filters the group membership operations
to include only those observed by the specified <code>ID</code>, and
then invokes the DGM function to generate the group membership.</p>
<pre><code class="language-text">ops = {m in gamma.history st. m was sent or acknowledged by ID}
return DGM(ops)

</code></pre>
<h4 id="generate-seed"><a class="header" href="#generate-seed">generate-seed</a></h4>
<p>This functions generates a random bit string and
sends it encrypted to each member of the group using the <code>2SM</code> mechanism.
It returns the updated protocol state and
the set of direct messages (denoted as <code>dmsgs</code>) to send.</p>
<pre><code class="language-text">gamma.nextSeed = random.randbytes()
dmsgs = empty
for each ID in recipients:
(gamma, msg) = encrypt-to(gamma, ID, gamma.nextSeed)
dmsgs = dmsgs + (ID, msg)
return (gamma, dmsgs)

</code></pre>
<h3 id="creation-of-a-group"><a class="header" href="#creation-of-a-group">Creation of a group</a></h3>
<p>A group is generated in a 3 steps procedure:</p>
<ol>
<li>A user calls the <code>create</code> function and broadcasts a control message of type
<em>create</em>.</li>
<li>Each receiver of the message processes the message and broadcasts an <em>ack</em>
control message.</li>
<li>Each member processes the <em>ack</em> message received.</li>
</ol>
<h4 id="create"><a class="header" href="#create">create</a></h4>
<p>This function generates a <em>create</em> control message and calls <code>generate-seed</code> to
define the set of direct messages that need to be sent.
Then it calls <code>process-create</code> to process the control message for this user.
The function <code>process-create</code> returns a tuple including an updated state gamma
and an update secret <code>I</code>.</p>
<pre><code class="language-text">control = (“create”, gamma.mySeq, IDs)
(gamma, dmsgs) = generate-seed(gamma, IDs)
(gamma, _, _, I, _) = process-create(gamma, gamma.myId, gamma.mySeq, IDs, empty_string)
return (gamma, control, dmsgs, I)

</code></pre>
<h4 id="process-seed"><a class="header" href="#process-seed">process-seed</a></h4>
<p>This function initially employs <code>member-view</code> to identify the users who were
part of the group when the control message was dispatched.
Then, it attempts to acquire the seed secret through the following steps:</p>
<ol>
<li>If the control message was dispatched by the local user, it uses the most
recent invocation of <code>generate-seed</code> stored the seed secret in
<code>gamma.nextSeed</code>.</li>
<li>If the <code>control</code> message was dispatched by another user, and the local user
is among its recipients, the function utilizes <code>decrypt-from</code> to decrypt the
direct message that includes the seed secret.</li>
<li>Otherwise, it returns an <code>ack</code> message without deriving an update secret.</li>
</ol>
<p>Afterwards, <code>process-seed</code> generates separate member secrets for each group
member from the seed secret by combining the seed secret and
each user ID using HKDF.
The secret for the sender of the message is stored in <code>senderSecret</code>, while
those for the other group members are stored in <code>gamma.memberSecret</code>.
The sender's member secret is immediately utilized to update their KDF ratchet
and compute their update secret <code>I_sender</code> using <code>update-ratchet</code>.
If the local user is the sender of the control message, the process is
completed, and the update secret is returned.
However, if the seed secret is received from another user, an <code>ack</code> control
message is constructed for broadcast, including the sender ID and sequence
number of the message being acknowledged.</p>
<p>The final step computes an update secret <code>I_me</code> for the local user invoking the
<code>process-ack</code> function.</p>
<pre><code class="language-text">recipients = member-view(gamma, sender) - {sender}
if sender =  gamma.myId then seed = gamma.nextSeed; gamma.nextSeed =
empty_string
else if  gamma.myId in recipients then (gamma, seed) = decrypt-from(gamma,
sender, dmsg)
else
return (gamma, (ack, ++gamma.mySeq, (sender, seq)), empty_string ,
empty_string , empty_string)

for ID in recipients do gamma.memberSecret[sender, seq, ID] = HKDF(seed, ID)
senderSecret = HKDF(seed, sender)
(gamma, I_sender) = update-ratchet(gamma, sender, senderSecret)
if sender = gamma.myId then return (gamma, empty_string , empty_string ,
I_sender, empty_string)
control = (ack, ++gamma.mySeq, (sender, seq))
members = member-view(gamma, gamma.myId)
forward = empty
for ID in {members - (recipients + {sender})}
    s = gamma.memberSecret[sender, seq, gamma.myId]
    (gamma, msg) = encrypt-to(gamma, ID, s)
    forward = forward + {(ID, msg)}
    (gamma, _, _, I_me, _) = process-ack(gamma, gamma.myId, gamma.mySeq, 
    (sender, seq), empty_string)
    return (gamma, control, forward, I_sender, I_me)

</code></pre>
<h4 id="process-create"><a class="header" href="#process-create">process-create</a></h4>
<p>This function is called by the sender and each of the receivers of the <code>create</code>
control message.
First, it records the information from the create message in the
<code>gamma.history+ {op}</code>, which is used to track group membership changes. Then,
it proceeds to call <code>process-seed</code>.</p>
<pre><code class="language-text">op = (”create”, sender, seq, IDs)
gamma.history = gamma.history + {op}
return (process-seed(gamma, sender, seq, dmsg))

</code></pre>
<h4 id="process-ack"><a class="header" href="#process-ack">process-ack</a></h4>
<p>This function is called by those group members once they receive an ack
message.
In <code>process-ack</code>, <code>ackID</code> and <code>ackSeq</code> are the sender and sequence number of
the acknowledged message.
Firstly, if the acknowledged message is a group membership operation, it
records the acknowledgement in <code>gamma.history</code>.</p>
<p>Following this, the function retrieves the relevant member secret from
<code>gamma.memberSecret</code>, which was previously obtained from the seed secret
contained in the acknowledged message.</p>
<p>Finally, it updates the ratchet for the sender of the <code>ack</code> and returns the
resulting update secret.</p>
<pre><code class="language-text">if (ackID, ackSeq) was a create / add / remove then
op = ("ack", sender, seq, ackID, ackSeq)
gamma.history = gamma.history + {op}`
s = gamma.memberSecret[ackID, ackSeq, sender]
gamma.memberSecret[ackID, ackSeq, sender] = empty_string
if (s = empty_string) &amp; (dmsg = empty_string) then return (gamma, empty_string,
empty_string, empty_string, empty_string)
if (s = empty_string) then (gamma, s) = decrypt-from(gamma, sender, dmsg)
(gamma, I) = update-ratchet(gamma, sender, s)
return (gamma, empty_string, empty_string, I, empty_string)

</code></pre>
<p>The HKDF function MUST follow RFC 5869 using the hash function SHA256.</p>
<h3 id="post-compromise-security-updates-and-group-member-removal"><a class="header" href="#post-compromise-security-updates-and-group-member-removal">Post-compromise security updates and group member removal</a></h3>
<p>The functions <code>update</code> and <code>remove</code> share similarities with <code>create</code>:
they both call the function <code>generate-seed</code> to encrypt a new seed secret for
each group member.
The distinction lies in the determination of the group members using <code>member view</code>.
In the case of <code>remove</code>, the user being removed is excluded from the recipients
of the seed secret.
Additionally, the control message they construct is designated with type
<code>update</code> or <code>remove</code> respectively.</p>
<p>Likewise, <code>process-update</code> and <code>process-remove</code> are akin to <code>process-create</code>.
The function <code>process-update</code> skips the update of <code>gamma.history</code>,
whereas <code>process-remove</code> includes a removal operation in the history.</p>
<h4 id="update"><a class="header" href="#update">update</a></h4>
<pre><code class="language-text">control = ("update", ++gamma.mySeq, empty_string)
recipients = member-view(gamma, gamma.myId) - {gamma.myId}
(gamma, dmsgs) = generate-seed(gamma, recipients)
(gamma, _, _, I , _) = process-update(gamma, gamma.myId, gamma.mySeq,
empty_string, empty_string)
return (gamma, control, dmsgs, I)

</code></pre>
<h4 id="remove"><a class="header" href="#remove">remove</a></h4>
<pre><code class="language-text">control = ("remove", ++gamma.mySeq, empty)
recipients = member-view(gamma, gamma.myId) - {ID, gamma.myId}
(gamma, dmsgs) = generate-seed(gamma, recipients)
(gamma, _, _, I , _) = process-update(gamma, gamma.myId, gamma.mySeq, ID,
empty_string)
return (gamma, control, dmsgs, I)

</code></pre>
<h4 id="process-update"><a class="header" href="#process-update">process-update</a></h4>
<p><code>return process-seed(gamma, sender, seq, dmsg)</code></p>
<h4 id="process-remove"><a class="header" href="#process-remove">process-remove</a></h4>
<pre><code class="language-text">op = ("remove", sender, seq, removed)
gamma.history = gamma.history + {op}
return process-seed(gamma, sender, seq, dmsg)

</code></pre>
<h3 id="group-member-addition"><a class="header" href="#group-member-addition">Group member addition</a></h3>
<h4 id="add"><a class="header" href="#add">add</a></h4>
<p>When adding a new group member, an existing member initiates the process by
invoking the <code>add</code> function and providing the ID of the user to be added.
This function prepares a control message marked as <code>add</code> for broadcast to the
group. Simultaneously, it creates a welcome message intended for the new member
as a direct message.
This <code>welcome</code> message includes the current state of the sender's KDF ratchet,
encrypted using <code>2SM</code>, along with the history of group membership operations
conducted so far.</p>
<pre><code class="language-text">control = ("add", ++gamma.mySeq, ID)
(gamma, c) = encrypt-to(gamma, ID, gamma.ratchet[gamma.myId])
op = ("add", gamma.myId, gamma.mySeq, ID)
welcome = (gamma.history + {op}, c)
(gamma, _, _, I, _) = process-add(gamma, gamma.myId, gamma.mySeq, ID, empty_string)
return (gamma, control, (ID, welcome), I)

</code></pre>
<h4 id="process-add"><a class="header" href="#process-add">process-add</a></h4>
<p>This function is invoked by both the sender and each recipient of an <code>add</code>
message, which includes the new group member. If the local user is the newly
added member, the function proceeds to call <code>process-welcome</code> and then exits.
Otherwise, it extends <code>gamma.history</code> with the <code>add</code> operation.</p>
<p>Line 5 determines whether the local user was already a group member at the time
the <code>add</code> message was sent; this condition is typically true but may be false
if multiple users were added concurrently.</p>
<p>On lines 6 to 8, the ratchet for the sender of the <em>add</em> message is updated
twice. In both calls to <code>update-ratchet</code>, a constant string is used as the
ratchet input instead of a random seed secret.</p>
<p>The value returned by the first ratchet update is stored in
<code>gamma.memberSecret</code> as the added user’s initial member secret. The result of
the second ratchet update becomes <code>I_sender</code>, the update secret for the sender
of the <code>add</code> message. On line 10, if the local user is the sender, the update
secret is returned.</p>
<p>If the local user is not the sender, an acknowledgment for the <code>add</code> message is
required.
Therefore, on line 11, a control message of type <code>add-ack</code> is constructed for
broadcast.
Subsequently, in line 12 the current ratchet state is encrypted using <code>2SM</code> to
generate a direct message intended for the added user, allowing them to decrypt
subsequent messages sent by the sender.
Finally, in lines 13 to 15, <code>process-add-ack</code> is called to calculate the local
user’s update secret (<code>I_me</code>), which is then returned along with <code>I_sender</code>.</p>
<pre><code class="language-text">if added = gamma.myId then return process-welcome(gamma, sender, seq, dmsg)
op = ("add", sender, seq, added)
gamma.history = gamma.history + {op}
if gamma.myId in member-view(gamma, sender) then
    (gamma, s) = update-ratchet(gamma, sender, "welcome")
    gamma.memberSecret[sender, seq, added] = s
    (gamma, I_sender) = update-ratchet(gamma, sender, "add")
    else I_sender = empty_string
    if sender = gamma.myId then return (gamma, empty_string, empty_string,
    I_sender, empty_string)
    control = ("add-ack", ++gamma.mySeq, (sender, seq))
    (gamma, c) = encrypt-to(gamma, added, ratchet[gamma.myId])
    (gamma, _, _, I_me, _) = process-add-ack(gamma, gamma.myId, gamma.mySeq,
    (sender, seq), empty_string)
    return (gamma, control, {(added, c)}, I_sender, I_me)

</code></pre>
<h4 id="process-add-ack"><a class="header" href="#process-add-ack">process-add-ack</a></h4>
<p>This function is invoked by both the sender and each recipient of an <code>add-ack</code>
message, including the new group member. Upon lines 1–2, the acknowledgment is
added to <code>gamma.history</code>, mirroring the process in <code>process-ack</code>.
If the current user is the new group member, the <code>add-ack</code> message includes the
direct message constructed in <code>process-add</code>; this direct message contains the
encrypted ratchet state of the sender of the <code>add-ack</code>, then it is decrypted on
lines 3–5.</p>
<p>Upon line 6, a check is performed to check if the local user was already a
group member at the time the <code>add-ack</code> was sent. If affirmative, a new update
secret <code>I</code> for the sender of the <code>add-ack</code> is computed on line 7 by invoking
<code>update-ratchet</code> with the constant string <code>add</code>.</p>
<p>In the scenario involving the new member,  the ratchet state was recently
initialized on line 5. This ratchet update facilitates all group members,
including the new addition, to derive each member’s update by obtaining any
update secret from before their inclusion.</p>
<pre><code class="language-text">op = ("ack", sender, seq, ackID, ackSeq)
gamma$.history = gamma.history + {op}
if dmsg != empty_string then
    (gamma, s) = decrypt-from(gamma, sender, dmsg)
    gamma.ratchet[sender] = s
if gamma.myId in member-view(gamma, sender) then
    (gamma, I) = update-ratchet(gamma, sender, "add")
    return (gamma, empty_string, empty_string, I, empty_string)
else return (gamma, empty_string, empty_string, empty_string, empty_string)

</code></pre>
<h4 id="process-welcome"><a class="header" href="#process-welcome">process-welcome</a></h4>
<p>This function serves as the second step called by a newly added group member.
In this context, <code>adderHistory</code> represents the adding user’s copy of
<code>gamma.history</code> sent in their welcome message, which is utilized to initialize
the added user’s history.
Here, <code>c</code> denotes the ciphertext of the adding user’s ratchet state, which is
decrypted on line 2 using <code>decrypt-from</code>.</p>
<p>Once <code>gamma.ratchet[sender]</code> is initialized, <code>update-ratchet</code> is invoked twice
on lines 3 to 5 with the constant strings <code>welcome</code> and <code>add</code> respectively.
These operations mirror the ratchet operations performed by every other group
member in <code>process-add</code>.
The outcome of the first <code>update-ratchet</code> call becomes the first member secret
for the added user,
while the second call returns <code>I_sender</code>, the update secret for the sender of
the add operation.</p>
<p>Subsequently, the new group member constructs an <em>ack</em> control message to
broadcast on line 6 and calls <code>process-ack</code> to compute their initial update
secret I_me. The function <code>process-ack</code> reads from <code>gamma.memberSecret</code> and
passes it to <code>update-ratchet</code>. The previous ratchet state for the new member is
the empty string <code>empty</code>, as established by <code>init</code>, thereby initializing the
new member’s ratchet.
Upon receiving the new member’s <code>ack</code>, every other group member initializes
their copy of the new member’s ratchet in a similar manner.</p>
<p>By the conclusion of <code>process-welcome</code>, the new group member has acquired
update secrets for themselves and the user who added them.
The ratchets for other group members are initialized by <code>process-add-ack</code>.</p>
<pre><code class="language-text">gamma.history = adderHistory
(gamma, gamma.ratchet[sender]) = decrypt-from(gamma, sender, c)
(gamma, s) = update-ratchet(gamma, sender, "welcome")
gamma.memberSecret[sender, seq, gamma.myId] = s
(gamma, I_sender) = update-ratchet(gamma, sender, "add")
control = ("ack", ++gamma.mySeq, (sender, seq))
(gamma, _, _, I_me, _) = process-ack(gamma, gamma.myId, gamma.mySeq, (sender,
seq), empty_string)
return (gamma, control, empty_string , I_sender, I_me)

</code></pre>
<h2 id="privacy-considerations"><a class="header" href="#privacy-considerations">Privacy Considerations</a></h2>
<h3 id="dependency-on-pki"><a class="header" href="#dependency-on-pki">Dependency on PKI</a></h3>
<p>The <a href="https://eprint.iacr.org/2020/1281">DCGKA</a> proposal presents some
limitations highlighted by the authors.
Among these limitations one finds the requirement of a PKI (or a key server)
mapping IDs to public keys.</p>
<p>One method to overcome this limitation is adapting the protocol SIWE (Sign in
with Ethereum) so a user <code>u_1</code> who wants to start a communication with a user
<code>u_2</code> can interact with latter’s wallet to request a public key using an
Ethereum address as <code>ID</code>.</p>
<h4 id="siwe"><a class="header" href="#siwe">SIWE</a></h4>
<p>The <a href="https://docs.login.xyz/general-information/siwe-overview">SIWE</a> (Sign In
With Ethereum) proposal was a suggested standard for leveraging Ethereum to
authenticate and authorize users on web3 applications.
Its goal is to establish a standardized method for users to sign in to web3
applications using their Ethereum address and private key,
mirroring the process by which users currently sign in to web2 applications
using their email and password.
Below follows the required steps:</p>
<ol>
<li>A server generates a unique Nonce for each user intending to sign in.</li>
<li>A user initiates a request to connect to a website using their wallet.</li>
<li>The user is presented with a distinctive message that includes the Nonce and
details about the website.</li>
<li>The user authenticates their identity by signing in with their wallet.</li>
<li>Upon successful authentication, the user's identity is confirmed or
approved.</li>
<li>The website grants access to data specific to the authenticated user.</li>
</ol>
<h4 id="our-approach"><a class="header" href="#our-approach">Our approach</a></h4>
<p>The idea in the <a href="https://eprint.iacr.org/2020/1281">DCGKA</a> setting closely
resembles the procedure outlined in SIWE. Here:</p>
<ol>
<li>The server corresponds to user D1,who initiates a request (instead of
generating a nonce) to obtain the public key of user D2.</li>
<li>Upon receiving the request, the wallet of D2 send the request to the user,</li>
<li>User D2 receives the request from the wallet, and decides whether accepts or
rejects.</li>
<li>The wallet and responds with a message containing the requested public key
in case of acceptance by D2.</li>
</ol>
<p>This message may be signed, allowing D1 to verify that the owner of the
received public key is indeed D2.</p>
<h3 id="multi-device-setting"><a class="header" href="#multi-device-setting">Multi-device setting</a></h3>
<p>One may see the set of devices as a group and create a group key for internal
communications.
One may use treeKEM for instance, since it provides interesting properties like
forward secrecy and post-compromise security.
All devices share the same <code>ID</code>, which is held by one of them, and from other
user’s point of view, they would look as a single user.</p>
<p>Using servers, like in the paper
<a href="https://eprint.iacr.org/2019/1363">Multi-Device for Signal</a>, should be
avoided; but this would imply using a particular device as receiver and
broadcaster within the group.
There is an obvious drawback which is having a single device working as a
“server”. Should this device be attacked or without connection, there should be
a mechanism for its revocation and replacement.</p>
<p>Another approach for communications between devices could be using the keypair
of each device. This could open the door to use UPKE, since keypairs should be
regenerated frequently.</p>
<p>Each time a device sends a message, either an internal message or an external
message, it needs to replicate and broadcast it to all devices in the group.</p>
<p>The mechanism for the substitution of misbehaving leader devices follows:</p>
<ol>
<li>Each device within a group knows the details of other leader devices. This
information may come from metadata in received messages, and is replicated by
the leader device.</li>
<li>To replace a leader, the user should select any other device within its
group and use it to send a signed message to all other users.</li>
<li>To get the ability to sign messages, this new leader should request the
keypair associated to the ID to the wallet.</li>
<li>Once the leader has been changed, it revocates access from DCGKA to the
former leader using the DCGKA protocol.</li>
<li>The new leader starts a key update in DCGKA.</li>
</ol>
<p>Not all devices in a group should be able to send messages to other users. Only
the leader device should be in charge of sending and receiving messages.
To prevent other devices from sending messages outside their group, a
requirement should be signing each message. The keys associated to the <code>ID</code>
should only be in control of the leader device.</p>
<p>The leader device is in charge of setting the keys involved in the DCGKA. This
information must be replicated within the group to make sure it is updated.</p>
<p>To detect missing messages or potential misbehavior, messages must include a
counter.</p>
<h3 id="using-upke"><a class="header" href="#using-upke">Using UPKE</a></h3>
<p>Managing the group of devices of a user can be done either using a group key
protocol such as treeKEM or using the keypair of each device.
Setting a common key for a group of devices under the control of the same actor
might be excessive, furthermore it may imply some of the problems one can find
in the usual setting of a group of different users;
for example: one of the devices may not participate in the required updating
processes, representing a threat for the group.</p>
<p>The other approach to managing the group of devices is using each device’s
keypair, but it would require each device updating these materia frequently,
something that may not happens.</p>
<p><a href="https://eprint.iacr.org/2022/068">UPKE</a> is a form of asymetric cryptography
where any user can update any other user’s key pair by running an update
algorithm with (high-entropy) private coins. Any sender can initiate a <em>key
update</em> by sending a special update ciphertext.
This ciphertext updates the receiver’s public key and also, once processed by
the receiver, will update their secret key.</p>
<p>To the best of my knowledge, there exists several efficient constructions both
<a href="https://eprint.iacr.org/2019/1189">UPKE from ElGamal</a> (based in the DH
assumption) and <a href="vac/raw/(https://eprint.iacr.org/2023/1400)">UPKE from Lattices</a>
(based in lattices).
None of them have been implemented in a secure messaging protocol, and this
opens the door to some novel research.</p>
<h2 id="copyright-5"><a class="header" href="#copyright-5">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-2"><a class="header" href="#references-2">References</a></h2>
<ul>
<li><a href="https://eprint.iacr.org/2020/1281">DCGKA</a></li>
<li><a href="https://messaginglayersecurity.rocks">MLS</a></li>
<li><a href="https://eprint.iacr.org/2022/251">CoCoa</a></li>
<li><a href="https://mattweidner.com/assets/pdf/acs-dissertation.pdf">Causal TreeKEM</a></li>
<li><a href="https://docs.login.xyz/general-information/siwe-overview">SIWE</a></li>
<li><a href="https://eprint.iacr.org/2019/1363">Multi-device for Signal</a></li>
<li><a href="https://eprint.iacr.org/2022/068">UPKE</a></li>
<li><a href="https://eprint.iacr.org/2019/1189">UPKE from ElGamal</a></li>
<li><a href="https://eprint.iacr.org/2023/1400">UPKE from Lattices</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="eth-mls-offchain"><a class="header" href="#eth-mls-offchain">ETH-MLS-OFFCHAIN</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Secure channel setup using decentralized MLS and Ethereum accounts</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Ugur Sen [ugur@status.im](mailto:ugur@status.im)</td></tr>
<tr><th>Contributors</th><td>s<br>e<br>e<br>m<br>e<br>n<br>k<br>i<br>n<br>a<br> <br>[<br>e<br>k<br>a<br>t<br>e<br>r<br>i<br>n<br>a<br>@<br>s<br>t<br>a<br>t<br>u<br>s<br>.<br>i<br>m<br>]<br>(<br>m<br>a<br>i<br>l<br>t<br>o<br>:<br>e<br>k<br>a<br>t<br>e<br>r<br>i<br>n<br>a<br>@<br>s<br>t<br>a<br>t<br>u<br>s<br>.<br>i<br>m<br>)</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-8"><a class="header" href="#timeline-8">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/raw/eth-mls-offchain.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/raw/eth-mls-offchain.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-11-26</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/e39d2884fee1b8a0b1b20a430d7004945ce919f6/vac/raw/eth-mls-offchain.md"><code>e39d288</code></a> — VAC/RAW/ ETH-MLS-OFFCHAIN RFC multi-steward support (#193)</li>
<li><strong>2025-08-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3b968ccce3848da67cddb0295a9cdcb37d63d18c/vac/raw/eth-mls-offchain.md"><code>3b968cc</code></a> — VAC/RAW/ ETH-MLS-OFFCHAIN RFC  (#166)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-3"><a class="header" href="#abstract-3">Abstract</a></h2>
<p>The following document specifies Ethereum authenticated scalable
and decentralized secure group messaging application by
integrating Message Layer Security (MLS) backend.
Decentralization refers each user is a node in P2P network and
each user has voice for any changes in group.
This is achieved by integrating a consensus mechanism.
Lastly, this RFC can also be referred to as de-MLS,
decentralized MLS, to emphasize its deviation
from the centralized trust assumptions of traditional MLS deployments.</p>
<h2 id="motivation-4"><a class="header" href="#motivation-4">Motivation</a></h2>
<p>Group messaging is a fundamental part of digital communication,
yet most existing systems depend on centralized servers,
which introduce risks around privacy, censorship, and unilateral control.
In restrictive settings, servers can be blocked or surveilled;
in more open environments, users still face opaque moderation policies,
data collection, and exclusion from decision-making processes.
To address this, we propose a decentralized, scalable peer-to-peer
group messaging system where each participant runs a node, contributes
to message propagation, and takes part in governance autonomously.
Group membership changes are decided collectively through a lightweight
partially synchronous, fault-tolerant consensus protocol without a centralized identity.
This design enables truly democratic group communication and is well-suited
for use cases like activist collectives, research collaborations, DAOs, support groups,
and decentralized social platforms.</p>
<h2 id="format-specification-1"><a class="header" href="#format-specification-1">Format Specification</a></h2>
<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”,
“SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL” in this document
are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">2119</a>.</p>
<h3 id="assumptions-1"><a class="header" href="#assumptions-1">Assumptions</a></h3>
<ul>
<li>The nodes in the P2P network can discover other nodes or will connect to other nodes when subscribing to same topic in a gossipsub.</li>
<li>We MAY have non-reliable (silent) nodes.</li>
<li>We MUST have a consensus that is lightweight, scalable and finalized in a specific time.</li>
</ul>
<h2 id="roles-1"><a class="header" href="#roles-1">Roles</a></h2>
<p>The three roles used in de-MLS is as follows:</p>
<ul>
<li><code>node</code>: Nodes are participants in the network that are not currently members
of any secure group messaging session but remain available as potential candidates for group membership.</li>
<li><code>member</code>: Members are special nodes in the secure group messaging who
obtains current group key of secure group messaging.
Each node is assigned a unique identity represented as a 20-byte value named <code>member id</code>.</li>
<li><code>steward</code>: Stewards are special and transparent members in the secure group
messaging who organize the changes by releasing commit messages upon the voted proposals.
There are two special subsets of steward as epoch and backup steward,
which are defined in the section de-MLS Objects.</li>
</ul>
<h2 id="mls-background"><a class="header" href="#mls-background">MLS Background</a></h2>
<p>The de-MLS consists of MLS backend, so the MLS services and other MLS components
are taken from the original <a href="https://datatracker.ietf.org/doc/rfc9420/">MLS specification</a>, with or without modifications.</p>
<h3 id="mls-services"><a class="header" href="#mls-services">MLS Services</a></h3>
<p>MLS is operated in two services authentication service (AS) and delivery service (DS).
Authentication service enables group members to authenticate the credentials presented by other group members.
The delivery service routes MLS messages among the nodes or
members in the protocol in the correct order and
manage the <code>keyPackage</code> of the users where the <code>keyPackage</code> is the objects
that provide some public information about a user.</p>
<h3 id="mls-objects"><a class="header" href="#mls-objects">MLS Objects</a></h3>
<p>Following section presents the MLS objects and components that used in this RFC:</p>
<p><code>Epoch</code>: Time intervals that changes the state that is defined by members,
section 3.4 in <a href="https://datatracker.ietf.org/doc/rfc9420/">MLS RFC 9420</a>.</p>
<p><code>MLS proposal message:</code> Members MUST receive the proposal message prior to the
corresponding commit message that initiates a new epoch with key changes,
in order to ensure the intended security properties, section 12.1 in <a href="https://datatracker.ietf.org/doc/rfc9420/">MLS RFC 9420</a>.
Here, the add and remove proposals are used.</p>
<p><code>Application message</code>: This message type used in arbitrary encrypted communication between group members.
This is restricted by <a href="https://datatracker.ietf.org/doc/rfc9420/">MLS RFC 9420</a> as if there is pending proposal,
the application message should be cut.
Note that: Since the MLS is based on servers, this delay between proposal and commit messages are very small.</p>
<p><code>Commit message:</code> After members receive the proposals regarding group changes,
the committer, who may be any member of the group, as specified in  <a href="https://datatracker.ietf.org/doc/rfc9420/">MLS RFC 9420</a>,
generates the necessary key material for the next epoch, including the appropriate welcome messages
for new joiners and new entropy for removed members. In this RFC, the committers only MUST be stewards.</p>
<h3 id="de-mls-objects"><a class="header" href="#de-mls-objects">de-MLS Objects</a></h3>
<p>This section presents the de-MLS objects:</p>
<p><code>Voting proposal</code>: Similar to MLS proposals, but processed only if approved through a voting process.
They function as application messages in the MLS group,
allowing the steward to collect them without halting the protocol.
There are three types of <code>voting proposal</code> according to the type of consensus as in shown Consensus Types section,
these are, <code>commit proposal</code>, <code>steward election proposal</code> and <code>emergency criteria proposal</code>.</p>
<p><code>Epoch steward</code>: The steward assigned to commit in <code>epoch E</code> according to the steward list.
Holds the primary responsibility for creating commit in that epoch.</p>
<p><code>Backup steward</code>: The steward next in line after the <code>epoch steward</code> on the <code>steward list</code> in <code>epoch E</code>.
Only becomes active if the <code>epoch steward</code> is malicious or fails,
in which case it completes the commitment phase.
If unused in <code>epoch E</code>, it automatically becomes the <code>epoch steward</code> in <code>epoch E+1</code>.</p>
<p><code>Steward list</code>: It is an ordered list that contains the <code>member id</code>s of authorized stewards.
Each steward in the list becomes main responsible for creating the commit message when its turn arrives,
according to this order for each epoch.
For example, suppose there are two stewards in the list <code>steward A</code> first and <code>steward B</code> last in the list.
<code>steward A</code> is responsible for creating the commit message for first epoch.
Similarly, <code>steward B</code> is for the last epoch.
Since the <code>epoch steward</code> is the primary committer for an epoch,
it holds the main responsibility for producing the commit.
However, other stewards MAY also generate a commit within the same epoch to preserve liveness
in case the epoch steward is inactive or slow.
Duplicate commits are not re-applied and only the single valid commit for the epoch is accepted by the group,
as in described in section filtering proposals against the multiple comitting.</p>
<p>Therefore, if a malicious steward occurred, the <code>backup steward</code> will be charged with committing.
Lastly, the size of the list named as <code>sn</code>, which also shows the epoch interval for steward list determination.</p>
<h2 id="flow-4"><a class="header" href="#flow-4">Flow</a></h2>
<p>General flow is as follows:</p>
<ul>
<li>A steward initializes a group just once, and then sends out Group Announcements (GA) periodically.</li>
<li>Meanwhile, each <code>node</code> creates and sends their <code>credential</code> includes <code>keyPackage</code>.</li>
<li>Each <code>member</code> creates <code>voting proposals</code> sends them to from MLS group during <code>epoch E</code>.</li>
<li>Meanwhile, the <code>steward</code> collects finalized <code>voting proposals</code> from MLS group and converts them into
<code>MLS proposals</code> then sends them with corresponding <code>commit messages</code></li>
<li>Evantually, with the commit messages, all members starts the next <code>epoch E+1</code>.</li>
</ul>
<h2 id="creating-voting-proposal"><a class="header" href="#creating-voting-proposal">Creating Voting Proposal</a></h2>
<p>A <code>member</code> MAY initializes the voting with the proposal payload
which is implemented using <a href="https://protobuf.dev/">protocol buffers v3</a> as follows:</p>
<pre><code class="language-protobuf">
syntax = "proto3";

message Proposal {
string name = 10;                 // Proposal name
string payload = 11;              // Describes the what is voting fore 
int32 proposal_id = 12;           // Unique identifier of the proposal
bytes proposal_owner = 13;        // Public key of the creator
repeated Vote votes = 14;         // Vote list in the proposal
int32 expected_voters_count = 15; // Maximum number of distinct voters
int32 round = 16;                 // Number of Votes
int64 timestamp = 17;             // Creation time of proposal
int64 expiration_time = 18;       // Time interval that the proposal is active
bool liveness_criteria_yes = 19;  // Shows how managing the silent peers vote
}
</code></pre>
<pre><code class="language-bash">message Vote {
int32 vote_id = 20;             // Unique identifier of the vote
bytes vote_owner = 21;          // Voter's public key
int64 timestamp = 22;           // Time when the vote was cast
bool vote = 23;                 // Vote bool value (true/false)
bytes parent_hash = 24;         // Hash of previous owner's Vote
bytes received_hash = 25;       // Hash of previous received Vote
bytes vote_hash = 26;           // Hash of all previously defined fields in Vote
bytes signature = 27;           // Signature of vote_hash
}
</code></pre>
<p>The voting proposal MAY include adding a <code>node</code> or removing a <code>member</code>.
After the <code>member</code> creates the voting proposal,
it is emitted to the network via the MLS <code>Application message</code> with a lightweight,
epoch based voting such as <a href="https://github.com/vacp2p/rfc-index/blob/consensus-hashgraph-like/vac/raw/consensus-hashgraphlike.md">hashgraphlike consensus.</a>
This consensus result MUST be finalized within the epoch as YES or NO.</p>
<p>If the voting result is YES, this points out the voting proposal will be converted into
the MLS proposal by the <code>steward</code> and following commit message that starts the new epoch.</p>
<h2 id="creating-welcome-message"><a class="header" href="#creating-welcome-message">Creating welcome message</a></h2>
<p>When a MLS <code>MLS proposal message</code> is created by the <code>steward</code>,
a <code>commit message</code> SHOULD follow,
as in section 12.04 <a href="https://datatracker.ietf.org/doc/rfc9420/">MLS RFC 9420</a> to the members.
In order for the new <code>member</code> joining the group to synchronize with the current members
who received the <code>commit message</code>,
the <code>steward</code> sends a welcome message to the node as the new <code>member</code>,
as in section 12.4.3.1. <a href="https://datatracker.ietf.org/doc/rfc9420/">MLS RFC 9420</a>.</p>
<h2 id="single-steward"><a class="header" href="#single-steward">Single steward</a></h2>
<p>To naive way to create a decentralized secure group messaging is having a single transparent <code>steward</code>
who only applies the changes regarding the result of the voting.</p>
<p>This is mostly similar with the general flow and specified in voting proposal and welcome message creation sections.</p>
<ol>
<li>Each time a single <code>steward</code> initializes a group with group parameters with parameters
as in section 8.1. Group Context in <a href="https://datatracker.ietf.org/doc/rfc9420/">MLS RFC 9420</a>.</li>
<li><code>steward</code> creates a group anouncement (GA) according to the previous step and
broadcast it to the all network periodically. GA message is visible in network to all <code>nodes</code>.</li>
<li>The each <code>node</code> who wants to be a <code>member</code> needs to obtain this anouncement and create <code>credential</code>
includes <code>keyPackage</code> that is specified in <a href="https://datatracker.ietf.org/doc/rfc9420/">MLS RFC 9420</a> section 10.</li>
<li>The <code>node</code> send the <code>KeyPackages</code> in plaintext with its signature with current <code>steward</code> public key which
anounced in welcome topic. This step is crucial for security, ensuring that malicious nodes/stewards
cannot use others' <code>KeyPackages</code>.
It also provides flexibility for liveness in multi-steward settings,
allowing more than one steward to obtain <code>KeyPackages</code> to commit.</li>
<li>The <code>steward</code> aggregates all <code>KeyPackages</code> utilizes them to provision group additions for new members,
based on the outcome of the voting process.</li>
<li>Any <code>member</code> start to create <code>voting proposals</code> for adding or removing users,
and present them to the voting in the MLS group as an application message.</li>
</ol>
<p>However, unlimited use of <code>voting proposals</code> within the group may be misused by
malicious or overly active members.
Therefore, an application-level constraint can be introduced to limit the number
or frequency of proposals initiated by each member to prevent spam or abuse.
7. Meanwhile, the <code>steward</code> collects finalized <code>voting proposals</code> with in epoch <code>E</code>,
that have received affirmative votes from members via application messages.
Otherwise, the <code>steward</code> discards proposals that did not receive a majority of "YES" votes.
Since voting proposals are transmitted as application messages, omitting them does not affect
the protocol’s correctness or consistency.
8. The <code>steward</code> converts all approved <code>voting proposals</code> into
corresponding <code>MLS proposals</code> and <code>commit message</code>, and
transmits both in a single operation as in <a href="https://datatracker.ietf.org/doc/rfc9420/">MLS RFC 9420</a> section 12.4,
including welcome messages for the new members.
Therefore, the <code>commit message</code> ends the previous epoch and create new ones.
9. The <code>members</code> applied the incoming <code>commit message</code> by checking the signatures and <code>voting proposals</code>
and synchronized with the upcoming epoch.</p>
<h2 id="multi-stewards"><a class="header" href="#multi-stewards">Multi stewards</a></h2>
<p>Decentralization has already been achieved in the previous section.
However, to improve availability and ensure censorship resistance,
the single steward protocol is extended to a multi steward architecture.
In this design, each epoch is coordinated by a designated steward,
operating under the same protocol as the single steward model.
Thus, the multi steward approach primarily defines how steward roles
rotate across epochs while preserving the underlying structure and logic of the original protocol.
Two variants of the multi steward design are introduced to address different system requirements.</p>
<h3 id="consensus-types"><a class="header" href="#consensus-types">Consensus Types</a></h3>
<p>Consensus is agnostic with its payload; therefore, it can be used for various purposes.
Note that each message for the consensus of proposals is an <code>application message</code> in the MLS object section.
It is used in three ways as follows:</p>
<ol>
<li><code>Commit proposal</code>:  It is the proposal instance that is specified in Creating Voting Proposal section
with <code>Proposal.payload</code> MUST show the commit request from <code>members</code>.
Any member MAY create this proposal in any epoch and <code>epoch steward</code> MUST collect and commit YES voted proposals.
This is the only proposal type common to both single steward and multi steward designs.</li>
<li><code>Steward election proposal</code>: This is the process that finalizes the <code>steward list</code>,
which sets and orders stewards responsible for creating commits over a predefined number of range in (<code>sn_min</code>,<code>sn_max</code>).
The validity of the choosen <code>steward list</code> ends when the last steward in the list (the one at the final index) completes its commit.
At that point, a new <code>steward election proposal</code> MUST be initiated again by any member during the corresponding epoch.
The <code>Proposal.payload</code> field MUST represent the ordered identities of the proposed stewards.
Each steward election proposal MUST be verified and finalized through the consensus process
so that members can identify which steward will be responsible in each epoch
and detect any unauthorized steward commits.</li>
<li><code>Emergency criteria proposal</code>: If there is a malicious member or steward,
this event MUST be voted on to finalize it.
If this returns YES, the next epoch MUST include the removal of the member or steward.
In a specific case where a steward is removed from the group, causing the total number of stewards to fall below <code>sn_min</code>,<br />
it is required to repeat the <code>steward election proposal</code>.
<code>Proposal.payload</code> MUST consist of the evidence of the dishonesty as described in the Steward violation list,
and the identifier of the malicious member or steward.
This proposal can be created by any member in any epoch.</li>
</ol>
<p>The order of consensus proposal messages is important to achieving a consistent result.
Therefore, messages MUST be prioritized by type in the following order, from highest to lowest priority:</p>
<ul>
<li>
<p><code>Emergency criteria proposal</code></p>
</li>
<li>
<p><code>Steward election proposal</code></p>
</li>
<li>
<p><code>Commit proposal</code></p>
</li>
</ul>
<p>This means that if a higher-priority consensus proposal is present in the network,
lower-priority messages MUST be withheld from transmission until the higher-priority proposals have been finalized.</p>
<h3 id="steward-list-creation"><a class="header" href="#steward-list-creation">Steward list creation</a></h3>
<p>The <code>steward list</code> consists of steward nominees who will become actual stewards if the <code>steward election proposal</code> is finalized with YES,
is arbitrarily chosen from <code>member</code> and OPTIONALLY adjusted depending on the needs of the implementation.
The <code>steward list</code> size, defined by the minimum <code>sn_min</code> and maximum <code>sn_max</code> bounds,
is determined at the time of group creation.
The <code>sn_min</code> requirement is applied only when the total number of members exceeds <code>sn_min</code>;
if the number of available members falls below this threshold,
the list size automatically adjusts to include all existing members.</p>
<p>The actual size of the list MAY vary within this range as <code>sn</code>, with the minimum value being at least 1.</p>
<p>The index of the slots shows epoch info and value of index shows <code>member id</code>s.
The next in line steward for the <code>epoch E</code> is named as <code>epoch steward</code>, which has index E.
And the subsequent steward in the <code>epoch E</code> is named as the <code>backup steward</code>.
For example, let's assume steward list is (S3, S2, S1) if in the previous epoch the roles were
(<code>backup steward</code>: S2, <code>epoch steward</code>: S1), then in the next epoch they become
(<code>backup steward</code>: S3, <code>epoch steward</code>: S2) by shifting.</p>
<p>If the <code>epoch steward</code> is honest, the <code>backup steward</code> does not involve the process in epoch,
and the <code>backup steward</code> will be the <code>epoch steward</code> within the <code>epoch E+1</code>.</p>
<p>If the <code>epoch steward</code> is malicious, the <code>backup steward</code> is involved in the commitment phase in <code>epoch E</code>
and the former steward becomes the <code>backup steward</code> in <code>epoch E</code>.</p>
<p>Liveness criteria:</p>
<p>Once the active <code>steward list</code> has completed its assigned epochs,</p>
<p>members MUST proceed to elect the next set of stewards
(which MAY include some or all of the previous members).
This election is conducted through a type 2 consensus procedure, <code>steward election proposal</code>.</p>
<p>A <code>Steward election proposal</code> is considered valid only if the resulting <code>steward list</code>
is produced through a deterministic process that ensures an unbiased distribution of steward assignments,
since allowing bias could enable a malicious participant to manipulate the list
and retain control within a favored group for multiple epochs.</p>
<p>The list MUST consist of at least <code>sn_min</code> members, including retained previous stewards,
sorted according to the ascending value of <code>SHA256(epoch E || member id || group id)</code>,
where <code>epoch E</code> is the epoch in which the election proposal is initiated,
and <code>group id</code> for shuffling the list across the different groups.
Any proposal with a list that does not adhere to this generation method MUST be rejected by all members.</p>
<p>We assume that there are no recurring entries in <code>SHA256(epoch E || member id || group id)</code>, since the SHA256 outputs are unique
when there is no repetition in the <code>member id</code> values, against the conflicts on sorting issues.</p>
<h3 id="multi-steward-with-big-consensuses"><a class="header" href="#multi-steward-with-big-consensuses">Multi steward with big consensuses</a></h3>
<p>In this model, all group modifications, such as adding or removing members,
must be approved through consensus by all participants,
including the steward assigned for <code>epoch E</code>.
A configuration with multiple stewards operating under a shared consensus protocol offers
increased decentralization and stronger protection against censorship.
However, this benefit comes with reduced operational efficiency.
The model is therefore best suited for small groups that value
decentralization and censorship resistance more than performance.</p>
<p>To create a multi steward with a big consensus,
the group is initialized with a single steward as specified as follows:</p>
<ol>
<li>The steward initialized the group with the config file.
This config file MUST contain (<code>sn_min</code>,<code>sn_max</code>) as the <code>steward list</code> size range.</li>
<li>The steward adds the members as a centralized way till the number of members reaches the <code>sn_min</code>.
Then, members propose lists by voting proposal with size <code>sn</code>
as a consensus among all members, as mentioned in the consensus section 2, according to the checks:
the size of the proposed list <code>sn</code> is in the interval (<code>sn_min</code>,<code>sn_max</code>).
Note that if the total number of members is below <code>sn_min</code>,
then the steward list size MUST be equal to the total member count.</li>
<li>After the voting proposal ends up with a <code>steward list</code>,
and group changes are ready to be committed as specified in single steward section
with a difference which is members also check the committed steward is <code>epoch steward</code> or <code>backup steward</code>,
otherwise anyone can create <code>emergency criteria proposal</code>.</li>
<li>If the <code>epoch steward</code> violates the changing process as mentioned in the section Steward violation list,
one of the members MUST initialize the <code>emergency criteria proposal</code> to remove the malicious Steward.
Then <code>backup steward</code> fulfills the epoch by committing again correctly.</li>
</ol>
<p>A large consensus group provides better decentralization, but it requires significant coordination,
which MAY not be suitable for groups with more than 1000 members.</p>
<h3 id="multi-steward-with-small-consensuses"><a class="header" href="#multi-steward-with-small-consensuses">Multi steward with small consensuses</a></h3>
<p>The small consensus model offers improved efficiency with a trade-off in decentralization.
In this design, group changes require consensus only among the stewards, rather than all members.
Regular members participate by periodically selecting the stewards by <code>steward election proposal</code>
but do not take part in commit decision by <code>commit proposal</code>.
This structure enables faster coordination since consensus is achieved within a smaller group of stewards.
It is particularly suitable for large user groups, where involving every member in each decision would be impractical.</p>
<p>The flow is similar to the big consensus including the <code>steward list</code> finalization with all members consensus
only the difference here, the commit messages requires <code>commit proposal</code> only among the stewards.</p>
<h2 id="filtering-proposals-against-the-multiple-comitting"><a class="header" href="#filtering-proposals-against-the-multiple-comitting">Filtering proposals against the multiple comitting</a></h2>
<p>Since stewards are allowed to produce a commit even when they are not the designated <code>epoch steward</code>,
multiple commits may appear within the same epoch, often reflecting recurring versions of the same proposal.
To ensure a consistent outcome, the valid commit for the epoch SHOULD be selected as the one derived
from the longest proposal chain, ordered by the ascending value of each proposal as <code>SHA256(proposal)</code>.
All other cases, such as invalid commits or commits based on proposals that were not approved through voting,
can be easily detected and discarded by the members.</p>
<h2 id="steward-violation-list"><a class="header" href="#steward-violation-list">Steward violation list</a></h2>
<p>A steward’s activity is called a violation if the action is one or more of the following:</p>
<ol>
<li>Broken commit: The steward releases a different commit message from the voted <code>commit proposal</code>.
This activity is identified by the <code>members</code> since the <a href="https://datatracker.ietf.org/doc/rfc9420/">MLS RFC 9420</a> provides the methods
that members can use to identify the broken commit messages that are possible in a few situations,
such as commit and proposal incompatibility. Specifically, the broken commit can arise as follows:
<ol>
<li>The commit belongs to the earlier epoch.</li>
<li>The commit message should equal the latest epoch</li>
<li>The commit needs to be compatible with the previous epoch’s <code>MLS proposal</code>.</li>
</ol>
</li>
<li>Broken MLS proposal: The steward prepares a different <code>MLS proposal</code> for the corresponding <code>voting proposal</code>.
This activity is identified by the <code>members</code> since both <code>MLS proposal</code> and <code>voting proposal</code> are visible
and can be identified by checking the hash of <code>Proposal.payload</code> and <code>MLSProposal.payload</code> is the same as RFC9240 section 12.1. Proposals.</li>
<li>Censorship and inactivity: The situation where there is a voting proposal that is visible for every member,
and the Steward does not provide an MLS proposal and commit.
This activity is again identified by the <code>members</code>since <code>voting proposals</code> are visible to every member in the group,
therefore each member can verify that there is no <code>MLS proposal</code> corresponding to <code>voting proposal</code>.</li>
</ol>
<h2 id="security-considerations"><a class="header" href="#security-considerations">Security Considerations</a></h2>
<p>In this section, the security considerations are shown as de-MLS assurance.</p>
<ol>
<li>Malicious Steward: A Malicious steward can act maliciously,
as in the Steward violation list section.
Therefore, de-MLS enforces that any steward only follows the protocol under the consensus order
and commits without emergency criteria application.</li>
<li>Malicious Member: A member is only marked as malicious
when the member acts by releasing a commit message.</li>
<li>Steward list election bias: Although SHA256 is used together with two global variables
to shuffle stewards in a deterministic and verifiable manner,
this approach only minimizes election bias; it does not completely eliminate it.
This design choice is intentional, in order to preserve the efficiency advantages provided by the MLS mechanism.</li>
</ol>
<h2 id="copyright-6"><a class="header" href="#copyright-6">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a></p>
<h3 id="references-3"><a class="header" href="#references-3">References</a></h3>
<ul>
<li><a href="https://datatracker.ietf.org/doc/rfc9420/">MLS RFC 9420</a></li>
<li><a href="https://github.com/vacp2p/rfc-index/blob/consensus-hashgraph-like/vac/raw/consensus-hashgraphlike.md">Hashgraphlike Consensus</a></li>
<li><a href="https://github.com/vacp2p/de-mls">vacp2p/de-mls</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="eth-mls-onchain"><a class="header" href="#eth-mls-onchain">ETH-MLS-ONCHAIN</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Secure channel setup using decentralized MLS and Ethereum accounts</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Ramses Fernandez &lt;ramses@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>A<br>a<br>r<br>y<br>a<br>m<br>a<br>n<br>n<br> <br>C<br>h<br>a<br>l<br>l<br>a<br>n<br>i<br> <br>&lt;<br>a<br>a<br>r<br>y<br>a<br>m<br>a<br>n<br>n<br>@<br>s<br>t<br>a<br>t<br>u<br>s<br>.<br>i<br>m<br>&gt;<br>,<br> <br>E<br>k<br>a<br>t<br>e<br>r<br>i<br>n<br>a<br> <br>B<br>r<br>o<br>s<br>l<br>a<br>v<br>s<br>k<br>a<br>y<br>a<br> <br>&lt;<br>e<br>k<br>a<br>t<br>e<br>r<br>i<br>n<br>a<br>@<br>s<br>t<br>a<br>t<br>u<br>s<br>.<br>i<br>m<br>&gt;<br>,<br> <br>U<br>g<br>u<br>r<br> <br>S<br>e<br>n<br> <br>&lt;<br>u<br>g<br>u<br>r<br>@<br>s<br>t<br>a<br>t<br>u<br>s<br>.<br>i<br>m<br>&gt;<br>,<br> <br>K<br>s<br>r<br> <br>&lt;<br>k<br>s<br>r<br>@<br>s<br>t<br>a<br>t<br>u<br>s<br>.<br>i<br>m<br>&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-9"><a class="header" href="#timeline-9">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/raw/eth-mls-onchain.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/raw/eth-mls-onchain.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-04</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/517b63984c875670e437d50359f2f67331104974/vac/raw/eth-mls-onchain.md"><code>517b639</code></a> — Update the RFCs: Vac Raw RFC (#143)</li>
<li><strong>2024-10-03</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/c655980494a5943634c372009bbea71c13196a8f/vac/raw/eth-demls.md"><code>c655980</code></a> — Eth secpm splitted (#91)</li>
<li><strong>2024-08-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/13aaae37d15bdd672c26565bd0e0ebfc2e8b9459/vac/raw/eth-secpm.md"><code>13aaae3</code></a> — Update eth-secpm.md (#84)</li>
<li><strong>2024-05-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/e234e9d5a30bb4d9d4654285c6118f3d9900a3b9/vac/raw/eth-secpm.md"><code>e234e9d</code></a> — Update eth-secpm.md (#35)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/vac/70/eth-secpm.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-28</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b842725d42f1c7d7661808035eff2b0dfa1fca7e/vac/70/eth-secpm.md"><code>b842725</code></a> — Update eth-secpm.md</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/f2e1b4cd4613f9ab648e42fd00475acf4541649d/vac/70/eth-secpm.md"><code>f2e1b4c</code></a> — Rename ETH-SECPM.md to eth-secpm.md</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/22bb3312fa6ab920281e11c5db190b123c9553b1/vac/70/ETH-SECPM.md"><code>22bb331</code></a> — Update ETH-SECPM.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/5b8ce46a6b384d6ee4c2d884f9db82b0aee9ce8c/vac/70/ETH-SECPM.md"><code>5b8ce46</code></a> — Create ETH-SECPM.md</li>
</ul>
<!-- timeline:end -->
<h2 id="motivation-5"><a class="header" href="#motivation-5">Motivation</a></h2>
<p>The need for secure communications has become paramount.<br />
Traditional centralized messaging protocols are susceptible to various security threats,
including unauthorized access, data breaches, and single points of failure.
Therefore a decentralized approach to secure communication becomes increasingly relevant,
offering a robust solution to address these challenges.</p>
<p>This document specifies a private messaging service using the
Ethereum blockchain as authentication service.
Rooted in the existing <a href="vac/raw/../../waku/standards/application/20/toy-eth-pm.html">model</a>,
this proposal addresses the deficiencies related
to forward privacy and authentication inherent
in the current framework.
The specification is divided into the following sections:</p>
<ul>
<li>Private group messaging protocol, based on the
<a href="https://datatracker.ietf.org/doc/rfc9420/">MLS protocol</a>.</li>
<li>Specification of an Ethereum-based authentication protocol, based on
<a href="https://eips.ethereum.org/EIPS/eip-4361">SIWE</a>.</li>
</ul>
<h2 id="protocol-flow"><a class="header" href="#protocol-flow">Protocol flow</a></h2>
<p>The following steps outline the flow of the protocol.</p>
<h3 id="account-registration-and-key-generation"><a class="header" href="#account-registration-and-key-generation">Account Registration and Key Generation</a></h3>
<p>Each user starts by registering their Ethereum account.
It is used as the authentication service.
Upon registration, the user generates a <code>KeyPackage</code>
that contains a public key
and supporting metadata required for the MLS group.</p>
<h3 id="group-initialization-and-member-management"><a class="header" href="#group-initialization-and-member-management">Group Initialization and Member Management</a></h3>
<p>When a new group is created, the initiating client generates a new <code>GroupContext</code>.
It contains a unique group ID and an initial epoch.</p>
<p>To add members, the initiator sends an <code>Add</code> request,
which includes the new member’s KeyPackage.</p>
<p>Existing members can update their identity in the group using the <code>Update</code> proposal,
which replaces the sender’s LeafNode in the group’s ratchet tree.</p>
<p>Members can be removed from the group via a <code>Remove</code> proposal,
which specifies the index of the member to be removed from the tree.
Upon processing this proposal,
the group generates a new group key to ensure that removed members
no longer have access to future communications.</p>
<h3 id="commit-and-authentication"><a class="header" href="#commit-and-authentication">Commit and Authentication</a></h3>
<p>After receiving a valid list of proposals (<code>Add</code>, <code>Update</code>, <code>Remove</code>),
a client initiates a <code>Commit</code> message,
processing the pending proposals and updates the group’s state.
The <code>Commit</code> message includes the updated <code>GroupContext</code>
and a <code>FramedContentAuthData</code>,
which ensures that all group members are aware of the changes.
Each member verifies the <code>FramedContentAuthData</code> to ensure the changes are consistent
with the current epoch of the <code>GroupContext</code>.</p>
<h3 id="message-exchange"><a class="header" href="#message-exchange">Message Exchange</a></h3>
<p>Once the group is established and all members have processed the latest <code>Commit</code>,
messages can be securely exchanged using
the session keyderived from the group's ratchet tree.
Each message is encapsulated within a <code>FramedContent</code> structure
and authenticated using the <code>FramedContentAuthData</code>,
ensuring message integrity.
Group members use the current <code>GroupContext</code> to validate incoming messages
and ensure they are consistent with the current group state.</p>
<h3 id="use-of-smart-contracts"><a class="header" href="#use-of-smart-contracts">Use of smart contracts</a></h3>
<p>This protocol accomplishes decentralization
through the use of smart contracts for managing groups.
They are used to register users in a group and keep the state of the group updated.
Smart contracts MUST include an ACL to keep the state of the group.</p>
<h2 id="private-group-messaging-protocol"><a class="header" href="#private-group-messaging-protocol">Private group messaging protocol</a></h2>
<h3 id="background"><a class="header" href="#background">Background</a></h3>
<p>The <a href="https://datatracker.ietf.org/doc/rfc9420/">Messaging Layer Security</a> (MLS)
protocol aims at providing a group of users with
end-to-end encryption in an authenticated and asynchronous way.
The main security characteristics of the protocol are:
Message confidentiality and authentication, sender authentication,
membership agreement, post-remove
and post-update security, and forward secrecy and
post-compromise security.
The MLS protocol achieves: low-complexity, group integrity,
synchronization and extensibility.</p>
<p>This document describes how the structure and methods of the
<a href="https://datatracker.ietf.org/doc/rfc9420/">MLS</a> protocol
are extended for their application in decentralized environments.
The approach described in this document makes use of smart contracts.
It makes use of a smart contract to manage each group chat.
Furthermore, this document describes how to use the Sign-in With Ethereum protocol
as authentication method.</p>
<h3 id="structure"><a class="header" href="#structure">Structure</a></h3>
<p>Each MLS session uses a single cipher suite that specifies the
primitives to be used in group key computations. The cipher suite MUST
use:</p>
<ul>
<li><code>X488</code> as Diffie-Hellman function.</li>
<li><code>SHA256</code> as KDF.</li>
<li><code>AES256-GCM</code> as AEAD algorithm.</li>
<li><code>SHA512</code> as hash function.</li>
<li><code>XEd448</code> for digital signatures.</li>
</ul>
<p>Formats for public keys, signatures and public-key encryption MUST
follow Section 5.1 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="hash-based-identifiers"><a class="header" href="#hash-based-identifiers">Hash-based identifiers</a></h3>
<p>Some MLS messages refer to other MLS objects by hash.
These identifiers MUST be computed according to Section 5.2 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="credentials"><a class="header" href="#credentials">Credentials</a></h3>
<p>Each member of a group presents a credential that provides one or more
identities for the
member and associates them with the member's signing key.
The identities and signing key are verified by the Authentication
Service in use for a group.</p>
<p>Credentials MUST follow the specifications of section 5.3 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<p>Below follows the flow diagram for the generation of credentials.
Users MUST generate key pairs by themselves.
<img src="vac/raw/./images/eth-secpm_credential.png" alt="figure1" /></p>
<h3 id="message-framing"><a class="header" href="#message-framing">Message framing</a></h3>
<p>Handshake and application messages use a common framing structure
providing encryption to ensure confidentiality within the group,
and signing to authenticate the sender.</p>
<p>The structure is:</p>
<ul>
<li><code>PublicMessage</code>: represents a message that is only signed,
and not encrypted.
The definition and the encoding/decoding of a <code>PublicMessage</code>
MUST follow the specification in section 6.2 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</li>
<li><code>PrivateMessage</code>: represents a signed and encrypted message,
with protections for both the content of the message and related metadata.</li>
</ul>
<p>The definition, and the encoding/decoding of a <code>PrivateMessage</code>
MUST follow the specification in section 6.3 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<p>Applications MUST use <code>PrivateMessage</code> to encrypt application messages.</p>
<p>Applications SHOULD use <code>PrivateMessage</code> to encode handshake messages.</p>
<p>Each encrypted MLS message carries a "generation" number which
is a per-sender incrementing counter.
If a group member observes a gap in the generation sequence
for a sender, then they know that they have missed
a message from that sender.</p>
<h3 id="nodes-contents"><a class="header" href="#nodes-contents">Nodes contents</a></h3>
<blockquote>
<p>This section makes use of sections 4 and 7 of
<a href="https://datatracker.ietf.org/docrfc9420/">RFC9420</a>.</p>
</blockquote>
<p>The nodes of a ratchet tree
(Section 4 in <a href="https://datatracker.ietf.org/docrfc9420/">RFC9420</a>)
contain several types of data:</p>
<ul>
<li>Leaf nodes describe individual members.</li>
<li>Parent nodes describe subgroups.</li>
</ul>
<p>Contents of each kind of node, and its structure MUST follow
the indications described in sections 7.1 and 7.2 of
<a href="https://datatracker.ietf.org/docrfc9420/">RFC9420</a>.</p>
<h3 id="leaf-node-validation"><a class="header" href="#leaf-node-validation">Leaf node validation</a></h3>
<p><code>KeyPackage</code> objects describe the client's capabilities and
provides keys that can be used  to add the client to a group.</p>
<p>The validity of a leaf node needs to be verified
at the following stages:</p>
<ul>
<li>When a leaf node is downloaded in a <code>KeyPackage</code>,
before it is used to add the client to the group.</li>
<li>When a leaf node is received by a group member in an
Add, Update, or Commit message.</li>
<li>When a client validates a ratchet tree.</li>
</ul>
<p>A client MUST verify the validity of a leaf node following the
instructions of section 7.3 in
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="ratchet-tree-evolution"><a class="header" href="#ratchet-tree-evolution">Ratchet tree evolution</a></h3>
<p>Whenever a member initiates an epoch change, they MAY need to refresh
the key pairs of their leaf and of the nodes on their direct path.
This is done to keep forward secrecy and post-compromise security.
The member initiating the epoch change MUST follow this procedure.
A member updates the nodes along its direct path as follows:</p>
<ul>
<li>Blank all the nodes on the direct path from the leaf to the root.</li>
<li>Generate a fresh HPKE key pair for the leaf.</li>
<li>Generate a sequence of path secrets, one for each node on the leaf's
filtered direct path.</li>
</ul>
<p>It MUST follow the procedure described in section 7.4 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<ul>
<li>Compute the sequence of HPKE key pairs <code>(node_priv,node_pub)</code>,
one for each node on the leaf's direct path.</li>
</ul>
<p>It MUST follow the procedure described in section 7.4 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="views-of-the-tree-synchronization"><a class="header" href="#views-of-the-tree-synchronization">Views of the tree synchronization</a></h3>
<p>After generating fresh key material and applying it to update
their local tree state, the generator broadcasts this update
to other members of the group.
This operation MUST be done according to section 7.5 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="leaf-synchronization"><a class="header" href="#leaf-synchronization">Leaf synchronization</a></h3>
<p>Changes to group memberships MUST be represented by
adding and removing leaves of the tree.
This corresponds to increasing or decreasing the depth of the tree,
resulting in the number of leaves being doubled or halved.
These operations MUST be done as described in section 7.7 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="tree-and-parent-hashing"><a class="header" href="#tree-and-parent-hashing">Tree and parent hashing</a></h3>
<p>Group members can agree on the cryptographic state of the group by
generating a hash value that represents the contents of the group
ratchet tree and the member’s credentials.
The hash of the tree is the hash of its root node,
defined recursively from the leaves.
Tree hashes summarize the state of a tree at point in time.
The hash of a leaf is the hash of the <code>LeafNodeHashInput</code> object.
At the same time the hash of a parent node, including the root,
is the hash of a <code>ParentNodeHashInput</code> object.
Parent hashes capture information about
how keys in the tree were populated.</p>
<p>Tree and parent hashing MUST follow the directions
in Sections 7.8 and 7.9 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="key-schedule"><a class="header" href="#key-schedule">Key schedule</a></h3>
<p>Group keys are derived using the <code>Extract</code> and <code>Expand</code> functions from
the KDF for the group's cipher suite,
as well as the functions defined below:</p>
<pre><code class="language-text">ExpandWithLabel(Secret, Label, Context, Length) = KDF.Expand(Secret, KDFLabel, Length)
DeriveSecret(Secret, Label) = ExpandWithLabel(Secret, Label, "", KDF.Nh)

</code></pre>
<p><code>KDFLabel</code> MUST be specified as:</p>
<pre><code class="language-text">struct {
    uint16 length;
    opaque label&lt;V&gt;;
    opaque context&lt;V&gt;;
} KDFLabel;
</code></pre>
<p>The fields of <code>KDFLabel</code> MUST be:</p>
<pre><code class="language-text">length = Length;
label = "MLS 1.0 " + Label;
context = Context;

</code></pre>
<p>Each member of the group MUST maintaint a <code>GroupContext</code> object
summarizing the state of the group.</p>
<p>The sturcture of such object MUST be:</p>
<pre><code class="language-text">struct {
      ProtocolVersion version = mls10;
      CipherSuite cipher_suite;
      opaque group_id&lt;V&gt;;
      uint64 epoch;
      opaque tree_hash&lt;V&gt;;
      opaque confirmed_trasncript_hash&lt;V&gt;;
      Extension extension&lt;V&gt;;
} GroupContext;
</code></pre>
<p>The use of key scheduling MUST follow the indications
in sections 8.1 - 8.7 in
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="secret-trees"><a class="header" href="#secret-trees">Secret trees</a></h3>
<p>For the generation of encryption keys and nonces, the key schedule
begins with the <code>encryption_secret</code> at the root and derives a tree of
secrets with the same structure as the group's ratchet tree.
Each leaf in the secret tree is associated with the same group member
as the corresponding leaf in the ratchet tree.</p>
<p>If <code>N</code> is a parent node in the secret tree, the secrets of the children
of <code>N</code> MUST be defined following section 9 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h4 id="encryption-keys"><a class="header" href="#encryption-keys">Encryption keys</a></h4>
<p>MLS encrypts three different types of information:</p>
<ul>
<li>Metadata (sender information).</li>
<li>Handshake messages (Proposal and Commit).</li>
<li>Application messages.</li>
</ul>
<p>For handshake and application messages, a sequence of keys is derived
via a sender ratchet.
Each sender has their own sender ratchet, and each step along the
ratchet is called a generation. These procedures MUST follow
section 9.1 of <a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h4 id="deletion-schedule"><a class="header" href="#deletion-schedule">Deletion schedule</a></h4>
<p>All security-sensitive values MUST be deleted
as soon as they are consumed.</p>
<p>A sensitive value S is consumed if:</p>
<ul>
<li>S was used to encrypt or (successfully) decrypt a message.</li>
<li>A key, nonce, or secret derived from S has been consumed.</li>
</ul>
<p>The deletion procedure MUST follow the instruction described in
section 9.2 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="key-packages"><a class="header" href="#key-packages">Key packages</a></h3>
<p>KeyPackage objects are used to ease the addition of clients
to a group asynchronously.</p>
<p>A KeyPackage object specifies:</p>
<ul>
<li>Protocol version and cipher suite supported by the client.</li>
<li>Public keys that can be used to encrypt Welcome messages.
Welcome messages provide new members with
the information to initialize their state
for the epoch in which they were added
or in which they want to
add themselves to the group</li>
<li>The content of the leaf node that should be added to the tree to
represent this client.</li>
</ul>
<p>KeyPackages are intended to be used only once and SHOULD NOT be reused.</p>
<p>Clients MAY generate and publish multiple KeyPackages to support
multiple cipher suites.</p>
<p>The structure of the object MUST be:</p>
<pre><code class="language-text">struct {
      ProtocolVersion version;
      CipherSuite cipher_suite;
      HPKEPublicKey init_key;
      LeafNode leaf_node;
      Extension extensions&lt;V&gt;;
      /* SignWithLabel(., "KeyPackageTBS", KeyPackageTBS) */
      opaque signature&lt;V&gt;;
}
</code></pre>
<pre><code class="language-text">struct {
      ProtocolVersion version;
      CipheSuite cipher_suite;
      HPKEPublicKey init_key;
      LeafNode leaf_node;
      Extension extensions&lt;V&gt;;
}
</code></pre>
<p><code>KeyPackage</code> object MUST be verified when:</p>
<ul>
<li>A <code>KeyPackage</code> is downloaded by a group member, before it is used to
add the client to the group.</li>
<li>When a <code>KeyPackage</code> is received by a group member in an <code>Add</code>
message.</li>
</ul>
<p>Verification MUST be done as follows:</p>
<ul>
<li>Verify that the cipher suite and protocol version of the <code>KeyPackage</code>
match those in the <code>GroupContext</code>.</li>
<li>Verify that the <code>leaf_node</code> of the <code>KeyPackage</code> is valid for a
<code>KeyPackage</code>.</li>
<li>Verify that the signature on the <code>KeyPackage</code> is valid.</li>
<li>Verify that the value of <code>leaf_node.encryption_key</code> is different from
the value of the <code>init_key field</code>.</li>
</ul>
<p>HPKE public keys are opaque values in a format defined by Section 4 of
<a href="https://datatracker.ietf.org/doc/rfc9180/">RFC9180</a>.</p>
<p>Signature public keys are represented as opaque values in a format
defined by the cipher suite's signature scheme.</p>
<h3 id="group-creation"><a class="header" href="#group-creation">Group creation</a></h3>
<p>A group is always created with a single member.
Other members are then added to the group using the usual
Add/Commit mechanism.
The creator of a group MUST set:</p>
<ul>
<li>the group ID.</li>
<li>cipher suite.</li>
<li>initial extensions for the group.</li>
</ul>
<p>If the creator intends to add other members at the time of creation,
then it SHOULD fetch <code>KeyPackages</code> for those members, and select a
cipher suite and extensions according to their capabilities.</p>
<p>The creator MUST use the capabilities information in these
<code>KeyPackages</code> to verify that the chosen version and cipher suite is the
best option supported by all members.</p>
<p>Group IDs SHOULD be constructed so they are unique with
high probability.</p>
<p>To initialize a group, the creator of the group MUST initialize a one
member group with the following initial values:</p>
<ul>
<li>Ratchet tree: A tree with a single node, a leaf node containing an
HPKE public key and credential for the creator.</li>
<li>Group ID: A value set by the creator.</li>
<li>Epoch: <code>0</code>.</li>
<li>Tree hash: The root hash of the above ratchet tree.</li>
<li>Confirmed transcript hash: The zero-length octet string.</li>
<li>Epoch secret: A fresh random value of size <code>KDF.Nh</code>.</li>
<li>Extensions: Any values of the creator's choosing.</li>
</ul>
<p>The creator MUST also calculate the interim transcript hash:</p>
<ul>
<li>Derive the <code>confirmation_key</code> for the epoch according to Section 8 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</li>
<li>Compute a <code>confirmation_tag</code> over the empty
<code>confirmed_transcript_hash</code> using the <code>confirmation_key</code> as described
in Section 8.1 of <a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</li>
<li>Compute the updated <code>interim_transcript_hash</code> from the
<code>confirmed_transcript_hash</code> and the <code>confirmation_tag</code> as described in
Section 8.2 <a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</li>
</ul>
<p>All members of a group MUST support the cipher suite and protocol
version in use. Additional requirements MAY be imposed by including a
<code>required_capabilities</code> extension in the <code>GroupContext</code>.</p>
<pre><code class="language-text">struct {
      ExtensionType extension_types&lt;V&gt;;
      ProposalType proposal_types&lt;V&gt;;
      CredentialType credential_types&lt;V&gt;;
}
</code></pre>
<p>The flow diagram shows the procedure to fetch key material
from other users:</p>
<p><img src="vac/raw/./images/eth-secpm_fetching.png" alt="figure2" /></p>
<p>Below follows the flow diagram for the creation of a group:</p>
<p><img src="vac/raw/./images/eth-secpm_creation.png" alt="figure3" /></p>
<h3 id="group-evolution"><a class="header" href="#group-evolution">Group evolution</a></h3>
<p>Group membership can change, and existing members can change their keys
in order to achieve post-compromise security.
In MLS, each such change is accomplished by a two-step process:</p>
<ul>
<li>A proposal to make the change is broadcast to the group in a
Proposal message.</li>
<li>A member of the group or a new member broadcasts a Commit message
that causes one or more proposed changes to enter into effect.</li>
</ul>
<p>The group evolves from one cryptographic state to another each time a
Commit message is sent and processed.
These states are called epochs and are uniquely identified among states
of the group by eight-octet epoch values.</p>
<p>Proposals are included in a <code>FramedContent</code> by way of a <code>Proposal</code>
structure that indicates their type:</p>
<pre><code class="language-text">struct {
      ProposalType proposal_type;
      select (Proposal.proposal_type) {
            case add:                      Add:
            case update:                   Update;
            case remove:                   Remove;
            case psk:                      PreSharedKey;
            case reinit:                   ReInit;
            case external_init:            ExternalInit;
            case group_context_extensions: GroupContextExtensions;
      }
}
</code></pre>
<p>On receiving a <code>FramedContent</code> containing a <code>Proposal</code>, a client MUST
verify the signature inside <code>FramedContentAuthData</code> and that the epoch
field of the enclosing FramedContent is equal to the epoch field of the
current GroupContext object.
If the verification is successful, then the Proposal SHOULD be cached
in such a way that it can be retrieved by hash in a later Commit
message.</p>
<p>Proposals are organized as follows:</p>
<ul>
<li><code>Add</code>: requests that a client with a specified KeyPackage be added to
the group.</li>
<li><code>Update</code>: similar to Add, it replaces the sender's LeafNode in the
tree instead of adding a new leaf to the tree.</li>
<li><code>Remove</code>: requests that the member with the leaf index removed be
removed from the group.</li>
<li><code>ReInit</code>: requests to reinitialize the group with different
parameters.</li>
<li><code>ExternalInit</code>: used by new members that want to join a group by
using an external commit.</li>
<li><code>GroupContentExtensions</code>: it is used to update the list of extensions
in the GroupContext for the group.</li>
</ul>
<p>Proposals structure and semantics MUST follow sections 12.1.1 - 12.1.7
of <a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<p>Any list of commited proposals MUST be validated either by a the group
member who created the commit, or any group member processing
such commit.
The validation MUST be done according to one of the procedures
described in Section 12.2 of
<a href="https://datatracker.ietf.orgdoc/rfc9420/">RFC9420</a>.</p>
<p>When creating or processing a Commit, a client applies a list of
proposals to the ratchet tree and <code>GroupContext</code>.
The client MUST apply the proposals in the list in the order described
in Section 12.3 of <a href="https://datatracker.ietf.org/docrfc9420/">RFC9420</a>.</p>
<p>Below follows the flow diagram for the addition of a member to a group:</p>
<p><img src="vac/raw/./images/eth-secpm_add.png" alt="figure4" /></p>
<p>The diagram below shows the procedure to remove a group member:</p>
<p><img src="vac/raw/./images/eth-secpm_remove.png" alt="figure5" /></p>
<p>The flow diagram below shows an update procedure:</p>
<p><img src="vac/raw/./images/eth-secpm_update.png" alt="figure6" /></p>
<h3 id="commit-messages"><a class="header" href="#commit-messages">Commit messages</a></h3>
<p>Commit messages initiate new group epochs.
It informs group members to update their representation of the state of
the group by applying the proposals and advancing the key schedule.</p>
<p>Each proposal covered by the Commit is included by a
<code>ProposalOrRef</code> value.
<code>ProposalOrRef</code> identify the proposal to be applied by value
or by reference.
Commits that refer to new Proposals from the committer
can be included by value.
Commits for previously sent proposals from anyone can be sent
by reference.
Proposals sent by reference are specified by including the hash of the
<code>AuthenticatedContent</code>.</p>
<p>Group members that have observed one or more valid proposals within an
epoch MUST send a Commit message before sending application data.
A sender and a receiver of a Commit MUST verify that the committed list
of proposals is valid.
The sender of a Commit SHOULD include all valid proposals received
during the current epoch.</p>
<p>Functioning of commits MUST follow the instructions of Section 12.4 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="application-messages"><a class="header" href="#application-messages">Application messages</a></h3>
<p>Handshake messages provide an authenticated group key exchange
to clients.
To protect application messages sent among the members of a group, the
<code>encryption_secret</code> provided by the key schedule is used to derive a
sequence of nonces and keys for message encryption.</p>
<p>Each client MUST maintain their local copy of the key schedule for each
epoch during which they are a group member.
They derive new keys, nonces, and secrets as needed. This data MUST be
deleted as soon as they have been used.</p>
<p>Group members MUST use the AEAD algorithm associated with the
negotiated MLS ciphersuite to encrypt and decrypt Application messages
according to the Message Framing section.
The group identifier and epoch allow a device to know which group
secrets should be used and from which Epoch secret to start computing
other secrets and keys.
Application messages SHOULD be padded to provide resistance against
traffic analysis techniques.
This avoids additional information to be provided to an attacker in
order to guess the length of the encrypted message.
Padding SHOULD be used on messages with zero-valued bytes before
AEAD encryption.</p>
<p>Functioning of application messages MUST follow the instructions of
Section 15 of <a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h2 id="implementation-of-the-onchain-component-of-the-protocol"><a class="header" href="#implementation-of-the-onchain-component-of-the-protocol">Implementation of the onchain component of the protocol</a></h2>
<h3 id="assumptions-2"><a class="header" href="#assumptions-2">Assumptions</a></h3>
<ul>
<li>Users have set a secure 1-1 communication channel.</li>
<li>Each group is managed by a separate smart contract.</li>
</ul>
<h3 id="addition-of-members-to-a-group"><a class="header" href="#addition-of-members-to-a-group">Addition of members to a group</a></h3>
<ol>
<li>On-chain: Alice creates a Smart Contract with ACL.</li>
<li>Off-chain: Alice sends the contract address
and an invitation message to Bob over the secure channel.</li>
<li>Off-chain: Bob sends a signed response
confirming his Ethereum address and agreement to join.</li>
<li>Off-chain: Alice verifies the signature using the public key of Bob.</li>
<li>On-chain: Alice adds Bob’s address to the ACL.</li>
<li>Off-chain: Alice sends a welcome message to Bob.</li>
<li>Off-chain: Alice sends a broadcast message to all group members,
notifying them the addition of Bob.</li>
</ol>
<p><img src="vac/raw/./images/eth-secpm_onchain-register-2.png" alt="figure8" /></p>
<h3 id="updates-in-groups"><a class="header" href="#updates-in-groups">Updates in groups</a></h3>
<p>Removal requests and update requests are considered the same operation.
One assumes Alice is the creator of the contract.
They MUST be processed as follows:</p>
<ol>
<li>Off-chain: Bob creates a new update request.</li>
<li>Off-chain: Bob sends the update request to Alice.</li>
<li>Off-chain: Alice verifies the request.</li>
<li>On-chain: If the verification is successfull,
Alice sends it to the smart contract for registration.</li>
<li>Off-chain: Alice sends a broadcast message
communicating the update to all users.</li>
</ol>
<p><img src="vac/raw/./images/eth-secpm_onchain-update.png" alt="figure9" /></p>
<h2 id="ethereum-based-authentication-protocol"><a class="header" href="#ethereum-based-authentication-protocol">Ethereum-based authentication protocol</a></h2>
<h3 id="introduction"><a class="header" href="#introduction">Introduction</a></h3>
<p>Sign-in with Ethereum describes how Ethereum accounts authenticate with
off-chain services by signing a standard message format
parameterized by scope, session details, and security mechanisms.
Sign-in with Ethereum (SIWE), which is described in the
<a href="https://eips.ethereum.org/EIPS/eip-4361">EIP 4361</a>,
MUST be the authentication method required.</p>
<h3 id="pattern"><a class="header" href="#pattern">Pattern</a></h3>
<h4 id="message-format-abnf"><a class="header" href="#message-format-abnf">Message format (ABNF)</a></h4>
<p>A SIWE Message MUST conform with the following Augmented Backus–Naur
Form (<a href="https://datatracker.ietf.org/doc/html/rfc5234">RFC 5234</a>)
expression.</p>
<pre><code class="language-text">sign-in-with-ethereum =
    [ scheme "://" ] domain %s" wants you to sign in with your 
    Ethereum account:" LF address LF
    LF
    [ statement LF ]
    LF
    %s"URI: " uri LF
    %s"Version: " version LF
    %s"Chain ID: " chain-id LF
    %s"Nonce: " nonce LF
    %s"Issued At: " issued-at
    [ LF %s"Expiration Time: " expiration-time ]
    [ LF %s"Not Before: " not-before ]
    [ LF %s"Request ID: " request-id ]
    [ LF %s"Resources:"
    resources ]

scheme = ALPHA *( ALPHA / DIGIT / "+" / "-" / "." )
    ; See RFC 3986 for the fully contextualized
    ; definition of "scheme".

domain = authority
    ; From RFC 3986:
    ;     authority     = [ userinfo "@" ] host [ ":" port ]
    ; See RFC 3986 for the fully contextualized
    ; definition of "authority".

address = "0x" 40*40HEXDIG
    ; Must also conform to captilization
    ; checksum encoding specified in EIP-55
    ; where applicable (EOAs).

statement = *( reserved / unreserved / " " )
    ; See RFC 3986 for the definition
    ; of "reserved" and "unreserved".
    ; The purpose is to exclude LF (line break).

uri = URI
    ; See RFC 3986 for the definition of "URI".

version = "1"

chain-id = 1*DIGIT
    ; See EIP-155 for valid CHAIN_IDs.

nonce = 8*( ALPHA / DIGIT )
    ; See RFC 5234 for the definition
    ; of "ALPHA" and "DIGIT".

issued-at = date-time
expiration-time = date-time
not-before = date-time
    ; See RFC 3339 (ISO 8601) for the
    ; definition of "date-time".

request-id = *pchar
    ; See RFC 3986 for the definition of "pchar".

resources = *( LF resource )

resource = "- " URI
</code></pre>
<p>This specification defines the following SIWE Message fields that can
be parsed from a SIWE Message by following the rules in
ABNF Message Format.
This section follows the section <em>ABNF message format</em>
in <a href="https://eips.ethereum.org/EIPS/eip-4361">EIP 4361</a>.</p>
<ul>
<li>
<p><code>scheme</code> OPTIONAL. The URI scheme of the origin of the request.
Its value MUST be a
<a href="https://datatracker.ietf.org/doc/htmlrfc3986">RFC 3986</a>
URI scheme.</p>
</li>
<li>
<p><code>domain</code> REQUIRED.
The domain that is requesting the signing.
Its value MUST be a <a href="https://datatracker.ietf.org/doc/html/rfc3986">RFC 3986</a>
authority. The authority includes an OPTIONAL port.
If the port is not specified, the default
port for the provided scheme is assumed.</p>
</li>
</ul>
<p>If scheme is not specified, HTTPS is assumed by default.</p>
<ul>
<li>
<p><code>address</code> REQUIRED. The Ethereum address performing the signing.
Its value SHOULD be conformant to mixed-case checksum address encoding
specified in ERC-55 where applicable.</p>
</li>
<li>
<p><code>statement</code> OPTIONAL. A human-readable ASCII assertion that the user
will sign which MUST NOT include '\n' (the byte 0x0a).</p>
</li>
<li>
<p><code>uri</code> REQUIRED. An
<a href="https://datatracker.ietf.org/doc/htmlrfc3986">RFC 3986</a>
URI referring to the resource that is the subject of the
signing.</p>
</li>
<li>
<p><code>version</code> REQUIRED. The current version of the SIWE Message, which
MUST be 1 for this specification.</p>
</li>
<li>
<p><code>chain-id</code> REQUIRED. The EIP-155 Chain ID to which the session is
bound, and the network where Contract Accounts MUST be resolved.</p>
</li>
<li>
<p><code>nonce</code> REQUIRED. A random string (minimum 8 alphanumeric characters)
chosen by the relying party and used to prevent replay attacks.</p>
</li>
<li>
<p><code>issued-at</code> REQUIRED. The time when the message was generated,
typically the current time.</p>
</li>
</ul>
<p>Its value MUST be an ISO 8601 datetime string.</p>
<ul>
<li><code>expiration-time</code> OPTIONAL. The time when the signed authentication
message is no longer valid.</li>
</ul>
<p>Its value MUST be an ISO 8601 datetime string.</p>
<ul>
<li><code>not-before</code> OPTIONAL. The time when the signed authentication
message will become valid.</li>
</ul>
<p>Its value MUST be an ISO 8601 datetime string.</p>
<ul>
<li>
<p><code>request-id</code> OPTIONAL. An system-specific identifier that MAY be used
to uniquely refer to the sign-in request.</p>
</li>
<li>
<p><code>resources</code> OPTIONAL. A list of information or references to
information the user wishes to have resolved as part of authentication
by the relying party.</p>
</li>
</ul>
<p>Every resource MUST be a RFC 3986 URI separated by "\n- " where \n is
the byte 0x0a.</p>
<h4 id="signing-and-verifying-messages-with-ethereum-accounts"><a class="header" href="#signing-and-verifying-messages-with-ethereum-accounts">Signing and Verifying Messages with Ethereum Accounts</a></h4>
<ul>
<li>
<p>For Externally Owned Accounts, the verification method specified in
<a href="https://eips.ethereum.org/EIPS/eip-191">ERC-191</a>
MUST be used.</p>
</li>
<li>
<p>For Contract Accounts,</p>
<ul>
<li>
<p>The verification method specified in
<a href="https://eips.ethereum.org/EIPS/eip-1271">ERC-1271</a>
SHOULD be used.
Otherwise, the implementer MUST clearly define the
verification method to attain security and interoperability
for both wallets and relying parties.</p>
</li>
<li>
<p>When performing <a href="https://eips.ethereum.org/EIPS/eip-1271">ERC-1271</a>
signature verification, the contract performing the verification MUST
be resolved from the specified <code>chain-id</code>.</p>
</li>
<li>
<p>Implementers SHOULD take into consideration that
<a href="https://eips.ethereum.org/EIPS/eip-1271">ERC-1271</a>
implementations are not required to be pure functions.
They can return different results for the same inputs depending
on blockchain state.
This can affect the security model and session validation rules.</p>
</li>
</ul>
</li>
</ul>
<h4 id="resolving-ethereum-name-service-ens-data"><a class="header" href="#resolving-ethereum-name-service-ens-data">Resolving Ethereum Name Service (ENS) Data</a></h4>
<ul>
<li>
<p>The relying party or wallet MAY additionally perform resolution of
ENS data, as this can improve the user experience by displaying human
friendly information that is related to the <code>address</code>.
Resolvable ENS data include:</p>
<ul>
<li>The primary ENS name.</li>
<li>The ENS avatar.</li>
<li>Any other resolvable resources specified in the ENS documentation.</li>
</ul>
</li>
<li>
<p>If resolution of ENS data is performed, implementers SHOULD take
precautions to preserve user privacy and consent.
Their <code>address</code> could be forwarded to third party services as part of
the resolution process.</p>
</li>
</ul>
<h4 id="implementer-steps-specifying-the-request-origin"><a class="header" href="#implementer-steps-specifying-the-request-origin">Implementer steps: specifying the request origin</a></h4>
<p>The <code>domain</code> and, if present, the <code>scheme</code>, in the SIWE Message MUST
correspond to the origin from where the signing request was made.</p>
<h4 id="implementer-steps-verifying-a-signed-message"><a class="header" href="#implementer-steps-verifying-a-signed-message">Implementer steps: verifying a signed message</a></h4>
<p>The SIWE Message MUST be checked for conformance to the ABNF Message
Format and its signature MUST be checked as defined in Signing and
Verifying Messages with Ethereum Accounts.</p>
<h4 id="implementer-steps-creating-sessions"><a class="header" href="#implementer-steps-creating-sessions">Implementer steps: creating sessions</a></h4>
<p>Sessions MUST be bound to the address and not to further resolved
resources that can change.</p>
<h4 id="implementer-steps-interpreting-and-resolving-resources"><a class="header" href="#implementer-steps-interpreting-and-resolving-resources">Implementer steps: interpreting and resolving resources</a></h4>
<p>Implementers SHOULD ensure that that URIs in the listed resources are
human-friendly when expressed in plaintext form.</p>
<h4 id="wallet-implementer-steps-verifying-the-message-format"><a class="header" href="#wallet-implementer-steps-verifying-the-message-format">Wallet implementer steps: verifying the message format</a></h4>
<p>The full SIWE message MUST be checked for conformance to the ABNF
defined in ABNF Message Format.</p>
<p>Wallet implementers SHOULD warn users if the substring <code>"wants you to sign in with your Ethereum account"</code> appears anywhere in an
<a href="https://eips.ethereum.org/EIPS/eip-191">ERC-191</a>
message signing request unless the message fully conforms to the format
defined ABNF Message Format.</p>
<h4 id="wallet-implementer-steps-verifying-the-request-origin"><a class="header" href="#wallet-implementer-steps-verifying-the-request-origin">Wallet implementer steps: verifying the request origin</a></h4>
<p>Wallet implementers MUST prevent phishing attacks by verifying the
origin of the request against the <code>scheme</code> and <code>domain</code> fields in the
SIWE Message.</p>
<p>The origin SHOULD be read from a trusted data source such as the
browser window or over WalletConnect
<a href="https://eips.ethereum.org/EIPS/eip-1328">ERC-1328</a> sessions for
comparison against the signing message contents.</p>
<p>Wallet implementers MAY warn instead of rejecting the verification if
the origin is pointing to localhost.</p>
<p>The following is a RECOMMENDED algorithm for Wallets to conform with
the requirements on request origin verification defined by
this specification.</p>
<p>The algorithm takes the following input variables:</p>
<ul>
<li>fields from the SIWE message.</li>
<li><code>origin</code> of the signing request: the origin of the page which
requested the signin via the provider.</li>
<li><code>allowedSchemes</code>: a list of schemes allowed by the Wallet.</li>
<li><code>defaultScheme</code>: a scheme to assume when none was provided. Wallet
implementers in the browser SHOULD use https.</li>
<li>developer mode indication: a setting deciding if certain risks should
be a warning instead of rejection. Can be manually configured or
derived from <code>origin</code> being localhost.</li>
</ul>
<p>The algorithm is described as follows:</p>
<ul>
<li>If <code>scheme</code> was not provided, then assign <code>defaultScheme</code> as scheme.</li>
<li>If <code>scheme</code> is not contained in <code>allowedSchemes</code>, then the <code>scheme</code>
is not expected and the Wallet MUST reject the request.
Wallet implementers in the browser SHOULD limit the list of
allowedSchemes to just 'https' unless a developer mode is activated.</li>
<li>If <code>scheme</code> does not match the scheme of origin, the Wallet SHOULD
reject the request.
Wallet implementers MAY show a warning instead of rejecting the request
if a developer mode is activated.
In that case the Wallet continues processing the request.</li>
<li>If the <code>host</code> part of the <code>domain</code> and <code>origin</code> do not match, the
Wallet MUST reject the request unless the Wallet is in developer mode.
In developer mode the Wallet MAY show a warning instead and continues
procesing the request.</li>
<li>If <code>domain</code> and <code>origin</code> have mismatching subdomains, the Wallet
SHOULD reject the request unless the Wallet is in developer mode.
In developer mode the Wallet MAY show a warning instead and continues
procesing the request.</li>
<li>Let <code>port</code> be the port component of <code>domain</code>, and if no port is
contained in domain, assign port the default port specified for the
scheme.</li>
<li>If <code>port</code> is not empty, then the Wallet SHOULD show a warning if the
<code>port</code> does not match the port of <code>origin</code>.</li>
<li>If <code>port</code> is empty, then the Wallet MAY show a warning if <code>origin</code>
contains a specific port.</li>
<li>Return request origin verification completed.</li>
</ul>
<h4 id="wallet-implementer-steps-creating-siwe-interfaces"><a class="header" href="#wallet-implementer-steps-creating-siwe-interfaces">Wallet implementer steps: creating SIWE interfaces</a></h4>
<p>Wallet implementers MUST display to the user the following fields from
the SIWE Message request by default and prior to signing, if they are
present: <code>scheme</code>, <code>domain</code>, <code>address</code>, <code>statement</code>, and <code>resources</code>.
Other present fields MUST also be made available to the user prior to
signing either by default or through an extended interface.</p>
<p>Wallet implementers displaying a plaintext SIWE Message to the user
SHOULD require the user to scroll to the bottom of the text area
prior to signing.</p>
<p>Wallet implementers MAY construct a custom SIWE user interface by
parsing the ABNF terms into data elements for use in the interface.
The display rules above still apply to custom interfaces.</p>
<h4 id="wallet-implementer-steps-supporting-internationalization-i18n"><a class="header" href="#wallet-implementer-steps-supporting-internationalization-i18n">Wallet implementer steps: supporting internationalization (i18n)</a></h4>
<p>After successfully parsing the message into ABNF terms, translation MAY
happen at the UX level per human language.</p>
<h2 id="consideration-to-secure-1-to-1-channels"><a class="header" href="#consideration-to-secure-1-to-1-channels">Consideration to secure 1-to-1 channels</a></h2>
<p>There are situations where users need to set one-to-one communication
channels in a secure way. One of these situations is when a user A
wants to add a new user B to an existing group.
In such situations communications between users MUST be done following
the instructions in this
<a href="https://github.com/vacp2p/rfc-index/blob/eth-secpm-splitted/vac/raw/eth-secure-channel.md">specification</a>
describing the use of X3DH in combination with the double ratchet mechanism.</p>
<h2 id="considerations-with-respect-to-decentralization"><a class="header" href="#considerations-with-respect-to-decentralization">Considerations with respect to decentralization</a></h2>
<p>The MLS protocol assumes the existence of a (central, untrusted)
<em>delivery service</em>, whose responsabilites include:</p>
<ul>
<li>Acting as a directory service providing the initial
keying material for clients to use.</li>
<li>Routing MLS messages among clients.</li>
</ul>
<p>The central delivery service can be avoided in protocols using the
publish/gossip approach, such as
<a href="https://github.com/libp2p/specs/tree/master/pubsub/gossipsub">gossipsub</a>.</p>
<p>Concerning keys, each node can generate and disseminate their
encryption key among the other nodes, so they can create a local
version of the tree that allows for the generation of the group key.</p>
<p>Another important component is the <em>authentication service</em>, which is
replaced with SIWE in this specification.</p>
<h2 id="privacy-and-security-considerations"><a class="header" href="#privacy-and-security-considerations">Privacy and Security Considerations</a></h2>
<ul>
<li>For the information retrieval, the algorithm MUST include a access
control mechanisms to restrict who can call the set and get functions.</li>
<li>One SHOULD include event logs to track changes in public keys.</li>
<li>The curve vurve448 MUST be chosen due to its higher security level:
224-bit security instead of the 128-bit security provided by X25519.</li>
<li>It is important that Bob MUST NOT reuse <code>SPK</code>.</li>
</ul>
<h2 id="copyright-7"><a class="header" href="#copyright-7">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-4"><a class="header" href="#references-4">References</a></h2>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc5234">Augmented BNF for Syntax Specifications</a></li>
<li><a href="https://github.com/libp2p/specs/tree/master/pubsub/gossipsub">Gossipsub</a></li>
<li><a href="https://www.ietf.org/rfc/rfc5869.txt">HMAC-based Extract-and-Expand Key Derivation Function</a></li>
<li><a href="https://datatracker.ietf.org/doc/rfc9180/">Hybrid Public Key Encryption</a></li>
<li><a href="https://eprint.iacr.org/2019/1189.pdf">Security Analysis and Improvements for the IETF MLS Standard for Group Messaging</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-191">Signed Data Standard</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-4361">Sign-In with Ethereum</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-1271">Standard Signature Validation Method for Contracts</a></li>
<li><a href="https://datatracker.ietf.org/doc/rfc9420/">The Messaging Layer Security Protocol</a></li>
<li><a href="https://rfc.vac.dev/spec/20/">Toy Ethereum Private Messaging Protocol</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc3986">Uniform Resource Identifier</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-1328">WalletConnect URI Format</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="eth-secpm"><a class="header" href="#eth-secpm">ETH-SECPM</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Secure channel setup using Ethereum accounts</td></tr>
<tr><th>Status</th><td>deleted</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Ramses Fernandez &lt;ramses@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-10"><a class="header" href="#timeline-10">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/raw/deleted/eth-secpm.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/raw/deleted/eth-secpm.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-06-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/36caaa621a711c7d73b5ecc80e7ba5f938d30691/vac/raw/deleted/eth-secpm.md"><code>36caaa6</code></a> — Fix Errors rfc.vac.dev (#165)</li>
<li><strong>2025-06-02</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/db90adc94e9f69627dd1254159d33eb062f00867/vac/raw/deleted/eth-secpm.md"><code>db90adc</code></a> — Fix LaTeX errors (#163)</li>
<li><strong>2025-04-04</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/517b63984c875670e437d50359f2f67331104974/vac/raw/deleted/eth-secpm.md"><code>517b639</code></a> — Update the RFCs: Vac Raw RFC (#143)</li>
<li><strong>2024-08-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/13aaae37d15bdd672c26565bd0e0ebfc2e8b9459/vac/raw/eth-secpm.md"><code>13aaae3</code></a> — Update eth-secpm.md (#84)</li>
<li><strong>2024-05-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/e234e9d5a30bb4d9d4654285c6118f3d9900a3b9/vac/raw/eth-secpm.md"><code>e234e9d</code></a> — Update eth-secpm.md (#35)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/vac/70/eth-secpm.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-28</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b842725d42f1c7d7661808035eff2b0dfa1fca7e/vac/70/eth-secpm.md"><code>b842725</code></a> — Update eth-secpm.md</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/f2e1b4cd4613f9ab648e42fd00475acf4541649d/vac/70/eth-secpm.md"><code>f2e1b4c</code></a> — Rename ETH-SECPM.md to eth-secpm.md</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/22bb3312fa6ab920281e11c5db190b123c9553b1/vac/70/ETH-SECPM.md"><code>22bb331</code></a> — Update ETH-SECPM.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/5b8ce46a6b384d6ee4c2d884f9db82b0aee9ce8c/vac/70/ETH-SECPM.md"><code>5b8ce46</code></a> — Create ETH-SECPM.md</li>
</ul>
<!-- timeline:end -->
<h2 id="note"><a class="header" href="#note">NOTE</a></h2>
<p>The content of this specification has been split between
<a href="vac/raw/deleted/vac/raw/eth-demls.html">ETH-DEMLS</a> and <a href="vac/raw/deleted/vac/raw/noise-x3dh-ratchet.html">NOISE-X3DH-RATCHET</a>
RFCs.</p>
<h2 id="motivation-6"><a class="header" href="#motivation-6">Motivation</a></h2>
<p>The need for secure communications has become paramount.<br />
Traditional centralized messaging protocols are susceptible to various security threats,
including unauthorized access, data breaches, and single points of failure.
Therefore a decentralized approach to secure communication becomes increasingly relevant,
offering a robust solution to address these challenges.</p>
<p>This specification outlines a private messaging service using the
Ethereum blockchain as authentication service.
Rooted in the existing <a href="vac/raw/deleted/../../waku/standards/application/20/toy-eth-pm.html">model</a>,
this proposal addresses the deficiencies related
to forward privacy and authentication inherent
in the current framework.
The specification is divided into 3 sections:</p>
<ul>
<li>Private 1-to-1 communications protocol, based on <a href="https://signal.org/docs/specifications/doubleratchet/">Signal's double
ratchet</a>.</li>
<li>Private group messaging protocol, based on the
<a href="https://datatracker.ietf.org/doc/rfc9420/">MLS protocol</a>.</li>
<li>Description of an Ethereum-based authentication protocol, based on
<a href="https://eips.ethereum.org/EIPS/eip-4361">SIWE</a>.</li>
</ul>
<h2 id="private-1-to-1-communications-protocol"><a class="header" href="#private-1-to-1-communications-protocol">Private 1-to-1 communications protocol</a></h2>
<h3 id="theory-1"><a class="header" href="#theory-1">Theory</a></h3>
<p>The specification is based on the noise protocol framework.
It corresponds to the double ratchet scheme combined with
the X3DH algorithm, which will be used to initialize the former.
We chose to express the protocol in noise to be be able to use
the noise streamlined implementation and proving features.
The X3DH algorithm provides both authentication and forward
secrecy, as stated in the
<a href="https://signal.org/docs/specifications/x3dh/">X3DH specification</a>.</p>
<p>This protocol will consist of several stages:</p>
<ol>
<li>Key setting for X3DH: this step will produce
prekey bundles for Bob which will be fed into X3DH.
It will also allow Alice to generate the keys required
to run the X3DH algorithm correctly.</li>
<li>Execution of X3DH: This step will output
a common secret key <code>SK</code> together with an additional
data vector <code>AD</code>. Both will be used in the double
ratchet algorithm initialization.</li>
<li>Execution of the double ratchet algorithm
for forward secure, authenticated communications,
using the common secret key <code>SK</code>, obtained from X3DH, as a root key.</li>
</ol>
<p>The protocol assumes the following requirements:</p>
<ul>
<li>Alice knows Bob’s Ethereum address.</li>
<li>Bob is willing to participate in the protocol,
and publishes his public key.</li>
<li>Bob’s ownership of his public key is verifiable,</li>
<li>Alice wants to send message M to Bob.</li>
<li>An eavesdropper cannot read M’s content
even if she is storing it or relaying it.</li>
</ul>
<blockquote>
<p>The inclusion of this first section devoted to secure 1-to-1
communications between users is motivated by the fact certain
interactions between existing group members and prospective new
members require secure communication channels.</p>
</blockquote>
<h3 id="syntax"><a class="header" href="#syntax">Syntax</a></h3>
<h4 id="cryptographic-suite"><a class="header" href="#cryptographic-suite">Cryptographic suite</a></h4>
<p>The following cryptographic functions MUST be used:</p>
<ul>
<li><code>X488</code> as Diffie-Hellman function <code>DH</code>.</li>
<li><code>SHA256</code> as KDF.</li>
<li><code>AES256-GCM</code> as AEAD algorithm.</li>
<li><code>SHA512</code> as hash function.</li>
<li><code>XEd448</code> for digital signatures.</li>
</ul>
<h4 id="x3dh-initialization"><a class="header" href="#x3dh-initialization">X3DH initialization</a></h4>
<p>This scheme MUST work on the curve curve448.
The X3DH algorithm corresponds to the IX pattern in Noise.</p>
<p>Bob and Alice MUST define personal key pairs
<code>(ik_B, IK_B)</code> and <code>(ik_A, IK_A)</code> respectively where:</p>
<ul>
<li>The key <code>ik</code> must be kept secret,</li>
<li>and the key <code>IK</code> is public.</li>
</ul>
<p>Bob MUST generate new keys using
<code>(ik_B, IK_B) = GENERATE_KEYPAIR(curve = curve448)</code>.</p>
<p>Bob MUST also generate a public key pair
<code>(spk_B, SPK_B) = GENERATE_KEYPAIR(curve = curve448)</code>.</p>
<p><code>SPK</code> is a public key generated and stored at medium-term.
Both signed prekey and the certificate MUST
undergo periodic replacement.
After replacing the key,
Bob keeps the old private key of <code>SPK</code>
for some interval, dependant on the implementation.
This allows Bob to decrypt delayed messages.</p>
<p>Bob MUST sign <code>SPK</code> for authentication:
<code>SigSPK = XEd448(ik, Encode(SPK))</code></p>
<p>A final step requires the definition of
<code>prekey_bundle = (IK, SPK, SigSPK, OPK_i)</code></p>
<p>One-time keys <code>OPK</code> MUST be generated as
<code>(opk_B, OPK_B) = GENERATE_KEYPAIR(curve = curve448)</code>.</p>
<p>Before sending an initial message to Bob,
Alice MUST generate an AD: <code>AD = Encode(IK_A) || Encode(IK_B)</code>.</p>
<p>Alice MUST generate ephemeral key pairs
<code>(ek, EK) = GENERATE_KEYPAIR(curve = curve448)</code>.</p>
<p>The function <code>Encode()</code> transforms a
curve448 public key into a byte sequence.
This is specified in the <a href="http://www.ietf.org/rfc/rfc7748.txt">RFC 7748</a>
on elliptic curves for security.</p>
<p>One MUST consider <code>q = 2^446 - 13818066809895115352007386748515426880336692474882178609894547503885</code>
for digital signatures with <code>(XEd448_sign, XEd448_verify)</code>:</p>
<pre><code class="language-text">XEd448_sign((ik, IK), message):
    Z = randbytes(64)  
    r = SHA512(2^456 - 2 || ik || message || Z )
    R = (r * convert_mont(5)) % q
    h = SHA512(R || IK || M)
    s = (r + h * ik) % q
    return (R || s)
</code></pre>
<pre><code class="language-text">XEd448_verify(u, message, (R || s)):
    if (R.y &gt;= 2^448) or (s &gt;= 2^446): return FALSE
    h = (SHA512(R || 156326 || message)) % q
    R_check = s * convert_mont(5) - h * 156326
    if R == R_check: return TRUE
    return FALSE 
</code></pre>
<pre><code class="language-text">convert_mont(u):
    u_masked = u % mod 2^448
    inv = ((1 - u_masked)^(2^448 - 2^224 - 3)) % (2^448 - 2^224 - 1)
    P.y = ((1 + u_masked) * inv)) % (2^448 - 2^224 - 1)
    P.s = 0
    return P
</code></pre>
<h4 id="use-of-x3dh"><a class="header" href="#use-of-x3dh">Use of X3DH</a></h4>
<p>This specification combines the double ratchet
with X3DH using the following data as initialization for the former:</p>
<ul>
<li>The <code>SK</code> output from X3DH becomes the <code>SK</code>
input of the double ratchet. See section 3.3 of
<a href="https://signal.org/docs/specifications/doubleratchet/">Signal Specification</a>
for a detailed description.</li>
<li>The <code>AD</code> output from X3DH becomes the <code>AD</code>
input of the double ratchet. See sections 3.4 and 3.5 of
<a href="https://signal.org/docs/specifications/doubleratchet/">Signal Specification</a>
for a detailed description.</li>
<li>Bob’s signed prekey <code>SigSPKB</code> from X3DH is used as Bob’s
initial ratchet public key of the double ratchet.</li>
</ul>
<p>X3DH has three phases:</p>
<ol>
<li>Bob publishes his identity key and prekeys to a server,
a network, or dedicated smart contract.</li>
<li>Alice fetches a prekey bundle from the server,
and uses it to send an initial message to Bob.</li>
<li>Bob receives and processes Alice's initial message.</li>
</ol>
<p>Alice MUST perform the following computations:</p>
<pre><code class="language-text">dh1 = DH(IK_A, SPK_B, curve = curve448)
dh2 = DH(EK_A, IK_B, curve = curve448)
dh3 = DH(EK_A, SPK_B)
SK = KDF(dh1 || dh2 || dh3)
</code></pre>
<p>Alice MUST send to Bob a message containing:</p>
<ul>
<li><code>IK_A, EK_A</code>.</li>
<li>An identifier to Bob's prekeys used.</li>
<li>A message encrypted with AES256-GCM using <code>AD</code> and <code>SK</code>.</li>
</ul>
<p>Upon reception of the initial message, Bob MUST:</p>
<ol>
<li>Perform the same computations above with the <code>DH()</code> function.</li>
<li>Derive <code>SK</code> and construct <code>AD</code>.</li>
<li>Decrypt the initial message encrypted with <code>AES256-GCM</code>.</li>
<li>If decryption fails, abort the protocol.</li>
</ol>
<h4 id="initialization-of-the-double-datchet"><a class="header" href="#initialization-of-the-double-datchet">Initialization of the double datchet</a></h4>
<p>In this stage Bob and Alice have generated key pairs
and agreed a shared secret <code>SK</code> using X3DH.</p>
<p>Alice calls <code>RatchetInitAlice()</code> defined below:</p>
<pre><code class="language-text">RatchetInitAlice(SK, IK_B):
    state.DHs = GENERATE_KEYPAIR(curve = curve448)
    state.DHr = IK_B
    state.RK, state.CKs = HKDF(SK, DH(state.DHs, state.DHr)) 
    state.CKr = None
    state.Ns, state.Nr, state.PN = 0
    state.MKSKIPPED = {}
</code></pre>
<p>The HKDF function MUST be the proposal by
<a href="http://www.ietf.org/rfc/rfc5869.txt">Krawczyk and Eronen</a>.
In this proposal <code>chaining_key</code> and <code>input_key_material</code>
MUST be replaced with <code>SK</code> and the output of <code>DH</code> respectively.</p>
<p>Similarly, Bob calls the function <code>RatchetInitBob()</code> defined below:</p>
<pre><code class="language-text">RatchetInitBob(SK, (ik_B,IK_B)):
    state.DHs = (ik_B, IK_B)
    state.Dhr = None
    state.RK = SK
    state.CKs, state.CKr = None
    state.Ns, state.Nr, state.PN = 0
    state.MKSKIPPED = {}
</code></pre>
<h4 id="encryption"><a class="header" href="#encryption">Encryption</a></h4>
<p>This function performs the symmetric key ratchet.</p>
<pre><code class="language-text">RatchetEncrypt(state, plaintext, AD):
   state.CKs, mk = HMAC-SHA256(state.CKs)
   header = HEADER(state.DHs, state.PN, state.Ns)
   state.Ns = state.Ns + 1
   return header, AES256-GCM_Enc(mk, plaintext, AD || header)
</code></pre>
<p>The <code>HEADER</code> function creates a new message header
containing the public key from the key pair output of the <code>DH</code>function.
It outputs the previous chain length <code>pn</code>,
and the message number <code>n</code>.
The returned header object contains ratchet public key
<code>dh</code> and integers <code>pn</code> and <code>n</code>.</p>
<h4 id="decryption"><a class="header" href="#decryption">Decryption</a></h4>
<p>The function <code>RatchetDecrypt()</code> decrypts incoming messages:</p>
<pre><code class="language-text">RatchetDecrypt(state, header, ciphertext, AD):
    plaintext = TrySkippedMessageKeys(state, header, ciphertext, AD)
    if plaintext != None:
        return plaintext
    if header.dh != state.DHr:
        SkipMessageKeys(state, header.pn)
        DHRatchet(state, header)
    SkipMessageKeys(state, header.n)
    state.CKr, mk = HMAC-SHA256(state.CKr)
    state.Nr = state.Nr + 1
    return AES256-GCM_Dec(mk, ciphertext, AD || header)
</code></pre>
<p>Auxiliary functions follow:</p>
<pre><code class="language-text">DHRatchet(state, header):
    state.PN = state.Ns
    state.Ns = state.Nr = 0
    state.DHr = header.dh
    state.RK, state.CKr = HKDF(state.RK, DH(state.DHs, state.DHr))
    state.DHs = GENERATE_KEYPAIR(curve = curve448)
    state.RK, state.CKs = HKDF(state.RK, DH(state.DHs, state.DHr))
</code></pre>
<pre><code class="language-text">SkipMessageKeys(state, until):
    if state.NR + MAX_SKIP &lt; until:
        raise Error
    if state.CKr != none:
        while state.Nr &lt; until:
            state.CKr, mk = HMAC-SHA256(state.CKr)
            state.MKSKIPPED[state.DHr, state.Nr] = mk
            state.Nr = state.Nr + 1
</code></pre>
<pre><code class="language-text">TrySkippedMessageKey(state, header, ciphertext, AD):
    if (header.dh, header.n) in state.MKSKIPPED:
        mk = state.MKSKIPPED[header.dh, header.n]
        delete state.MKSKIPPED[header.dh, header.n]
        return AES256-GCM_Dec(mk, ciphertext, AD || header)
    else: return None
</code></pre>
<h2 id="information-retrieval"><a class="header" href="#information-retrieval">Information retrieval</a></h2>
<h3 id="static-data"><a class="header" href="#static-data">Static data</a></h3>
<p>Some data, such as the key pairs <code>(ik, IK)</code> for Alice and Bob,
MAY NOT be regenerated after a period of time.
Therefore the prekey bundle MAY be stored in long-term
storage solutions, such as a dedicated smart contract
which outputs such a key pair when receiving an Ethereum wallet
address.</p>
<p>Storing static data is done using a dedicated
smart contract <code>PublicKeyStorage</code> which associates
the Ethereum wallet address of a user with his public key.
This mapping is done by <code>PublicKeyStorage</code>
using a <code>publicKeys</code> function, or a <code>setPublicKey</code> function.
This mapping is done if the user passed an authorization process.
A user who wants to retrieve a public key associated
with a specific wallet address calls a function <code>getPublicKey</code>.
The user provides the wallet address as the only
input parameter for <code>getPublicKey</code>.
The function outputs the associated public key
from the smart contract.</p>
<h3 id="ephemeral-data"><a class="header" href="#ephemeral-data">Ephemeral data</a></h3>
<p>Storing ephemeral data on Ethereum MAY be done using
a combination of on-chain and off-chain solutions.
This approach provides an efficient solution to
the problem of storing updatable data in Ethereum.</p>
<ol>
<li>Ethereum stores a reference or a hash
that points to the off-chain data.</li>
<li>Off-chain solutions can include systems like IPFS,
traditional cloud storage solutions, or
decentralized storage networks such as a
<a href="https://www.ethswarm.org">Swarm</a>.</li>
</ol>
<p>In any case, the user stores the associated
IPFS hash, URL or reference in Ethereum.</p>
<p>The fact of a user not updating the ephemeral information
can be understood as Bob not willing to participate in any
communication.</p>
<p>This applies to <code>KeyPackage</code>,
which in the MLS specification are meant
o be stored in a directory provided by the delivery service.
If such an element does not exist,
<code>KeyPackage</code> MUST be stored according
to one of the two options outlined above.</p>
<h2 id="private-group-messaging-protocol-1"><a class="header" href="#private-group-messaging-protocol-1">Private group messaging protocol</a></h2>
<h3 id="theoretical-content"><a class="header" href="#theoretical-content">Theoretical content</a></h3>
<p>The <a href="https://datatracker.ietf.org/doc/rfc9420/">Messaging Layer Security</a>(MLS)
protocol aims at providing a group of users with
end-to-end encryption in an authenticated and asynchronous way.
The main security characteristics of the protocol are:
Message confidentiality and authentication, sender authentication,
membership agreement, post-remove
and post-update security, and forward secrecy and
post-compromise security.
The MLS protocol achieves: low-complexity, group integrity,
synchronization and extensibility.</p>
<p>The extension to group chat described in forthcoming sections is built upon the
<a href="https://datatracker.ietf.org/doc/rfc9420/">MLS</a> protocol.</p>
<h3 id="structure-1"><a class="header" href="#structure-1">Structure</a></h3>
<p>Each MLS session uses a single cipher suite that specifies the
primitives to be used in group key computations. The cipher suite MUST
use:</p>
<ul>
<li><code>X488</code> as Diffie-Hellman function.</li>
<li><code>SHA256</code> as KDF.</li>
<li><code>AES256-GCM</code> as AEAD algorithm.</li>
<li><code>SHA512</code> as hash function.</li>
<li><code>XEd448</code> for digital signatures.</li>
</ul>
<p>Formats for public keys, signatures and public-key encryption MUST
follow Section 5.1 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="hash-based-identifiers-1"><a class="header" href="#hash-based-identifiers-1">Hash-based identifiers</a></h3>
<p>Some MLS messages refer to other MLS objects by hash.
These identifiers MUST be computed according to Section 5.2 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="credentials-1"><a class="header" href="#credentials-1">Credentials</a></h3>
<p>Each member of a group presents a credential that provides one or more
identities for the
member and associates them with the member's signing key.
The identities and signing key are verified by the Authentication
Service in use for a
group.</p>
<p>Credentials MUST follow the specifications of section 5.3 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<p>Below follows the flow diagram for the generation of credentials.
Users MUST generate key pairs by themselves.
<img src="vac/raw/deleted//vac/raw/images/eth-secpm_credential.png" alt="figure1" /></p>
<h3 id="message-framing-1"><a class="header" href="#message-framing-1">Message framing</a></h3>
<p>Handshake and application messages use a common framing structure
providing encryption to
ensure confidentiality within the group, and signing to authenticate
the sender.</p>
<p>The structure is:</p>
<ul>
<li><code>PublicMessage</code>: represents a message that is only signed, and not
encrypted.
The definition and the encoding/decoding of a <code>PublicMessage</code> MUST
follow the specification
in section 6.2 of <a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</li>
<li><code>PrivateMessage</code>: represents a signed and encrypted message, with
protections for both the content of the message and related metadata.</li>
</ul>
<p>The definition, and the encoding/decoding of a <code>PrivateMessage</code> MUST
follow the  specification in section 6.3 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<p>Applications MUST use <code>PrivateMessage</code> to encrypt application messages.</p>
<p>Applications SHOULD use <code>PrivateMessage</code> to encode handshake messages.</p>
<p>Each encrypted MLS message carries a "generation" number which is a
per-sender incrementing counter.
If a group member observes a gap in the generation sequence for a
sender, then they know that they have missed a message from that
sender.</p>
<h3 id="nodes-contents-1"><a class="header" href="#nodes-contents-1">Nodes contents</a></h3>
<p>The nodes of a ratchet tree contain several types of data:</p>
<ul>
<li>Leaf nodes describe individual members.</li>
<li>Parent nodes describe subgroups.</li>
</ul>
<p>Contents of each kind of node, and its structure MUST follow the
indications described in
sections 7.1 and 7.2 of
<a href="https://datatracker.ietf.org/docrfc9420/">RFC9420</a>.</p>
<h3 id="leaf-node-validation-1"><a class="header" href="#leaf-node-validation-1">Leaf node validation</a></h3>
<p><code>KeyPackage</code> objects describe the client's capabilities and provides
keys that can be used  to add the client to a group.</p>
<p>The validity of a leaf node needs to be verified at the following
stages:</p>
<ul>
<li>When a leaf node is downloaded in a <code>KeyPackage</code>, before it is used
to add the client to the group.</li>
<li>When a leaf node is received by a group member in an Add, Update, or
Commit message.</li>
<li>When a client validates a ratchet tree.</li>
</ul>
<p>A client MUST verify the validity of a leaf node following the
instructions of section 7.3 in
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="ratchet-tree-evolution-1"><a class="header" href="#ratchet-tree-evolution-1">Ratchet tree evolution</a></h3>
<p>Whenever a member initiates an epoch change, they MAY need to refresh
the key pairs of their leaf and of the nodes on their direct path. This
is done to keep forward secrecy and post-compromise security.
The member initiating the epoch change MUST follow this procedure
procedure.
A member updates the nodes along its direct path as follows:</p>
<ul>
<li>Blank all the nodes on the direct path from the leaf to the root.</li>
<li>Generate a fresh HPKE key pair for the leaf.</li>
<li>Generate a sequence of path secrets, one for each node on the leaf's
filtered direct path.</li>
</ul>
<p>It MUST follow the procedure described in section 7.4 of [RFC9420
(https://datatracker.ietf.org/doc/rfc9420/).</p>
<ul>
<li>Compute the sequence of HPKE key pairs <code>(node_priv,node_pub)</code>, one
for each node on the leaf's direct path.</li>
</ul>
<p>It MUST follow the procedure described in section 7.4 of [RFC9420
(https://datatracker.ietf.org/doc/rfc9420/).</p>
<h3 id="views-of-the-tree-synchronization-1"><a class="header" href="#views-of-the-tree-synchronization-1">Views of the tree synchronization</a></h3>
<p>After generating fresh key material and applying it to update their
local tree state, the generator broadcasts this update to other members
of the group.
This operation MUST be done according to section 7.5 of [RFC9420
(https://datatracker.ietf.org/doc/rfc9420/).</p>
<h3 id="leaf-synchronization-1"><a class="header" href="#leaf-synchronization-1">Leaf synchronization</a></h3>
<p>Changes to group memberships MUST be represented by adding and removing
leaves of the tree.
This corresponds to increasing or decreasing the depth of the tree,
resulting in the number of leaves being doubled or halved.
These operations MUST be done as described in section 7.7 of [RFC9420
(https://datatracker.ietf.org/doc/rfc9420/).</p>
<h3 id="tree-and-parent-hashing-1"><a class="header" href="#tree-and-parent-hashing-1">Tree and parent hashing</a></h3>
<p>Group members can agree on the cryptographic state of the group by
generating a hash value that represents the contents of the group
ratchet tree and the member’s credentials.
The hash of the tree is the hash of its root node, defined recursively
from the leaves.
Tree hashes summarize the state of a tree at point in time.
The hash of a leaf is the hash of the <code>LeafNodeHashInput</code> object.
At the same time, the hash of a parent node including the root, is the
hash of a <code>ParentNodeHashInput</code> object.
Parent hashes capture information about how keys in the tree were
populated.</p>
<p>Tree and parent hashing MUST follow the directions in Sections 7.8 and
7.9 of <a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="key-schedule-1"><a class="header" href="#key-schedule-1">Key schedule</a></h3>
<p>Group keys are derived using the <code>Extract</code> and <code>Expand</code> functions from
the KDF for the group's cipher suite, as well as the functions defined
below:</p>
<pre><code class="language-text">ExpandWithLabel(Secret, Label, Context, Length) = KDF.Expand(Secret,
KDFLabel, Length)
DeriveSecret(Secret, Label) = ExpandWithLabel(Secret, Label, "",
KDF.Nh)

</code></pre>
<p><code>KDFLabel</code> MUST be specified as:</p>
<pre><code class="language-text">struct {
    uint16 length;
    opaque label&lt;V&gt;;
    opaque context&lt;V&gt;;
} KDFLabel;

</code></pre>
<p>The fields of <code>KDFLabel</code> MUST be:</p>
<pre><code class="language-text">length = Length;
label = "MLS 1.0 " + Label;
context = Context;

</code></pre>
<p>Each member of the group MUST maintaint a <code>GroupContext</code> object
summarizing the state of the group.</p>
<p>The sturcture of such object MUST be:</p>
<pre><code class="language-text">struct {
ProtocolVersion version = mls10;
CipherSuite cipher_suite;
opaque group_id&lt;V&gt;;
uint64 epoch;
opaque tree_hash&lt;V&gt;;
opaque confirmed_trasncript_hash&lt;V&gt;;
Extension extension&lt;V&gt;;
} GroupContext;

</code></pre>
<p>The use of key scheduling MUST follow the indications in sections 8.1 -
8.7 in <a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="secret-trees-1"><a class="header" href="#secret-trees-1">Secret trees</a></h3>
<p>For the generation of encryption keys and nonces, the key schedule
begins with the <code>encryption_secret</code> at the root and derives a tree of
secrets with the same structure as the group's ratchet tree.
Each leaf in the secret tree is associated with the same group member
as the corresponding leaf in the ratchet tree.</p>
<p>If <code>N</code> is a parent node in the secret tree, the secrets of the children
of <code>N</code> MUST be defined following section 9 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h4 id="encryption-keys-1"><a class="header" href="#encryption-keys-1">Encryption keys</a></h4>
<p>MLS encrypts three different types of information:</p>
<ul>
<li>Metadata (sender information).</li>
<li>Handshake messages (Proposal and Commit).</li>
<li>Application messages.</li>
</ul>
<p>For handshake and application messages, a sequence of keys is derived
via a sender ratchet.
Each sender has their own sender ratchet, and each step along the
ratchet is called a generation. These procedures MUST follow section
9.1 of <a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h4 id="deletion-schedule-1"><a class="header" href="#deletion-schedule-1">Deletion schedule</a></h4>
<p>All security-sensitive values MUST be deleted as soon as they are
consumed.</p>
<p>A sensitive value S is consumed if:</p>
<ul>
<li>S was used to encrypt or (successfully) decrypt a message.</li>
<li>A key, nonce, or secret derived from S has been consumed.</li>
</ul>
<p>The deletion procedure MUST follow the instruction described in section
9.2 of <a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="key-packages-1"><a class="header" href="#key-packages-1">Key packages</a></h3>
<p>KeyPackage objects are used to ease the addition of clients to a group
asynchronously.
A KeyPackage object specifies:</p>
<ul>
<li>Protocol version and cipher suite supported by the client.</li>
<li>Public keys that can be used to encrypt Welcome messages.
Welcome messages provide new members with the information
to initialize their
state for the epoch in which they were added or in which they want to
add themselves to the group</li>
<li>The content of the leaf node that should be added to the tree to
represent this client.</li>
</ul>
<p>KeyPackages are intended to be used only once and SHOULD NOT be reused.</p>
<p>Clients MAY generate and publish multiple KeyPackages to support
multiple cipher suites.</p>
<p>The structure of the object MUST be:</p>
<pre><code class="language-text">struct {
ProtocolVersion version;
CipherSuite cipher_suite;
HPKEPublicKey init_key;
LeafNode leaf_node;
Extension extensions&lt;V&gt;;
/* SignWithLabel(., "KeyPackageTBS", KeyPackageTBS) */
opaque signature&lt;V&gt;;
}

</code></pre>
<pre><code class="language-text">struct {
ProtocolVersion version;
CipheSuite cipher_suite;
HPKEPublicKey init_key;
LeafNode leaf_node;
Extension extensions&lt;V&gt;;
}

</code></pre>
<p><code>KeyPackage</code> object MUST be verified when:</p>
<ul>
<li>A <code>KeyPackage</code> is downloaded by a group member, before it is used to
add the client to the group.</li>
<li>When a <code>KeyPackage</code> is received by a group member in an <code>Add</code>
message.</li>
</ul>
<p>Verification MUST be done as follows:</p>
<ul>
<li>Verify that the cipher suite and protocol version of the <code>KeyPackage</code>
match those in the <code>GroupContext</code>.</li>
<li>Verify that the <code>leaf_node</code> of the <code>KeyPackage</code> is valid for a
<code>KeyPackage</code>.</li>
<li>Verify that the signature on the <code>KeyPackage</code> is valid.</li>
<li>Verify that the value of <code>leaf_node.encryption_key</code> is different from
the value of the <code>init_key field</code>.</li>
</ul>
<p>HPKE public keys are opaque values in a format defined by Section 4 of
<a href="https://datatracker.ietf.org/doc/rfc9180/">RFC9180</a>.</p>
<p>Signature public keys are represented as opaque values in a format
defined by the cipher suite's signature scheme.</p>
<h3 id="group-creation-1"><a class="header" href="#group-creation-1">Group creation</a></h3>
<p>A group is always created with a single member.
Other members are then added to the group using the usual Add/Commit
mechanism.
The creator of a group MUST set:</p>
<ul>
<li>the group ID.</li>
<li>cipher suite.</li>
<li>initial extensions for the group.</li>
</ul>
<p>If the creator intends to add other members at the time of creation,
then it SHOULD fetch <code>KeyPackages</code> for those members, and select a
cipher suite and extensions according to their capabilities.</p>
<p>The creator MUST use the capabilities information in these
<code>KeyPackages</code> to verify that the chosen version and cipher suite is the
best option supported by all members.</p>
<p>Group IDs SHOULD be constructed so they are unique with high
probability.</p>
<p>To initialize a group, the creator of the group MUST initialize a one
member group with the following initial values:</p>
<ul>
<li>Ratchet tree: A tree with a single node, a leaf node containing an
HPKE public key and credential for the creator.</li>
<li>Group ID: A value set by the creator.</li>
<li>Epoch: <code>0</code>.</li>
<li>Tree hash: The root hash of the above ratchet tree.</li>
<li>Confirmed transcript hash: The zero-length octet string.</li>
<li>Epoch secret: A fresh random value of size <code>KDF.Nh</code>.</li>
<li>Extensions: Any values of the creator's choosing.</li>
</ul>
<p>The creator MUST also calculate the interim transcript hash:</p>
<ul>
<li>Derive the <code>confirmation_key</code> for the epoch according to Section 8 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</li>
<li>Compute a <code>confirmation_tag</code> over the empty
<code>confirmed_transcript_hash</code> using the <code>confirmation_key</code> as described
in Section 8.1 of <a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</li>
<li>Compute the updated <code>interim_transcript_hash</code> from the
<code>confirmed_transcript_hash</code> and the <code>confirmation_tag</code> as described in
Section 8.2 <a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</li>
</ul>
<p>All members of a group MUST support the cipher suite and protocol
version in use. Additional requirements MAY be imposed by including a
<code>required_capabilities</code> extension in the <code>GroupContext</code>.</p>
<pre><code class="language-text">struct {
ExtensionType extension_types&lt;V&gt;;
ProposalType proposal_types&lt;V&gt;;
CredentialType credential_types&lt;V&gt;;
}

</code></pre>
<p>The flow diagram shows the procedure to fetch key material from other
users:
<img src="vac/raw/deleted//vac/raw/images/eth-secpm_fetching.png" alt="figure2" /></p>
<p>Below follows the flow diagram for the creation of a group:
<img src="vac/raw/deleted//vac/raw/images/eth-secpm_creation.png" alt="figure3" /></p>
<h3 id="group-evolution-1"><a class="header" href="#group-evolution-1">Group evolution</a></h3>
<p>Group membership can change, and existing members can change their keys
in order to achieve post-compromise security.
In MLS, each such change is accomplished by a two-step process:</p>
<ul>
<li>A proposal to make the change is broadcast to the group in a Proposal
message.</li>
<li>A member of the group or a new member broadcasts a Commit message
that causes one or more proposed changes to enter into effect.</li>
</ul>
<p>The group evolves from one cryptographic state to another each time a
Commit message is sent and processed.
These states are called epochs and are uniquely identified among states
of the group by eight-octet epoch values.</p>
<p>Proposals are included in a <code>FramedContent</code> by way of a <code>Proposal</code>
structure that indicates their type:</p>
<pre><code class="language-text">struct {
ProposalType proposal_type;
select (Proposal.proposal_type) {
case add:                      Add:
case update:                   Update;
case remove:                   Remove;
case psk:                      PreSharedKey;
case reinit:                   ReInit;
case external_init:            ExternalInit;
case group_context_extensions: GroupContextExtensions;
}

</code></pre>
<p>On receiving a <code>FramedContent</code> containing a <code>Proposal</code>, a client MUST
verify the signature inside <code>FramedContentAuthData</code> and that the epoch
field of the enclosing FramedContent is equal to the epoch field of the
current GroupContext object.
If the verification is successful, then the Proposal SHOULD be cached
in such a way that it can be retrieved by hash in a later Commit
message.</p>
<p>Proposals are organized as follows:</p>
<ul>
<li><code>Add</code>: requests that a client with a specified KeyPackage be added to
the group.</li>
<li><code>Update</code>: similar to Add, it replaces the sender's LeafNode in the
tree instead of adding a new leaf to the tree.</li>
<li><code>Remove</code>: requests that the member with the leaf index removed be
removed from the group.</li>
<li><code>ReInit</code>: requests to reinitialize the group with different
parameters.</li>
<li><code>ExternalInit</code>: used by new members that want to join a group by
using an external commit.</li>
<li><code>GroupContentExtensions</code>: it is used to update the list of extensions
in the GroupContext for the group.</li>
</ul>
<p>Proposals structure and semantics MUST follow sections 12.1.1 - 12.1.7
of <a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<p>Any list of commited proposals MUST be validated either by a the group
member who created the commit, or any group member processing such
commit.
The validation MUST be done according to one of the procedures
described in Section 12.2 of
<a href="https://datatracker.ietf.orgdoc/rfc9420/">RFC9420</a>.</p>
<p>When creating or processing a Commit, a client applies a list of
proposals to the ratchet tree and <code>GroupContext</code>.
The client MUST apply the proposals in the list in the order described
in Section 12.3 of <a href="https://datatracker.ietf.org/docrfc9420/">RFC9420</a>.</p>
<p>Below follows the flow diagram for the addition of a member to a group:
<img src="vac/raw/deleted//vac/raw/images/eth-secpm_add.png" alt="figure4" /></p>
<p>The diagram below shows the procedure to remove a group member:</p>
<p><img src="vac/raw/deleted//vac/raw/images/eth-secpm_remove.png" alt="figure5" /></p>
<p>The flow diagram below shows an update procedure:</p>
<p><img src="vac/raw/deleted//vac/raw/images/eth-secpm_update.png" alt="figure6" /></p>
<h3 id="commit-messages-1"><a class="header" href="#commit-messages-1">Commit messages</a></h3>
<p>Commit messages initiate new group epochs.
It informs group members to update their representation of the state of
the group by applying the proposals and advancing the key schedule.</p>
<p>Each proposal covered by the Commit is included by a <code>ProposalOrRef</code>
value.
<code>ProposalOrRef</code> identify the proposal to be applied by value or by
reference.
Commits that refer to new Proposals from the committer can be included
by value.
Commits for previously sent proposals from anyone can be sent by
reference.
Proposals sent by reference are specified by including the hash of the
<code>AuthenticatedContent</code>.</p>
<p>Group members that have observed one or more valid proposals within an
epoch MUST send a Commit message before sending application data.
A sender and a receiver of a Commit MUST verify that the committed list
of proposals is valid.
The sender of a Commit SHOULD include all valid proposals received
during the current epoch.</p>
<p>Functioning of commits MUST follow the instructions of Section 12.4 of
<a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="application-messages-1"><a class="header" href="#application-messages-1">Application messages</a></h3>
<p>Handshake messages provide an authenticated group key exchange to
clients.
To protect application messages sent among the members of a group, the
<code>encryption_secret</code> provided by the key schedule is used to derive a
sequence of nonces and keys for message encryption.</p>
<p>Each client MUST maintain their local copy of the key schedule for each
epoch during which they are a group member.
They derive new keys, nonces, and secrets as needed. This data MUST be
deleted as soon as they have been used.</p>
<p>Group members MUST use the AEAD algorithm associated with the
negotiated MLS ciphersuite to encrypt and decrypt Application messages
according to the Message Framing section.
The group identifier and epoch allow a device to know which group
secrets should be used and from which Epoch secret to start computing
other secrets and keys.
Application messages SHOULD be padded to provide resistance against
traffic analysis techniques.
This avoids additional information to be provided to an attacker in
order to guess the length of the encrypted message.
Padding SHOULD be used on messages with zero-valued bytes before AEAD
encryption.</p>
<p>Functioning of application messages MUST follow the instructions of
Section 15 of <a href="https://datatracker.ietf.org/doc/rfc9420/">RFC9420</a>.</p>
<h3 id="considerations-with-respect-to-decentralization-1"><a class="header" href="#considerations-with-respect-to-decentralization-1">Considerations with respect to decentralization</a></h3>
<p>The MLS protocol assumes the existence on a (central, untrusted)
<em>delivery service</em>, whose responsabilites include:</p>
<ul>
<li>Acting as a directory service providing the initial
keying material for clients to use.</li>
<li>Routing MLS messages among clients.</li>
</ul>
<p>The central delivery service can be avoided in protocols using the
publish/gossip approach, such as
<a href="https://github.com/libp2p/specs/tree/master/pubsub/gossipsub">gossipsub</a>.</p>
<p>Concerning keys, each node can generate and disseminate their
encryption key among the other nodes, so they can create a local
version of the tree that allows for the generation of the group key.</p>
<p>Another important component is the <em>authentication service</em>, which is
replaced with SIWE in this specification.</p>
<h2 id="ethereum-based-authentication-protocol-1"><a class="header" href="#ethereum-based-authentication-protocol-1">Ethereum-based authentication protocol</a></h2>
<h3 id="introduction-1"><a class="header" href="#introduction-1">Introduction</a></h3>
<p>Sign-in with Ethereum describes how Ethereum accounts authenticate with
off-chain services by signing a standard message format
parameterized by scope, session details, and security mechanisms.
Sign-in with Ethereum (SIWE), which is described in the [EIP 4361
(https://eips.ethereum.org/EIPS/eip-4361), MUST be the authentication
method required.</p>
<h3 id="pattern-1"><a class="header" href="#pattern-1">Pattern</a></h3>
<h4 id="message-format-abnf-1"><a class="header" href="#message-format-abnf-1">Message format (ABNF)</a></h4>
<p>A SIWE Message MUST conform with the following Augmented Backus–Naur
Form (<a href="https://datatracker.ietf.org/doc/html/rfc5234">RFC 5234</a>)
expression.</p>
<pre><code class="language-text">sign-in-with-ethereum =
    [ scheme "://" ] domain %s" wants you to sign in with your 
    Ethereum account:" LF address LF
    LF
    [ statement LF ]
    LF
    %s"URI: " uri LF
    %s"Version: " version LF
    %s"Chain ID: " chain-id LF
    %s"Nonce: " nonce LF
    %s"Issued At: " issued-at
    [ LF %s"Expiration Time: " expiration-time ]
    [ LF %s"Not Before: " not-before ]
    [ LF %s"Request ID: " request-id ]
    [ LF %s"Resources:"
    resources ]

scheme = ALPHA *( ALPHA / DIGIT / "+" / "-" / "." )
    ; See RFC 3986 for the fully contextualized
    ; definition of "scheme".

domain = authority
    ; From RFC 3986:
    ;     authority     = [ userinfo "@" ] host [ ":" port ]
    ; See RFC 3986 for the fully contextualized
    ; definition of "authority".

address = "0x" 40*40HEXDIG
    ; Must also conform to captilization
    ; checksum encoding specified in EIP-55
    ; where applicable (EOAs).

statement = *( reserved / unreserved / " " )
    ; See RFC 3986 for the definition
    ; of "reserved" and "unreserved".
    ; The purpose is to exclude LF (line break).

uri = URI
    ; See RFC 3986 for the definition of "URI".

version = "1"

chain-id = 1*DIGIT
    ; See EIP-155 for valid CHAIN_IDs.

nonce = 8*( ALPHA / DIGIT )
    ; See RFC 5234 for the definition
    ; of "ALPHA" and "DIGIT".

issued-at = date-time
expiration-time = date-time
not-before = date-time
    ; See RFC 3339 (ISO 8601) for the
    ; definition of "date-time".

request-id = *pchar
    ; See RFC 3986 for the definition of "pchar".

resources = *( LF resource )

resource = "- " URI

</code></pre>
<p>This specification defines the following SIWE Message fields that can
be parsed from a SIWE Message by following the rules in ABNF Message
Format:</p>
<ul>
<li>
<p><code>scheme</code> OPTIONAL. The URI scheme of the origin of the request.
Its value MUST be a
<a href="https://datatracker.ietf.org/doc/htmlrfc3986">RFC 3986</a>
URI scheme.</p>
</li>
<li>
<p><code>domain</code> REQUIRED.
The domain that is requesting the signing.
Its value MUST be a <a href="https://datatracker.ietf.org/doc/html/rfc3986">RFC 3986</a>
authority. The authority includes an OPTIONAL port.
If the port is not specified, the default
port for the provided scheme is assumed.</p>
</li>
</ul>
<p>If scheme is not specified, HTTPS is assumed by default.</p>
<ul>
<li>
<p><code>address</code> REQUIRED. The Ethereum address performing the signing.
Its value SHOULD be conformant to mixed-case checksum address encoding
specified in ERC-55 where applicable.</p>
</li>
<li>
<p><code>statement</code> OPTIONAL. A human-readable ASCII assertion that the user
will sign which MUST NOT include '\n' (the byte 0x0a).</p>
</li>
<li>
<p><code>uri</code> REQUIRED. An
<a href="https://datatracker.ietf.org/doc/htmlrfc3986">RFC 3986</a>
URI referring to the resource that is the subject of the
signing.</p>
</li>
<li>
<p><code>version</code> REQUIRED. The current version of the SIWE Message, which
MUST be 1 for this specification.</p>
</li>
<li>
<p><code>chain-id</code> REQUIRED. The EIP-155 Chain ID to which the session is
bound, and the network where Contract Accounts MUST be resolved.</p>
</li>
<li>
<p><code>nonce</code> REQUIRED. A random string (minimum 8 alphanumeric characters)
chosen by the relying party and used to prevent replay attacks.</p>
</li>
<li>
<p><code>issued-at</code> REQUIRED. The time when the message was generated,
typically the current time.</p>
</li>
</ul>
<p>Its value MUST be an ISO 8601 datetime string.</p>
<ul>
<li><code>expiration-time</code> OPTIONAL. The time when the signed authentication
message is no longer valid.</li>
</ul>
<p>Its value MUST be an ISO 8601 datetime string.</p>
<ul>
<li><code>not-before</code> OPTIONAL. The time when the signed authentication
message will become valid.</li>
</ul>
<p>Its value MUST be an ISO 8601 datetime string.</p>
<ul>
<li>
<p><code>request-id</code> OPTIONAL. An system-specific identifier that MAY be used
to uniquely refer to the sign-in request.</p>
</li>
<li>
<p><code>resources</code> OPTIONAL. A list of information or references to
information the user wishes to have resolved as part of authentication
by the relying party.</p>
</li>
</ul>
<p>Every resource MUST be a RFC 3986 URI separated by "\n- " where \n is
the byte 0x0a.</p>
<h4 id="signing-and-verifying-messages-with-ethereum-accounts-1"><a class="header" href="#signing-and-verifying-messages-with-ethereum-accounts-1">Signing and Verifying Messages with Ethereum Accounts</a></h4>
<ul>
<li>
<p>For Externally Owned Accounts, the verification method specified in
<a href="https://eips.ethereum.org/EIPS/eip-191">ERC-191</a>
MUST be used.</p>
</li>
<li>
<p>For Contract Accounts,</p>
<ul>
<li>
<p>The verification method specified in
<a href="https://eips.ethereum.org/EIPS/eip-1271">ERC-1271</a>
SHOULD be used.
Otherwise, the implementer MUST clearly define the
verification method
to attain security and interoperability for both
wallets and relying parties.</p>
</li>
<li>
<p>When performing <a href="https://eips.ethereum.org/EIPS/eip-1271">ERC-1271</a>
signature verification, the contract performing the verification MUST
be resolved from the specified <code>chain-id</code>.</p>
</li>
<li>
<p>Implementers SHOULD take into consideration that [ERC-1271
(https://eips.ethereum.org/EIPS/eip-1271) implementations are not
required to be pure functions.
They can return different results for the same inputs depending on
blockchain state.
This can affect the security model and session validation rules.</p>
</li>
</ul>
</li>
</ul>
<h4 id="resolving-ethereum-name-service-ens-data-1"><a class="header" href="#resolving-ethereum-name-service-ens-data-1">Resolving Ethereum Name Service (ENS) Data</a></h4>
<ul>
<li>
<p>The relying party or wallet MAY additionally perform resolution of
ENS data, as this can improve the user experience by displaying human
friendly information that is related to the <code>address</code>.
Resolvable ENS data include:</p>
<ul>
<li>The primary ENS name.</li>
<li>The ENS avatar.</li>
<li>Any other resolvable resources specified in the ENS documentation.</li>
</ul>
</li>
<li>
<p>If resolution of ENS data is performed, implementers SHOULD take
precautions to preserve user privacy and consent.
Their <code>address</code> could be forwarded to third party services as part of
the resolution process.</p>
</li>
</ul>
<h4 id="implementer-steps-specifying-the-request-origin-1"><a class="header" href="#implementer-steps-specifying-the-request-origin-1">Implementer steps: specifying the request origin</a></h4>
<p>The <code>domain</code> and, if present, the <code>scheme</code>, in the SIWE Message MUST
correspond to the origin from where the signing request was made.</p>
<h4 id="implementer-steps-verifying-a-signed-message-1"><a class="header" href="#implementer-steps-verifying-a-signed-message-1">Implementer steps: verifying a signed message</a></h4>
<p>The SIWE Message MUST be checked for conformance to the ABNF Message
Format and its signature MUST be checked as defined in Signing and
Verifying Messages with Ethereum Accounts.</p>
<h4 id="implementer-steps-creating-sessions-1"><a class="header" href="#implementer-steps-creating-sessions-1">Implementer steps: creating sessions</a></h4>
<p>Sessions MUST be bound to the address and not to further resolved
resources that can change.</p>
<h4 id="implementer-steps-interpreting-and-resolving-resources-1"><a class="header" href="#implementer-steps-interpreting-and-resolving-resources-1">Implementer steps: interpreting and resolving resources</a></h4>
<p>Implementers SHOULD ensure that that URIs in the listed resources are
human-friendly when expressed in plaintext form.</p>
<h4 id="wallet-implementer-steps-verifying-the-message-format-1"><a class="header" href="#wallet-implementer-steps-verifying-the-message-format-1">Wallet implementer steps: verifying the message format</a></h4>
<p>The full SIWE message MUST be checked for conformance to the ABNF
defined in ABNF Message Format.</p>
<p>Wallet implementers SHOULD warn users if the substring <code>"wants you to sign in with your Ethereum account"</code> appears anywhere in an [ERC-191
(https://eips.ethereum.org/EIPS/eip-191) message signing request unless
the message fully conforms to the format defined ABNF Message Format.</p>
<h4 id="wallet-implementer-steps-verifying-the-request-origin-1"><a class="header" href="#wallet-implementer-steps-verifying-the-request-origin-1">Wallet implementer steps: verifying the request origin</a></h4>
<p>Wallet implementers MUST prevent phishing attacks by verifying the
origin of the request against the <code>scheme</code> and <code>domain</code> fields in the
SIWE Message.</p>
<p>The origin SHOULD be read from a trusted data source such as the
browser window or over WalletConnect
<a href="https://eips.ethereum.org/EIPS/eip-1328">ERC-1328</a> sessions for
comparison against the
signing message contents.</p>
<p>Wallet implementers MAY warn instead of rejecting the verification if
the origin is pointing to localhost.</p>
<p>The following is a RECOMMENDED algorithm for Wallets to conform with
the requirements on request origin verification defined by this
specification.</p>
<p>The algorithm takes the following input variables:</p>
<ul>
<li>fields from the SIWE message.</li>
<li><code>origin</code> of the signing request: the origin of the page which
requested the signin via the provider.</li>
<li><code>allowedSchemes</code>: a list of schemes allowed by the Wallet.</li>
<li><code>defaultScheme</code>: a scheme to assume when none was provided. Wallet
implementers in the browser SHOULD use https.</li>
<li>developer mode indication: a setting deciding if certain risks should
be a warning instead of rejection. Can be manually configured or
derived from <code>origin</code> being localhost.</li>
</ul>
<p>The algorithm is described as follows:</p>
<ul>
<li>If <code>scheme</code> was not provided, then assign <code>defaultScheme</code> as scheme.</li>
<li>If <code>scheme</code> is not contained in <code>allowedSchemes</code>, then the <code>scheme</code>
is not expected and the Wallet MUST reject the request.
Wallet implementers in the browser SHOULD limit the list of
allowedSchemes to just 'https' unless a developer mode is activated.</li>
<li>If <code>scheme</code> does not match the scheme of origin, the Wallet SHOULD
reject the request.
Wallet implementers MAY show a warning instead of rejecting the request
if a developer mode is activated.
In that case the Wallet continues processing the request.</li>
<li>If the <code>host</code> part of the <code>domain</code> and <code>origin</code> do not match, the
Wallet MUST reject the request unless the Wallet is in developer mode.
In developer mode the Wallet MAY show a warning instead and continues
procesing the request.</li>
<li>If <code>domain</code> and <code>origin</code> have mismatching subdomains, the Wallet
SHOULD reject the request unless the Wallet is in developer mode.
In developer mode the Wallet MAY show a warning instead and continues
procesing the request.</li>
<li>Let <code>port</code> be the port component of <code>domain</code>, and if no port is
contained in domain, assign port the default port specified for the
scheme.</li>
<li>If <code>port</code> is not empty, then the Wallet SHOULD show a warning if the
<code>port</code> does not match the port of <code>origin</code>.</li>
<li>If <code>port</code> is empty, then the Wallet MAY show a warning if <code>origin</code>
contains a specific port.</li>
<li>Return request origin verification completed.</li>
</ul>
<h4 id="wallet-implementer-steps-creating-siwe-interfaces-1"><a class="header" href="#wallet-implementer-steps-creating-siwe-interfaces-1">Wallet implementer steps: creating SIWE interfaces</a></h4>
<p>Wallet implementers MUST display to the user the following fields from
the SIWE Message request by default and prior to signing, if they are
present: <code>scheme</code>, <code>domain</code>, <code>address</code>, <code>statement</code>, and <code>resources</code>.
Other present fields MUST also be made available to the user prior to
signing either by default or through an extended interface.</p>
<p>Wallet implementers displaying a plaintext SIWE Message to the user
SHOULD require the user to scroll to the bottom of the text area prior
to signing.</p>
<p>Wallet implementers MAY construct a custom SIWE user interface by
parsing the ABNF terms into data elements for use in the interface.
The display rules above still apply to custom interfaces.</p>
<h4 id="wallet-implementer-steps-supporting-internationalization-i18n-1"><a class="header" href="#wallet-implementer-steps-supporting-internationalization-i18n-1">Wallet implementer steps: supporting internationalization (i18n)</a></h4>
<p>After successfully parsing the message into ABNF terms, translation MAY
happen at the UX level per human language.</p>
<h2 id="privacy-and-security-considerations-1"><a class="header" href="#privacy-and-security-considerations-1">Privacy and Security Considerations</a></h2>
<ul>
<li>The double ratchet "recommends" using AES in CBC mode. Since
encryption must be with an AEAD encryption scheme, we will use AES in
GCM mode instead (supported by Noise).</li>
<li>For the information retrieval, the algorithm MUST include a access
control mechanisms to restrict who can call the set and get functions.</li>
<li>One SHOULD include event logs to track changes in public keys.</li>
<li>The curve vurve448 MUST be chosen due to its higher security level:
224-bit security instead of the 128-bit security provided by X25519.</li>
<li>It is important that Bob MUST NOT reuse <code>SPK</code>.</li>
</ul>
<h2 id="considerations-related-to-the-use-of-ethereum-addresses"><a class="header" href="#considerations-related-to-the-use-of-ethereum-addresses">Considerations related to the use of Ethereum addresses</a></h2>
<h3 id="with-respect-to-the-authentication-service"><a class="header" href="#with-respect-to-the-authentication-service">With respect to the Authentication Service</a></h3>
<ul>
<li>If users used their Ethereum addresses as identifiers, they MUST
generate their own credentials.
These credentials MUST use the digital signature key pair associated to
the Ethereum address.</li>
<li>Other users can verify credentials.</li>
<li>With this approach, there is no need to have a dedicated
Authentication Service responsible for the issuance and verification of
credentials.</li>
<li>The interaction diagram showing the generation of credentials becomes
obsolete.</li>
</ul>
<h3 id="with-respect-to-the-delivery-service"><a class="header" href="#with-respect-to-the-delivery-service">With respect to the Delivery Service</a></h3>
<ul>
<li>Users MUST generate their own KeyPackage.</li>
<li>Other users can verify KeyPackages when required.</li>
<li>A Delivery Service storage system MUST verify KeyPackages before
storing them.</li>
<li>Interaction diagrams involving the DS do not change.</li>
</ul>
<h2 id="consideration-related-to-the-onchain-component-of-the-protocol"><a class="header" href="#consideration-related-to-the-onchain-component-of-the-protocol">Consideration related to the onchain component of the protocol</a></h2>
<h3 id="assumptions-3"><a class="header" href="#assumptions-3">Assumptions</a></h3>
<ul>
<li>Users have set a secure 1-1 communication channel.</li>
<li>Each group is managed by a separate smart contract.</li>
</ul>
<h3 id="addition-of-members-to-a-group-1"><a class="header" href="#addition-of-members-to-a-group-1">Addition of members to a group</a></h3>
<h4 id="alice-knows-bobs-ethereum-address"><a class="header" href="#alice-knows-bobs-ethereum-address">Alice knows Bob’s Ethereum address</a></h4>
<ol>
<li>Off-chain - Alice and Bob set a secure communication channel.</li>
<li>Alice creates the smart contract associated to the group. This smart
contract MUST include an ACL.</li>
<li>Alice adds Bob’s Ethereum address to the ACL.</li>
<li>Off-chain - Alice sends a request to join the group to Bob. The
request MUST include the contract’s address: <code>RequestMLSPayload {"You are joining the group with smart contract: 0xabcd"}</code></li>
<li>Off-chain - Bob responds the request with a digitally signed
response. This response includes Bob’s credentials and key package:
<code>ResponseMLSPayload {sig: signature(ethereum_sk, message_to_sign), address: ethereum_address, credentials, keypackage}</code></li>
<li>Off-chain - Alice verifies the signature, using Bob’s <code>ethereum_pk</code>
and checks that it corresponds to an address contained in the ACL.</li>
<li>Off-chain - Alice sends a welcome message to Bob.</li>
<li>Off-chain - Alice SHOULD broadcasts a message announcing the
addition of Bob to other users of the group.
<img src="vac/raw/deleted//vac/raw/images/eth-secpm_onchain-register-1.png" alt="figure7" /></li>
</ol>
<h4 id="alice-does-not-know-bobs-ethereum-address"><a class="header" href="#alice-does-not-know-bobs-ethereum-address">Alice does not know Bob’s Ethereum address</a></h4>
<ol>
<li>Off-chain - Alice and Bob set a secure communication channel.</li>
<li>Alice creates the smart contract associated to the group.
This smart contract MUST include an ACL.</li>
<li>Off-chain - Alice sends a request to join the group to Bob. The
request MUST include the contract’s address:
<code>RequestMLSPayload{"You are joining the group with smart contract: 0xabcd"}</code></li>
<li>Off-chain - Bob responds the request with a digitally signed
response. This response includes Bob’s credentials, his Ethereum
address and key package: <code>ResponseMLSPayload {sig: signature(ethereum_sk, message_to_sign), address: ethereum_address, credentials, keypackage}</code></li>
<li>Off-chain - Alice verifies the signature using Bob’s <code>ethereum_pk</code>.</li>
<li>Upon reception of Bob’s data, Alice registers data with the smart
contract.</li>
<li>Off-chain - Alice sends a welcome message to Bob.</li>
<li>Off-chain - Alice SHOULD broadcasts a message announcing the
addition of Bob to other users of the group.</li>
</ol>
<p><img src="vac/raw/deleted//vac/raw/images/eth-secpm_onchain-register-2.png" alt="figure8" /></p>
<h3 id="considerations-regarding-smart-contracts"><a class="header" href="#considerations-regarding-smart-contracts">Considerations regarding smart contracts</a></h3>
<p>The role of the smart contract includes:</p>
<ul>
<li>Register user information and key packages:
As described in the previous section.</li>
<li>Updates of key material.
<ul>
<li>Users MUST send any update in their key material to the other
users of the group via off-chain messages.</li>
<li>Upon reception of the new key material, the creator of the
contract MUST update the state of the smart contract.</li>
</ul>
</li>
<li>Deletion of users.
<ul>
<li>Any user can submit a proposal for the removal of a user via
off-chain message.</li>
<li>This proposal MUST be sent to the creator of the contract.</li>
<li>The creator of the contract MUST update the ACL, and send
messages to the group for key update.</li>
</ul>
</li>
</ul>
<p><img src="vac/raw/deleted//vac/raw/images/eth-secpm_onchain-update.png" alt="figure9" /></p>
<blockquote>
<p>It is important to note that both
user removal and updates of any kind
have a similar interaction flow.</p>
</blockquote>
<ul>
<li>Queries of existing users.
<ul>
<li>Any user can query the smart contract to know the state of the
group, including existing users and removed ones.</li>
<li>This aspect MUST be used when adding new members to verify that
the prospective key package has not been already used.</li>
</ul>
</li>
</ul>
<h2 id="copyright-8"><a class="header" href="#copyright-8">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-5"><a class="header" href="#references-5">References</a></h2>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc5234">Augmented BNF for Syntax Specifications</a></li>
<li><a href="https://github.com/libp2p/specs/tree/master/pubsub/gossipsub">Gossipsub</a></li>
<li><a href="https://www.ietf.org/rfc/rfc5869.txt">HMAC-based Extract-and-Expand Key Derivation Function</a></li>
<li><a href="https://datatracker.ietf.org/doc/rfc9180/">Hybrid Public Key Encryption</a></li>
<li><a href="https://eprint.iacr.org/2019/1189.pdf">Security Analysis and Improvements for the IETF MLS Standard for Group Messaging</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-191">Signed Data Standard</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-4361">Sign-In with Ethereum</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-1271">Standard Signature Validation Method for Contracts</a></li>
<li><a href="https://signal.org/docs/specifications/doubleratchet/">The Double Ratchet Algorithm</a></li>
<li><a href="https://datatracker.ietf.org/doc/rfc9420/">The Messaging Layer Security Protocol</a></li>
<li><a href="https://signal.org/docs/specifications/x3dh/">The X3DH Key Agreement Protocol</a></li>
<li><a href="https://rfc.vac.dev/spec/20/">Toy Ethereum Private Messaging Protocol</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc3986">Uniform Resource Identifier</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-1328">WalletConnect URI Format</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gossipsub-tor-push"><a class="header" href="#gossipsub-tor-push">GOSSIPSUB-TOR-PUSH</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Gossipsub Tor Push</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Daniel Kaiser &lt;danielkaiser@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-11"><a class="header" href="#timeline-11">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/raw/gossipsub-tor-push.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/raw/gossipsub-tor-push.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/vac/raw/gossipsub-tor-push.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-05-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/99be3b974509ea03561c7ef4b1b02a56f24e9297/vac/raw/gossipsub-tor-push.md"><code>99be3b9</code></a> — Move Raw Specs (#37)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/cd8c9f45f4d3eb0d8275fbaad378a42370c5b9a6/vac/46/gossipsub-tor-push.md"><code>cd8c9f4</code></a> — Update and rename GOSSIPSUB-TOR-PUSH.md to gossipsub-tor-push.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/0db60c18c18cfd2373204083cf4a1f5f3b8845dd/vac/46/GOSSIPSUB-TOR-PUSH.md"><code>0db60c1</code></a> — Create GOSSIPSUB-TOR-PUSH.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-4"><a class="header" href="#abstract-4">Abstract</a></h2>
<p>This document extends the <a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/README.md">libp2p gossipsub specification</a>
specifying gossipsub Tor Push,
a gossipsub-internal way of pushing messages into a gossipsub network via Tor.
Tor Push adds sender identity protection to gossipsub.</p>
<p><strong>Protocol identifier</strong>: /meshsub/1.1.0</p>
<p>Note: Gossipsub Tor Push does not have a dedicated protocol identifier.
It uses the same identifier as gossipsub and
works with all <a href="https://github.com/libp2p/specs/tree/master/pubsub">pubsub</a>
based protocols.
This allows nodes that are oblivious to Tor Push to process messages received via
Tor Push.</p>
<h2 id="background-1"><a class="header" href="#background-1">Background</a></h2>
<p>Without extensions, <a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/README.md">libp2p gossipsub</a>
does not protect sender identities.</p>
<p>A possible design of an anonymity extension to gossipsub
is pushing messages through an anonymization network
before they enter the gossipsub network.
<a href="https://www.torproject.org/">Tor</a> is currently the largest anonymization network.
It is well researched and works reliably.
Basing our solution on Tor both inherits existing security research,
as well as allows for a quick deployment.</p>
<p>Using the anonymization network approach,
even the first gossipsub node that relays a given message
cannot link the message to its sender
(within a relatively strong adversarial model).
Taking the low bandwidth overhead and the low latency overhead into consideration,
Tor offers very good anonymity properties.</p>
<h2 id="functional-operation"><a class="header" href="#functional-operation">Functional Operation</a></h2>
<p>Tor Push allows nodes to push messages over Tor into the gossipsub network.
The approach specified in this document is fully backwards compatible.
Gossipsub nodes that do not support Tor Push can receive and relay Tor Push messages,
because Tor Push uses the same Protocol ID as gossipsub.</p>
<p>Messages are sent over Tor via <a href="https://www.rfc-editor.org/rfc/rfc1928">SOCKS5</a>.
Tor Push uses a dedicated libp2p context to prevent information leakage.
To significantly increase resilience and mitigate circuit failures,
Tor Push establishes several connections,
each to a different randomly selected gossipsub node.</p>
<h2 id="specification"><a class="header" href="#specification">Specification</a></h2>
<p>This section specifies the format of Tor Push messages,
as well as how Tor Push messages are received and sent, respectively.</p>
<h3 id="wire-format"><a class="header" href="#wire-format">Wire Format</a></h3>
<p>The wire format of a Tor Push message corresponds verbatim to a typical
<a href="https://github.com/libp2p/specs/tree/master/pubsub#the-message">libp2p pubsub message</a>.</p>
<pre><code class="language-protobuf">message Message {
  optional string from = 1;
  optional bytes data = 2;
  optional bytes seqno = 3;
  required string topic = 4;
  optional bytes signature = 5;
  optional bytes key = 6;
}
</code></pre>
<h3 id="receiving-tor-push-messages"><a class="header" href="#receiving-tor-push-messages">Receiving Tor Push Messages</a></h3>
<p>Any node supporting a protocol with ID <code>/meshsub/1.1.0</code> (e.g. gossipsub),
can receive Tor Push messages.
Receiving nodes are oblivious to Tor Push and
will process incoming messages according to the respective <code>meshsub/1.1.0</code> specification.</p>
<h3 id="sending-tor-push-messages"><a class="header" href="#sending-tor-push-messages">Sending Tor Push Messages</a></h3>
<p>In the following, we refer to nodes sending Tor Push messages as Tp-nodes
(Tor Push nodes).</p>
<p>Tp-nodes MUST setup a separate libp2p context, i.e. <a href="https://docs.libp2p.io/concepts/multiplex/switch/">libp2p switch</a>,
which MUST NOT be used for any purpose other than Tor Push.
We refer to this context as Tp-context.
The Tp-context MUST NOT share any data, e.g. peer lists, with the default context.</p>
<p>Tp-peers are peers a Tp-node plans to send Tp-messages to.
Tp-peers MUST support <code>/meshsub/1.1.0</code>.
For retrieving Tp-peers,
Tp-nodes SHOULD use an ambient peer discovery method
that retrieves a random peer sample (from the set of all peers),
e.g. <a href="vac/raw/../../waku/standards/core/33/discv5.html">33/WAKU2-DISCV5</a>.</p>
<p>Tp-nodes MUST establish a connection as described in sub-section
<a href="vac/raw/gossipsub-tor-push.html#connection-establishment">Tor Push Connection Establishment</a> to at least one Tp-peer.
To significantly increase resilience,
Tp-nodes SHOULD establish Tp-connections to <code>D</code> peers,
where <code>D</code> is the <a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.0.md#parameters">desired gossipsub out-degree</a>,
with a default value of <code>8</code>.</p>
<p>Each Tp-message MUST be sent via the Tp-context over at least one Tp-connection.
To increase resilience,
Tp-messages SHOULD be sent via the Tp-context over all available Tp-connections.</p>
<p>Control messages of any kind, e.g. gossipsub graft, MUST NOT be sent via Tor Push.</p>
<h4 id="connection-establishment"><a class="header" href="#connection-establishment">Connection Establishment</a></h4>
<p>Tp-nodes establish a <code>/meshsub/1.1.0</code> connection to tp-peers via
<a href="https://www.rfc-editor.org/rfc/rfc1928">SOCKS5</a> over <a href="https://www.torproject.org/">Tor</a>.</p>
<p>Establishing connections, which in turn establishes the respective Tor circuits,
can be done ahead of time.</p>
<h4 id="epochs"><a class="header" href="#epochs">Epochs</a></h4>
<p>Tor Push introduces epochs.
The default epoch duration is 10 minutes.
(We might adjust this default value based on experiments and
evaluation in future versions of this document.
It seems a good trade-off between traceablity and circuit building overhead.)</p>
<p>For each epoch, the Tp-context SHOULD be refreshed, which includes</p>
<ul>
<li>libp2p peer-ID</li>
<li>Tp-peer list</li>
<li>connections to Tp-peers</li>
</ul>
<p>Both Tp-peer selection for the next epoch and
establishing connections to the newly selected peers
SHOULD be done during the current epoch
and be completed before the new epoch starts.
This avoids adding latency to message transmission.</p>
<h2 id="securityprivacy-considerations"><a class="header" href="#securityprivacy-considerations">Security/Privacy Considerations</a></h2>
<h3 id="fingerprinting-attacks"><a class="header" href="#fingerprinting-attacks">Fingerprinting Attacks</a></h3>
<p>Protocols that feature distinct patterns are prone to fingerprinting attacks
when using them over Tor Push.
Both malicious guards and exit nodes could detect these patterns
and link the sender and receiver, respectively, to transmitted traffic.
As a mitigation, such protocols can introduce dummy messages and/or
padding to hide patterns.</p>
<h3 id="dos"><a class="header" href="#dos">DoS</a></h3>
<h4 id="general-dos-against-tor"><a class="header" href="#general-dos-against-tor">General DoS against Tor</a></h4>
<p>Using untargeted DoS to prevent Tor Push messages
from entering the gossipsub network would cost vast resources,
because Tor Push transmits messages over several circuits and
the Tor network is well established.</p>
<h4 id="targeting-the-guard"><a class="header" href="#targeting-the-guard">Targeting the Guard</a></h4>
<p>Denying the service of a specific guard node
blocks Tp-nodes using the respective guard.
Tor guard selection will replace this guard [TODO elaborate].
Still, messages might be delayed during this window
which might be critical to certain applications.</p>
<h4 id="targeting-the-gossipsub-network"><a class="header" href="#targeting-the-gossipsub-network">Targeting the Gossipsub Network</a></h4>
<p>Without sophisticated rate limiting (for example using <a href="vac/raw/../../waku/standards/core/17/rln-relay.html">17/WAKU2-RLN-RELAY</a>),
attackers can spam the gossipsub network.
It is not enough to just block peers that send too many messages,
because these messages might actually come from a Tor exit node
that many honest Tp-nodes use.
Without Tor Push,
protocols on top of gossipsub could block peers
if they exceed a certain message rate.
With Tor Push, this would allow the reputation-based DoS attack described in
<a href="https://ieeexplore.ieee.org/abstract/document/7163022">Bitcoin over Tor isn't a Good Idea</a>.</p>
<h4 id="peer-discovery"><a class="header" href="#peer-discovery">Peer Discovery</a></h4>
<p>The discovery mechanism could be abused to link requesting nodes
to their Tor connections to discovered nodes.
An attacker that controls both the node that responds to a discovery query,
and the node who’s ENR the response contains,
can link the requester to a Tor connection
that is expected to be opened to the node represented by the returned ENR soon after.</p>
<p>Further, the discovery mechanism (e.g. discv5)
could be abused to distribute disproportionately many malicious nodes.
For instance if p% of the nodes in the network are malicious,
an attacker could manipulate the discovery to return malicious nodes with 2p% probability.
The discovery mechanism needs to be resilient against this attack.</p>
<h3 id="roll-out-phase"><a class="header" href="#roll-out-phase">Roll-out Phase</a></h3>
<p>During the roll-out phase of Tor Push, during which only a few nodes use Tor Push,
attackers can narrow down the senders of Tor messages
to the set of gossipsub nodes that do not originate messages.
Nodes who want anonymity guarantees even during the roll-out phase
can use separate network interfaces for their default context and
Tp-context, respectively.
For the best protection, these contexts should run on separate physical machines.</p>
<h2 id="copyright-9"><a class="header" href="#copyright-9">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-6"><a class="header" href="#references-6">References</a></h2>
<ul>
<li><a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/README.md">libp2p gossipsub</a></li>
<li><a href="https://github.com/libp2p/specs/tree/master/pubsub">libp2p pubsub</a></li>
<li><a href="https://github.com/libp2p/specs/tree/master/pubsub#the-message">libp2p pubsub message</a></li>
<li><a href="https://docs.libp2p.io/concepts/multiplex/switch">libp2p switch</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc1928">SOCKS5</a></li>
<li><a href="https://www.torproject.org/">Tor</a></li>
<li><a href="vac/raw/../../waku/standards/core/33/discv5.html">33/WAKU2-DISCV5</a></li>
<li><a href="https://ieeexplore.ieee.org/abstract/document/7163022">Bitcoin over Tor isn't a Good Idea</a></li>
<li><a href="vac/raw/../../waku/standards/core/17/rln-relay.html">17/WAKU2-RLN-RELAY</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="logos-capability-discovery"><a class="header" href="#logos-capability-discovery">LOGOS-CAPABILITY-DISCOVERY</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Logos Capability Discovery Protocol</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Arunima Chaudhuri [arunima@status.im](mailto:arunima@status.im)</td></tr>
<tr><th>Contributors</th><td>U<br>g<br>u<br>r<br> <br>S<br>e<br>n<br> <br>[<br>u<br>g<br>u<br>r<br>@<br>s<br>t<br>a<br>t<br>u<br>s<br>.<br>i<br>m<br>]<br>(<br>m<br>a<br>i<br>l<br>t<br>o<br>:<br>u<br>g<br>u<br>r<br>@<br>s<br>t<br>a<br>t<br>u<br>s<br>.<br>i<br>m<br>)</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-12"><a class="header" href="#timeline-12">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/raw/logos-capability-discovery.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/raw/logos-capability-discovery.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-12-09</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/aaf158aa59edb2ce0841a345725d16355218c196/vac/raw/logos-capability-discovery.md"><code>aaf158a</code></a> — VAC/RAW/LOGOS-DISCOVERY-CAPABILITY RFC  (#212)</li>
</ul>
<!-- timeline:end -->
<blockquote>
<p><strong>Note:</strong> This specification is currently a WIP and undergoing a high rate of changes.</p>
</blockquote>
<h2 id="abstract-5"><a class="header" href="#abstract-5">Abstract</a></h2>
<p>This RFC defines the Logos Capability Discovery protocol,
a discovery mechanism inspired by <a href="https://ieeexplore.ieee.org/document/10629017">DISC-NG service discovery</a>
built on top of <a href="https://github.com/libp2p/specs/tree/7740c076350b6636b868a9e4a411280eea34d335/kad-dht">Kad-dht</a>.</p>
<p>The protocol enables nodes to:</p>
<ul>
<li>Advertise their participation in specific services</li>
<li>Efficiently discover other peers participating in those services</li>
</ul>
<p>In this RFC, the terms "capability" and "service" are used interchangeably.
Within Logos, a node’s “capabilities” map directly to
the “services” it participates in.
Similarly, "peer" and "node" refer to the same entity:
a participant in the Logos Discovery network.</p>
<p>Logos discovery extends Kad-dht toward a multi-service, resilient discovery layer,
enhancing reliability while maintaining compatibility with existing Kad-dht behavior.
For everything else that isn't explicitly stated herein,
it is safe to assume behaviour similar to Kad-dht.</p>
<h2 id="motivation-7"><a class="header" href="#motivation-7">Motivation</a></h2>
<p>In decentralized networks supporting multiple services,
efficient peer discovery for specific services is critical.
Traditional approaches face several challenges:</p>
<ul>
<li>Inefficiency: Random-walk–based discovery is inefficient for unpopular services.</li>
<li>Load imbalance: A naive approach where nodes advertise their service at DHT peers
whose IDs are closest to the service ID
leads to hotspots and overload at popular services.</li>
<li>Scalability: Discovery must scale logarithmically across many distinct services.</li>
</ul>
<p>Logos discovery addresses these through:</p>
<ul>
<li>Service-specific routing tables</li>
<li>Adaptive advertisement placement with admission control</li>
<li>Improved lookup operations balancing efficiency and resilience</li>
</ul>
<h2 id="format-specification-2"><a class="header" href="#format-specification-2">Format Specification</a></h2>
<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”,
“SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL” in this document
are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">2119</a>.</p>
<h2 id="protocol-roles"><a class="header" href="#protocol-roles">Protocol Roles</a></h2>
<p>The Logos capability discovery protocol defines three roles that nodes can perform:</p>
<h3 id="advertiser"><a class="header" href="#advertiser">Advertiser</a></h3>
<p><strong>Advertisers</strong> are nodes that participate in a service
and want to be discovered by other peers.</p>
<p>Responsibilities:</p>
<ul>
<li>Advertisers SHOULD register advertisements for their service across registrars</li>
<li>Advertisers SHOULD handle registration responses</li>
</ul>
<h3 id="discoverer"><a class="header" href="#discoverer">Discoverer</a></h3>
<p><strong>Discoverers</strong> are nodes attempting to find peers that provide a specific service.</p>
<p>Responsibilities:</p>
<ul>
<li>Discoverers SHOULD query registrars for advertisements of a service</li>
</ul>
<h3 id="registrar"><a class="header" href="#registrar">Registrar</a></h3>
<p><strong>Registrars</strong> are nodes that store and serve advertisements.</p>
<p>Responsibilities:</p>
<ul>
<li>Registrars MUST use a waiting time based admission control mechanism
to decide whether to store an advertisement coming from an advertiser or not.</li>
<li>Registrars SHOULD respond to query requests for advertisements coming from discoverers.</li>
</ul>
<h2 id="definitions-2"><a class="header" href="#definitions-2">Definitions</a></h2>
<h3 id="dht-routing-table"><a class="header" href="#dht-routing-table">DHT Routing Table</a></h3>
<p>Every participant in the kad-dht peer discovery layer
maintains the peer routing table <code>KadDHT(peerID)</code>.
It is a distributed key-value store with
<a href="https://github.com/libp2p/specs/blob/7740c076350b6636b868a9e4a411280eea34d335/peer-ids/peer-ids.md#peer-ids">peer IDs</a>
as key against their matching
<a href="https://github.com/libp2p/specs/blob/7740c076350b6636b868a9e4a411280eea34d335/RFC/0003-routing-records.md">signed peer records</a> values.
It is centered on the node's own <code>peerID</code>.</p>
<blockquote>
<p>“Centered on” means the table is organized using that ID as the reference point
for computing distances with other peers and assigning peers to buckets.</p>
</blockquote>
<h3 id="bucket"><a class="header" href="#bucket">Bucket</a></h3>
<p>Each table is organized into buckets.
A bucket is a container that stores information about peers
at a particular distance range from the center ID.</p>
<p>For simplicity in this RFC, we represent each bucket as a list of peer IDs.
However, in a full implementation, each entry in the bucket MUST store
a complete peer information necessary to enable communication.</p>
<p><strong>Bucket Size:</strong></p>
<p>The number of entries a bucket can hold is implementation-dependent.</p>
<ul>
<li>Smaller buckets → lower memory usage but reduced resilience to churn</li>
<li>Larger buckets →  better redundancy but increased maintenance overhead</li>
</ul>
<h3 id="service"><a class="header" href="#service">Service</a></h3>
<p>A service is a logical sub-network within the larger peer-to-peer network.
It represents a specific capability a node supports
— for example, a particular protocol or functionality it offers.
A service MUST be identified by a libp2p protocol ID via the
<a href="https://github.com/libp2p/specs/tree/7740c076350b6636b868a9e4a411280eea34d335/identify">identify protocol</a>.</p>
<h3 id="service-id"><a class="header" href="#service-id">Service ID</a></h3>
<p>The service ID <code>service_id_hash</code> MUST be the SHA-256 hash of the protocol ID.</p>
<p>For example:</p>
<div class="table-wrapper"><table><thead><tr><th>Service Identifier</th><th>Service ID</th></tr></thead><tbody>
<tr><td><code>/waku/store/1.0.0</code></td><td><code>313a14f48b3617b0ac87daabd61c1f1f1bf6a59126da455909b7b11155e0eb8e</code></td></tr>
<tr><td><code>/libp2p/mix/1.2.0</code></td><td><code>9c55878d86e575916b267195b34125336c83056dffc9a184069bcb126a78115d</code></td></tr>
</tbody></table>
</div>
<h3 id="advertisement-cache"><a class="header" href="#advertisement-cache">Advertisement Cache</a></h3>
<p>An advertisement cache <code>ad_cache</code> is a bounded storage structure
maintained by registrars to store accepted advertisements.</p>
<h3 id="advertise-table"><a class="header" href="#advertise-table">Advertise Table</a></h3>
<p>For every service it participates in, an advertiser node MUST maintain an
advertise table <code>AdvT(service_id_hash)</code> centered on <code>service_id_hash</code>.
The table MAY be initialized using
peers from the advertiser’s <code>KadDHT(peerID)</code> routing table.
It SHOULD be updated opportunistically through interactions with
registrars during the advertisement process.</p>
<p>Each bucket in the advertise table contains a list of registrar peers at a
particular XOR distance range from <code>service_id_hash</code>, which are candidates for placing
advertisements.</p>
<h3 id="search-table"><a class="header" href="#search-table">Search Table</a></h3>
<p>For every service it attempts to discover, a discoverer node MUST maintain a
search table <code>DiscT(service_id_hash)</code> centered on <code>service_id_hash</code>.
The table MAY be initialized using
peers from the discoverer’s<code>KadDHT(peerID)</code> routing table.
It SHOULD be updated through interactions with
registrars during lookup operations.</p>
<p>Each bucket in the search table contains a list of registrar peers at a
particular XOR distance range from <code>service_id_hash</code>, which discoverers can query to
retrieve advertisements for that service.</p>
<h3 id="registrar-table"><a class="header" href="#registrar-table">Registrar Table</a></h3>
<p>For every service for which it stores and serves advertisements,
a registrar node SHOULD maintain a registrar table <code>RegT(service_id_hash)</code>
centered on <code>service_id_hash</code>.
The table MAY be initialized using peers from the
registrar’s <code>KadDHT(peerID)</code> routing table.
It SHOULD be updated opportunistically
through interactions with advertisers and discoverers.</p>
<p>Each bucket in the registrar table contains a list of peer nodes
at a particular XOR distance range from <code>service_id_hash</code>.
Registrars use this table to return
<code>closerPeers</code> during <code>REGISTER</code> and <code>GET_ADS</code> responses,
enabling advertisers and discoverers to
refine their service-specific routing tables.</p>
<h3 id="address"><a class="header" href="#address">Address</a></h3>
<p>A <a href="https://github.com/libp2p/specs/tree/7740c076350b6636b868a9e4a411280eea34d335/addressing">multiaddress</a>
is a standardized way used in libp2p to represent network addresses.
Implementations SHOULD use multiaddresses for peer connectivity.
However, implementations MAY use alternative address representations if they:</p>
<ul>
<li>Remain interoperable</li>
<li>Convey sufficient information (IP + port) to establish connections</li>
</ul>
<h3 id="signature"><a class="header" href="#signature">Signature</a></h3>
<p>Refer to <a href="https://github.com/libp2p/specs/blob/7740c076350b6636b868a9e4a411280eea34d335/peer-ids/peer-ids.md">Peer Ids and Keys</a>
to know about supported signatures.
In the base Kad DHT specification, signatures are optional,
typically implemented as a PKI signature over the tuple <code>(key || value || author)</code>.
In this RFC digital signatures MUST be used to
authenticate advertisements and tickets.</p>
<h3 id="expiry-time-e"><a class="header" href="#expiry-time-e">Expiry Time <code>E</code></a></h3>
<p><code>E</code> is advertisement expiry time in seconds.
The expiry time <strong><code>E</code></strong> is a system wide parameter,
not an individual advertisement field or parameter of an individual registrar.</p>
<h2 id="data-structures"><a class="header" href="#data-structures">Data Structures</a></h2>
<h3 id="advertisement"><a class="header" href="#advertisement">Advertisement</a></h3>
<p>An <strong>advertisement</strong> is a data structure
indicating that a specific node participates in a service.
In this RFC we refer to advertisement objects as <code>ads</code>.
For a single advertisement object we use <code>ad</code>.</p>
<pre><code class="language-protobuf">message Advertisement {
    // Service identifier (32-byte SHA-256 hash)
    bytes service_id_hash = 1;

    // Peer ID of advertiser (32-byte hash of public key)
    bytes peerID = 2;

    // Multiaddrs of advertiser
    repeated bytes addrs = 3;

    // Ed25519 signature over (service_id_hash || peerID || addrs)
    bytes signature = 4;

    // Optional: Service-specific metadata
    optional bytes metadata = 5;

    // Unix timestamp in seconds
    uint64 timestamp = 6;
}
</code></pre>
<p>Advertisements MUST include <code>service_id_hash</code>, <code>peerID</code>, <code>addrs</code> and <code>signature</code> fields.
Advertisements MAY include <code>metadata</code> and <code>timestamp</code> fields.
The <code>signature</code> field MUST be a Ed25519 signature over the concatenation of
(<code>service_id_hash</code> || <code>peerID</code> || <code>addrs</code>).
Refer to <a href="vac/raw/logos-capability-discovery.html#signature">Signature</a> section for more details.
Implementations MUST verify this signature before accepting an advertisement.</p>
<h3 id="ticket"><a class="header" href="#ticket">Ticket</a></h3>
<p>Tickets are digitally signed objects
issued by registrars to advertisers to reliably indicate
how long an advertiser already waited for admission.</p>
<pre><code class="language-protobuf">message Ticket {
    // Copy of the original advertisement
    Advertisement ad = 1;

    // Ticket creation timestamp (Unix time in seconds)
    uint64 t_init = 2;

    // Last modification timestamp (Unix time in seconds)
    uint64 t_mod = 3;

    // Remaining wait time in seconds
    uint32 t_wait_for = 4;

    // Ed25519 signature over (ad || t_init || t_mod || t_wait_for)
    bytes signature = 5;
}
</code></pre>
<p>Tickets MUST include <code>ad</code>, <code>t_init</code>, <code>t_mod</code>, <code>t_wait_for</code> and <code>signature</code> fields.
The <code>signature</code> field MUST be an Ed25519 signature over the concatenation of
(<code>ad</code> || <code>t_init</code> || <code>t_mod</code> || <code>t_wait_for</code>).
Refer to <a href="vac/raw/logos-capability-discovery.html#signature">Signature</a> section for more details.
Implementations MUST verify this signature before accepting a ticket.</p>
<h2 id="protocol-specifications"><a class="header" href="#protocol-specifications">Protocol Specifications</a></h2>
<h3 id="system-parameters-1"><a class="header" href="#system-parameters-1">System Parameters</a></h3>
<p>The system parameters are derived directly from
the <a href="https://ieeexplore.ieee.org/document/10629017">DISC-NG paper</a>.
Implementations SHOULD modify them as needed based on specific requirements.</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th>Default Value</th><th>Description</th></tr></thead><tbody>
<tr><td><code>K_register</code></td><td>3</td><td>Max number of active (i.e. unexpired) registrations + ongoing registration attempts per bucket.</td></tr>
<tr><td><code>K_lookup</code></td><td>5</td><td>For each bucket in the search table, number of random registrar nodes queried by discoverers</td></tr>
<tr><td><code>F_lookup</code></td><td>30</td><td>number of advertisers to find in the lookup process. We stop lookup process when we have found these many advertisers</td></tr>
<tr><td><code>F_return</code></td><td>10</td><td>max number of service-specific peers returned from a single registrar</td></tr>
<tr><td><code>E</code></td><td>900 seconds</td><td>Advertisement expiry time (15 minutes)</td></tr>
<tr><td><code>C</code></td><td>1,000</td><td>Advertisement cache capacity</td></tr>
<tr><td><code>P_occ</code></td><td>10</td><td>Occupancy exponent for waiting time calculation</td></tr>
<tr><td><code>G</code></td><td>10⁻⁷</td><td>Safety parameter for waiting time calculation</td></tr>
<tr><td><code>δ</code></td><td>1 second</td><td>Registration window time</td></tr>
<tr><td><code>m</code></td><td>16</td><td>Number of buckets for advertise table, search table</td></tr>
</tbody></table>
</div>
<h3 id="distance"><a class="header" href="#distance">Distance</a></h3>
<p>The distance <code>d</code> between any two keys in Logos Capability Discovery
MUST be calculated using the bitwise XOR applied to their 256-bit SHA-256 representations.
This provides a deterministic, uniform, and symmetric way to measure proximity in the keyspace.
The keyspace is the entire numerical range of possible <code>peerID</code> and <code>service_id_hash</code>
— the 256-bit space in which all SHA-256–derived IDs exist.
XOR MUST be used to measure distances between them in the keyspace.</p>
<p>For every node in the network, the <code>peerID</code> is unique.
In this system, both <code>peerID</code> and the <code>service_id_hash</code> are 256-bit SHA-256 hashes.
Thus both belong to the same keyspace.</p>
<p>Advertise table <code>AdvT(service_id_hash)</code>, search table <code>DiscT(service_id_hash)</code>
and registrar table <code>RegT(service_id_hash)</code> MUST be centered on <code>service_id_hash</code>
while <code>KadDHT(peerID)</code> table is centered on <code>peerID</code>.</p>
<p>When inserting a node into <code>AdvT(service_id_hash)</code>, <code>DiscT(service_id_hash)</code> or <code>RegT(service_id_hash)</code>,
the bucket index into which the node will be inserted MUST be determined by:</p>
<ul>
<li>x = reference ID which is the <code>service_id_hash</code></li>
<li>y = target peer ID <code>peerID</code></li>
<li>L = 256 = bit length of IDs</li>
<li><code>m</code> = 16 = number of buckets in the advertise/search table</li>
<li><code>d = x ⊕ y = service_id_hash ⊕ peerID</code> = bitwise XOR distance (interpreted as an unsigned integer)</li>
</ul>
<p>The bucket index <code>i</code> where <code>y</code> is placed in <code>x</code>'s advertise/search table is:</p>
<ul>
<li>For <code>d &gt; 0</code>, <code>i = min( ⌊ (m / 256) * (256 − 1 − ⌊log₂(d)⌋) ⌋ , m − 1 )</code></li>
<li>For <code>d = 0</code>, <code>i = m - 1</code> which is the same ID case</li>
</ul>
<p>If we further simplify it, then:</p>
<ul>
<li>Let <code>lz = CLZ(d)</code> = number of leading zeros in the 256-bit representation of <code>d</code></li>
<li><code>i = min( ⌊ (lz * m) / 256 ⌋ , m − 1 )</code></li>
</ul>
<p>Lower-index buckets represent peers far away from <code>service_id_hash</code> in the keyspace,
while higher-index buckets contain peers closer to <code>service_id_hash</code>.
This property allows efficient logarithmic routing:
each hop moves to a peer that shares a longer prefix of bits
with the target <code>service_id_hash</code>.</p>
<p>This formula MUST also used when we bootstrap peers.
Bootstrapping MAY be done from the <code>KadDHT(peerID)</code> table.
For every peer present in the table from where we bootstrap,
we MUST use the same formula to place them in <code>AdvT(service_id_hash)</code>,
<code>DiscT(service_id_hash)</code> and <code>RegT(service_id_hash)</code> buckets.</p>
<p>Initially the density of peers in the search table <code>DiscT(service_id_hash)</code>
and advertise table <code>AdvT(service_id_hash)</code> around <code>service_id_hash</code> might be low or even null
particularly when <code>service_id_hash</code> and <code>peerID</code> are distant in the keyspace
(as <code>KadDHT(peerID)</code> is centered on <code>peerID</code>).
The buckets SHOULD be filled opportunistically
while interacting with peers during the search or advertisement process.
Registrars, apart from responding to queries,
SHOULD return a list of peers as <code>response.closerPeers</code> .
These peers SHOULD be added to buckets in <code>AdvT(service_id_hash)</code> and <code>DiscT(service_id_hash)</code>.
While adding peers implementations MUST use the same formula.</p>
<p><strong>Note:</strong></p>
<p>The <code>response.closerPeers</code> field returned by registrars SHOULD include
a list of peer information object which contains both peer IDs and addresses,
as the latter is required to contact peers.
In this RFC, we simplify representation by listing only peer IDs,
but full implementations SHOULD include address information.</p>
<h2 id="rpc-messages"><a class="header" href="#rpc-messages">RPC Messages</a></h2>
<p>All RPC messages MUST be sent using the libp2p Kad-dht message format
with new message types added for Logos discovery operations.</p>
<h3 id="message-types"><a class="header" href="#message-types">Message Types</a></h3>
<p>The following message types MUST be added to the Kad-dht <code>Message.MessageType</code> enum:</p>
<pre><code class="language-protobuf">enum MessageType {
    // ... existing Kad-dht message types ...
    REGISTER = 6;
    GET_ADS = 7;
}
</code></pre>
<h3 id="register-message"><a class="header" href="#register-message">REGISTER Message</a></h3>
<h4 id="register-request"><a class="header" href="#register-request">REGISTER Request</a></h4>
<p>Advertisers SHOULD send <code>REGISTER</code> request message to registrars
to admit the advertiser's advertisemnet for a service
into the registrar's <code>ad_cache</code>.</p>
<pre><code class="language-protobuf">message Message {
    MessageType type = 1;  // REGISTER
    bytes key = 2;         // service_id_hash
    Advertisement ad = 3;   // The advertisement to register
    optional Ticket ticket = 4;  // Optional: ticket from previous attempt
}
</code></pre>
<p>Advertisers SHOULD include the <code>service_id_hash</code> in the <code>key</code> field
and the advertisement in the <code>ad</code> field of the request.
If this is a retry attempt, advertisers SHOULD include
the latest <code>ticket</code> received from the registrar.</p>
<h4 id="register-response"><a class="header" href="#register-response">REGISTER Response</a></h4>
<p><code>REGISTER</code> response SHOULD be sent by registrars to advertisers.</p>
<pre><code class="language-protobuf">enum RegistrationStatus {
    CONFIRMED = 0;  // Advertisement accepted
    WAIT = 1;       // wait, ticket provided
    REJECTED = 2;   // Advertisement rejected
}

message Message {
    MessageType type = 1;       // REGISTER
    RegistrationStatus status = 2;
    optional Ticket ticket = 3;  // Provided if status = WAIT
    repeated Peer closerPeers = 4;  // Peers for populating advertise table
}
</code></pre>
<p>Registrars SHOULD set the <code>status</code> field to indicate the result of the registration attempt.
If <code>status</code> is <code>WAIT</code>, registrars MUST provide a valid <code>ticket</code>.
Registrars SHOULD include <code>closerPeers</code> to help populate the advertiser's table.</p>
<h3 id="get_ads-message"><a class="header" href="#get_ads-message">GET_ADS Message</a></h3>
<h4 id="get_ads-request"><a class="header" href="#get_ads-request">GET_ADS Request</a></h4>
<p>Discoverers send <code>GET_ADS</code> request message to registrars
to get advertisements for a particular service.</p>
<pre><code class="language-protobuf">message Message {
    MessageType type = 1;  // GET_ADS
    bytes key = 2;         // service_id_hash to look up
}
</code></pre>
<p>Discoverers SHOULD include the <code>service_id_hash</code> they are searching for in the <code>key</code> field.</p>
<h4 id="get_ads-response"><a class="header" href="#get_ads-response">GET_ADS Response</a></h4>
<p>Registrars SHOULD respond to discoverer's <code>GET_ADS</code> request
using the following response structure.</p>
<pre><code class="language-protobuf">message Message {
    MessageType type = 1;              // GET_ADS
    repeated Advertisement ads = 2;     // Up to F_return advertisements
    repeated Peer closerPeers = 3;     // Peers for populating search table
}
</code></pre>
<p>Registrars MUST return up to <code>F_return</code> advertisements for the requested service.
Registrars SHOULD include <code>closerPeers</code> to help populate the discoverer's search table.</p>
<h2 id="sequence-diagram"><a class="header" href="#sequence-diagram">Sequence Diagram</a></h2>
<p><img src="https://github.com/user-attachments/assets/d85fab17-c636-417a-afaf-c609aa53075d" alt="Sequence diagram" /></p>
<h2 id="advertisement-placement"><a class="header" href="#advertisement-placement">Advertisement Placement</a></h2>
<h3 id="overview"><a class="header" href="#overview">Overview</a></h3>
<p><code>ADVERTISE(service_id_hash)</code> lets advertisers publish itself
as a participant in a particular <code>service_id_hash</code> .</p>
<p>It spreads advertisements for its service across multiple registrars,
such that other peers can  find it efficiently.</p>
<h3 id="advertisement-algorithm"><a class="header" href="#advertisement-algorithm">Advertisement Algorithm</a></h3>
<p>Advertisers place advertisements across multiple registrars using the <code>ADVERTISE()</code> algorithm.
The advertisers run <code>ADVERTISE()</code> periodically.
Implementations may choose the interval based on their requirements.</p>
<pre><code class="language-text">procedure ADVERTISE(service_id_hash):
    ongoing ← MAP&lt;bucketIndex; LIST&lt;registrars&gt;&gt;
    AdvT(service_id_hash) ← KadDHT(peerID)
    for i in 0, 1, ..., m-1:
        while ongoing[i].size &lt; K_register:
            registrar ← AdvT(service_id_hash).getBucket(i).getRandomNode()
            if registrar = None:
                break
            end if
            ongoing[i].add(registrar)
            ad.service_id_hash ← service_id_hash
            ad.peerID ← peerID
            ad.addrs ← node.addrs
            ad.timestamp ← NOW()
            SIGN(ad)
            async(ADVERTISE_SINGLE(registrar, ad, i, service_id_hash))
        end while
    end for
end procedure

procedure ADVERTISE_SINGLE(registrar, ad, i, service_id_hash):
    ticket ← None
    while True:
        response ← registrar.Register(ad, ticket)
        AdvT(service_id_hash).add(response.closerPeers)
        if response.status = Confirmed:
            SLEEP(E)
            break
        else if response.status = Wait:
            SLEEP(min(E, response.ticket.t_wait_for))
            ticket ← response.ticket
        else:
            break
        end if
    end while
    ongoing[i].remove(registrar)
end procedure
</code></pre>
<p>Refer to the <a href="vac/raw/logos-capability-discovery.html#advertiser-algorithms-explanation">Advertiser Algorithms Explanation section</a> for a detailed explanation.</p>
<h2 id="service-discovery"><a class="header" href="#service-discovery">Service Discovery</a></h2>
<h3 id="overview-1"><a class="header" href="#overview-1">Overview</a></h3>
<p>Discoverers are nodes attempting to find peers that
provide a specific service identified by <code>service_id_hash</code>.</p>
<h4 id="discovery-table-disctservice_id_hash-requirements"><a class="header" href="#discovery-table-disctservice_id_hash-requirements">Discovery Table <code>DiscT(service_id_hash)</code> Requirements</a></h4>
<p>For each service that a discoverer wants to find,
it MUST instantiate a search table <code>DiscT(service_id_hash)</code>,
centered on that <code>service_id_hash</code>.</p>
<p>Discoverers MAY bootstrap <code>DiscT(service_id_hash)</code> by copying existing entries
from <code>KadDHT(peerID)</code> already maintained by the node.
For every peer present in the table from where we bootstrap,
we MUST use the formula described in the <a href="vac/raw/logos-capability-discovery.html#distance">Distance</a> section to place them in buckets.
<code>DiscT(service_id_hash)</code> SHOULD be maintained through interactions
with registrars during lookup operations.</p>
<h4 id="lookup-requirements"><a class="header" href="#lookup-requirements">Lookup Requirements</a></h4>
<p>The <code>LOOKUP(service_id_hash)</code> is carried out by discoverer nodes to query registrar nodes
to get advertisements of a particular <code>service_id_hash</code>.
The <code>LOOKUP(service_id_hash)</code> procedure MUST work as a gradual search
on the search table <code>DiscT(service_id_hash)</code> of the service whose advertisements it wants.
The <code>LOOKUP(service_id_hash)</code> MUST start from far buckets <code>(b_0)</code>
which has registrar nodes with fewer shared bits with service_id_hash
and moving to buckets <code>(b_(m-1))</code> containing registrar nodes with
higher number of shared bits or closer to <code>service_id_hash</code>.
To perform a lookup, discoverers:</p>
<ul>
<li>SHOULD query <code>K_lookup</code> random registrar nodes from every bucket of <code>DiscT(service_id_hash)</code>.</li>
<li>MUST verify the signature of each advertisement received before accepting it.</li>
<li>SHOULD add closer peers returned by registrars
in the response to <code>DiscT(service_id_hash)</code> to improve future lookups.</li>
<li>SHOULD retrieve at most <code>F_return</code> advertisement peers from a single registrar.</li>
<li>SHOULD run the lookup process periodically.
Implementations can choose the interval based on their requirements.</li>
</ul>
<h3 id="lookup-algorithm"><a class="header" href="#lookup-algorithm">Lookup Algorithm</a></h3>
<p>We RECOMMEND that the following algorithm be used
to implement the service discovery requirements specified above.
Implementations MAY use alternative algorithms
as long as they satisfy requirements specified in the previous section.</p>
<pre><code class="language-protobuf">procedure LOOKUP(service_id_hash):
    DiscT(service_id_hash) ← KadDHT(peerID)
    foundPeers ← SET&lt;Peers&gt;
    for i in 0, 1, ..., m-1:
        for j in 0, ..., K_lookup - 1:
            peer ← DiscT(service_id_hash).getBucket(i).getRandomNode()
            if peer = None:
                break
            end if
            response ← peer.GetAds(service_id_hash)
            for ad in response.ads:
                assert(ad.hasValidSignature())
                foundPeers.add(ad.peerID)
                if foundPeers.size ≥ F_lookup:
                      break
                  end if
              end for
            DiscT(service_id_hash).add(response.closerPeers)
            if foundPeers.size ≥ F_lookup:
                return foundPeers
            end if
        end for
    end for
    return foundPeers
end procedure
</code></pre>
<p>Refer to the <a href="vac/raw/logos-capability-discovery.html#lookupservice_id_hash-algorithm-explanation">Lookup Algorithm Explanation section</a>
for the detailed explanation.</p>
<h2 id="admission-protocol"><a class="header" href="#admission-protocol">Admission Protocol</a></h2>
<h3 id="overview-2"><a class="header" href="#overview-2">Overview</a></h3>
<p>Registrars are nodes that store and serve advertisements.
They play a critical role in the Logos discovery network
by acting as intermediaries between advertisers and discoverers.</p>
<h4 id="admission-control-requirements"><a class="header" href="#admission-control-requirements">Admission Control Requirements</a></h4>
<p>Registrars MUST use a waiting time based admission protocol
to admit advertisements into their <code>ad_cache</code>.
The mechanism does not require registrars to maintain
any state for each ongoing request preventing DoS attacks.</p>
<p>When a registrar node receives a <code>REGISTER</code> request from an advertiser node
to admit its <code>ad</code> for a service into the <code>ad_cache</code>,
the registrar MUST process the request according to the following requirements:</p>
<ul>
<li>The registrar MUST NOT admit an advertisement
if an identical <code>ad</code> already exists in the <code>ad_cache</code>.</li>
<li>The Registrar MUST calculate waiting time for the advertisement
using the formula specified in the
<a href="vac/raw/logos-capability-discovery.html#waiting-time-calculation">Waiting Time Calculation</a> section.
The waiting time determines how long the advertiser must wait
before the <code>ad</code> can be admitted to the <code>ad_cache</code>.</li>
<li>If no <code>ticket</code> is provided in the <code>REGISTER</code> request then
this is the advertiser's first registration attempt for the <code>ad</code>.
The registrar MUST create a new <code>ticket</code>
and return the signed <code>ticket</code> to the advertiser with status <code>Wait</code>.</li>
<li>If the advertiser provides a <code>ticket</code> in the <code>REGISTER</code> request from a previous attempt:
<ul>
<li>The registrar MUST verify the <code>ticket.signature</code>
is valid and was issued by this registrar.</li>
<li>The registrar MUST verify that <code>ticket.ad</code> matches the <code>ad</code> in the current request</li>
<li>The registrar MUST verify that the <code>ad</code> is still not in the <code>ad_cache</code></li>
<li>The registrar MUST verify the retry is within the registration window</li>
<li>If any verification fails, the registrar MUST reject the request</li>
<li>The registrar MUST recalculate the waiting time based on current cache state</li>
<li>The registrar MUST calculate remaining wait time:
<code>t_remaining = t_wait - (NOW() - ticket.t_init)</code>.
This ensures advertisers accumulate waiting time across retries</li>
</ul>
</li>
<li>If <code>t_remaining ≤ 0</code>, the registrar MUST add the <code>ad</code> to the <code>ad_cache</code>
with <code>ad.Timestamp</code> set to current Unix time.
The registrar SHOULD return response with <code>status = Confirmed</code></li>
<li>If <code>t_remaining &gt; 0</code>, the advertiser SHOULD continue waiting.
The registrar MUST issue a new <code>ticket</code> with updated <code>ticket.t_mod</code> and <code>ticket.t_wait_for = MIN(E, t_remaining)</code>.
The registrar MUST sign the new <code>ticket</code>.
The registrar SHOULD return response with status <code>Wait</code> and the new signed <code>ticket</code>.</li>
<li>The registrar SHOULD include a list of closer peers (<code>response.closerPeers</code>)
to help the advertiser improve its advertise table.</li>
</ul>
<p><code>ad_cache</code> maintainence:</p>
<ul>
<li>The total size of the <code>ad_cache</code> MUST be limited by its capacity <code>C</code>.</li>
<li>Each <code>ad</code> stored in the <code>ad_cache</code> MUST have an associated expiry time <code>E</code>,
after which the <code>ad</code> is MUST be automatically removed.</li>
<li>When processing or periodically cleaning,
the registrar MUST check <code>if currentTime - ad.Timestamp &gt; E</code>.
If true, the <code>ad</code> is expired and MUST be removed from the cache.</li>
<li><code>ad_cache</code> MUST NOT store duplicate <code>ad</code>.</li>
</ul>
<h3 id="registration-flow"><a class="header" href="#registration-flow">Registration Flow</a></h3>
<p>We RECOMMEND that the following algorithm be used by registrars
to implement the admission control requirements specified above.</p>
<p>Refer to the <a href="vac/raw/logos-capability-discovery.html#register-message">Register Message section</a>
for the request and response structure of <code>REGISTER</code>.</p>
<pre><code class="language-text">procedure REGISTER(ad, ticket):
    assert(ad not in ad_cache)
    response.ticket.ad ← ad
    t_wait ← CALCULATE_WAITING_TIME(ad)

    if ticket.empty():
        t_remaining ← t_wait
        response.ticket.t_init ← NOW()
        response.ticket.t_mod ← NOW()
    else:
        assert(ticket.hasValidSignature())
        assert(ticket.ad = ad)
        assert(ad.notInAdCache())
        t_scheduled ← ticket.t_mod + ticket.t_wait_for
        assert(t_scheduled ≤ NOW() ≤ t_scheduled + δ)
        t_remaining ← t_wait - (NOW() - ticket.t_init)
    end if
    if t_remaining ≤ 0:
        ad_cache.add(ad)
        response.status ← Confirmed
    else:
        response.status ← Wait
        response.ticket.t_wait_for ← MIN(E, t_remaining)
        response.ticket.t_mod ← NOW()
        SIGN(response.ticket)
    end if
    response.closerPeers ← GETPEERS(ad.service_id_hash)
    return response
end procedure
</code></pre>
<p>Refer to the <a href="vac/raw/logos-capability-discovery.html#register-algorithm-explanation">Register Algorithm Explanation section</a>
for detailed explanation.</p>
<h2 id="lookup-response-algorithm"><a class="header" href="#lookup-response-algorithm">Lookup Response Algorithm</a></h2>
<p>Registrars respond to <code>GET_ADS</code> requests from discoverers
using the <code>LOOKUP_RESPONSE()</code> algorithm.
Refer to <a href="vac/raw/logos-capability-discovery.html#get_ads-message">GET_ADS Message section</a>
for the request and response structure of <code>GET_ADS</code>.</p>
<pre><code class="language-text">procedure LOOKUP_RESPONSE(service_id_hash):
    response.ads ← ad_cache.getAdvertisements(service_id_hash)[:F_return]
    response.closerPeers ← GETPEERS(service_id_hash)
    return response
end procedure
</code></pre>
<ol>
<li>Fetch all <code>ads</code> for <code>service_id_hash</code> from the registrar’s <code>ad_cache</code>.
Then return up to <code>F_return</code> of them
(a system parameter limiting how many <code>ads</code> are sent per query by a registrar).</li>
<li>Call the <code>GETPEERS(service_id_hash)</code> function to get a list of peers
from across the registrar’s routing table <code>RegT(service_id_hash)</code>.</li>
<li>Send the assembled response (advertisements + closer peers) back to the discoverer.</li>
</ol>
<h2 id="peer-table-updates"><a class="header" href="#peer-table-updates">Peer Table Updates</a></h2>
<p>While responding to both <code>REGISTER</code> requests by advertisers
and <code>GET_ADS</code> request by discoverers,
the contacted registrar node also returns a list of peers.
To get this list of peers, the registrar runs the <code>GETPEERS(service_id_hash)</code> algorithm.
Both advertisers and discoverers update their
service-specific tables using this list of peers.</p>
<pre><code class="language-text">procedure GETPEERS(service_id_hash):
    peers ← SET&lt;peers&gt;
    RegT(service_id_hash) ← KadDHT(peerID)
    for i in 0, 1, ..., m-1:
        peer ← b_i(service_id_hash).getRandomNode()
        if peer ≠ None:
            peers.add(peer)
        end if
    end for
    return peers
end procedure
</code></pre>
<ol>
<li><code>peers</code> is initialized as an empty set to avoid storing duplicates</li>
<li>The registrar table <code>RegT(service_id_hash)</code> is initialized from the node’s <code>KadDHT(peerID)</code> routing table.
Refer to the <a href="vac/raw/logos-capability-discovery.html#distance">Distance section</a> on how to add peers.</li>
<li>Go through all <code>m</code> buckets in the registrar’s table — from farthest to closest relative to the <code>service_id_hash</code>.
<ol>
<li>Pick one random peer from bucket <code>i</code>.
<code>getRandomNode()</code>  function remembers already returned nodes and never returns the same one twice.</li>
<li>If peer returned is not null then we move on to next bucket.
Else we try to get another peer in the same bucket</li>
</ol>
</li>
<li>Return <code>peers</code> which contains one peer from every bucket of <code>RegT(service_id_hash)</code>.</li>
</ol>
<p>Malicious registrars could return large numbers of malicious nodes in a specific bucket.
To limit this risk, a node communicating with a registrar asks it to return a single peer per bucket
from registrar’s view of the routing table <code>RegT(service_id_hash)</code>.
Contacting registrars in consecutive buckets divides the search space by a constant factor,
and allows learning new peers from more densely-populated routing tables towards the destination.
The procedure mitigates the risk of having malicious peers polluting the table
while still learning rare peers in buckets close to <code>service_id_hash</code>.</p>
<h2 id="waiting-time-calculation"><a class="header" href="#waiting-time-calculation">Waiting Time Calculation</a></h2>
<h3 id="formula"><a class="header" href="#formula">Formula</a></h3>
<p>The waiting time is the time advertisers have to
wait before their <code>ad</code> is admitted to the <code>ad_cache</code>.
The waiting time is given based on the <code>ad</code> itself
and the current state of the registrar’s <code>ad_cache</code>.</p>
<p>The waiting time for an advertisement MUST be calculated using:</p>
<pre><code class="language-text">w(ad) = E × (1/(1 - c/C)^P_occ) × (c(ad.service_id_hash)/C + score(getIP(ad.addrs)) + G)
</code></pre>
<ul>
<li><code>c</code>: Current cache occupancy</li>
<li><code>c(ad.service_id_hash)</code>: Number of advertisements for <code>service_id_hash</code> in cache</li>
<li><code>getIP(ad.addrs)</code> is a function to get the IP address from the multiaddress of the advertisement.</li>
<li><code>score(getIP(ad.addrs))</code>: IP similarity score (0 to 1). Refer to the <a href="vac/raw/logos-capability-discovery.html#ip-similarity-score">IP Similarity Score section</a></li>
</ul>
<p>Section <a href="vac/raw/logos-capability-discovery.html#system-parameters">System Parameters</a> can be referred
for the definitions of the remaining parameters in the formula.</p>
<p>Issuing waiting times promote diversity in the <code>ad_cache</code>.
It results in high waiting times and slower admission for malicious advertisers
using Sybil identities from a limited number of IP addresses.
It also promotes less popular services with fast admission
ensuring fairness and robustness against failures of single registrars.</p>
<h3 id="scaling"><a class="header" href="#scaling">Scaling</a></h3>
<p>The waiting time is normalized by the ad’s expiry time <code>E</code>.
It binds waiting time to <code>E</code> and allows us to reason about the number of incoming requests
regardless of the time each <code>ad</code> spends in the <code>ad_cache</code>.</p>
<h3 id="occupancy-score"><a class="header" href="#occupancy-score">Occupancy Score</a></h3>
<pre><code class="language-text">occupancy_score = 1 / (1 - c/C)^P_occ
</code></pre>
<p>The occupancy score increases progressively as the cache fills:</p>
<ul>
<li>When <code>c &lt;&lt; C</code>: Score ≈ 1 (minimal impact)</li>
<li>As the <code>ad_cache</code> fills up, the score will be amplified by the divisor of the equation.
The higher the value of <code>P_occ</code>, the faster the increase.
Implementations should consider this while setting the value for <code>P_occ</code></li>
<li>As <code>c → C</code>: Score → ∞ (prevents overflow)</li>
</ul>
<h3 id="service-similarity"><a class="header" href="#service-similarity">Service Similarity</a></h3>
<pre><code class="language-text">service_similarity = c(ad.service_id_hash) / C
</code></pre>
<p>The service similarity score promotes diversity:</p>
<ul>
<li>Low when <code>service_id_hash</code> has few advertisements in cache. Thus lower waiting time.</li>
<li>High when <code>service_id_hash</code> dominates the cache. Thus higher waiting time.</li>
</ul>
<h3 id="ip-similarity-score"><a class="header" href="#ip-similarity-score">IP Similarity Score</a></h3>
<p>The IP similarity score is used to detect and limit
Sybil attacks where malicious actors create multiple advertisements
from the same network or IP prefix.</p>
<p>Registrars MUST use an IP similarity score to
limit the number of <code>ads</code> coming from the same subnetwork
by increasing their waiting time.
The IP similarity mechanism:</p>
<ul>
<li>MUST calculate a score ranging from 0 to 1, where:
<ul>
<li>A score closer to 1 indicates IPs sharing similar prefixes
(potential Sybil behavior)</li>
<li>A score closer to 0 indicates diverse IPs (legitimate behavior)</li>
</ul>
</li>
<li>MUST track IP addresses of <code>ads</code> currently in the <code>ad_cache</code>.</li>
<li>MUST update its tracking structure when:
<ul>
<li>A new <code>ad</code> is admitted to the <code>ad_cache</code>: MUST add the IP</li>
<li>An <code>ad</code> expires after time <code>E</code>:
MUST remove IP if there are no other active <code>ads</code> from the same IP</li>
</ul>
</li>
<li>MUST calculate the IP similarity score every time
a waiting time is calculated for a new registration attempt.</li>
</ul>
<h4 id="tree-structure"><a class="header" href="#tree-structure">Tree Structure</a></h4>
<p>We RECOMMEND using an IP tree data structure
to efficiently track and calculate IP similarity scores.
An IP tree is a binary tree that stores
IPs used by <code>ads</code> currently present in the <code>ad_cache</code>.
This data structure provides logarithmic time complexity
for insertion, deletion, and score calculation.
Implementations MAY use alternative data structures
as long as they satisfy the requirements specified above.
The recommended IP tree has the following structure:</p>
<ul>
<li>Each tree vertex stores a <code>IP_counter</code> showing how many IPs pass through that node.</li>
<li>Apart from root, the IP tree is a 32-level binary tree</li>
<li>The <code>IP_counter</code> of every vertex of the tree is initially set to 0.</li>
<li>edges represent consecutive 0s or 1s in a binary representation of IPv4 addresses.</li>
<li>While inserting an IPv4 address into the tree using <code>ADD_IP_TO_TREE()</code> algorithm,
<code>IP_counter</code>s of all the visited vertices are increased by 1.
The visited path is the binary representation of the IPv4 address.
IPv4 addresses are inserted into the tree only when they are admitted to the <code>ad_cache</code>.</li>
<li>The IP tree is traversed to calculate the IP score using
<code>CALCULATE_IP_SCORE()</code> every time the waiting time is calculated.</li>
<li>When an <code>ad</code> expires after <code>E</code> the <code>ad</code> is removed from the <code>ad_cache</code>
and the IP tree is also updated using the <code>REMOVE_FROM_IP_TREE()</code> algorithm
by decreasing the <code>IP_counter</code>s on the path.
The path is the binary representation of the IPv4 address.</li>
<li>the root <code>IP_counter</code> stores the number of IPv4 addresses
that are currently present in the <code>ad_cache</code></li>
</ul>
<h4 id="add_ip_to_tree-algorithm"><a class="header" href="#add_ip_to_tree-algorithm"><code>ADD_IP_TO_TREE()</code> algorithm</a></h4>
<p>When an <code>ad</code> is admitted to the <code>ad_cache</code>,
its IPv4 address MUST be added to the IP tracking structure.</p>
<p>We RECOMMEND the <code>ADD_IP_TO_TREE()</code> algorithm for adding IPv4 addresses to the IP tree.
This algorithm ensures efficient insertion with O(32) time complexity.
Implementations MAY use alternative approaches as long as they maintain
accurate IP tracking for similarity calculation.</p>
<pre><code class="language-text">procedure ADD_IP_TO_TREE(tree, IP):
    v ← tree.root
    bits ← IP.toBinary()
    for i in 0, 1, ..., 31:
        v.IP_counter ← v.IP_counter + 1
        if bits[i] = 0:
            v ← v.left
        else:
            v ← v.right
        end if
    end for
end procedure
</code></pre>
<ol>
<li>Start from the root node of the tree.
Initialize current node variable <code>v</code> to root of the tree <code>tree.root</code>.</li>
<li>Convert the IP address into its binary form (32 bits) and sore in variable <code>bits</code></li>
<li>Go through each bit of the IP address, from the most significant (leftmost <code>0</code>) to the least (rightmost <code>31</code>).
<ol>
<li>Increase the <code>IP_counter</code> for the current node <code>v.IP_counter</code>.
This records that another IP passed through this vertex <code>v</code> (i.e., shares this prefix).</li>
<li>Move to the next node in the tree. Go left <code>v.left</code> if the current bit <code>bits[i]</code> is <code>0</code>.
Go right <code>v.right</code> if it’s <code>1</code>.
This follows the path corresponding to the IP’s binary representation.</li>
</ol>
</li>
</ol>
<h4 id="calculate_ip_score-algorithm"><a class="header" href="#calculate_ip_score-algorithm"><code>CALCULATE_IP_SCORE()</code> algorithm</a></h4>
<p>Every time a waiting time is calculated for a registration attempt,
the registrar MUST calculate the IP similarity score for the advertiser's IP address.
This score determines how similar the IP is to other IPs already in the cache.</p>
<p>We RECOMMEND the <code>CALCULATE_IP_SCORE()</code> algorithm for calculating IP similarity scores.
This algorithm traverses the IP tree to detect how many IPs share common prefixes,
providing an effective measure of potential Sybil behavior.
Implementations MAY use alternative approaches
as long as they accurately measure IP similarity on a 0-1 scale.</p>
<pre><code class="language-text">procedure CALCULATE_IP_SCORE(tree, IP):
    v ← tree.root
    score ← 0
    bits ← IP.toBinary()
    for i in 0, 1, ..., 31:
        if bits[i] = 0:
            v ← v.left
        else:
            v ← v.right
        end if
        if v.IP_counter &gt; tree.root.IP_counter / 2^i:
            score ← score + 1
        end if
    end for
    return score / 32
end procedure
</code></pre>
<ol>
<li>Start from the root node of the tree.</li>
<li>Initialize the similarity score <code>score</code> to 0.
This score will later show how common the IP’s prefix is among existing IPs.</li>
<li>Convert the IP address into its binary form (32 bits) and sore in variable <code>bits</code></li>
<li>Go through each bit of the IP address,
from the most significant (leftmost <code>0</code>) to the least (rightmost <code>31</code>).
<ol>
<li>Move to the next node in the tree.
Go left <code>v.left</code> if the current bit <code>bits[i]</code> is <code>0</code>. Go right <code>v.right</code> if it’s <code>1</code>.
This follows the path corresponding to the IP’s binary representation.</li>
<li>Check if this node’s <code>IP_counter</code> is larger than expected in a perfectly balanced tree.
If it is, that means too many IPs share this prefix,
so increase the similarity score <code>score</code> by 1.</li>
</ol>
</li>
<li>Divide the total score by 32 (the number of bits in the IP) and return it.</li>
</ol>
<h4 id="remove_from_ip_tree-algorithm"><a class="header" href="#remove_from_ip_tree-algorithm"><code>REMOVE_FROM_IP_TREE()</code> algorithm</a></h4>
<p>When an <code>ad</code> expires after time <code>E</code>,
the registrar MUST remove the <code>ad</code> from the <code>ad_cache</code>.
The registrar MUST also remove the IP from IP tracking structure
if there are no other active <code>ad</code> in <code>ad_cache</code> from the same IP.</p>
<p>We RECOMMEND the <code>REMOVE_FROM_IP_TREE()</code> algorithm for removing IPv4 addresses from the IP tree.
This algorithm ensures efficient deletion with O(32) time complexity.
Implementations MAY use alternative approaches as long as they maintain accurate IP tracking.</p>
<pre><code class="language-text">procedure REMOVE_FROM_IP_TREE(tree, IP):
    v ← tree.root
    bits ← IP.toBinary()
    for i in 0, 1, ..., 31:
        v.IP_counter ← v.IP_counter - 1
        if bits[i] = 0:
            v ← v.left
        else:
            v ← v.right
        end if
    end for
end procedure
</code></pre>
<p>Implementations can extend the IP tree algorithms to IPv6
by using a 128-level binary tree,
corresponding to the 128-bit length of IPv6 addresses.</p>
<h3 id="safety-parameter"><a class="header" href="#safety-parameter">Safety Parameter</a></h3>
<p>The safety parameter <code>G</code> ensures waiting times never reach zero even when:</p>
<ul>
<li>Service similarity is zero (new service).</li>
<li>IP similarity is zero (completely distinct IP)</li>
</ul>
<p>It prevents <code>ad_cache</code> overflow in cases when attackers try to
send <code>ads</code> for random services or from diverse IPs.</p>
<h3 id="lower-bound-enforcement"><a class="header" href="#lower-bound-enforcement">Lower Bound Enforcement</a></h3>
<p>To prevent "ticket grinding" attacks where advertisers
repeatedly request new tickets hoping for better waiting times,
registrars MUST enforce lower bounds:</p>
<p>Invariant: A new waiting time <code>w_2</code> at time <code>t_2</code>
cannot be smaller than a previous waiting time <code>w_1</code> at time <code>t_1</code>
(where <code>t_1 &lt; t_2</code>) by more than the elapsed time:</p>
<pre><code class="language-text">w_2 ≥ w_1 - (t_2 - t_1)
</code></pre>
<p>Thus registrars MUST maintain lower bound state for:</p>
<ul>
<li>Each service in the cache: <code>bound(service_id_hash)</code> and <code>timestamp(service_id_hash)</code></li>
<li>Each IP prefix in the IP tree: <code>bound(IP)</code> and <code>timestamp(IP)</code></li>
</ul>
<p>The total waiting time will respect the lower bound if lower bound is enforced on these.
These two sets have a bounded size as number of <code>ads</code> present in the <code>ad_cache</code>
at a time is bounded by the cache capacity <code>C</code>.</p>
<p><strong>How SHOULD lower bound be calculated for service IDs:</strong></p>
<p>When new <code>service_id_hash</code> enters the cache, <code>bound(service_id_hash)</code> is set to <code>0</code>,
and a <code>timestamp(service_id_hash)</code> is set to the current time.
When a new ticket request arrives for the same <code>service_id_hash</code>,
the registrar calculates the service waiting time <code>w_s</code> and then applies the lower-bound rule:</p>
<p><code>w_s = max(w_s, bound(service_id_hash) - timestamp(service_id_hash))</code></p>
<p>The values <code>bound(service_id_hash)</code> and <code>timestamp(service_id_hash)</code>
are updated whenever a new <code>ticket</code> is issued
and the condition <code>w_s &gt; (bound(service_id_hash) - timestamp(service_id_hash))</code>is satisfied.</p>
<p><strong>How SHOULD lower bound be calculated for IPs:</strong>
Registrars enforce lower-bound state for the advertiser’s IP address using IP tree
(refer to the <a href="vac/raw/logos-capability-discovery.html#ip-similarity-score">IP Similarity Score section</a>).</p>
<h2 id="implementation-notes-2"><a class="header" href="#implementation-notes-2">Implementation Notes</a></h2>
<h3 id="client-and-server-mode"><a class="header" href="#client-and-server-mode">Client and Server Mode</a></h3>
<p>Logos discovery respects the client/server mode distinction
from the base Kad-dht specification:</p>
<ul>
<li><strong>Server mode nodes</strong>: MAY be Discoverer, Advertiser or Registrar</li>
<li><strong>Client mode nodes</strong>: MUST be only Discoverer</li>
</ul>
<p>Implementations MAY include incentivization mechanisms
to encourage peers to participate as advertisers or registrars,
rather than operating solely in client mode.
This helps prevent free-riding behavior,
ensures a fair distribution of network load,
and maintains the overall resilience and availability of the discovery layer.
Incentivization mechanisms are beyond the scope of this RFC.</p>
<h2 id="references-7"><a class="header" href="#references-7">References</a></h2>
<p>[0] <a href="https://pdos.csail.mit.edu/~petar/papers/maymounkov-kademlia-lncs.pdf">Kademlia: A Peer-to-Peer Information System Based on the XOR Metric</a></p>
<p>[1] <a href="https://ieeexplore.ieee.org/document/10629017">DISC-NG: Robust Service Discovery in the Ethereum Global Network</a></p>
<p>[2] <a href="https://github.com/libp2p/specs/blob/master/kad-dht/README.md">libp2p Kademlia DHT specification</a></p>
<p>[3] <a href="https://github.com/libp2p/go-libp2p-kad-dht">Go implementation</a></p>
<h2 id="appendix"><a class="header" href="#appendix">Appendix</a></h2>
<p>This appendix provides detailed explanations of some algorithms
and helper procedures referenced throughout this RFC.
To maintain clarity and readability in the main specification,
the body contains only the concise pseudocode and high-level descriptions.</p>
<h3 id="advertiser-algorithms-explanation"><a class="header" href="#advertiser-algorithms-explanation">Advertiser Algorithms Explanation</a></h3>
<p>Refer to the <a href="vac/raw/logos-capability-discovery.html#advertisement-algorithm">Advertisement Algorithm section</a> for the pseudocode.</p>
<h4 id="advertise-algorithm-explanation"><a class="header" href="#advertise-algorithm-explanation">ADVERTISE() algorithm explanation</a></h4>
<ol>
<li>Initialize a map <code>ongoing</code> for tracking which registrars are currently being advertised to.</li>
<li>Initialize the advertise table <code>AdvT(service_id_hash)</code> by bootstrapping peers from
the advertiser’s <code>KadDHT(peerID)</code> routing table.
(Refer to the <a href="vac/raw/logos-capability-discovery.html#distance">Distance section</a>)</li>
<li>Iterate over all buckets (i = 0 through <code>m-1</code>),
where <code>m</code> is the number of buckets in <code>AdvT(service_id_hash)</code> and <code>ongoing</code> map.
Each bucket corresponds to a particular distance from the <code>service_id_hash</code>.
<ol>
<li><code>ongoing[i]</code> contains list of  registrars with active (unexpired) registrations
or ongoing registration attempts at a distance <code>i</code>
from the <code>service_id_hash</code> of the service that the advertiser is advertising for.</li>
<li>Advertisers continuously maintain up to <code>K_register</code> active (unexpired) registrations
or ongoing registration attempts in every bucket of the <code>ongoing</code> map for its service.
Increasing <code>K_register</code> makes the advertiser easier to find
at the cost of increased communication and storage costs.</li>
<li>Pick a random registrar from bucket <code>i</code> of <code>AdvT(service_id_hash)</code> to advertise to.
<ul>
<li><code>AdvT(service_id_hash).getBucket(i)</code> → returns a list of registrars in bucket <code>i</code>
from the advertise table <code>AdvT(service_id_hash)</code></li>
<li><code>.getRandomNode()</code> → function returns a random registrar node.
The advertiser tries to place its advertisement into that registrar.
The function remembers already returned nodes
and never returns the same one twice during the same <code>ad</code> placement process.
If there are no peers, it returns <code>None</code>.</li>
</ul>
</li>
<li>if we get a peer then we add that to that bucket <code>ongoing[i]</code></li>
<li>Build the advertisement object <code>ad</code> containing <code>service_id_hash</code>, <code>peerID</code>, <code>addrs</code>, and <code>timestamp</code>
(Refer to the <a href="vac/raw/logos-capability-discovery.html#advertisement">Advertisement section</a>) .
Then it is signed by the advertiser using the node’s private key (Ed25519 signature)</li>
<li>Then send this <code>ad</code> asynchronously to the selected registrar.
The helper <code>ADVERTISE_SINGLE()</code> will handle registration to a single registrar.
Asynchronous execution allows multiple <code>ads</code> (to multiple registrars) to proceed in parallel.</li>
</ol>
</li>
</ol>
<h4 id="advertise_single-algorithm-explanation"><a class="header" href="#advertise_single-algorithm-explanation">ADVERTISE_SINGLE() algorithm explanation</a></h4>
<p><code>ADVERTISE_SINGLE()</code> algorithm handles registration to one registrar at a time</p>
<ol>
<li>Initialize <code>ticket</code> to <code>None</code> as we have not yet got any ticket from registrar</li>
<li>Keep trying until the registrar confirms or rejects the <code>ad</code>.
<ol>
<li>Send the <code>ad</code> to the registrar using <code>Register</code> request.
Request structure is described in section <a href="vac/raw/logos-capability-discovery.html#register-message">Register Message Structure</a>.
If we already have a ticket, include it in the request.</li>
<li>The registrar replies with a <code>response</code>.
Refer to the <a href="vac/raw/logos-capability-discovery.html#register-message">Register Message Structure section</a> for the response structure</li>
<li>Add the list of peers returned by the registrar <code>response.closerPeers</code> to the advertise table <code>AdvT(service_id_hash)</code>.
Refer to the [Distance](#distance section) on how to add.
These help improve the table for future use.</li>
<li>If the registrar accepted the advertisement successfully,
wait for <code>E</code> seconds,
then stop retrying because the <code>ad</code> is already registered.</li>
<li>If the registrar says “wait” (its cache is full or overloaded),
sleep for the time written in the ticket <code>ticket.t_wait_for</code>(but not more than <code>E</code>).
Then update <code>ticket</code> with the new one from the registrar, and try again.</li>
<li>If the registrar rejects the ad, stop trying with this registrar.</li>
</ol>
</li>
<li>Remove this registrar from the <code>ongoing</code> map in bucket i (<code>ongoing[i]</code>),
since we’ve finished trying with it.</li>
</ol>
<h3 id="discoverer-algorithms"><a class="header" href="#discoverer-algorithms">Discoverer Algorithms</a></h3>
<h4 id="lookupservice_id_hash-algorithm-explanation"><a class="header" href="#lookupservice_id_hash-algorithm-explanation">LOOKUP(service_id_hash) algorithm explanation</a></h4>
<p>Refer to the <a href="vac/raw/logos-capability-discovery.html#lookup-algorithm">Lookup Algorithm section</a> for the pseudocode.</p>
<ol>
<li>The <strong>Discovery Table</strong> <code>DiscT(service_id_hash)</code> is initialized by
bootstrapping peers from the discoverer’s <code>KadDHT(peerID)</code> routing table.
(refer to the <a href="vac/raw/logos-capability-discovery.html#distance">Distance section</a>)</li>
<li>Create an empty set <code>foundPeers</code> to store unique advertisers peer IDs discovered during the lookup.</li>
<li>Go through each bucket of the search table <code>DiscT(service_id_hash)</code> —
from farthest (<code>b₀</code>) to closest (<code>bₘ₋₁</code>) to the service ID <code>service_id_hash</code>.
For each bucket, query up to <code>K_lookup</code> random peers.
<ol>
<li>Pick a random registrar node from bucket <code>i</code> of the search table <code>DiscT(service_id_hash)</code> to query
<ol>
<li><code>DiscT(service_id_hash).getBucket(i)</code> → returns a list of registrars
in bucket <code>i</code> from the search table <code>DiscT(service_id_hash)</code></li>
<li><code>.getRandomNode()</code> → function returns a random registrar node.
The discover queries this node to get <code>ads</code> for a particular service ID <code>service_id_hash</code>.
The function remembers already returned nodes and never returns the same one twice.
If there are no peers, it returns <code>None</code>.</li>
</ol>
</li>
<li>A <code>GET_ADS</code> request is sent to the selected registrar peer.
Refer to the <a href="vac/raw/logos-capability-discovery.html#get_ads-message">GET_ADS Message section</a> to see the request and response structure for <code>GET_ADS</code>.
The response returned by the registrar node is stored in <code>response</code></li>
<li>The <code>response</code> contains a list of advertisements <code>response.ads</code>.
A queried registrar returns at most <code>F_return</code> advertisements.
If it returns more we can just randomly keep <code>F_return</code> of them.
For each advertisement returned:
<ol>
<li>Verify its digital signature for authenticity.</li>
<li>Add the advertiser’s peer ID <code>ad.peerID</code> to the list <code>foundPeers</code>.</li>
</ol>
</li>
<li>The <code>response</code> also contains a list of peers <code>response.closerPeers</code>
that is inserted into the search table <code>DiscT(service_id_hash)</code>.
Refer to the <a href="vac/raw/logos-capability-discovery.html#distance">Distance section</a> for how it is added.</li>
<li>Stop early if enough advertiser peers (<code>F_lookup</code>) have been found — no need to continue searching.
For popular services <code>F_lookup</code> advertisers are generally found in the initial phase
from the farther buckets and the search terminates.
But for unpopular ones it might take longer but not more than <code>O(log N)</code>
where N is number of nodes participating in the network as registrars.</li>
<li>If early stop doesn’t happen then the search stops when no unqueried registrars remain in any of the buckets.</li>
</ol>
</li>
<li>Return <code>foundPeers</code> which is the final list of discovered advertisers that provide service <code>service_id_hash</code></li>
</ol>
<p>Making the advertisers and discoverers walk towards <code>service_id_hash</code> in a similar fashion
guarantees that the two processes overlap and contact a similar set of registrars that relay the <code>ads</code>.
At the same time, contacting random registrars in each encountered bucket using <code>getRandomNode()</code>
makes it difficult for an attacker to strategically place malicious registrars in the network.
The first bucket <code>b_0(service_id_hash)</code> covers the largest fraction of the key space
as it corresponds to peers with no common prefix to <code>service_id_hash</code> (i.e. 50% of all the registrars).
Placing malicious registrars in this fraction of the key space
to impact service discovery process would require considerable resources.
Subsequent buckets cover smaller fractions of the key space,
making it easier for the attacker to place Sybils
but also increasing the chance of advertisers already gathering enough <code>ads</code> in previous buckets.</p>
<p>Parameters <code>F_return</code> and <code>F_lookup</code> play an important role in setting a compromise between security and efficiency.
A small value of <code>F_return &lt;&lt; F_lookup</code> increases the diversity of the source of <code>ads</code> received by the discoverer
but increases search time, and requires reaching buckets covering smaller key ranges where eclipse risks are higher.
On the other hand, similar values for <code>F_lookup</code> and <code>F_return</code> reduce overheads
but increase the danger of a discoverer receiving <code>ads</code> uniquely from malicious nodes.
Finally, low values of <code>F_lookup</code> stop the search operation early,
before reaching registrars close to the service hash, contributing to a more balanced load distribution.
Implementations should consider these trade-offs carefully when selecting appropriate values.</p>
<h3 id="registrar-algorithms"><a class="header" href="#registrar-algorithms">Registrar Algorithms</a></h3>
<h4 id="register-algorithm-explanation"><a class="header" href="#register-algorithm-explanation"><code>REGISTER()</code> algorithm explanation</a></h4>
<p>Refer to the <a href="vac/raw/logos-capability-discovery.html#registration-flow">Registration Flow section</a> for the pseudocode</p>
<ol>
<li>Make sure this advertisement <code>ad</code> is not already in the registrar’s advertisement cache <code>ad_cache</code>.
Duplicates are not allowed.
An advertiser can place at most one <code>ad</code> for a specific <code>service_id_hash</code> in the <code>ad_cache</code> of a given registrar.</li>
<li>Prepare a response ticket <code>response.ticket</code> linked to this <code>ad</code>.</li>
<li>Then calculate how long the advertiser should wait <code>t_wait</code> before being admitted.
Refer to the <a href="vac/raw/logos-capability-discovery.html#waiting-time-calculation">Waiting Time Calculation section</a> for details.</li>
<li>Check if this is the first registration attempt (no ticket yet):
<ol>
<li>If yes then it’s the first try. The advertiser must wait for the full waiting time <code>t_wait</code>.
The ticket’s creation time <code>t_init</code> and last-modified time <code>t_mod</code> are both set to <code>NOW()</code>.</li>
<li>If no, then this is a retry, so a previous ticket exists.
<ol>
<li>Validate that the ticket is properly signed by the registrar,
belongs to this same advertisement and that the <code>ad</code> is still not already in the <code>ad_cache</code>.</li>
<li>Ensure the retry is happening within the allowed time window <code>δ</code> after the scheduled time.
If the advertiser waits too long or too short, the ticket is invalid.</li>
<li>Calculate how much waiting time is left <code>t_remaining</code>
by subtracting how long the advertiser has already waited
(<code>NOW() - ticket.t_init</code>) from <code>t_wait</code>.</li>
</ol>
</li>
</ol>
</li>
<li>Check if the remaining waiting time <code>t_remaining</code> is less than or equal to 0.
This means  the waiting time is over.
<code>t_remaining</code> can be 0 also when the registrar decides that
the advertiser doesn’t have to wait for admission to the <code>ad_cache</code>(waiting time <code>t_wait</code> is 0).
<ol>
<li>If yes, add the <code>ad</code> to <code>ad_cache</code> and confirm registration.
The advertisement is now officially registered.</li>
<li>If no, then there is still time to wait.
In this case registrar does not store <code>ad</code> but instead issues a ticket.
<ol>
<li>set <code>reponse.status</code> to <code>wait</code></li>
<li>Update the ticket with the new remaining waiting time <code>t_wait_for</code></li>
<li>Update the ticket last modification time <code>t_mod</code></li>
<li>Sign the ticket again. The advertiser will retry later using this new ticket.</li>
</ol>
</li>
</ol>
</li>
<li>Add a list of peers closer to the <code>ad.service_id_hash</code> using the <code>GETPEERS()</code> function
to the response (the advertiser uses this to update its advertise table <code>AdvT(service_id_hash)</code>).</li>
<li>Send the full response back to the advertiser</li>
</ol>
<p>Upon receiving a ticket, the advertiser waits for the specified <code>t_wait</code> time
before trying to register again with the same registrar.
Each new registration attempt must include the latest ticket issued by that registrar.</p>
<p>A ticket can only be used within a limited <strong>registration window</strong> <code>δ</code>,
which is chosen to cover the maximum expected delay between the advertiser and registrar.
This rule prevents attackers from collecting many tickets, accumulating waiting times,
and submitting them all at once to overload the registrar.</p>
<p>Advertisers only read the waiting time <code>t_wait</code> from the ticket —
they do <strong>not</strong> use the creation time <code>t_init</code> or the modification time <code>t_mod</code>.
Therefore, <strong>clock</strong> synchronization between advertisers and registrars is not required.</p>
<p>The waiting time <code>t_wait</code> is not fixed.
Each time an advertiser tries to register,
the registrar recalculates a new waiting time based on its current cache state.
The remaining time <code>t_remaining</code> is then computed as the difference between
the new waiting time and the time the advertiser has already waited, as recorded in the ticket.
With every retry, the advertiser accumulates waiting time and will eventually be admitted.
However, if the advertiser misses its registration window or fails to include the last ticket,
it loses all accumulated waiting time and must restart the registration process from the beginning.
Implementations must consider these factors while deciding the registration window <code>δ</code> time.</p>
<p>This design lets registrars prioritize advertisers that have waited longer
without keeping any per-request state before the <code>ad</code> is admitted to the cache.
Because waiting times are recalculated and tickets are stored only on the advertiser’s side,
the registrar is protected from memory exhaustion
and DoS attacks caused by inactive or malicious advertisers.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="libp2p-mix"><a class="header" href="#libp2p-mix">LIBP2P-MIX</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Libp2p Mix Protocol</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Prem Prathi &lt;premprathi@proton.me&gt;</td></tr>
<tr><th>Contributors</th><td>A<br>k<br>s<br>h<br>a<br>y<br>a<br> <br>M<br>a<br>n<br>i<br> <br>&lt;<br>a<br>k<br>s<br>h<br>a<br>y<br>a<br>@<br>s<br>t<br>a<br>t<br>u<br>s<br>.<br>i<br>m<br>&gt;<br>,<br> <br>D<br>a<br>n<br>i<br>e<br>l<br> <br>K<br>a<br>i<br>s<br>e<br>r<br> <br>&lt;<br>d<br>a<br>n<br>i<br>e<br>l<br>k<br>a<br>i<br>s<br>e<br>r<br>@<br>s<br>t<br>a<br>t<br>u<br>s<br>.<br>i<br>m<br>&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-13"><a class="header" href="#timeline-13">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/raw/mix.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/raw/mix.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-12-15</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/dabc31786b4a4ca704ebcd1105239faff7ac2b47/vac/raw/mix.md"><code>dabc317</code></a> — fixing format errors in mix rfc (#229)</li>
<li><strong>2025-12-12</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/4f54254706666e373b5987901d974dc40f109293/vac/raw/mix.md"><code>4f54254</code></a> — fix format errors in math sections for mix rfc (#225)</li>
<li><strong>2025-12-11</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/7f1df32779d5ff3fa57abc2e71ac2ad1b9662965/vac/raw/mix.md"><code>7f1df32</code></a> — chore: use sembreaks for easy review and edits (#223)</li>
<li><strong>2025-12-10</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/e742cd519200a7cb0971936bd1dbbeb31397bce5/vac/raw/mix.md"><code>e742cd5</code></a> — RFC Addition: Section 9 Security Considerations (#194)</li>
<li><strong>2025-12-10</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/9d11a22901ffe9c3ab0007f58baa55b0e08abfc9/vac/raw/mix.md"><code>9d11a22</code></a> — docs: finalize Section 8 Sphinx Packet Construction and Handling (#202)</li>
<li><strong>2025-10-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/36be428cdd2f12e1c9a1dd0b984dc9a6fd4acfee/vac/raw/mix.md"><code>36be428</code></a> —  RFC Refactor: Sphinx Packet Format (#173)</li>
<li><strong>2025-06-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/5e3b4788ec1c0ec07535efe321b103d52b118db5/vac/raw/mix.md"><code>5e3b478</code></a> —  RFC Refactor PR: Modular Rewrite of Mix Protocol Specification (#158)</li>
<li><strong>2025-06-02</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/db90adc94e9f69627dd1254159d33eb062f00867/vac/raw/mix.md"><code>db90adc</code></a> — Fix LaTeX errors (#163)</li>
<li><strong>2024-11-08</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/38fce27d33ff11fcf15f947a9985c86b297c71b6/vac/raw/mix.md"><code>38fce27</code></a> — typo fix</li>
<li><strong>2024-09-16</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/7f5276e18c16e644ba6645d20854ce6e6dd82aad/vac/raw/mix.md"><code>7f5276e</code></a> — libp2p Mix Protocol Spec Draft (#97)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-6"><a class="header" href="#abstract-6">Abstract</a></h2>
<p>The Mix Protocol defines a decentralized anonymous message routing layer for libp2p networks.
It enables sender anonymity by routing each message through a decentralized mix overlay network composed of participating libp2p nodes, known as mix nodes.
Each message is routed independently in a stateless manner, allowing other libp2p protocols to selectively anonymize messages without modifying their core protocol behavior.</p>
<h2 id="1-introduction"><a class="header" href="#1-introduction">1. Introduction</a></h2>
<p>The Mix Protocol is a custom libp2p protocol that defines a message-layer routing abstraction designed to provide sender anonymity in peer-to-peer systems built on the libp2p stack.
It addresses the absence of native anonymity primitives in libp2p by offering a modular, content-agnostic protocol that other libp2p protocols can invoke when anonymity is required.</p>
<p>This document describes the design, behavior, and integration of the Mix Protocol within the libp2p architecture.
Rather than replacing or modifying existing libp2p protocols, the Mix Protocol complements them by operating independently of connection state and protocol negotiation.
It is intended to be used as an optional anonymity layer that can be selectively applied on a per-message basis.</p>
<p>Integration with other libp2p protocols is handled through external interface components—the Mix Entry and Exit layers—which mediate between these protocols and the Mix Protocol instances.
These components allow applications to defer anonymity concerns to the Mix layer without altering their native semantics or transport assumptions.</p>
<p>The rest of this document describes the motivation for the protocol, defines relevant terminology, presents the protocol architecture, and explains how the Mix Protocol interoperates with the broader libp2p protocol ecosystem.</p>
<h2 id="2-terminology"><a class="header" href="#2-terminology">2. Terminology</a></h2>
<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="https://datatracker.ietf.org/doc/html/rfc2119">RFC 2119</a>.</p>
<p>The following terms are used throughout this specification:</p>
<ul>
<li>
<p><strong>Origin Protocol</strong>
A libp2p protocol (<em>e.g.,</em> Ping, GossipSub) that generates and receives the actual message payload.
The origin protocol MUST decide on a per-message basis whether to route the message through the Mix Protocol or not.</p>
</li>
<li>
<p><strong>Mix Node</strong>
A libp2p node that supports the Mix Protocol and participates in the mix network.
A mix node initiates anonymous routing when invoked with a message.
It also receives and processes Sphinx packets when selected as a hop in a mix path.</p>
</li>
<li>
<p><strong>Mix Path</strong>
A non-repeating sequence of mix nodes through which a Sphinx packet is routed across the mix network.</p>
</li>
<li>
<p><strong>Mixify</strong>
A per-message flag set by the origin protocol to indicate that a message should be routed using the Mix Protocol or not.
Only messages with mixify set are forwarded to the Mix Entry Layer. Other messages SHOULD be routed using the origin protocol's default behavior.
The phrases 'messages to be mixified', 'to mixify a message' and related variants are used informally throughout this document to refer to messages that either have the <code>mixify</code> flag set or are selected to have it set.</p>
</li>
<li>
<p><strong>Mix Entry Layer</strong>
A component that receives messages to be <em>mixified</em> from an origin protocol and forwards them to the local Mix Protocol instance.
The Entry Layer is external to the Mix Protocol.</p>
</li>
<li>
<p><strong>Mix Exit Layer</strong>
A component that receives decrypted messages from a Mix Protocol instance and delivers them to the appropriate origin protocol instance at the destination.
Like the Entry Layer, it is external to the Mix Protocol.</p>
</li>
<li>
<p><strong>Mixnet or Mix Network</strong>
A decentralized overlay network formed by all nodes that support the Mix Protocol.
It operates independently of libp2p's protocol-level routing and origin protocol behavior.</p>
</li>
<li>
<p><strong>Sphinx Packet</strong>
A cryptographic packet format used by the Mix Protocol to encapsulate messages.
It uses layered encryption to hide routing information and protect message contents as packets are forwarded hop-by-hop.
Sphinx packets are fixed-size and indistinguishable from one another, providing unlinkability and metadata protection.</p>
</li>
<li>
<p><strong>Initialization Vector (IV)</strong>
A fixed-length input used to initialize block ciphers to add randomness to the encryption process.
It ensures that encrypting the same plaintext with the same key produces different ciphertexts.
The IV is not secret but must be unique for each encryption.</p>
</li>
<li>
<p><strong>Single-Use Reply Block (SURB)</strong>
A pre-computed Sphinx header that encodes a return path back to the sender.
SURBs are generated by the sender and included in the Sphinx packet sent to the recipient.
It enables the recipient to send anonymous replies, without learning the sender's identity, the return path, or the forwarding delays.</p>
</li>
</ul>
<h2 id="3-motivation-and-background"><a class="header" href="#3-motivation-and-background">3. Motivation and Background</a></h2>
<p>libp2p enables modular peer-to-peer applications, but it lacks built-in support for sender anonymity.
Most protocols expose persistent peer identifiers, transport metadata, or traffic patterns that can be exploited to deanonymize users through passive observation or correlation.</p>
<p>While libp2p supports NAT traversal mechanisms such as Circuit Relay, these focus on connectivity rather than anonymity.
Relays may learn peer identities during stream setup and can observe traffic timing and volume, offering no protection against metadata analysis.</p>
<p>libp2p also supports a Tor transport for network-level anonymity, tunneling traffic through long-lived, encrypted circuits.
However, Tor relies on session persistence and is ill-suited for protocols requiring per-message unlinkability.</p>
<p>The Mix Protocol addresses this gap with a decentralized message routing layer based on classical mix network principles.
It applies layered encryption and per-hop delays to obscure both routing paths and timing correlations.
Each message is routed independently, providing resistance to traffic analysis and protection against metadata leakage</p>
<p>By decoupling anonymity from connection state and transport negotiation, the Mix Protocol offers a modular privacy abstraction that existing libp2p protocols can adopt without altering their core behavior.</p>
<p>To better illustrate the differences in design goals and threat models, the following subsection contrasts the Mix Protocol with Tor, a widely known anonymity system.</p>
<h3 id="31-comparison-with-tor"><a class="header" href="#31-comparison-with-tor">3.1 Comparison with Tor</a></h3>
<p>The Mix Protocol differs fundamentally from Tor in several ways:</p>
<ul>
<li>
<p><strong>Unlinkability</strong>: In the Mix Protocol, there is no direct connection between source and destination.
Each message is routed independently, eliminating correlation through persistent circuits.</p>
</li>
<li>
<p><strong>Delay-based mixing</strong>: Mix nodes introduce randomized delays (e.g., from an exponential distribution) before forwarding messages, making timing correlation significantly harder.</p>
</li>
<li>
<p><strong>High-latency focus</strong>: Tor prioritizes low-latency communication for interactive web traffic, whereas the Mix Protocol is designed for scenarios where higher latency is acceptable in exchange for stronger anonymity.</p>
</li>
<li>
<p><strong>Message-based design</strong>: Each message in the Mix Protocol is self-contained and independently routed.
No sessions or state are maintained between messages.</p>
</li>
<li>
<p><strong>Resistance to endpoint attacks</strong>: The Mix Protocol is less susceptible to certain endpoint-level attacks, such as traffic volume correlation or targeted probing, since messages are delayed, reordered, and unlinkable at each hop.</p>
</li>
</ul>
<p>To understand the underlying anonymity properties of the Mix Protocol, we next describe the core components of a mix network.</p>
<h2 id="4-mixing-strategy-and-packet-format"><a class="header" href="#4-mixing-strategy-and-packet-format">4. Mixing Strategy and Packet Format</a></h2>
<p>The Mix Protocol relies on two core design elements to achieve sender unlinkability and metadata protection:
a mixing strategy and a cryptographically secure mix packet format.</p>
<h3 id="41-mixing-strategy"><a class="header" href="#41-mixing-strategy">4.1 Mixing Strategy</a></h3>
<p>A mixing strategy defines how mix nodes delay and reorder incoming packets to resist timing correlation and input-output linkage.
Two commonly used approaches are batch-based mixing and continuous-time mixing.</p>
<p>In batching-based mixing, each mix node collects incoming packets over a fixed or adaptive interval, shuffles them, and forwards them in a batch.
While this provides some unlinkability, it introduces high latency, requires synchronized flushing rounds, and may result in bursty output traffic.
Anonymity is bounded by the batch size, and performance may degrade under variable message rates.</p>
<p>The Mix Protocol instead uses continuous-time mixing, where each mix node applies a randomized delay to every incoming packet, typically drawn from an exponential distribution.
This enables theoretically unbounded anonymity sets, since any packet may, with non-zero probability, be delayed arbitrarily long.
In practice, the distribution is truncated once the probability of delay falls below a negligible threshold.
Continuous-time mixing also offers improved bandwidth utilization and smoother output traffic compared to batching-based approaches.</p>
<p>To make continuous-time mixing tunable and predictable, the sender MUST select the mean delay for each hop and encode it into the Sphinx packet header.
This allows top-level applications to balance latency and anonymity according to their requirements.</p>
<h3 id="42-mix-packet-format"><a class="header" href="#42-mix-packet-format">4.2 Mix Packet Format</a></h3>
<p>A mix packet format defines how messages are encapsulated and routed through a mix network.
It must ensure unlinkability between incoming and outgoing packets, prevent metadata leakage (e.g., path length, hop position, or payload size), and support uniform processing by mix nodes regardless of direction or content.</p>
<p>The Mix Protocol uses <a href="https://cypherpunks.ca/~iang/pubs/Sphinx_Oakland09.pdf">Sphinx packets</a> to meet these goals.
Each message is encrypted in layers corresponding to the selected mix path.
As a packet traverses the network, each mix node removes one encryption layer to obtain the next hop and delay, while the remaining payload remains encrypted and indistinguishable.</p>
<p>Sphinx packets are fixed in size and bit-wise unlinkable.
This ensures that they appear identical on the wire regardless of payload, direction, or route length, reducing opportunities for correlation based on packet size or format.
Even mix nodes learn only the immediate routing information and the delay to be applied.
They do not learn their position in the path or the total number of hops.</p>
<p>The packet format is resistant to tagging and replay attacks and is compact and efficient to process.
Sphinx packets also include per-hop integrity checks and enforces a maximum path length.
Together with a constant-size header and payload, this provides bounded protection against endless routing and malformed packet propagation.</p>
<p>It also supports anonymous and indistinguishable reply messages through <a href="https://cypherpunks.ca/~iang/pubs/Sphinx_Oakland09.pdf">Single-Use Reply Blocks (SURBs)</a>, although reply support is not implemented yet.</p>
<p>A complete specification of the Sphinx packet structure and fields is provided in [Section 6].</p>
<h2 id="5-protocol-overview"><a class="header" href="#5-protocol-overview">5. Protocol Overview</a></h2>
<p>The Mix Protocol defines a decentralized, message-based routing layer that provides sender anonymity within the libp2p framework.
It is agnostic to message content and semantics.
Each message is treated as an opaque payload, wrapped into a <a href="https://cypherpunks.ca/~iang/pubs/Sphinx_Oakland09.pdf">Sphinx packet</a> and routed independently through a randomly selected mix path.
Along the path, each mix node removes one layer of encryption, adds a randomized delay, and forwards the packet to the next hop.
This combination of layered encryption and per-hop delay provides resistance to traffic analysis and enables message-level unlinkability.</p>
<p>Unlike typical custom libp2p protocols, the Mix Protocol is stateless—it does not establish persistent streams, negotiate protocols, or maintain sessions.
Each message is self-contained and routed independently.</p>
<p>The Mix Protocol sits above the transport layer and below the protocol layer in the libp2p stack.
It provides a modular anonymity layer that other libp2p protocols MAY invoke selectively on a per-message basis.</p>
<p>Integration with other libp2p protocols is handled through external components that mediate between the origin protocol and the Mix Protocol instances.
This enables selective anonymous routing without modifying protocol semantics or internal behavior.</p>
<p>The following subsections describe how the Mix Protocol integrates with origin protocols via the Mix Entry and Exit layers, how per-message anonymity is controlled through the <code>mixify</code> flag, the rationale for defining Mix as a protocol rather than a transport, and the end-to-end message interaction flow.</p>
<h3 id="51-integration-with-origin-protocols"><a class="header" href="#51-integration-with-origin-protocols">5.1 Integration with Origin Protocols</a></h3>
<p>libp2p protocols that wish to anonymize messages MUST do so by integrating with the Mix Protocol via the Mix Entry and Exit layers.</p>
<ul>
<li>
<p>The <strong>Mix Entry Layer</strong> receives messages to be <em>mixified</em> from an origin protocol and forwards them to the local Mix Protocol instance.</p>
</li>
<li>
<p>The <strong>Mix Exit Layer</strong> receives the final decrypted message from a Mix Protocol instance and forwards it to the appropriate origin protocol instance at the destination over a client-only connection.</p>
</li>
</ul>
<p>This integration is external to the Mix Protocol and is not handled by mix nodes themselves.</p>
<h3 id="52-mixify-option"><a class="header" href="#52-mixify-option">5.2 Mixify Option</a></h3>
<p>Some origin protocols may require selective anonymity, choosing to anonymize <em>only</em> certain messages based on their content, context, or destination.
For example, a protocol may only anonymize messages containing sensitive metadata while delivering others directly to optimize performance.</p>
<p>To support this, origin protocols MAY implement a per-message <code>mixify</code> flag that indicates whether a message should be routed using the Mix Protocol.</p>
<ul>
<li>If the flag is set, the message MUST be handed off to the Mix Entry Layer for anonymous routing.</li>
<li>If the flag is not set, the message SHOULD be routed using the origin protocol's default mechanism.</li>
</ul>
<p>This design enables protocols to invoke the Mix Protocol only for selected messages, providing fine-grained control over privacy and performance trade-offs.</p>
<h3 id="53-why-a-protocol-not-a-transport"><a class="header" href="#53-why-a-protocol-not-a-transport">5.3 Why a Protocol, Not a Transport</a></h3>
<p>The Mix Protocol is specified as a custom libp2p protocol rather than a transport to support selective anonymity while remaining compatible with libp2p's architecture.</p>
<p>As noted in <a href="vac/raw/mix.html#52-mixify-option">Section 5.2</a>, origin protocols may anonymize only specific messages based on content or context.
Supporting such selective behavior requires invoking Mix on a per-message basis.</p>
<p>libp2p transports, however, are negotiated per peer connection and apply globally to all messages exchanged between two peers.
Enabling selective anonymity at the transport layer would therefore require changes to libp2p's core transport semantics.</p>
<p>Defining Mix as a protocol avoids these constraints and offers several benefits:</p>
<ul>
<li>Supports selective invocation on a per-message basis.</li>
<li>Works atop existing secure transports (<em>e.g.,</em> QUIC, TLS) without requiring changes to the transport stack.</li>
<li>Preserves a stateless, content-agnostic model focused on anonymous message routing.</li>
<li>Integrates seamlessly with origin protocols via the Mix Entry and Exit layers.</li>
</ul>
<p>This design preserves the modularity of the libp2p stack and allows Mix to be adopted without altering existing transport or protocol behavior.</p>
<h3 id="54-protocol-interaction-flow"><a class="header" href="#54-protocol-interaction-flow">5.4 Protocol Interaction Flow</a></h3>
<p>A typical end-to-end Mix Protocol flow consists of the following three conceptual phases.
Only the second phase—the anonymous routing performed by mix nodes—is part of the core Mix Protocol.
The entry-side and exit-side integration steps are handled externally by the Mix Entry and Exit layers.</p>
<ol>
<li>
<p><strong>Entry-side Integration (Mix Entry Layer):</strong></p>
<ul>
<li>The origin protocol generates a message and sets the <code>mixify</code> flag.</li>
<li>The message is passed to the Mix Entry Layer, which invokes the local Mix Protocol instance with the message, destination, and origin protocol codec as input.</li>
</ul>
</li>
<li>
<p><strong>Anonymous Routing (Core Mix Protocol):</strong></p>
<ul>
<li>The Mix Protocol instance wraps the message in a Sphinx packet and selects a random mix path.</li>
<li>Each mix node along the path:
<ul>
<li>Processes the Sphinx packet by removing one encryption layer.</li>
<li>Applies a delay and forwards the packet to the next hop.</li>
</ul>
</li>
<li>The final node in the path (exit node) decrypts the final layer, extracting the original plaintext message, destination, and origin protocol codec.</li>
</ul>
</li>
<li>
<p><strong>Exit-side Integration (Mix Exit Layer):</strong></p>
<ul>
<li>The Mix Exit Layer receives the plaintext message, destination, and origin protocol codec.</li>
<li>It routes the message to the destination origin protocol instance using a client-only connection.</li>
</ul>
</li>
</ol>
<p>The destination node does not need to support the Mix Protocol to receive or respond to anonymous messages.</p>
<p>The behavior described above represents the core Mix Protocol.
In addition, the protocol supports a set of pluggable components that extend its functionality.
These components cover areas such as node discovery, delay strategy, spam resistance, cover traffic generation, and incentivization.
Some are REQUIRED for interoperability; others are OPTIONAL or deployment-specific.
The next section describes each component.</p>
<h3 id="55-stream-management-and-multiplexing"><a class="header" href="#55-stream-management-and-multiplexing">5.5 Stream Management and Multiplexing</a></h3>
<p>Each Mix Protocol message is routed independently, and forwarding it to the next hop requires opening a new libp2p stream using the Mix Protocol.
This applies to both the initial Sphinx packet transmission and each hop along the mix path.</p>
<p>In high-throughput environments (<em>e.g.</em>, messaging systems with continuous anonymous traffic), mix nodes may frequently communicate with a subset of mix nodes.
Opening a new stream for each Sphinx packet in such scenarios can incur performance costs, as each stream setup requires a multistream handshake for protocol negotiation.</p>
<p>While libp2p supports multiplexing multiple streams over a single transport connection using stream muxers such as mplex and yamux, it does not natively support reusing the same stream over multiple message transmissions.
However, stream reuse may be desirable in the mixnet setting to reduce overhead and avoid hitting per protocol stream limits between peers.</p>
<p>The lifecycle of streams, including their reuse, eviction, or pooling strategy, is outside the scope of this specification.
It SHOULD be handled by the libp2p host, connection manager, or transport stack.</p>
<p>Mix Protocol implementations MUST NOT assume persistent stream availability and SHOULD gracefully fall back to opening a new stream when reuse is not possible.</p>
<h2 id="6-pluggable-components"><a class="header" href="#6-pluggable-components">6. Pluggable Components</a></h2>
<p>Pluggable components define functionality that extends or configures the behavior of the Mix Protocol beyond its core message routing logic.
Each component in this section falls into one of two categories:</p>
<ul>
<li>Required for interoperability and path construction (<em>e.g.,</em> discovery, delay strategy).</li>
<li>Optional or deployment-specific (<em>e.g.,</em> spam protection, cover traffic, incentivization).</li>
</ul>
<p>The following subsections describe the role and expected behavior of each.</p>
<h3 id="61-discovery"><a class="header" href="#61-discovery">6.1 Discovery</a></h3>
<p>The Mix Protocol does not mandate a specific peer discovery mechanism.
However, nodes participating in the mixnet MUST be discoverable so that other nodes can construct routing paths that include them.</p>
<p>To enable this, regardless of the discovery mechanism used, each mix node MUST make the following information available to peers:</p>
<ul>
<li>Indicate Mix Protocol support (<em>e.g.,</em> using a <code>mix</code> field or bit).</li>
<li>Its X25519 public key for Sphinx encryption.</li>
<li>One or more routable libp2p multiaddresses that identify the mix node's own network endpoints.</li>
</ul>
<p>To support sender anonymity at scale, discovery mechanism SHOULD support <em>unbiased random sampling</em> from the set of live mix nodes.
This enables diverse path construction and reduces exposure to adversarial routing bias.</p>
<p>While no existing mechanism provides unbiased sampling by default, <a href="https://rfc.vac.dev/waku/standards/core/33/discv5/">Waku's ambient discovery</a>—an extension over <a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5.md">Discv5</a>—demonstrates an approximate solution.
It combines topic-based capability advertisement with periodic peer sampling.
A similar strategy could potentially be adapted for the Mix Protocol.</p>
<p>A more robust solution would involve integrating capability-aware discovery directly into the libp2p stack, such as through extensions to <code>libp2p-kaddht</code>.
This would enable direct lookup of mix nodes based on protocol support and eliminate reliance on external mechanisms such as Discv5.
Such an enhancement remains exploratory and is outside the scope of this specification.</p>
<p>Regardless of the mechanism, the goal is to ensure mix nodes are discoverable and that path selection is resistant to bias and node churn.</p>
<h3 id="62-delay-strategy"><a class="header" href="#62-delay-strategy">6.2 Delay Strategy</a></h3>
<p>The Mix Protocol uses per-hop delay as a core mechanism for achieving timing unlinkability.
For each hop in the mix path, the sender MUST specify a mean delay value, which is embedded in the Sphinx packet header.
The mix node at each hop uses this value to sample a randomized delay before forwarding the packet.</p>
<p>By default, delays are sampled from an exponential distribution.
This supports continuous-time mixing, produces smooth output traffic, and enables tunable trade-offs between latency and anonymity.
Importantly, it allows for unbounded anonymity sets: each packet may, with non-zero probability, be delayed arbitrarily long.</p>
<p>The delay strategy is considered pluggable, and other distributions MAY be used to match application-specific anonymity or performance requirements.
However, any delay strategy MUST ensure that:</p>
<ul>
<li>Delays are sampled independently at each hop.</li>
<li>Delay sampling introduces sufficient variability to obscure timing correlation between packet arrival and forwarding across multiple hops.</li>
</ul>
<p>Strategies that produce deterministic or tightly clustered output delays are NOT RECOMMENDED, as they increase the risk of timing correlation.
Delay strategies SHOULD introduce enough uncertainty to prevent adversaries from linking packet arrival and departure times, even when monitoring multiple hops concurrently.</p>
<h3 id="63-spam-protection"><a class="header" href="#63-spam-protection">6.3 Spam Protection</a></h3>
<p>The Mix Protocol supports optional spam protection mechanisms to defend recipients against abusive or unsolicited traffic.
These mechanisms are applied at the exit node, which is the final node in the mix path before the message is delivered to its destination via the respective libp2p protocol.</p>
<p>Exit nodes that enforce spam protection MUST validate the attached proof before forwarding the message.
If validation fails, the message MUST be discarded.</p>
<p>Common strategies include Proof of Work (PoW), Verifiable Delay Functions (VDFs), and Rate-limiting Nullifiers (RLNs).</p>
<p>The sender is responsible for appending the appropriate spam protection data (e.g., nonce, timestamp) to the message payload.
The format and verification logic depend on the selected method.
An example using PoW is included in Appendix A.</p>
<p>Note:
The spam protection mechanisms described above are intended to protect the destination application or protocol from message abuse or flooding.
They do not provide protection against denial-of-service (DoS) or resource exhaustion attacks targeting the mixnet itself (<em>e.g.,</em> flooding mix nodes with traffic, inducing processing overhead, or targeting bandwidth).</p>
<p>Protections against attacks targeting the mixnet itself are not defined in this specification but are critical to the long-term robustness of the system.
Future versions of the protocol may define mechanisms to rate-limit clients, enforce admission control, or incorporate incentives and accountability to defend the mixnet itself from abuse.</p>
<h3 id="64-cover-traffic"><a class="header" href="#64-cover-traffic">6.4 Cover Traffic</a></h3>
<p>Cover traffic is an optional mechanism used to improve privacy by making the presence or absence of actual messages indistinguishable to observers.
It helps achieve <em>unobservability</em> where a passive adversary cannot determine whether a node is sending real messages or not.</p>
<p>In the Mix Protocol, cover traffic is limited to <em>loop messages</em>—dummy Sphinx packets that follow a valid mix path and return to the originating node.
These messages carry no application payload but are indistinguishable from real messages in structure, size, and routing behavior.</p>
<p>Cover traffic MAY be generated by either mix nodes or senders.
The strategy for generating such traffic—such as timing and frequency—is pluggable and not specified in this document.</p>
<p>Implementations that support cover traffic SHOULD generate loop messages at randomized intervals.
This helps mask actual sending behavior and increases the effective anonymity set.
Timing strategies such as Poisson processes or exponential delays are commonly used, but the choice is left to the implementation.</p>
<p>In addition to enhancing privacy, loop messages can be used to assess network liveness or path reliability without requiring explicit acknowledgments.</p>
<h3 id="65-incentivization"><a class="header" href="#65-incentivization">6.5 Incentivization</a></h3>
<p>The Mix Protocol supports a simple tit-for-tat model to discourage free-riding and promote mix node participation.
In this model, nodes that wish to send anonymous messages using the Mix Protocol MUST also operate a mix node.
This requirement ensures that participants contribute to the anonymity set they benefit from, fostering a minimal form of fairness and reciprocity.</p>
<p>This tit-for-tat model is intentionally lightweight and decentralized.
It deters passive use of the mixnet by requiring each user to contribute bandwidth and processing capacity.
However, it does not guarantee the quality of service provided by participating nodes.
For example, it does not prevent nodes from running low-quality or misbehaving mix instances, nor does it deter participation by compromised or transient peers.</p>
<p>The Mix Protocol does not mandate any form of payment, token exchange, or accounting.
More sophisticated economic models—such as stake-based participation, credentialed relay networks, or zero-knowledge proof-of-contribution systems—MAY be layered on top of the protocol or enforced via external coordination.</p>
<p>Additionally, network operators or application-layer policies MAY require nodes to maintain minimum uptime, prove their participation, or adhere to service-level guarantees.</p>
<p>While the Mix Protocol defines a minimum participation requirement, additional incentivization extensions are considered pluggable and experimental in this version of the specification.
No specific mechanism is standardized.</p>
<h2 id="7-core-mix-protocol-responsibilities"><a class="header" href="#7-core-mix-protocol-responsibilities">7. Core Mix Protocol Responsibilities</a></h2>
<p>This section defines the core routing behavior of the Mix Protocol, which all conforming implementations MUST support.</p>
<p>The Mix Protocol defines the logic for anonymously routing messages through the decentralized mix network formed by participating libp2p nodes.
Each mix node MUST implement support for:</p>
<ul>
<li>initiating anonymous routing when invoked with a message.</li>
<li>receiving and processing Sphinx packets when selected as a hop in a mix path.</li>
</ul>
<p>These roles and their required behaviors are defined in the following subsections.</p>
<h3 id="71-protocol-identifier"><a class="header" href="#71-protocol-identifier">7.1 Protocol Identifier</a></h3>
<p>The Mix Protocol is identified by the protocol string <code>"/mix/1.0.0"</code>.</p>
<p>All Mix Protocol interactions occur over libp2p streams negotiated using this identifier.
Each Sphinx packet transmission—whether initiated locally or forwarded as part of a mix path—involves opening a new libp2p stream to the next hop.
Implementations MAY optimize performance by reusing streams where appropriate;
see <a href="vac/raw/mix.html#55-stream-management-and-multiplexing">Section 5.5</a> for more details on stream management.</p>
<h3 id="72-initiation"><a class="header" href="#72-initiation">7.2 Initiation</a></h3>
<p>A mix node initiates anonymous routing only when it is explicitly invoked with a message to be routed.
As specified in <a href="vac/raw/mix.html#52-mixify-option">Section 5.2</a>, the decision to anonymize a message is made by the origin protocol.
When anonymization is required, the origin protocol instance forwards the message to the Mix Entry Layer, which then passes the message to the local Mix Protocol instance for routing.</p>
<p>To perform message initiation, a mix node MUST:</p>
<ul>
<li>Select a random mix path.</li>
<li>Assign a delay value for each hop and encode it into the Sphinx packet header.</li>
<li>Wrap message in a Sphinx packet by applying layered encryption in reverse order of nodes in the selected mix path.</li>
<li>Forward the resulting packet to the first mix node in the mix path using the Mix Protocol.</li>
</ul>
<p>The Mix Protocol does not interpret message content or origin protocol context.
Each invocation is stateless, and the implementation MUST NOT retain routing metadata or per-message state after the packet is forwarded.</p>
<h3 id="73-sphinx-packet-receiving-and-processing"><a class="header" href="#73-sphinx-packet-receiving-and-processing">7.3 Sphinx Packet Receiving and Processing</a></h3>
<p>A mix node that receives a Sphinx packet is oblivious to its position in the path.
The first hop is indistinguishable from other intermediary hops in terms of processing and behavior.</p>
<p>After decrypting one layer of the Sphinx packet, the node MUST inspect the routing information.
If this layer indicates that the next hop is the final destination, the packet MUST be processed as an exit.
Otherwise, it MUST be processed as an intermediary.</p>
<h4 id="731-intermediary-processing"><a class="header" href="#731-intermediary-processing">7.3.1 Intermediary Processing</a></h4>
<p>To process a Sphinx packet as an intermediary, a mix node MUST:</p>
<ul>
<li>Extract the next hop address and associated delay from the decrypted packet.</li>
<li>Wait for the specified delay.</li>
<li>Forward the updated packet to the next hop using the Mix Protocol.</li>
</ul>
<p>A mix node performing intermediary processing MUST treat each packet as stateless and self-contained.</p>
<h4 id="732-exit-processing"><a class="header" href="#732-exit-processing">7.3.2 Exit Processing</a></h4>
<p>To process a Sphinx packet as an exit, a mix node MUST:</p>
<ul>
<li>Extract the plaintext message from the final decrypted packet.</li>
<li>Validate any attached spam protection proof.</li>
<li>Discard the message if spam protection validation fails.</li>
<li>Forward the valid message to the Mix Exit Layer for delivery to the destination origin protocol instance.</li>
</ul>
<p>The node MUST NOT retain decrypted content after forwarding.</p>
<p>The routing behavior described in this section relies on the use of Sphinx packets to preserve unlinkability and confidentiality across hops.
The next section specifies their structure, cryptographic components, and construction.</p>
<h2 id="8-sphinx-packet-format"><a class="header" href="#8-sphinx-packet-format">8. Sphinx Packet Format</a></h2>
<p>The Mix Protocol uses the Sphinx packet format to enable unlinkable, multi-hop message routing with per-hop confidentiality and integrity.
Each message transmitted through the mix network is encapsulated in a Sphinx packet constructed by the initiating mix node.
The packet is encrypted in layers such that each hop in the mix path can decrypt exactly one layer and obtain the next-hop routing information and forwarding delay, without learning the complete path or the message origin.
Only the final hop learns the destination, which is encoded in the innermost routing layer.</p>
<p>Sphinx packets are self-contained and indistinguishable on the wire, providing strong metadata protection.
Mix nodes forward packets without retaining state or requiring knowledge of the source or destination beyond their immediate routing target.</p>
<p>To ensure uniformity, each Sphinx packet consists of a fixed-length header and a payload that is padded to a fixed maximum size.
Although the original message payload may vary in length, padding ensures that all packets are identical in size on the wire.
This ensures unlinkability and protects against correlation attacks based on message size.</p>
<p>If a message exceeds the maximum supported payload size, it MUST be fragmented before being passed to the Mix Protocol.
Fragmentation and reassembly are the responsibility of the origin protocol or the top-level application.
The Mix Protocol handles only messages that do not require fragmentation.</p>
<p>The structure, encoding, and size constraints of the Sphinx packet are detailed in the following subsections.</p>
<h3 id="81-packet-structure-overview"><a class="header" href="#81-packet-structure-overview">8.1 Packet Structure Overview</a></h3>
<p>Each Sphinx packet consists of three fixed-length header fields— $α$, $β$, and $γ$ —followed by a fixed-length encrypted payload $δ$.
Together, these components enable per-hop message processing with strong confidentiality and integrity guarantees in a stateless and unlinkable manner.</p>
<ul>
<li><strong>$α$ (Alpha)</strong>: An ephemeral public value. Each mix node uses its private key and $α$ to derive a shared session key for that hop. This session key is used to decrypt and process one layer of the packet.</li>
<li><strong>$β$ (Beta)</strong>: The nested encrypted routing information. It encodes the next hop address, the forwarding delay, integrity check $γ$ for the next hop, and the $β$ for subsequent hops. At the final hop, $β$ encodes the destination address and fixed-length zero padding to preserve uniform size.</li>
<li><strong>$γ$ (Gamma)</strong>: A message authentication code computed over $β$ using the session key derived from $α$. It ensures header integrity at each hop.</li>
<li><strong>$δ$ (Delta)</strong>: The encrypted payload. It consists of the message padded to a fixed maximum length and encrypted in layers corresponding to each hop in the mix path.</li>
</ul>
<p>At each hop, the mix node derives the session key from $α$, verifies the header integrity using $γ$, decrypts one layer of $β$ to extract the next hop and delay, and decrypts one layer of $δ$.
It then constructs a new packet with updated values of $α$, $β$, $γ$, and $δ$, and forwards it to the next hop.
At the final hop, the mix node decrypts the innermost layer of $β$ and $δ$, which yields the destination address and the original application message respectively.</p>
<p>All Sphinx packets are fixed in size and indistinguishable on the wire.
This uniform format, combined with layered encryption and per-hop integrity protection, ensures unlinkability, tamper resistance, and robustness against correlation attacks.</p>
<p>The structure and semantics of these fields, the cryptographic primitives used, and the construction and processing steps are defined in the following subsections.</p>
<h3 id="82-cryptographic-primitives"><a class="header" href="#82-cryptographic-primitives">8.2 Cryptographic Primitives</a></h3>
<p>This section defines the cryptographic primitives used in Sphinx packet construction and processing.</p>
<ul>
<li>
<p><strong>Security Parameter</strong>: All cryptographic operations target a minimum of $κ = 128$ bits of security, balancing performance with resistance to modern attacks.</p>
</li>
<li>
<p><strong>Elliptic Curve Group $\mathbb{G}$</strong>:</p>
<ul>
<li><strong>Curve</strong>: Curve25519</li>
<li><strong>Notation</strong>: Let $g$ denote the canonical base point (generator) of $\mathbb{G}$.</li>
<li><strong>Purpose</strong>: Used for deriving Diffie–Hellman-style shared key at each hop using $α$.</li>
<li><strong>Representation</strong>: Small 32-byte group elements, efficient for both encryption and key exchange.</li>
<li><strong>Scalar Field</strong>: The curve is defined over the finite field $\mathbb{Z}_q$, where $q = 2^{252} + 27742317777372353535851937790883648493$. Ephemeral exponents used in Sphinx packet construction are selected uniformly at random from $\mathbb{Z}_q^*$, the multiplicative subgroup of $\mathbb{Z}_q$.</li>
</ul>
</li>
<li>
<p><strong>Hash Function</strong>:</p>
<ul>
<li><strong>Construction</strong>: SHA-256</li>
<li><strong>Notation</strong>: The hash function is denoted by $H(\cdot)$ in subsequent sections.</li>
</ul>
</li>
<li>
<p><strong>Key Derivation Function (KDF)</strong>:</p>
<ul>
<li><strong>Purpose</strong>: To derive encryption keys, IVs, and MAC key from the shared session key at each hop.</li>
<li><strong>Construction</strong>: SHA-256 hash with output truncated to $128$ bits.</li>
<li><strong>Key Derivation</strong>: The KDF key separation labels (<em>e.g.,</em> <code>"aes_key"</code>, <code>"mac_key"</code>) are fixed strings and MUST be agreed upon across implementations.</li>
</ul>
</li>
<li>
<p><strong>Symmetric Encryption</strong>: AES-128 in Counter Mode (AES-CTR)</p>
<ul>
<li><strong>Purpose</strong>: To encrypt $β$ and $δ$ for each hop.</li>
<li><strong>Keys and IVs</strong>: Each derived from the session key for the hop using the KDF.</li>
</ul>
</li>
<li>
<p><strong>Message Authentication Code (MAC)</strong>:</p>
<ul>
<li><strong>Construction</strong>: HMAC-SHA-256 with output truncated to $128$ bits.</li>
<li><strong>Purpose</strong>: To compute $γ$ for each hop.</li>
<li><strong>Key</strong>: Derived using KDF from the session key for the hop.</li>
</ul>
</li>
</ul>
<p>These primitives are used consistently throughout packet construction and decryption, as described in the following sections.</p>
<h3 id="83-packet-component-sizes"><a class="header" href="#83-packet-component-sizes">8.3 Packet Component Sizes</a></h3>
<p>This section defines the size of each component in a Sphinx packet, deriving them from the security parameter and protocol parameters introduced earlier.
All Sphinx packets MUST be fixed in length to ensure uniformity and indistinguishability on the wire.
The serialized packet is structured as follows:</p>
<pre><code class="language-text">+--------+----------+--------+----------+
|   α    |     β    |   γ    |    δ     |
| 32 B   | variable | 16 B   | variable |
+--------+----------+--------+----------+
</code></pre>
<h4 id="831-header-field-sizes"><a class="header" href="#831-header-field-sizes">8.3.1 Header Field Sizes</a></h4>
<p>The header consists of the fields $α$, $β$, and $γ$, totaling a fixed size per maximum path length:</p>
<ul>
<li>
<p><strong>$α$ (Alpha)</strong>: 32 bytes
The size of $α$ is determined by the elliptic curve group representation used (Curve25519), which encodes group elements as 32-byte values.</p>
</li>
<li>
<p><strong>$β$ (Beta)</strong>: $((t + 1)r + 1)κ$ bytes
The size of $β$ depends on:</p>
<ul>
<li>
<p><strong>Maximum path length ($r$)</strong>: The recommended value of $r=5$ balances bandwidth versus anonymity tradeoffs.</p>
</li>
<li>
<p><strong>Combined address and delay width ($tκ$)</strong>: The recommended $t=6$ accommodates standard libp2p relay multiaddress representations plus a 2-byte delay field. While the actual multiaddress and delay fields may be shorter, they are padded to $tκ$ bytes to maintain fixed field size. The structure and rationale for the $tκ$ block and its encoding are specified in <a href="vac/raw/mix.html#84-address-and-delay-encoding">Section 8.4</a>.</p>
<p>Note:
This expands on the original <a href="vac/raw/(https://cypherpunks.ca/~iang/pubs/Sphinx_Oakland09.pdf)">Sphinx packet format</a>, which embeds a fixed $κ$-byte mix node identifier per hop in $β$.
The Mix Protocol generalizes this to $tκ$ bytes to accommodate libp2p multiaddresses and forwarding delays while preserving the cryptographic properties of the original design.</p>
</li>
<li>
<p><strong>Per-hop $γ$ size ($κ$)</strong> (defined below): Accounts for the integrity tag included with each hop's routing information.</p>
</li>
</ul>
<p>Using the recommended value of $r=5$ and $t=6$, the resulting $β$ size is $576$ bytes.
At the final hop, $β$ encodes the destination address in the first $tκ-2$ bytes and the remaining bytes are zero-padded.</p>
</li>
<li>
<p><strong>$γ$ (Gamma)</strong>: $16$ bytes
The size of $γ$ equals the security parameter $κ$, providing a $κ$-bit integrity tag at each hop.</p>
</li>
</ul>
<p>Thus, the total header length is:</p>
<p>$<code>\begin{aligned} |Header| &amp;= α + β + γ \\   &amp;= 32 + ((t + 1)r + 1)κ + 16 \end{aligned}</code>$</p>
<p>Notation: $|x|$ denotes the size (in bytes) of field $x$.</p>
<p>Using the recommended value of $r = 5$ and $t = 6$, the header size is:</p>
<p>$<code>\begin{aligned} |Header| &amp;= 32 + 576 + 16 \\   &amp;= 624 \ bytes \end{aligned}</code>$</p>
<h4 id="832-payload-size"><a class="header" href="#832-payload-size">8.3.2 Payload Size</a></h4>
<p>This subsection defines the size of the encrypted payload $δ$ in a Sphinx packet.</p>
<p>$δ$ contains the application message, padded to a fixed maximum length to ensure all packets are indistinguishable on the wire.
The size of $δ$ is calculated as:</p>
<p>$<code>\begin{aligned} |δ| &amp;= TotalPacketSize - HeaderSize \end{aligned}</code>$</p>
<p>The recommended total packet size is $4608$ bytes, chosen to:</p>
<ul>
<li>Accommodate larger libp2p application messages, such as those commonly observed in Status chat using Waku (typically ~4KB payloads),</li>
<li>Allow inclusion of additional data such as SURBs without requiring fragmentation,</li>
<li>Maintain reasonable per-hop processing and bandwidth overhead.</li>
</ul>
<p>This recommended total packet size of $4608$ bytes yields:</p>
<p>$<code>\begin{aligned} Payload &amp;= 4608 - 624 \\   &amp;= 3984\ bytes \end{aligned}</code>$</p>
<p>Implementations MUST account for payload extensions, such as SURBs, when determining the maximum message size that can be encapsulated in a single Sphinx packet.
Details on SURBs are defined in [Section X.X].</p>
<p>The following subsection defines the padding and fragmentation requirements for ensuring this fixed-size constraint.</p>
<h4 id="833-padding-and-fragmentation"><a class="header" href="#833-padding-and-fragmentation">8.3.3 Padding and Fragmentation</a></h4>
<p>Implementations MUST ensure that all messages shorter than the maximum payload size are padded before Sphinx encapsulation to ensure that all packets are indistinguishable on the wire.
Messages larger than the maximum payload size MUST be fragmented by the origin protocol or top-level application before being passed to the Mix Protocol.
Reassembly is the responsibility of the consuming application, not the Mix Protocol.</p>
<h4 id="834-anonymity-set-considerations"><a class="header" href="#834-anonymity-set-considerations">8.3.4 Anonymity Set Considerations</a></h4>
<p>The fixed maximum packet size is a configurable parameter.
Protocols or applications that choose to configure a different packet size (either larger or smaller than the default) MUST be aware that using unique or uncommon packet sizes can reduce their effective anonymity set to only other users of the same size.
Implementers SHOULD align with widely used defaults to maximize anonymity set size.</p>
<p>Similarly, parameters such as $r$ and $t$ are configurable.
Changes to these parameters affect header size and therefore impact payload size if the total packet size remains fixed.
However, if such changes alter the total packet size on the wire, the same anonymity set considerations apply.</p>
<p>The following subsection defines how the next-hop or destination address and forwarding delay are encoded within $β$ to enable correct routing and mixing behavior.</p>
<h3 id="84-address-and-delay-encoding"><a class="header" href="#84-address-and-delay-encoding">8.4 Address and Delay Encoding</a></h3>
<p>Each hop's $β$ includes a fixed-size block containing the next-hop address and the forwarding delay, except for the final hop, which encodes the destination address and a delay-sized zero padding.
This section defines the structure and encoding of that block.</p>
<p>The combined address and delay block MUST be exactly $tκ$ bytes in length, as defined in <a href="vac/raw/mix.html#831-header-field-sizes">Section 8.3.1</a>, regardless of the actual address or delay values.
The first $(tκ - 2)$ bytes MUST encode the address, and the final $2$ bytes MUST encode the forwarding delay.
This fixed-length encoding ensures that packets remain indistinguishable on the wire and prevents correlation attacks based on routing metadata structure.</p>
<p>Implementations MAY use any address and delay encoding format agreed upon by all participating mix nodes, as long as the combined length is exactly $tκ$ bytes.
The encoding format MUST be interpreted consistently by all nodes within a deployment.</p>
<p>For interoperability, a recommended default encoding format involves:</p>
<ul>
<li>
<p>Encoding the next-hop or destination address as a libp2p multi-address:</p>
<ul>
<li>To keep the address block compact while allowing relay connectivity, each mix node is limited to one IPv4 circuit relay multiaddress. This ensures that most nodes can act as mix nodes, including those behind NATs or firewalls.</li>
<li>In libp2p terms, this combines transport addresses with multiple peer identities to form an address that describes a relay circuit:
<code>/ip4/&lt;ipv4&gt;/tcp/&lt;port&gt;/p2p/&lt;relayPeerID&gt;/p2p-circuit/p2p/&lt;relayedPeerID&gt;</code>
Variants may include directly reachable peers and transports such as <code>/quic-v1</code>, depending on the mix node's supported stack.</li>
<li>IPv6 support is deferred, as it adds $16$ bytes just for the IP field.</li>
<li>Future revisions may extend this format to support IPv6 or DNS-based multiaddresses.</li>
</ul>
<p>With these constraints, the recommended encoding layout is:</p>
<ul>
<li>IPv4 address (4 bytes)</li>
<li>Protocol identifier <em>e.g.,</em> TCP or QUIC (1 byte)</li>
<li>Port number (2 bytes)</li>
<li>Peer IDs (39 bytes, post-Base58 decoding)</li>
</ul>
</li>
<li>
<p>Encoding the forwarding delay as an unsigned 16-bit integer (2 bytes), representing the mean delay in milliseconds for the configured delay distribution, using big endian network byte order.
The delay distribution is pluggable, as defined in <a href="vac/raw/mix.html#62-delay-strategy">Section 6.2</a>.</p>
</li>
</ul>
<p>If the encoded address or delay is shorter than its respective allocated field, it MUST be padded with zeros.
If it exceeds the allocated size, it MUST be rejected or truncated according to the implementation policy.</p>
<p>Note:
Future versions of the Mix Protocol may support address compression by encoding only the peer identifier and relying on external peer discovery mechanisms to retrieve full multiaddresses at runtime.
This would allow for more compact headers and greater address flexibility, but requires fast and reliable lookup support across deployments.
This design is out of scope for the current version.</p>
<p>With the field sizes and encoding conventions established, the next section describes how a mix node constructs a complete Sphinx packet when initiating the Mix Protocol.</p>
<h3 id="85-packet-construction"><a class="header" href="#85-packet-construction">8.5 Packet Construction</a></h3>
<p>This section defines how a mix node constructs a Sphinx packet when initiating the Mix Protocol on behalf of a local origin protocol instance.
The construction process wraps the message in a sequence of encryption layers—one for each hop—such that only the corresponding mix node can decrypt its layer and retrieve the routing instructions for that hop.</p>
<h4 id="851-inputs"><a class="header" href="#851-inputs">8.5.1 Inputs</a></h4>
<p>To initiate the Mix Protocol, the origin protocol instance submits a message to the Mix Entry Layer on the same node.
This layer forwards it to the local Mix Protocol instance, which constructs a Sphinx packet using the following REQUIRED inputs:</p>
<ul>
<li><strong>Application message</strong>: The serialized message provided by the origin protocol instance. The Mix Protocol instance applies any configured spam protection mechanism and attaches one or two SURBs prior to encapsulating the message in the Sphinx packet. The initiating node MUST ensure that the resulting payload size does not exceed the maximum supported size defined in <a href="vac/raw/mix.html#832-payload-size">Section 8.3.2</a>.</li>
<li><strong>Origin protocol codec</strong>: The libp2p protocol string corresponding to the origin protocol instance. This is included in the payload so that the exit node can route the message to the intended destination protocol after decryption.</li>
<li><strong>Mix Path length $L$</strong>: The number of mix nodes to include in the path. The mix path MUST consist of at least three hops, each representing a distinct mix node.</li>
<li><strong>Destination address $Δ$</strong>: The routing address of the intended recipient of the message. This address is encoded in $(tκ - 2)$ bytes as defined in <a href="vac/raw/mix.html#84-address-and-delay-encoding">Section 8.4</a> and revealed only at the last hop.</li>
</ul>
<h4 id="852-construction-steps"><a class="header" href="#852-construction-steps">8.5.2 Construction Steps</a></h4>
<p>This subsection defines how the initiating mix node constructs a complete Sphinx packet using the inputs defined in <a href="vac/raw/mix.html#851-inputs">Section 8.5.1</a>.
The construction MUST follow the cryptographic structure defined in <a href="vac/raw/mix.html#81-packet-structure-overview">Section 8.1</a>, use the primitives specified in <a href="vac/raw/mix.html#82-cryptographic-primitives">Section 8.2</a>, and adhere to the component sizes and encoding formats from <a href="vac/raw/mix.html#83-packet-component-sizes">Section 8.3</a> and <a href="vac/raw/mix.html#84-address-and-delay-encoding">Section 8.4</a>.</p>
<p>The construction MUST proceed as follows:</p>
<ol>
<li>
<p><strong>Prepare Application Message</strong></p>
<ul>
<li>Apply any configured spam protection mechanism (<em>e.g.,</em> PoW, VDF, RLN) to the serialized message. Spam protection mechanisms are pluggable as defined in <a href="vac/raw/mix.html#63-spam-protection">Section 6.3</a>.</li>
<li>Attach one or more SURBs, if required. Their format and processing are specified in [Section X.X].</li>
<li>Append the origin protocol codec in a format that enables the exit node to reliably extract it during parsing. A recommended encoding approach is to prefix the codec string with its length, encoded as a compact varint field limited to two bytes. Regardless of the scheme used, implementations MUST agree on the format within a deployment to ensure deterministic decoding.</li>
<li>Pad the result to the maximum application message length of $3968$ bytes using a deterministic padding scheme. This value is derived from the fixed payload size in <a href="vac/raw/mix.html#832-payload-size">Section 8.3.2</a> ($3984$ bytes) minus the security parameter $κ = 16$ bytes defined in <a href="vac/raw/mix.html#82-cryptographic-primitives">Section 8.2</a>. The chosen scheme MUST yield a fixed-size padded output and MUST be consistent across all mix nodes to ensure correct interpretation during unpadding. For example, schemes that explicitly encode the padding length and prepend zero-valued padding bytes MAY be used.</li>
<li>Let the resulting message be $m$.</li>
</ul>
</li>
<li>
<p><strong>Select A Mix Path</strong></p>
<ul>
<li>First obtain an unbiased random sample of live, routable mix nodes using some discovery mechanism. The choice of discovery mechanism is deployment-specific as defined in <a href="vac/raw/mix.html#61-discovery">Section 6.1</a>. The discovery mechanism MUST be unbiased and provide, at a minimum, the multiaddress and X25519 public key of each mix node.</li>
<li>From this sample, choose a random mix path of length $L \geq 3$. As defined in <a href="vac/raw/mix.html#2-terminology">Section 2</a>, a mix path is a non-repeating sequence of mix nodes.</li>
<li>For each hop $i \in {0 \ldots L-1}$:
<ul>
<li>Retrieve the multiaddress and corresponding X25519 public key $y_i$ of the $i$-th mix node.</li>
<li>Encode the multiaddress in $(tκ - 2)$ bytes as defined in <a href="vac/raw/mix.html#84-address-and-delay-encoding">Section 8.4</a>. Let the resulting encoded multiaddress be $\mathrm{addr_i}$.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Wrap Plaintext Payload In Sphinx Packet</strong></p>
<p>a. <strong>Compute Ephemeral Secrets</strong></p>
<ul>
<li>Choose a random private exponent $x \in_R \mathbb{Z}_q^*$.</li>
<li>Initialize:
$<code>\begin{aligned} α_0 &amp;= g^x \\ s_0 &amp;= y_0^x \\ b_0 &amp;= H(α_0\ |\ s_0) \end{aligned}</code>$</li>
<li>For each hop $i$ (from $1$ to $L-1$), compute:
$<code>\begin{aligned} α_i &amp;= α_{i-1}^{b_{i-1}} \\ s_i &amp;= y_{i}^{x\prod_{\text{j=0}}^{\text{i-1}} b_{j}} \\ b_i &amp;= H(α_i\ |\ s_i) \end{aligned}</code>$</li>
</ul>
<p>Note that the length of $α_i$ is $32$ bytes, $0 \leq i \leq L-1$ as defined in <a href="vac/raw/mix.html#831-header-field-sizes">Section 8.3.1</a>.</p>
<p>b. <strong>Compute Per-Hop Filler Strings</strong>
Filler strings are encrypted strings that are appended to the header during encryption.
They ensure that the header length remains constant across hops, regardless of the position of a node in the mix path.</p>
<p>To compute the sequence of filler strings, perform the following steps:</p>
<ul>
<li>
<p>Initialize $Φ_0 = \epsilon$ (empty string).</p>
</li>
<li>
<p>For each $i$ (from $1$ to $L-1$):</p>
<ul>
<li>
<p>Derive per-hop AES key and IV:</p>
<p>$<code>\begin{array}{l} Φ_{\mathrm{aes\_key}_{i-1}} = \mathrm{KDF}(\text{"aes\_key"} \mid s_{i-1})\\ Φ_{\mathrm{iv}_{i-1}} = \mathrm{KDF}(\text{"iv"} \mid s_{i-1}) \end{array}</code>$</p>
</li>
<li>
<p>Compute the filler string $Φ_i$ using $\text{AES-CTR}^\prime_i$, which is AES-CTR encryption with the keystream starting from index $((t+1)(r-i)+t+2)κ$ :</p>
<p>$<code>\begin{array}{l} Φ_i = \mathrm{AES\text{-}CTR}'_i\bigl(Φ_{\mathrm{aes\_key}_{i-1}}, Φ_{\mathrm{iv}_{i-1}}, Φ_{i-1} \mid 0_{(t+1)κ} \bigr), \\ \text{where } 0_x \text{ defines the string of } 0 \text{ bits of length } x\text{.} \end{array}</code>$</p>
</li>
</ul>
</li>
</ul>
<p>Note that the length of $Φ_i$ is $(t+1)iκ$, $0 \leq i \leq L-1$.</p>
<p>c. <strong>Construct Routing Header</strong>
The routing header as defined in <a href="vac/raw/mix.html#81-packet-structure-overview">Section 8.1</a> is the encrypted structure that carries the forwarding instructions for each hop.
It ensures that a mix node can learn only its immediate next hop and forwarding delay without inferring the full path.</p>
<p>Filler strings computed in the previous step are appended during encryption to ensure that the header length remains constant across hops.
This prevents a node from distinguishing its position in the path based on header size.</p>
<p>To construct the routing header, perform the following steps for each hop $i = L-1$ down to $0$, recursively:</p>
<ul>
<li>
<p>Derive per-hop AES key, MAC key, and IV:</p>
<p>$<code>\begin{array}{l} β_{\mathrm{aes\_key}_i} = \mathrm{KDF}(\text{"aes\_key"} \mid s_i)\\ \mathrm{mac\_key}_i = \mathrm{KDF}(\text{"mac\_key"} \mid s_{i})\\ β_{\mathrm{iv}_i} = \mathrm{KDF}(\text{"iv"} \mid s_i) \end{array}</code>$</p>
</li>
<li>
<p>Set the per hop two-byte encoded delay $\mathrm{delay}_i$ as defined in <a href="vac/raw/mix.html#84-address-and-delay-encoding">Section 8.4</a>:</p>
<ul>
<li>If final hop (<em>i.e.,</em> $i = L - 1$), encode two byte zero padding.</li>
<li>For all other hop $i$, $i &lt; L - 1$, select the mean forwarding delay for the delay strategy configured by the application, and encode it as a two-byte value. The delay strategy is pluggable, as defined in <a href="vac/raw/mix.html#62-delay-strategy">Section 6.2</a>.</li>
</ul>
</li>
<li>
<p>Using the derived keys and encoded forwarding delay, compute the nested encrypted routing information $β_i$:</p>
<ul>
<li>
<p>If $i = L-1$ (<em>i.e.,</em> exit node):</p>
<p>$<code>\begin{array}{l} β_i = \mathrm{AES\text{-}CTR}\bigl(β_{\mathrm{aes\_key}_i}, β_{\mathrm{iv}_i}, Δ \mid \mathrm{delay}_i \mid 0_{((t+1)(r-L)+2)κ} \bigr) \bigm| Φ_{L-1} \end{array}</code>$</p>
</li>
<li>
<p>Otherwise (<em>i.e.,</em> intermediary node):</p>
<p>$<code>\begin{array}{l} β_i = \mathrm{AES\text{-}CTR}\bigl(β_{\mathrm{aes\_key}_i}, β_{\mathrm{iv}_i}, \mathrm{addr}_{i+1} \mid \mathrm{delay}_i \mid γ_{i+1} \mid β_{i+1 \, [0 \ldots (r(t+1) - t)κ - 1]} \bigr),\\ \text{where notation } X_{[a \ldots b]} \text{ denotes the substring of } X \text{ from byte offset } a \text{ to } b\text{, inclusive, using zero-based indexing.} \end{array}</code>$</p>
</li>
</ul>
<p>Note that the length of $\beta_i$ is $(r(t+1)+1)κ$, $0 \leq i \leq L-1$ as defined in <a href="vac/raw/mix.html#831-header-field-sizes">Section 8.3.1</a>.</p>
<ul>
<li>
<p>Compute the message authentication code $γ_i$:</p>
<p>$<code>\begin{array}{l} γ_i = \mathrm{HMAC\text{-}SHA\text{-}256}\bigl(\mathrm{mac\_key}_i, β_i \bigr) \end{array}</code>$</p>
</li>
</ul>
<p>Note that the length of $\gamma_i$ is $κ$, $0 \leq i \leq L-1$ as defined in <a href="vac/raw/mix.html#831-header-field-sizes">Section 8.3.1</a>.</p>
</li>
</ul>
<p>d. <strong>Encrypt Payload</strong>
The encrypted payload $δ$ contains the message $m$ defined in Step 1, prepended with a $κ$-byte string of zeros.
It is encrypted in layers such that each hop in the mix path removes exactly one layer using the per-hop session key.
This ensures that only the final hop (<em>i.e.,</em> the exit node) can fully recover $m$, validate its integrity, and forward it to the destination.
To compute the encrypted payload, perform the following steps for each hop $i = L-1$ down to $0$, recursively:</p>
<ul>
<li>
<p>Derive per-hop AES key and IV:</p>
<p>$<code>\begin{array}{l} δ_{\mathrm{aes\_key}_i} = \mathrm{KDF}(\text{"δ\_aes\_key"} \mid s_i)\\ δ_{\mathrm{iv}_i} = \mathrm{KDF}(\text{"δ\_iv"} \mid s_i) \end{array}</code>$</p>
</li>
<li>
<p>Using the derived keys, compute the encrypted payload $δ_i$:</p>
<ul>
<li>
<p>If $i = L-1$ (<em>i.e.,</em> exit node):</p>
<p>$<code>\begin{array}{l} δ_i = \mathrm{AES\text{-}CTR}\bigl(δ_{\mathrm{aes\_key}_i}, δ_{\mathrm{iv}_i}, 0_{κ} \mid m \bigr) \end{array}</code>$</p>
</li>
<li>
<p>Otherwise (<em>i.e.,</em> intermediary node):</p>
<p>$<code>\begin{array}{l} δ_i = \mathrm{AES\text{-}CTR}\bigl(δ_{\mathrm{aes\_key}_i}, δ_{\mathrm{iv}_i}, δ_{i+1} \bigr) \end{array}</code>$</p>
</li>
</ul>
<p>Note that the length of $\delta_i$, $0 \leq i \leq L-1$ is $|m| + κ$ bytes.</p>
<p>Given that the derived size of $\delta_i$ is $3984$ bytes as defined in <a href="vac/raw/mix.html#832-payload-size">Section 8.3.2</a>, this allows $m$ to be of length $3984-16 = 3968$ bytes as defined in Step 1.</p>
</li>
</ul>
<p>e. <strong>Assemble Final Packet</strong>
The final Sphinx packet is structured as defined in <a href="vac/raw/mix.html#83-packet-component-sizes">Section 8.3</a>:</p>
<pre><code class="language-text">α = α_0      // 32 bytes
β = β_0      // 576 bytes
γ = γ_0      // 16 bytes
δ = δ_0      // 3984 bytes
</code></pre>
<p>Serialize the final packet using a consistent format and prepare it for transmission.</p>
<p>f. <strong>Transmit Packet</strong></p>
<ul>
<li>Sample a randomized delay from the same distribution family used for per-hop delays (in Step 3.e.) with an independently chosen mean.</li>
</ul>
<p>This delay prevents timing correlation when multiple Sphinx packets are sent in quick succession.
Such bursts may occur when an upstream protocol fragments a large message, or when several messages are sent close together.</p>
<ul>
<li>After the randomized delay elapses, transmit the serialized packet to the first hop via a libp2p stream negotiated under the <code>"/mix/1.0.0"</code> protocol identifier.</li>
</ul>
<p>Implementations MAY reuse an existing stream to the first hop as described in <a href="vac/raw/mix.html#55-stream-management-and-multiplexing">Section 5.5</a>, if doing so does not introduce any observable linkability between the packets.</p>
</li>
</ol>
<p>Once a Sphinx packet is constructed and transmitted by the initiating node, it is processed hop-by-hop by the remaining mix nodes in the path.
Each node receives the packet over a libp2p stream negotiated under the <code>"/mix/1.0.0"</code> protocol.
The following subsection defines the per-hop packet handling logic expected of each mix node, depending on whether it acts as an intermediary or an exit.</p>
<h3 id="86-sphinx-packet-handling"><a class="header" href="#86-sphinx-packet-handling">8.6 Sphinx Packet Handling</a></h3>
<p>Each mix node MUST implement a handler for incoming data received over libp2p streams negotiated under the <code>"/mix/1.0.0"</code> protocol identifier.
The incoming stream may have been reused by the previous hop, as described in <a href="vac/raw/mix.html#55-stream-management-and-multiplexing">Section 5.5</a>.
Implementations MUST ensure that packet handling remains stateless and unlinkable, regardless of stream reuse.</p>
<p>Upon receiving the stream payload, the node MUST interpret it as a Sphinx packet and process it in one of two roles—intermediary or exit— as defined in <a href="vac/raw/mix.html#73-sphinx-packet-receiving-and-processing">Section 7.3</a>.
This section defines the exact behavior for both roles.</p>
<h4 id="861-shared-preprocessing"><a class="header" href="#861-shared-preprocessing">8.6.1 Shared Preprocessing</a></h4>
<p>Upon receiving a stream payload over a libp2p stream, the mix node MUST first deserialize it into a Sphinx packet <code>(α, β, γ, δ)</code>.</p>
<p>The deserialized fields MUST match the sizes defined in <a href="vac/raw/mix.html#852-construction-steps">Section 8.5.2</a> step 3.e., and the total packet length MUST match the fixed packet size defined in <a href="vac/raw/mix.html#832-payload-size">Section 8.3.2</a>.</p>
<p>If the stream payload does not match the expected length, it MUST be discarded and the processing MUST terminate.</p>
<p>After successful deserialization, the mix node performs the following steps:</p>
<ol>
<li>
<p><strong>Derive Session Key</strong></p>
<p>Let $x \in \mathbb{Z}_q^*$ denote the node's X25519 private key.
Compute the shared secret $s = α^x$.</p>
</li>
<li>
<p><strong>Check for Replays</strong></p>
<ul>
<li>Compute the tag $H(s)$.</li>
<li>If the tag exists in the node's table of previously seen tags, discard the packet and terminate processing.</li>
<li>Otherwise, store the tag in the table.</li>
</ul>
<p>The table MAY be flushed when the node rotates its private key.
Implementations SHOULD perform this cleanup securely and automatically.</p>
</li>
<li>
<p><strong>Check Header Integrity</strong></p>
<ul>
<li>
<p>Derive the MAC key from the session secret $s$:</p>
<p>$<code>\begin{array}{l} \mathrm{mac\_key} = \mathrm{KDF}(\text{"mac\_key"} \mid s) \end{array}</code>$</p>
</li>
<li>
<p>Verify the integrity of the routing header:</p>
<p>$<code>\begin{array}{l} γ \stackrel{?}{=} \mathrm{HMAC\text{-}SHA\text{-}256}(\mathrm{mac\_key}, β) \end{array}</code>$</p>
<p>If the check fails, discard the packet and terminate processing.</p>
</li>
</ul>
</li>
<li>
<p><strong>Decrypt One Layer of the Routing Header</strong></p>
<ul>
<li>
<p>Derive the routing header AES key and IV from the session secret $s$:</p>
<p>$<code>\begin{array}{l} β_{\mathrm{aes\_key}} = \mathrm{KDF}(\text{"aes\_key"} \mid s)\\ β_{\mathrm{iv}} = \mathrm{KDF}(\text{"iv"} \mid s) \end{array}</code>$</p>
</li>
<li>
<p>Decrypt the suitably padded $β$ to obtain the routing block $B$ for this hop:</p>
<p>$<code>\begin{array}{l} B = \mathrm{AES\text{-}CTR}\bigl(β_{\mathrm{aes\_key}}, β_{\mathrm{iv}}, β \mid 0_{(t+1)κ} \bigr) \end{array}</code>$</p>
<p>This step removes the filler string appended during header encryption in <a href="vac/raw/mix.html#852-construction-steps">Section 8.5.2</a> step 3.c. and yields the plaintext routing information for this hop.</p>
</li>
</ul>
<p>The routing block $B$ MUST be parsed according to the rules and field layout defined in <a href="vac/raw/mix.html#862-node-role-determination">Section 8.6.2</a> to determine whether the current node is an intermediary or the exit.</p>
</li>
<li>
<p><strong>Decrypt One Layer of the Payload</strong></p>
<ul>
<li>
<p>Derive the payload AES key and IV from the session secret $s$:</p>
<p>$<code>\begin{array}{l} δ_{\mathrm{aes\_key}} = \mathrm{KDF}(\text{"δ\_aes\_key"} \mid s)\\ δ_{\mathrm{iv}} = \mathrm{KDF}(\text{"δ\_iv"} \mid s) \end{array}</code>$</p>
</li>
<li>
<p>Decrypt one layer of the encrypted payload $δ$:</p>
<p>$<code>\begin{array}{l} δ' = \mathrm{AES\text{-}CTR}\bigl(δ_{\mathrm{aes\_key}}, δ_{\mathrm{iv}}, δ \bigr) \end{array}</code>$</p>
</li>
</ul>
<p>The resulting $δ'$ is the decrypted payload for this hop and MUST be interpreted depending on the parsed node's role, determined by $B$, as described in <a href="vac/raw/mix.html#862-node-role-determination">Section 8.6.2</a>.</p>
</li>
</ol>
<h4 id="862-node-role-determination"><a class="header" href="#862-node-role-determination">8.6.2 Node Role Determination</a></h4>
<p>As described in <a href="vac/raw/mix.html#861-shared-preprocessing">Section 8.6.1</a>, the mix node obtains the routing block $B$ by decrypting one layer of the encrypted header $β$.</p>
<p>At this stage, the node MUST determine whether it is an intermediary or the exit based on the prefix of $B$, in accordance with the construction of $β_i$ defined in <a href="vac/raw/mix.html#852-construction-steps">Section 8.5.2</a> step 3.c.:</p>
<ul>
<li>If the first $(tκ - 2)$ bytes of $B$ contain a nonzero-encoded address, immediately followed by a two-byte zero delay, and then $((t + 1)(r - L) + t + 2)κ$ bytes of all-zero padding, process the packet as an exit.</li>
<li>Otherwise, process the packet as an intermediary.</li>
</ul>
<p>The following subsections define the precise behavior for each case.</p>
<h4 id="863-intermediary-processing"><a class="header" href="#863-intermediary-processing">8.6.3 Intermediary Processing</a></h4>
<p>Once the node determines its role as an intermediary following the steps in <a href="vac/raw/mix.html#862-node-role-determination">Section 8.6.2</a>, it MUST perform the following steps to interpret routing block $B$ and decrypted payload $δ'$ obtained in <a href="vac/raw/mix.html#861-shared-preprocessing">Section 8.6.1</a>:</p>
<ol>
<li>
<p><strong>Parse Routing Block</strong></p>
<p>Parse the routing block $B$ according to the $β_i$, $i \neq L - 1$ construction defined in <a href="vac/raw/mix.html#852-construction-steps">Section 8.5.2</a> step 3.c.:</p>
<ul>
<li>
<p>Extract the first $(tκ - 2)$ bytes of $B$ as the next hop address $\mathrm{addr}$</p>
<p>$<code>\begin{array}{l} \mathrm{addr} = B_{[0\ldots(tκ - 2) - 1]} \end{array}</code>$</p>
</li>
<li>
<p>Extract next two bytes as the mean delay $\mathrm{delay}$</p>
<p>$<code>\begin{array}{l} \mathrm{delay} = B_{[(tκ - 2)\ldots{tκ} - 1]} \end{array}</code>$</p>
</li>
<li>
<p>Extract next $κ$ bytes as the next hop MAC $γ'$</p>
<p>$<code>\begin{array}{l} γ' = B_{[tκ\ldots(t + 1)κ - 1]} \end{array}</code>$</p>
</li>
<li>
<p>Extract next $(r(t+1)+1)κ$ bytes as the next hop routing information $β'$</p>
<p>$<code>\begin{array}{l} β' = B_{[(t + 1)κ\ldots(r(t +1 ) + t + 2)κ - 1]} \end{array}</code>$</p>
</li>
</ul>
<p>If parsing fails, discard the packet and terminate processing.</p>
</li>
<li>
<p><strong>Update Header Fields</strong></p>
<p>Update the header fields according to the construction steps defined in <a href="vac/raw/mix.html#852-construction-steps">Section 8.5.2</a>:</p>
<ul>
<li>
<p>Compute the next hop ephemeral public value $α'$, deriving the blinding factor $b$ from the shared secret $s$ computed in <a href="vac/raw/mix.html#861-shared-preprocessing">Section 8.6.1</a> step 1.</p>
<p>$<code>\begin{aligned} b &amp;= H(α\ |\ s) \\ α' &amp;= α^b \end{aligned}</code>$</p>
</li>
<li>
<p>Use the $β'$ and $γ'$ extracted in Step 1. as the routing information and MAC respectively in the outgoing packet.</p>
</li>
</ul>
</li>
<li>
<p><strong>Update Payload</strong></p>
<p>Use the decrypted payload $δ'$ computed in <a href="vac/raw/mix.html#861-shared-preprocessing">Section 8.6.1</a> step 5. as the payload in the outgoing packet.</p>
</li>
<li>
<p><strong>Assemble Final Packet</strong>
The final Sphinx packet is structured as defined in <a href="vac/raw/mix.html#83-packet-component-sizes">Section 8.3</a>:</p>
<pre><code class="language-text">α = α'      // 32 bytes
β = β'      // 576 bytes
γ = γ'      // 16 bytes
δ = δ'      // 3984 bytes
</code></pre>
<p>Serialize $α'$ using the same format used in <a href="vac/raw/mix.html#852-construction-steps">Section 8.5.2</a>.
The remaining fields are already fixed-length buffers and do not require further transformation.</p>
</li>
<li>
<p><strong>Transmit Packet</strong></p>
<ul>
<li>
<p>Interpret the $\mathrm{addr}$ and $\mathrm{delay}$ extracted in Step 1. according to the encoding format used during construction in <a href="vac/raw/mix.html#852-construction-steps">Section 8.5.2</a> Step 3.c.</p>
</li>
<li>
<p>Sample the actual forwarding delay from the configured delay distribution, using the decoded mean delay value as the distribution parameter.</p>
</li>
<li>
<p>After the forwarding delay elapses, transmit the serialized packet to the next hop address via a libp2p stream negotiated under the <code>"/mix/1.0.0"</code> protocol identifier.</p>
</li>
</ul>
<p>Implementations MAY reuse an existing stream to the next hop as described in <a href="vac/raw/mix.html#55-stream-management-and-multiplexing">Section 5.5</a>, if doing so does not introduce any observable linkability between the packets.</p>
</li>
<li>
<p><strong>Erase State</strong></p>
<ul>
<li>
<p>After transmission, erase all temporary values securely from memory, including session keys, decrypted content, and routing metadata.</p>
</li>
<li>
<p>If any error occurs—such as malformed header, invalid delay, or failed stream transmission—silently discard the packet and do not send any error response.</p>
</li>
</ul>
</li>
</ol>
<h4 id="864-exit-processing"><a class="header" href="#864-exit-processing">8.6.4 Exit Processing</a></h4>
<p>Once the node determines its role as an exit following the steps in <a href="vac/raw/mix.html#862-node-role-determination">Section 8.6.2</a>, it MUST perform the following steps to interpret routing block $B$ and decrypted payload $δ'$ obtained in <a href="vac/raw/mix.html#861-shared-preprocessing">Section 8.6.1</a>:</p>
<ol>
<li>
<p><strong>Parse Routing Block</strong></p>
<p>Parse the routing block $B$ according to the $β_i$, $i = L - 1$ construction defined in <a href="vac/raw/mix.html#852-construction-steps">Section 8.5.2</a> step 3.c.:</p>
<ul>
<li>
<p>Extract first $(tκ - 2)$ bytes of $B$ as the destination address $Δ$</p>
<p>$<code>\begin{array}{l} Δ = B_{[0\ldots(tκ - 2) - 1]} \end{array}</code>$</p>
</li>
</ul>
</li>
<li>
<p><strong>Recover Padded Application Message</strong></p>
<ul>
<li>
<p>Verify the decrypted payload $δ'$ computed in <a href="vac/raw/mix.html#861-shared-preprocessing">Section 8.6.1</a> step 5.:</p>
<p>$<code>\begin{array}{l} δ'_{[0\ldots{κ} - 1]} \stackrel{?}{=} 0_{κ} \end{array}</code>$</p>
</li>
</ul>
<p>If the check fails, discard $δ'$ and terminate processing.</p>
<ul>
<li>
<p>Extract rest of the bytes of $δ'$ as the padded application message $m$:</p>
<p>$<code>\begin{array}{l} m = δ'_{[κ\ldots]},\; \; \; \text{where notation } X_{[a \ldots]} \text{ denotes the substring of } X \text{ from byte offset } a \text{ to the end of the string using zero-based indexing.} \end{array}</code>$</p>
</li>
</ul>
</li>
<li>
<p><strong>Extract Application Message</strong></p>
<p>Interpret recovered $m$ according to the construction steps defined in <a href="vac/raw/mix.html#852-construction-steps">Section 8.5.2</a> step 1.:</p>
<ul>
<li>
<p>First, unpad $m$ using the deterministic padding scheme defined during construction.</p>
</li>
<li>
<p>Next, parse the unpadded message deterministically to extract:</p>
<ul>
<li>optional spam protection proof</li>
<li>zero or more SURBs</li>
<li>the origin protocol codec</li>
<li>the serialized application message</li>
</ul>
</li>
<li>
<p>Parse and deserialize the metadata fields required for spam validation, SURB extraction, and protocol codec identification, consistent with the format and extensions applied by the initiator.
The application message itself MUST remain serialized.</p>
</li>
<li>
<p>If parsing fails at any stage, discard $m$ and terminate processing.</p>
</li>
</ul>
</li>
<li>
<p><strong>Handoff to Exit Layer</strong></p>
<ul>
<li>
<p>Hand off the serialized application message, the origin protocol codec, and destination address $Δ$ (extracted in step 1.) to the local Exit layer for further processing and delivery.</p>
</li>
<li>
<p>The Exit Layer is responsible for establishing a client-only connection and forwarding the message to the destination. Implementations MAY reuse an existing stream to the destination, if doing so does not introduce any observable linkability between forwarded messages.</p>
</li>
</ul>
</li>
</ol>
<h2 id="9-security-considerations"><a class="header" href="#9-security-considerations">9. Security Considerations</a></h2>
<p>This section describes the security guarantees and limitations of the Mix Protocol.
It begins by outlining the anonymity properties provided by the core protocol when routing messages through the mix network.
It then discusses the trust assumptions required at the edges of the network, particularly at the final hop.
Finally, it presents an alternative trust model for destinations that support Mix Protocol directly, followed by a summary of broader limitations and areas that may be addressed in future iterations.</p>
<h3 id="91-security-guarantees-of-the-core-mix-protocol"><a class="header" href="#91-security-guarantees-of-the-core-mix-protocol">9.1 Security Guarantees of the Core Mix Protocol</a></h3>
<p>The core Mix Protocol—comprising anonymous routing through a sequence of mix nodes using Sphinx packets—provides the following security guarantees:</p>
<ul>
<li><strong>Sender anonymity</strong>: Each message is wrapped in layered encryption and routed independently, making it unlinkable to the sender even if multiple mix nodes are colluding.</li>
<li><strong>Metadata protection</strong>: All messages are fixed in size and indistinguishable on the wire. Sphinx packets reveal only the immediate next hop and delay to each mix node. No intermediate node learns its position in the path or the total pathlength.</li>
<li><strong>Traffic analysis resistance</strong>: Continuous-time mixing with randomized per-hop delays reduces the risk of timing correlation and input-output linkage.</li>
<li><strong>Per-hop confidentiality and integrity</strong>: Each hop decrypts only its assigned layer of the Sphinx packet and verifies header integrity via a per-hop MAC.</li>
<li><strong>No long-term state</strong>: All routing is stateless. Mix nodes do not maintain per-message metadata, reducing the surface for correlation attacks.</li>
</ul>
<p>These guarantees hold only within the boundaries of the Mix Protocol.
Additional trust assumptions are introduced at the edges, particularly at the final hop, where the decrypted message is handed off to the Mix Exit Layer for delivery to the destination outside the mixnet.
The next subsection discusses these trust assumptions in detail.</p>
<h3 id="92-exit-node-trust-model"><a class="header" href="#92-exit-node-trust-model">9.2 Exit Node Trust Model</a></h3>
<p>The Mix Protocol ensures strong sender anonymity and metadata protection between the Mix Entry and Exit layers.
However, once a Sphinx packet is decrypted at the final hop, additional trust assumptions are introduced.
The node processing the final layer of encryption is trusted to forward the correct message to the destination and return any reply using the provided reply key.
This section outlines the resulting trust boundaries.</p>
<h4 id="921-message-delivery-and-origin-trust"><a class="header" href="#921-message-delivery-and-origin-trust">9.2.1 Message Delivery and Origin Trust</a></h4>
<p>At the final hop, the decrypted Sphinx packet reveals the plaintext message and destination address.
The exit node is then trusted to deliver this message to the destination application, and—if a reply is expected—to return the response using the embedded reply key.</p>
<p>In this model, the exit node becomes a privileged middleman.
It has full visibility into the decrypted payload.
Specifically, the exit node could tamper with either direction of communication without detection:</p>
<ul>
<li>It may alter or drop the forwarded message.</li>
<li>It may fabricate a reply instead of forwarding the actual response from the destination.</li>
</ul>
<p>This limitation is consistent with the broader mixnet trust model.
While intermediate nodes are constrained by layered encryption, edge nodes—specifically the initiating and the exit nodes in the path—are inherently more privileged and operate outside the cryptographic protections of the mixnet.</p>
<p>In systems like Tor, such exit-level tampering is mitigated by long-lived circuits that allow endpoints to negotiate shared session keys (<em>e.g.,</em> via TLS).
A malicious exit cannot forge a valid forward message or response without access to these session secrets.</p>
<p>The Mix Protocol, by contrast, is stateless and message-based.
Each message is routed independently, with no persistent circuit or session context.
As a result, endpoints cannot correlate messages, establish session keys, or validate message origin.
That is, the exit remains a necessary point of trust for message delivery and response handling.</p>
<p>The next subsection describes a related limitation:
the exit's ability to pose as a legitimate client to the destination's origin protocol, and how that can be abused to bypass application-layer expectations.</p>
<h4 id="922-origin-protocol-trust-and-client-role-abuse"><a class="header" href="#922-origin-protocol-trust-and-client-role-abuse">9.2.2 Origin Protocol Trust and Client Role Abuse</a></h4>
<p>In addition to the message delivery and origin trust assumption, the exit node also initiates a client-side connection to the origin protocol instance at the destination.
From the destination's perspective, this appears indistinguishable from a conventional peer connection, and the exit is accepted as a legitimate peer.</p>
<p>As a result, any protocol-level safeguards and integrity checks are applied to the exit node as well.
However, since the exit node is not a verifiable peer and may open fresh connections at will, such protections are limited in their effectiveness.
A malicious exit may repeatedly initiate new connections, send well-formed fabricated messages and circumvent any peer scoring mechanisms by reconnecting.
These messages are indistinguishable from legitimate peer messages from the destination's point of view.</p>
<p>This class of attack is distinct from basic message tampering.
Even if the message content is well-formed and semantically valid, the exit's role as an unaccountable client allows it to bypass application-level assumptions about peer behavior.
This results in protocol misuse, targeted disruption, or spoofed message injection that the destination cannot attribute.</p>
<p>Despite these limitations, this model is compatible with legacy protocols and destinations that do not support the Mix Protocol.
It allows applications to preserve sender anonymity without requiring any participation from the recipient.</p>
<p>However, in scenarios that demand stronger end-to-end guarantees—such as verifiable message delivery, origin authentication, or control over client access—it may be beneficial for the destination itself to operate a Mix instance.
This alternative model is described in the next subsection.</p>
<h3 id="93-destination-as-final-hop"><a class="header" href="#93-destination-as-final-hop">9.3 Destination as Final Hop</a></h3>
<p>In some deployments, it may be desirable for the destination node to participate in the Mix Protocol directly.
In this model, the destination operates its own Mix instance and is selected as the final node in the mix path.
The decrypted message is then delivered by the Mix Exit Layer directly to the destination's local origin protocol instance, without relying on a separate exit node.</p>
<p>From a security standpoint, this model provides end-to-end integrity guarantees.
It removes the trust assumption on an external exit.
The message is decrypted and delivered entirely within the destination node, eliminating the risk of tampering during the final delivery step.
The response, if used, is also encrypted and returned by the destination itself, avoiding reliance on a third-party node to apply the reply key.</p>
<p>This model also avoids client role abuse.
Since the Mix Exit Layer delivers the message locally, the destination need not accept arbitrary inbound connections from external clients.
This removes the risk of an adversarial exit posing as a peer and injecting protocol-compliant but unauthorized messages.</p>
<p>This approach does require the destination to support the Mix Protocol.
However, this requirement can be minimized by supporting a lightweight mode in which the destination only sends and receives messages via Mix, without participating in message routing for other nodes.
This is similar to the model adopted by Waku, where edge nodes are not required to relay traffic but still interact with the network.
In practice, this tradeoff is often acceptable.</p>
<p>The core Mix Protocol does not mandate destination participation.
However, implementations MAY support this model as an optional mode for use in deployments that require stronger end-to-end security guarantees.
The discovery mechanism MAY include a flag to advertise support for routing versus receive-only participation.
Additional details on discovery configurations are out of scope for this specification.</p>
<p>This trust model is not required for interoperability, but is recommended when assessing deployment-specific threat models, especially in protocols that require message integrity or authenticated replies.</p>
<h3 id="94-known-protocol-limitations"><a class="header" href="#94-known-protocol-limitations">9.4 Known Protocol Limitations</a></h3>
<p>The Mix Protocol provides strong sender anonymity and metadata protection guarantees within the mix network.
However, it does not address all classes of network-level disruption or application-layer abuse.
This section outlines known limitations that deployments MUST consider when evaluating system resilience and reliability.</p>
<h4 id="941-undetectable-node-misbehavior"><a class="header" href="#941-undetectable-node-misbehavior">9.4.1 Undetectable Node Misbehavior</a></h4>
<p>The Mix Protocol in its current version does not include mechanisms to detect or attribute misbehavior by mix nodes.
Since Sphinx packets are unlinkable and routing is stateless, malicious or faulty nodes may delay, drop, or selectively forward packets without detection.</p>
<p>This behavior is indistinguishable from benign network failure.
There is no native support for feedback, acknowledgment, or proof-of-relay.
As a result, unreliable nodes cannot be penalized or excluded based on observed reliability.</p>
<p>Future versions may explore accountability mechanisms.
For now, deployments MAY improve robustness by sending each packet along multiple paths as defined in [Section X.X], but MUST treat message loss as a possibility.</p>
<h4 id="942-no-built-in-retry-or-acknowledgment"><a class="header" href="#942-no-built-in-retry-or-acknowledgment">9.4.2 No Built-in Retry or Acknowledgment</a></h4>
<p>The Mix protocol does not support retransmission, delivery acknowledgments, or automated fallback logic.
Each message is sent once and routed independently through the mixnet.
If a message is lost or a node becomes unavailable, recovery is the responsibility of the top-level application.</p>
<p>Single-Use Reply Blocks (SURBs) (defined in Section[X.X]) enable destinations to send responses back to the sender via a fresh mix path.
However, SURBs are optional, and their usage for acknowledgments or retries must be coordinated by the application.</p>
<p>Applications using the Mix Protocol MUST treat delivery as probabilistic.
To improve reliability, the sender MAY:</p>
<ul>
<li>Use parallel transmission across <code>D</code> disjoint paths.</li>
<li>Estimate end-to-end delay bounds based on chosen per-hop delays (defined in <a href="vac/raw/mix.html#62-delay-strategy">Section 6.2</a>), and retry using different paths if a response is not received within the expected window.</li>
</ul>
<p>These strategies MUST be implemented at the origin protocol layer or through Mix integration logic and are not enforced by the Mix Protocol itself.</p>
<h4 id="943-no-sybil-resistance"><a class="header" href="#943-no-sybil-resistance">9.4.3 No Sybil Resistance</a></h4>
<p>The Mix Protocol does not include any built-in defenses against Sybil attacks.
All nodes that support the protocol and are discoverable via peer discovery are equally eligible for path selection.
An adversary that operates a large number of Sybil nodes may be selected into mix paths more often than expected, increasing the likelihood of partial or full path compromise.</p>
<p>In the worst case, if an adversary controls a significant fraction of nodes (<em>e.g.,</em> one-third of the network), the probability that a given path includes only adversarial nodes increases sharply.
This raises the risk of deanonymization through end-to-end traffic correlation or timing analysis.</p>
<p>Deployments concerned with Sybil resistance MAY implement passive defenses such as minimum path length constraints.
More advanced mitigations such as stake-based participation or resource proofs typically require some form of trusted setup or blockchain-based coordination.</p>
<p>Such defenses are out of scope in the current version of the Mix Protocol, but are critical to ensuring anonymity at scale and may be explored in future iterations.</p>
<h4 id="944-vulnerability-to-denial-of-service-attacks"><a class="header" href="#944-vulnerability-to-denial-of-service-attacks">9.4.4 Vulnerability to Denial-of-Service Attacks</a></h4>
<p>The Mix Protocol does not provide built-in defenses against denial-of-service (DoS) attacks targeting mix nodes.
A malicious mix node may generate a high volume of valid Sphinx packets to exhaust computational, memory, or bandwidth resources along random paths through the network.</p>
<p>This risk stems from the protocol's stateless and sender-anonymous design.
Mix nodes process each packet independently and cannot distinguish honest users from attackers.
There is no mechanism to attribute packets, limit per-sender usage, or apply network-wide fairness constraints.</p>
<p>Application-level defenses—such as PoW, VDFs, and RLNs (defined in <a href="vac/raw/mix.html#63-spam-protection">Section 6.3</a>) to protect destination endpoints—do not address abuse <em>within</em> the mixnet.
Mix nodes remain vulnerable to volumetric attacks even when destinations are protected.</p>
<p>While the Mix Protocol includes safeguards such as layered encryption, per-hop integrity checks, and fixed-size headers, these primarily defend against tagging attacks and structurally invalid or malformed traffic.
The Sphinx packet format also enforces a maximum path length $(L \leq r)$, which prevents infinite loops or excessively long paths being embedded.
However, these protections do not prevent adversaries from injecting large volumes of short, well-formed messages to exhaust mix node resources.</p>
<p>DoS protection—such as admission control, rate-limiting, or resource-bound access—MUST be implemented outside the core protocol.
Any such mechanism MUST preserve sender unlinkability and SHOULD be evaluated carefully to avoid introducing correlation risks.</p>
<p>Defending against large-scale DoS attacks is considered a deployment-level responsibility and is out of scope for this specification.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="noise-x3dh-double-ratchet"><a class="header" href="#noise-x3dh-double-ratchet">NOISE-X3DH-DOUBLE-RATCHET</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Secure 1-to-1 channel setup using X3DH and the double ratchet</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Ramses Fernandez &lt;ramses@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-14"><a class="header" href="#timeline-14">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/raw/noise-x3dh-double-ratchet.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/raw/noise-x3dh-double-ratchet.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-04</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/517b63984c875670e437d50359f2f67331104974/vac/raw/noise-x3dh-double-ratchet.md"><code>517b639</code></a> — Update the RFCs: Vac Raw RFC (#143)</li>
<li><strong>2024-10-03</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/c655980494a5943634c372009bbea71c13196a8f/vac/raw/eth-secure-channel.md"><code>c655980</code></a> — Eth secpm splitted (#91)</li>
</ul>
<!-- timeline:end -->
<h2 id="motivation-8"><a class="header" href="#motivation-8">Motivation</a></h2>
<p>The need for secure communications has become paramount.
This specification outlines a protocol describing a
secure 1-to-1 comunication channel between 2 users. The
main components are the X3DH key establishment mechanism,
combined with the double ratchet. The aim of this
combination of schemes is providing a protocol with both
forward secrecy and post-compromise security.</p>
<h2 id="theory-2"><a class="header" href="#theory-2">Theory</a></h2>
<p>The specification is based on the noise protocol framework.
It corresponds to the double ratchet scheme combined with
the X3DH algorithm, which will be used to initialize the former.
We chose to express the protocol in noise to be be able to use
the noise streamlined implementation and proving features.
The X3DH algorithm provides both authentication and forward
secrecy, as stated in the
<a href="https://signal.org/docs/specifications/x3dh/">X3DH specification</a>.</p>
<p>This protocol will consist of several stages:</p>
<ol>
<li>Key setting for X3DH: this step will produce
prekey bundles for Bob which will be fed into X3DH.
It will also allow Alice to generate the keys required
to run the X3DH algorithm correctly.</li>
<li>Execution of X3DH: This step will output
a common secret key <code>SK</code> together with an additional
data vector <code>AD</code>. Both will be used in the double
ratchet algorithm initialization.</li>
<li>Execution of the double ratchet algorithm
for forward secure, authenticated communications,
using the common secret key <code>SK</code>, obtained from X3DH, as a root key.</li>
</ol>
<p>The protocol assumes the following requirements:</p>
<ul>
<li>Alice knows Bob’s Ethereum address.</li>
<li>Bob is willing to participate in the protocol,
and publishes his public key.</li>
<li>Bob’s ownership of his public key is verifiable,</li>
<li>Alice wants to send message M to Bob.</li>
<li>An eavesdropper cannot read M’s content
even if she is storing it or relaying it.</li>
</ul>
<h2 id="syntax-1"><a class="header" href="#syntax-1">Syntax</a></h2>
<h3 id="cryptographic-suite-1"><a class="header" href="#cryptographic-suite-1">Cryptographic suite</a></h3>
<p>The following cryptographic functions MUST be used:</p>
<ul>
<li><code>X488</code> as Diffie-Hellman function <code>DH</code>.</li>
<li><code>SHA256</code> as KDF.</li>
<li><code>AES256-GCM</code> as AEAD algorithm.</li>
<li><code>SHA512</code> as hash function.</li>
<li><code>XEd448</code> for digital signatures.</li>
</ul>
<h3 id="x3dh-initialization-1"><a class="header" href="#x3dh-initialization-1">X3DH initialization</a></h3>
<p>This scheme MUST work on the curve curve448.
The X3DH algorithm corresponds to the IX pattern in Noise.</p>
<p>Bob and Alice MUST define personal key pairs
<code>(ik_B, IK_B)</code> and <code>(ik_A, IK_A)</code> respectively where:</p>
<ul>
<li>The key <code>ik</code> must be kept secret,</li>
<li>and the key <code>IK</code> is public.</li>
</ul>
<p>Bob MUST generate new keys using
<code>(ik_B, IK_B) = GENERATE_KEYPAIR(curve = curve448)</code>.</p>
<p>Bob MUST also generate a public key pair
<code>(spk_B, SPK_B) = GENERATE_KEYPAIR(curve = curve448)</code>.</p>
<p><code>SPK</code> is a public key generated and stored at medium-term.
Both signed prekey and the certificate MUST
undergo periodic replacement.
After replacing the key,
Bob keeps the old private key of <code>SPK</code>
for some interval, dependant on the implementation.
This allows Bob to decrypt delayed messages.</p>
<p>Bob MUST sign <code>SPK</code> for authentication:
<code>SigSPK = XEd448(ik, Encode(SPK))</code></p>
<p>A final step requires the definition of
<code>prekey_bundle = (IK, SPK, SigSPK, OPK_i)</code></p>
<p>One-time keys <code>OPK</code> MUST be generated as
<code>(opk_B, OPK_B) = GENERATE_KEYPAIR(curve = curve448)</code>.</p>
<p>Before sending an initial message to Bob,
Alice MUST generate an AD: <code>AD = Encode(IK_A) || Encode(IK_B)</code>.</p>
<p>Alice MUST generate ephemeral key pairs
<code>(ek, EK) = GENERATE_KEYPAIR(curve = curve448)</code>.</p>
<p>The function <code>Encode()</code> transforms a
curve448 public key into a byte sequence.
This is specified in the <a href="http://www.ietf.org/rfc/rfc7748.txt">RFC 7748</a>
on elliptic curves for security.</p>
<p>One MUST consider <code>q = 2^446 - 13818066809895115352007386748515426880336692474882178609894547503885</code>
for digital signatures with <code>(XEd448_sign, XEd448_verify)</code>:</p>
<pre><code class="language-text">XEd448_sign((ik, IK), message):
    Z = randbytes(64)  
    r = SHA512(2^456 - 2 || ik || message || Z )
    R = (r * convert_mont(5)) % q
    h = SHA512(R || IK || M)
    s = (r + h * ik) % q
    return (R || s)
</code></pre>
<pre><code class="language-text">XEd448_verify(u, message, (R || s)):
    if (R.y &gt;= 2^448) or (s &gt;= 2^446): return FALSE
    h = (SHA512(R || 156326 || message)) % q
    R_check = s * convert_mont(5) - h * 156326
    if R == R_check: return TRUE
    return FALSE 
</code></pre>
<pre><code class="language-text">convert_mont(u):
    u_masked = u % mod 2^448
    inv = ((1 - u_masked)^(2^448 - 2^224 - 3)) % (2^448 - 2^224 - 1)
    P.y = ((1 + u_masked) * inv)) % (2^448 - 2^224 - 1)
    P.s = 0
    return P
</code></pre>
<h3 id="use-of-x3dh-1"><a class="header" href="#use-of-x3dh-1">Use of X3DH</a></h3>
<p>This specification combines the double ratchet
with X3DH using the following data as initialization for the former:</p>
<ul>
<li>The <code>SK</code> output from X3DH becomes the <code>SK</code>
input of the double ratchet. See section 3.3 of
<a href="https://signal.org/docs/specifications/doubleratchet/">Signal Specification</a>
for a detailed description.</li>
<li>The <code>AD</code> output from X3DH becomes the <code>AD</code>
input of the double ratchet. See sections 3.4 and 3.5 of
<a href="https://signal.org/docs/specifications/doubleratchet/">Signal Specification</a>
for a detailed description.</li>
<li>Bob’s signed prekey <code>SigSPKB</code> from X3DH is used as Bob’s
initial ratchet public key of the double ratchet.</li>
</ul>
<p>X3DH has three phases:</p>
<ol>
<li>Bob publishes his identity key and prekeys to a server,
a network, or dedicated smart contract.</li>
<li>Alice fetches a prekey bundle from the server,
and uses it to send an initial message to Bob.</li>
<li>Bob receives and processes Alice's initial message.</li>
</ol>
<p>Alice MUST perform the following computations:</p>
<pre><code class="language-text">dh1 = DH(IK_A, SPK_B, curve = curve448)
dh2 = DH(EK_A, IK_B, curve = curve448)
dh3 = DH(EK_A, SPK_B)
SK = KDF(dh1 || dh2 || dh3)
</code></pre>
<p>Alice MUST send to Bob a message containing:</p>
<ul>
<li><code>IK_A, EK_A</code>.</li>
<li>An identifier to Bob's prekeys used.</li>
<li>A message encrypted with AES256-GCM using <code>AD</code> and <code>SK</code>.</li>
</ul>
<p>Upon reception of the initial message, Bob MUST:</p>
<ol>
<li>Perform the same computations above with the <code>DH()</code> function.</li>
<li>Derive <code>SK</code> and construct <code>AD</code>.</li>
<li>Decrypt the initial message encrypted with <code>AES256-GCM</code>.</li>
<li>If decryption fails, abort the protocol.</li>
</ol>
<h3 id="initialization-of-the-double-datchet-1"><a class="header" href="#initialization-of-the-double-datchet-1">Initialization of the double datchet</a></h3>
<p>In this stage Bob and Alice have generated key pairs
and agreed a shared secret <code>SK</code> using X3DH.</p>
<p>Alice calls <code>RatchetInitAlice()</code> defined below:</p>
<pre><code class="language-text">RatchetInitAlice(SK, IK_B):
    state.DHs = GENERATE_KEYPAIR(curve = curve448)
    state.DHr = IK_B
    state.RK, state.CKs = HKDF(SK, DH(state.DHs, state.DHr)) 
    state.CKr = None
    state.Ns, state.Nr, state.PN = 0
    state.MKSKIPPED = {}
</code></pre>
<p>The HKDF function MUST be the proposal by
<a href="http://www.ietf.org/rfc/rfc5869.txt">Krawczyk and Eronen</a>.
In this proposal <code>chaining_key</code> and <code>input_key_material</code>
MUST be replaced with <code>SK</code> and the output of <code>DH</code> respectively.</p>
<p>Similarly, Bob calls the function <code>RatchetInitBob()</code> defined below:</p>
<pre><code class="language-text">RatchetInitBob(SK, (ik_B,IK_B)):
    state.DHs = (ik_B, IK_B)
    state.Dhr = None
    state.RK = SK
    state.CKs, state.CKr = None
    state.Ns, state.Nr, state.PN = 0
    state.MKSKIPPED = {}
</code></pre>
<h3 id="encryption-1"><a class="header" href="#encryption-1">Encryption</a></h3>
<p>This function performs the symmetric key ratchet.</p>
<pre><code class="language-text">RatchetEncrypt(state, plaintext, AD):
   state.CKs, mk = HMAC-SHA256(state.CKs)
   header = HEADER(state.DHs, state.PN, state.Ns)
   state.Ns = state.Ns + 1
   return header, AES256-GCM_Enc(mk, plaintext, AD || header)
</code></pre>
<p>The <code>HEADER</code> function creates a new message header
containing the public key from the key pair output of the <code>DH</code>function.
It outputs the previous chain length <code>pn</code>,
and the message number <code>n</code>.
The returned header object contains ratchet public key
<code>dh</code> and integers <code>pn</code> and <code>n</code>.</p>
<h3 id="decryption-1"><a class="header" href="#decryption-1">Decryption</a></h3>
<p>The function <code>RatchetDecrypt()</code> decrypts incoming messages:</p>
<pre><code class="language-text">RatchetDecrypt(state, header, ciphertext, AD):
    plaintext = TrySkippedMessageKeys(state, header, ciphertext, AD)
    if plaintext != None:
        return plaintext
    if header.dh != state.DHr:
        SkipMessageKeys(state, header.pn)
        DHRatchet(state, header)
    SkipMessageKeys(state, header.n)
    state.CKr, mk = HMAC-SHA256(state.CKr)
    state.Nr = state.Nr + 1
    return AES256-GCM_Dec(mk, ciphertext, AD || header)
</code></pre>
<p>Auxiliary functions follow:</p>
<pre><code class="language-text">DHRatchet(state, header):
    state.PN = state.Ns
    state.Ns = state.Nr = 0
    state.DHr = header.dh
    state.RK, state.CKr = HKDF(state.RK, DH(state.DHs, state.DHr))
    state.DHs = GENERATE_KEYPAIR(curve = curve448)
    state.RK, state.CKs = HKDF(state.RK, DH(state.DHs, state.DHr))
</code></pre>
<pre><code class="language-text">SkipMessageKeys(state, until):
    if state.NR + MAX_SKIP &lt; until:
        raise Error
    if state.CKr != none:
        while state.Nr &lt; until:
            state.CKr, mk = HMAC-SHA256(state.CKr)
            state.MKSKIPPED[state.DHr, state.Nr] = mk
            state.Nr = state.Nr + 1
</code></pre>
<pre><code class="language-text">TrySkippedMessageKey(state, header, ciphertext, AD):
    if (header.dh, header.n) in state.MKSKIPPED:
        mk = state.MKSKIPPED[header.dh, header.n]
        delete state.MKSKIPPED[header.dh, header.n]
        return AES256-GCM_Dec(mk, ciphertext, AD || header)
    else: return None
</code></pre>
<h2 id="information-retrieval-1"><a class="header" href="#information-retrieval-1">Information retrieval</a></h2>
<h3 id="static-data-1"><a class="header" href="#static-data-1">Static data</a></h3>
<p>Some data, such as the key pairs <code>(ik, IK)</code> for Alice and Bob,
MAY NOT be regenerated after a period of time.
Therefore the prekey bundle MAY be stored in long-term
storage solutions, such as a dedicated smart contract
which outputs such a key pair when receiving an Ethereum wallet
address.</p>
<p>Storing static data is done using a dedicated
smart contract <code>PublicKeyStorage</code> which associates
the Ethereum wallet address of a user with his public key.
This mapping is done by <code>PublicKeyStorage</code>
using a <code>publicKeys</code> function, or a <code>setPublicKey</code> function.
This mapping is done if the user passed an authorization process.
A user who wants to retrieve a public key associated
with a specific wallet address calls a function <code>getPublicKey</code>.
The user provides the wallet address as the only
input parameter for <code>getPublicKey</code>.
The function outputs the associated public key
from the smart contract.</p>
<h3 id="ephemeral-data-1"><a class="header" href="#ephemeral-data-1">Ephemeral data</a></h3>
<p>Storing ephemeral data on Ethereum MAY be done using
a combination of on-chain and off-chain solutions.
This approach provides an efficient solution to
the problem of storing updatable data in Ethereum.</p>
<ol>
<li>Ethereum stores a reference or a hash
that points to the off-chain data.</li>
<li>Off-chain solutions can include systems like IPFS,
traditional cloud storage solutions, or
decentralized storage networks such as a
<a href="https://www.ethswarm.org">Swarm</a>.</li>
</ol>
<p>In any case, the user stores the associated
IPFS hash, URL or reference in Ethereum.</p>
<p>The fact of a user not updating the ephemeral information
can be understood as Bob not willing to participate in any
communication.</p>
<h2 id="copyright-10"><a class="header" href="#copyright-10">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-8"><a class="header" href="#references-8">References</a></h2>
<ul>
<li><a href="https://signal.org/docs/specifications/doubleratchet/">The Double Ratchet Algorithm</a></li>
<li><a href="https://signal.org/docs/specifications/x3dh/">The X3DH Key Agreement Protocol</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rln-interep-spec"><a class="header" href="#rln-interep-spec">RLN-INTEREP-SPEC</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Interep as group management for RLN</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Editor</th><td>Aaryamann Challani &lt;p1ge0nh8er@proton.me&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-15"><a class="header" href="#timeline-15">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/raw/rln-interep-spec.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/raw/rln-interep-spec.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/vac/raw/rln-interep-spec.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-08-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eb25cd06d679e94409072a96841de16a6b3910d5/vac/raw/rln-interep-spec.md"><code>eb25cd0</code></a> — chore: replace email addresses (#86)</li>
<li><strong>2024-05-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/99be3b974509ea03561c7ef4b1b02a56f24e9297/vac/raw/rln-interep-spec.md"><code>99be3b9</code></a> — Move Raw Specs (#37)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/860bae20d9eb9f17ac6c3839f939d545bf796835/vac/48/rln-interep-spec.md"><code>860bae2</code></a> — Update rln-interep-spec.md</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3f722d945c53b8356be6282f9c20646e099a2122/vac/48/rln-interep-spec.md"><code>3f722d9</code></a> — Update and rename README.md to rln-interep-spec.md</li>
<li><strong>2024-01-30</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/ea623980770922d0dfe2f861db885ca1ae9dd84e/vac/48/README.md"><code>ea62398</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-7"><a class="header" href="#abstract-7">Abstract</a></h2>
<p>This spec integrates <a href="https://interep.link">Interep</a>
into the <a href="vac/raw/../32/rln-v1.html">RLN</a> spec.
Interep is a group management protocol
that allows for the creation of groups of users and
the management of their membership.
It is used to manage the membership of the RLN group.</p>
<p>Interep ties in web2 identities with reputation, and
sorts the users into groups based on their reputation score.
For example, a GitHub user with over 100 followers is considered to have "gold" reputation.</p>
<p>Interep uses <a href="https://semaphore.appliedzkp.org/">Semaphore</a>
under the hood to allow anonymous signaling of membership in a group.
Therefore, a user with a "gold" reputation can prove the existence
of their membership without revealing their identity.</p>
<p>RLN is used for spam prevention, and Interep is used for group management.</p>
<p>By using Interep with RLN,
we allow users to join RLN membership groups
without the need for on-chain financial stake.</p>
<h2 id="motivation-9"><a class="header" href="#motivation-9">Motivation</a></h2>
<p>To have Sybil-Resistant group management,
there are <a href="https://github.com/vacp2p/rln-contract">implementations</a>
of RLN which make use of financial stake on-chain.
However, this is not ideal because it reduces the barrier of entry for honest participants.</p>
<p>In this case,
honest participants will most likely have a web2 identity accessible to them,
which can be used for joining an Interep reputation group.
By modifying the RLN spec to use Interep,
we can have Sybil-Resistant group management
without the need for on-chain financial stake.</p>
<p>Since RLN and Interep both use Semaphore-style credentials,
it is possible to use the same set of credentials for both.</p>
<h2 id="functional-operation-1"><a class="header" href="#functional-operation-1">Functional Operation</a></h2>
<p>Using Interep with RLN involves the following steps -</p>
<ol>
<li>Generate Semaphore credentials</li>
<li>Verify reputation and join Interep group</li>
<li>Join RLN membership group via interaction with Smart Contract,
by passing a proof of membership to the Interep group</li>
</ol>
<h3 id="1-generate-semaphore-credentials"><a class="header" href="#1-generate-semaphore-credentials">1. Generate Semaphore credentials</a></h3>
<p>Semaphore credentials are generated in a standard way,
depicted in the <a href="https://semaphore.appliedzkp.org/docs/guides/identities#create-deterministic-identities">Semaphore documentation</a>.</p>
<h3 id="2-verify-reputation-and-join-interep-group"><a class="header" href="#2-verify-reputation-and-join-interep-group">2. Verify reputation and join Interep group</a></h3>
<p>Using the Interep app deployed on <a href="https://goerli.interep.link/">Goerli</a>,
the user can check their reputation tier and join the corresponding group.
This results in a transaction to the Interep contract, which adds them to the group.</p>
<h3 id="3-join-rln-membership-group"><a class="header" href="#3-join-rln-membership-group">3. Join RLN membership group</a></h3>
<p>Instead of sending funds to the RLN contract to join the membership group,
the user can send a proof of membership to the Interep group.
This proof is generated by the user, and
is verified by the contract.
The contract ensures that the user is a member of the Interep group, and
then adds them to the RLN membership group.</p>
<p>Following is the modified signature of the register function
in the RLN contract -</p>
<pre><code class="language-solidity">    /// @param groupId: Id of the group.
    /// @param signal: Semaphore signal.
    /// @param nullifierHash: Nullifier hash.
    /// @param externalNullifier: External nullifier.
    /// @param proof: Zero-knowledge proof.
    /// @param idCommitment: ID Commitment of the member.
    function register(
        uint256 groupId,
        bytes32 signal,
        uint256 nullifierHash,
        uint256 externalNullifier,
        uint256[8] calldata proof,
        uint256 idCommitment
    )
</code></pre>
<h2 id="verification-of-messages"><a class="header" href="#verification-of-messages">Verification of messages</a></h2>
<p>Messages are verified the same way as in the <a href="vac/raw/../32/rln-v1.html">RLN spec</a>.</p>
<h2 id="slashing-1"><a class="header" href="#slashing-1">Slashing</a></h2>
<p>The slashing mechanism is the same as in the <a href="vac/raw/../32/rln-v1.html">RLN spec</a>.
It is important to note that the slashing
may not have the intended effect on the user,
since the only consequence is that they cannot send messages.
This is due to the fact that the user
can send a identity commitment in the registration to the RLN contract,
which is different than the one used in the Interep group.</p>
<h2 id="proof-of-concept"><a class="header" href="#proof-of-concept">Proof of Concept</a></h2>
<p>A proof of concept is available at
<a href="https://github.com/vacp2p/rln-interep-contract">vacp2p/rln-interp-contract</a>
which integrates Interep with RLN.</p>
<h2 id="security-considerations-1"><a class="header" href="#security-considerations-1">Security Considerations</a></h2>
<ol>
<li>As mentioned in <a href="vac/raw/rln-interep-spec.html#slashing">Slashing</a>,
the slashing mechanism may not have the intended effect on the user.</li>
<li>This spec inherits the security considerations of the <a href="vac/raw/../32/rln-v1.html">RLN spec</a>.</li>
<li>This spec inherits the security considerations of <a href="https://docs.interep.link/">Interep</a>.</li>
<li>A user may make multiple registrations using the same Interep proofs but
different identity commitments.
The way to mitigate this is to check if the nullifier hash has been detected
previously in proof verification.</li>
</ol>
<h2 id="references-9"><a class="header" href="#references-9">References</a></h2>
<ol>
<li><a href="vac/raw/../32/rln-v1.html">RLN spec</a></li>
<li><a href="https://interep.link">Interep</a></li>
<li><a href="https://semaphore.appliedzkp.org/">Semaphore</a></li>
<li><a href="https://ethresear.ch/t/decentralised-cloudflare-using-rln-and-rich-user-identities/10774">Decentralized cloudflare using Interep</a></li>
<li><a href="https://github.com/interep-project/contracts">Interep contracts</a></li>
<li><a href="https://github.com/vacp2p/rln-contract">RLN contract</a></li>
<li><a href="https://rlnp2p.vac.dev/">RLNP2P</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rln-stealth-commitments"><a class="header" href="#rln-stealth-commitments">RLN-STEALTH-COMMITMENTS</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>RLN Stealth Commitment Usage</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Aaryamann Challani &lt;p1ge0nh8er@proton.me&gt;</td></tr>
<tr><th>Contributors</th><td>Jimmy Debe &lt;jimmy@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-16"><a class="header" href="#timeline-16">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/raw/rln-stealth-commitments.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/raw/rln-stealth-commitments.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/vac/raw/rln-stealth-commitments.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-08-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eb25cd06d679e94409072a96841de16a6b3910d5/vac/raw/rln-stealth-commitments.md"><code>eb25cd0</code></a> — chore: replace email addresses (#86)</li>
<li><strong>2024-04-15</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/0b0e00f510f5995b612b4ac8c50c51f9d938dfc8/vac/raw/rln-stealth-commitments.md"><code>0b0e00f</code></a> — feat(rln-stealth-commitments): add initial tech writeup (#23)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-8"><a class="header" href="#abstract-8">Abstract</a></h2>
<p>This specification describes the usage of stealth commitments
to add prospective users to a network-governed
<a href="vac/raw/./32/rln-v1.html">32/RLN-V1</a> membership set.</p>
<h2 id="motivation-10"><a class="header" href="#motivation-10">Motivation</a></h2>
<p>When <a href="vac/raw/./32/rln-v1.html">32/RLN-V1</a> is enforced in <a href="vac/raw/../waku/standards/core/10/waku2.html">10/Waku2</a>,
all users are required to register to a membership set.
The membership set will store user identities
allowing the secure interaction within an application.
Forcing a user to do an on-chain transaction
to join a membership set is an onboarding friction,
and some projects may be opposed to this method.
To improve the user experience,
stealth commitments can be used by a counterparty
to register identities on the user's behalf,
while maintaining the user's anonymity.</p>
<p>This document specifies a privacy-preserving mechanism,
allowing a counterparty to utilize <a href="vac/raw/./32/rln-v1.html">32/RLN-V1</a>
to register an <code>identityCommitment</code> on-chain.
Counterparties will be able to register members
to a RLN membership set without exposing the user's private keys.</p>
<h2 id="background-2"><a class="header" href="#background-2">Background</a></h2>
<p>The <a href="vac/raw/./32/rln-v1.html">32/RLN-V1</a> protocol,
consists of a smart contract that stores a <code>idenitityCommitment</code>
in a membership set.
In order for a user to join the membership set,
the user is required to make a transaction on the blockchain.
A set of public keys is used to compute a stealth commitment for a user,
as described in <a href="https://eips.ethereum.org/EIPS/eip-5564">ERC-5564</a>.
This specification is an implementation of the
<a href="https://eips.ethereum.org/EIPS/eip-5564">ERC-5564</a> scheme,
tailored to the curve that is used in the <a href="vac/raw/./32/rln-v1.html">32/RLN-V1</a> protocol.</p>
<p>This can be used in a couple of ways in applications:</p>
<ol>
<li>Applications can add users
to the <a href="vac/raw/./32/rln-v1.html">32/RLN-V1</a> membership set in a batch.</li>
<li>Users of the application
can register other users to the <a href="vac/raw/./32/rln-v1.html">32/RLN-V1</a> membership set.</li>
</ol>
<p>This is useful when the prospective user does not have access to funds
on the network that <a href="vac/raw/./32/rln-v1.html">32/RLN-V1</a> is deployed on.</p>
<h2 id="wire-format-specification-1"><a class="header" href="#wire-format-specification-1">Wire Format Specification</a></h2>
<p>The two parties, the requester and the receiver,
MUST exchange the following information:</p>
<pre><code class="language-protobuf">
message Request {
  // The spending public key of the requester
  bytes spending_public_key = 1;

  // The viewing public key of the requester
  bytes viewing_public_key = 2;
}
</code></pre>
<h3 id="generate-stealth-commitment"><a class="header" href="#generate-stealth-commitment">Generate Stealth Commitment</a></h3>
<p>The application or user SHOULD generate a <code>stealth_commitment</code>
after a request to do so is received.
This commitment MAY be inserted into the corresponding application membership set.</p>
<p>Once the membership set is updated,
the receiver SHOULD exchange the following as a response to the request:</p>
<pre><code class="language-protobuf">
message Response {
  
  // The used to check if the stealth_commitment belongs to the requester
  bytes view_tag = 2;

  // The stealth commitment for the requester
  bytes stealth_commitment = 3;

  // The ephemeral public key used to generate the commitment
  bytes ephemeral_public_key = 4;

}

</code></pre>
<p>The receiver MUST generate an <code>ephemeral_public_key</code>,
<code>view_tag</code> and <code>stealth_commitment</code>.
This will be used to check the stealth commitment
used to register to the membership set,
and the user MUST be able to check ownership with their <code>viewing_public_key</code>.</p>
<h2 id="implementation-suggestions"><a class="header" href="#implementation-suggestions">Implementation Suggestions</a></h2>
<p>An implementation of the Stealth Address scheme is available in the
<a href="https://github.com/rymnc/erc-5564-bn254">erc-5564-bn254</a> repository,
which also includes a test to generate a stealth commitment for a given user.</p>
<h2 id="securityprivacy-considerations-1"><a class="header" href="#securityprivacy-considerations-1">Security/Privacy Considerations</a></h2>
<p>This specification inherits the security and privacy considerations of the
<a href="https://eips.ethereum.org/EIPS/eip-5564">Stealth Address</a> scheme.</p>
<h2 id="copyright-11"><a class="header" href="#copyright-11">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-10"><a class="header" href="#references-10">References</a></h2>
<ul>
<li><a href="vac/raw/../waku/standards/core/10/waku2.html">10/Waku2</a></li>
<li><a href="vac/raw/./32/rln-v1.html">32/RLN-V1</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-5564">ERC-5564</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rln-v2"><a class="header" href="#rln-v2">RLN-V2</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Rate Limit Nullifier V2</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Editor</th><td>Rasul Ibragimov &lt;curryrasul@gmail.com&gt;</td></tr>
<tr><th>Contributors</th><td>Lev Soukhanov &lt;0xdeadfae@gmail.com&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-17"><a class="header" href="#timeline-17">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/raw/rln-v2.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/raw/rln-v2.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/vac/raw/rln-v2.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-05-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/99be3b974509ea03561c7ef4b1b02a56f24e9297/vac/raw/rln-v2.md"><code>99be3b9</code></a> — Move Raw Specs (#37)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/83426365f7b85619052172be4e55a5f2b9b052a0/vac/58/rln-v2.md"><code>8342636</code></a> — Update and rename RLN-V2.md to rln-v2.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d7e84b4762946426e7317ec43e27dfd0738ec39b/vac/58/RLN-V2.md"><code>d7e84b4</code></a> — Create RLN-V2.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-9"><a class="header" href="#abstract-9">Abstract</a></h2>
<p>The protocol specified in this document is an improvement of <a href="vac/raw/../32/rln-v1.html">32/RLN-V1</a>,
being more general construct, that allows to set various limits for an epoch
(it's 1 message per epoch in <a href="vac/raw/../32/rln-v1.html">32/RLN-V1</a>)
while remaining almost as simple as it predecessor.
Moreover, it allows to set different rate-limits
for different RLN app users based on some public data,
e.g. stake or reputation.</p>
<h2 id="motivation-11"><a class="header" href="#motivation-11">Motivation</a></h2>
<p>The main goal of this RFC is to generalize <a href="vac/raw/../32/rln-v1.html">32/RLN-V1</a> and
expand its applications.
There are two different subprotocols based on this protocol:</p>
<ul>
<li>RLN-Same - RLN with the same rate-limit for all users;</li>
<li>RLN-Diff - RLN that allows to set different rate-limits for different users.</li>
</ul>
<p>It is important to note that by using a large epoch limit value,
users will be able to remain anonymous,
because their <code>internal_nullifiers</code> will not be repeated until they exceed the limit.</p>
<h2 id="flow-5"><a class="header" href="#flow-5">Flow</a></h2>
<p>As in <a href="vac/raw/../32/rln-v1.html">32/RLN-V1</a>, the general flow can be described by three steps:</p>
<ol>
<li>Registration</li>
<li>Signaling</li>
<li>Verification and slashing</li>
</ol>
<p>The two sub-protocols have different flows, and
hence are defined separately.</p>
<h3 id="important-note"><a class="header" href="#important-note">Important note</a></h3>
<p>All terms and parameters used remain the same as in <a href="vac/raw/../32/rln-v1.html">32/RLN-V1</a>,
more details <a href="vac/raw/../32/rln-v1.html">here</a></p>
<h2 id="rln-same-flow"><a class="header" href="#rln-same-flow">RLN-Same flow</a></h2>
<h3 id="registration-1"><a class="header" href="#registration-1">Registration</a></h3>
<p>The registration process in the RLN-Same subprotocol does not differ from <a href="vac/raw/../32/rln-v1.html">32/RLN-V1</a>.</p>
<p>Signalling</p>
<p>For proof generation, the user needs to submit the following fields to the circuit:</p>
<pre><code class="language-js">{
    identity_secret: identity_secret_hash,
    path_elements: Merkle_proof.path_elements,
    identity_path_index: Merkle_proof.indices,
    x: signal_hash,
    message_id: message_id,
    external_nullifier: external_nullifier,
    message_limit: message_limit
}
</code></pre>
<p>Calculating output</p>
<p>The following fields are needed for proof output calculation:</p>
<pre><code class="language-js">{
    identity_secret_hash: bigint, 
    external_nullifier: bigint,
    message_id: bigint,
    x: bigint, 
}
</code></pre>
<p>The output <code>[y, internal_nullifier]</code> is calculated in the following way:</p>
<pre><code class="language-js">a_0 = identity_secret_hash
a_1 = poseidonHash([a0, external_nullifier, message_id])

y = a_0 + x * a_1

internal_nullifier = poseidonHash([a_1])
</code></pre>
<h2 id="rln-diff-flow"><a class="header" href="#rln-diff-flow">RLN-Diff flow</a></h2>
<p>Registration</p>
<p><strong>id_commitment</strong> in <a href="vac/raw/../32/rln-v1.html">32/RLN-V1</a> is equal to <code>poseidonHash(identity_secret)</code>.
The goal of RLN-Diff is to set different rate-limits for different users.
It follows that <strong>id_commitment</strong> must somehow depend
on the <code>user_message_limit</code> parameter,
where 0 &lt;= <code>user_message_limit</code> &lt;= <code>message_limit</code>.
There are few ways to do that:</p>
<ol>
<li>Sending <code>identity_secret_hash</code> = <code>poseidonHash(identity_secret, userMessageLimit)</code>
and zk proof that <code>user_message_limit</code> is valid (is in the right range).
This approach requires zkSNARK verification,
which is an expensive operation on the blockchain.</li>
<li>Sending the same <code>identity_secret_hash</code> as in <a href="vac/raw/../32/rln-v1.html">32/RLN-V1</a>
(<code>poseidonHash(identity_secret)</code>) and a user_message_limit publicly to a server
or smart-contract where
<code>rate_commitment</code> = <code>poseidonHash(identity_secret_hash, userMessageLimit)</code> is calculated.
The leaves in the membership Merkle tree would be the rate_commitments of the users.
This approach requires additional hashing in the Circuit, but
it eliminates the need for zk proof verification for the registration.</li>
</ol>
<p>Both methods are correct, and the choice of the method is left to the implementer.
It is recommended to use second method for the reasons already described.
The following flow description will also be based on the second method.</p>
<p>Signalling</p>
<p>For proof generation, the user need to submit the following fields to the circuit:</p>
<pre><code class="language-js">{
    identity_secret: identity_secret_hash,
    path_elements: Merkle_proof.path_elements,
    identity_path_index: Merkle_proof.indices,
    x: signal_hash,
    message_id: message_id,
    external_nullifier: external_nullifier,
    user_message_limit: message_limit
}
</code></pre>
<p>Calculating output</p>
<p>The Output is calculated in the same way as the RLN-Same sub-protocol.</p>
<h3 id="verification-and-slashing-1"><a class="header" href="#verification-and-slashing-1">Verification and slashing</a></h3>
<p>Verification and slashing in both subprotocols remain the same as in <a href="vac/raw/../32/rln-v1.html">32/RLN-V1</a>.
The only difference that may arise is the <code>message_limit</code> check in RLN-Same,
since it is now a public input of the Circuit.</p>
<h3 id="zk-circuits-specification"><a class="header" href="#zk-circuits-specification">ZK Circuits specification</a></h3>
<p>The design of the <a href="vac/raw/../32/rln-v1.html">32/RLN-V1</a> circuits
is different from the circuits of this protocol.
RLN-v2 requires additional algebraic constraints.
The membership proof and Shamir's Secret Sharing constraints remain unchanged.</p>
<p>The ZK Circuit is implemented using a <a href="https://eprint.iacr.org/2016/260.pdf">Groth-16 ZK-SNARK</a>,
using the <a href="https://docs.circom.io/">circomlib</a> library.
Both schemes contain compile-time constants/system parameters:</p>
<ul>
<li>DEPTH - depth of membership Merkle tree</li>
<li>LIMIT_BIT_SIZE - bit size of <code>limit</code> numbers,
e.g. for the 16 - maximum <code>limit</code> number is 65535.</li>
</ul>
<p>The main difference of the protocol is that instead of a new polynomial
(a new value <code>a_1</code>) for a new epoch, a new polynomial is generated for each message.
The user assigns an identifier to each message;
the main requirement is that this identifier be in the range from 1 to <code>limit</code>.
This is proven using range constraints.</p>
<h3 id="rln-same-circuit"><a class="header" href="#rln-same-circuit">RLN-Same circuit</a></h3>
<h4 id="circuit-parameters-1"><a class="header" href="#circuit-parameters-1">Circuit parameters</a></h4>
<p>Public Inputs</p>
<ul>
<li><code>x</code></li>
<li><code>external_nullifier</code></li>
<li><code>message_limit</code> - limit per epoch</li>
</ul>
<p>Private Inputs</p>
<ul>
<li><code>identity_secret_hash</code></li>
<li><code>path_elements</code></li>
<li><code>identity_path_index</code></li>
<li><code>message_id</code></li>
</ul>
<p>Outputs</p>
<ul>
<li><code>y</code></li>
<li><code>root</code></li>
<li><code>internal_nullifier</code></li>
</ul>
<h3 id="rln-diff-circuit"><a class="header" href="#rln-diff-circuit">RLN-Diff circuit</a></h3>
<p>In the RLN-Diff scheme, instead of the public parameter <code>message_limit</code>,
a parameter is used that is set for each user during registration (<code>user_message_limit</code>);
the <code>message_id</code> value is compared to it in the same way
as it is compared to <code>message_limit</code> in the case of RLN-Same.</p>
<p>Circuit parameters</p>
<p>Public Inputs</p>
<ul>
<li><code>x</code></li>
<li><code>external_nullifier</code></li>
</ul>
<p>Private Inputs</p>
<ul>
<li><code>identity_secret_hash</code></li>
<li><code>path_elements</code></li>
<li><code>identity_path_index</code></li>
<li><code>message_id</code></li>
<li><code>user_message_limit</code></li>
</ul>
<p>Outputs</p>
<ul>
<li><code>y</code></li>
<li><code>root</code></li>
<li><code>internal_nullifier</code></li>
</ul>
<h2 id="appendix-a-security-considerations-1"><a class="header" href="#appendix-a-security-considerations-1">Appendix A: Security considerations</a></h2>
<p>Although there are changes in the circuits,
this spec inherits all the security considerations of <a href="vac/raw/../32/rln-v1.html">32/RLN-V1</a>.</p>
<h2 id="copyright-12"><a class="header" href="#copyright-12">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-11"><a class="header" href="#references-11">References</a></h2>
<ul>
<li><a href="https://zkresear.ch/t/rate-limit-nullifier-v2-circuits/102">1</a></li>
<li><a href="https://github.com/Rate-Limiting-Nullifier/rln-circuits-v2">2</a></li>
<li><a href="vac/raw/../32/rln-v1.html">3</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sds"><a class="header" href="#sds">SDS</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Scalable Data Sync protocol for distributed logs</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Editor</th><td>Hanno Cornelius &lt;hanno@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Akhil Peddireddy &lt;akhil@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-18"><a class="header" href="#timeline-18">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/vac/raw/sds.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/vac/raw/sds.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-10-24</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/69802377a8c1df53659ac05c7aa93543be4b3e4a/vac/raw/sds.md"><code>6980237</code></a> — Fix Linting Errors (#204)</li>
<li><strong>2025-10-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/171e934d6186a5952f0458bbe42c966859fe2a31/vac/raw/sds.md"><code>171e934</code></a> — docs: add SDS-Repair extension (#176)</li>
<li><strong>2025-10-02</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/6672c5bedf5a08d3045d3b7d23d2b7a2e5d3aa2f/vac/raw/sds.md"><code>6672c5b</code></a> — docs: update lamport timestamps to uint64, pegged to current time (#196)</li>
<li><strong>2025-09-15</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1da70386edb15303fb8aa587b8a5da784a2d644/vac/raw/sds.md"><code>b1da703</code></a> — fix: use milliseconds for Lamport timestamp initialization (#179)</li>
<li><strong>2025-08-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3505da6bd66d2830e5711deb0b5c2b4de9212a4d/vac/raw/sds.md"><code>3505da6</code></a> — sds lint fix (#177)</li>
<li><strong>2025-08-19</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/536d31b5b7641bd451cf35b94e8de1aa8a6c9f64/vac/raw/sds.md"><code>536d31b</code></a> — docs: re-add sender ID to messages (#170)</li>
<li><strong>2025-03-07</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/8ee2a6d6b232838d83374c35e2413f84436ecf64/vac/raw/sds.md"><code>8ee2a6d</code></a> — docs: add optional retrieval hint to causal history in sds (#130)</li>
<li><strong>2025-02-20</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/235c1d5aa676d8278036003d4493c7c32afc033b/vac/raw/sds.md"><code>235c1d5</code></a> — docs: clarify receiving sync messages (#131)</li>
<li><strong>2025-02-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/718245979fd1c67d04d1eab7ea31a4aad6dbc1d2/vac/raw/sds.md"><code>7182459</code></a> — docs: update sds sync message requirements (#129)</li>
<li><strong>2025-01-28</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/7a01711ffc5b50186e111bc2f4fa2e4b02b26bf3/vac/raw/sds.md"><code>7a01711</code></a> — fix(sds): remove optional from causal history field in Message protobuf (#123)</li>
<li><strong>2024-12-17</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/08b363d67e34277e7881a20e36f788978cb0f93c/vac/raw/sds.md"><code>08b363d</code></a> — Update SDS.md: Remove Errors (#115)</li>
<li><strong>2024-11-28</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/bee78c40b9a94ed4c40fe6ba2505b6b0654206b4/vac/raw/sds.md"><code>bee78c4</code></a> — docs: add SDS protocol for scalable e2e reliability (#108)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-10"><a class="header" href="#abstract-10">Abstract</a></h2>
<p>This specification introduces the Scalable Data Sync (SDS) protocol
to achieve end-to-end reliability
when consolidating distributed logs in a decentralized manner.
The protocol is designed for a peer-to-peer (p2p) topology
where an append-only log is maintained by each member of a group of nodes
who may individually append new entries to their local log at any time and
is interested in merging new entries from other nodes in real-time or close to real-time
while maintaining a consistent order.
The outcome of the log consolidation procedure is
that all nodes in the group eventually reflect in their own logs
the same entries in the same order.
The protocol aims to scale to very large groups.</p>
<h2 id="motivation-12"><a class="header" href="#motivation-12">Motivation</a></h2>
<p>A common application that fits this model is a p2p group chat (or group communication),
where the participants act as log nodes
and the group conversation is modelled as the consolidated logs
maintained on each node.
The problem of end-to-end reliability can then be stated as
ensuring that all participants eventually see the same sequence of messages
in the same causal order,
despite the challenges of network latency, message loss,
and scalability present in any communications transport layer.
The rest of this document will assume the terminology of a group communication:
log nodes being the <em>participants</em> in the group chat
and the logged entries being the <em>messages</em> exchanged between participants.</p>
<h2 id="design-assumptions"><a class="header" href="#design-assumptions">Design Assumptions</a></h2>
<p>We make the following simplifying assumptions for a proposed reliability protocol:</p>
<ul>
<li><strong>Broadcast routing:</strong>
Messages are broadcast disseminated by the underlying transport.
The selected transport takes care of routing messages
to all participants of the communication.</li>
<li><strong>Store nodes:</strong>
There are high-availability caches (a.k.a. Store nodes)
from which missed messages can be retrieved.
These caches maintain the full history of all messages that have been broadcast.
This is an optional element in the protocol design,
but improves scalability by reducing direct interactions between participants.</li>
<li><strong>Message ID:</strong>
Each message has a globally unique, immutable ID (or hash).
Messages can be requested from the high-availability caches or
other participants using the corresponding message ID.</li>
<li><strong>Participant ID:</strong>
Each participant has a globally unique, immutable ID
visible to other participants in the communication.</li>
<li><strong>Sender ID:</strong>
The <strong>Participant ID</strong> of the original sender of a message,
often coupled with a <strong>Message ID</strong>.</li>
</ul>
<h2 id="wire-protocol-2"><a class="header" href="#wire-protocol-2">Wire protocol</a></h2>
<p>The keywords “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”,
“SHOULD NOT”, “RECOMMENDED”, “MAY”, and
“OPTIONAL” in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">2119</a>.</p>
<h3 id="message"><a class="header" href="#message">Message</a></h3>
<p>Messages MUST adhere to the following meta structure:</p>
<pre><code class="language-protobuf">syntax = "proto3";

message HistoryEntry {
  string message_id = 1; // Unique identifier of the SDS message, as defined in `Message`
  optional bytes retrieval_hint = 2; // Optional information to help remote parties retrieve this SDS message; For example, A Waku deterministic message hash or routing payload hash

  optional string sender_id = 3; // Participant ID of original message sender. Only populated if using optional SDS Repair extension
}

message Message {
  string sender_id = 1;           // Participant ID of the message sender
  string message_id = 2;          // Unique identifier of the message
  string channel_id = 3;          // Identifier of the channel to which the message belongs
  optional uint64 lamport_timestamp = 10;    // Logical timestamp for causal ordering in channel
  repeated HistoryEntry causal_history = 11;  // List of preceding message IDs that this message causally depends on. Generally 2 or 3 message IDs are included.
  optional bytes bloom_filter = 12;         // Bloom filter representing received message IDs in channel

  repeated HistoryEntry repair_request = 13; // Capped list of history entries missing from sender's causal history. Only populated if using the optional SDS Repair extension.

  optional bytes content = 20;             // Actual content of the message
}
</code></pre>
<p>The sending participant MUST include its own globally unique identifier in the <code>sender_id</code> field.
In addition, it MUST include a globally unique identifier for the message in the <code>message_id</code> field,
likely based on a message hash.
The <code>channel_id</code> field MUST be set to the identifier of the channel of group communication
that is being synchronized.
For simple group communications without individual channels,
the <code>channel_id</code> SHOULD be set to <code>0</code>.
The <code>lamport_timestamp</code>, <code>causal_history</code> and
<code>bloom_filter</code> fields MUST be set according to the <a href="vac/raw/sds.html#protocol-steps">protocol steps</a>
set out below.
These fields MAY be left unset in the case of <a href="vac/raw/sds.html#ephemeral-messages">ephemeral messages</a>.
The message <code>content</code> MAY be left empty for <a href="vac/raw/sds.html#periodic-sync-message">periodic sync messages</a>,
otherwise it MUST contain the application-level content</p>
<blockquote>
<p><strong><em>Note:</em></strong> Close readers may notice that,
outside of filtering messages originating from the sender itself,
the <code>sender_id</code> field is not used for much.
Its importance is expected to increase once a p2p retrieval mechanism is added to SDS,
as is planned for the protocol.</p>
</blockquote>
<h3 id="participant-state"><a class="header" href="#participant-state">Participant state</a></h3>
<p>Each participant MUST maintain:</p>
<ul>
<li>A Lamport timestamp for each channel of communication,
initialized to current epoch time in millisecond resolution.
The Lamport timestamp is increased as described in the <a href="vac/raw/sds.html#protocol-steps">protocol steps</a>
to maintain a logical ordering of events while staying close to the current epoch time.
This allows the messages from new joiners to be correctly ordered with other recent messages,
without these new participants first having to synchronize past messages to discover the current Lamport timestamp.</li>
<li>A bloom filter for received message IDs per channel.
The bloom filter SHOULD be rolled over and
recomputed once it reaches a predefined capacity of message IDs.
Furthermore,
it SHOULD be designed to minimize false positives through an optimal selection of
size and hash functions.</li>
<li>A buffer for unacknowledged outgoing messages</li>
<li>A buffer for incoming messages with unmet causal dependencies</li>
<li>A local log (or history) for each channel,
containing all message IDs in the communication channel,
ordered by Lamport timestamp.</li>
</ul>
<p>Messages in the unacknowledged outgoing buffer can be in one of three states:</p>
<ol>
<li><strong>Unacknowledged</strong> - there has been no acknowledgement of message receipt
by any participant in the channel</li>
<li><strong>Possibly acknowledged</strong> - there has been ambiguous indication that the message
has been <em>possibly</em> received by at least one participant in the channel</li>
<li><strong>Acknowledged</strong> - there has been sufficient indication that the message
has been received by at least some of the participants in the channel.
This state will also remove the message from the outgoing buffer.</li>
</ol>
<h3 id="protocol-steps"><a class="header" href="#protocol-steps">Protocol Steps</a></h3>
<p>For each channel of communication,
participants MUST follow these protocol steps to populate and interpret
the <code>lamport_timestamp</code>, <code>causal_history</code> and <code>bloom_filter</code> fields.</p>
<h4 id="send-message"><a class="header" href="#send-message">Send Message</a></h4>
<p>Before broadcasting a message:</p>
<ul>
<li>the participant MUST set its local Lamport timestamp
to the maximum between the current value + <code>1</code>
and the current epoch time in milliseconds.
In other words the local Lamport timestamp is set to <code>max(timeNowInMs, current_lamport_timestamp + 1)</code>.</li>
<li>the participant MUST include the increased Lamport timestamp in the message's <code>lamport_timestamp</code> field.</li>
<li>the participant MUST determine the preceding few message IDs in the local history
and include these in an ordered list in the <code>causal_history</code> field.
The number of message IDs to include in the <code>causal_history</code> depends on the application.
We recommend a causal history of two message IDs.</li>
<li>the participant MAY include a <code>retrieval_hint</code> in the <code>HistoryEntry</code>
for each message ID in the <code>causal_history</code> field.
This is an application-specific field to facilitate retrieval of messages,
e.g. from high-availability caches.</li>
<li>the participant MUST include the current <code>bloom_filter</code>
state in the broadcast message.</li>
</ul>
<p>After broadcasting a message,
the message MUST be added to the participant’s buffer
of unacknowledged outgoing messages.</p>
<h4 id="receive-message"><a class="header" href="#receive-message">Receive Message</a></h4>
<p>Upon receiving a message,</p>
<ul>
<li>the participant SHOULD ignore the message if it has a <code>sender_id</code> matching its own.</li>
<li>the participant MAY deduplicate the message by comparing its <code>message_id</code> to previously received message IDs.</li>
<li>the participant MUST <a href="vac/raw/sds.html#review-ack-status">review the ACK status</a> of messages
in its unacknowledged outgoing buffer
using the received message's causal history and bloom filter.</li>
<li>if the message has a populated <code>content</code> field,
the participant MUST include the received message ID in its local bloom filter.</li>
<li>the participant MUST verify that all causal dependencies are met
for the received message.
Dependencies are met if the message IDs in the <code>causal_history</code> of the received message
appear in the local history of the receiving participant.</li>
</ul>
<p>If all dependencies are met and the message has a populated <code>content</code> field,
the participant MUST <a href="vac/raw/sds.html#deliver-message">deliver the message</a>.
If dependencies are unmet,
the participant MUST add the message to the incoming buffer of messages
with unmet causal dependencies.</p>
<h4 id="deliver-message"><a class="header" href="#deliver-message">Deliver Message</a></h4>
<p>Triggered by the <a href="vac/raw/sds.html#receive-message">Receive Message</a> procedure.</p>
<p>If the received message’s Lamport timestamp is greater than the participant's
local Lamport timestamp,
the participant MUST update its local Lamport timestamp to match the received message.
The participant MUST insert the message ID into its local log,
based on Lamport timestamp.
If one or more message IDs with the same Lamport timestamp already exists,
the participant MUST follow the <a href="vac/raw/sds.html#resolve-conflicts">Resolve Conflicts</a> procedure.</p>
<h4 id="resolve-conflicts"><a class="header" href="#resolve-conflicts">Resolve Conflicts</a></h4>
<p>Triggered by the <a href="vac/raw/sds.html#deliver-message">Deliver Message</a> procedure.</p>
<p>The participant MUST order messages with the same Lamport timestamp
in ascending order of message ID.
If the message ID is implemented as a hash of the message,
this means the message with the lowest hash would precede
other messages with the same Lamport timestamp in the local log.</p>
<h4 id="review-ack-status"><a class="header" href="#review-ack-status">Review ACK Status</a></h4>
<p>Triggered by the <a href="vac/raw/sds.html#receive-message">Receive Message</a> procedure.</p>
<p>For each message in the unacknowledged outgoing buffer,
based on the received <code>bloom_filter</code> and <code>causal_history</code>:</p>
<ul>
<li>the participant MUST mark all messages in the received <code>causal_history</code> as <strong>acknowledged</strong>.</li>
<li>the participant MUST mark all messages included in the <code>bloom_filter</code>
as <strong>possibly acknowledged</strong>.
If a message appears as <strong>possibly acknowledged</strong> in multiple received bloom filters,
the participant MAY mark it as acknowledged based on probabilistic grounds,
taking into account the bloom filter size and hash number.</li>
</ul>
<h4 id="periodic-incoming-buffer-sweep"><a class="header" href="#periodic-incoming-buffer-sweep">Periodic Incoming Buffer Sweep</a></h4>
<p>The participant MUST periodically check causal dependencies for each message
in the incoming buffer.
For each message in the incoming buffer:</p>
<ul>
<li>the participant MAY attempt to retrieve missing dependencies from the Store node
(high-availability cache) or other peers.
It MAY use the application-specific <code>retrieval_hint</code> in the <code>HistoryEntry</code> to facilitate retrieval.</li>
<li>if all dependencies of a message are met,
the participant MUST proceed to <a href="vac/raw/sds.html#deliver-message">deliver the message</a>.</li>
</ul>
<p>If a message's causal dependencies have failed to be met
after a predetermined amount of time,
the participant MAY mark them as <strong>irretrievably lost</strong>.</p>
<h4 id="periodic-outgoing-buffer-sweep"><a class="header" href="#periodic-outgoing-buffer-sweep">Periodic Outgoing Buffer Sweep</a></h4>
<p>The participant MUST rebroadcast <strong>unacknowledged</strong> outgoing messages
after a set period.
The participant SHOULD use distinct resend periods for <strong>unacknowledged</strong> and
<strong>possibly acknowledged</strong> messages,
prioritizing <strong>unacknowledged</strong> messages.</p>
<h4 id="periodic-sync-message"><a class="header" href="#periodic-sync-message">Periodic Sync Message</a></h4>
<p>For each channel of communication,
participants SHOULD periodically send sync messages to maintain state.
These sync messages:</p>
<ul>
<li>MUST be sent with empty content</li>
<li>MUST include a Lamport timestamp increased to <code>max(timeNowInMs, current_lamport_timestamp + 1)</code>,
where <code>timeNowInMs</code> is the current epoch time in milliseconds.</li>
<li>MUST include causal history and bloom filter according to regular message rules</li>
<li>MUST NOT be added to the unacknowledged outgoing buffer</li>
<li>MUST NOT be included in causal histories of subsequent messages</li>
<li>MUST NOT be included in bloom filters</li>
<li>MUST NOT be added to the local log</li>
</ul>
<p>Since sync messages are not persisted,
they MAY have non-unique message IDs without impacting the protocol.
To avoid network activity bursts in large groups,
a participant MAY choose to only send periodic sync messages
if no other messages have been broadcast in the channel after a random backoff period.</p>
<p>Participants MUST process the causal history and bloom filter of these sync messages
following the same steps as regular messages,
but MUST NOT persist the sync messages themselves.</p>
<h4 id="ephemeral-messages"><a class="header" href="#ephemeral-messages">Ephemeral Messages</a></h4>
<p>Participants MAY choose to send short-lived messages for which no synchronization
or reliability is required.
These messages are termed <em>ephemeral</em>.</p>
<p>Ephemeral messages SHOULD be sent with <code>lamport_timestamp</code>, <code>causal_history</code>, and
<code>bloom_filter</code> unset.
Ephemeral messages SHOULD NOT be added to the unacknowledged outgoing buffer
after broadcast.
Upon reception,
ephemeral messages SHOULD be delivered immediately without buffering for causal dependencies
or including in the local log.</p>
<h3 id="sds-repair-sds-r"><a class="header" href="#sds-repair-sds-r">SDS Repair (SDS-R)</a></h3>
<p>SDS Repair (SDS-R) is an optional extension module for SDS,
allowing participants in a communication to collectively repair any gaps in causal history (missing messages)
preferably over a limited time window.
Since SDS-R acts as coordinated rebroadcasting of missing messages,
which involves all participants of the communication,
it is most appropriate in a limited use case for repairing relatively recent missed dependencies.
It is not meant to replace mechanisms for long-term consistency,
such as peer-to-peer syncing or the use of a high-availability centralised cache (Store node).</p>
<h4 id="sds-r-message-fields"><a class="header" href="#sds-r-message-fields">SDS-R message fields</a></h4>
<p>SDS-R adds the following fields to SDS messages:</p>
<ul>
<li><code>sender_id</code> in <code>HistoryEntry</code>:
the original message sender's participant ID.
This is used to determine the group of participants who will respond to a repair request.</li>
<li><code>repair_request</code> in <code>Message</code>:
a capped list of history entries missing for the message sender
and for which it's requesting a repair.</li>
</ul>
<h4 id="sds-r-participant-state"><a class="header" href="#sds-r-participant-state">SDS-R participant state</a></h4>
<p>SDS-R adds the following to each participant state:</p>
<ul>
<li>
<p>Outgoing <strong>repair request buffer</strong>:
a list of locally missing <code>HistoryEntry</code>s
each mapped to a future request timestamp, <code>T_req</code>,
after which this participant will request a repair if at that point the missing dependency has not been repaired yet.
<code>T_req</code> is computed as a pseudorandom backoff from the timestamp when the dependency was detected missing.
<a href="vac/raw/sds.html#determine-t_req">Determining <code>T_req</code></a> is described below.
We RECOMMEND that the outgoing repair request buffer be chronologically ordered in ascending order of <code>T_req</code>.</p>
</li>
<li>
<p>Incoming <strong>repair request buffer</strong>:
a list of locally available <code>HistoryEntry</code>s
that were requested for repair by a remote participant
AND for which this participant might be an eligible responder,
each mapped to a future response timestamp, <code>T_resp</code>,
after which this participant will rebroadcast the corresponding requested <code>Message</code> if at that point no other participant had rebroadcast the <code>Message</code>.
<code>T_resp</code> is computed as a pseudorandom backoff from the timestamp when the repair was first requested.
<a href="vac/raw/sds.html#determine-t_resp">Determining <code>T_resp</code></a> is described below.
We describe below how a participant can <a href="vac/raw/sds.html#determine-response-group">determine if they're an eligible responder</a> for a specific repair request.</p>
</li>
<li>
<p>Augmented local history log:
for each message ID kept in the local log for which the participant could be a repair responder,
the full SDS <code>Message</code> must be cached rather than just the message ID,
in case this participant is called upon to rebroadcast the message.
We describe below how a participant can <a href="vac/raw/sds.html#determine-response-group">determine if they're an eligible responder</a> for a specific message.</p>
</li>
</ul>
<p><strong><em>Note:</em></strong> The required state can likely be significantly reduced in future by simply requiring that a responding participant should <em>reconstruct</em> the original <code>Message</code> when rebroadcasting, rather than the simpler, but heavier,
requirement of caching the entire received <code>Message</code> content in local history.</p>
<h4 id="sds-r-global-state"><a class="header" href="#sds-r-global-state">SDS-R global state</a></h4>
<p>For a specific channel (that is, within a specific SDS-controlled communication)
the following SDS-R configuration state SHOULD be common for all participants in the conversation:</p>
<ul>
<li><code>T_min</code>: the <em>minimum</em> time period to wait before a missing causal entry can be repaired.
We RECOMMEND a value of at least 30 seconds.</li>
<li><code>T_max</code>: the <em>maximum</em> time period over which missing causal entries can be repaired.
We RECOMMEND a value of between 120 and 600 seconds.</li>
</ul>
<p>Furthermore, to avoid a broadcast storm with multiple participants responding to a repair request,
participants in a single channel MAY be divided into discrete response groups.
Participants will only respond to a repair request if they are in the response group for that request.
The global <code>num_response_groups</code> variable configures the number of response groups for this communication.
Its use is described below.
A reasonable default value for <code>num_response_groups</code> is one response group for every <code>128</code> participants.
In other words, if the (roughly) expected number of participants is expressed as <code>num_participants</code>, then
<code>num_response_groups = num_participants div 128 + 1</code>.
In other words, if there are fewer than 128 participants in a communication,
they will all belong to the same response group.</p>
<p>We RECOMMEND that the global state variables <code>T_min</code>, <code>T_max</code> and <code>num_response_groups</code>
be set <em>statically</em> for a specific SDS-R application,
based on expected number of group participants and volume of traffic.</p>
<p><strong><em>Note:</em></strong> Future versions of this protocol will recommend dynamic global SDS-R variables,
based on the current number of participants.</p>
<h4 id="sds-r-send-message"><a class="header" href="#sds-r-send-message">SDS-R send message</a></h4>
<p>SDS-R adds the following steps when sending a message:</p>
<p>Before broadcasting a message,</p>
<ul>
<li>the participant SHOULD populate the <code>repair_request</code> field in the message
with <em>eligible</em> entries from the outgoing repair request buffer.
An entry is eligible to be included in a <code>repair_request</code>
if its corresponding request timestamp, <code>T_req</code>, has expired (in other words,
<code>T_req &lt;= current_time</code>).
The maximum number of repair request entries to include is up to the application.
We RECOMMEND that this quota be filled by the eligible entries from the outgoing repair request buffer with the lowest <code>T_req</code>.
We RECOMMEND a maximum of 3 entries.
If there are no eligible entries in the buffer,
this optional field MUST be left unset.</li>
</ul>
<h4 id="sds-r-receive-message"><a class="header" href="#sds-r-receive-message">SDS-R receive message</a></h4>
<p>On receiving a message,</p>
<ul>
<li>the participant MUST remove entries matching the received message ID from its <em>outgoing</em> repair request buffer.
This ensures that the participant does not request repairs for dependencies that have now been met.</li>
<li>the participant MUST remove entries matching the received message ID from its <em>incoming</em> repair request buffer.
This ensures that the participant does not respond to repair requests that another participant has already responded to.</li>
<li>the participant SHOULD add any unmet causal dependencies to its outgoing repair request buffer against a unique <code>T_req</code> timestamp for that entry.
It MUST compute the <code>T_req</code> for each such HistoryEntry according to the steps outlined in <a href="vac/raw/sds.html#determine-t_req"><em>Determine T_req</em></a>.</li>
<li>for each item in the <code>repair_request</code> field:
<ul>
<li>the participant MUST remove entries matching the repair message ID from its own outgoing repair request buffer.
This limits the number of participants that will request a common missing dependency.</li>
<li>if the participant has the requested <code>Message</code> in its local history <em>and</em> is an eligible responder for the repair request,
it SHOULD add the request to its incoming repair request buffer against a unique <code>T_resp</code> timestamp for that entry.
It MUST compute the <code>T_resp</code> for each such repair request according to the steps outlined in <a href="vac/raw/sds.html#determine-t_resp"><em>Determine T_resp</em></a>.
It MUST determine if it's an eligible responder for a repair request according to the steps outlined in <a href="vac/raw/sds.html#determine-response-group"><em>Determine response group</em></a>.</li>
</ul>
</li>
</ul>
<h4 id="determine-t_req"><a class="header" href="#determine-t_req">Determine T_req</a></h4>
<p>A participant determines the repair request timestamp, <code>T_req</code>,
for a missing <code>HistoryEntry</code> as follows:</p>
<pre><code class="language-text">T_req = current_time + hash(participant_id, message_id) % (T_max - T_min) + T_min
</code></pre>
<p>where <code>current_time</code> is the current timestamp,
<code>participant_id</code> is the participant's <em>own</em> participant ID
(not the <code>sender_id</code> in the missing <code>HistoryEntry</code>),
<code>message_id</code> is the missing <code>HistoryEntry</code>'s message ID,
and <code>T_min</code> and <code>T_max</code> are as set out in <a href="vac/raw/sds.html#sds-r-global-state">SDS-R global state</a>.</p>
<p>This allows <code>T_req</code> to be pseudorandomly and linearly distributed as a backoff of between <code>T_min</code> and <code>T_max</code> from current time.</p>
<blockquote>
<p><strong><em>Note:</em></strong> placing <code>T_req</code> values on an exponential backoff curve will likely be more appropriate and is left for a future improvement.</p>
</blockquote>
<h4 id="determine-t_resp"><a class="header" href="#determine-t_resp">Determine T_resp</a></h4>
<p>A participant determines the repair response timestamp, <code>T_resp</code>,
for a <code>HistoryEntry</code> that it could repair as follows:</p>
<pre><code class="language-text">distance = hash(participant_id) XOR hash(sender_id)
T_resp = current_time + distance*hash(message_id) % T_max
</code></pre>
<p>where <code>current_time</code> is the current timestamp,
<code>participant_id</code> is the participant's <em>own</em> (local) participant ID,
<code>sender_id</code> is the requested <code>HistoryEntry</code> sender ID,
<code>message_id</code> is the requested <code>HistoryEntry</code> message ID,
and <code>T_max</code> is as set out in <a href="vac/raw/sds.html#sds-r-global-state">SDS-R global state</a>.</p>
<p>We first calculate the logical <code>distance</code> between the local <code>participant_id</code> and
the original <code>sender_id</code>.
If this participant is the original sender, the <code>distance</code> will be <code>0</code>.
It should then be clear that the original participant will have a response backoff time of <code>0</code>,
making it the most likely responder.
The <code>T_resp</code> values for other eligible participants will be pseudorandomly and
linearly distributed as a backoff of up to <code>T_max</code> from current time.</p>
<blockquote>
<p><strong><em>Note:</em></strong> placing <code>T_resp</code> values on an exponential backoff curve will likely be more appropriate and
is left for a future improvement.</p>
</blockquote>
<h4 id="determine-response-group"><a class="header" href="#determine-response-group">Determine response group</a></h4>
<p>Given a message with <code>sender_id</code> and <code>message_id</code>,
a participant with <code>participant_id</code> is in the response group for that message if</p>
<pre><code class="language-text">hash(participant_id, message_id) % num_response_groups == hash(sender_id, message_id) % num_response_groups
</code></pre>
<p>where <code>num_response_groups</code> is as set out in <a href="vac/raw/sds.html#sds-r-global-state">SDS-R global state</a>.
This ensures that a participant will always be in the response group for its own published messages.
It also allows participants to determine immediately on first reception of a message or
a history entry if they are in the associated response group.</p>
<h4 id="sds-r-incoming-repair-request-buffer-sweep"><a class="header" href="#sds-r-incoming-repair-request-buffer-sweep">SDS-R incoming repair request buffer sweep</a></h4>
<p>An SDS-R participant MUST periodically check if there are any incoming requests in the <strong>incoming</strong> repair request buffer* that is due for a response.
For each item in the buffer,
the participant SHOULD broadcast the corresponding <code>Message</code> from local history
if its corresponding response timestamp, <code>T_resp</code>, has expired
(in other words, <code>T_resp &lt;= current_time</code>).</p>
<h4 id="sds-r-periodic-sync-message"><a class="header" href="#sds-r-periodic-sync-message">SDS-R Periodic Sync Message</a></h4>
<p>If the participant is due to send a periodic sync message,
it SHOULD send the message according to <a href="vac/raw/sds.html#sds-r-send-message">SDS-R send message</a>
if there are any eligible items in the outgoing repair request buffer,
regardless of whether other participants have also recently broadcast a Periodic Sync message.</p>
<h2 id="copyright-13"><a class="header" href="#copyright-13">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="template"><a class="header" href="#template">TEMPLATE</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>RFC Template</td></tr>
<tr><th>Slug</th><td>XX</td></tr>
<tr><th>Status</th><td>raw/draft/stable/deprecated</td></tr>
<tr><th>Category</th><td>Standards Track/Informational/Best Current Practice</td></tr>
<tr><th>Editor</th><td>Daniel Kaiser &lt;danielkaiser@status.im&gt;</td></tr>
</table>
</div>
## (Info, remove this section)
<p>This section contains meta info about writing RFCs.
This section (including its subsections) MUST be removed.</p>
<p><a href="https://rfc.vac.dev/spec/1/">COSS</a> explains the Vac RFC process.</p>
<h2 id="tags"><a class="header" href="#tags">Tags</a></h2>
<p>The <code>tags</code> metadata SHOULD contain a list of tags if applicable.</p>
<p>Currently identified tags comprise</p>
<ul>
<li><code>waku/core-protocol</code> for Waku protocol definitions (e.g. store, relay, light push),</li>
<li><code>waku/application</code> for applications built on top of Waku protocol
(e.g. eth-dm, toy-chat),</li>
</ul>
<h2 id="abstract-11"><a class="header" href="#abstract-11">Abstract</a></h2>
<h2 id="background--rationale--motivation"><a class="header" href="#background--rationale--motivation">Background / Rationale / Motivation</a></h2>
<p>This section serves as an introduction providing background information and
a motivation/rationale for why the specified protocol is useful.</p>
<h2 id="theory--semantics"><a class="header" href="#theory--semantics">Theory / Semantics</a></h2>
<p>A standard track RFC in <code>stable</code> status MUST feature this section.
A standard track RFC in <code>raw</code> or <code>draft</code> status SHOULD feature this section.
This section SHOULD explain in detail how the proposed protocol works.
It may touch on the wire format where necessary for the explanation.
This section MAY also specify endpoint behaviour when receiving specific messages,
e.g. the behaviour of certain caches etc.</p>
<h2 id="wire-format-specification--syntax"><a class="header" href="#wire-format-specification--syntax">Wire Format Specification / Syntax</a></h2>
<p>A standard track RFC in <code>stable</code> status MUST feature this section.
A standard track RFC in <code>raw</code> or <code>draft</code> status SHOULD feature this section.
This section SHOULD not contain explanations of semantics and
focus on concisely defining the wire format.
Implementations MUST adhere to these exact formats to interoperate with other implementations.
It is fine, if parts of the previous section that touch on the wire format are repeated.
The purpose of this section is having a concise definition
of what an implementation sends and accepts.
Parts that are not specified here are considered implementation details.
Implementors are free to decide on how to implement these details.
An optional <em>implementation suggestions</em> section may provide suggestions
on how to approach implementation details, and,
if available, point to existing implementations for reference.</p>
<h2 id="implementation-suggestions-optional"><a class="header" href="#implementation-suggestions-optional">Implementation Suggestions (optional)</a></h2>
<h2 id="further-optional-sections"><a class="header" href="#further-optional-sections">(Further Optional Sections)</a></h2>
<h2 id="securityprivacy-considerations-2"><a class="header" href="#securityprivacy-considerations-2">Security/Privacy Considerations</a></h2>
<p>A standard track RFC in <code>stable</code> status MUST feature this section.
A standard track RFC in <code>raw</code> or <code>draft</code> status SHOULD feature this section.
Informational RFCs (in any state) may feature this section.
If there are none, this section MUST explicitly state that fact.
This section MAY contain additional relevant information,
e.g. an explanation as to why there are no security consideration
for the respective document.</p>
<h2 id="copyright-14"><a class="header" href="#copyright-14">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-12"><a class="header" href="#references-12">References</a></h2>
<p>References MAY be subdivided into normative and informative.</p>
<h2 id="normative"><a class="header" href="#normative">normative</a></h2>
<p>A list of references that MUST be read to fully understand and/or
implement this protocol.
See <a href="https://datatracker.ietf.org/doc/html/rfc3967#section-1.1">RFC3967 Section 1.1</a>.</p>
<h2 id="informative-1"><a class="header" href="#informative-1">informative</a></h2>
<p>A list of additional references.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="waku-rfcs"><a class="header" href="#waku-rfcs">Waku RFCs</a></h1>
<p>Waku builds a family of privacy-preserving,
censorship-resistant communication protocols for web3 applications.</p>
<p>Contributors can visit <a href="https://github.com/waku-org/specs">Waku RFCs</a>
for new Waku specifications under discussion.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="waku-standards---core"><a class="header" href="#waku-standards---core">Waku Standards - Core</a></h1>
<p>Core Waku protocol specifications, including messaging, peer discovery, and network primitives.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="10waku2"><a class="header" href="#10waku2">10/WAKU2</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v2</td></tr>
<tr><th>Slug</th><td>10</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Hanno Cornelius &lt;hanno@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Sanaz Taheri &lt;sanaz@status.im&gt;<br>Hanno Cornelius &lt;hanno@status.im&gt;<br>Reeshav Khan &lt;reeshav@status.im&gt;<br>Daniel Kaiser &lt;danielkaiser@status.im&gt;<br>Oskar Thorén &lt;oskarth@titanproxy.com&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-19"><a class="header" href="#timeline-19">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/core/10/waku2.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/core/10/waku2.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-15</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/34aa3f3647cd5f0ae6a9af7fad47c3c8ee32c866/waku/standards/core/10/waku2.md"><code>34aa3f3</code></a> — Fix links 10/WAKU2 (#153)</li>
<li><strong>2025-04-09</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/cafa04fb93c461034e1754cf750409a6236cf6ee/waku/standards/core/10/waku2.md"><code>cafa04f</code></a> — 10/WAKU2: Update (#125)</li>
<li><strong>2024-11-20</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/ff87c84dc71d4f933bab188993914069fea12baa/waku/standards/core/10/waku2.md"><code>ff87c84</code></a> — Update Waku Links (#104)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/core/10/waku2.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/core/10/waku2.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/8e14d584bf90f59aab790c9b8e62dd6adf5da100/waku/standards/core/10/waku2.md"><code>8e14d58</code></a> — Update waku2.md</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/6cf68fd03e35f5889a827d0e7d053879e2162a4e/waku/standards/core/10/waku2.md"><code>6cf68fd</code></a> — Update waku2.md</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/6734b1690817d1647feeccc07f28c13fc1c3b789/waku/standards/core/10/waku2.md"><code>6734b16</code></a> — Update waku2.md</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/356649a5b690dd56f7de42961eeeeb676dd71b88/waku/standards/core/10/waku2.md"><code>356649a</code></a> — Update and rename WAKU2.md to waku2.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/550238ca71eb03506d400db579d8fdbab1acd6ad/waku/standards/core/10/WAKU2.md"><code>550238c</code></a> — Rename README.md to WAKU2.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/standards/core/10-WAKU2/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-26</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d6651b7f2a72974685871b3c25c7514dd5a4e679/waku/rfcs/standards/core/10-WAKU2/README.md"><code>d6651b7</code></a> — Update README.md</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/6e98666f71f01fd5fa348ba71d8d55a265891a80/waku/rfcs/standards/core/10-WAKU2/README.md"><code>6e98666</code></a> — Rename README.md to README.md</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/9b740d887522349f8d9c80c580d3777d7f6f63af/waku/specs/standards/core/10-WAKU2/README.md"><code>9b740d8</code></a> — Rename waku/10/README.md to waku/specs/standards/core/10-WAKU2/README.md</li>
<li><strong>2024-01-24</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/330c35b56eecf3876c8246fbddb9e40b5211b566/waku/10/README.md"><code>330c35b</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-12"><a class="header" href="#abstract-12">Abstract</a></h2>
<p>Waku is a family of modular peer-to-peer protocols for secure communication.
The protocols are designed to be secure, privacy-preserving, censorship-resistant
and being able to run in resource-restricted environments.
At a high level, it implements Pub/Sub over <a href="https://github.com/libp2p/specs">libp2p</a>
and adds a set of capabilities to it.
These capabilities are things such as:
(i) retrieving historical messages for mostly-offline devices
(ii) adaptive nodes, allowing for heterogeneous nodes to contribute to the network
(iii) preserving bandwidth usage for resource-restriced devices</p>
<p>This makes Waku ideal for running a p2p protocol on mobile devices and
other similar restricted environments.</p>
<p>Historically, it has its roots in <a href="waku/standards/core/10//waku/standards/legacy/6/waku1.html">6/WAKU1</a>,
which stems from <a href="https://eips.ethereum.org/EIPS/eip-627">Whisper</a>,
originally part of the Ethereum stack.
However, Waku acts more as a thin wrapper for Pub/Sub and has a different API.
It is implemented in an iterative manner where initial focus
is on porting essential functionality to libp2p.
See <a href="https://vac.dev/waku-v2-plan">rough road map (2020)</a> for more historical context.</p>
<h2 id="motivation-and-goals"><a class="header" href="#motivation-and-goals">Motivation and Goals</a></h2>
<p>Waku, as a family of protocols, is designed to have a set of properties
that are useful for many applications:</p>
<p>1.<strong>Useful for generalized messaging.</strong></p>
<p>Many applications require some form of messaging protocol to communicate
between different subsystems or different nodes.
This messaging can be human-to-human, machine-to-machine or a mix.
Waku is designed to work for all these scenarios.</p>
<p>2.<strong>Peer-to-peer.</strong></p>
<p>Applications sometimes have requirements that make them suitable
for peer-to-peer solutions:</p>
<ul>
<li>Censorship-resistant with no single point of failure</li>
<li>Adaptive and scalable network</li>
<li>Shared infrastructure</li>
</ul>
<p>3.<strong>Runs anywhere.</strong></p>
<p>Applications often run in restricted environments,
where resources or the environment is restricted in some fashion.
For example:</p>
<ul>
<li>Limited bandwidth, CPU, memory, disk, battery, etc.</li>
<li>Not being publicly connectable</li>
<li>Only being intermittently connected; mostly-offline</li>
</ul>
<p>4.<strong>Privacy-preserving.</strong></p>
<p>Applications often have a desire for some privacy guarantees, such as:</p>
<ul>
<li>Pseudonymity and not being tied to any personally identifiable information (PII)</li>
<li>Metadata protection in transit</li>
<li>Various forms of unlinkability, etc.</li>
</ul>
<p>5.<strong>Modular design.</strong></p>
<p>Applications often have different trade-offs when it comes to what properties they
and their users value.
Waku is designed in a modular fashion where an application protocol or
node can choose what protocols they run.
We call this concept <em>adaptive nodes</em>.</p>
<p>For example:</p>
<ul>
<li>Resource usage vs metadata protection</li>
<li>Providing useful services to the network vs mostly using it</li>
<li>Stronger guarantees for spam protection vs economic registration cost</li>
</ul>
<p>For more on the concept of adaptive nodes and what this means in practice,
please see the <a href="waku/standards/core/10//waku/informational/30/adaptive-nodes.html">30/ADAPTIVE-NODES</a> spec.</p>
<h2 id="specification-1"><a class="header" href="#specification-1">Specification</a></h2>
<p>The keywords “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”,
“SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and
“OPTIONAL” in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">2119</a>.</p>
<h3 id="network-interaction-domains"><a class="header" href="#network-interaction-domains">Network Interaction Domains</a></h3>
<p>While Waku is best thought of as a single cohesive thing,
there are three network interaction domains:</p>
<p>(a) gossip domain
(b) discovery domain
(c) request/response domain</p>
<h4 id="protocols-and-identifiers"><a class="header" href="#protocols-and-identifiers">Protocols and Identifiers</a></h4>
<p>Since Waku is built on top of libp2p, many protocols have a libp2p protocol identifier.
The current main <a href="https://docs.libp2p.io/concepts/protocols/">protocol identifiers</a>
are:</p>
<ol>
<li><code>/vac/waku/relay/2.0.0</code></li>
<li><code>/vac/waku/store-query/3.0.0</code></li>
<li><code>/vac/waku/filter/2.0.0-beta1</code></li>
<li><code>/vac/waku/lightpush/2.0.0-beta1</code></li>
</ol>
<p>This is in addition to protocols that specify messages, payloads, and
recommended usages.
Since these aren't negotiated libp2p protocols,
they are referred to by their RFC ID.
For example:</p>
<ul>
<li><a href="waku/standards/core/10//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a> and
<a href="waku/standards/core/10//waku/standards/application/26/payload.html">26/WAKU-PAYLOAD</a> for message payloads</li>
<li><a href="waku/standards/core/10//waku/informational/23/topics.html">23/WAKU2-TOPICS</a> and
<a href="waku/standards/core/10//waku/informational/27/peers.html">27/WAKU2-PEERS</a> for recommendations around usage</li>
</ul>
<p>There are also more experimental libp2p protocols such as:</p>
<ol>
<li><code>/vac/waku/waku-rln-relay/2.0.0-alpha1</code></li>
<li><code>/vac/waku/peer-exchange/2.0.0-alpha1</code></li>
</ol>
<p>The semantics of these protocols are referred to by RFC ID <a href="waku/standards/core/10//waku/standards/core/17/rln-relay.html">17/WAKU2-RLN-RELAY</a> and <a href="waku/standards/core/10//waku/standards/core/34/peer-exchange.html">34/WAKU2-PEER-EXCHANGE</a>.</p>
<h4 id="use-of-libp2p-and-protobuf"><a class="header" href="#use-of-libp2p-and-protobuf">Use of libp2p and Protobuf</a></h4>
<p>Unless otherwise specified,
all protocols are implemented over libp2p and use Protobuf by default.
Since messages are exchanged over a <a href="https://docs.libp2p.io/concepts/protocols/">bi-directional binary stream</a>,
as a convention,
libp2p protocols prefix binary message payloads with
the length of the message in bytes.
This length integer is encoded as a <a href="https://developers.google.com/protocol-buffers/docs/encoding#varints">protobuf varint</a>.</p>
<h4 id="gossip-domain"><a class="header" href="#gossip-domain">Gossip Domain</a></h4>
<p>Waku is using gossiping to disseminate messages throughout the network.</p>
<p><strong>Protocol identifier</strong>: <code>/vac/waku/relay/2.0.0</code></p>
<p>See <a href="waku/standards/core/10//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a> specification for more details.</p>
<p>For an experimental privacy-preserving economic spam protection mechanism,
see <a href="waku/standards/core/10//waku/standards/core/17/rln-relay.html">17/WAKU2-RLN-RELAY</a>.</p>
<p>See <a href="waku/standards/core/10//waku/informational/23/topics.html">23/WAKU2-TOPICS</a>
for more information about the recommended topic usage.</p>
<h4 id="direct-use-of-libp2p-protocols"><a class="header" href="#direct-use-of-libp2p-protocols">Direct use of libp2p protocols</a></h4>
<p>In addition to <code>/vac/waku/*</code> protocols,
Waku MAY directly use the following libp2p protocols:</p>
<ul>
<li><a href="https://docs.libp2p.io/concepts/protocols/#ping">libp2p ping protocol</a>
with protocol id</li>
</ul>
<pre><code class="language-text">/ipfs/ping/1.0.0
</code></pre>
<p>for liveness checks between peers, or
to keep peer-to-peer connections alive.</p>
<ul>
<li><a href="https://docs.libp2p.io/concepts/protocols/#identify">libp2p identity and identity/push</a>
with protocol IDs</li>
</ul>
<pre><code class="language-text">/ipfs/id/1.0.0
</code></pre>
<p>and</p>
<pre><code class="language-text">/ipfs/id/push/1.0.0
</code></pre>
<p>respectively, as basic means for capability discovery.
These protocols are anyway used by the libp2p connection
establishment layer Waku is built on.
We plan to introduce a new Vac capability discovery protocol
with better anonymity properties and more functionality.</p>
<h4 id="transports"><a class="header" href="#transports">Transports</a></h4>
<p>Waku is built in top of libp2p, and like libp2p it strives to be transport agnostic.
We define a set of recommended transports in order to achieve a baseline of
interoperability between clients.
This section describes these recommended transports.</p>
<p>Waku client implementations SHOULD support the TCP transport.
Where TCP is supported it MUST be enabled for both dialing and listening,
even if other transports are available.</p>
<p>Waku nodes running in environments that do not allow the use of TCP directly,
MAY use other transports.</p>
<p>A Waku node SHOULD support secure websockets for bidirectional communication streams,
for example in a web browser context.</p>
<p>A node MAY support unsecure websockets if required by the application or
running environment.</p>
<h3 id="discovery-domain"><a class="header" href="#discovery-domain">Discovery Domain</a></h3>
<h4 id="discovery-methods"><a class="header" href="#discovery-methods">Discovery Methods</a></h4>
<p>Waku can retrieve a list of nodes to connect to using DNS-based discovery
as per <a href="https://eips.ethereum.org/EIPS/eip-1459">EIP-1459</a>.
While this is a useful way of bootstrapping connection to a set of peers,
it MAY be used in conjunction with an <a href="https://docs.libp2p.io/concepts/publish-subscribe/#discovery">ambient peer discovery</a>
procedure to find other nodes to connect to,
such as <a href="https://github.com/ethereum/devp2p/blob/8fd5f7e1c1ec496a9d8dc1640a8548b8a8b5986b/discv5/discv5.md">Node Discovery v5</a>.
It is possible to bypass the discovery domain by specifying static nodes.</p>
<h4 id="use-of-enr"><a class="header" href="#use-of-enr">Use of ENR</a></h4>
<p><a href="https://github.com/waku-org/specs/blob/master/standards/core/enr.md">WAKU2-ENR</a>
describes the usage of <a href="https://eips.ethereum.org/EIPS/eip-778">EIP-778 ENR (Ethereum Node Records)</a>
for Waku discovery purposes.
It introduces two new ENR fields, <code>multiaddrs</code> and
<code>waku2</code>, that a Waku node MAY use for discovery purposes.
These fields MUST be used under certain conditions, as set out in the specification.
Both EIP-1459 DNS-based discovery and Node Discovery v5 operate on ENR,
and it's reasonable to expect even wider utility for ENR in Waku networks in the future.</p>
<h3 id="requestresponse-domain"><a class="header" href="#requestresponse-domain">Request/Response Domain</a></h3>
<p>In addition to the Gossip domain,
Waku provides a set of request/response protocols.
They are primarily used in order to get Waku to run in resource restricted environments,
such as low bandwidth or being mostly offline.</p>
<h4 id="historical-message-support"><a class="header" href="#historical-message-support">Historical Message Support</a></h4>
<p><strong>Protocol identifier</strong>*: <code>/vac/waku/store-query/3.0.0</code></p>
<p>This is used to fetch historical messages for mostly offline devices.
See <a href="waku/standards/core/10//waku/standards/core/13/store.html">13/WAKU2-STORE spec</a> specification for more details.</p>
<p>There is also an experimental fault-tolerant addition to the store protocol
that relaxes the high availability requirement.
See <a href="waku/standards/core/10//waku/standards/application/21/fault-tolerant-store.html">21/WAKU2-FAULT-TOLERANT-STORE</a></p>
<h4 id="content-filtering"><a class="header" href="#content-filtering">Content Filtering</a></h4>
<p><strong>Protocol identifier</strong>*: <code>/vac/waku/filter/2.0.0-beta1</code></p>
<p>This is used to preserve more bandwidth when fetching a subset of messages.
See <a href="waku/standards/core/10//waku/standards/core/12/filter.html">12/WAKU2-FILTER</a> specification for more details.</p>
<h4 id="lightpush"><a class="header" href="#lightpush">LightPush</a></h4>
<p><strong>Protocol identifier</strong>*: <code>/vac/waku/lightpush/2.0.0-beta1</code></p>
<p>This is used for nodes with short connection windows and
limited bandwidth to publish messages into the Waku network.
See <a href="waku/standards/core/10//waku/standards/core/19/lightpush.html">19/WAKU2-LIGHTPUSH</a> specification for more details.</p>
<h4 id="other-protocols"><a class="header" href="#other-protocols">Other Protocols</a></h4>
<p>The above is a non-exhaustive list,
and due to the modular design of Waku,
there may be other protocols here that provide a useful service to the Waku network.</p>
<h3 id="overview-of-protocol-interaction"><a class="header" href="#overview-of-protocol-interaction">Overview of Protocol Interaction</a></h3>
<p>See the sequence diagram below for an overview of how different protocols interact.</p>
<p><img src="waku/standards/core/10/./images/overview.png" alt="Overview of how protocols interact in Waku." /></p>
<ol start="0">
<li>
<p>We have six nodes, A-F.
The protocols initially mounted are indicated as such.
The PubSub topics <code>pubtopic1</code> and
<code>pubtopic2</code> is used for routing and
indicates that it is subscribed to messages on that topic for relay,
see <a href="waku/standards/core/10//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a> for details.
Ditto for <a href="waku/standards/core/10//waku/standards/core/13/store.html">13/WAKU2-STORE</a>
where it indicates that these messages are persisted on that node.</p>
</li>
<li>
<p>Node A creates a WakuMessage <code>msg1</code> with a ContentTopic <code>contentTopic1</code>.
See <a href="waku/standards/core/10//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a> for more details.
If WakuMessage version is set to 1,
we use the <a href="waku/standards/core/10//waku/standards/legacy/6/waku1.html">6/WAKU1</a> compatible <code>data</code> field with encryption.
See <a href="waku/standards/core/10//waku/standards/legacy/7/data.html">7/WAKU-DATA</a> for more details.</p>
</li>
<li>
<p>Node F requests to get messages filtered by PubSub topic <code>pubtopic1</code> and
ContentTopic <code>contentTopic1</code>.
Node D subscribes F to this filter and
will in the future forward messages that match that filter.
See <a href="waku/standards/core/10//waku/standards/core/12/filter.html">12/WAKU2-FILTER</a> for more details.</p>
</li>
<li>
<p>Node A publishes <code>msg1</code> on <code>pubtopic1</code> and
subscribes to that relay topic.
It then gets relayed further from B to D, but
not C since it doesn't subscribe to that topic.
See <a href="waku/standards/core/10//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a>.</p>
</li>
<li>
<p>Node D saves <code>msg1</code> for possible later retrieval by other nodes.
See <a href="waku/standards/core/10//waku/standards/core/13/store.html">13/WAKU2-STORE</a>.</p>
</li>
<li>
<p>Node D also pushes <code>msg1</code> to F,
as it has previously subscribed F to this filter.
See <a href="waku/standards/core/10//waku/standards/core/12/filter.html">12/WAKU2-FILTER</a>.</p>
</li>
<li>
<p>At a later time, Node E comes online.
It then requests messages matching <code>pubtopic1</code> and
<code>contentTopic1</code> from Node D.
Node D responds with messages meeting this (and possibly other) criteria.
See <a href="waku/standards/core/10//waku/standards/core/13/store.html">13/WAKU2-STORE</a>.</p>
</li>
</ol>
<h2 id="appendix-a-upgradability-and-compatibility"><a class="header" href="#appendix-a-upgradability-and-compatibility">Appendix A: Upgradability and Compatibility</a></h2>
<h3 id="compatibility-with-waku-legacy"><a class="header" href="#compatibility-with-waku-legacy">Compatibility with Waku Legacy</a></h3>
<p><a href="waku/standards/core/10//waku/standards/legacy/6/waku1.html">6/WAKU1</a> and Waku are different protocols all together.
They use a different transport protocol underneath;
<a href="waku/standards/core/10//waku/standards/legacy/6/waku1.html">6/WAKU1</a> is devp2p RLPx based while Waku uses libp2p.
The protocols themselves also differ as does their data format.
Compatibility can be achieved only by using a bridge
that not only talks both devp2p RLPx and libp2p,
but that also transfers (partially) the content of a packet from one version
to the other.</p>
<p>See <a href="waku/standards/core/10//waku/standards/core/15/bridge.html">15/WAKU-BRIDGE</a> for details on a bidirectional bridge mode.</p>
<h2 id="appendix-b-security"><a class="header" href="#appendix-b-security">Appendix B: Security</a></h2>
<p>Each protocol layer of Waku provides a distinct service and
is associated with a separate set of security features and concerns.
Therefore, the overall security of Waku
depends on how the different layers are utilized.
In this section,
we overview the security properties of Waku protocols
against a static adversarial model which is described below.
Note that a more detailed security analysis of each Waku protocol
is supplied in its respective specification as well.</p>
<h3 id="primary-adversarial-model"><a class="header" href="#primary-adversarial-model">Primary Adversarial Model</a></h3>
<p>In the primary adversarial model,
we consider adversary as a passive entity that attempts to collect information
from others to conduct an attack,
but it does so without violating protocol definitions and instructions.</p>
<p>The following are <strong>not</strong> considered as part of the adversarial model:</p>
<ul>
<li>An adversary with a global view of all the peers and their connections.</li>
<li>An adversary that can eavesdrop on communication links
between arbitrary pairs of peers
(unless the adversary is one end of the communication).
Specifically, the communication channels are assumed to be secure.</li>
</ul>
<h3 id="security-features"><a class="header" href="#security-features">Security Features</a></h3>
<h4 id="pseudonymity"><a class="header" href="#pseudonymity">Pseudonymity</a></h4>
<p>Waku by default guarantees pseudonymity for all of the protocol layers
since parties do not have to disclose their true identity
and instead they utilize libp2p <code>PeerID</code> as their identifiers.
While pseudonymity is an appealing security feature,
it does not guarantee full anonymity since the actions taken under the same pseudonym
i.e., <code>PeerID</code> can be linked together and
potentially result in the re-identification of the true actor.</p>
<h4 id="anonymity--unlinkability"><a class="header" href="#anonymity--unlinkability">Anonymity / Unlinkability</a></h4>
<p>At a high level,
anonymity is the inability of an adversary in linking an actor
to its data/performed action (the actor and action are context-dependent).
To be precise about linkability,
we use the term Personally Identifiable Information (PII)
to refer to any piece of data that could potentially
be used to uniquely identify a party.
For example, the signature verification key, and
the hash of one's static IP address are unique for each user and
hence count as PII.
Notice that users' actions can be traced through their PIIs
(e.g., signatures) and hence result in their re-identification risk.
As such, we seek anonymity by avoiding linkability between actions and
the actors / actors' PII. Concerning anonymity, Waku provides the following features:</p>
<p><strong>Publisher-Message Unlinkability</strong>:
This feature signifies the unlinkability of a publisher
to its published messages in the 11/WAKU2-RELAY protocol.
The <a href="waku/standards/core/10//waku/standards/core/11/relay.html">Publisher-Message Unlinkability</a>
is enforced through the <code>StrictNoSign</code> policy due to which the data fields
of pubsub messages that count as PII for the publisher must be left unspecified.</p>
<p><strong>Subscriber-Topic Unlinkability</strong>:
This feature stands for the unlinkability of the subscriber
to its subscribed topics in the 11/WAKU2-RELAY protocol.
The <a href="waku/standards/core/10//waku/standards/core/11/relay.html">Subscriber-Topic Unlinkability</a>
is achieved through the utilization of a single PubSub topic.
As such, subscribers are not re-identifiable from their subscribed topic IDs
as the entire network is linked to the same topic ID.
This level of unlinkability / anonymity is known as <a href="https://www.privitar.com/blog/k-anonymity-an-introduction/">k-anonymity</a>
where k is proportional to the system size (number of subscribers).
Note that there is no hard limit on the number of the pubsub topics, however,
the use of one topic is recommended for the sake of anonymity.</p>
<h4 id="spam-protection"><a class="header" href="#spam-protection">Spam protection</a></h4>
<p>This property indicates that no adversary can flood the system
(i.e., publishing a large number of messages in a short amount of time),
either accidentally or deliberately, with any kind of message
i.e. even if the message content is valid or useful.
Spam protection is partly provided in <code>11/WAKU2-RELAY</code>
through the <a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md#spam-protection-measures">scoring mechanism</a>
provided for by GossipSub v1.1.
At a high level,
peers utilize a scoring function to locally score the behavior
of their connections and remove peers with a low score.</p>
<h4 id="data-confidentiality-integrity-and-authenticity"><a class="header" href="#data-confidentiality-integrity-and-authenticity">Data confidentiality, Integrity, and Authenticity</a></h4>
<p>Confidentiality can be addressed through data encryption whereas integrity and
authenticity are achievable through digital signatures.
These features are provided for in <a href="waku/standards/core/10//waku/standards/core/14/message.html">14/WAKU2-MESSAGE (version 1)</a>`
through payload encryption as well as encrypted signatures.</p>
<h3 id="security-considerations-2"><a class="header" href="#security-considerations-2">Security Considerations</a></h3>
<p>Lack of anonymity/unlinkability in the protocols involving direct connections
including <code>13/WAKU2-STORE</code> and <code>12/WAKU2-FILTER</code> protocols:</p>
<p>The anonymity/unlinkability is not guaranteed in the protocols like <code>13/WAKU2-STORE</code>
and <code>12/WAKU2-FILTER</code> where peers need to have direct connections
to benefit from the designated service.
This is because during the direct connections peers utilize <code>PeerID</code>
to identify each other,
therefore the service obtained in the protocol is linkable
to the beneficiary's <code>PeerID</code> (which counts as PII).
For <code>13/WAKU2-STORE</code>,
the queried node would be able to link the querying node's <code>PeerID</code>
to its queried topics.
Likewise, in the <code>12/WAKU2-FILTER</code>,
a full node can link the light node's <code>PeerID</code>s to its content filter.</p>
<!-- TODO: to inspect the nim-libp2p codebase and
figure out the exact use of PeerIDs in direct communication,
it might be the case that the requester does not have to disclose its PeerID-->
<!--TODO: might be good to add a figure visualizing the Waku protocol stack and
the security features of each layer-->
<h2 id="appendix-c-implementation-notes"><a class="header" href="#appendix-c-implementation-notes">Appendix C: Implementation Notes</a></h2>
<h3 id="implementation-matrix"><a class="header" href="#implementation-matrix">Implementation Matrix</a></h3>
<p>There are multiple implementations of Waku and its protocols:</p>
<ul>
<li><a href="https://github.com/status-im/nim-waku/">nim-waku (Nim)</a></li>
<li><a href="https://github.com/status-im/go-waku/">go-waku (Go)</a></li>
<li><a href="https://github.com/status-im/js-waku/">js-waku (NodeJS and Browser)</a></li>
</ul>
<p>Below you can find an overview of the specifications that they implement
as they relate to Waku.
This includes Waku legacy specifications, as they are used for bridging between the two networks.</p>
<div class="table-wrapper"><table><thead><tr><th>Spec</th><th>nim-waku (Nim)</th><th>go-waku (Go)</th><th>js-waku (Node JS)</th><th>js-waku (Browser JS)</th></tr></thead><tbody>
<tr><td><a href="waku/standards/core/10//waku/standards/legacy/6/waku1.html">6/WAKU1</a></td><td>✔</td><td></td><td></td><td></td></tr>
<tr><td><a href="waku/standards/core/10//waku/standards/legacy/7/data.html">7/WAKU-DATA</a></td><td>✔</td><td>✔</td><td></td><td></td></tr>
<tr><td><a href="waku/standards/core/10//waku/standards/legacy/8/mail.html">8/WAKU-MAIL</a></td><td>✔</td><td></td><td></td><td></td></tr>
<tr><td><a href="waku/standards/core/10//waku/standards/legacy/9/rpc.html">9/WAKU-RPC</a></td><td>✔</td><td></td><td></td><td></td></tr>
<tr><td><a href="waku/standards/core/10//waku/standards/core/10/waku2.html">10/WAKU2</a></td><td>✔</td><td>🚧</td><td>🚧</td><td>✔</td></tr>
<tr><td><a href="waku/standards/core/10//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a></td><td>✔</td><td>✔</td><td>✔</td><td>✔</td></tr>
<tr><td><a href="waku/standards/core/10//waku/standards/core/12/filter.html">12/WAKU2-FILTER</a></td><td>✔</td><td>✔</td><td></td><td></td></tr>
<tr><td><a href="waku/standards/core/10//waku/standards/core/13/store.html">13/WAKU2-STORE</a></td><td>✔</td><td>✔</td><td>✔*</td><td>✔*</td></tr>
<tr><td><a href="waku/standards/core/10//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a>)</td><td>✔</td><td>✔</td><td>✔</td><td>✔</td></tr>
<tr><td><a href="waku/standards/core/10//waku/standards/core/15/bridge.html">15/WAKU2-BRIDGE</a></td><td>✔</td><td></td><td></td><td></td></tr>
<tr><td><a href="waku/standards/core/10//waku/deprecated/16/rpc.html">16/WAKU2-RPC</a></td><td>✔</td><td></td><td></td><td></td></tr>
<tr><td><a href="waku/standards/core/10//waku/standards/core/17/rln-relay.html">17/WAKU2-RLN-RELAY</a></td><td>🚧</td><td></td><td></td><td></td></tr>
<tr><td><a href="waku/standards/core/10//waku/standards/application/18/swap.html">18/WAKU2-SWAP</a></td><td>🚧</td><td></td><td></td><td></td></tr>
<tr><td><a href="waku/standards/core/10//waku/standards/core/19/lightpush.html">19/WAKU2-LIGHTPUSH</a></td><td>✔</td><td>✔</td><td>✔**</td><td>✔**</td></tr>
<tr><td><a href="waku/standards/core/10//waku/standards/application/21/fault-tolerant-store.html">21/WAKU2-FAULT-TOLERANT-STORE</a></td><td>✔</td><td>✔</td><td></td><td></td></tr>
</tbody></table>
</div>
<p>*js-waku implements <a href="waku/standards/core/10//waku/standards/core/13/store.html">13/WAKU2-STORE</a> as a querying node only.
**js-waku only implements <a href="waku/standards/core/10//waku/standards/core/19/lightpush.html">19/WAKU2-LIGHTPUSH</a> requests.</p>
<h3 id="recommendations-for-clients"><a class="header" href="#recommendations-for-clients">Recommendations for Clients</a></h3>
<p>To implement a minimal Waku client,
we recommend implementing the following subset in the following order:</p>
<ul>
<li><a href="waku/standards/core/10//waku/standards/core/10/waku2.html">10/WAKU2</a> - this specification</li>
<li><a href="waku/standards/core/10//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a> - for basic operation</li>
<li><a href="waku/standards/core/10//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a> - version 0 (unencrypted)</li>
<li><a href="waku/standards/core/10//waku/standards/core/13/store.html">13/WAKU2-STORE</a> - for historical messaging (query mode only)</li>
</ul>
<p>To get compatibility with Waku Legacy:</p>
<ul>
<li><a href="waku/standards/core/10//waku/standards/legacy/7/data.html">7/WAKU-DATA</a></li>
<li><a href="waku/standards/core/10//waku/standards/14/message.html">14/WAKU2-MESSAGE</a> - version 1 (encrypted with <code>7/WAKU-DATA</code>)</li>
</ul>
<p>For an interoperable keep-alive mechanism:</p>
<ul>
<li><a href="https://docs.libp2p.io/concepts/protocols/#ping">libp2p ping protocol</a>,
with periodic pings to connected peers</li>
</ul>
<h2 id="appendix-d-future-work"><a class="header" href="#appendix-d-future-work">Appendix D: Future work</a></h2>
<p>The following features are currently experimental,
under research and initial implementations:</p>
<p><strong>Economic Spam Resistance</strong>:</p>
<p>We aim to enable an incentivized spam protection technique
to enhance <code>11/WAKU2-RELAY</code> by using rate limiting nullifiers.
More details on this can be found in <a href="waku/standards/core/10//waku/standards/core/17/rln-relay.html">17/WAKU2-RLN-RELAY</a>.
In this advanced method,
peers are limited to a certain rate of messaging per epoch and
an immediate financial penalty is enforced for spammers who break this rate.</p>
<p><strong>Prevention of Denial of Service (DoS) and Node Incentivization</strong>:
Denial of service signifies the case where an adversarial node
exhausts another node's service capacity (e.g., by making a large number of requests)
and makes it unavailable to the rest of the system.
DoS attack is to be mitigated through the accounting model as described in <a href="waku/standards/core/10//waku/deprecated/18/swap.html">18/WAKU2-SWAP</a>.
In a nutshell, peers have to pay for the service they obtain from each other.
In addition to incentivizing the service provider,
accounting also makes DoS attacks costly for malicious peers.
The accounting model can be used in <code>13/WAKU2-STORE</code> and
<code>12/WAKU2-FILTER</code> to protect against DoS attacks.</p>
<p>Additionally, this gives node operators who provide a useful service to the network
an incentive to perform that service.
See <a href="waku/standards/core/10//waku/deprecated/18/swap.html">18/WAKU2-SWAP</a>
for more details on this piece of work.</p>
<h2 id="copyright-15"><a class="header" href="#copyright-15">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-13"><a class="header" href="#references-13">References</a></h2>
<ol>
<li>
<p><a href="https://github.com/libp2p/specs">libp2p specs</a></p>
</li>
<li>
<p><a href="waku/standards/core/10//waku/standards/legacy/6/waku1.html">6/WAKU1</a></p>
</li>
<li>
<p><a href="https://eips.ethereum.org/EIPS/eip-627">Whisper spec (EIP627)</a></p>
</li>
<li>
<p><a href="https://vac.dev/waku-v2-plan">Waku v2 plan</a></p>
</li>
<li>
<p><a href="waku/standards/core/10//waku/informational/30/adaptive-nodes.html">30/ADAPTIVE-NODES</a></p>
</li>
<li>
<p><a href="https://docs.libp2p.io/concepts/protocols/">Protocol Identifiers</a></p>
</li>
<li>
<p><a href="waku/standards/core/10//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a></p>
</li>
<li>
<p><a href="waku/standards/core/10//waku/standards/application/26/payload.html">26/WAKU-PAYLOAD</a></p>
</li>
<li>
<p><a href="waku/standards/core/10//waku/informational/23/topics.html">23/WAKU2-TOPICS</a></p>
</li>
<li>
<p><a href="waku/standards/core/10//waku/informational/27/peers.html">27/WAKU2-PEERS</a></p>
</li>
<li>
<p><a href="https://docs.libp2p.io/concepts/protocols/">bi-directional binary stream</a></p>
</li>
<li>
<p><a href="https://developers.google.com/protocol-buffers/docs/encoding#varints">Protobuf varint encoding</a></p>
</li>
<li>
<p><a href="waku/standards/core/10//waku/standards/core/11/relay.html">11/WAKU2-RELAY spec</a></p>
</li>
<li>
<p><a href="waku/standards/core/10//waku/standards/core/17/rln-relay.html">17/WAKU2-RLN-RELAY</a></p>
</li>
<li>
<p><a href="https://eips.ethereum.org/EIPS/eip-1459">EIP-1459</a></p>
</li>
<li>
<p><a href="https://docs.libp2p.io/concepts/publish-subscribe/#discovery">Ambient peer discovery</a></p>
</li>
<li>
<p><a href="https://github.com/ethereum/devp2p/blob/8fd5f7e1c1ec496a9d8dc1640a8548b8a8b5986b/discv5/discv5.md">Node Discovery v5</a></p>
</li>
<li>
<p><a href="https://github.com/waku-org/specs/blob/master/standards/core/enr.md">WAKU2-ENR</a></p>
</li>
<li>
<p><a href="https://eips.ethereum.org/EIPS/eip-778">EIP-778 ENR (Ethereum Node Records)</a></p>
</li>
<li>
<p><a href="waku/standards/core/10//waku/standards/core/13/store.html">13/WAKU2-STORE spec</a></p>
</li>
<li>
<p><a href="waku/standards/core/10//waku/standards/application/21/ft-store.html">21/WAKU2-FT-STORE</a></p>
</li>
<li>
<p><a href="waku/standards/core/10//waku/standards/core/12/filter.html">12/WAKU2-FILTER</a></p>
</li>
<li>
<p><a href="waku/standards/core/10//waku/standards/core/19/lightpush.html">19/WAKU2-LIGHTPUSH</a></p>
</li>
<li>
<p><a href="waku/standards/core/10//waku/standards/legacy/7/data.html">7/WAKU-DATA</a></p>
</li>
<li>
<p><a href="waku/standards/core/10//waku/standards/core/15/bridge.html">15/WAKU-BRIDGE</a></p>
</li>
<li>
<p><a href="https://www.privitar.com/blog/k-anonymity-an-introduction/">k-anonymity</a></p>
</li>
<li>
<p><a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md">GossipSub v1.1</a></p>
</li>
<li>
<p><a href="https://github.com/status-im/nim-waku/">nim-waku (Nim)</a></p>
</li>
<li>
<p><a href="https://github.com/status-im/go-waku/">go-waku (Go)</a></p>
</li>
<li>
<p><a href="https://github.com/status-im/js-waku/">js-waku (NodeJS and Browser)</a></p>
</li>
<li>
<p><a href="waku/standards/core/10//waku/standards/legacy/8/mail.html">8/WAKU-MAIL</a></p>
</li>
<li>
<p><a href="waku/standards/core/10//waku/standards/legacy/9/rpc.html">9/WAKU-RPC</a></p>
</li>
<li>
<p><a href="waku/standards/core/10/waku/deprecated/16/rpc.html">16/WAKU2-RPC</a></p>
</li>
<li>
<p><a href="waku/standards/core/10/waku/deprecated/18/swap.html">18/WAKU2-SWAP spec</a></p>
</li>
<li>
<p><a href="waku/standards/core/10/../../application/21/fault-tolerant-store.html">21/WAKU2-FAULT-TOLERANT-STORE</a></p>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="11waku2-relay"><a class="header" href="#11waku2-relay">11/WAKU2-RELAY</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v2 Relay</td></tr>
<tr><th>Slug</th><td>11</td></tr>
<tr><th>Status</th><td>stable</td></tr>
<tr><th>Editor</th><td>Hanno Cornelius &lt;hanno@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Oskar Thorén &lt;oskarth@titanproxy.com&gt;<br>Sanaz Taheri &lt;sanaz@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-20"><a class="header" href="#timeline-20">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/core/11/relay.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/core/11/relay.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/core/11/relay.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b346ad2cbb99404b5237f55d2d222f4563c7d249/waku/standards/core/11/relay.md"><code>b346ad2</code></a> — Update relay.md</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/0904a8b592174f9cf3e02453f8e73db32cb725c1/waku/standards/core/11/relay.md"><code>0904a8b</code></a> — Update and rename RELAY.md to relay.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/8ff46fac5d37d8a508140586530134ec3f1c0720/waku/standards/core/11/RELAY.md"><code>8ff46fa</code></a> — Rename WAKU2-RELAY.md to RELAY.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/4c4591c92b516c98e410c5f4cac5f4535abb96f7/waku/standards/core/11/WAKU2-RELAY.md"><code>4c4591c</code></a> — Rename README.md to WAKU2-RELAY.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/standards/core/11/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/6874961a27cbe8bd3ea5ac8497286bb974ea6e89/waku/rfcs/standards/core/11/README.md"><code>6874961</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<p><code>11/WAKU2-RELAY</code> specifies a <a href="https://docs.libp2p.io/concepts/publish-subscribe/">Publish/Subscribe approach</a>
to peer-to-peer messaging with a strong focus on privacy,
censorship-resistance, security and scalability.
Its current implementation is a minor extension of the
<a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/README.md">libp2p GossipSub protocol</a>
and prescribes gossip-based dissemination.
As such the scope is limited to defining a separate
<a href="https://github.com/libp2p/specs/blob/master/connections/README.md#protocol-negotiation"><code>protocol id</code></a>
for <code>11/WAKU2-RELAY</code>, establishing privacy and security requirements,
and defining how the underlying GossipSub is to be interpreted and
implemented within the Waku and cryptoeconomic domain.
<code>11/WAKU2-RELAY</code> should not be confused with <a href="https://github.com/libp2p/specs/tree/master/relay">libp2p circuit relay</a>.</p>
<p><strong>Protocol identifier</strong>: <code>/vac/waku/relay/2.0.0</code></p>
<h2 id="security-requirements"><a class="header" href="#security-requirements">Security Requirements</a></h2>
<p>The <code>11/WAKU2-RELAY</code> protocol is designed to provide the following security properties
under a static <a href="waku/standards/core/11/relay.html#adversarial-model">Adversarial Model</a>.
Note that data confidentiality, integrity, and
authenticity are currently considered out of scope for <code>11/WAKU2-RELAY</code> and
must be handled by higher layer protocols such as <a href="waku/standards/core/11/../14/message.html"><code>14/WAKU2-MESSAGE</code></a>.</p>
<!-- May add the definition of the unsupported feature: 
Confidentiality indicates that an adversary
should not be able to learn the data carried by the `WakuRelay` protocol.
Integrity indicates that the data transferred by the `WakuRelay` protocol
can not be tampered with by an adversarial entity without being detected.
Authenticity no adversary can forge data on behalf of a targeted publisher and
make it accepted by other subscribers as if the origin is the target. -->
<ul>
<li>
<p><strong>Publisher-Message Unlinkability</strong>:
This property indicates that no adversarial entity can link a published <code>Message</code>
to its publisher.
This feature also implies the unlinkability of the publisher
to its published topic ID as the <code>Message</code> embodies the topic IDs.</p>
</li>
<li>
<p><strong>Subscriber-Topic Unlinkability</strong>:
This feature stands for the inability of any adversarial entity
from linking a subscriber to its subscribed topic IDs.</p>
</li>
</ul>
<!-- TODO: more requirements can be added,
but that needs further and deeper investigation-->
<h3 id="terminology-1"><a class="header" href="#terminology-1">Terminology</a></h3>
<p><em>Personally identifiable information</em> (PII)
refers to any piece of data that can be used to uniquely identify a user.
For example, the signature verification key,
and the hash of one's static IP address are unique for each user and
hence count as PII.</p>
<h2 id="adversarial-model"><a class="header" href="#adversarial-model">Adversarial Model</a></h2>
<ul>
<li>Any entity running the <code>11/WAKU2-RELAY</code> protocol is considered an adversary.
This includes publishers, subscribers, and all the peers' direct connections.
Furthermore,
we consider the adversary as a passive entity that attempts to collect information
from others to conduct an attack but
it does so without violating protocol definitions and instructions.
For example, under the passive adversarial model,
no malicious subscriber hides the messages it receives from other subscribers
as it is against the description of <code>11/WAKU2-RELAY</code>.
However,
a malicious subscriber may learn which topics are subscribed to by which peers.</li>
<li>The following are <strong>not</strong> considered as part of the adversarial model:
<ul>
<li>An adversary with a global view of all the peers and their connections.</li>
<li>An adversary that can eavesdrop on communication links between arbitrary pairs
of peers (unless the adversary is one end of the communication).
In other words, the communication channels are assumed to be secure.</li>
</ul>
</li>
</ul>
<h2 id="wire-specification"><a class="header" href="#wire-specification">Wire Specification</a></h2>
<p>The <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md">PubSub interface specification</a>
defines the protobuf RPC messages
exchanged between peers participating in a GossipSub network.
We republish these messages here for ease of reference and
define how <code>11/WAKU2-RELAY</code> uses and interprets each field.</p>
<h3 id="protobuf-definitions"><a class="header" href="#protobuf-definitions">Protobuf definitions</a></h3>
<p>The PubSub RPC messages are specified using <a href="https://developers.google.com/protocol-buffers/">protocol buffers v2</a></p>
<pre><code class="language-protobuf">syntax = "proto2";

message RPC {
  repeated SubOpts subscriptions = 1;
  repeated Message publish = 2;

  message SubOpts {
    optional bool subscribe = 1;
    optional string topicid = 2;
  }

  message Message {
    optional string from = 1;
    optional bytes data = 2;
    optional bytes seqno = 3;
    repeated string topicIDs = 4;
    optional bytes signature = 5;
    optional bytes key = 6;
  }
}
</code></pre>
<blockquote>
<p><strong><em>NOTE:</em></strong>
The various <a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.0.md#control-messages">control messages</a>
defined for GossipSub are used as specified there.
<strong><em>NOTE:</em></strong>
The <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor"><code>TopicDescriptor</code></a>
is not currently used by <code>11/WAKU2-RELAY</code>.</p>
</blockquote>
<h3 id="message-fields"><a class="header" href="#message-fields">Message fields</a></h3>
<p>The <code>Message</code> protobuf defines the format in which content is relayed between peers.
<code>11/WAKU2-RELAY</code> specifies the following usage requirements for each field:</p>
<ul>
<li>
<p>The <code>from</code> field MUST NOT be used, following the <a href="waku/standards/core/11/relay.html#signature-policy"><code>StrictNoSign</code> signature policy</a>.</p>
</li>
<li>
<p>The <code>data</code> field MUST be filled out with a <code>WakuMessage</code>.
See <a href="waku/standards/core/11/../14/message.html"><code>14/WAKU2-MESSAGE</code></a> for more details.</p>
</li>
<li>
<p>The <code>seqno</code> field MUST NOT be used, following the <a href="waku/standards/core/11/relay.html#signature-policy"><code>StrictNoSign</code> signature policy</a>.</p>
</li>
<li>
<p>The <code>topicIDs</code> field MUST contain the content-topics
that a message is being published on.</p>
</li>
<li>
<p>The <code>signature</code> field MUST NOT be used,
following the <a href="waku/standards/core/11/relay.html#signature-policy"><code>StrictNoSign</code> signature policy</a>.</p>
</li>
<li>
<p>The <code>key</code> field MUST NOT be used,
following the <a href="waku/standards/core/11/relay.html#signature-policy"><code>StrictNoSign</code> signature policy</a>.</p>
</li>
</ul>
<h3 id="subopts-fields"><a class="header" href="#subopts-fields">SubOpts fields</a></h3>
<p>The <code>SubOpts</code> protobuf defines the format
in which subscription options are relayed between peers.
A <code>11/WAKU2-RELAY</code> node MAY decide to subscribe or
unsubscribe from topics by sending updates using <code>SubOpts</code>.
The following usage requirements apply:</p>
<ul>
<li>
<p>The <code>subscribe</code> field MUST contain a boolean,
where <code>true</code> indicates subscribe and <code>false</code> indicates unsubscribe to a topic.</p>
</li>
<li>
<p>The <code>topicid</code> field MUST contain the pubsub topic.</p>
</li>
</ul>
<blockquote>
<p>Note: The <code>topicid</code> refering to pubsub topic and
<code>topicId</code> refering to content-topic are detailed in <a href="waku/standards/core/11/../../../informational/23/topics.html">23/WAKU2-TOPICS</a>.</p>
</blockquote>
<h3 id="signature-policy"><a class="header" href="#signature-policy">Signature Policy</a></h3>
<p>The <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#signature-policy-options"><code>StrictNoSign</code> option</a>
MUST be used, to ensure that messages are built without the <code>signature</code>,
<code>key</code>, <code>from</code> and <code>seqno</code> fields.
Note that this does not merely imply that these fields be empty, but
that they MUST be <em>absent</em> from the marshalled message.</p>
<h2 id="security-analysis"><a class="header" href="#security-analysis">Security Analysis</a></h2>
<!-- TODO: realized that the prime security objective of the `WakuRelay` 
protocol is to provide peers unlinkability
as such this feature is prioritized over other features
e.g., unlinkability is preferred over authenticity and integrity.
It might be good to motivate unlinkability and
its impact on the relay protocol or other protocols invoking relay protocol.-->
<ul>
<li><strong>Publisher-Message Unlinkability</strong>:
To address publisher-message unlinkability,
one should remove any PII from the published message.
As such, <code>11/WAKU2-RELAY</code> follows the <code>StrictNoSign</code> policy as described in
<a href="https://github.com/libp2p/specs/tree/master/pubsub#message-signing">libp2p PubSub specs</a>.
As the result of the <code>StrictNoSign</code> policy,
<code>Message</code>s should be built without the  <code>from</code>,
<code>signature</code> and <code>key</code> fields since each of these three fields individually
counts as PII for the author of the message
(one can link the creation of the message with libp2p peerId and
thus indirectly with the IP address of the publisher).
Note that removing identifiable information from messages
cannot lead to perfect unlinkability.
The direct connections of a publisher
might be able to figure out which <code>Message</code>s belong to that publisher
by analyzing its traffic.
The possibility of such inference may get higher
when the <code>data</code> field is also not encrypted by the upper-level protocols.</li>
</ul>
<!-- TODO: more investigation on traffic analysis attacks and their success probability-->
<ul>
<li><strong>Subscriber-Topic Unlinkability:</strong>
To preserve subscriber-topic unlinkability,
it is recommended by <a href="waku/standards/core/11/../10/waku2.html"><code>10/WAKU2</code></a> to use a single PubSub topic
in the <code>11/WAKU2-RELAY</code> protocol.
This allows an immediate subscriber-topic unlinkability
where subscribers are not re-identifiable from their subscribed topic IDs
as the entire network is linked to the same topic ID.
This level of unlinkability / anonymity
is known as <a href="https://www.privitar.com/blog/k-anonymity-an-introduction/">k-anonymity</a>
where k is proportional to the system size
(number of participants of Waku relay protocol).
However, note that <code>11/WAKU2-RELAY</code> supports the use of more than one topic.
In case that more than one topic id is utilized,
preserving unlinkability is the responsibility of the upper-level protocols
which MAY adopt
<a href="https://specs.status.im/spec/10#partitioned-topic">partitioned topics technique</a>
to achieve K-anonymity for the subscribed peers.</li>
</ul>
<h2 id="future-work"><a class="header" href="#future-work">Future work</a></h2>
<ul>
<li><strong>Economic spam resistance</strong>:
In the spam-protected <code>11/WAKU2-RELAY</code> protocol,
no adversary can flood the system with spam messages
(i.e., publishing a large number of messages in a short amount of time).
Spam protection is partly provided by GossipSub v1.1 through <a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md#spam-protection-measures">scoring mechanism</a>.
At a high level,
peers utilize a scoring function to locally score the behavior of their connections
and remove peers with a low score.
<code>11/WAKU2-RELAY</code> aims at enabling an advanced spam protection mechanism
with economic disincentives by utilizing Rate Limiting Nullifiers.
In a nutshell,
peers must conform to a certain message publishing rate per a system-defined epoch,
otherwise, they get financially penalized for exceeding the rate.
More details on this new technique can be found in <a href="waku/standards/core/11/../17/rln-relay.html"><code>17/WAKU2-RLN-RELAY</code></a>.</li>
</ul>
<!-- TODO havn't checked if all the measures in libp2p GossipSub v1.1
are taken in the nim-libp2p as well, may need to audit the code -->
<ul>
<li>Providing <strong>Unlinkability</strong>, <strong>Integrity</strong> and  <strong>Authenticity</strong> simultaneously:
Integrity and authenticity are typically addressed through digital signatures and
Message Authentication Code (MAC) schemes, however,
the usage of digital signatures (where each signature is bound to a particular peer)
contradicts with the unlinkability requirement
(messages signed under a certain signature key are verifiable by a verification key
that is bound to a particular publisher).
As such, integrity and authenticity are missing features in <code>11/WAKU2-RELAY</code>
in the interest of unlinkability.
In future work, advanced signature schemes like group signatures
can be utilized to enable authenticity, integrity, and unlinkability simultaneously.
In a group signature scheme, a member of a group can anonymously sign a message
on behalf of the group as such the true signer
is indistinguishable from other group members.</li>
</ul>
<!-- TODO: shall I add a reference for group signatures?-->
<h2 id="copyright-16"><a class="header" href="#copyright-16">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-14"><a class="header" href="#references-14">References</a></h2>
<ol>
<li>
<p><a href="waku/standards/core/11/../10/waku2.html"><code>10/WAKU2</code></a></p>
</li>
<li>
<p><a href="waku/standards/core/11/../14/message.html"><code>14/WAKU2-MESSAGE</code></a></p>
</li>
<li>
<p><a href="waku/standards/core/11/../17/rln-relay.html"><code>17/WAKU-RLN</code></a></p>
</li>
<li>
<p><a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.0.md">GossipSub v1.0</a></p>
</li>
<li>
<p><a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md">GossipSub v1.1</a></p>
</li>
<li>
<p><a href="https://www.privitar.com/blog/k-anonymity-an-introduction/">K-anonimity</a></p>
</li>
<li>
<p><a href="https://docs.libp2p.io/concepts/publish-subscribe/"><code>libp2p</code> concepts: Publish/Subscribe</a></p>
</li>
<li>
<p><a href="https://github.com/libp2p/specs/blob/master/connections/README.md#protocol-negotiation"><code>libp2p</code> protocol negotiation</a></p>
</li>
<li>
<p><a href="https://specs.status.im/spec/10#partitioned-topic">Partitioned topics</a></p>
</li>
<li>
<p><a href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a></p>
</li>
<li>
<p><a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md">PubSub interface for libp2p (r2, 2019-02-01)</a></p>
</li>
<li>
<p><a href="waku/standards/core/11/../6/waku1.html">Waku v1 spec</a></p>
</li>
<li>
<p><a href="https://eips.ethereum.org/EIPS/eip-627">Whisper spec (EIP627)</a></p>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="12waku2-filter"><a class="header" href="#12waku2-filter">12/WAKU2-FILTER</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v2 Filter</td></tr>
<tr><th>Slug</th><td>12</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Hanno Cornelius &lt;hanno@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Dean Eigenmann &lt;dean@status.im&gt;<br>Oskar Thorén &lt;oskar@status.im&gt;<br>Sanaz Taheri &lt;sanaz@status.im&gt;<br>Ebube Ud &lt;ebube@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-21"><a class="header" href="#timeline-21">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/core/12/filter.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/core/12/filter.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-03-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/e8a3f8a77ddfc84894f4e1119380e90ca2dd0ab4/waku/standards/core/12/filter.md"><code>e8a3f8a</code></a> — 12/WAKU2-FILTER: Update (#119)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/core/12/filter.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/e4d8f27fd57d64512a482c669fb30d949c1afe90/waku/standards/core/12/filter.md"><code>e4d8f27</code></a> — Update and rename FILTER.md to filter.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/046a3b77a53e01a34e5b71fc3aa7af731af366ce/waku/standards/core/12/FILTER.md"><code>046a3b7</code></a> — Rename WAKU2-FILTER.md to FILTER.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/57124a766cb9e87a5ae6a81522c7725ffd888d61/waku/standards/core/12/WAKU2-FILTER.md"><code>57124a7</code></a> — Rename README.md to WAKU2-FILTER.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/standards/core/12/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/940d7958a286701155f6e8739494e426490e14c4/waku/rfcs/standards/core/12/README.md"><code>940d795</code></a> — Rename waku/12/README.md to waku/rfcs/standards/core/12/README.md</li>
<li><strong>2024-01-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/420adf1bd6fe714366bb11667400b923772835da/waku/12/README.md"><code>420adf1</code></a> — Vac RFC index initial structure</li>
</ul>
<!-- timeline:end -->
<p>previous versions: <a href="waku/standards/core/12//waku/standards/core/12/previous-versions/00/filter.html">00</a></p>
<p><strong>Protocol identifiers</strong>:</p>
<ul>
<li><em>filter-subscribe</em>: <code>/vac/waku/filter-subscribe/2.0.0-beta1</code></li>
<li><em>filter-push</em>: <code>/vac/waku/filter-push/2.0.0-beta1</code></li>
</ul>
<hr />
<h2 id="abstract-13"><a class="header" href="#abstract-13">Abstract</a></h2>
<p>This specification describes the <code>12/WAKU2-FILTER</code> protocol,
which enables a client to subscribe to a subset of real-time messages from a Waku peer.
This is a more lightweight version of <a href="waku/standards/core/12//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a>,
useful for bandwidth restricted devices.
This is often used by nodes with lower resource limits to subscribe to full Relay nodes and
only receive the subset of messages they desire,
based on content topic interest.</p>
<h2 id="motivation-13"><a class="header" href="#motivation-13">Motivation</a></h2>
<p>Unlike the <a href="waku/standards/core/12//waku/standards/core/13/store.html">13/WAKU2-STORE</a> protocol
for historical messages, this protocol allows for native lower latency scenarios,
such as instant messaging.
It is thus complementary to it.</p>
<p>Strictly speaking, it is not just doing basic request-response, but
performs sender push based on receiver intent.
While this can be seen as a form of light publish/subscribe,
it is only used between two nodes in a direct fashion. Unlike the
Gossip domain, this is suitable for light nodes which put a premium on bandwidth.
No gossiping takes place.</p>
<p>It is worth noting that a light node could get by with only using the
<a href="waku/standards/core/12//waku/standards/core/13/store.html">13/WAKU2-STORE</a> protocol to
query for a recent time window, provided it is acceptable to do frequent polling.</p>
<h2 id="semantics"><a class="header" href="#semantics">Semantics</a></h2>
<p>The key words “MUST”, “MUST NOT”, “REQUIRED”,
“SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and
“OPTIONAL” in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">2119</a>.</p>
<h3 id="content-filtering-1"><a class="header" href="#content-filtering-1">Content filtering</a></h3>
<p>Content filtering is a way to do
<a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern#Message_filtering">message-based filtering</a>.
Currently the only content filter being applied is on <code>contentTopic</code>.</p>
<h3 id="terminology-2"><a class="header" href="#terminology-2">Terminology</a></h3>
<p>The term Personally identifiable information (PII)
refers to any piece of data that can be used to uniquely identify a user.
For example, the signature verification key, and
the hash of one's static IP address are unique for each user and hence count as PII.</p>
<h3 id="protobuf"><a class="header" href="#protobuf">Protobuf</a></h3>
<pre><code class="language-protobuf">syntax = "proto3";

// Protocol identifier: /vac/waku/filter-subscribe/2.0.0-beta1
message FilterSubscribeRequest {
  enum FilterSubscribeType {
    SUBSCRIBER_PING = 0;
    SUBSCRIBE = 1;
    UNSUBSCRIBE = 2;
    UNSUBSCRIBE_ALL = 3;
  }

  string request_id = 1;
  FilterSubscribeType filter_subscribe_type = 2;

  // Filter criteria
  optional string pubsub_topic = 10;
  repeated string content_topics = 11;
}

message FilterSubscribeResponse {
  string request_id = 1;
  uint32 status_code = 10;
  optional string status_desc = 11;
}

// Protocol identifier: /vac/waku/filter-push/2.0.0-beta1
message MessagePush {
  WakuMessage waku_message = 1;
  optional string pubsub_topic = 2;
}
</code></pre>
<h3 id="filter-subscribe"><a class="header" href="#filter-subscribe">Filter-Subscribe</a></h3>
<p>A filter service node MUST support the <em>filter-subscribe</em> protocol
to allow filter clients to subscribe, modify, refresh and
unsubscribe a desired set of filter criteria.
The combination of different filter criteria
for a specific filter client node is termed a "subscription".
A filter client is interested in receiving messages matching the filter criteria
in its registered subscriptions.</p>
<p>Since a filter service node is consuming resources to provide this service,
it MAY account for usage and adapt its service provision to certain clients.</p>
<h4 id="filter-subscribe-request"><a class="header" href="#filter-subscribe-request">Filter Subscribe Request</a></h4>
<p>A client node MUST send all filter requests in a <code>FilterSubscribeRequest</code> message.
This request MUST contain a <code>request_id</code>.
The <code>request_id</code> MUST be a uniquely generated string.
Each request MUST include a <code>filter_subscribe_type</code>, indicating the type of request.</p>
<h4 id="filter-subscribe-response"><a class="header" href="#filter-subscribe-response">Filter Subscribe Response</a></h4>
<p>When responding to a <code>FilterSubscribeRequest</code>,
a filter service node SHOULD send a <code>FilterSubscribeResponse</code>
with a <code>requestId</code> matching that of the request.
This response MUST contain a <code>status_code</code> indicating if the request was successful
or not.
Successful status codes are in the <code>2xx</code> range.
Client nodes SHOULD consider all other status codes as error codes and
assume that the requested operation had failed.
In addition,
the filter service node MAY choose to provide a more detailed status description
in the <code>status_desc</code> field.</p>
<h4 id="filter-matching"><a class="header" href="#filter-matching">Filter matching</a></h4>
<p>In the description of each request type below,
the term "filter criteria" refers to the combination of <code>pubsub_topic</code> and
a set of <code>content_topics</code>.
The request MAY include filter criteria,
conditional to the selected <code>filter_subscribe_type</code>.
If the request contains filter criteria,
it MUST contain a <code>pubsub_topic</code>
and the <code>content_topics</code> set MUST NOT be empty.
A <a href="waku/standards/core/12//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a> matches filter criteria
when its <code>content_topic</code> is in the <code>content_topics</code> set
and it was published on a matching <code>pubsub_topic</code>.</p>
<h4 id="filter-subscribe-types"><a class="header" href="#filter-subscribe-types">Filter Subscribe Types</a></h4>
<p>The filter-subscribe types are defined as follows:</p>
<h5 id="subscriber_ping"><a class="header" href="#subscriber_ping">SUBSCRIBER_PING</a></h5>
<p>A filter client that sends a <code>FilterSubscribeRequest</code> with
<code>filter_subscribe_type</code> set to <code>SUBSCRIBER_PING</code>,
requests that the filter service node SHOULD indicate if it has any active subscriptions
for this client.
The filter client SHOULD exclude any filter criteria from the request.
The filter service node SHOULD respond with a success <code>status_code</code>
if it has any active subscriptions for this client
or an error <code>status_code</code> if not.
The filter service node SHOULD ignore any filter criteria in the request.</p>
<h5 id="subscribe"><a class="header" href="#subscribe">SUBSCRIBE</a></h5>
<p>A filter client that sends a <code>FilterSubscribeRequest</code> with
<code>filter_subscribe_type</code> set to <code>SUBSCRIBE</code>
requests that the filter service node SHOULD push messages
matching this filter to the client.
The filter client MUST include the desired filter criteria in the request.
A client MAY use this request type to <em>modify</em> an existing subscription
by providing <em>additional</em> filter criteria in a new request.
A client MAY use this request type to <em>refresh</em> an existing subscription
by providing <em>the same</em> filter criteria in a new request.
The filter service node SHOULD respond with a success <code>status_code</code>
if it successfully honored this request
or an error <code>status_code</code> if not.
The filter service node SHOULD respond with an error <code>status_code</code> and
discard the request if the <code>FilterSubscribeRequest</code>
does not contain valid filter criteria,
i.e. both a <code>pubsub_topic</code> <em>and</em> a non-empty <code>content_topics</code> set.</p>
<h5 id="unsubscribe"><a class="header" href="#unsubscribe">UNSUBSCRIBE</a></h5>
<p>A filter client that sends a <code>FilterSubscribeRequest</code> with
<code>filter_subscribe_type</code> set to <code>UNSUBSCRIBE</code>
requests that the service node SHOULD <em>stop</em> pushing messages
matching this filter to the client.
The filter client MUST include the filter criteria
it desires to unsubscribe from in the request.
A client MAY use this request type to <em>modify</em> an existing subscription
by providing <em>a subset of</em> the original filter criteria
to unsubscribe from in a new request.
The filter service node SHOULD respond with a success <code>status_code</code>
if it successfully honored this request
or an error <code>status_code</code> if not.
The filter service node SHOULD respond with an error <code>status_code</code> and
discard the request if the unsubscribe request does not contain valid filter criteria,
i.e. both a <code>pubsub_topic</code> <em>and</em> a non-empty <code>content_topics</code> set.</p>
<h5 id="unsubscribe_all"><a class="header" href="#unsubscribe_all">UNSUBSCRIBE_ALL</a></h5>
<p>A filter client that sends a <code>FilterSubscribeRequest</code> with
<code>filter_subscribe_type</code> set to <code>UNSUBSCRIBE_ALL</code>
requests that the service node SHOULD <em>stop</em> pushing messages
matching <em>any</em> filter to the client.
The filter client SHOULD exclude any filter criteria from the request.
The filter service node SHOULD remove any existing subscriptions for this client.
It SHOULD respond with a success <code>status_code</code> if it successfully honored this request
or an error <code>status_code</code> if not.</p>
<h3 id="filter-push"><a class="header" href="#filter-push">Filter-Push</a></h3>
<p>A filter client node MUST support the <em>filter-push</em> protocol
to allow filter service nodes to push messages
matching registered subscriptions to this client.</p>
<p>A filter service node SHOULD push all messages
matching the filter criteria in a registered subscription
to the subscribed filter client.
These <a href="waku/standards/core/12//waku/standards/core/14/message.html"><code>WakuMessage</code>s</a>
are likely to come from <a href="waku/standards/core/12//waku/standards/core/11/relay.html"><code>11/WAKU2-RELAY</code></a>,
but there MAY be other sources or protocols where this comes from.
This is up to the consumer of the protocol.</p>
<p>If a message push fails,
the filter service node MAY consider the client node to be unreachable.
If a specific filter client node is not reachable from the service node
for a period of time,
the filter service node MAY choose to stop pushing messages to the client and
remove its subscription.
This period is up to the service node implementation.
It is RECOMMENDED to set <code>1 minute</code> as a reasonable default.</p>
<h4 id="message-push"><a class="header" href="#message-push">Message Push</a></h4>
<p>Each message MUST be pushed in a <code>MessagePush</code> message.
Each <code>MessagePush</code> MUST contain one (and only one) <code>waku_message</code>.
If this message was received on a specific <code>pubsub_topic</code>,
it SHOULD be included in the <code>MessagePush</code>.
A filter client SHOULD NOT respond to a <code>MessagePush</code>.
Since the filter protocol does not include caching or fault-tolerance,
this is a best effort push service with no bundling
or guaranteed retransmission of messages.
A filter client SHOULD verify that each <code>MessagePush</code> it receives
originated from a service node where the client has an active subscription
and that it matches filter criteria belonging to that subscription.</p>
<h3 id="adversarial-model-1"><a class="header" href="#adversarial-model-1">Adversarial Model</a></h3>
<p>Any node running the <code>WakuFilter</code> protocol
i.e., both the subscriber node and
the queried node are considered as an adversary.
Furthermore, we consider the adversary as a passive entity
that attempts to collect information from other nodes to conduct an attack but
it does so without violating protocol definitions and instructions.
For example, under the passive adversarial model,
no malicious node intentionally hides the messages
matching to one's subscribed content filter
as it is against the description of the <code>WakuFilter</code> protocol.</p>
<p>The following are not considered as part of the adversarial model:</p>
<ul>
<li>An adversary with a global view of all the nodes and their connections.</li>
<li>An adversary that can eavesdrop on communication links
between arbitrary pairs of nodes (unless the adversary is one end of the communication).
In specific, the communication channels are assumed to be secure.</li>
</ul>
<h3 id="security-considerations-3"><a class="header" href="#security-considerations-3">Security Considerations</a></h3>
<p>Note that while using <code>WakuFilter</code> allows light nodes to save bandwidth,
it comes with a privacy cost in the sense that they need to
disclose their liking topics to the full nodes to retrieve the relevant messages.
Currently, anonymous subscription is not supported by the <code>WakuFilter</code>, however,
potential solutions in this regard are discussed below.</p>
<h4 id="future-work-1"><a class="header" href="#future-work-1">Future Work</a></h4>
<!-- Alternative title: Filter-subscriber unlinkability -->
<p><strong>Anonymous filter subscription</strong>:
This feature guarantees that nodes can anonymously subscribe for a message filter
(i.e., without revealing their exact content filter).
As such, no adversary in the <code>WakuFilter</code> protocol
would be able to link nodes to their subscribed content filers.
The current version of the <code>WakuFilter</code> protocol does not provide anonymity
as the subscribing node has a direct connection to the full node and
explicitly submits its content filter to be notified about the matching messages.
However, one can consider preserving anonymity through one of the following ways:</p>
<ul>
<li>By hiding the source of the subscription i.e., anonymous communication.
That is the subscribing node shall hide all its PII in its filter request
e.g., its IP address.
This can happen by the utilization of a proxy server or by using Tor</li>
</ul>
<!-- TODO: if nodes have to disclose their PeerIDs
(e.g., for authentication purposes)
when connecting to other nodes in the WakuFilter protocol,
then Tor does not preserve anonymity since it only helps in hiding the IP.
So, the PeerId usage in switches must be investigated further.
Depending on how PeerId is used,
one may be able to link between a subscriber and
its content filter despite hiding the IP address-->.
<p>Note that the current structure of filter requests
i.e., <code>FilterRPC</code> does not embody any piece of PII, otherwise,
such data fields must be treated carefully to achieve anonymity.</p>
<ul>
<li>By deploying secure 2-party computations in which
the subscribing node obtains the messages matching a content filter
whereas the full node learns nothing about the content filter as well as
the messages pushed to the subscribing node.
Examples of such 2PC protocols are
<a href="https://link.springer.com/referenceworkentry/10.1007%2F978-1-4419-5906-5_9#:~:text=Oblivious%20transfer%20(OT)%20is%20a,information%20the%20receiver%20actually%20obtains.">Oblivious Transfers</a>
and one-way Private Set Intersections (PSI).</li>
</ul>
<h2 id="copyright-17"><a class="header" href="#copyright-17">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-15"><a class="header" href="#references-15">References</a></h2>
<ul>
<li><a href="waku/standards/core/12//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a></li>
<li><a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern#Message_filtering">message-based filtering</a></li>
<li><a href="waku/standards/core/12//waku/standards/core/13/store.html">13/WAKU2-STORE</a></li>
<li><a href="waku/standards/core/12//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a></li>
<li><a href="https://link.springer.com/referenceworkentry/10.1007%2F978-1-4419-5906-5_9#:~:text=Oblivious%20transfer%20(OT)%20is%20a,information%20the%20receiver%20actually%20obtains">Oblivious Transfers</a></li>
<li>12/WAKU2-FILTER previous version: <a href="waku/standards/core/12/waku/standards/core/12/previous-versions/00/filter.html">00</a></li>
</ul>
<h3 id="informative-2"><a class="header" href="#informative-2">Informative</a></h3>
<ol>
<li><a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern#Message_filtering">Message Filtering (Wikipedia)</a></li>
<li><a href="https://github.com/libp2p/specs/tree/master/pubsub#topic-validation">Libp2p PubSub spec - topic validation</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="13waku2-store"><a class="header" href="#13waku2-store">13/WAKU2-STORE</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku Store Query</td></tr>
<tr><th>Slug</th><td>13</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Hanno Cornelius &lt;hanno@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Dean Eigenmann &lt;dean@status.im&gt;<br>Oskar Thorén &lt;oskarth@titanproxy.com&gt;<br>Aaryamann Challani &lt;p1ge0nh8er@proton.me&gt;<br>Sanaz Taheri &lt;sanaz@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-22"><a class="header" href="#timeline-22">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/core/13/store.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/core/13/store.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-15</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/1b8b2ac70bb697d52fd0d2201b9e3c59041863cf/waku/standards/core/13/store.md"><code>1b8b2ac</code></a> — Add missing status to 13/WAKU-STORE (#149)</li>
<li><strong>2025-02-03</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/a60a2c45de49966c3550e0f5efe2fa4b081dd40f/waku/standards/core/13/store.md"><code>a60a2c4</code></a> — 13/WAKU-STORE: Update (#124)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/core/13/store.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-08-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eb25cd06d679e94409072a96841de16a6b3910d5/waku/standards/core/13/store.md"><code>eb25cd0</code></a> — chore: replace email addresses (#86)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/core/13/store.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/755be9440d31a71ffdc3c250baa802f0220f29e5/waku/standards/core/13/store.md"><code>755be94</code></a> — Update and rename STORE.md to store.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3baed074afeae25c69e15af1b6534d0bf89034c2/waku/standards/core/13/STORE.md"><code>3baed07</code></a> — Rename README.md to STORE.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/standards/core/13/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/51e28795c2b64c87c741ec7b3a6669e0d020e1e5/waku/rfcs/standards/core/13/README.md"><code>51e2879</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<p>Previous version: <a href="waku/standards/core/13//waku/standards/core/13/previous-versions/00/store.html">00</a></p>
<h2 id="abstract-14"><a class="header" href="#abstract-14">Abstract</a></h2>
<p>This specification explains the <code>WAKU2-STORE</code> protocol,
which enables querying of <a href="waku/standards/core/13//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a>s.</p>
<p><strong>Protocol identifier</strong>*: <code>/vac/waku/store-query/3.0.0</code></p>
<h3 id="terminology-3"><a class="header" href="#terminology-3">Terminology</a></h3>
<p>The term PII, Personally Identifiable Information,
refers to any piece of data that can be used to uniquely identify a user.
For example, the signature verification key, and
the hash of one's static IP address are unique for each user and hence count as PII.</p>
<h2 id="wire-specification-1"><a class="header" href="#wire-specification-1">Wire Specification</a></h2>
<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”,
“SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and
“OPTIONAL” in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">RFC2119</a>.</p>
<h3 id="design-requirements"><a class="header" href="#design-requirements">Design Requirements</a></h3>
<p>The concept of <code>ephemeral</code> messages introduced in <a href="waku/standards/core/13//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a> affects <code>WAKU2-STORE</code> as well.
Nodes running <code>WAKU2-STORE</code> SHOULD support <code>ephemeral</code> messages as specified in <a href="waku/standards/core/13//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a>.
Nodes running <code>WAKU2-STORE</code> SHOULD NOT store messages with the <code>ephemeral</code> flag set to <code>true</code>.</p>
<h3 id="payloads-2"><a class="header" href="#payloads-2">Payloads</a></h3>
<pre><code class="language-protobuf">syntax = "proto3";

// Protocol identifier: /vac/waku/store-query/3.0.0
package waku.store.v3;

import "waku/message/v1/message.proto";

message WakuMessageKeyValue {
  optional bytes message_hash = 1; // Globally unique key for a Waku Message

  // Full message content and associated pubsub_topic as value
  optional waku.message.v1.WakuMessage message = 2;
  optional string pubsub_topic = 3;
}

message StoreQueryRequest {
  string request_id = 1;
  bool include_data = 2; // Response should include full message content
  
  // Filter criteria for content-filtered queries
  optional string pubsub_topic = 10;
  repeated string content_topics = 11;
  optional sint64 time_start = 12;
  optional sint64 time_end = 13;

  // List of key criteria for lookup queries
  repeated bytes message_hashes = 20; // Message hashes (keys) to lookup
  
  // Pagination info. 50 Reserved
  optional bytes pagination_cursor = 51; // Message hash (key) from where to start query (exclusive)
  bool pagination_forward = 52;
  optional uint64 pagination_limit = 53;
}

message StoreQueryResponse {
  string request_id = 1;

  optional uint32 status_code = 10;
  optional string status_desc = 11;

  repeated WakuMessageKeyValue messages = 20;

  optional bytes pagination_cursor = 51;
}
</code></pre>
<h3 id="general-store-query-concepts"><a class="header" href="#general-store-query-concepts">General Store Query Concepts</a></h3>
<h4 id="waku-message-key-value-pairs"><a class="header" href="#waku-message-key-value-pairs">Waku Message Key-Value Pairs</a></h4>
<p>The store query protocol operates as a query protocol for a key-value store of historical messages,
with each entry having a <a href="waku/standards/core/13//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a>
and associated <code>pubsub_topic</code> as the value,
and <a href="waku/standards/core/13//waku/standards/core/14/message.html#deterministic-message-hashing">deterministic message hash</a> as the key.
The store can be queried to return either a set of keys or a set of key-value pairs.</p>
<p>Within the store query protocol,
the <a href="waku/standards/core/13//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a> keys and
values MUST be represented in a <code>WakuMessageKeyValue</code> message.
This message MUST contain the deterministic <code>message_hash</code> as the key.
It MAY contain the full <a href="waku/standards/core/13//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a> and
associated pubsub topic as the value in the <code>message</code> and
<code>pubsub_topic</code> fields, depending on the use case as set out below.</p>
<p>If the message contains a value entry in addition to the key,
both the <code>message</code> and <code>pubsub_topic</code> fields MUST be populated.
The message MUST NOT have either <code>message</code> or <code>pubsub_topic</code> populated with the other unset.
Both fields MUST either be set or unset.</p>
<h4 id="waku-message-store-eligibility"><a class="header" href="#waku-message-store-eligibility">Waku Message Store Eligibility</a></h4>
<p>In order for a message to be eligible for storage:</p>
<ul>
<li>it MUST be a <em>valid</em> <a href="waku/standards/core/13//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a>.</li>
<li>the <code>timestamp</code> field MUST be populated with the Unix epoch time,
at which the message was generated in nanoseconds.
If at the time of storage the <code>timestamp</code> deviates by more than 20 seconds
either into the past or the future when compared to the store node’s internal clock,
the store node MAY reject the message.</li>
<li>the <code>ephemeral</code> field MUST be set to <code>false</code>.</li>
</ul>
<h4 id="waku-message-sorting"><a class="header" href="#waku-message-sorting">Waku message sorting</a></h4>
<p>The key-value entries in the store MUST be time-sorted by the <a href="waku/standards/core/13//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a> <code>timestamp</code> attribute.
Where two or more key-value entries have identical <code>timestamp</code> values,
the entries MUST be further sorted by the natural order of their message hash keys.
Within the context of traversing over key-value entries in the store,
<em>"forward"</em> indicates traversing the entries in ascending order,
whereas <em>"backward"</em> indicates traversing the entries in descending order.</p>
<h4 id="pagination"><a class="header" href="#pagination">Pagination</a></h4>
<p>If a large number of entries in the store service node match the query criteria provided in a <code>StoreQueryRequest</code>,
the client MAY make use of pagination
in a chain of store query request and response transactions
to retrieve the full response in smaller batches termed <em>"pages"</em>.
Pagination can be performed either in <a href="waku/standards/core/13/store.html#waku-message-sorting">a <em>forward</em> or <em>backward</em> direction</a>.</p>
<p>A store query client MAY indicate the maximum number of matching entries it wants in the <code>StoreQueryResponse</code>,
by setting the page size limit in the <code>pagination_limit</code> field.
Note that a store service node MAY enforce its own limit
if the <code>pagination_limit</code> is unset
or larger than the service node's internal page size limit.</p>
<p>A <code>StoreQueryResponse</code> with a populated <code>pagination_cursor</code> indicates that more stored entries match the query than included in the response.</p>
<p>A <code>StoreQueryResponse</code> without a populated <code>pagination_cursor</code> indicates that
there are no more matching entries in the store.</p>
<p>The client MAY request the next page of entries from the store service node
by populating a subsequent <code>StoreQueryRequest</code> with the <code>pagination_cursor</code>
received in the <code>StoreQueryResponse</code>.
All other fields and query criteria MUST be the same as in the preceding <code>StoreQueryRequest</code>.</p>
<p>A <code>StoreQueryRequest</code> without a populated <code>pagination_cursor</code> indicates that
the client wants to retrieve the "first page" of the stored entries matching the query.</p>
<h3 id="store-query-request"><a class="header" href="#store-query-request">Store Query Request</a></h3>
<p>A client node MUST send all historical message queries within a <code>StoreQueryRequest</code> message.
This request MUST contain a <code>request_id</code>.
The <code>request_id</code> MUST be a uniquely generated string.</p>
<p>If the store query client requires the store service node to include <a href="waku/standards/core/13//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a> values in the query response,
it MUST set <code>include_data</code> to <code>true</code>.
If the store query client requires the store service node to return only message hash keys in the query response,
it SHOULD set <code>include_data</code> to <code>false</code>.
By default, therefore, the store service node assumes <code>include_data</code> to be <code>false</code>.</p>
<p>A store query client MAY include query filter criteria in the <code>StoreQueryRequest</code>.
There are two types of filter use cases:</p>
<ol>
<li>Content filtered queries and</li>
<li>Message hash lookup queries</li>
</ol>
<h4 id="content-filtered-queries"><a class="header" href="#content-filtered-queries">Content filtered queries</a></h4>
<p>A store query client MAY request the store service node to filter historical entries by a content filter.
Such a client MAY create a filter on content topic, on time range or on both.</p>
<p>To filter on content topic,
the client MUST populate <em>both</em> the <code>pubsub_topic</code> <em>and</em> <code>content_topics</code> field.
The client MUST NOT populate either <code>pubsub_topic</code> or
<code>content_topics</code> and leave the other unset.
Both fields MUST either be set or unset.
A mixed content topic filter with just one of either <code>pubsub_topic</code> or
<code>content_topics</code> set, SHOULD be regarded as an invalid request.</p>
<p>To filter on time range, the client MUST set <code>time_start</code>, <code>time_end</code> or both.
Each <code>time_</code> field should contain a Unix epoch timestamp in nanoseconds.
An unset <code>time_start</code> SHOULD be interpreted as "from the oldest stored entry".
An unset <code>time_end</code> SHOULD be interpreted as "up to the youngest stored entry".</p>
<p>If any of the content filter fields are set,
namely <code>pubsub_topic</code>, <code>content_topic</code>, <code>time_start</code>, or <code>time_end</code>,
the client MUST NOT set the <code>message_hashes</code> field.</p>
<h4 id="message-hash-lookup-queries"><a class="header" href="#message-hash-lookup-queries">Message hash lookup queries</a></h4>
<p>A store query client MAY request the store service node to filter historical entries by one or
more matching message hash keys.
This type of query acts as a "lookup" against a message hash key or
set of keys already known to the client.</p>
<p>In order to perform a lookup query,
the store query client MUST populate the <code>message_hashes</code> field with the list of message hash keys it wants to lookup in the store service node.</p>
<p>If the <code>message_hashes</code> field is set,
the client MUST NOT set any of the content filter fields,
namely <code>pubsub_topic</code>, <code>content_topic</code>, <code>time_start</code>, or <code>time_end</code>.</p>
<h4 id="presence-queries"><a class="header" href="#presence-queries">Presence queries</a></h4>
<p>A presence query is a special type of lookup query that allows a client to check for the presence of one or
more messages in the store service node,
without retrieving the full contents (values) of the messages.
This can, for example, be used as part of a reliability mechanism,
whereby store query clients verify that previously published messages have been successfully stored.</p>
<p>In order to perform a presence query,
the store query client MUST populate the <code>message_hashes</code> field in the <code>StoreQueryRequest</code> with the list of message hashes
for which it wants to verify presence in the store service node.
The <code>include_data</code> property MUST be set to <code>false</code>.
The client SHOULD interpret every <code>message_hash</code> returned in the <code>messages</code> field of the <code>StoreQueryResponse</code> as present in the store.
The client SHOULD assume that all other message hashes included in the original <code>StoreQueryRequest</code> but
not in the <code>StoreQueryResponse</code> is not present in the store.</p>
<h4 id="pagination-info"><a class="header" href="#pagination-info">Pagination info</a></h4>
<p>The store query client MAY include a message hash as <code>pagination_cursor</code>,
to indicate at which key-value entry a store service node SHOULD start the query.
The <code>pagination_cursor</code> is treated as exclusive
and the corresponding entry will not be included in subsequent store query responses.</p>
<p>For forward queries,
only messages following (see <a href="waku/standards/core/13/store.html#waku-message-sorting">sorting</a>) the one indexed at <code>pagination_cursor</code>
will be returned.
For backward queries,
only messages preceding (see <a href="waku/standards/core/13/store.html#waku-message-sorting">sorting</a>) the one indexed at <code>pagination_cursor</code>
will be returned.</p>
<p>If the store query client requires the store service node to perform a forward query,
it MUST set <code>pagination_forward</code> to <code>true</code>.
If the store query client requires the store service node to perform a backward query,
it SHOULD set <code>pagination_forward</code> to <code>false</code>.
By default, therefore, the store service node assumes pagination to be backward.</p>
<p>A store query client MAY indicate the maximum number of matching entries it wants in the <code>StoreQueryResponse</code>,
by setting the page size limit in the <code>pagination_limit</code> field.
Note that a store service node MAY enforce its own limit
if the <code>pagination_limit</code> is unset
or larger than the service node's internal page size limit.</p>
<p>See <a href="waku/standards/core/13/store.html#pagination">pagination</a> for more on how the pagination info is used in store transactions.</p>
<h3 id="store-query-response"><a class="header" href="#store-query-response">Store Query Response</a></h3>
<p>In response to any <code>StoreQueryRequest</code>,
a store service node SHOULD respond with a <code>StoreQueryResponse</code> with a <code>requestId</code> matching that of the request.
This response MUST contain a <code>status_code</code> indicating if the request was successful or not.
Successful status codes are in the <code>2xx</code> range.
A client node SHOULD consider all other status codes as error codes and
assume that the requested operation had failed.
In addition,
the store service node MAY choose to provide a more detailed status description in the <code>status_desc</code> field.</p>
<h4 id="filter-matching-1"><a class="header" href="#filter-matching-1">Filter matching</a></h4>
<p>For <a href="waku/standards/core/13/store.html#content-filtered-queries">content filtered queries</a>,
an entry in the store service node matches the filter criteria in a <code>StoreQueryRequest</code> if each of the following conditions are met:</p>
<ul>
<li>its <code>content_topic</code> is in the request <code>content_topics</code> set
and it was published on a matching <code>pubsub_topic</code> OR the request <code>content_topics</code> and
<code>pubsub_topic</code> fields are unset</li>
<li>its <code>timestamp</code> is <em>larger or equal</em> than the request <code>start_time</code> OR the request <code>start_time</code> is unset</li>
<li>its <code>timestamp</code> is <em>smaller</em> than the request <code>end_time</code> OR the request <code>end_time</code> is unset</li>
</ul>
<p>Note that for content filtered queries, <code>start_time</code> is treated as <em>inclusive</em> and
<code>end_time</code> is treated as <em>exclusive</em>.</p>
<p>For <a href="waku/standards/core/13/store.html#message-hash-lookup-queries">message hash lookup queries</a>,
an entry in the store service node matches the filter criteria if its <code>message_hash</code> is in the request <code>message_hashes</code> set.</p>
<p>The store service node SHOULD respond with an error code and
discard the request if the store query request contains both content filter criteria
and message hashes.</p>
<h4 id="populating-response-messages"><a class="header" href="#populating-response-messages">Populating response messages</a></h4>
<p>The store service node SHOULD populate the <code>messages</code> field in the response
only with entries matching the filter criteria provided in the corresponding request.
Regardless of whether the response is to a <em>forward</em> or <em>backward</em> query,
the <code>messages</code> field in the response MUST be ordered in a forward direction
according to the <a href="waku/standards/core/13/store.html#waku-message-sorting">message sorting rules</a>.</p>
<p>If the corresponding <code>StoreQueryRequest</code> has <code>include_data</code> set to true,
the service node SHOULD populate both the <code>message_hash</code> and
<code>message</code> for each entry in the response.
In all other cases,
the store service node SHOULD populate only the <code>message_hash</code> field for each entry in the response.</p>
<h4 id="paginating-the-response"><a class="header" href="#paginating-the-response">Paginating the response</a></h4>
<p>The response SHOULD NOT contain more <code>messages</code> than the <code>pagination_limit</code> provided in the corresponding <code>StoreQueryRequest</code>.
It is RECOMMENDED that the store node defines its own maximum page size internally.
If the <code>pagination_limit</code> in the request is unset,
or exceeds this internal maximum page size,
the store service node SHOULD ignore the <code>pagination_limit</code> field and
apply its own internal maximum page size.</p>
<p>In response to a <em>forward</em> <code>StoreQueryRequest</code>:</p>
<ul>
<li>if the <code>pagination_cursor</code> is set,
the store service node SHOULD populate the <code>messages</code> field
with matching entries following the <code>pagination_cursor</code> (exclusive).</li>
<li>if the <code>pagination_cursor</code> is unset,
the store service node SHOULD populate the <code>messages</code> field
with matching entries from the first entry in the store.</li>
<li>if there are still more matching entries in the store
after the maximum page size is reached while populating the response,
the store service node SHOULD populate the <code>pagination_cursor</code> in the <code>StoreQueryResponse</code>
with the message hash key of the <em>last</em> entry <em>included</em> in the response.</li>
</ul>
<p>In response to a <em>backward</em> <code>StoreQueryRequest</code>:</p>
<ul>
<li>if the <code>pagination_cursor</code> is set,
the store service node SHOULD populate the <code>messages</code> field
with matching entries preceding the <code>pagination_cursor</code> (exclusive).</li>
<li>if the <code>pagination_cursor</code> is unset,
the store service node SHOULD populate the <code>messages</code> field
with matching entries from the last entry in the store.</li>
<li>if there are still more matching entries in the store
after the maximum page size is reached while populating the response,
the store service node SHOULD populate the <code>pagination_cursor</code> in the <code>StoreQueryResponse</code>
with the message hash key of the <em>first</em> entry <em>included</em> in the response.</li>
</ul>
<h3 id="security-consideration"><a class="header" href="#security-consideration">Security Consideration</a></h3>
<p>The main security consideration while using this protocol is that a querying node has to reveal its content filters of interest to the queried node,
hence potentially compromising their privacy.</p>
<h4 id="adversarial-model-2"><a class="header" href="#adversarial-model-2">Adversarial Model</a></h4>
<p>Any peer running the <code>WAKU2-STORE</code> protocol, i.e.
both the querying node and the queried node, are considered as an adversary.
Furthermore,
we currently consider the adversary as a passive entity that attempts to collect information from other peers to conduct an attack but
it does so without violating protocol definitions and instructions.
As we evolve the protocol,
further adversarial models will be considered.
For example, under the passive adversarial model,
no malicious node hides or
lies about the history of messages as it is against the description of the <code>WAKU2-STORE</code> protocol.</p>
<p>The following are not considered as part of the adversarial model:</p>
<ul>
<li>An adversary with a global view of all the peers and their connections.</li>
<li>An adversary that can eavesdrop on communication links between arbitrary pairs of peers (unless the adversary is one end of the communication).
Specifically, the communication channels are assumed to be secure.</li>
</ul>
<h3 id="future-work-2"><a class="header" href="#future-work-2">Future Work</a></h3>
<ul>
<li>
<p><strong>Anonymous query</strong>: This feature guarantees that nodes can anonymously query historical messages from other nodes i.e.,
without disclosing the exact topics of <a href="waku/standards/core/13//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a> they are interested in.<br />
As such, no adversary in the <code>WAKU2-STORE</code> protocol would be able to learn which peer is interested in which content filters i.e.,
content topics of <a href="waku/standards/core/13//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a>.
The current version of the <code>WAKU2-STORE</code> protocol does not provide anonymity for historical queries,
as the querying node needs to directly connect to another node in the <code>WAKU2-STORE</code> protocol and
explicitly disclose the content filters of its interest to retrieve the corresponding messages.
However, one can consider preserving anonymity through one of the following ways:</p>
</li>
<li>
<p>By hiding the source of the request i.e., anonymous communication.
That is the querying node shall hide all its PII in its history request e.g.,
its IP address.
This can happen by the utilization of a proxy server or by using Tor.
Note that the current structure of historical requests does not embody any piece of PII, otherwise,
such data fields must be treated carefully to achieve query anonymity.</p>
</li>
</ul>
<!-- TODO: if nodes have to disclose their PeerIDs
(e.g., for authentication purposes) when connecting to other nodes in the store protocol,
then Tor does not preserve anonymity since it only helps in hiding the IP.
So, the PeerId usage in switches must be investigated further.
Depending on how PeerId is used, one may be able to link between a querying node 
and its queried topics despite hiding the IP address-->
<ul>
<li>By deploying secure 2-party computations
in which the querying node obtains the historical messages of a certain topic,
the queried node learns nothing about the query.
Examples of such 2PC protocols are secure one-way Private Set Intersections (PSI).</li>
</ul>
<!-- TODO: add a reference for PSIs? --> <!-- TODO: more techniques to be included -->
<!-- TODO: Censorship resistant:
this is about a node that hides the historical messages from other nodes.
This attack is not included in the specs since it does not fit the
passive adversarial model (the attacker needs to deviate from the store protocol).-->
<ul>
<li><strong>Robust and verifiable timestamps</strong>: Messages timestamp is a way to show that
the message existed prior to some point in time.
However, the lack of timestamp verifiability can create room for a range of attacks,
including injecting messages with invalid timestamps pointing to the far future.
To better understand the attack,
consider a store node whose current clock shows <code>2021-01-01 00:00:30</code>
(and assume all the other nodes have a synchronized clocks +-20seconds).
The store node already has a list of messages,
<code>(m1,2021-01-01 00:00:00), (m2,2021-01-01 00:00:01), ..., (m10:2021-01-01 00:00:20)</code>,
that are sorted based on their timestamp.<br />
An attacker sends a message with an arbitrary large timestamp e.g.,
10 hours ahead of the correct clock <code>(m',2021-01-01 10:00:30)</code>.
The store node places <code>m'</code> at the end of the list,
<code>(m1,2021-01-01 00:00:00), (m2,2021-01-01 00:00:01), ..., (m10:2021-01-01 00:00:20), (m',2021-01-01 10:00:30)</code>.
Now another message arrives with a valid timestamp e.g.,
<code>(m11, 2021-01-01 00:00:45)</code>.
However, since its timestamp precedes the malicious message <code>m'</code>,
it gets placed before <code>m'</code> in the list i.e.,
<code>(m1,2021-01-01 00:00:00), (m2,2021-01-01 00:00:01), ..., (m10:2021-01-01 00:00:20), (m11, 2021-01-01 00:00:45), (m',2021-01-01 10:00:30)</code>.
In fact, for the next 10 hours,
<code>m'</code> will always be considered as the most recent message and
served as the last message to the querying nodes irrespective of how many other
messages arrive afterward.</li>
</ul>
<p>A robust and verifiable timestamp allows the receiver of a message to verify that
a message has been generated prior to the claimed timestamp.
One solution is the use of <a href="https://opentimestamps.org/">open timestamps</a> e.g.,
block height in Blockchain-based timestamps.
That is, messages contain the most recent block height perceived by their senders
at the time of message generation.
This proves accuracy within a range of minutes (e.g., in Bitcoin blockchain) or
seconds (e.g., in Ethereum 2.0) from the time of origination.</p>
<h2 id="copyright-18"><a class="header" href="#copyright-18">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-16"><a class="header" href="#references-16">References</a></h2>
<ol>
<li><a href="waku/standards/core/13//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a></li>
<li><a href="https://developers.google.com/protocol-buffers/">protocol buffers v3</a></li>
<li><a href="https://opentimestamps.org/">Open timestamps</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="14waku2-message"><a class="header" href="#14waku2-message">14/WAKU2-MESSAGE</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v2 Message</td></tr>
<tr><th>Slug</th><td>14</td></tr>
<tr><th>Status</th><td>stable</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Hanno Cornelius &lt;hanno@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Sanaz Taheri &lt;sanaz@status.im&gt;<br>Aaryamann Challani &lt;p1ge0nh8er@proton.me&gt;<br>Lorenzo Delgado &lt;lorenzo@status.im&gt;<br>Abhimanyu Rawat &lt;abhi@status.im&gt;<br>Oskar Thorén &lt;oskarth@titanproxy.com&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-23"><a class="header" href="#timeline-23">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/core/14/message.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/core/14/message.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-09</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/805280880a1c68b002c23b0bfbcded86eabe68ba/waku/standards/core/14/message.md"><code>8052808</code></a> — 14/WAKU2-MESSAGE: Move to Stable (#120)</li>
<li><strong>2024-11-20</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/ff87c84dc71d4f933bab188993914069fea12baa/waku/standards/core/14/message.md"><code>ff87c84</code></a> — Update Waku Links (#104)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/core/14/message.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-08-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eb25cd06d679e94409072a96841de16a6b3910d5/waku/standards/core/14/message.md"><code>eb25cd0</code></a> — chore: replace email addresses (#86)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/core/14/message.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/8e70159669b48c37e6934a5d24dbbc600fafde87/waku/standards/core/14/message.md"><code>8e70159</code></a> — Update and rename MESSAGE.md to message.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/88df5d8a40101301c529799fefee6949732766a4/waku/standards/core/14/MESSAGE.md"><code>88df5d8</code></a> — Rename README.md to MESSAGE.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/standards/core/14/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/9cd48a881189dcba3a7681a618731e40a2d38bcc/waku/rfcs/standards/core/14/README.md"><code>9cd48a8</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-15"><a class="header" href="#abstract-15">Abstract</a></h2>
<p><a href="waku/standards/core/14//waku/standards/core/10/waku2.html">10/WAKU2</a> is a family of modular peer-to-peer protocols
for secure communication.
These protocols are designed to be secure, privacy-preserving,
and censorship-resistant and can run in resource-restricted environments.
At a high level,
<a href="waku/standards/core/14//waku/standards/core/10/waku2.html">10/WAKU2</a> implements a publish/subscribe messaging pattern over libp2p and
adds capabilities.</p>
<p>The present document specifies the <a href="waku/standards/core/14//waku/standards/core/10/waku2.html">10/WAKU2</a> message format.
A way to encapsulate the messages sent with specific information security goals,
and Whisper/<a href="waku/standards/core/14//waku/standards/legacy/6/waku1.html">6/WAKU1</a> backward compatibility.</p>
<h2 id="motivation-14"><a class="header" href="#motivation-14">Motivation</a></h2>
<p>When sending messages over Waku, there are multiple requirements:</p>
<ul>
<li>One may have a separate encryption layer as part of the application.</li>
<li>One may want to provide efficient routing for resource-restricted devices.</li>
<li>One may want to provide compatibility with <a href="waku/standards/core/14//waku/standards/legacy/6/waku1.html">6/WAKU1</a> envelopes.</li>
<li>One may want encrypted payloads by default.</li>
<li>One may want to provide unlinkability to get metadata protection.</li>
</ul>
<p>This specification attempts to provide for these various requirements.</p>
<h2 id="semantics-1"><a class="header" href="#semantics-1">Semantics</a></h2>
<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”,
“SHOULD NOT”, “RECOMMENDED”, “MAY”, and
“OPTIONAL” in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">2119</a>.</p>
<h3 id="waku-message"><a class="header" href="#waku-message">Waku Message</a></h3>
<p>A <code>WakuMessage</code> is constituted by the combination of data payload and
attributes that, for example, a <em>publisher</em> sends to a <em>topic</em> and
is eventually delivered to <em>subscribers</em>.</p>
<p>The <code>WakuMessage</code> attributes are key-value pairs of metadata associated with a message.
The message data payload is the part of the transmitted <code>WakuMessage</code>
that is the actual message information.
The data payload is also treated as a <code>WakuMessage</code> attribute for convenience.</p>
<h3 id="message-attributes"><a class="header" href="#message-attributes">Message Attributes</a></h3>
<ul>
<li>
<p>The <code>payload</code> attribute MUST contain the message data payload to be sent.</p>
</li>
<li>
<p>The <code>content_topic</code> attribute MUST specify a string identifier
that can be used for content-based filtering,
as described in <a href="waku/standards/core/14//waku/informational/23/topics.html">23/WAKU2-TOPICS</a>.</p>
</li>
<li>
<p>The <code>meta</code> attribute, if present,
contains an arbitrary application-specific variable-length byte array
with a maximum length limit of 64 bytes.
This attribute can be utilized to convey supplementary details
to various <a href="waku/standards/core/14//waku/standards/core/10/waku2.html">10/WAKU2</a> protocols,
thereby enabling customized processing based on its contents.</p>
</li>
<li>
<p>The <code>version</code> attribute, if present,
contains a version number to discriminate different types of payload encryption.
If omitted, the value SHOULD be interpreted as version 0.</p>
</li>
<li>
<p>The <code>timestamp</code> attribute, if present,
signifies the time at which the message was generated by its sender.
This attribute MAY contain the Unix epoch time in nanoseconds.
If the attribute is omitted, it SHOULD be interpreted as timestamp 0.</p>
</li>
<li>
<p>The <code>rate_limit_proof</code> attribute, if present,
contains a rate limit proof encoded as per <a href="waku/standards/core/14//waku/standards/core/17/rln-relay.html">17/WAKU2-RLN-RELAY</a>.</p>
</li>
<li>
<p>The <code>ephemeral</code> attribute, if present, signifies the transient nature of the message.
For example, an ephemeral message SHOULD not be persisted by other nodes on the same network.
If this attribute is set to <code>true</code>, the message SHOULD be interpreted as ephemeral.
If, instead, the attribute is omitted or set to <code>false</code>,
the message SHOULD be interpreted as non-ephemeral.</p>
</li>
</ul>
<h2 id="wire-format-1"><a class="header" href="#wire-format-1">Wire Format</a></h2>
<p>The <code>WakuMessage</code> wire format is specified using <a href="https://developers.google.com/protocol-buffers/">protocol buffers v3</a>.</p>
<pre><code class="language-protobuf">syntax = "proto3";

message WakuMessage {
  bytes payload = 1;
  string content_topic = 2;
  optional uint32 version = 3;
  optional sint64 timestamp = 10;
  optional bytes meta = 11;
  optional bytes rate_limit_proof = 21;
  optional bool ephemeral = 31;
}
</code></pre>
<p>An example proto file following this specification can be found <a href="https://github.com/vacp2p/waku/blob/main/waku/message/v1/message.proto">here (vacp2p/waku)</a>.</p>
<h2 id="payload-encryption"><a class="header" href="#payload-encryption">Payload encryption</a></h2>
<p>The <code>WakuMessage</code> payload MAY be encrypted.
The message <code>version</code> attribute indicates
the schema used to encrypt the payload data.</p>
<ul>
<li>
<p><strong>Version 0:</strong>
The payload SHOULD be interpreted as unencrypted; additionally,
it CAN indicate that the message payload has been encrypted
at the application layer.</p>
</li>
<li>
<p><strong>Version 1:</strong>
The payload SHOULD be encrypted using <a href="waku/standards/core/14//waku/standards/legacy/6/waku1.html">6/WAKU1</a> payload encryption specified in <a href="waku/standards/core/14//waku/standards/application/26/payload.html">26/WAKU-PAYLOAD</a>.
This provides asymmetric and symmetric encryption.
The key agreement is performed out of band.
And provides an encrypted signature and padding for some form of unlinkability.</p>
</li>
<li>
<p><strong>Version 2:</strong>
The payload SHOULD be encoded according to <a href="https://github.com/waku-org/specs/blob/master/standards/application/noise.md">WAKU2-NOISE</a>.
The Waku Noise protocol provides symmetric encryption and asymmetric key exchange.</p>
</li>
</ul>
<p>Any <code>version</code> value not included in this list is reserved for future specification.
And, in this case, the payload SHOULD be interpreted as unencrypted by the Waku layer.</p>
<h2 id="whisper6waku1-envelope-compatibility"><a class="header" href="#whisper6waku1-envelope-compatibility">Whisper/<a href="waku/standards/core/14//waku/standards/legacy/6/waku1.html">6/WAKU1</a> envelope compatibility</a></h2>
<p>Whisper/<a href="waku/standards/core/14//waku/standards/legacy/6/waku1.html">6/WAKU1</a> envelopes are compatible with Waku messages format.</p>
<ul>
<li>Whisper/<a href="waku/standards/core/14//waku/standards/legacy/6/waku1.html">6/WAKU1</a> <code>topic</code> field
SHOULD be mapped to Waku message's <code>content_topic</code> attribute.</li>
<li>Whisper/<a href="waku/standards/core/14//waku/standards/legacy/6/waku1.html">6/WAKU1</a> <code>data</code> field SHOULD be mapped to Waku message's <code>payload</code> attribute.</li>
</ul>
<p><a href="waku/standards/core/14//waku/standards/core/10/waku2.html">10/WAKU2</a> implements a publish/subscribe messaging pattern over libp2p.
This makes some Whisper/<a href="waku/standards/core/14//waku/standards/legacy/6/waku1.html">6/WAKU1</a> envelope fields redundant
(e.g., <code>expiry</code>, <code>ttl</code>, <code>topic</code>, etc.), so they can be ignored.</p>
<h2 id="deterministic-message-hashing"><a class="header" href="#deterministic-message-hashing">Deterministic message hashing</a></h2>
<p>In Protocol Buffers v3,
the deterministic serialization is not canonical across the different implementations
and languages.
It is also unstable across different builds with schema changes due to unknown fields.</p>
<p>To overcome this interoperability limitation,
a <a href="waku/standards/core/14//waku/standards/core/10/waku2.html">10/WAKU2</a> message's hash MUST be computed following this schema:</p>
<pre><code class="language-js">message_hash = sha256(concat(pubsub_topic, message.payload, message.content_topic, message.meta, message.timestamp))
</code></pre>
<p>If an optional attribute, such as <code>meta</code>, is absent,
the concatenation of attributes SHOULD exclude it.
This recommendation is made to ensure that the concatenation process proceeds smoothly
when certain attributes are missing and to maintain backward compatibility.</p>
<p>This hashing schema is deemed appropriate for use cases
where a cross-implementation deterministic hash is needed,
such as message deduplication and integrity validation.
The collision probability offered by this hashing schema can be considered negligible.
This is due to the deterministic concatenation order of the message attributes,
coupled with using a SHA-2 (256-bit) hashing algorithm.</p>
<h3 id="test-vectors"><a class="header" href="#test-vectors">Test vectors</a></h3>
<p>The <code>WakuMessage</code> hash computation (<code>meta</code> size of 12 bytes):</p>
<pre><code class="language-js">pubsub_topic = "/waku/2/default-waku/proto" (0x2f77616b752f322f64656661756c742d77616b752f70726f746f)
message.payload = 0x010203045445535405060708
message.content_topic = "/waku/2/default-content/proto" (0x2f77616b752f322f64656661756c742d636f6e74656e742f70726f746f)
message.meta = 0x73757065722d736563726574
message.timestamp = 0x175789bfa23f8400

message_hash = 0x64cce733fed134e83da02b02c6f689814872b1a0ac97ea56b76095c3c72bfe05
</code></pre>
<p>The <code>WakuMessage</code> hash computation (<code>meta</code> size of 64 bytes):</p>
<pre><code class="language-js">pubsub_topic = "/waku/2/default-waku/proto" (0x2f77616b752f322f64656661756c742d77616b752f70726f746f)
message.payload = 0x010203045445535405060708
message.content_topic = "/waku/2/default-content/proto" (0x2f77616b752f322f64656661756c742d636f6e74656e742f70726f746f)
message.meta = 0x000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f
message.timestamp = 0x175789bfa23f8400

message_hash = 0x7158b6498753313368b9af8f6e0a0a05104f68f972981da42a43bc53fb0c1b27
</code></pre>
<p>The <code>WakuMessage</code> hash computation (<code>meta</code> attribute not present):</p>
<pre><code class="language-js">pubsub_topic = "/waku/2/default-waku/proto" (0x2f77616b752f322f64656661756c742d77616b752f70726f746f)
message.payload = 0x010203045445535405060708
message.content_topic = "/waku/2/default-content/proto" (0x2f77616b752f322f64656661756c742d636f6e74656e742f70726f746f)
message.meta = &lt;not-present&gt;
message.timestamp = 0x175789bfa23f8400

message_hash = 0xa2554498b31f5bcdfcbf7fa58ad1c2d45f0254f3f8110a85588ec3cf10720fd8
</code></pre>
<p>The <code>WakuMessage</code> hash computation (<code>payload</code> length 0):</p>
<pre><code class="language-js">pubsub_topic = "/waku/2/default-waku/proto" (0x2f77616b752f322f64656661756c742d77616b752f70726f746f)
message.payload = []
message.content_topic = "/waku/2/default-content/proto" (0x2f77616b752f322f64656661756c742d636f6e74656e742f70726f746f)
message.meta = 0x73757065722d736563726574
message.timestamp = 0x175789bfa23f8400

message_hash = 0x483ea950cb63f9b9d6926b262bb36194d3f40a0463ce8446228350bd44e96de4
</code></pre>
<h2 id="security-considerations-4"><a class="header" href="#security-considerations-4">Security Considerations</a></h2>
<h3 id="confidentiality-integrity-and-authenticity"><a class="header" href="#confidentiality-integrity-and-authenticity">Confidentiality, integrity, and authenticity</a></h3>
<p>The level of confidentiality, integrity, and
authenticity of the <code>WakuMessage</code> payload is discretionary.
Accordingly, the application layer shall utilize the encryption and
signature schemes supported by <a href="waku/standards/core/14//waku/standards/core/10/waku2.html">10/WAKU2</a>,
to meet the application-specific privacy needs.</p>
<h3 id="reliability-of-the-timestamp-attribute"><a class="header" href="#reliability-of-the-timestamp-attribute">Reliability of the <code>timestamp</code> attribute</a></h3>
<p>The message <code>timestamp</code> attribute is set by the sender.
Therefore, because message timestamps aren’t independently verified,
this attribute is prone to exploitation and misuse.
It should not solely be relied upon for operations such as message ordering.
For example, a malicious actor can arbitrarily set the <code>timestamp</code> of a <code>WakuMessage</code>
to a high value so that it always shows up as the most recent message
in a chat application.
Applications using <a href="waku/standards/core/14//waku/standards/core/10/waku2.html">10/WAKU2</a> messages’ <code>timestamp</code> attribute
are RECOMMENDED to use additional methods for more robust message ordering.
An example of how to deal with message ordering against adversarial message timestamps
can be found in the Status protocol,
see <a href="waku/standards/core/14//status/62/payloads.html">62/STATUS-PAYLOADS</a>.</p>
<h3 id="reliability-of-the-ephemeral-attribute"><a class="header" href="#reliability-of-the-ephemeral-attribute">Reliability of the <code>ephemeral</code> attribute</a></h3>
<p>The message <code>ephemeral</code> attribute is set by the sender.
Since there is currently no incentive mechanism
for network participants to behave correctly,
this attribute is inherently insecure.
A malicious actor can tamper with the value of a Waku message’s <code>ephemeral</code> attribute,
and the receiver would not be able to verify the integrity of the message.</p>
<h2 id="copyright-19"><a class="header" href="#copyright-19">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-17"><a class="header" href="#references-17">References</a></h2>
<ul>
<li><a href="waku/standards/core/14//waku/standards/core/10/waku2.html">10/WAKU2</a></li>
<li><a href="waku/standards/core/14//waku/standards/legacy/6/waku1.html">6/WAKU1</a></li>
<li><a href="waku/standards/core/14//waku/informational/23/topics.html">23/WAKU2-TOPICS</a></li>
<li><a href="waku/standards/core/14//waku/standards/core/17/rln-relay.html">17/WAKU2-RLN-RELAY</a></li>
<li><a href="waku/standards/core/14//waku/standards/core/64/network.html">64/WAKU2-NETWORK</a></li>
<li><a href="https://developers.google.com/protocol-buffers/">protocol buffers v3</a></li>
<li><a href="waku/standards/core/14//waku/standards/application/26/payload.html">26/WAKU-PAYLOAD</a></li>
<li><a href="https://github.com/waku-org/specs/blob/master/standards/application/noise.md">WAKU2-NOISE</a></li>
<li><a href="waku/standards/core/14//status/62/payloads.html">62/STATUS-PAYLOADS</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="15waku-bridge"><a class="header" href="#15waku-bridge">15/WAKU-BRIDGE</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku Bridge</td></tr>
<tr><th>Slug</th><td>15</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Hanno Cornelius &lt;hanno@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-24"><a class="header" href="#timeline-24">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/core/15/bridge.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/core/15/bridge.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-01-28</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/c3d5fe6f882dbda6e01abe17adb864ae522c2f3b/waku/standards/core/15/bridge.md"><code>c3d5fe6</code></a> — 15/WAKU2-BRIDGE: Update (#113)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/core/15/bridge.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d637b10156cbf6cf21f36fc090c267a33d8bafcd/waku/standards/core/15/bridge.md"><code>d637b10</code></a> — Update and rename BRIDGE.md to bridge.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/4bf2f6ece9d077b31e8bd2833b47b0931aed5d4d/waku/standards/core/15/BRIDGE.md"><code>4bf2f6e</code></a> — Rename README.md to BRIDGE.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/standards/core/15/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/f883f26a87230274eb00b960f9a4974a95e466d5/waku/rfcs/standards/core/15/README.md"><code>f883f26</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-16"><a class="header" href="#abstract-16">Abstract</a></h2>
<p>This specification describes how <a href="waku/standards/core/15//waku/standards/legacy/6/waku1.html">6/WAKU1</a>
traffic can be used with <a href="waku/standards/core/15//waku/standards/core/10/waku2.html">10/WAKU2</a> networks.</p>
<h2 id="wire-format-2"><a class="header" href="#wire-format-2">Wire Format</a></h2>
<p>The keywords “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”,
“SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and
“OPTIONAL” in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">2119</a>.</p>
<p>A bridge requires supporting both Waku versions:</p>
<ul>
<li><a href="waku/standards/core/15//waku/standards/legacy/6/waku1.html">6/WAKU1</a> - using devp2p RLPx protocol</li>
<li><a href="waku/standards/core/15//waku/standards/core/10/waku2.html">10/WAKU2</a> - using libp2p protocols</li>
</ul>
<h2 id="publishing-packets"><a class="header" href="#publishing-packets">Publishing Packets</a></h2>
<p>Packets received on <a href="waku/standards/core/15//waku/standards/legacy/6/waku1.html">6/WAKU1</a> networks
SHOULD be published just once on <a href="waku/standards/core/15//waku/standards/core/10/waku2.html">10/WAKU2</a> networks.
More specifically, the bridge SHOULD publish
this through <a href="waku/standards/core/15//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a> (PubSub domain).</p>
<p>When publishing such packet,
the creation of a new <code>Message</code> with a new <code>WakuMessage</code> as data field is REQUIRED.
The <code>data</code> and
<code>topic</code> field, from the <a href="waku/standards/core/15//waku/standards/legacy/6/waku1.html">6/WAKU1</a> <code>Envelope</code>,
MUST be copied to the <code>payload</code> and <code>content_topic</code> fields of the <code>WakuMessage</code>.
See <a href="waku/standards/core/15//waku/standards/core/14/message.html#wire-format">14/WAKU2-MESSAGE</a>
for message format details.
Other fields such as <code>nonce</code>, <code>expiry</code> and
<code>ttl</code> will be dropped as they become obsolete in <a href="waku/standards/core/15//waku/standards/core/10/waku2.html">10/WAKU2</a>.</p>
<p>Before this is done, the usual envelope verification still applies:</p>
<ul>
<li>Expiry &amp; future time verification</li>
<li>PoW verification</li>
<li>Size verification</li>
</ul>
<p>Bridging SHOULD occur through the <a href="waku/standards/core/15//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a>,
but it MAY also be done on other <a href="waku/standards/core/15//waku/standards/core/10/waku2.html">10/WAKU2</a> protocols
(e.g. <a href="waku/standards/core/15//waku/standards/core/12/filter.html">12/WAKU2-FILTER</a>).
The latter is however not advised as it will
increase the complexity of the bridge and
because of the <a href="waku/standards/core/15/bridge.html#security-considerations">Security Considerations</a> explained further below.</p>
<p>Packets received on <a href="waku/standards/core/15//waku/standards/core/10/waku2.html">10/WAKU2</a> networks,
SHOULD be posted just once on <a href="waku/standards/core/15//waku/standards/legacy/6/waku1.html">6/WAKU1</a> networks.
The <a href="waku/standards/core/15//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a> contains only the <code>payload</code> and
<code>contentTopic</code> fields.
The bridge MUST create a new <a href="waku/standards/core/15//waku/standards/legacy/6/waku1.html">6/WAKU1</a> <code>Envelope</code> and
copy over the <code>payload</code> and <code>contentFilter</code>
fields to the <code>data</code> and <code>topic</code> fields.
Next, before posting on the network,
the bridge MUST set a new <code>expiry</code>, <code>ttl</code> and do the PoW <code>nonce</code> calculation.</p>
<h3 id="security-considerations-5"><a class="header" href="#security-considerations-5">Security Considerations</a></h3>
<p>As mentioned above,
a bridge will be posting new <a href="waku/standards/core/15//waku/standards/legacy/6/waku1.html">6/WAKU1</a> envelopes,
which requires doing the PoW <code>nonce</code> calculation.</p>
<p>This could be a DoS attack vector,
as the PoW calculation will make it more expensive to post the message
compared to the original publishing on <a href="waku/standards/core/15//waku/standards/core/10/waku2.html">10/WAKU2</a> networks.
Low PoW setting will lower this problem,
but it is likely that it is still more expensive.</p>
<p>For this reason, it is RECOMMENDED to run bridges independently of other nodes,
so that a bridge that gets overwhelmed does not disrupt regular Waku v2 to v2
traffic.</p>
<p>Bridging functionality SHOULD also be carefully implemented so that messages do
not bounce back and forth between the <a href="waku/standards/core/15//waku/standards/core/10/waku2.html">10/WAKU2</a> and
<a href="waku/standards/core/15//waku/standards/legacy/6/waku1.html">6/WAKU1</a> networks.
The bridge SHOULD properly track messages with a seen filter,
so that no amplification occurs.</p>
<h2 id="copyright-20"><a class="header" href="#copyright-20">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-18"><a class="header" href="#references-18">References</a></h2>
<ul>
<li><a href="waku/standards/core/15//waku/standards/legacy/6/waku1.html">6/WAKU1</a></li>
<li><a href="waku/standards/core/15//waku/standards/core/10/waku2.html">10/WAKU2</a></li>
<li><a href="waku/standards/core/15//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a></li>
<li><a href="waku/standards/core/15//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a></li>
<li><a href="waku/standards/core/15//waku/standards/core/12/filter.html">12/WAKU2-FILTER</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="17waku2-rln-relay"><a class="header" href="#17waku2-rln-relay">17/WAKU2-RLN-RELAY</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v2 RLN Relay</td></tr>
<tr><th>Slug</th><td>17</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Alvaro Revuelta &lt;alvaro@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Oskar Thorén &lt;oskarth@titanproxy.com&gt;<br>Aaryamann Challani &lt;p1ge0nh8er@proton.me&gt;<br>Sanaz Taheri &lt;sanaz@status.im&gt;<br>Hanno Cornelius &lt;hanno@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-25"><a class="header" href="#timeline-25">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/core/17/rln-relay.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/core/17/rln-relay.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-11-20</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/776c1b76cda73aa1feaf5746a4cdb56b6836b4be/waku/standards/core/17/rln-relay.md"><code>776c1b7</code></a> — rfc-index: Update (#110)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/core/17/rln-relay.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-08-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eb25cd06d679e94409072a96841de16a6b3910d5/waku/standards/core/17/rln-relay.md"><code>eb25cd0</code></a> — chore: replace email addresses (#86)</li>
<li><strong>2024-06-06</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/5064ded9982e8540a763afc7f698ead9eb9f9477/waku/standards/core/17/rln-relay.md"><code>5064ded</code></a> — Update 17/WAKU2-RLN-RELAY: Proof Size (#44)</li>
<li><strong>2024-05-28</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/7b443c1aab627894e3f22f5adfbb93f4c4eac4f6/waku/standards/core/17/rln-relay.md"><code>7b443c1</code></a> — 17/WAKU2-RLN-RELAY: Update (#32)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/core/17/rln-relay.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/244ea554800c28ffe6ae2730729aa631863dbbc5/waku/standards/core/17/rln-relay.md"><code>244ea55</code></a> — Update and rename RLN-RELAY.md to rln-relay.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/7bcefaca66451f555555c252a724889bd7d13d3f/waku/standards/core/17/RLN-RELAY.md"><code>7bcefac</code></a> — Rename README.md to RLN-RELAY.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/standards/core/17/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-26</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/1ed5919657475a66ca54cf8e2dc3c27208a5fc1a/waku/rfcs/standards/core/17/README.md"><code>1ed5919</code></a> — Update README.md</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/4b3b4e30803638b48244b8029b7be5bbd3530ee7/waku/rfcs/standards/core/17/README.md"><code>4b3b4e3</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-17"><a class="header" href="#abstract-17">Abstract</a></h2>
<p>This specification describes the <code>17/WAKU2-RLN-RELAY</code> protocol,
which is an extension of <a href="waku/standards/core/17/../11/relay.html"><code>11/WAKU2-RELAY</code></a>
to provide spam protection using <a href="waku/standards/core/17/../../../../vac/32/rln-v1.html">Rate Limiting Nullifiers (RLN)</a>.</p>
<p>The security objective is to contain spam activity in the <a href="waku/standards/core/17/../64/network.html">64/WAKU-NETWORK</a>
by enforcing a global messaging rate to all the peers.
Peers that violate the messaging rate are considered spammers and
their message is considered spam.
Spammers are also financially punished and removed from the system.</p>
<h2 id="motivation-15"><a class="header" href="#motivation-15">Motivation</a></h2>
<p>In open and anonymous p2p messaging networks,
one big problem is spam resistance.
Existing solutions, such as Whisper’s proof of work,
are computationally expensive hence not suitable for resource-limited nodes.
Other reputation-based approaches might not be desirable,
due to issues around arbitrary exclusion and privacy.</p>
<p>We augment the <a href="waku/standards/core/17/../11/relay.html"><code>11/WAKU2-RELAY</code></a> protocol
with a novel construct of <a href="waku/standards/core/17/../../../../vac/32/rln-v1.html">RLN</a>
to enable an efficient economic spam prevention mechanism
that can be run in resource-constrained environments.</p>
<h2 id="specification-2"><a class="header" href="#specification-2">Specification</a></h2>
<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”,
“SHOULD NOT”, “RECOMMENDED”, “MAY”, and
“OPTIONAL” in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">2119</a>.</p>
<h3 id="flow-6"><a class="header" href="#flow-6">Flow</a></h3>
<p>The messaging rate is defined by the <code>period</code>
which indicates how many messages can be sent in a given period.
We define an <code>epoch</code> as $\lceil$ <code>unix_time</code> / <code>period</code> $\rceil$.
For example, if <code>unix_time</code> is <code>1644810116</code> and we set <code>period</code> to <code>30</code>,
then <code>epoch</code> is  $\lceil$ <code>(unix_time/period)</code> $\rceil$ <code>= 54827003</code>.</p>
<blockquote>
<p><strong>NOTE:</strong> The <code>epoch</code> refers to the epoch in RLN and not Unix epoch.
This means a message can only be sent every period,
where the <code>period</code> is up to the application.</p>
</blockquote>
<p>See section <a href="waku/standards/core/17/rln-relay.html#recommended-system-parameters">Recommended System Parameters</a>
for the RECOMMENDED method to set a sensible <code>period</code> value depending on the application.
Peers subscribed to a spam-protected <code>pubsubTopic</code>
are only allowed to send one message per <code>epoch</code>.
The higher-level layers adopting <code>17/WAKU2-RLN-RELAY</code>
MAY choose to enforce the messaging rate for <code>WakuMessages</code>
with a specific <code>contentTopic</code> published on a <code>pubsubTopic</code>.</p>
<h4 id="setup-and-registration"><a class="header" href="#setup-and-registration">Setup and Registration</a></h4>
<p>A <code>pubsubTopic</code> that is spam-protected requires subscribed peers to form a <a href="waku/standards/core/17/../../../../vac/32/rln-v1.html">RLN group</a>.</p>
<ul>
<li>Peers MUST be registered to the RLN group to be able to publish messages.</li>
<li>Registration MAY be moderated through a smart contract
deployed on the Ethereum blockchain.</li>
</ul>
<p>Each peer has an <a href="waku/standards/core/17/../../../../vac/32/rln-v1.html">RLN key pair</a> denoted by <code>sk</code>
and <code>pk</code>.</p>
<ul>
<li>The secret key <code>sk</code> is secret data and MUST be persisted securely by the peer.</li>
<li>The state of the membership contract
SHOULD contain a list of all registered members' public identity keys i.e., <code>pk</code>s.</li>
</ul>
<p>For registration,
a peer MUST create a transaction to invoke the registration function on the contract,
which registers its <code>pk</code> in the RLN group.</p>
<ul>
<li>The transaction MUST transfer additional tokens to the contract to be staked.
This amount is denoted by <code>staked_fund</code> and is a system parameter.
The peer who has the secret key <code>sk</code> associated with a registered <code>pk</code>
would be able to withdraw a portion <code>reward_portion</code>
of the staked fund by providing valid proof.</li>
</ul>
<p><code>reward_portion</code> is also a system parameter.</p>
<blockquote>
<p><strong>NOTE:</strong> Initially <code>sk</code> is only known to its owning peer however,
it may get exposed to other peers in case the owner attempts spamming the system
i.e., sending more than one message per <code>epoch</code>.</p>
</blockquote>
<p>An overview of registration is illustrated in Figure 1.</p>
<p><img src="waku/standards/core/17/./images/rln-relay.png" alt="Figure 1: Registration." /></p>
<h4 id="publishing"><a class="header" href="#publishing">Publishing</a></h4>
<p>To publish at a given <code>epoch</code>, the publishing peer proceeds
based on the regular <a href="waku/standards/core/17/../11/relay.html"><code>11/WAKU2-RELAY</code></a> protocol.
However, to protect against spamming, each <code>WakuMessage</code>
(which is wrapped inside the <code>data</code> field of a PubSub message)
MUST carry a <a href="waku/standards/core/17/rln-relay.html#ratelimitproof"><code>RateLimitProof</code></a> with the following fields.
Section <a href="waku/standards/core/17/rln-relay.html#payloads">Payload</a> covers the details about the type and
encoding of these fields.</p>
<ul>
<li>The <code>merkle_root</code> contains the root of the Merkle tree.</li>
<li>The <code>epoch</code> represents the current epoch.</li>
<li>The <code>nullifier</code> is an internal nullifier acting as a fingerprint
that allows specifying whether two messages are published by the same peer
during the same <code>epoch</code>.</li>
<li>The <code>nullifier</code> is a deterministic value derived from <code>sk</code> and
<code>epoch</code> therefore any two messages issued by the same peer
(i.e., using the same <code>sk</code>)
for the same <code>epoch</code> are guaranteed to have identical <code>nullifier</code>s.</li>
<li>The <code>share_x</code> and
<code>share_y</code> can be seen as partial disclosure of peer's <code>sk</code> for the intended <code>epoch</code>.
They are derived deterministically from peer's <code>sk</code> and
current <code>epoch</code> using <a href="waku/standards/core/17/../../../../vac/32/rln-v1.html">Shamir secret sharing scheme</a>.</li>
</ul>
<p>If a peer discloses more than one such pair (<code>share_x</code>, <code>share_y</code>) for the same <code>epoch</code>,
it would allow full disclosure of its  <code>sk</code> and
hence get access to its staked fund in the membership contract.</p>
<ul>
<li>The <code>proof</code> field is a zero-knowledge proof signifying that:</li>
</ul>
<ol>
<li>The message owner is the current member of the group i.e.,
the peer's identity commitment key, <code>pk</code>,
is part of the membership group Merkle tree with the root <code>merkle_root</code>.</li>
<li><code>share_x</code> and <code>share_y</code> are correctly computed.</li>
<li>The <code>nullifier</code> is constructed correctly.
For more details about the proof generation check <a href="waku/standards/core/17/../../../../vac/32/rln-v1.html">RLN</a>
The proof generation relies on the knowledge of two pieces of private information
i.e., <code>sk</code> and <code>authPath</code>.
The <code>authPath</code> is a subset of Merkle tree nodes
by which a peer can prove the inclusion of its <code>pk</code> in the group.</li>
</ol>
<!-- TODO refer to RLN RFC for authPath def -->
<p>The proof generation also requires a set of public inputs which are:
the Merkle tree root <code>merkle_root</code>, the current <code>epoch</code>, and
the message for which the proof is going to be generated.
In <code>17/WAKU2-RLN-RELAY</code>,
the message is the concatenation of <code>WakuMessage</code>'s  <code>payload</code> filed and
its <code>contentTopic</code> i.e., <code>payload||contentTopic</code>.</p>
<h4 id="group-synchronization"><a class="header" href="#group-synchronization">Group Synchronization</a></h4>
<p>Proof generation relies on the knowledge of Merkle tree root <code>merkle_root</code> and
<code>authPath</code> which both require access to the membership Merkle tree.
Getting access to the Merkle tree can be done in various ways:</p>
<ol>
<li>
<p>Peers construct the tree locally.
This can be done by listening to the registration and
deletion events emitted by the membership contract.
Peers MUST update the local Merkle tree on a per-block basis.
This is discussed further
in the <a href="waku/standards/core/17/rln-relay.html#merkle-root-validation">Merkle Root Validation</a> section.</p>
</li>
<li>
<p>For synchronizing the state of slashed <code>pk</code>s,
disseminate such information through a <code>pubsubTopic</code> to which all peers are subscribed.
A deletion transaction SHOULD occur on the membership contract.
The benefit of an off-chain slashing
is that it allows real-time removal of spammers as opposed to on-chain slashing
in which peers get informed with a delay,
where the delay is due to mining the slashing transaction.</p>
</li>
</ol>
<p>For the group synchronization,
one important security consideration is that peers MUST make sure they always use
the most recent Merkle tree root in their proof generation.
The reason is that using an old root can allow inference
about the index of the user's <code>pk</code> in the membership tree
hence compromising user privacy and breaking message unlinkability.</p>
<h4 id="routing"><a class="header" href="#routing">Routing</a></h4>
<p>Upon the receipt of a PubSub message via <a href="waku/standards/core/17/../11/relay.html"><code>11/WAKU2-RELAY</code></a> protocol,
the routing peer parses the <code>data</code> field as a <code>WakuMessage</code> and
gets access to the <code>RateLimitProof</code> field.<br />
The peer then validates the <code>RateLimitProof</code>  as explained next.</p>
<h5 id="epoch-validation"><a class="header" href="#epoch-validation">Epoch Validation</a></h5>
<p>If the <code>epoch</code> attached to the <code>WakuMessage</code> is more than <code>max_epoch_gap</code>,
apart from the routing peer's current <code>epoch</code>,
then the <code>WakuMessage</code> MUST be discarded and considered invalid.
This is to prevent a newly registered peer from spamming the system
by messaging for all the past epochs.
<code>max_epoch_gap</code> is a system parameter
for which we provide some recommendations in section <a href="waku/standards/core/17/rln-relay.html#recommended-system-parameters">Recommended System Parameters</a>.</p>
<h5 id="merkle-root-validation"><a class="header" href="#merkle-root-validation">Merkle Root Validation</a></h5>
<p>The routing peers MUST check whether the provided Merkle root
in the <code>RateLimitProof</code> is valid.
It can do so by maintaining a local set of valid Merkle roots,
which consist of <code>acceptable_root_window_size</code> past roots.
These roots refer to the final state of the Merkle tree
after a whole block consisting of group changes is processed.
The Merkle roots are updated on a per-block basis instead of a per-event basis.
This is done because if Merkle roots are updated on a per-event basis,
some peers could send messages with a root that refers to a Merkle tree state
that might get invalidated while the message is still propagating in the network,
due to many registrations happening during this time frame.
By updating roots on a per-block basis instead,
we will have only one root update per-block processed,
regardless on how many registrations happened in a block, and
peers will be able to successfully propagate messages in a time frame
corresponding to roughly the size of the roots window times the block mining time.</p>
<p>Atomic processing of the blocks are necessary
so that even if the peer is unable to process one event,
the previous roots remain valid, and can be used to generate valid RateLimitProof's.</p>
<p>This also allows peers which are not well connected to the network
to be able to send messages, accounting for network delay.
This network delay is related to the nature of asynchronous network conditions,
which means that peers see membership changes asynchronously, and
therefore may have differing local Merkle trees.
See <a href="waku/standards/core/17/rln-relay.html#recommended-system-parameters">Recommended System Parameters</a>
on choosing an appropriate <code>acceptable_root_window_size</code>.</p>
<h5 id="proof-verification"><a class="header" href="#proof-verification">Proof Verification</a></h5>
<p>The routing peers MUST check whether the zero-knowledge proof <code>proof</code> is valid.
It does so by running the zk verification algorithm as explained in <a href="waku/standards/core/17/../../../../vac/32/rln-v1.html">RLN</a>.
If <code>proof</code> is invalid then the message MUST be discarded.</p>
<h5 id="spam-detection"><a class="header" href="#spam-detection">Spam detection</a></h5>
<p>To enable local spam detection and slashing,
routing peers MUST record the <code>nullifier</code>, <code>share_x</code>, and <code>share_y</code>
of incoming messages which are not discarded i.e.,
not found spam or with invalid proof or epoch.
To spot spam messages, the peer checks whether a message
with an identical <code>nullifier</code> has already been relayed.</p>
<ol>
<li>If such a message exists and its <code>share_x</code> and <code>share_y</code>
components are different from the incoming message, then slashing takes place.
That is, the peer uses the  <code>share_x</code> and <code>share_y</code>
of the new message and the <code>share'_x</code> and <code>share'_y</code>
of the old record to reconstruct the <code>sk</code> of the message owner.
The <code>sk</code> then MAY be used to delete the spammer from the group and
withdraw a portion <code>reward_portion</code> of its staked funds.</li>
<li>If the <code>share_x</code> and
<code>share_y</code> fields of the previously relayed message are identical
to the incoming message,
then the message is a duplicate and MUST be discarded.</li>
<li>If none is found, then the message gets relayed.</li>
</ol>
<p>An overview of the routing procedure and slashing is provided in Figure 2.</p>
<p><img src="waku/standards/core/17/./images/rln-message-verification.png" alt="Figure 2: Publishing, Routing and Slashing workflow." /></p>
<hr />
<h3 id="payloads-3"><a class="header" href="#payloads-3">Payloads</a></h3>
<p>Payloads are protobuf messages implemented using <a href="https://developers.google.com/protocol-buffers/">protocol buffers v3</a>.
Nodes MAY extend the <a href="waku/standards/core/17/../14/message.html">14/WAKU2-MESSAGE</a>
with a <code>rate_limit_proof</code> field to indicate that their message is not spam.</p>
<pre><code class="language-diff">
syntax = "proto3";

message RateLimitProof {
  bytes proof = 1;
  bytes merkle_root = 2;
  bytes epoch = 3;
  bytes share_x = 4;
  bytes share_y = 5;
  bytes nullifier = 6;
}

message WakuMessage {
  bytes payload = 1;
  string content_topic = 2;
  optional uint32 version = 3;
  optional sint64 timestamp = 10;
  optional bool ephemeral = 31;
  RateLimitProof rate_limit_proof = 21;
}

</code></pre>
<h4 id="wakumessage"><a class="header" href="#wakumessage">WakuMessage</a></h4>
<p><code>rate_limit_proof</code> holds the information required to prove that the message owner
has not exceeded the message rate limit.</p>
<h4 id="ratelimitproof"><a class="header" href="#ratelimitproof">RateLimitProof</a></h4>
<p>Below is the description of the fields of <code>RateLimitProof</code> and their types.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Parameter</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>proof</code></td><td>array of 256 bytes uncompressed or 128 bytes compressed</td><td>the zkSNARK proof as explained in the <a href="waku/standards/core/17/rln-relay.html#publishing">Publishing process</a></td></tr>
<tr><td style="text-align: right"><code>merkle_root</code></td><td>array of 32 bytes in little-endian order</td><td>the root of membership group Merkle tree at the time of publishing the message</td></tr>
<tr><td style="text-align: right"><code>share_x</code> and <code>share_y</code></td><td>array of 32 bytes each</td><td>Shamir secret shares of the user's secret identity key <code>sk</code> . <code>share_x</code> is the Poseidon hash of the <code>WakuMessage</code>'s <code>payload</code> concatenated with its <code>contentTopic</code> . <code>share_y</code> is calculated using <a href="waku/standards/core/17/../../../../vac/32/rln-v1.html">Shamir secret sharing scheme</a></td></tr>
<tr><td style="text-align: right"><code>nullifier</code></td><td>array of 32 bytes</td><td>internal nullifier derived from <code>epoch</code> and peer's <code>sk</code> as explained in <a href="waku/standards/core/17/../../../../vac/32/rln-v1.html">RLN construct</a></td></tr>
</tbody></table>
</div>
<h3 id="recommended-system-parameters"><a class="header" href="#recommended-system-parameters">Recommended System Parameters</a></h3>
<p>The system parameters are summarized in the following table,
and the RECOMMENDED values for a subset of them are presented next.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Parameter</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>period</code></td><td>the length of <code>epoch</code> in seconds</td></tr>
<tr><td style="text-align: right"><code>staked_fund</code></td><td>the amount of funds to be staked by peers at the registration</td></tr>
<tr><td style="text-align: right"><code>reward_portion</code></td><td>the percentage of <code>staked_fund</code> to be rewarded to the slashers</td></tr>
<tr><td style="text-align: right"><code>max_epoch_gap</code></td><td>the maximum allowed gap between the <code>epoch</code> of a routing peer and the incoming message</td></tr>
<tr><td style="text-align: right"><code>acceptable_root_window_size</code></td><td>The maximum number of past Merkle roots to store</td></tr>
</tbody></table>
</div>
<h4 id="epoch-length"><a class="header" href="#epoch-length">Epoch Length</a></h4>
<p>A sensible value for the <code>period</code> depends on the application
for which the spam protection is going to be used.
For example, while the <code>period</code> of <code>1</code> second i.e.,
messaging rate of <code>1</code> per second, might be acceptable for a chat application,
might be too low for communication among Ethereum network validators.
One should look at the desired throughput of the application
to decide on a proper <code>period</code> value.</p>
<h4 id="maximum-epoch-gap"><a class="header" href="#maximum-epoch-gap">Maximum Epoch Gap</a></h4>
<p>We discussed in the <a href="waku/standards/core/17/rln-relay.html#routing">Routing</a> section that the gap between the epoch
observed by the routing peer and
the one attached to the incoming message
should not exceed a threshold denoted by <code>max_epoch_gap</code>.
The value of <code>max_epoch_gap</code> can be measured based on the following factors.</p>
<ul>
<li>Network transmission delay <code>Network_Delay</code>:
the maximum time that it takes for a message to be fully disseminated
in the GossipSub network.</li>
<li>Clock asynchrony <code>Clock_Asynchrony</code>:
The maximum difference between the Unix epoch clocks perceived
by network peers which can be due to clock drifts.</li>
</ul>
<p>With a reasonable approximation of the preceding values,
one can set <code>max_epoch_gap</code> as</p>
<p><code>max_epoch_gap</code>
$= \lceil \frac{\text{Network Delay} + \text{Clock Asynchrony}}{\text{Epoch Length}}\rceil$
where  <code>period</code>  is the length of the <code>epoch</code> in seconds.
<code>Network_Delay</code> and <code>Clock_Asynchrony</code> MUST have the same resolution as  <code>period</code>.
By this formulation, <code>max_epoch_gap</code> indeed measures the maximum number of <code>epoch</code>s
that can elapse since a message gets routed from its origin
to all the other peers in the network.</p>
<p><code>acceptable_root_window_size</code> depends upon the underlying chain's average blocktime,
<code>block_time</code></p>
<p>The lower bound for the <code>acceptable_root_window_size</code> SHOULD be set as $acceptable_root_window_size=(Network_Delay)/block_time$</p>
<p><code>Network_Delay</code> MUST have the same resolution as <code>block_time</code>.</p>
<p>By this formulation,
<code>acceptable_root_window_size</code> will provide a lower bound
of how many roots can be acceptable by a routing peer.</p>
<p>The <code>acceptable_root_window_size</code> should indicate how many blocks may have been mined
during the time it takes for a peer to receive a message.
This formula represents a lower bound of the number of acceptable roots.</p>
<h2 id="copyright-21"><a class="header" href="#copyright-21">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-19"><a class="header" href="#references-19">References</a></h2>
<ol>
<li><a href="waku/standards/core/17/../11/relay.html"><code>11/WAKU2-RELAY</code></a></li>
<li><a href="waku/standards/core/17/../64/network.html">64/WAKU-NETWORK</a></li>
<li><a href="waku/standards/core/17/../../../../vac/32/rln-v1.html">RLN</a></li>
<li><a href="waku/standards/core/17/../14/message.html">14/WAKU2-MESSAGE</a></li>
<li><a href="https://hackmd.io/tMTLMYmTR5eynw2lwK9n1w?view">RLN documentation</a></li>
<li><a href="https://hackmd.io/tMTLMYmTR5eynw2lwK9n1w?view#Public-Inputs">Public inputs to the RLN circuit</a></li>
<li><a href="https://hackmd.io/tMTLMYmTR5eynw2lwK9n1w?view#Linear-Equation-amp-SSS">Shamir secret sharing scheme used in RLN</a></li>
<li><a href="https://hackmd.io/tMTLMYmTR5eynw2lwK9n1w?view#Nullifiers">RLN internal nullifier</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="19waku2-lightpush"><a class="header" href="#19waku2-lightpush">19/WAKU2-LIGHTPUSH</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v2 Light Push</td></tr>
<tr><th>Slug</th><td>19</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Hanno Cornelius &lt;hanno@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Daniel Kaiser &lt;danielkaiser@status.im&gt;<br>Oskar Thorén &lt;oskarth@titanproxy.com&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-26"><a class="header" href="#timeline-26">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/core/19/lightpush.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/core/19/lightpush.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-11-20</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/ff87c84dc71d4f933bab188993914069fea12baa/waku/standards/core/19/lightpush.md"><code>ff87c84</code></a> — Update Waku Links (#104)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/core/19/lightpush.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/core/19/lightpush.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/c88680ab64084b578230f56e20fc21413457852c/waku/standards/core/19/lightpush.md"><code>c88680a</code></a> — Update and rename LIGHTPUSH.md to lightpush.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/f9efd294fa3161f8ccc3e32df68be62413a655d8/waku/standards/core/19/LIGHTPUSH.md"><code>f9efd29</code></a> — Rename README.md to LIGHTPUSH.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/standards/core/19/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/c90013bf2f6ed51ea4c72f1dec30f092c508f676/waku/rfcs/standards/core/19/README.md"><code>c90013b</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<p><strong>Protocol identifier</strong>: <code>/vac/waku/lightpush/2.0.0-beta1</code></p>
<h2 id="motivation-and-goals-1"><a class="header" href="#motivation-and-goals-1">Motivation and Goals</a></h2>
<p>Light nodes with short connection windows and
limited bandwidth wish to publish messages into the Waku network.
Additionally,
there is sometimes a need for confirmation
that a message has been received "by the network"
(here, at least one node).</p>
<p><code>19/WAKU2-LIGHTPUSH</code> is a request/response protocol for this.</p>
<h2 id="payloads-4"><a class="header" href="#payloads-4">Payloads</a></h2>
<pre><code class="language-protobuf">syntax = "proto3";

message PushRequest {
    string pubsub_topic = 1;
    WakuMessage message = 2;
}

message PushResponse {
    bool is_success = 1;
    // Error messages, etc
    string info = 2;
}

message PushRPC {
    string request_id = 1;
    PushRequest request = 2;
    PushResponse response = 3;
}
</code></pre>
<h3 id="message-relaying"><a class="header" href="#message-relaying">Message Relaying</a></h3>
<p>Nodes that respond to <code>PushRequests</code> MUST either
relay the encapsulated message via <a href="waku/standards/core/19/../11/relay.html">11/WAKU2-RELAY</a> protocol
on the specified <code>pubsub_topic</code>,
or forward the <code>PushRequest</code> via 19/LIGHTPUSH on a <a href="https://github.com/waku-org/specs/blob/master/standards/application/dandelion.md">WAKU2-DANDELION</a>
stem.
If they are unable to do so for some reason,
they SHOULD return an error code in <code>PushResponse</code>.</p>
<h2 id="security-considerations-6"><a class="header" href="#security-considerations-6">Security Considerations</a></h2>
<p>Since this can introduce an amplification factor,
it is RECOMMENDED for the node relaying to the rest of the network
to take extra precautions.
This can be done by rate limiting via <a href="waku/standards/core/19/../17/rln-relay.html">17/WAKU2-RLN-RELAY</a>.</p>
<p>Note that the above is currently not fully implemented.</p>
<h2 id="copyright-22"><a class="header" href="#copyright-22">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-20"><a class="header" href="#references-20">References</a></h2>
<ul>
<li><a href="waku/standards/core/19/../11/relay.html">11/WAKU2-RELAY</a></li>
<li><a href="https://github.com/waku-org/specs/blob/master/standards/application/dandelion.md">WAKU2-DANDELION</a></li>
<li><a href="waku/standards/core/19/../17/rln-relay.html">17/WAKU2-RLN-RELAY</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="31waku2-enr"><a class="header" href="#31waku2-enr">31/WAKU2-ENR</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v2 usage of ENR</td></tr>
<tr><th>Slug</th><td>31</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Franck Royer &lt;franck@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-27"><a class="header" href="#timeline-27">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/core/31/enr.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/core/31/enr.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-10-16</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/e4f5f28ea3d44ecf6fde2f59cd1d5e094073ec35/waku/standards/core/31/enr.md"><code>e4f5f28</code></a> — Update WAKU-ENR: Move to Draft (#180)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-18"><a class="header" href="#abstract-18">Abstract</a></h2>
<p>This specification describes the usage of the ENR (Ethereum Node Records)
format for <a href="waku/standards/core/31/../10/waku2.html">10/WAKU2</a> purposes.
The ENR format is defined in <a href="https://eips.ethereum.org/EIPS/eip-778">EIP-778</a> <a href="waku/standards/core/31/enr.html#references">[3]</a>.</p>
<p>This specification is an extension of EIP-778,
ENR used in Waku MUST adhere to both EIP-778 and 31/WAKU2-ENR.</p>
<h2 id="motivation-16"><a class="header" href="#motivation-16">Motivation</a></h2>
<p>EIP-1459 with the usage of ENR has been implemented <a href="waku/standards/core/31/enr.html#references">[1]</a> <a href="waku/standards/core/31/enr.html#references">[2]</a> as a discovery protocol for Waku.</p>
<p>EIP-778 specifies a number of pre-defined keys.
However, the usage of these keys alone does not allow for certain transport capabilities to be encoded,
such as Websocket.
Currently, Waku nodes running in a browser only support websocket transport protocol.
Hence, new ENR keys need to be defined to allow for the encoding of transport protocol other than raw TCP.</p>
<h3 id="usage-of-multiaddr-format-rationale"><a class="header" href="#usage-of-multiaddr-format-rationale">Usage of Multiaddr Format Rationale</a></h3>
<p>One solution would be to define new keys such as <code>ws</code> to encode the websocket port of a node.
However, we expect new transport protocols to be added overtime such as quic.
Hence, this would only provide a short term solution until another specification would need to be added.</p>
<p>Moreover, secure websocket involves SSL certificates.
SSL certificates are only valid for a given domain and ip,
so an ENR containing the following information:</p>
<ul>
<li>secure websocket port</li>
<li>ipv4 fqdn</li>
<li>ipv4 address</li>
<li>ipv6 address</li>
</ul>
<p>Would carry some ambiguity: Is the certificate securing the websocket port valid for the ipv4 fqdn?
the ipv4 address?
the ipv6 address?</p>
<p>The <a href="waku/standards/core/31/../10/waku2.html">10/WAKU2</a> protocol family is built on the <a href="https://github.com/libp2p/specs">libp2p</a> protocol stack.
Hence, it uses <a href="https://github.com/multiformats/multiaddr">multiaddr</a> to format network addresses.</p>
<p>Directly storing one or several multiaddresses in the ENR would fix the issues listed above:</p>
<ul>
<li>multiaddr is self-describing and support addresses for any network protocol:
No new specification would be needed to support encoding other transport protocols in an ENR.</li>
<li>multiaddr contains both the host and port information,
allowing the ambiguity previously described to be resolved.</li>
</ul>
<h2 id="wire-format-3"><a class="header" href="#wire-format-3">Wire Format</a></h2>
<h3 id="multiaddrs-enr-key"><a class="header" href="#multiaddrs-enr-key"><code>multiaddrs</code> ENR key</a></h3>
<p>We define a <code>multiaddrs</code> key.</p>
<ul>
<li>The value MUST be a list of binary encoded multiaddr prefixed by their size.</li>
<li>The size of the multiaddr MUST be encoded in a Big Endian unsigned 16-bit integer.</li>
<li>The size of the multiaddr MUST be encoded in 2 bytes.</li>
<li>The <code>secp256k1</code> value MUST be present on the record;
<code>secp256k1</code> is defined in <a href="https://eips.ethereum.org/EIPS/eip-778">EIP-778</a> and
contains the compressed secp256k1 public key.</li>
<li>The node's peer id SHOULD be deduced from the <code>secp256k1</code> value.</li>
<li>The multiaddresses SHOULD NOT contain a peer id except for circuit relay addresses</li>
<li>For raw TCP &amp; UDP connections details,
<a href="https://eips.ethereum.org/EIPS/eip-778">EIP-778</a> pre-defined keys SHOULD be used;
The keys <code>tcp</code>, <code>udp</code>, <code>ip</code> (and <code>tcp6</code>, <code>udp6</code>, <code>ip6</code> for IPv6)
are enough to convey all necessary information;</li>
<li>To save space, <code>multiaddrs</code> key SHOULD only be used for connection details that cannot be represented using the <a href="https://eips.ethereum.org/EIPS/eip-778">EIP-778</a> pre-defined keys.</li>
<li>The 300 bytes size limit as defined by <a href="https://eips.ethereum.org/EIPS/eip-778">EIP-778</a> still applies;
In practice, it is possible to encode 3 multiaddresses in ENR, more or
less could be encoded depending on the size of each multiaddress.</li>
</ul>
<h3 id="usage-1"><a class="header" href="#usage-1">Usage</a></h3>
<h4 id="many-connection-types"><a class="header" href="#many-connection-types">Many connection types</a></h4>
<p>Alice is a Waku node operator, she runs a node that supports inbound connection for the following protocols:</p>
<ul>
<li>TCP 10101 on <code>1.2.3.4</code></li>
<li>UDP 20202 on <code>1.2.3.4</code></li>
<li>TCP 30303 on <code>1234:5600:101:1::142</code></li>
<li>UDP 40404 on <code>1234:5600:101:1::142</code></li>
<li>Secure Websocket on <code>wss://example.com:443/</code></li>
<li>QUIC on <code>quic://quic.example.com:443/</code></li>
<li>A circuit relay address <code>/ip4/1.2.3.4/tcp/55555/p2p/QmRelay/p2p-circuit/p2p/QmAlice</code></li>
</ul>
<p>Alice SHOULD structure the ENR for her node as follows:</p>
<div class="table-wrapper"><table><thead><tr><th>key</th><th>value</th></tr></thead><tbody>
<tr><td><code>tcp</code></td><td><code>10101</code></td></tr>
<tr><td><code>udp</code></td><td><code>20202</code></td></tr>
<tr><td><code>tcp6</code></td><td><code>30303</code></td></tr>
<tr><td><code>udp6</code></td><td><code>40404</code></td></tr>
<tr><td><code>ip</code></td><td><code>1.2.3.4</code></td></tr>
<tr><td><code>ip6</code></td><td><code>1234:5600:101:1::142</code></td></tr>
<tr><td><code>secp256k1</code></td><td>Alice's compressed secp256k1 public key, 33 bytes</td></tr>
<tr><td><code>multiaddrs</code></td><td><code>len1 | /dns4/example.com/tcp/443/wss | len2 | /dns4/quic.examle.com/tcp/443/quic | len3 | /ip4/1.2.3.4/tcp/55555/p2p/QmRelay</code></td></tr>
</tbody></table>
</div>
<p>Where <code>multiaddrs</code>:</p>
<ul>
<li><code>|</code> is the concatenation operator,</li>
<li><code>len1</code> is the length of <code>/dns4/example.com/tcp/443/wss</code> byte representation,</li>
<li><code>len2</code> is the length of <code>/dns4/quic.examle.com/tcp/443/quic</code> byte representation.</li>
<li><code>len3</code> is the length of <code>/ip4/1.2.3.4/tcp/55555/p2p/QmRelay</code> byte representation.
Notice that the <code>/p2p-circuit</code> component is not stored, but,
since circuit relay addresses are the only one containing a <code>p2p</code> component,
it's safe to assume that any address containing this component is a circuit relay address.
Decoding this type of multiaddresses would require appending the <code>/p2p-circuit</code> component.</li>
</ul>
<h4 id="raw-tcp-only"><a class="header" href="#raw-tcp-only">Raw TCP only</a></h4>
<p>Bob is a node operator that runs a node that supports inbound connection for the following protocols:</p>
<ul>
<li>TCP 10101 on <code>1.2.3.4</code></li>
</ul>
<p>Bob SHOULD structure the ENR for his node as follows:</p>
<div class="table-wrapper"><table><thead><tr><th>key</th><th>value</th></tr></thead><tbody>
<tr><td><code>tcp</code></td><td><code>10101</code></td></tr>
<tr><td><code>ip</code></td><td><code>1.2.3.4</code></td></tr>
<tr><td><code>secp256k1</code></td><td>Bob's compressed secp256k1 public key, 33 bytes</td></tr>
</tbody></table>
</div>
<p>As Bob's node's connection details can be represented with EIP-778's pre-defined keys only,
it is not needed to use the <code>multiaddrs</code> key.</p>
<h3 id="limitations"><a class="header" href="#limitations">Limitations</a></h3>
<p>Supported key type is <code>secp256k1</code> only.</p>
<p>Support for other elliptic curve cryptography such as <code>ed25519</code> MAY be used.</p>
<h3 id="waku2-enr-key"><a class="header" href="#waku2-enr-key"><code>waku2</code> ENR key</a></h3>
<p>We define a <code>waku2</code> field key:</p>
<ul>
<li>The value MUST be an 8-bit flag field,
where bits set to <code>1</code> indicate <code>true</code> and
bits set to <code>0</code> indicate <code>false</code> for the relevant flags.</li>
<li>The flag values already defined are set out below,
with <code>bit 7</code> the most significant bit and <code>bit 0</code> the least significant bit.</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th>bit 7</th><th>bit 6</th><th>bit 5</th><th>bit 4</th><th>bit 3</th><th>bit 2</th><th>bit 1</th><th>bit 0</th></tr></thead><tbody>
<tr><td><code>undef</code></td><td><code>undef</code></td><td><code>undef</code></td><td><code>sync</code></td><td><code>lightpush</code></td><td><code>filter</code></td><td><code>store</code></td><td><code>relay</code></td></tr>
</tbody></table>
</div>
<ul>
<li>In the scheme above, the flags <code>sync</code>, <code>lightpush</code>, <code>filter</code>, <code>store</code> and
<code>relay</code> correlates with support for protocols with the same name.
If a protocol is not supported, the corresponding field MUST be set to <code>false</code>.
Indicating positive support for any specific protocol is OPTIONAL,
though it MAY be required by the relevant application or discovery process.</li>
<li>Flags marked as <code>undef</code> is not yet defined.
These SHOULD be set to <code>false</code> by default.</li>
</ul>
<h3 id="key-usage"><a class="header" href="#key-usage">Key Usage</a></h3>
<ul>
<li>A Waku node MAY choose to populate the <code>waku2</code> field for enhanced discovery capabilities,
such as indicating supported protocols.
Such a node MAY indicate support for any specific protocol by setting the corresponding flag to <code>true</code>.</li>
<li>Waku nodes that want to participate in <a href="https://github.com/vacp2p/rfc-index/blob/main/waku/standards/core/33/discv5.md">Node Discovery Protocol v5</a> <a href="waku/standards/core/31/enr.html#references">[4]</a>, however,
MUST implement the <code>waku2</code> key with at least one flag set to <code>true</code>.</li>
<li>Waku nodes that discovered other participants using Discovery v5,
MUST filter out participant records that do not implement this field or
do not have at least one flag set to <code>true</code>.</li>
<li>In addition, such nodes MAY choose to filter participants on specific flags
(such as supported protocols),
or further interpret the <code>waku2</code> field as required by the application.</li>
</ul>
<h2 id="copyright-23"><a class="header" href="#copyright-23">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-21"><a class="header" href="#references-21">References</a></h2>
<ul>
<li><a href="waku/standards/core/31/../10/waku2.html">1</a></li>
<li><a href="https://github.com/status-im/nim-waku/pull/690">2</a></li>
<li><a href="https://github.com/vacp2p/rfc/issues/462#issuecomment-943869940">3</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-778">4</a></li>
<li><a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5.md">5</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="33waku2-discv5"><a class="header" href="#33waku2-discv5">33/WAKU2-DISCV5</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v2 Discv5 Ambient Peer Discovery</td></tr>
<tr><th>Slug</th><td>33</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Daniel Kaiser &lt;danielkaiser@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-28"><a class="header" href="#timeline-28">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/core/33/discv5.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/core/33/discv5.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/59711664052c15d62589bb7351f87c4a4bcc31a2/waku/standards/core/33/discv5.md"><code>5971166</code></a> — Update discv5.md (#139)</li>
<li><strong>2024-11-20</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/87d4ff74d06e5ca72c79a1ada09083d3347adcca/waku/standards/core/33/discv5.md"><code>87d4ff7</code></a> — Workflow Fix: markdown-lint (#111)</li>
<li><strong>2024-11-20</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/dcc579c47ad5ade76f061ad7ff35cccd5f223653/waku/standards/core/33/discv5.md"><code>dcc579c</code></a> — Update WAKU2-PEER-EXCHANGE: Move to draft (#7)</li>
<li><strong>2024-11-20</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/ff87c84dc71d4f933bab188993914069fea12baa/waku/standards/core/33/discv5.md"><code>ff87c84</code></a> — Update Waku Links (#104)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/core/33/discv5.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/core/33/discv5.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/38d68cef7fd354f95f06da524204c5c84bb0a7ca/waku/standards/core/33/discv5.md"><code>38d68ce</code></a> — Update discv5.md</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b8f8d2052a4dfae298750f374da194e0ed19764e/waku/standards/core/33/discv5.md"><code>b8f8d20</code></a> — Update and rename DISCV5.md to discv5.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/c6ef447cf222867a4ff13b55efd35e6fd5cd0afe/waku/standards/core/33/DISCV5.md"><code>c6ef447</code></a> — Rename README.md to DISCV5.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/standards/core/33/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/037474d1080785b34da3b4a2726c191e010a65d2/waku/rfcs/standards/core/33/README.md"><code>037474d</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-19"><a class="header" href="#abstract-19">Abstract</a></h2>
<p><code>33/WAKU2-DISCV5</code> specifies a modified version of
<a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5.md">Ethereum's Node Discovery Protocol v5</a>
as a means for ambient node discovery.
<a href="waku/standards/core/33//waku/standards/core/10/waku2.html">10/WAKU2</a> uses the <code>33/WAKU2-DISCV5</code> ambient node discovery network
for establishing a decentralized network of interconnected Waku2 nodes.
In its current version,
the <code>33/WAKU2-DISCV5</code> discovery network
is isolated from the Ethereum Discovery v5 network.
Isolation improves discovery efficiency,
which is especially significant with a low number of Waku nodes
compared to the total number of Ethereum nodes.</p>
<h2 id="disclaimer"><a class="header" href="#disclaimer">Disclaimer</a></h2>
<p>This version of <code>33/WAKU2-DISCV5</code> has a focus on timely deployment
of an efficient discovery method for <a href="waku/standards/core/33//waku/standards/core/10/waku2.html">10/WAKU2</a>.
Establishing a separate discovery network is in line with this focus.
However, we are aware of potential resilience problems
(see section on security considerations) and
are <a href="https://forum.vac.dev/t/waku-v2-discv5-roadmap-discussion/121/8">discussing</a>
and researching hybrid approaches.</p>
<h2 id="background-and-rationale"><a class="header" href="#background-and-rationale">Background and Rationale</a></h2>
<p><a href="waku/standards/core/33//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a> assumes the existence of a network of Waku2 nodes.
For establishing and growing this network,
new nodes trying to join the Waku2 network
need a means of discovering nodes within the network.
<a href="waku/standards/core/33//waku/standards/core/10/waku2.html">10/WAKU2</a> supports the following discovery methods
in order of increasing decentralization</p>
<ul>
<li>hard coded bootstrap nodes</li>
<li><a href="waku/standards/core/33//waku/standards/10/waku2.html"><code>DNS discovery</code></a> (based on <a href="https://eips.ethereum.org/EIPS/eip-1459">EIP-1459</a>)</li>
<li><a href="waku/standards/core/33//waku/standards/core/34/peer-exchange.html"><code>34/WAKU2-PEER-EXCHANGE</code></a></li>
<li><code>33/WAKU2-DISCV5</code> (specified in this document)</li>
</ul>
<p>The purpose of ambient node discovery within <a href="waku/standards/core/33//waku/standards/core/10/waku2.html">10/WAKU2</a>
is discovering Waku2 nodes in a decentralized way.
The unique selling point of <code>33/WAKU2-DISCV5</code> is its holistic view of the network,
which allows avoiding hotspots and allows merging the network after a split.
While the other methods provide either a fixed or local set of nodes,
<code>33/WAKU2-DISCV5</code> can provide a random sample of Waku2 nodes.
Future iterations of this document will add the possibility
of efficiently discovering Waku2 nodes that have certain capabilities,
e.g. holding messages of a certain time frame
during which the querying node was offline.</p>
<h3 id="separate-discovery-network"><a class="header" href="#separate-discovery-network">Separate Discovery Network</a></h3>
<h4 id="wrt-waku2-relay-network"><a class="header" href="#wrt-waku2-relay-network">w.r.t. Waku2 Relay Network</a></h4>
<p><code>33/WAKU2-DISCV5</code> spans an overlay network separate from the
<a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/README.md">GossipSub</a>
network <a href="waku/standards/core/33//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a> builds on.
Because it is a P2P network on its own, it also depends on bootstrap nodes.
Having a separate discovery network reduces load on the bootstrap nodes,
because the actual work is done by randomly discovered nodes.
This also increases decentralization.</p>
<h4 id="wrt-ethereum-discovery-v5"><a class="header" href="#wrt-ethereum-discovery-v5">w.r.t. Ethereum Discovery v5</a></h4>
<p><code>33/WAKU2-DISCV5</code> spans a discovery network
isolated from the Ethereum Discovery v5 network.</p>
<p>Another simple solution would be taking part in the Ethereum Discovery network,
and filtering Waku nodes based on whether they support <a href="https://github.com/waku-org/specs/blob/master/standards/core/enr.md">WAKU2-ENR</a>.
This solution is more resilient towards eclipse attacks.
However, this discovery method is very inefficient
for small percentages of Waku nodes
(see <a href="https://forum.vac.dev/t/waku-v2-discv5-roadmap-discussion/121/8">estimation</a>).
It boils down to random walk discovery and does not offer a O(log(n)) hop bound.
The rarer the requested property (in this case Waku),
the longer a random walk will take until finding an appropriate node,
which leads to a needle-in-the-haystack problem.
Using a dedicated Waku2 discovery network,
nodes can query this discovery network for a random set of nodes
and all (well-behaving)
returned nodes can serve as bootstrap nodes for other Waku2 protocols.</p>
<p>A more sophisticated solution would be using <a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5-theory.md#topic-advertisement">Discv5 topic discovery</a>.
However, in its current state it also has efficiency problems for small percentages
of Waku nodes and is still in the design phase
(<a href="https://github.com/ethereum/devp2p/issues/199">see here</a>).</p>
<p>Currently,
the Ethereum discv5 network is very efficient in finding other discv5 nodes,
but it is not so efficient for finding discv5 nodes
that have a specific property or
offer specific services, e.g. Waku.</p>
<p>As part of our <a href="https://forum.vac.dev/t/waku-v2-discv5-roadmap-discussion/121">discv5 roadmap</a>,
we consider two ideas for future versions of <code>33/WAKU2-DISCV5</code></p>
<ul>
<li><a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5-theory.md#topic-advertisement">Discv5 topic discovery</a>
with adjustments (ideally upstream)</li>
<li>a hybrid solution that uses both a separate discv5 network and
a Waku-ENR-filtered Ethereum discv5 network</li>
</ul>
<h2 id="semantics-2"><a class="header" href="#semantics-2">Semantics</a></h2>
<p><code>33/WAKU2-DISCV5</code> fully inherits the <a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5-theory.md">discv5 semantics</a>.</p>
<p>Before announcing their address via Waku2 discv5,
nodes SHOULD check if this address is publicly reachable.
Nodes MAY use the <a href="https://github.com/libp2p/specs/blob/master/autonat/README.md">libp2p AutoNAT protocol</a>
to perform that check.
Nodes SHOULD only announce publicly reachable addresses via Waku2 discv5,
to avoid cluttering peer lists with nodes that are not reachable.</p>
<h2 id="wire-format-specification-2"><a class="header" href="#wire-format-specification-2">Wire Format Specification</a></h2>
<p><code>33/WAKU2-DISCV5</code> inherits the <a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5-wire.md">discv5 wire protocol</a>
except for the following differences</p>
<h2 id="waku2-specific-protocol-id"><a class="header" href="#waku2-specific-protocol-id">WAKU2-Specific <code>protocol-id</code></a></h2>
<p>Ethereum discv5:</p>
<pre><code class="language-text">header        = static-header || authdata
static-header = protocol-id || version || flag || nonce || authdata-size
protocol-id   = &lt;b&gt;"discv5"&lt;/b&gt;
version       = 0x0001
authdata-size = uint16    -- byte length of authdata
flag          = uint8     -- packet type identifier
nonce         = uint96    -- nonce of message

</code></pre>
<p><code>33/WAKU2-DISCV5</code>:</p>
<pre><code class="language-text">kcode&gt;
header        = static-header || authdata
static-header = protocol-id || version || flag || nonce || authdata-size
protocol-id   = &lt;b&gt;"d5waku"&lt;/b&gt;
version       = 0x0001
authdata-size = uint16    -- byte length of authdata
flag          = uint8     -- packet type identifier
nonce         = uint96    -- nonce of message

</code></pre>
<h2 id="suggestions-for-implementations"><a class="header" href="#suggestions-for-implementations">Suggestions for Implementations</a></h2>
<p>Existing discv5 implementations</p>
<ul>
<li>can be augmented to make the <code>protocol-id</code> selectable using a compile-time flag
as in <a href="https://github.com/kaiserd/nim-eth/blob/add-selectable-protocol-id-static/eth/p2p/discoveryv5/encoding.nim#L34">this feature branch</a>
of nim-eth/discv5.</li>
<li>can be forked followed by changing the <code>protocol-id</code> string as in <a href="https://github.com/status-im/go-waku/blob/master/waku/v2/discv5/discover.go#L135-L137">go-waku</a>.</li>
</ul>
<h2 id="security-considerations-7"><a class="header" href="#security-considerations-7">Security Considerations</a></h2>
<h3 id="sybil-attack"><a class="header" href="#sybil-attack">Sybil attack</a></h3>
<p>Implementations should limit the number of bucket entries
that have the same network parameters (IP address / port) to mitigate Sybil attacks.</p>
<h3 id="eclipse-attack"><a class="header" href="#eclipse-attack">Eclipse attack</a></h3>
<p>Eclipse attacks aim to eclipse certain regions in a DHT.
Malicious nodes provide false routing information for certain target regions.
The larger the desired eclipsed region,
the more resources (i.e. controlled nodes) the attacker needs.
This introduces an efficiency versus resilience tradeoff.
Discovery is more efficient if information about target objects
(e.g. network parameters of nodes supporting Waku) are closer to a specific DHT address.
If nodes providing specific information are closer to each other,
they cover a smaller range in the DHT and are easier to eclipse.</p>
<p>Sybil attacks greatly increase the power of eclipse attacks,
because they significantly reduce resources necessary
to mount a successful eclipse attack.</p>
<h2 id="security-implications-of-a-separate-discovery-network"><a class="header" href="#security-implications-of-a-separate-discovery-network">Security Implications of a Separate Discovery Network</a></h2>
<p>A dedicated Waku discovery network is more likely to be subject
to successful eclipse attacks (and to DoS attacks in general).
This is because eclipsing in a smaller network requires less resources for the attacker.
DoS attacks render the whole network unusable
if the percentage of attacker nodes is sufficient.</p>
<p>Using random walk discovery would mitigate eclipse attacks
targeted at specific capabilities, e.g. Waku.
However, this is because eclipse attacks aim at the DHT overlay structure,
which is not used by random walks.
So, this mitigation would come at the cost of giving up overlay routing efficiency.
The efficiency loss is especially severe with a relatively small number of Waku nodes.</p>
<p>Properly protecting against eclipse attacks is challenging and
raises research questions that we will address in future stages of our discv5 roadmap.</p>
<h2 id="references-22"><a class="header" href="#references-22">References</a></h2>
<ol>
<li><a href="waku/standards/core/33//waku/standards/core/10/waku2.html">10/WAKU2</a></li>
<li><a href="waku/standards/core/33//waku/standards/core/34/peer-exchange.html"><code>34/WAKU2-PEER-EXCHANGE</code></a></li>
<li><a href="waku/standards/core/33//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a></li>
<li><a href="https://github.com/waku-org/specs/blob/master/standards/core/enr.md">WAKU2-ENR</a></li>
<li><a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5.md">Node Discovery Protocol v5 (<code>discv5</code>)</a></li>
<li><a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5-theory.md"><code>discv5</code> semantics</a>.</li>
<li><a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5-wire.md"><code>discv5</code> wire protocol</a></li>
<li><a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5-theory.md#topic-advertisement"><code>discv5</code> topic discovery</a></li>
<li><a href="https://github.com/libp2p/specs/blob/master/autonat/README.md">libp2p AutoNAT protocol</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-1459"><code>EIP-1459</code></a></li>
<li><a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/README.md"><code>GossipSub</code></a></li>
<li><a href="https://forum.vac.dev/t/waku-v2-discv5-roadmap-discussion/121">Waku discv5 roadmap discussion</a></li>
<li><a href="https://forum.vac.dev/t/waku-v2-discv5-roadmap-discussion/121/8">discovery efficiency estimation</a></li>
<li><a href="https://github.com/kaiserd/nim-eth/blob/add-selectable-protocol-id-static/eth/p2p/discoveryv5/encoding.nim">implementation: Nim</a></li>
<li><a href="https://github.com/status-im/go-waku/blob/master/waku/v2/discv5/discover.go">implementation: Go</a></li>
</ol>
<h2 id="copyright-24"><a class="header" href="#copyright-24">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="34waku2-peer-exchange"><a class="header" href="#34waku2-peer-exchange">34/WAKU2-PEER-EXCHANGE</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku2 Peer Exchange</td></tr>
<tr><th>Slug</th><td>34</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Hanno Cornelius &lt;hanno@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Daniel Kaiser &lt;danielkaiser@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-29"><a class="header" href="#timeline-29">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/core/34/peer-exchange.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/core/34/peer-exchange.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-12-07</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2b297d597fc3ad0af145c3d53204432867709ea8/waku/standards/core/34/peer-exchange.md"><code>2b297d5</code></a> — Update peer-exchange.md to fix a build error (#114)</li>
<li><strong>2024-11-20</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/87d4ff74d06e5ca72c79a1ada09083d3347adcca/waku/standards/core/34/peer-exchange.md"><code>87d4ff7</code></a> — Workflow Fix: markdown-lint (#111)</li>
<li><strong>2024-11-20</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/dcc579c47ad5ade76f061ad7ff35cccd5f223653/waku/standards/core/34/peer-exchange.md"><code>dcc579c</code></a> — Update WAKU2-PEER-EXCHANGE: Move to draft (#7)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-20"><a class="header" href="#abstract-20">Abstract</a></h2>
<p>This document specifies a simple request-response peer exchange protocol.
Responders send information about a requested number of peers.
The main purpose of this protocol is providing resource restricted devices with peers.</p>
<p><em><strong>Protocol Identifier</strong></em></p>
<blockquote>
<p>/vac/waku/peer-exchange/2.0.0-alpha1</p>
</blockquote>
<h2 id="background-and-motivation"><a class="header" href="#background-and-motivation">Background and Motivation</a></h2>
<p>It may not be feasible, on resource restricted devices,
to take part in distributed random sampling ambient peer discovery protocols,
such as <a href="waku/standards/core/34//waku/standards/core/33/discv5.html">33/WAKU2-DISCV5</a>.
The Waku peer discovery protocol, specified in this document,
allows resource restricted devices to request a list of peers from a service node.
Network parameters necessary to connect to this service node COULD be learned
from a static bootstrapping method or
using <a href="https://eips.ethereum.org/EIPS/eip-1459">EIP-1459: Node Discovery via DNS</a>.
The advantage of using Waku peer exchange to discover new peers,
compared to relying on a static peer list or DNS discovery, is a more even load distribution.
If a lot of resource restricted nodes would use the same service nodes as relay
or store nodes, the load on these would be very high.
Heavily used static nodes also add a centralized element.
Downtime of such a node might significantly impact the network.</p>
<p>However, the resource efficiency of this protocol comes at an anonymity cost,
which is explained in the
<a href="waku/standards/core/34/peer-exchange.html#security-considerations">Security/Privacy Considerations</a> section.
This protocol SHOULD only be used if <a href="waku/standards/core/34//waku/standards/core/33/discv5.html">33/WAKU2-DISCV5</a> is infeasible.</p>
<h2 id="theory-and-protocol-semantics"><a class="header" href="#theory-and-protocol-semantics">Theory and Protocol Semantics</a></h2>
<p>The keywords “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”,
“SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and
“OPTIONAL” in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">2119</a>.</p>
<p>The peer exchange protocol, specified in this document,
is a simple request-response protocol.
As Figure 1 illustrates, the requesting node sends a request to a peer,
which acts as the responder.
The responder replies with a list of ENRs as specified in <a href="https://github.com/waku-org/specs/blob/master/standards/core/enr.md">WAKU2-ENR</a>.
The <a href="https://docs.libp2p.io/concepts/addressing/">multiaddresses</a>
used to connect to the respective peers can be extracted from the ENRs.</p>
<p><img src="waku/standards/core/34/./images/protocol.svg" alt="Figure 1: The responder provides a list of ENRs to the requester. These ENRs contain the information necessary for connecting to the respective peers." /></p>
<p>In order to protect its anonymity,
the responder MUST NOT provide peers from its actively used peer list
as this opens pathways to <em>Neighbourhood Surveillance</em> attacks, as described in the
<a href="waku/standards/core/34/peer-exchange.html#security-considerations">Security/Privacy Considerations Section</a>.
The responder SHOULD provide a set of peers
that has been retrieved using ambient peer discovery methods supporting random sampling,
e.g. <a href="waku/standards/core/34//waku/standards/core/33/discv5.html">33/WAKU2-DISCV5</a>.
This both protects the responder's anonymity as well as helps distributing load.</p>
<p>To allow for fast responses, responders SHOULD retrieve peers unsolicited
(before receiving a query) and
maintain a queue of peers for the purpose of providing them in peer exchange responses.
To get the best anonymity properties with respect to response peer sets,
responders SHOULD use each of these peers only once.</p>
<p>To save bandwidth, and as a trade off to anonymity,
responders MAY maintain a larger cache of exchange peers and
randomly sample response sets from this local cache.
The size of the cache SHOULD be large enough to allow randomly sampling peer sets
that (on average) do not overlap too much.
The responder SHOULD periodically replace the oldest peers in the cache.
The RECOMMENDED options for the cache size are described in the
<a href="waku/standards/core/34/peer-exchange.html#implementation-suggestions">Implementation Suggestions Section</a>.</p>
<p>Requesters, in the context of the specified peer exchange protocol,
SHOULD be resource restricted devices.
While any node could technically act as a requester,
using the peer exchange protocol comes with two drawbacks:</p>
<ul>
<li>reducing <a href="waku/standards/core/34/peer-exchange.html#security-considerations">anonymity</a></li>
<li>causing load on responder nodes</li>
</ul>
<h2 id="wire-format-specification-3"><a class="header" href="#wire-format-specification-3">Wire Format Specification</a></h2>
<pre><code class="language-protobuf">syntax = "proto3";

message PeerInfo {
  bytes enr = 1;
}

message PeerExchangeQuery {
  uint64 num_peers = 1;
}

message PeerExchangeResponse {
  repeated PeerInfo peer_infos = 1;
}

message PeerExchangeRPC {
  PeerExchangeQuery query = 1;
  PeerExchangeResponse response = 2;
}

</code></pre>
<p>The <code>enr</code> field contains a Waku ENR as specified in <a href="https://github.com/waku-org/specs/blob/master/standards/core/enr.md">WAKU2-ENR</a>.</p>
<p>Requesters send a <code>PeerExchangeQuery</code> to a peer.
Responders SHOULD include a maximum of <code>num_peers</code> <code>PeerInfo</code> instances into a response.
Responders send a <code>PeerExchangeResponse</code> to requesters
containing a list of <code>PeerInfo</code> instances, which in turn hold an ENR.</p>
<h2 id="implementation-suggestions-1"><a class="header" href="#implementation-suggestions-1">Implementation Suggestions</a></h2>
<h3 id="discovery-interface"><a class="header" href="#discovery-interface">Discovery Interface</a></h3>
<p>Implementations can implement the libp2p discovery interface:</p>
<ul>
<li><a href="https://github.com/status-im/nim-libp2p/issues/140">nim</a></li>
<li><a href="https://github.com/libp2p/js-libp2p-interfaces/tree/master/packages/interface-peer-discovery">javascript</a>.</li>
</ul>
<h3 id="exchange-peer-cache-size"><a class="header" href="#exchange-peer-cache-size">Exchange Peer Cache Size</a></h3>
<p>The size of the (optional) exchange peer cache discussed in
<a href="waku/standards/core/34/peer-exchange.html#theory-and-protocol-semantics">Theory and Protocol Semantics</a>
depends on the average number of requested peers,
which is expected to be the outbound degree of the underlying
<a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md">libp2p gossipsub</a>
mesh network.
The RECOMMENDED value for this outbound degree is 6 (see parameter <code>D</code> in <a href="waku/standards/core/34//waku/informational/29/config.html">29/WAKU2-CONFIG</a>).
It is RECOMMENDED for the cache to hold at least 10 times as many peers (60).</p>
<p>The RECCOMENDED cache size also depends on the number of requesters a responder
is expected to serve within a <em>refresh cycle</em>.
A refresh cycle is the time interval in which all peers in the cache
are expected to be replaced.
If the number of requests expected per refresh cycle exceeds 600
(10 times the above recommended 60),
it is RECOMMENDED to increase the cache size to at least a tenth of that number.</p>
<h2 id="security-considerations-8"><a class="header" href="#security-considerations-8">Security Considerations</a></h2>
<h3 id="privacy-and-anonymity"><a class="header" href="#privacy-and-anonymity">Privacy and Anonymity</a></h3>
<p>The peer exchange protocol specified in this document comes with anonymity and
security implications.
We differentiate these implications into the requester and responder side, respectively.</p>
<h3 id="requester"><a class="header" href="#requester">Requester</a></h3>
<p>With a simple peer exchange protocol,
the requester is inherently susceptible to both <em>neighbourhood surveillance</em> and
<em>controlled neighbourhood</em> attacks.</p>
<p>To mount a <em>neighbourhood surveillance</em> attack,
an attacker has to connect to the peers of the victim node.
The peer exchange protocol allows a malicious responder to easily get into this position.
The responder connects to a set of peers and
simply returns this set of peers to the requester.</p>
<p>The peer exchange protocol also makes it much easier to get into the position
required for the <em>controlled neighbourhood</em> attack:
A malicious responder provides controlled peers in the response peer list.</p>
<p>More on these attacks may be found in our <a href="https://vac.dev/wakuv2-relay-anon">research log article</a>.</p>
<p>As a weak mitigation the requester MAY ask several peers and
select a subset of the returned peers.</p>
<h3 id="responder"><a class="header" href="#responder">Responder</a></h3>
<p>Responders that answer with active mesh peers are more vulnerable
to a <em>neighbourhood surveillance</em> attack.
Responding with the set of active mesh peers allows a malicious requester to
get into the required position more easily.
It takes away the first hurdle of the <em>neighbourhood surveillance</em> attack:
The attacker knows which peers to try to connect to.
This increased vulnerability can be avoided by only responding
with randomly sampled sets of peers,
e.g. by requesting a random peer set via <a href="waku/standards/core/34//waku/standards/core/33/discv5.html">33/WAKU2-DISCV5</a>.
(As stated in the <a href="waku/standards/core/34/peer-exchange.html#theory-and-protocol-semantics">Theory and Protocol Semantics Section</a>,
these peer sets SHOULD be retrieved unsolicitedly before
receiving requests to achieve faster response times.)</p>
<p>Responders are also susceptible to amplification DoS attacks.
Requesters send a simple message request which causes responders to
engage in ambient peer discovery to retrieve a new random peer set.
As a mitigation, responders MAY feature a <code>seen cache</code> for requests and
only answer once per time interval.
The exchange-peer cache discussed in <a href="waku/standards/core/34/peer-exchange.html#theory-and-protocol-semantics">Theory and Protocol Semantics Section</a>
also provides mitigation.
Still, frequent queries can tigger the refresh cycle more often.
The <code>seen cache</code> MAY be used in conjunction to provide additional mitigation.</p>
<h3 id="further-considerations"><a class="header" href="#further-considerations">Further Considerations</a></h3>
<p>The response field contains ENRs as specified in <a href="https://github.com/waku-org/specs/blob/master/standards/core/enr.md">WAKU2-ENR</a>.
While ENRs contain signatures, they do not violate the <a href="waku/standards/core/34//waku/standards/core/11/relay.html#signature-policy">Waku relay no-sign policy</a>,
because they are part of the discovery domain and
are not propagated in the relay domain.
However, there might still be some form of leakage:
ENRs could be used to track peers and facilitate linking attacks.
We will investigate this further in our Waku anonymity analysis.</p>
<h2 id="copyright-25"><a class="header" href="#copyright-25">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-23"><a class="header" href="#references-23">References</a></h2>
<ul>
<li><a href="waku/standards/core/34//waku/standards/core/33/discv5.html">33/WAKU2-DISCV5</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-1459">EIP-1459: Node Discovery via DNS</a></li>
<li><a href="https://github.com/waku-org/specs/blob/master/standards/core/enr.md">WAKU2-ENR</a></li>
<li><a href="https://docs.libp2p.io/concepts/addressing/">multiaddress</a></li>
<li><a href="https://github.com/status-im/nim-libp2p/issues/140">libp2p discovery interface in nim</a></li>
<li><a href="https://github.com/libp2p/js-libp2p-interfaces/tree/master/packages/interface-peer-discovery">libp2p discovery interface in javascript</a></li>
<li><a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md">libp2p gossipsub</a></li>
<li><a href="waku/standards/core/34//waku/informational/29/config.html">29/WAKU2-CONFIG</a></li>
<li><a href="https://vac.dev/wakuv2-relay-anon">Waku Relay Anonymity</a></li>
<li><a href="waku/standards/core/34//waku/standards/core/11/relay.html#signature-policy">Waku relay no-sign policy</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="36waku2-bindings-api"><a class="header" href="#36waku2-bindings-api">36/WAKU2-BINDINGS-API</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v2 C Bindings API</td></tr>
<tr><th>Slug</th><td>36</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Richard Ramos &lt;richard@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Franck Royer &lt;franck@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-30"><a class="header" href="#timeline-30">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/core/36/bindings-api.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/core/36/bindings-api.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/core/36/bindings-api.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/core/36/bindings-api.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-28</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/cb561034229ddac7205169ac9f68bb6bfbb3fda4/waku/standards/core/36/bindings-api.md"><code>cb56103</code></a> — Update bindings-api.md</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/e9469d0a5a16be00420ec0ae20e30ac2fb092181/waku/standards/core/36/bindings-api.md"><code>e9469d0</code></a> — Update and rename BINDINGS-API.md to bindings-api.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/76e514a3843edc2daf54dc9855c96d2c3c780687/waku/standards/core/36/BINDINGS-API.md"><code>76e514a</code></a> — Rename README.md to BINDINGS-API.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/standards/core/36/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/6bd686d9436b69e0134cc0312e6b6830051455c0/waku/rfcs/standards/core/36/README.md"><code>6bd686d</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<h2 id="introduction-2"><a class="header" href="#introduction-2">Introduction</a></h2>
<p>Native applications that wish to integrate Waku may not be able to use nwaku and
its JSON RPC API due to constraints
on packaging, performance or executables.</p>
<p>An alternative is to link existing Waku implementation as a static or
dynamic library in their application.</p>
<p>This specification describes the C API that SHOULD be implemented
by native Waku library and that SHOULD be used to consume them.</p>
<h2 id="design-requirements-1"><a class="header" href="#design-requirements-1">Design requirements</a></h2>
<p>The API should be generic enough, so:</p>
<ul>
<li>it can be implemented by both nwaku and go-waku C-Bindings,</li>
<li>it can be consumed from a variety of languages such as C#, Kotlin, Swift,
Rust, C++, etc.</li>
</ul>
<p>The selected format to pass data to and from the API is <code>JSON</code>.</p>
<p>It has been selected due to its widespread usage and
easiness of use. Other alternatives MAY replace it in the future (C
structure, protobuf) if it brings limitations that need to be lifted.</p>
<h2 id="the-api"><a class="header" href="#the-api">The API</a></h2>
<h3 id="general"><a class="header" href="#general">General</a></h3>
<h4 id="wakucallback-type"><a class="header" href="#wakucallback-type"><code>WakuCallBack</code> type</a></h4>
<p>All the API functions require passing callbacks
which will be executed depending on the result of the execution result.
These callbacks are defined as</p>
<pre><code class="language-c">typedef void (*WakuCallBack) (const char* msg, size_t len_0);
</code></pre>
<p>With <code>msg</code> containing a <code>\0</code> terminated string, and <code>len_0</code> the length of this string.
The format of the data sent to these callbacks
will depend on the function being executed.
The data can be characters, numeric or json.</p>
<h3 id="status-codes"><a class="header" href="#status-codes">Status Codes</a></h3>
<p>The API functions return an integer with status codes
depending on the execution result.
The following status codes are defined:</p>
<ul>
<li><code>0</code> - Success</li>
<li><code>1</code> - Error</li>
<li><code>2</code> - Missing callback</li>
</ul>
<h3 id="jsonmessage-type"><a class="header" href="#jsonmessage-type"><code>JsonMessage</code> type</a></h3>
<p>A Waku Message in JSON Format:</p>
<pre><code class="language-ts">{
    payload: string;
    contentTopic: string;
    version: number;
    timestamp: number;
}
</code></pre>
<p>Fields:</p>
<ul>
<li><code>payload</code>: base64 encoded payload,
<a href="waku/standards/core/36//"><code>waku_utils_base64_encode</code></a>
can be used for this.</li>
<li><code>contentTopic</code>: The content topic to be set on the message.</li>
<li><code>version</code>: The Waku Message version number.</li>
<li><code>timestamp</code>: Unix timestamp in nanoseconds.</li>
</ul>
<h3 id="decodedpayload-type"><a class="header" href="#decodedpayload-type"><code>DecodedPayload</code> type</a></h3>
<p>A payload once decoded, used when a received Waku Message is encrypted:</p>
<pre><code class="language-ts">interface DecodedPayload {
    pubkey?: string;
    signature?: string;
    data: string;
    padding: string;
  }
</code></pre>
<p>Fields:</p>
<ul>
<li><code>pubkey</code>: Public key that signed the message (optional),
hex encoded with <code>0x</code> prefix,</li>
<li><code>signature</code>: Message signature (optional), hex encoded with <code>0x</code> prefix,</li>
<li><code>data</code>: Decrypted message payload base64 encoded,</li>
<li><code>padding</code>: Padding base64 encoded.</li>
</ul>
<h3 id="filtersubscription-type"><a class="header" href="#filtersubscription-type"><code>FilterSubscription</code> type</a></h3>
<p>The criteria to create subscription to a light node in JSON Format:</p>
<pre><code class="language-ts">{
    contentFilters: ContentFilter[];
    pubsubTopic: string?;
}
</code></pre>
<p>Fields:</p>
<ul>
<li><code>contentFilters</code>: Array of <a href="waku/standards/core/36/bindings-api.html#contentfilter-type"><code>ContentFilter</code></a>
being subscribed to / unsubscribed from.</li>
<li><code>topic</code>: Optional pubsub topic.</li>
</ul>
<h3 id="contentfilter-type"><a class="header" href="#contentfilter-type"><code>ContentFilter</code> type</a></h3>
<pre><code class="language-ts">{
    contentTopic: string;
}
</code></pre>
<p>Fields:</p>
<ul>
<li><code>contentTopic</code>: The content topic of a Waku message.</li>
</ul>
<h3 id="storequery-type"><a class="header" href="#storequery-type"><code>StoreQuery</code> type</a></h3>
<p>Criteria used to retrieve historical messages</p>
<pre><code class="language-ts">interface StoreQuery {
    pubsubTopic?: string;
    contentFilters?: ContentFilter[];
    startTime?: number;
    endTime?: number;
    pagingOptions?: PagingOptions
  }
</code></pre>
<p>Fields:</p>
<ul>
<li><code>pubsubTopic</code>: The pubsub topic on which messages are published.</li>
<li><code>contentFilters</code>:
Array of <a href="waku/standards/core/36/bindings-api.html#contentfilter-type"><code>ContentFilter</code></a> to query for historical messages,</li>
<li><code>startTime</code>: The inclusive lower bound on the timestamp of queried messages.
This field holds the Unix epoch time in nanoseconds.</li>
<li><code>endTime</code>: The inclusive upper bound on the timestamp of queried messages.
This field holds the Unix epoch time in nanoseconds.</li>
<li><code>pagingOptions</code>: Paging information in <a href="waku/standards/core/36/bindings-api.html#pagingoptions-type"><code>PagingOptions</code></a> format.</li>
</ul>
<h3 id="storeresponse-type"><a class="header" href="#storeresponse-type"><code>StoreResponse</code> type</a></h3>
<p>The response received after doing a query to a store node:</p>
<pre><code class="language-ts">interface StoreResponse {
    messages: JsonMessage[];
    pagingOptions?: PagingOptions;
  }
</code></pre>
<p>Fields:</p>
<ul>
<li><code>messages</code>: Array of retrieved historical messages
in <a href="waku/standards/core/36/bindings-api.html#jsonmessage-type"><code>JsonMessage</code></a> format.</li>
<li><code>pagingOption</code>: Paging information in <a href="waku/standards/core/36/bindings-api.html#pagingoptions-type"><code>PagingOptions</code></a> format
from which to resume further historical queries</li>
</ul>
<h3 id="pagingoptions-type"><a class="header" href="#pagingoptions-type"><code>PagingOptions</code> type</a></h3>
<pre><code class="language-ts">interface PagingOptions {
    pageSize: number;
    cursor?: Index;
    forward: bool;
  }
</code></pre>
<p>Fields:</p>
<ul>
<li><code>pageSize</code>: Number of messages to retrieve per page.</li>
<li><code>cursor</code>: Message Index from which to perform pagination.
If not included and forward is set to true,
paging will be performed from the beginning of the list.
If not included and forward is set to false,
paging will be performed from the end of the list.</li>
<li><code>forward</code>:  <code>true</code> if paging forward, <code>false</code> if paging backward</li>
</ul>
<h3 id="index-type"><a class="header" href="#index-type"><code>Index</code> type</a></h3>
<pre><code class="language-ts">interface Index {
    digest: string;
    receiverTime: number;
    senderTime: number;
    pubsubTopic: string;
  }
</code></pre>
<p>Fields:</p>
<ul>
<li><code>digest</code>: Hash of the message at this <a href="waku/standards/core/36/bindings-api.html#index-type"><code>Index</code></a>.</li>
<li><code>receiverTime</code>: UNIX timestamp in nanoseconds
at which the message at this <a href="waku/standards/core/36/bindings-api.html#index-type"><code>Index</code></a> was received.</li>
<li><code>senderTime</code>: UNIX timestamp in nanoseconds at which the message is generated
by its sender.</li>
<li><code>pubsubTopic</code>: The pubsub topic of the message at this <a href="waku/standards/core/36/bindings-api.html#index-type"><code>Index</code></a>.</li>
</ul>
<h2 id="events"><a class="header" href="#events">Events</a></h2>
<p>Asynchronous events require a callback to be registered.
An example of an asynchronous event that might be emitted is receiving a message.
When an event is emitted,
this callback will be triggered receiving a JSON string of type <code>JsonSignal</code>.</p>
<h3 id="jsonsignal-type"><a class="header" href="#jsonsignal-type"><code>JsonSignal</code> type</a></h3>
<pre><code class="language-ts">{
    type: string;
    event: any;
}
</code></pre>
<p>Fields:</p>
<ul>
<li><code>type</code>: Type of signal being emitted. Currently, only <code>message</code> is available.</li>
<li><code>event</code>: Format depends on the type of signal.</li>
</ul>
<p>For example:</p>
<pre><code class="language-json">{
  "type": "message",
  "event": {
    "pubsubTopic": "/waku/2/default-waku/proto",
    "messageId": "0x6496491e40dbe0b6c3a2198c2426b16301688a2daebc4f57ad7706115eac3ad1",
    "wakuMessage": {
      "payload": "TODO",
      "contentTopic": "/my-app/1/notification/proto",
      "version": 1,
      "timestamp": 1647826358000000000
    }
  }
}
</code></pre>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left"><code>type</code></th><th><code>event</code> Type</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>message</code></td><td><code>JsonMessageEvent</code></td></tr>
</tbody></table>
</div>
<h3 id="jsonmessageevent-type"><a class="header" href="#jsonmessageevent-type"><code>JsonMessageEvent</code> type</a></h3>
<p>Type of <code>event</code> field for a <code>message</code> event:</p>
<pre><code class="language-ts">{
    pubsubTopic: string;
    messageId: string;
    wakuMessage: JsonMessage;
}
</code></pre>
<ul>
<li><code>pubsubTopic</code>: The pubsub topic on which the message was received.</li>
<li><code>messageId</code>: The message id.</li>
<li><code>wakuMessage</code>: The message in <a href="waku/standards/core/36/bindings-api.html#jsonmessage-type"><code>JsonMessage</code></a> format.</li>
</ul>
<h3 id="waku_set_event_callback"><a class="header" href="#waku_set_event_callback">waku_set_event_callback</a></h3>
<pre><code class="language-c">extern void waku_set_event_callback(WakuCallBack cb){}
</code></pre>
<p>Register callback to act as event handler and receive application signals,
which are used to react to asynchronous events in Waku.</p>
<p>Parameters</p>
<ol>
<li><code>WakuCallBack cb</code>: callback that will be executed when an async event is emitted.</li>
</ol>
<h2 id="node-management"><a class="header" href="#node-management">Node management</a></h2>
<h3 id="jsonconfig-type"><a class="header" href="#jsonconfig-type"><code>JsonConfig</code> type</a></h3>
<p>Type holding a node configuration:</p>
<pre><code class="language-ts">interface JsonConfig {
    host?: string;
    port?: number;
    advertiseAddr?: string;
    nodeKey?: string;
    keepAliveInterval?: number;
    relay?: boolean;
    relayTopics?: Array&lt;string&gt;;
    gossipsubParameters?: GossipSubParameters;
    minPeersToPublish?: number
    legacyFilter?: boolean;
    discV5?: boolean;
    discV5BootstrapNodes?: Array&lt;string&gt;;
    discV5UDPPort?: number;
    store?: boolean;
    databaseURL?: string;
    storeRetentionMaxMessages?: number;
    storeRetentionTimeSeconds?: number;
    websocket?: Websocket;
    dns4DomainName?: string;
}
</code></pre>
<p>Fields:</p>
<p>All fields are optional.
If a key is <code>undefined</code>, or <code>null</code>, a default value will be set.</p>
<ul>
<li><code>host</code>: Listening IP address.
Default <code>0.0.0.0</code>.</li>
<li><code>port</code>: Libp2p TCP listening port.
Default <code>60000</code>.
Use <code>0</code> for random.</li>
<li><code>advertiseAddr</code>: External address to advertise to other nodes.
Can be ip4, ip6 or dns4, dns6.
If <code>null</code>, the multiaddress(es) generated from the ip and
port specified in the config (or default ones) will be used.
Default: <code>null</code>.</li>
<li><code>nodeKey</code>: Secp256k1 private key in Hex format (<code>0x123...abc</code>).
Default random.</li>
<li><code>keepAliveInterval</code>:
Interval in seconds for pinging peers to keep the connection alive.
Default <code>20</code>.</li>
<li><code>relay</code>: Enable relay protocol.
Default <code>true</code>.</li>
<li><code>relayTopics</code>:
Array of pubsub topics that WakuRelay will automatically subscribe to
when the node starts
Default <code>[]</code></li>
<li><code>gossipSubParameters</code>: custom gossipsub parameters.
See <code>GossipSubParameters</code> section for defaults</li>
<li><code>minPeersToPublish</code>: The minimum number of peers required on a topic
to allow broadcasting a message.
Default <code>0</code>.</li>
<li><code>legacyFilter</code>: Enable Legacy Filter protocol.
Default <code>false</code>.</li>
<li><code>discV5</code>: Enable DiscoveryV5.
Default <code>false</code></li>
<li><code>discV5BootstrapNodes</code>: Array of bootstrap nodes ENR</li>
<li><code>discV5UDPPort</code>: UDP port for DiscoveryV5
Default <code>9000</code></li>
<li><code>store</code>: Enable store protocol to persist message history
Default <code>false</code></li>
<li><code>databaseURL</code>: url connection string. Accepts SQLite and
PostgreSQL connection strings
Default: <code>sqlite3://store.db</code></li>
<li><code>storeRetentionMaxMessages</code>: max number of messages to store in the database.
Default <code>10000</code></li>
<li><code>storeRetentionTimeSeconds</code>: max number of seconds that a message will be persisted
in the database.
Default <code>2592000</code> (30d)</li>
<li><code>websocket</code>: custom websocket support parameters. See <code>Websocket</code> section for defaults</li>
<li><code>dns4DomainName</code>: the domain name resolving to the node's public IPv4 address.</li>
</ul>
<p>For example:</p>
<pre><code class="language-json">{
  "host": "0.0.0.0",
  "port": 60000,
  "advertiseAddr": "1.2.3.4",
  "nodeKey": "0x123...567",
  "keepAliveInterval": 20,
  "relay": true,
  "minPeersToPublish": 0
}
</code></pre>
<h3 id="gossipsubparameters-type"><a class="header" href="#gossipsubparameters-type"><code>GossipsubParameters</code> type</a></h3>
<p>Type holding custom gossipsub configuration:</p>
<pre><code class="language-ts">interface GossipSubParameters {
    D?: number;
    D_low?: number;
    D_high?: number;
    D_score?: number;
    D_out?: number;
    HistoryLength?: number;
    HistoryGossip?: number;
    D_lazy?: number;
    GossipFactor?: number;
    GossipRetransmission?: number;
    HeartbeatInitialDelayMs?: number;
    HeartbeatIntervalSeconds?: number;
    SlowHeartbeatWarning?: number;
    FanoutTTLSeconds?: number;
    PrunePeers?: number;
    PruneBackoffSeconds?: number;
    UnsubscribeBackoffSeconds?: number;
    Connectors?: number;
    MaxPendingConnections?: number;
    ConnectionTimeoutSeconds?: number;
    DirectConnectTicks?: number;
    DirectConnectInitialDelaySeconds?: number;
    OpportunisticGraftTicks?: number;
    OpportunisticGraftPeers?: number;
    GraftFloodThresholdSeconds?: number;
    MaxIHaveLength?: number;
    MaxIHaveMessages?: number;
    IWantFollowupTimeSeconds?: number;
}
</code></pre>
<p>Fields:</p>
<p>All fields are optional.
If a key is <code>undefined</code>, or <code>null</code>, a default value will be set.</p>
<ul>
<li><code>d</code>: optimal degree for a GossipSub topic mesh.
Default <code>6</code></li>
<li><code>dLow</code>: lower bound on the number of peers we keep in a GossipSub topic mesh
Default <code>5</code></li>
<li><code>dHigh</code>: upper bound on the number of peers we keep in a GossipSub topic mesh.
Default <code>12</code></li>
<li><code>dScore</code>: affects how peers are selected when pruning a mesh due to over subscription.
Default <code>4</code></li>
<li><code>dOut</code>: sets the quota for the number of outbound connections
to maintain in a topic mesh.
Default <code>2</code></li>
<li><code>historyLength</code>: controls the size of the message cache used for gossip.
Default <code>5</code></li>
<li><code>historyGossip</code>: controls how many cached message ids
we will advertise in IHAVE gossip messages.
Default <code>3</code></li>
<li><code>dLazy</code>: affects how many peers we will emit gossip to at each heartbeat.
Default <code>6</code></li>
<li><code>gossipFactor</code>: affects how many peers we will emit gossip to at each heartbeat.
Default <code>0.25</code></li>
<li><code>gossipRetransmission</code>:
controls how many times we will allow a peer to request the same message id
through IWANT gossip before we start ignoring them.
Default <code>3</code></li>
<li><code>heartbeatInitialDelayMs</code>: short delay in milliseconds before
the heartbeat timer begins after the router is initialized.
Default <code>100</code> milliseconds</li>
<li><code>heartbeatIntervalSeconds</code>: controls the time between heartbeats.
Default <code>1</code> second</li>
<li><code>slowHeartbeatWarning</code>: duration threshold for heartbeat processing before
emitting a warning.
Default <code>0.1</code></li>
<li><code>fanoutTTLSeconds</code>: controls how long we keep track of the fanout state.
Default <code>60</code> seconds</li>
<li><code>prunePeers</code>: controls the number of peers to include in prune Peer eXchange.
Default <code>16</code></li>
<li><code>pruneBackoffSeconds</code>: controls the backoff time for pruned peers.
Default <code>60</code> seconds</li>
<li><code>unsubscribeBackoffSeconds</code>: controls the backoff time to use when unsuscribing
from a topic.
Default <code>10</code> seconds</li>
<li><code>connectors</code>: number of active connection attempts for peers obtained through PX.
Default <code>8</code></li>
<li><code>maxPendingConnections</code>: maximum number of pending connections
for peers attempted through px.
Default <code>128</code></li>
<li><code>connectionTimeoutSeconds</code>: timeout in seconds for connection attempts.
Default <code>30</code> seconds</li>
<li><code>directConnectTicks</code>: the number of heartbeat ticks
for attempting to reconnect direct peers that are not currently connected.
Default <code>300</code></li>
<li><code>directConnectInitialDelaySeconds</code>: initial delay before opening connections to
direct peers.
Default <code>1</code> second</li>
<li><code>opportunisticGraftTicks</code>: number of heartbeat ticks for attempting to
improve the mesh with opportunistic grafting.
Default <code>60</code></li>
<li><code>opportunisticGraftPeers</code>: the number of peers to opportunistically graft.
Default <code>2</code></li>
<li><code>graftFloodThresholdSeconds</code>: If a GRAFT comes before GraftFloodThresholdSeconds
has elapsed since the last PRUNE,
then there is an extra score penalty applied to the peer through P7.
Default <code>10</code> seconds</li>
<li><code>maxIHaveLength</code>: max number of messages to include in an IHAVE message,
also controls the max number of IHAVE ids we will accept and
request with IWANT from a peer within a heartbeat.
Default <code>5000</code></li>
<li><code>maxIHaveMessages</code>: max number of IHAVE messages to accept from a peer
within a heartbeat.
Default <code>10</code></li>
<li><code>iWantFollowupTimeSeconds</code>: Time to wait for a message requested
through IWANT following an IHAVE advertisement.
Default <code>3</code> seconds</li>
<li><code>seenMessagesTTLSeconds</code>: configures when a previously seen message ID
can be forgotten about.
Default <code>120</code> seconds</li>
</ul>
<h3 id="websocket-type"><a class="header" href="#websocket-type"><code>Websocket</code> type</a></h3>
<p>Type holding custom websocket support configuration:</p>
<pre><code class="language-ts">interface Websocket {
    enabled?: bool;
    host?: string;
    port?: number;
    secure?: bool;
    certPath?: string;
    keyPath?: string;
}
</code></pre>
<p>Fields:</p>
<p>All fields are optional.
If a key is <code>undefined</code>, or <code>null</code>, a default value will be set.
If using <code>secure</code> websockets support, <code>certPath</code> and
<code>keyPath</code> become mandatory attributes.
Unless selfsigned certificates are used,
it will probably make sense in the <code>JsonConfiguration</code>
to specify the domain name used in the certificate in the <code>dns4DomainName</code> attribute.</p>
<ul>
<li><code>enabled</code>:  indicates if websockets support will be enabled
Default <code>false</code></li>
<li><code>host</code>: listening address for websocket connections
Default <code>0.0.0.0</code></li>
<li><code>port</code>: TCP listening port for websocket connection
(<code>0</code> for random, binding to <code>443</code> requires root access)
Default <code>60001</code>, if secure websockets support is enabled, the default is <code>6443“</code></li>
<li><code>secure</code>: enable secure websockets support
Default <code>false</code></li>
<li><code>certPath</code>: secure websocket certificate path</li>
<li><code>keyPath</code>: secure websocket key path</li>
</ul>
<h3 id="waku_new"><a class="header" href="#waku_new">waku_new</a></h3>
<pre><code class="language-c">extern int waku_new(char* jsonConfig, WakuCallBack onErrCb){}
</code></pre>
<p>Instantiates a Waku node.</p>
<p>Parameters</p>
<ol>
<li><code>char* jsonConfig</code>:
JSON string containing the options used to initialize a waku node.
Type <a href="waku/standards/core/36/bindings-api.html#jsonconfig-type"><code>JsonConfig</code></a>.
It can be <code>NULL</code> to use defaults.</li>
<li><code>WakuCallBack onErrCb</code>: <a href="waku/standards/core/36/bindings-api.html#wakucallback-type"><code>WakuCallBack</code></a>.
Callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onErrCb</code> callback</li>
</ul>
<h3 id="waku_start"><a class="header" href="#waku_start">waku_start</a></h3>
<pre><code class="language-c">extern int waku_start(WakuCallBack onErrCb){}
</code></pre>
<p>Starts a Waku node mounting all the protocols that were enabled
during the Waku node instantiation.</p>
<p>Parameters</p>
<ol>
<li><code>WakuCallBack onErrCb</code>:
callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onErrCb</code> callback</li>
</ul>
<h3 id="waku_stop"><a class="header" href="#waku_stop">waku_stop</a></h3>
<pre><code class="language-c">extern int waku_stop(WakuCallBack onErrCb){}
</code></pre>
<p>Stops a Waku node.</p>
<p>Parameters</p>
<ol>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onErrCb</code> callback</li>
</ul>
<h3 id="waku_peerid"><a class="header" href="#waku_peerid">waku_peerid</a></h3>
<pre><code class="language-c">extern int waku_peerid(WakuCallBack onOkCb, WakuCallBack onErrCb){}
</code></pre>
<p>Get the peer ID of the waku node.</p>
<p>Parameters</p>
<ol>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will receive the base58 encoded peer ID,
for example <code>QmWjHKUrXDHPCwoWXpUZ77E8o6UbAoTTZwf1AD1tDC4KNP</code></li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<h3 id="waku_listen_addresses"><a class="header" href="#waku_listen_addresses">waku_listen_addresses</a></h3>
<pre><code class="language-c">extern int waku_listen_addresses(WakuCallBack onOkCb, WakuCallBack onErrCb){}
</code></pre>
<p>Get the multiaddresses the Waku node is listening to.</p>
<p>Parameters</p>
<ol>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will receive a json array of multiaddresses.
The multiaddresses are <code>string</code>s. For example:</li>
</ul>
<pre><code class="language-json">[
    "/ip4/127.0.0.1/tcp/30303",
    "/ip4/1.2.3.4/tcp/30303",
    "/dns4/waku.node.example/tcp/8000/wss"
]
</code></pre>
<ul>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> and <code>onErrCb</code> callback</li>
</ul>
<h2 id="connecting-to-peers"><a class="header" href="#connecting-to-peers">Connecting to peers</a></h2>
<h3 id="waku_add_peer"><a class="header" href="#waku_add_peer">waku_add_peer</a></h3>
<pre><code class="language-c">extern int waku_add_peer(char* address, char* protocolId, WakuCallBack onOkCb, WakuCallBack onErrCb){}
</code></pre>
<p>Add a node multiaddress and protocol to the waku node's peerstore.</p>
<p>Parameters</p>
<ol>
<li><code>char* address</code>: A multiaddress (with peer id) to reach the peer being added.</li>
<li><code>char* protocolId</code>: A protocol we expect the peer to support.</li>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code>  will receive the base 58 peer ID of the peer that was added.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<h3 id="waku_connect"><a class="header" href="#waku_connect">waku_connect</a></h3>
<pre><code class="language-c">extern int waku_connect(char* address, int timeoutMs, WakuCallBack onErrCb){}
</code></pre>
<p>Dial peer using a multiaddress.</p>
<p>Parameters</p>
<ol>
<li><code>char* address</code>: A multiaddress to reach the peer being dialed.</li>
<li><code>int timeoutMs</code>: Timeout value in milliseconds to execute the call.
If the function execution takes longer than this value,
the execution will be canceled and an error returned.
Use <code>0</code> for no timeout.</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onErrCb</code> callback</li>
</ul>
<h3 id="waku_connect_peerid"><a class="header" href="#waku_connect_peerid">waku_connect_peerid</a></h3>
<pre><code class="language-c">extern int waku_connect_peerid(char* peerId, int timeoutMs, WakuCallBack onErrCb){}
</code></pre>
<p>Dial peer using its peer ID.</p>
<p>Parameters</p>
<ol>
<li><code>char* peerID</code>: Peer ID to dial.
The peer must be already known.
It must have been added before with <a href="waku/standards/core/36/bindings-api.html#waku_add_peer"><code>waku_add_peer</code></a>
or previously dialed with <a href="waku/standards/core/36/bindings-api.html#waku_add_peer"><code>waku_connect</code></a>.</li>
<li><code>int timeoutMs</code>: Timeout value in milliseconds to execute the call.
If the function execution takes longer than this value,
the execution will be canceled and an error returned.
Use <code>0</code> for no timeout.</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onErrCb</code> callback</li>
</ul>
<h3 id="waku_disconnect"><a class="header" href="#waku_disconnect">waku_disconnect</a></h3>
<pre><code class="language-c">extern int waku_disconnect(char* peerId, WakuCallBack onErrCb){}
</code></pre>
<p>Disconnect a peer using its peerID</p>
<p>Parameters</p>
<ol>
<li><code>char* peerID</code>: Peer ID to disconnect.</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onErrCb</code> callback</li>
</ul>
<h3 id="waku_peer_cnt"><a class="header" href="#waku_peer_cnt">waku_peer_cnt</a></h3>
<pre><code class="language-c">extern int waku_peer_cnt(WakuCallBack onOkCb, WakuCallBack onErrCb){}
</code></pre>
<p>Get number of connected peers.</p>
<p>Parameters</p>
<ol>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will receive the number of connected peers.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<h3 id="waku_peers"><a class="header" href="#waku_peers">waku_peers</a></h3>
<pre><code class="language-c">extern int waku_peers(WakuCallBack onOkCb, WakuCallBack onErrCb){}
</code></pre>
<p>Retrieve the list of peers known by the Waku node.</p>
<p>Parameters</p>
<ol>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will receive a json array with the list of peers.
This list has this format:</li>
</ul>
<pre><code class="language-json">[
  {
    "peerID": "16Uiu2HAmJb2e28qLXxT5kZxVUUoJt72EMzNGXB47RedcBafeDCBA",
    "protocols": [
      "/ipfs/id/1.0.0",
      "/vac/waku/relay/2.0.0",
      "/ipfs/ping/1.0.0"
    ],
    "addrs": [
      "/ip4/1.2.3.4/tcp/30303"
    ],
    "connected": true
  }
]
</code></pre>
<ul>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<h2 id="waku-relay"><a class="header" href="#waku-relay">Waku Relay</a></h2>
<h3 id="waku_content_topic"><a class="header" href="#waku_content_topic">waku_content_topic</a></h3>
<pre><code class="language-c">extern int waku_content_topic(char* applicationName, unsigned int applicationVersion, char* contentTopicName, char* encoding, WakuCallBack onOkCb){}
</code></pre>
<p>Create a content topic string according to <a href="waku/standards/core/36/../../../informational/23/topics.html">RFC 23</a>.</p>
<p>Parameters</p>
<ol>
<li><code>char* applicationName</code></li>
<li><code>unsigned int applicationVersion</code></li>
<li><code>char* contentTopicName</code></li>
<li><code>char* encoding</code>: depending on the payload, use <code>proto</code>, <code>rlp</code> or <code>rfc26</code></li>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will receive the content topic formatted according to <a href="waku/standards/core/36/../../../informational/23/topics.html">RFC 23</a>:
<code>/{application-name}/{version-of-the-application}/{content-topic-name}/{encoding}</code></li>
<li>1 - The operation failed for any reason.</li>
<li>2 - The function is missing the <code>onOkCb</code> callback</li>
</ul>
<h3 id="waku_pubsub_topic"><a class="header" href="#waku_pubsub_topic">waku_pubsub_topic</a></h3>
<pre><code class="language-c">extern int waku_pubsub_topic(char* name, char* encoding, WakuCallBack onOkCb){}
</code></pre>
<p>Create a pubsub topic string according to <a href="waku/standards/core/36/../../../informational/23/topics.html">RFC 23</a>.</p>
<p>Parameters</p>
<ol>
<li><code>char* name</code></li>
<li><code>char* encoding</code>: depending on the payload, use <code>proto</code>, <code>rlp</code> or <code>rfc26</code></li>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will get populated with a pubsub topic formatted according to <a href="waku/standards/core/36/../../../informational/23/topics.html">RFC 23</a>:
<code>/waku/2/{topic-name}/{encoding}</code></li>
<li>1 - The operation failed for any reason.</li>
<li>2 - The function is missing the <code>onOkCb</code> callback</li>
</ul>
<h3 id="waku_default_pubsub_topic"><a class="header" href="#waku_default_pubsub_topic">waku_default_pubsub_topic</a></h3>
<pre><code class="language-c">extern int waku_default_pubsub_topic(WakuCallBack onOkCb){}
</code></pre>
<p>Returns the default pubsub topic used for exchanging waku messages
defined in <a href="waku/standards/core/36/../10/waku2.html">RFC 10</a>.</p>
<p>Parameters</p>
<ol>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will get populated with  <code>/waku/2/default-waku/proto</code></li>
<li>1 - The operation failed for any reason.</li>
<li>2 - The function is missing the <code>onOkCb</code> callback</li>
</ul>
<h3 id="waku_relay_publish"><a class="header" href="#waku_relay_publish">waku_relay_publish</a></h3>
<pre><code class="language-c">extern int waku_relay_publish(char* messageJson, char* pubsubTopic, int timeoutMs, WakuCallBack onOkCb, WakuCallBack onErrCb){}
</code></pre>
<p>Publish a message using Waku Relay.</p>
<p>Parameters</p>
<ol>
<li><code>char* messageJson</code>:
JSON string containing the <a href="waku/standards/core/36/../14/message.html">Waku Message</a>
as <a href="waku/standards/core/36/bindings-api.html#jsonmessage-type"><code>JsonMessage</code></a>.</li>
<li><code>char* pubsubTopic</code>: pubsub topic on which to publish the message.
If <code>NULL</code>, it uses the default pubsub topic.</li>
<li><code>int timeoutMs</code>: Timeout value in milliseconds to execute the call.
If the function execution takes longer than this value,
the execution will be canceled and an error returned.
Use <code>0</code> for no timeout.</li>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>If the execution is successful, the <code>result</code> field contains the message ID.</p>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will get populated with the message ID</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<h3 id="waku_relay_enough_peers"><a class="header" href="#waku_relay_enough_peers">waku_relay_enough_peers</a></h3>
<pre><code class="language-c">extern int waku_relay_enough_peers(char* pubsubTopic, WakuCallBack onOkCb, WakuCallBack onErrCb){}
</code></pre>
<p>Determine if there are enough peers to publish a message on a given pubsub topic.</p>
<p>Parameters</p>
<ol>
<li><code>char* pubsubTopic</code>: Pubsub topic to verify.
If <code>NULL</code>, it verifies the number of peers in the default pubsub topic.</li>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will receive a string <code>boolean</code> indicating whether there are enough peers,
i.e. <code>true</code> or <code>false</code></li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<h3 id="waku_relay_subscribe"><a class="header" href="#waku_relay_subscribe">waku_relay_subscribe</a></h3>
<pre><code class="language-c">extern int waku_relay_subscribe(char* topic, WakuCallBack onErrCb){}
</code></pre>
<p>Subscribe to a Waku Relay pubsub topic to receive messages.</p>
<p>Parameters</p>
<ol>
<li><code>char* topic</code>: Pubsub topic to subscribe to.
If <code>NULL</code>, it subscribes to the default pubsub topic.</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onErrCb</code> callback</li>
</ul>
<p>Events</p>
<p>When a message is received,
a <code>"message"</code> event is emitted containing the message, pubsub topic,
and node ID in which
the message was received.</p>
<p>The <code>event</code> type is <a href="waku/standards/core/36/bindings-api.html#jsonmessageevent-type"><code>JsonMessageEvent</code></a>.</p>
<p>For Example:</p>
<pre><code class="language-json">{
  "type": "message",
  "event": {
    "pubsubTopic": "/waku/2/default-waku/proto",
    "messageId": "0x6496491e40dbe0b6c3a2198c2426b16301688a2daebc4f57ad7706115eac3ad1",
    "wakuMessage": {
      "payload": "TODO",
      "contentTopic": "/my-app/1/notification/proto",
      "version": 1,
      "timestamp": 1647826358000000000
    }
  }
}
</code></pre>
<h3 id="waku_relay_unsubscribe"><a class="header" href="#waku_relay_unsubscribe">waku_relay_unsubscribe</a></h3>
<pre><code class="language-c">extern int waku_relay_unsubscribe(char* topic, WakuCallBack onErrCb)
</code></pre>
<p>Closes the pubsub subscription to a pubsub topic. No more messages will be received
from this pubsub topic.</p>
<p>Parameters</p>
<ol>
<li><code>char* pusubTopic</code>: Pubsub topic to unsubscribe from.
If <code>NULL</code>, unsubscribes from the default pubsub topic.</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.</li>
<li>1 - The operation failed for any reason.</li>
<li>2 - The function is missing the <code>onErrCb</code> callback</li>
</ul>
<h3 id="waku_relay_topics"><a class="header" href="#waku_relay_topics">waku_relay_topics</a></h3>
<pre><code class="language-c">extern int waku_relay_topics(WakuCallBack onOkCb, WakuCallBack onErrCb)
</code></pre>
<p>Get the list of subscribed pubsub topics in Waku Relay.</p>
<p>Parameters</p>
<ol>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will receive a json array of pubsub topics
i.e <code>["pubsubTopic1", "pubsubTopic2"]</code></li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<h2 id="waku-filter"><a class="header" href="#waku-filter">Waku Filter</a></h2>
<h3 id="waku_filter_subscribe"><a class="header" href="#waku_filter_subscribe">waku_filter_subscribe</a></h3>
<pre><code class="language-c">extern int waku_filter_subscribe(char* filterJSON, char* peerID, int timeoutMs, WakuCallBack onOkCb, WakuCallBack onErrCb)
</code></pre>
<p>Creates a subscription to a filter full node matching a content filter..</p>
<p>Parameters</p>
<ol>
<li><code>char* filterJSON</code>:
JSON string containing the <a href="waku/standards/core/36/bindings-api.html#filtersubscription-type"><code>FilterSubscription</code></a>
to subscribe to.</li>
<li><code>char* peerID</code>: Peer ID to subscribe to.
The peer must be already known.
It must have been added before with <a href="waku/standards/core/36/bindings-api.html#waku_add_peer"><code>waku_add_peer</code></a>
or previously dialed with <a href="waku/standards/core/36/bindings-api.html#waku_connect"><code>waku_connect_peer</code></a>.
Use <code>NULL</code> to automatically select a node.</li>
<li><code>int timeoutMs</code>: Timeout value in milliseconds to execute the call.
If the function execution takes longer than this value,
the execution will be canceled and an error returned.
Use <code>0</code> for no timeout.</li>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will receive the subscription details, for example:</li>
</ul>
<pre><code class="language-json">{
  "peerID": "....",
  "pubsubTopic": "...",
  "contentTopics": [...]
}
</code></pre>
<ul>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<p>Events</p>
<p>When a message is received,
a <code>"message"</code> event is emitted containing the message, pubsub topic,
and node ID in which the message was received.</p>
<p>The <code>event</code> type is <a href="waku/standards/core/36/bindings-api.html#jsonmessageevent-type"><code>JsonMessageEvent</code></a>.</p>
<p>For Example:</p>
<pre><code class="language-json">{
  "type": "message",
  "event": {
    "pubsubTopic": "/waku/2/default-waku/proto",
    "messageId": "0x6496491e40dbe0b6c3a2198c2426b16301688a2daebc4f57ad7706115eac3ad1",
    "wakuMessage": {
      "payload": "TODO",
      "contentTopic": "/my-app/1/notification/proto",
      "version": 1,
      "timestamp": 1647826358000000000
    }
  }
}
</code></pre>
<h3 id="waku_filter_ping"><a class="header" href="#waku_filter_ping">waku_filter_ping</a></h3>
<pre><code class="language-c">extern int waku_filter_ping(char* peerID, int timeoutMs, WakuCallBack onErrCb){}
</code></pre>
<p>Used to know if a service node has an active subscription for this client</p>
<p>Parameters</p>
<ol>
<li><code>char* peerID</code>: Peer ID to check for an active subscription
The peer must be already known.
It must have been added before with <a href="waku/standards/core/36/bindings-api.html#waku_connect"><code>waku_add_peer</code></a>
or previously dialed with <a href="waku/standards/core/36/bindings-api.html#waku_connect"><code>waku_connect_peer</code></a>.</li>
<li><code>int timeoutMs</code>: Timeout value in milliseconds to execute the call.
If the function execution takes longer than this value,
the execution will be canceled and an error returned.
Use <code>0</code> for no timeout.</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onErrCb</code> callback</li>
</ul>
<h3 id="waku_filter_unsubscribe"><a class="header" href="#waku_filter_unsubscribe">waku_filter_unsubscribe</a></h3>
<pre><code class="language-c">extern int waku_filter_unsubscribe(filterJSON *C.char, char* peerID, int timeoutMs, WakuCallBack onErrCb){}
</code></pre>
<p>Sends a requests to a service node to stop pushing messages matching this filter
to this client.
It might be used to modify an existing subscription by
providing a subset of the original filter criteria</p>
<p>Parameters</p>
<ol>
<li><code>char* filterJSON</code>: JSON string containing the <a href="waku/standards/core/36/bindings-api.html#filtersubscription-type"><code>FilterSubscription</code></a>
criteria to unsubscribe from</li>
<li><code>char* peerID</code>: Peer ID to unsubscribe from
The peer must be already known.
It must have been added before with <a href="waku/standards/core/36/bindings-api.html#waku_add_peer"><code>waku_add_peer</code></a>
or previously dialed with <a href="waku/standards/core/36/bindings-api.html#waku_connect"><code>waku_connect_peer</code></a>.</li>
<li><code>int timeoutMs</code>: Timeout value in milliseconds to execute the call.
If the function execution takes longer than this value,
the execution will be canceled and an error returned.
Use <code>0</code> for no timeout.</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<h3 id="waku_filter_unsubscribe_all"><a class="header" href="#waku_filter_unsubscribe_all">waku_filter_unsubscribe_all</a></h3>
<pre><code class="language-c">extern int waku_filter_unsubscribe_all(char* peerID, int timeoutMs, WakuCallBack onOkCb, WakuCallBack onErrCb){}
</code></pre>
<p>Sends a requests to a service node (or all service nodes) to stop pushing messages</p>
<p>Parameters</p>
<ol>
<li><code>char* peerID</code>: Peer ID to unsubscribe from
The peer must be already known.
It must have been added before with <a href="waku/standards/core/36/bindings-api.html#waku_add_peer"><code>waku_add_peer</code></a>
or previously dialed with <a href="waku/standards/core/36/bindings-api.html#waku_connect"><code>waku_connect_peer</code></a>.
Use <code>NULL</code> to unsubscribe from all peers with active subscriptions</li>
<li><code>int timeoutMs</code>: Timeout value in milliseconds to execute the call.
If the function execution takes longer than this value,
the execution will be canceled and an error returned.
Use <code>0</code> for no timeout.</li>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will receive an array
with information about the state of each unsubscription attempt (one per peer)</li>
</ul>
<pre><code class="language-json">[
  {
    "peerID": ....,
    "error": "" // Empty if succesful
  },
  ...
]
</code></pre>
<ul>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<h2 id="waku-legacy-filter"><a class="header" href="#waku-legacy-filter">Waku Legacy Filter</a></h2>
<h3 id="waku_legacy_filter_subscribe"><a class="header" href="#waku_legacy_filter_subscribe">waku_legacy_filter_subscribe</a></h3>
<pre><code class="language-c">extern int waku_legacy_filter_subscribe(char* filterJSON, char* peerID, int timeoutMs, WakuCallBack onErrCb){}
</code></pre>
<p>Creates a subscription in a lightnode for messages that matches a content filter
and optionally a <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topic</code></a>.</p>
<p>Parameters</p>
<ol>
<li><code>char* filterJSON</code>:
JSON string containing the <a href="waku/standards/core/36/bindings-api.html#waku_legacy_filter_subscribe"><code>LegacyFilterSubscription</code></a>
to subscribe to.</li>
<li><code>char* peerID</code>: Peer ID to subscribe to.
The peer must be already known.
It must have been added before with <a href="waku/standards/core/36/bindings-api.html#waku_add_peer"><code>waku_add_peer</code></a>
or previously dialed with <a href="waku/standards/core/36/bindings-api.html#waku_connect"><code>waku_connect_peer</code></a>.
Use <code>NULL</code> to automatically select a node.</li>
<li><code>int timeoutMs</code>: Timeout value in milliseconds to execute the call.
If the function execution takes longer than this value,
the execution will be canceled and an error returned.
Use <code>0</code> for no timeout.</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onErrCb</code> callback</li>
</ul>
<p>Events</p>
<p>When a message is received,
a <code>"message"</code> event is emitted containing the message, pubsub topic,
and node ID in which the message was received.</p>
<p>The <code>event</code> type is <a href="waku/standards/core/36/bindings-api.html#jsonmessageevent-type"><code>JsonMessageEvent</code></a>.</p>
<p>For Example:</p>
<pre><code class="language-json">{
  "type": "message",
  "event": {
    "pubsubTopic": "/waku/2/default-waku/proto",
    "messageId": "0x6496491e40dbe0b6c3a2198c2426b16301688a2daebc4f57ad7706115eac3ad1",
    "wakuMessage": {
      "payload": "TODO",
      "contentTopic": "/my-app/1/notification/proto",
      "version": 1,
      "timestamp": 1647826358000000000
    }
  }
}
</code></pre>
<h3 id="waku_legacy_filter_unsubscribe"><a class="header" href="#waku_legacy_filter_unsubscribe">waku_legacy_filter_unsubscribe</a></h3>
<pre><code class="language-c">extern int waku_legacy_filter_unsubscribe(char* filterJSON, int timeoutMs, WakuCallBack onErrCb){}
</code></pre>
<p>Removes subscriptions in a light node matching a content filter and,
optionally, a <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topic</code></a>.</p>
<p>Parameters</p>
<ol>
<li><code>char* filterJSON</code>: JSON string containing the <a href="waku/standards/core/36/bindings-api.html#filtersubscription-type"><code>LegacyFilterSubscription</code></a>.</li>
<li><code>int timeoutMs</code>: Timeout value in milliseconds to execute the call.
If the function execution takes longer than this value,
the execution will be canceled and an error returned.
Use <code>0</code> for no timeout.</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onErrCb</code> callback</li>
</ul>
<h2 id="waku-lightpush"><a class="header" href="#waku-lightpush">Waku Lightpush</a></h2>
<h3 id="waku_lightpush_publish"><a class="header" href="#waku_lightpush_publish">waku_lightpush_publish</a></h3>
<pre><code class="language-c">extern int waku_lightpush_publish(char* messageJSON, char* topic, char* peerID, int timeoutMs, WakuCallBack onOkCb, WakuCallBack onErrCb){}
</code></pre>
<p>Publish a message using Waku Lightpush.</p>
<p>Parameters</p>
<ol>
<li><code>char* messageJson</code>:
JSON string containing the <a href="waku/standards/core/36/../14/message.html">Waku Message</a> as <a href="waku/standards/core/36/bindings-api.html#jsonmessage-type"><code>JsonMessage</code></a>.</li>
<li><code>char* pubsubTopic</code>: pubsub topic on which to publish the message.
If <code>NULL</code>, it uses the default pubsub topic.</li>
<li><code>char* peerID</code>: Peer ID supporting the lightpush protocol.
The peer must be already known.
It must have been added before with <a href="waku/standards/core/36/bindings-api.html#waku_add_peer"><code>waku_add_peer</code></a>
or previously dialed with <a href="waku/standards/core/36/bindings-api.html#waku_connect"><code>waku_connect_peer</code></a>.
Use <code>NULL</code> to automatically select a node.</li>
<li><code>int timeoutMs</code>: Timeout value in milliseconds to execute the call.
If the function execution takes longer than this value,
the execution will be canceled and an error returned.
Use <code>0</code> for no timeout.</li>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Note: <code>messageJson.version</code> is overwritten to <code>0</code>.</p>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will receive the message ID</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<h2 id="waku-store"><a class="header" href="#waku-store">Waku Store</a></h2>
<h3 id="waku_store_query"><a class="header" href="#waku_store_query">waku_store_query</a></h3>
<pre><code class="language-c">extern int waku_store_query(char* queryJSON, char* peerID, int timeoutMs, WakuCallBack onOkCb, WakuCallBack onErrCb){}
</code></pre>
<p>Retrieves historical messages on specific content topics.
This method may be called with <a href="waku/standards/core/36/bindings-api.html#pagingoptions-type"><code>PagingOptions</code></a>,
to retrieve historical messages on a per-page basis.
If the request included <a href="waku/standards/core/36/bindings-api.html#pagingoptions-type"><code>PagingOptions</code></a>, the node
must return messages on a per-page basis and
include <a href="waku/standards/core/36/bindings-api.html#pagingoptions-type"><code>PagingOptions</code></a> in the response.
These <a href="waku/standards/core/36/bindings-api.html#pagingoptions-type"><code>PagingOptions</code></a>
must contain a cursor pointing to the Index from which a new page can be requested.</p>
<p>Parameters</p>
<ol>
<li><code>char* queryJSON</code>: JSON string containing the <a href="waku/standards/core/36/bindings-api.html#storequery-type"><code>StoreQuery</code></a>.</li>
<li><code>char* peerID</code>: Peer ID supporting the store protocol.
The peer must be already known.
It must have been added before with <a href="waku/standards/core/36/bindings-api.html#waku_add_peer"><code>waku_add_peer</code></a>
or previously dialed with <a href="waku/standards/core/36/bindings-api.html#waku_connect"><code>waku_connect_peer</code></a>.</li>
<li><code>int timeoutMs</code>: Timeout value in milliseconds to execute the call.
If the function execution takes longer than this value,
the execution will be canceled and an error returned.
Use <code>0</code> for no timeout.</li>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will receive a <a href="waku/standards/core/36/bindings-api.html#storeresponse-type"><code>StoreResponse</code></a>.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<h3 id="waku_store_local_query"><a class="header" href="#waku_store_local_query">waku_store_local_query</a></h3>
<pre><code class="language-c">extern int waku_store_local_query(char* queryJSON, WakuCallBack onOkCb, WakuCallBack onErrCb){}
</code></pre>
<p>Retrieves locally stored historical messages on specific content topics.
This method may be called with <a href="waku/standards/core/36/bindings-api.html#pagingoptions-type"><code>PagingOptions</code></a>,
to retrieve historical messages on a per-page basis.
If the request included <a href="waku/standards/core/36/bindings-api.html#pagingoptions-type"><code>PagingOptions</code></a>, the node
must return messages on a per-page basis and
include <a href="waku/standards/core/36/bindings-api.html#pagingoptions-type"><code>PagingOptions</code></a> in the response.
These <a href="waku/standards/core/36/bindings-api.html#pagingoptions-type"><code>PagingOptions</code></a>
must contain a cursor pointing to the Index from which a new page can be requested.</p>
<p>Parameters</p>
<ol>
<li><code>char* queryJSON</code>: JSON string containing the <a href="waku/standards/core/36/bindings-api.html#storequery-type"><code>StoreQuery</code></a>.</li>
<li><code>int timeoutMs</code>: Timeout value in milliseconds to execute the call.
If the function execution takes longer than this value,
the execution will be canceled and an error returned.
Use <code>0</code> for no timeout.</li>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly. <code>onOkCb</code> will receive a <a href="waku/standards/core/36/bindings-api.html#storeresponse-type"><code>StoreResponse</code></a>.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<h2 id="encrypting-messages"><a class="header" href="#encrypting-messages">Encrypting messages</a></h2>
<h3 id="waku_encode_symmetric"><a class="header" href="#waku_encode_symmetric">waku_encode_symmetric</a></h3>
<pre><code class="language-c">extern int waku_encode_symmetric(char* messageJson, char* symmetricKey, char* optionalSigningKey, WakuCallBack onOkCb, WakuCallBack onErrCb){}
</code></pre>
<p>Encrypt a message using symmetric encryption and optionally sign the message</p>
<p>Parameters</p>
<ol>
<li><code>char* messageJson</code>:
JSON string containing the <a href="waku/standards/core/36/../14/message.html">Waku Message</a> as <a href="waku/standards/core/36/bindings-api.html#jsonmessage-type"><code>JsonMessage</code></a>.</li>
<li><code>char* symmetricKey</code>: hex encoded secret key to be used for encryption.</li>
<li><code>char* optionalSigningKey</code>: hex encoded private key to be used to sign the message.</li>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Note: <code>messageJson.version</code> is overwritten to <code>1</code>.</p>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will receive the encrypted waku message which can be broadcasted with relay
or lightpush protocol publish functions.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<h3 id="waku_encode_asymmetric"><a class="header" href="#waku_encode_asymmetric">waku_encode_asymmetric</a></h3>
<pre><code class="language-c">extern int waku_encode_asymmetric(char* messageJson, char* publicKey, char* optionalSigningKey, WakuCallBack onOkCb, WakuCallBack onErrCb){}
</code></pre>
<p>Encrypt a message using asymmetric encryption and optionally sign the message</p>
<p>Parameters</p>
<ol>
<li><code>char* messageJson</code>:
JSON string containing the <a href="waku/standards/core/36/../14/message.html">Waku Message</a> as <a href="waku/standards/core/36/bindings-api.html#jsonmessage-type"><code>JsonMessage</code></a>.</li>
<li><code>char* publicKey</code>: hex encoded public key to be used for encryption.</li>
<li><code>char* optionalSigningKey</code>: hex encoded private key to be used to sign the message.</li>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Note: <code>messageJson.version</code> is overwritten to <code>1</code>.</p>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will receive the encrypted waku message which can be broadcasted with relay
or lightpush protocol publish functions.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<h2 id="decrypting-messages"><a class="header" href="#decrypting-messages">Decrypting messages</a></h2>
<h3 id="waku_decode_symmetric"><a class="header" href="#waku_decode_symmetric">waku_decode_symmetric</a></h3>
<pre><code class="language-c">extern int waku_decode_symmetric(char* messageJson, char* symmetricKey, WakuCallBack onOkCb, WakuCallBack onErrCb){}
</code></pre>
<p>Decrypt a message using a symmetric key</p>
<p>Parameters</p>
<ol>
<li><code>char* messageJson</code>:
JSON string containing the <a href="waku/standards/core/36/../14/message.html">Waku Message</a> as <a href="waku/standards/core/36/bindings-api.html#jsonmessage-type"><code>JsonMessage</code></a>.</li>
<li><code>char* symmetricKey</code>: 32 byte symmetric key hex encoded.</li>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Note: <code>messageJson.version</code> is expected to be <code>1</code>.</p>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will receive the decoded payload as a <a href="waku/standards/core/36/bindings-api.html#decodedpayload-type"><code>DecodedPayload</code></a>.</li>
</ul>
<pre><code class="language-json">{
  "pubkey": "0x......",
  "signature": "0x....",
  "data": "...",
  "padding": "..."
}
</code></pre>
<ul>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<h3 id="waku_decode_asymmetric"><a class="header" href="#waku_decode_asymmetric">waku_decode_asymmetric</a></h3>
<pre><code class="language-c">extern int waku_decode_asymmetric(char* messageJson, char* privateKey, WakuCallBack onOkCb, WakuCallBack onErrCb){}
</code></pre>
<p>Decrypt a message using a secp256k1 private key</p>
<p>Parameters</p>
<ol>
<li><code>char* messageJson</code>:
JSON string containing the <a href="waku/standards/core/36/../14/message.html">Waku Message</a> as <a href="waku/standards/core/36/bindings-api.html#jsonmessage-type"><code>JsonMessage</code></a>.</li>
<li><code>char* privateKey</code>: secp256k1 private key hex encoded.</li>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Note: <code>messageJson.version</code> is expected to be <code>1</code>.</p>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will receive the decoded payload as a <a href="waku/standards/core/36/bindings-api.html#decodedpayload-type"><code>DecodedPayload</code></a>.</li>
</ul>
<pre><code class="language-json">{
  "pubkey": "0x......",
  "signature": "0x....",
  "data": "...",
  "padding": "..."
}
</code></pre>
<ul>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<h2 id="dns-discovery"><a class="header" href="#dns-discovery">DNS Discovery</a></h2>
<h3 id="waku_dns_discovery"><a class="header" href="#waku_dns_discovery">waku_dns_discovery</a></h3>
<pre><code class="language-c">extern int waku_dns_discovery(char* url, char* nameserver, int timeoutMs, WakuCallBack onOkCb, WakuCallBack onErrCb){}
</code></pre>
<p>Returns a list of multiaddress and enrs given a url to a DNS discoverable ENR tree</p>
<p>Parameters</p>
<ol>
<li><code>char* url</code>: URL containing a discoverable ENR tree</li>
<li><code>char* nameserver</code>: The nameserver to resolve the ENR tree url.
If <code>NULL</code> or empty, it will automatically use the default system dns.</li>
<li><code>int timeoutMs</code>: Timeout value in milliseconds to execute the call.
If the function execution takes longer than this value,
the execution will be canceled and an error returned.
Use <code>0</code> for no timeout.</li>
<li><code>WakuCallBack onOkCb</code>: callback to be executed if the function is succesful</li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.
<code>onOkCb</code> will receive an array objects describing the multiaddresses,
enr and peerID each node found.</li>
</ul>
<pre><code class="language-json">[
    {
        "peerID":"16Uiu2HAmPLe7Mzm8TsYUubgCAW1aJoeFScxrLj8ppHFivPo97bUZ",
        "multiaddrs":[
            "/ip4/134.209.139.210/tcp/30303/p2p/16Uiu2HAmPLe7Mzm8TsYUubgCAW1aJoeFScxrLj8ppHFivPo97bUZ",
            "/dns4/node-01.do-ams3.wakuv2.test.statusim.net/tcp/8000/wss/p2p/16Uiu2HAmPLe7Mzm8TsYUubgCAW1aJoeFScxrLj8ppHFivPo97bUZ"
        ],
        "enr":"enr:-M-4QCtJKX2WDloRYDT4yjeMGKUCRRcMlsNiZP3cnPO0HZn6IdJ035RPCqsQ5NvTyjqHzKnTM6pc2LoKliV4CeV0WrgBgmlkgnY0gmlwhIbRi9KKbXVsdGlhZGRyc7EALzYobm9kZS0wMS5kby1hbXMzLndha3V2Mi50ZXN0LnN0YXR1c2ltLm5ldAYfQN4DiXNlY3AyNTZrMaEDnr03Tuo77930a7sYLikftxnuG3BbC3gCFhA4632ooDaDdGNwgnZfg3VkcIIjKIV3YWt1Mg8"
    },
    ...
]
</code></pre>
<ul>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onOkCb</code> or <code>onErrCb</code> callback</li>
</ul>
<h2 id="discoveryv5"><a class="header" href="#discoveryv5">DiscoveryV5</a></h2>
<h3 id="waku_discv5_update_bootnodes"><a class="header" href="#waku_discv5_update_bootnodes">waku_discv5_update_bootnodes</a></h3>
<pre><code class="language-c">extern int waku_discv5_update_bootnodes(char* bootnodes, WakuCallBack onErrCb)`
</code></pre>
<p>Update the bootnode list used for discovering new peers via DiscoveryV5</p>
<p>Parameters</p>
<ol>
<li><code>char* bootnodes</code>: JSON array containing the bootnode ENRs i.e. <code>["enr:...", "enr:..."]</code></li>
<li><code>WakuCallBack onErrCb</code>: callback to be executed if the function fails</li>
</ol>
<p>Returns</p>
<p><code>int</code> with a status code. Possible values:</p>
<ul>
<li>0 - The operation was completed successfuly.</li>
<li>1 - The operation failed for any reason.
<code>onErrCb</code> will be executed with the reason the function execution failed.</li>
<li>2 - The function is missing the <code>onErrCb</code> callback</li>
</ul>
<h2 id="copyright-26"><a class="header" href="#copyright-26">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="64waku2-network"><a class="header" href="#64waku2-network">64/WAKU2-NETWORK</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v2 Network</td></tr>
<tr><th>Slug</th><td>64</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Category</th><td>Best Current Practice</td></tr>
<tr><th>Editor</th><td>Hanno Cornelius &lt;hanno@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-31"><a class="header" href="#timeline-31">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/core/64/network.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/core/64/network.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-02-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/0277fd0c4dbd907dfb2f0c28b6cde94a335e1fae/waku/standards/core/64/network.md"><code>0277fd0</code></a> — docs: update dead links in 64/Network (#133)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/core/64/network.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-07-09</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/77029a2e648317bff0f50623e7e03862115cee5c/waku/standards/core/64/network.md"><code>77029a2</code></a> — Add RLNv2 to TheWakuNetwork (#82)</li>
<li><strong>2024-05-10</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/e5b859abfb3e42fde4336e5fc5b4e7250126f8ce/waku/standards/core/64/network.md"><code>e5b859a</code></a> — Update WAKU2-NETWORK: Move to draft (#5)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-21"><a class="header" href="#abstract-21">Abstract</a></h2>
<p>This specification describes an opinionated deployment of <a href="waku/standards/core/64/../10/waku2.html">10/WAKU2</a>
protocols to form a coherent and
shared decentralized messaging network that is open-access,
useful for generalized messaging, privacy-preserving, scalable and
accessible even to resource-restricted devices.
We'll refer to this opinionated deployment simply as
<em>the public Waku Network</em>, <em>the Waku Network</em> or, if the context is clear, <em>the network</em>
in the rest of this document.
All The Waku Network configuration parameters are listed <a href="https://github.com/waku-org/nwaku/blob/8bfad3ab453f96ac545c7cb0af06d0c0f34d1356/waku/factory/networks_config.nim#L31">here</a>.</p>
<h2 id="theory--semantics-1"><a class="header" href="#theory--semantics-1">Theory / Semantics</a></h2>
<h3 id="routing-protocol"><a class="header" href="#routing-protocol">Routing protocol</a></h3>
<p>The Waku Network is built on the
<a href="waku/standards/core/64/../17/rln-relay.html">17/WAKU2-RLN-RELAY</a> routing protocol,
which in turn is an extension of
<a href="waku/standards/core/64/../11/relay.html">11/WAKU2-RELAY</a> with spam protection measures.</p>
<h3 id="network-shards"><a class="header" href="#network-shards">Network shards</a></h3>
<p>Traffic in the Waku Network is sharded into eight
<a href="waku/standards/core/64/../17/rln-relay.html">17/WAKU2-RLN-RELAY</a> pubsub topics.
Each pubsub topic is named according to the static shard naming format
defined in <a href="https://github.com/waku-org/specs/blob/master/standards/core/relay-sharding.md">WAKU2-RELAY-SHARDING</a>
with:</p>
<ul>
<li><code>&lt;cluster_id&gt;</code> set to <code>1</code></li>
<li><code>&lt;shard_number&gt;</code> occupying the range <code>0</code> to <code>7</code>.
In other words, the Waku Network is a <a href="waku/standards/core/64/../17/rln-relay.html">17/WAKU2-RLN-RELAY</a> network
routed on the combination of the eight pubsub topics:</li>
</ul>
<pre><code class="language-text">/waku/2/rs/1/0
/waku/2/rs/1/1
...
/waku/2/rs/1/7
</code></pre>
<p>A node MUST use <a href="waku/standards/core/64/../66/metadata.html">66/WAKU2-METADATA</a>
protocol to identify the <code>&lt;cluster_id&gt;</code> that every
inbound/outbound peer that attempts to connect supports.
In any of the following cases, the node MUST trigger a disconnection:</p>
<ul>
<li><a href="waku/standards/core/64/../66/metadata.html">66/WAKU2-METADATA</a>
dial fails.</li>
<li><a href="waku/standards/core/64/../66/metadata.html">66/WAKU2-METADATA</a>
reports an empty <code>&lt;cluster_id&gt;</code>.</li>
<li><a href="waku/standards/core/64/../66/metadata.html">66/WAKU2-METADATA</a>
reports a <code>&lt;cluster_id&gt;</code> different than <code>1</code>.</li>
</ul>
<h2 id="roles-2"><a class="header" href="#roles-2">Roles</a></h2>
<p>There are two distinct roles evident in the network, those of:</p>
<ol>
<li>nodes, and</li>
<li>applications.</li>
</ol>
<h3 id="nodes"><a class="header" href="#nodes">Nodes</a></h3>
<p>Nodes are the individual software units
using <a href="waku/standards/core/64/../10/waku2.html">10/WAKU2</a> protocols to form a p2p messaging network.
Nodes, in turn, can participate in a shard as full relayers, i.e. <em>relay nodes</em>,
or by running a combination of protocols suitable for resource-restricted environments,
i.e. <em>non-relay nodes</em>.
Nodes can also provide various services to the network,
such as storing historical messages or protecting the network against spam.
See the section on <a href="waku/standards/core/64/network.html#default-services">default services</a> for more.</p>
<h4 id="relay-nodes"><a class="header" href="#relay-nodes">Relay nodes</a></h4>
<p>Relay nodes MUST follow <a href="waku/standards/core/64/../17/rln-relay.html">17/WAKU2-RLN-RELAY</a>
to route messages to other nodes in the network
for any of the pubsub topics <a href="waku/standards/core/64/network.html#network-shards">defined as the Waku Network shards</a>.
Relay nodes MAY choose to subscribe to any of these shards,
but MUST be subscribed to at least one defined shard.
Each relay node SHOULD be subscribed to as many shards as it has resources to support.
If a relay node supports an encapsulating application,
it SHOULD be subscribed to all the shards servicing that application.
If resource restrictions prevent a relay node from servicing all shards
used by the encapsulating application,
it MAY choose to support some shards as a non-relay node.</p>
<h4 id="bootstrapping-and-discovery"><a class="header" href="#bootstrapping-and-discovery">Bootstrapping and discovery</a></h4>
<p>Nodes MAY use any method to bootstrap connection to the network,
but it is RECOMMENDED that each node retrieves a list of bootstrap peers to connect
to using <a href="https://eips.ethereum.org/EIPS/eip-1459">EIP-1459 DNS-based discovery</a>.
Relay nodes SHOULD use <a href="waku/standards/core/64/../33/discv5.html">33/WAKU2-DISCV5</a> to continually discover
other peers in the network.
Each relay node MUST encode its supported shards into its discoverable ENR,
as described in <a href="https://github.com/waku-org/specs/blob/master/standards/core/relay-sharding.md/#discovery">WAKU2-RELAY-SHARDING</a>.
The ENR MUST be updated if the set of supported shards change.
A node MAY choose to ignore discovered peers that do not support any of the shards
in its own subscribed set.</p>
<h4 id="transports-1"><a class="header" href="#transports-1">Transports</a></h4>
<p>Relay nodes MUST follow <a href="waku/standards/core/64/../10/waku2.html">10/WAKU2</a> specifications with regards
to supporting different transports.
If TCP transport is available,
each relay node MUST support it as transport for both dialing and listening.
In addition,
a relay node SHOULD support secure websockets for bidirectional communication streams,
for example to allow connections from and to web browser-based clients.
A relay node MAY support unsecure websockets if required by the application or
running environment.</p>
<h4 id="default-services"><a class="header" href="#default-services">Default services</a></h4>
<p>For each supported shard,
each relay node SHOULD enable and support the following protocols as a service node:</p>
<ol>
<li><a href="waku/standards/core/64/../12/filter.html">12/WAKU2-FILTER</a> to allow resource-restricted peers to subscribe
to messages matching a specific content filter.</li>
<li><a href="waku/standards/core/64/../13/store.html">13/WAKU2-STORE</a> to allow other peers to request historical messages
from this node.</li>
<li><a href="waku/standards/core/64/../19/lightpush.html">19/WAKU2-LIGHTPUSH</a> to allow resource-restricted peers to
request publishing a message to the network on their behalf.</li>
<li><a href="https://github.com/waku-org/specs/blob/master/standards/core/peer-exchange.md">WAKU2-PEER-EXCHANGE</a>
to allow resource-restricted peers to discover more peers
in a resource efficient way.</li>
</ol>
<h4 id="store-service-nodes"><a class="header" href="#store-service-nodes">Store service nodes</a></h4>
<p>Each relay node SHOULD support <a href="waku/standards/core/64/../13/store.html">13/WAKU2-STORE</a>
as a store service node, for each supported shard.
The store SHOULD be configured to retain at least <code>12</code> hours of messages
per supported shard.
Store service nodes SHOULD only store messages
with a valid <a href="waku/standards/core/64/network.html#message-attributes"><code>rate_limit_proof</code></a> attribute.</p>
<h4 id="non-relay-nodes"><a class="header" href="#non-relay-nodes">Non-relay nodes</a></h4>
<p>Nodes MAY opt out of relay functionality on any network shard
and instead request services from relay nodes as clients
using any of the defined service protocols:</p>
<ol>
<li><a href="waku/standards/core/64/../12/filter.html">12/WAKU2-FILTER</a>
to subscribe to messages matching a specific content filter.</li>
<li><a href="waku/standards/core/64/../13/store.html">13/WAKU2-STORE</a>
to request historical messages matching a specific content filter.</li>
<li><a href="waku/standards/core/64/../19/lightpush.html">19/WAKU2-LIGHTPUSH</a>
to request publishing a message to the network.</li>
<li><a href="https://github.com/waku-org/specs/blob/master/standards/core/peer-exchange.md">WAKU2-PEER-EXCHANGE</a>
to discover more peers in a resource efficient way.</li>
</ol>
<h4 id="store-client-nodes"><a class="header" href="#store-client-nodes">Store client nodes</a></h4>
<p>Nodes MAY request historical messages from <a href="waku/standards/core/64/../13/store.html">13/WAKU2-STORE</a>
service nodes as store clients.
A store client SHOULD discard any messages retrieved from a store service node
that do not contain a valid <a href="waku/standards/core/64/network.html#message-attributes"><code>rate_limit_proof</code></a> attribute.
The client MAY consider service nodes returning messages
without a valid <a href="waku/standards/core/64/network.html#message-attributes"><code>rate_limit_proof</code></a> attribute as untrustworthy.
The mechanism by which this may happen is currently underdefined.</p>
<h3 id="applications"><a class="header" href="#applications">Applications</a></h3>
<p>Applications are the higher-layer projects or
platforms that make use of the generalized messaging capability of the network.
In other words,
an application defines a payload used in the various <a href="waku/standards/core/64/../10/waku2.html">10/WAKU2</a> protocols.
Any participant in an application SHOULD make use of an underlying node
in order to communicate on the network.
Applications SHOULD make use of an <a href="waku/standards/core/64/network.html#autosharding">autosharding</a> API
to allow the underlying node to automatically select the target shard
on the Waku Network.
See the section on <a href="waku/standards/core/64/network.html#autosharding">autosharding</a> for more.</p>
<h2 id="rln-rate-limiting"><a class="header" href="#rln-rate-limiting">RLN rate-limiting</a></h2>
<p>The <a href="waku/standards/core/64/../17/rln-relay.html">17/WAKU2-RLN-RELAY</a> protocol uses <a href="https://github.com/vacp2p/rfc-index/blob/a5b24ac0a27da361312260f9da372a0e6e812212/vac/raw/rln-v2.md">RLN-V2</a>
proofs to ensure that a pre-agreed rate limit
of <code>x</code> messages every <code>y</code> seconds is not exceeded by any publisher.
While the network is under capacity,
individual relayers MAY choose to freely route messages without RLN proofs
up to a discretionary bandwidth limit,
after which messages without proofs MUST be discarded by relay nodes.
This bandwidth limit SHOULD be enforced using a <a href="waku/standards/core/64/network.html#free-bandwidth-exceeded">bandwidth validation mechanism</a>
separate from a RLN rate-limiting.
This implies that quality of service and
reliability is significantly lower for messages without proofs
and at times of high network utilization these messages may not be relayed at all.</p>
<h3 id="rln-parameters"><a class="header" href="#rln-parameters">RLN Parameters</a></h3>
<p>The Waku Network uses the following RLN parameters:</p>
<ul>
<li><code>rlnRelayUserMessageLimit=100</code>:
Amount of messages that a membership is allowed to publish per epoch.
Configurable between <code>0</code> and <code>MAX_MESSAGE_LIMIT</code>.</li>
<li><code>rlnEpochSizeSec=600</code>: Size of the epoch in seconds.</li>
<li><code>rlnRelayChainId=11155111</code>: Network in which the RLN contract is deployed,
aka Sepolia.</li>
<li><code>rlnRelayEthContractAddress=0xCB33Aa5B38d79E3D9Fa8B10afF38AA201399a7e3</code>:
Network address where RLN memberships are stored.</li>
<li><code>staked_fund=0</code>: In other words, the Waku Network does not use RLN staking.
Registering a membership just requires to pay gas.</li>
<li><code>MAX_MESSAGE_LIMIT=100</code>:
Maximum amount of messages allowed per epoch for any membership.
Enforced in the contract.</li>
<li><code>max_epoch_gap=20</code>: Maximum allowed gap in seconds into the past or
future compared to the validator's clock.</li>
</ul>
<p>Nodes MUST <em>reject</em> messages not respecting any of these parameters.
Nodes SHOULD use Network Time Protocol (NTP) to synchronize their own clocks,
thereby ensuring valid timestamps for proof generation and validation.
Publishers to the Waku Network SHOULD register an RLN membership.</p>
<h3 id="rln-proofs"><a class="header" href="#rln-proofs">RLN Proofs</a></h3>
<p>Each RLN member MUST generate and attach an RLN proof to every published message
as described in <a href="waku/standards/core/64/../17/rln-relay.html">17/WAKU2-RLN-RELAY</a> and <a href="https://github.com/vacp2p/rfc-index/blob/a5b24ac0a27da361312260f9da372a0e6e812212/vac/raw/rln-v2.md">RLN-V2</a>.
Slashing is not implemented for the Waku Network.
Instead, validators will penalise peers forwarding messages exceeding the rate limit
as specified for <a href="waku/standards/core/64/network.html#rate-limit-exceeded">the rate-limiting validation mechanism</a>.
This incentivizes all relay nodes to validate RLN proofs
and reject messages violating rate limits
in order to continue participating in the network.</p>
<h2 id="network-traffic"><a class="header" href="#network-traffic">Network traffic</a></h2>
<p>All payload on the Waku Network MUST be encapsulated in a <a href="waku/standards/core/64/../14/message.html">14/WAKU2-MESSAGE</a>
with rate limit proof extensions defined for <a href="waku/standards/core/64/../17/rln-relay.html">17/WAKU2-RLN-RELAY</a>.
Each message on the Waku Network SHOULD be validated by each relayer,
according to the rules discussed under <a href="waku/standards/core/64/network.html#message-validation">message validation</a>.</p>
<h3 id="message-attributes-1"><a class="header" href="#message-attributes-1">Message Attributes</a></h3>
<ul>
<li>The mandatory <code>payload</code> attribute MUST contain the message data payload
as crafted by the application.</li>
<li>The mandatory <code>content_topic</code> attribute MUST specify a string identifier
that can be used for content-based filtering.
This is also crafted by the application.
See <a href="waku/standards/core/64/network.html#autosharding">Autosharding</a> for more on the content topic format.</li>
<li>The optional <code>meta</code> attribute MAY be omitted.
If present, will form part of the message uniqueness vector described in <a href="waku/standards/core/64/../14/message.html">14/WAKU2-MESSAGE</a>.</li>
<li>The optional <code>version</code> attribute SHOULD be set to <code>0</code>.
It MUST be interpreted as <code>0</code> if not present.</li>
<li>The mandatory <code>timestamp</code> attribute MUST contain the Unix epoch time
at which the message was generated by the application.
The value MUST be in nanoseconds.
It MAY contain a fudge factor of up to 1 seconds in either direction
to improve resistance to timing attacks.</li>
<li>The optional <code>ephemeral</code> attribute MUST be set to <code>true</code>,
if the message should not be persisted by the Waku Network.</li>
<li>The optional <code>rate_limit_proof</code> attribute SHOULD be populated with the RLN proof
as set out in <a href="waku/standards/core/64/network.html#rln-proofs">RLN Proofs</a>.
Messages with this field unpopulated MAY be discarded from the network by relayers.
This field MUST be populated if the message should be persisted by the Waku Network.</li>
</ul>
<h3 id="message-size"><a class="header" href="#message-size">Message Size</a></h3>
<p>Any <a href="waku/standards/core/64/../14/message.html">14/WAKU2-MESSAGE</a> published to the network
MUST NOT exceed an absolute maximum size of <code>150</code> kilobytes.
This limit applies to the entire message after protobuf serialization,
including attributes.
It is RECOMMENDED not to exceed an average size of <code>4</code> kilobytes
for <a href="waku/standards/core/64/../14/message.html">14/WAKU2-MESSAGE</a> published to the network.</p>
<h3 id="message-validation"><a class="header" href="#message-validation">Message Validation</a></h3>
<p>Relay nodes MUST apply <a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md#extended-validators">gossipsub v1.1 validation</a>
to each relayed message and
SHOULD apply all of the rules set out in the section below
to determine the validity of a message.
Validation has one of three outcomes,
repeated here from the <a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md#extended-validators">gossipsub specification</a>
for ease of reference:</p>
<ol>
<li>Accept - the message is considered valid and
it MUST be delivered and forwarded to the network.</li>
<li>Reject - the message is considered invalid, MUST be rejected and
SHOULD trigger a gossipsub scoring penalty against the transmitting peer.</li>
<li>Ignore - the message SHOULD NOT be delivered and forwarded to the network,
but this MUST NOT trigger a gossipsub scoring penalty against the transmitting peer.</li>
</ol>
<p>The following validation rules are defined:</p>
<h4 id="decoding-failure"><a class="header" href="#decoding-failure">Decoding failure</a></h4>
<p>If a message fails to decode as a valid <a href="waku/standards/core/64/../14/message.html">14/WAKU2-MESSAGE</a>,
the relay node MUST <em>reject</em> the message.
This SHOULD trigger a penalty against the transmitting peer.</p>
<h4 id="invalid-timestamp"><a class="header" href="#invalid-timestamp">Invalid timestamp</a></h4>
<p>If a message has a timestamp deviating by more than <code>20</code> seconds
either into the past or the future
when compared to the relay node's internal clock,
the relay node MUST <em>reject</em> the message.
This allows for some deviation between internal clocks,
network routing latency and
an optional <a href="waku/standards/core/64/network.html#message-attributes">fudge factor when timestamping new messages</a>.</p>
<h4 id="free-bandwidth-exceeded"><a class="header" href="#free-bandwidth-exceeded">Free bandwidth exceeded</a></h4>
<p>If a message contains no RLN proof
and the current bandwidth utilization on the shard the message was published to
equals or exceeds <code>1</code> Mbps,
the relay node SHOULD <em>ignore</em> the message.</p>
<h4 id="invalid-rln-epoch"><a class="header" href="#invalid-rln-epoch">Invalid RLN epoch</a></h4>
<p>If a message contains an RLN proof
and the <code>epoch</code> attached to the proof deviates by more than <code>max_epoch_gap</code> seconds
from the relay node's own <code>epoch</code>,
the relay node MUST <em>reject</em> the message.
<code>max_epoch_gap</code> is <a href="waku/standards/core/64/network.html#rln-parameters">set to <code>20</code> seconds</a> for the Waku Network.</p>
<h4 id="invalid-rln-proof"><a class="header" href="#invalid-rln-proof">Invalid RLN proof</a></h4>
<p>If a message contains an RLN proof
and the zero-knowledge proof is invalid
according to the verification process described in <a href="https://github.com/vacp2p/rfc-index/blob/a5b24ac0a27da361312260f9da372a0e6e812212/vac/raw/rln-v2.md">RLN-V2</a>,
the relay node MUST <em>ignore</em> the message.</p>
<h4 id="rate-limit-exceeded"><a class="header" href="#rate-limit-exceeded">Rate limit exceeded</a></h4>
<p>If a message contains an RLN proof
and the relay node detects double signaling
according to the verification process described in <a href="https://github.com/vacp2p/rfc-index/blob/a5b24ac0a27da361312260f9da372a0e6e812212/vac/raw/rln-v2.md">RLN-V2</a>,
the relay node MUST <em>reject</em> the message
for violating the agreed rate limit of <code>rlnRelayUserMessageLimit</code> messages
every <code>rlnEpochSizeSec</code> second.
This SHOULD trigger a penalty against the transmitting peer.</p>
<h2 id="autosharding"><a class="header" href="#autosharding">Autosharding</a></h2>
<p>Nodes in the Waku Network SHOULD allow encapsulating applications to use autosharding,
as defined in <a href="https://github.com/waku-org/specs/blob/master/standards/core/relay-sharding.md/#automatic-sharding">WAKU2-RELAY-SHARDING</a>
by automatically determining the appropriate pubsub topic
from the list <a href="waku/standards/core/64/network.html#network-shards">of defined Waku Network shards</a>.
This allows the application to omit the target pubsub topic
when invoking any Waku protocol function.
Applications using autosharding MUST use content topics in the format
defined in <a href="https://github.com/waku-org/specs/blob/master/standards/core/relay-sharding.md/#content-topics-format-for-autosharding">WAKU2-RELAY-SHARDING</a>
and SHOULD use the short length format:</p>
<pre><code class="language-text">/{application-name}/{version-of-the-application}/{content-topic-name}/{encoding}
</code></pre>
<p>When an encapsulating application makes use of autosharding
the underlying node MUST determine the target pubsub topic(s)
from the content topics provided by the application
using the hashing mechanism defined in <a href="https://github.com/waku-org/specs/blob/master/standards/core/relay-sharding.md/#automatic-sharding">WAKU2-RELAY-SHARDING</a>.</p>
<h2 id="copyright-27"><a class="header" href="#copyright-27">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-24"><a class="header" href="#references-24">References</a></h2>
<ul>
<li><a href="waku/standards/core/64/../10/waku2.html">10/WAKU2</a></li>
<li><a href="waku/standards/core/64/../17/rln-relay.html">17/WAKU2-RLN-RELAY</a></li>
<li><a href="waku/standards/core/64/../11/relay.html">11/WAKU2-RELAY</a></li>
<li><a href="waku/standards/core/64/../../core/relay-sharding.html">WAKU2-RELAY-SHARDING</a></li>
<li><a href="waku/standards/core/64/../66/metadata.html">66/WAKU2-METADATA</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-1459">EIP-1459 DNS-based discovery</a></li>
<li><a href="waku/standards/core/64/../33/discv5.html">33/WAKU2-DISCV5</a></li>
<li><a href="waku/standards/core/64/../12/filter.html">12/WAKU2-FILTER</a></li>
<li><a href="waku/standards/core/64/../13/store.html">13/WAKU2-STORE</a></li>
<li><a href="waku/standards/core/64/../19/lightpush.html">19/WAKU2-LIGHTPUSH</a></li>
<li><a href="waku/standards/core/64/../../core/peer-exchange.html">34/WAKU2-PEER-EXCHANGE</a></li>
<li><a href="waku/standards/core/64/../../../../vac/32/rln-v1.html">32/RLN-V1</a></li>
<li><a href="https://github.com/vacp2p/rfc-index/blob/a5b24ac0a27da361312260f9da372a0e6e812212/vac/raw/rln-v2.md">RLN-V2</a></li>
<li><a href="waku/standards/core/64/../14/message.html">14/WAKU2-MESSAGE</a></li>
<li><a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md#extended-validators">gossipsub v1.1 validation</a></li>
<li><a href="https://github.com/waku-org/specs/blob/master/standards/core/relay-sharding.md/">WAKU2-RELAY-SHARDING</a></li>
<li><a href="https://github.com/waku-org/nwaku/blob/master/waku/factory/networks_config.nim#L31">The Waku Network Config</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="66waku2-metadata"><a class="header" href="#66waku2-metadata">66/WAKU2-METADATA</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku Metadata Protocol</td></tr>
<tr><th>Slug</th><td>66</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Franck Royer &lt;franck@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;<br>Alvaro Revuelta &lt;alrevuelta@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-32"><a class="header" href="#timeline-32">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/core/66/metadata.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/core/66/metadata.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-07-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/4361e2958f1c71269953206c7b09be7a88609d0c/waku/standards/core/66/metadata.md"><code>4361e29</code></a> — Add implementation recommendation for metadata (#168)</li>
<li><strong>2025-05-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/f829b12517476a054cbe5858de83c1d6ba303568/waku/standards/core/66/metadata.md"><code>f829b12</code></a> — waku/standards/core/66/metadata.md update (#148)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/core/66/metadata.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-04-17</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d82eaccdc07b42e9b4d06d5127e560445e1e222a/waku/standards/core/66/metadata.md"><code>d82eacc</code></a> — Update WAKU2-METADATA: Move to draft (#6)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-22"><a class="header" href="#abstract-22">Abstract</a></h2>
<p>This specification describes the metadata
that can be associated with a <a href="waku/standards/core/66//waku/standards/core/10/waku2.html">10/WAKU2</a> node.</p>
<h2 id="metadata-protocol"><a class="header" href="#metadata-protocol">Metadata Protocol</a></h2>
<p>The keywords “MUST”, // List style “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”,
“NOT RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>.</p>
<p>Waku specifies a req/resp protocol that provides information about the node's capabilities.
Such metadata MAY be used by other peers for subsequent actions such as light protocol requests or disconnection.</p>
<p>The node that makes the request,
includes its metadata so that the receiver is aware of it,
without requiring another round trip.
The parameters are the following:</p>
<ul>
<li><code>clusterId</code>: Unique identifier of the cluster that the node is running in.</li>
<li><code>shards</code>: Shard indexes that the node is subscribed to via <a href="waku/standards/core/66//waku/standards/core/11/relay.html"><code>11/WAKU2-RELAY</code></a>.</li>
</ul>
<p><em><strong>Protocol Identifier</strong></em></p>
<blockquote>
<p>/vac/waku/metadata/1.0.0</p>
</blockquote>
<h3 id="request"><a class="header" href="#request">Request</a></h3>
<pre><code class="language-protobuf">message WakuMetadataRequest {
  optional uint32 cluster_id = 1;
  repeated uint32 shards = 2;
}
</code></pre>
<h3 id="response"><a class="header" href="#response">Response</a></h3>
<pre><code class="language-protobuf">message WakuMetadataResponse {
  optional uint32 cluster_id = 1;
  repeated uint32 shards = 2;
}
</code></pre>
<h2 id="implementation-suggestions-2"><a class="header" href="#implementation-suggestions-2">Implementation Suggestions</a></h2>
<h3 id="triggering-metadata-request"><a class="header" href="#triggering-metadata-request">Triggering Metadata Request</a></h3>
<p>A node SHOULD proceed with metadata request upon first connection to a remote node.
A node SHOULD use the remote node's libp2p peer id as identifier for this heuristic.</p>
<p>A node MAY proceed with metadata request upon reconnection to a remote peer.</p>
<p>A node SHOULD store the remote peer's metadata information for future reference.
A node MAY implement a TTL regarding a remote peer's metadata, and refresh it upon expiry by initiating another metadata request.
It is RECOMMENDED to set the TTL to 6 hours.</p>
<p>A node MAY trigger a metadata request after receiving an error response from a remote note
stating they do not support a specific cluster or shard.
For example, when using a request-response service such as <a href="waku/standards/core/66//waku/standards/core/19/lightpush.html"><code>19/WAKU2-LIGHTPUSH</code></a>.</p>
<h3 id="providing-cluster-id"><a class="header" href="#providing-cluster-id">Providing Cluster Id</a></h3>
<p>A node MUST include their cluster id into their metadata payload.
It is RECOMMENDED for a node to operate on a single cluster id.</p>
<h3 id="providing-shard-information"><a class="header" href="#providing-shard-information">Providing Shard Information</a></h3>
<ul>
<li>Nodes that mount <a href="waku/standards/core/66//waku/standards/core/11/relay.html"><code>11/WAKU2-RELAY</code></a> MAY include the shards they are subscribed to in their metadata payload.</li>
<li>Shard-relevant services are message related services,
such as <a href="waku/standards/core/66//waku/standards/core/13/store.html"><code>13/WAKU2-STORE</code></a>, <a href="waku/standards/core/66//waku/standards/core/12/filter.html">12/WAKU2-FILTER</a>
and <a href="waku/standards/core/66//waku/standards/core/19/lightpush.html"><code>19/WAKU2-LIGHTPUSH</code></a>
but not <a href="waku/standards/core/66//waku/standards/core/34/peer-exchange.html"><code>34/WAKU2-PEER-EXCHANGE</code></a></li>
<li>Nodes that mount <a href="waku/standards/core/66//waku/standards/core/11/relay.html"><code>11/WAKU2-RELAY</code></a> and a shard-relevant service SHOULD include the shards they are subscribed to in their metadata payload.</li>
<li>Nodes that do not mount <a href="waku/standards/core/66//waku/standards/core/11/relay.html"><code>11/WAKU2-RELAY</code></a> SHOULD NOT include any shard information</li>
</ul>
<h3 id="using-cluster-id"><a class="header" href="#using-cluster-id">Using Cluster Id</a></h3>
<p>When reading the cluster id of a remote peer, the local node MAY disconnect if their cluster id is different from the remote peer.</p>
<h3 id="using-shard-information"><a class="header" href="#using-shard-information">Using Shard Information</a></h3>
<p>It is NOT RECOMMENDED to disconnect from a peer based on the fact that their shard information is different from the local node.</p>
<p>Ahead of doing a shard-relevant request,
a node MAY use the previously received metadata shard information to select a peer that support the targeted shard.</p>
<p>For non-shard-relevant requests, a node SHOULD NOT discriminate a peer based on medata shard information.</p>
<h2 id="copyright-28"><a class="header" href="#copyright-28">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-25"><a class="header" href="#references-25">References</a></h2>
<ul>
<li><a href="waku/standards/core/66//waku/standards/core/10/waku2.html">10/WAKU2</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="waku-standards---application"><a class="header" href="#waku-standards---application">Waku Standards - Application</a></h1>
<p>Application-layer specifications built on top of Waku core protocols.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20toy-eth-pm"><a class="header" href="#20toy-eth-pm">20/TOY-ETH-PM</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Toy Ethereum Private Message</td></tr>
<tr><th>Slug</th><td>20</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Franck Royer &lt;franck@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-33"><a class="header" href="#timeline-33">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/application/20/toy-eth-pm.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/application/20/toy-eth-pm.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-09</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3b152e44b595456250c0f45288c4e2e6a87774e4/waku/standards/application/20/toy-eth-pm.md"><code>3b152e4</code></a> — 20/TOY-ETH-PM: Update (#141)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/application/20/toy-eth-pm.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/application/20/toy-eth-pm.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/89a94a5ba9e5d45f2563a9ede5ad4fe976d1cc54/waku/standards/application/20/toy-eth-pm.md"><code>89a94a5</code></a> — Update toy-eth-pm.md</li>
<li><strong>2024-01-30</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/c4ff509ce7ba84eaf60d9ddb6e273d0a06fbf32d/waku/standards/application/20/toy-eth-pm.md"><code>c4ff509</code></a> — Create toy-eth-pm.md</li>
<li><strong>2024-01-30</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/8841f4941ec2efd34126ce297c42722ab437b806/waku/informational/20/toy-eth-pm.md"><code>8841f49</code></a> — Update toy-eth-pm.md</li>
<li><strong>2024-01-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/a16a2b474d8f841f71fed42f6247539daa7c4d53/waku/informational/20/toy-eth-pm.md"><code>a16a2b4</code></a> — Create toy-eth-pm.md</li>
</ul>
<!-- timeline:end -->
<p><strong>Content Topics</strong>:</p>
<ul>
<li>Public Key Broadcast: <code>/eth-pm/1/public-key/proto</code></li>
<li>Private Message: <code>/eth-pm/1/private-message/proto</code></li>
</ul>
<h2 id="abstract-23"><a class="header" href="#abstract-23">Abstract</a></h2>
<p>This specification explains the Toy Ethereum Private Message protocol
which enables a peer to send an encrypted message to another peer
over the Waku network using the peer's Ethereum address.</p>
<h2 id="goal"><a class="header" href="#goal">Goal</a></h2>
<p>Alice wants to send an encrypted message to Bob,
where only Bob can decrypt the message.
Alice only knows Bob's Ethereum Address.</p>
<p>The goal of this specification
is to demonstrate how Waku can be used for encrypted messaging purposes,
using Ethereum accounts for identity.
This protocol caters to Web3 wallet restrictions,
allowing it to be implemented using standard Web3 API.
In the current state,
Toy Ethereum Private Message, ETH-PM, has privacy and features <a href="waku/standards/application/20/toy-eth-pm.html#limitations">limitations</a>,
has not been audited and hence is not fit for production usage.
We hope this can be an inspiration for developers
wishing to build on top of Waku.</p>
<h2 id="design-requirements-2"><a class="header" href="#design-requirements-2">Design Requirements</a></h2>
<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”,
“SHOULD NOT”, “RECOMMENDED”, “MAY”, and
“OPTIONAL” in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">2119</a>.</p>
<h2 id="variables"><a class="header" href="#variables">Variables</a></h2>
<p>Here are the variables used in the protocol and their definition:</p>
<ul>
<li><code>B</code> is Bob's Ethereum address (or account),</li>
<li><code>b</code> is the private key of <code>B</code>, and is only known by Bob.</li>
<li><code>B'</code> is Bob's Encryption Public Key, for which <code>b'</code> is the private key.</li>
<li><code>M</code> is the private message that Alice sends to Bob.</li>
</ul>
<p>The proposed protocol MUST adhere to the following design requirements:</p>
<ol>
<li>Alice knows Bob's Ethereum address</li>
<li>Bob is willing to participate to Eth-PM, and publishes <code>B'</code></li>
<li>Bob's ownership of <code>B'</code> MUST be verifiable</li>
<li>Alice wants to send message <code>M</code> to Bob</li>
<li>Bob SHOULD be able to get <code>M</code> using <a href="waku/standards/application/20/waku/standards/core/10/waku2.html">10/WAKU2</a></li>
<li>Participants only have access to their Ethereum Wallet via the Web3 API</li>
<li>Carole MUST NOT be able to read <code>M</code>'s content,
even if she is storing it or relaying it</li>
<li><a href="waku/standards/application/20/waku/standards/application/26/payload.html">Waku Message Version 1</a> Asymmetric Encryption
is used for encryption purposes.</li>
</ol>
<h2 id="limitations-1"><a class="header" href="#limitations-1">Limitations</a></h2>
<p>Alice's details are not included in the message's structure,
meaning that there is no programmatic way for Bob to reply to Alice
or verify her identity.</p>
<p>Private messages are sent on the same content topic for all users.
As the recipient data is encrypted,
all participants must decrypt all messages which can lead to scalability issues.</p>
<p>This protocol does not guarantee Perfect Forward Secrecy nor Future Secrecy:
If Bob's private key is compromised, past and future messages could be decrypted.
A solution combining regular <a href="https://www.signal.org/docs/specifications/x3dh/">X3DH</a>
bundle broadcast with <a href="https://signal.org/docs/specifications/doubleratchet/">Double Ratchet</a>
encryption would remove these limitations;
See the <a href="waku/standards/application/20/status/deprecated/secure-transport.html">Status secure transport specification</a>
for an example of a protocol that achieves this in a peer-to-peer setting.</p>
<p>Bob MUST decide to participate in the protocol before Alice can send him a message.
This is discussed in more detail in
<a href="waku/standards/application/20/toy-eth-pm.html#consideration-for-a-non-interactiveuncoordinated-protocol">Consideration for a non-interactive/uncoordinated protocol</a></p>
<h2 id="the-protocol"><a class="header" href="#the-protocol">The Protocol</a></h2>
<h3 id="generate-encryption-keypair"><a class="header" href="#generate-encryption-keypair">Generate Encryption KeyPair</a></h3>
<p>First, Bob needs to generate a keypair for Encryption purposes.</p>
<p>Bob SHOULD get 32 bytes from a secure random source as Encryption Private Key, <code>b'</code>.
Then Bob can compute the corresponding SECP-256k1 Public Key, <code>B'</code>.</p>
<h3 id="broadcast-encryption-public-key"><a class="header" href="#broadcast-encryption-public-key">Broadcast Encryption Public Key</a></h3>
<p>For Alice to encrypt messages for Bob,
Bob SHOULD broadcast his Encryption Public Key <code>B'</code>.
To prove that the Encryption Public Key <code>B'</code>
is indeed owned by the owner of Bob's Ethereum Account <code>B</code>,
Bob MUST sign <code>B'</code> using <code>B</code>.</p>
<h3 id="sign-encryption-public-key"><a class="header" href="#sign-encryption-public-key">Sign Encryption Public Key</a></h3>
<p>To prove ownership of the Encryption Public Key,
Bob must sign it using <a href="https://eips.ethereum.org/EIPS/eip-712">EIP-712</a> v3,
meaning calling <code>eth_signTypedData_v3</code> on his wallet's API.</p>
<p>Note: While v4 also exists, it is not available on all wallets and
the features brought by v4 is not needed for the current use case.</p>
<p>The <code>TypedData</code> to be passed to <code>eth_signTypedData_v3</code> MUST be as follows, where:</p>
<ul>
<li><code>encryptionPublicKey</code> is Bob's Encryption Public Key, <code>B'</code>,
in hex format, <strong>without</strong> <code>0x</code> prefix.</li>
<li><code>bobAddress</code> is Bob's Ethereum address, corresponding to <code>B</code>,
in hex format, <strong>with</strong> <code>0x</code> prefix.</li>
</ul>
<pre><code class="language-js">const typedData = {
    domain: {
      chainId: 1,
      name: 'Ethereum Private Message over Waku',
      version: '1',
    },
    message: {
      encryptionPublicKey: encryptionPublicKey,
      ownerAddress: bobAddress,
    },
    primaryType: 'PublishEncryptionPublicKey',
    types: {
      EIP712Domain: [
        { name: 'name', type: 'string' },
        { name: 'version', type: 'string' },
        { name: 'chainId', type: 'uint256' },
      ],
      PublishEncryptionPublicKey: [
        { name: 'encryptionPublicKey', type: 'string' },
        { name: 'ownerAddress', type: 'string' },
      ],
    },
  }
</code></pre>
<h3 id="public-key-message"><a class="header" href="#public-key-message">Public Key Message</a></h3>
<p>The resulting signature is then included in a <code>PublicKeyMessage</code>, where</p>
<ul>
<li><code>encryption_public_key</code> is Bob's Encryption Public Key <code>B'</code>, not compressed,</li>
<li><code>eth_address</code> is Bob's Ethereum Address <code>B</code>,</li>
<li><code>signature</code> is the EIP-712 as described above.</li>
</ul>
<pre><code class="language-protobuf">syntax = "proto3";

message PublicKeyMessage {
   bytes encryption_public_key = 1;
   bytes eth_address = 2;
   bytes signature = 3;
}
</code></pre>
<p>This MUST be wrapped in a <a href="waku/standards/application/20//waku/standards/core/14/message.html">14/WAKU-MESSAGE</a> version 0,
with the Public Key Broadcast content topic.
Finally, Bob SHOULD publish the message on Waku.</p>
<h2 id="consideration-for-a-non-interactiveuncoordinated-protocol"><a class="header" href="#consideration-for-a-non-interactiveuncoordinated-protocol">Consideration for a non-interactive/uncoordinated protocol</a></h2>
<p>Alice has to get Bob's public Key to send a message to Bob.
Because an Ethereum Address is part of the hash of the public key's account,
it is not enough in itself to deduce Bob's Public Key.</p>
<p>This is why the protocol dictates that Bob MUST send his Public Key first,
and Alice MUST receive it before she can send him a message.</p>
<p>Moreover, nwaku, the reference implementation of <a href="waku/standards/application/20//waku/standards/core/13/store.html">13/WAKU2-STORE</a>,
stores messages for a maximum period of 30 days.
This means that Bob would need to broadcast his public key
at least every 30 days to be reachable.</p>
<p>Below we are reviewing possible solutions to mitigate this "sign up" step.</p>
<h3 id="retrieve-the-public-key-from-the-blockchain"><a class="header" href="#retrieve-the-public-key-from-the-blockchain">Retrieve the public key from the blockchain</a></h3>
<p>If Bob has signed at least one transaction with his account
then his Public Key can be extracted from the transaction's ECDSA signature.
The challenge with this method is that standard Web3 Wallet API
does not allow Alice to specifically retrieve all/any transaction sent by Bob.</p>
<p>Alice would instead need to use the <code>eth.getBlock</code> API
to retrieve Ethereum blocks one by one.
For each block, she would need to check the <code>from</code> value of each transaction
until she finds a transaction sent by Bob.</p>
<p>This process is resource intensive and
can be slow when using services such as Infura due to rate limits in place,
which makes it inappropriate for a browser or mobile phone environment.</p>
<p>An alternative would be to either run a backend
that can connect directly to an Ethereum node,
use a centralized blockchain explorer
or use a decentralized indexing service such as <a href="https://thegraph.com/">The Graph</a>.</p>
<p>Note that these would resolve a UX issue
only if a sender wants to proceed with <em>air drops</em>.</p>
<p>Indeed, if Bob does not publish his Public Key in the first place
then it MAY be an indication that he does not participate in this protocol
and hence will not receive messages.</p>
<p>However, these solutions would be helpful
if the sender wants to proceed with an <em>air drop</em> of messages:
Send messages over Waku for users to retrieve later,
once they decide to participate in this protocol.
Bob may not want to participate first but may decide to participate at a later stage
and would like to access previous messages.
This could make sense in an NFT offer scenario:
Users send offers to any NFT owner,
NFT owner may decide at some point to participate in the protocol and
retrieve previous offers.</p>
<h3 id="publishing-the-public-in-long-term-storage"><a class="header" href="#publishing-the-public-in-long-term-storage">Publishing the public in long term storage</a></h3>
<p>Another improvement would be for Bob not having to re-publish his public key
every 30 days or less.
Similarly to above,
if Bob stops publishing his public key
then it MAY be an indication that he does not participate in the protocol anymore.</p>
<p>In any case,
the protocol could be modified to store the Public Key in a more permanent storage,
such as a dedicated smart contract on the blockchain.</p>
<h2 id="send-private-message"><a class="header" href="#send-private-message">Send Private Message</a></h2>
<p>Alice MAY monitor the Waku network to collect Ethereum Address and
Encryption Public Key tuples.
Alice SHOULD verify that the <code>signature</code>s of <code>PublicKeyMessage</code>s she receives
are valid as per EIP-712.
She SHOULD drop any message without a signature or with an invalid signature.</p>
<p>Using Bob's Encryption Public Key,
retrieved via <a href="waku/standards/application/20//waku/standards/core/10/waku2.html">10/WAKU2</a>,
Alice MAY now send an encrypted message to Bob.</p>
<p>If she wishes to do so,
Alice MUST encrypt her message <code>M</code> using Bob's Encryption Public Key <code>B'</code>,
as per <a href="waku/standards/application/20/waku/standards/application/26/payload.html">26/WAKU-PAYLOAD Asymmetric Encryption specs</a>.</p>
<p>Alice SHOULD now publish this message on the Private Message content topic.</p>
<h2 id="copyright-29"><a class="header" href="#copyright-29">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-26"><a class="header" href="#references-26">References</a></h2>
<ul>
<li><a href="waku/standards/application/20//waku/standards/core/10/waku2.html">10/WAKU2</a></li>
<li><a href="waku/standards/application/20/waku/standards/application/26/payload.html">Waku Message Version 1</a></li>
<li><a href="https://www.signal.org/docs/specifications/x3dh/">X3DH</a></li>
<li><a href="https://signal.org/docs/specifications/doubleratchet/">Double Ratchet</a></li>
<li><a href="waku/standards/application/20/status/deprecated/secure-transport.html">Status secure transport specification</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-712">EIP-712</a></li>
<li><a href="waku/standards/application/20//waku/standards/core/13/store.html">13/WAKU2-STORE</a></li>
<li><a href="https://thegraph.com/">The Graph</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="26waku2-payload"><a class="header" href="#26waku2-payload">26/WAKU2-PAYLOAD</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku Message Payload Encryption</td></tr>
<tr><th>Slug</th><td>26</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Oskar Thoren &lt;oskarth@titanproxy.com&gt;</td></tr>
<tr><th>Contributors</th><td>Oskar Thoren &lt;oskarth@titanproxy.com&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-34"><a class="header" href="#timeline-34">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/application/26/payload.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/application/26/payload.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-03-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/f08de108457eed828dadbd36339433c586701267/waku/standards/application/26/payload.md"><code>f08de10</code></a> — 26/WAKU2-PAYLOADS: Update (#136)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/application/26/payload.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/application/26/payload.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/33cf551676123ef90340f5fa909084675d51e8cd/waku/standards/application/26/payload.md"><code>33cf551</code></a> — Update payload.md</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/29acb80f5333aaa5f5e829520fa49d2820bd550e/waku/standards/application/26/payload.md"><code>29acb80</code></a> — Rename README.md to payload.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/standards/application/26/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/7bd071220d54b345d477bf4041c593c4da4d4a53/waku/rfcs/standards/application/26/README.md"><code>7bd0712</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-24"><a class="header" href="#abstract-24">Abstract</a></h2>
<p>This specification describes how Waku provides confidentiality, authenticity, and
integrity, as well as some form of unlinkability.
Specifically, it describes how encryption, decryption and
signing works in <a href="waku/standards/application/26/waku/standards/legacy/6/waku1.html">6/WAKU1</a> and
in <a href="waku/standards/application/26/waku/standards/core/10/waku2.html">10/WAKU2</a> with <a href="waku/standards/application/26/waku/standards/core/14/message.html">14/WAKU-MESSAGE</a>.</p>
<p>This specification effectively replaces <a href="waku/standards/application/26/waku/standards/legacy/7/data.html">7/WAKU-DATA</a>
as well as <a href="waku/standards/application/26/waku/standards/legacy/6/waku1.html">6/WAKU1 Payload encryption</a>
but written in a way that is agnostic and self-contained for <a href="waku/standards/application/26/waku/standards/legacy/6/waku1.html">6/WAKU1</a> and <a href="waku/standards/application/26/waku/standards/core/10/waku2.html">10/WAKU2</a>.</p>
<p>Large sections of the specification originate from
<a href="https://eips.ethereum.org/EIPS/eip-627">EIP-627: Whisper spec</a> as well from
<a href="https://github.com/ethereum/devp2p/blob/master/rlpx.md#ecies-encryption">RLPx Transport Protocol spec (ECIES encryption)</a>
with some modifications.</p>
<h2 id="specification-3"><a class="header" href="#specification-3">Specification</a></h2>
<p>The keywords “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”,
“SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and
“OPTIONAL” in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">2119</a>.</p>
<p>For <a href="waku/standards/application/26/waku/standards/legacy/6/waku1.html">6/WAKU1</a>,
the <code>data</code> field is used in the <a href="waku/standards/application/26/waku/standards/legacy/6/waku1.html#abnf-specification">waku envelope</a>
and the field MAY contain the encrypted payload.</p>
<p>For <a href="waku/standards/application/26/waku/standards/core/10/waku2.html">10/WAKU2</a>,
the <code>payload</code> field is used in <code>WakuMessage</code>
and MAY contain the encrypted payload.</p>
<p>The fields that are concatenated and
encrypted as part of the <code>data</code> (Waku legacy) or
<code>payload</code> (Waku) field are:</p>
<ul>
<li><code>flags</code></li>
<li><code>payload-length</code></li>
<li><code>payload</code></li>
<li><code>padding</code></li>
<li><code>signature</code></li>
</ul>
<h2 id="design-requirements-3"><a class="header" href="#design-requirements-3">Design requirements</a></h2>
<ul>
<li><em>Confidentiality</em>:
The adversary SHOULD NOT be able to learn what data is being sent from one Waku node
to one or several other Waku nodes.</li>
<li><em>Authenticity</em>:
The adversary SHOULD NOT be able to cause Waku endpoint
to accept data from any third party as though it came from the other endpoint.</li>
<li><em>Integrity</em>:
The adversary SHOULD NOT be able to cause a Waku endpoint to
accept data that has been tampered with.</li>
</ul>
<p>Notable, <em>forward secrecy</em> is not provided for at this layer.
If this property is desired,
a more fully featured secure communication protocol can be used on top.</p>
<p>It also provides some form of <em>unlinkability</em> since:</p>
<ul>
<li>only participants who are able to decrypt a message can see its signature</li>
<li>payload are padded to a fixed length</li>
</ul>
<h2 id="cryptographic-primitives"><a class="header" href="#cryptographic-primitives">Cryptographic primitives</a></h2>
<ul>
<li>AES-256-GCM (for symmetric encryption)</li>
<li>ECIES</li>
<li>ECDSA</li>
<li>KECCAK-256</li>
</ul>
<p>ECIES is using the following cryptosystem:</p>
<ul>
<li>Curve: secp256k1</li>
<li>KDF: NIST SP 800-56 Concatenation Key Derivation Function, with SHA-256 option</li>
<li>MAC: HMAC with SHA-256</li>
<li>AES: AES-128-CTR</li>
</ul>
<h3 id="abnf"><a class="header" href="#abnf">ABNF</a></h3>
<p>Using <a href="https://tools.ietf.org/html/rfc5234">Augmented Backus-Naur form (ABNF)</a>
we have the following format:</p>
<pre><code class="language-abnf">; 1 byte; first two bits contain the size of payload-length field,
; third bit indicates whether the signature is present.
flags           = 1OCTET

; contains the size of payload.
payload-length  = 4*OCTET

; byte array of arbitrary size (may be zero).
payload         = *OCTET

; byte array of arbitrary size (may be zero).
padding         = *OCTET

; 65 bytes, if present.
signature       = 65OCTET

data            = flags payload-length payload padding [signature]

; This field is called payload in Waku
payload         = data
</code></pre>
<h3 id="signature-1"><a class="header" href="#signature-1">Signature</a></h3>
<p>Those unable to decrypt the payload/data are also unable to access the signature.
The signature, if provided,
SHOULD be the ECDSA signature of the Keccak-256 hash of the unencrypted data
using the secret key of the originator identity.
The signature is serialized as the concatenation of the <code>r</code>, <code>s</code> and <code>v</code> parameters
of the SECP-256k1 ECDSA signature, in that order.
<code>r</code> and <code>s</code> MUST be big-endian encoded, fixed-width 256-bit unsigned.
<code>v</code> MUST be an 8-bit big-endian encoded,
non-normalized and should be either 27 or 28.</p>
<p>See <a href="https://ethereum.github.io/yellowpaper/paper.pdf">Ethereum "Yellow paper": Appendix F Signing transactions</a>
for more information on signature generation, parameters and public key recovery.</p>
<h3 id="encryption-2"><a class="header" href="#encryption-2">Encryption</a></h3>
<h4 id="symmetric"><a class="header" href="#symmetric">Symmetric</a></h4>
<p>Symmetric encryption uses AES-256-GCM for
<a href="https://en.wikipedia.org/wiki/Authenticated_encryption">authenticated encryption</a>.
The output of encryption is of the form (<code>ciphertext</code>, <code>tag</code>, <code>iv</code>)
where <code>ciphertext</code> is the encrypted message,
<code>tag</code> is a 16 byte message authentication tag and
<code>iv</code> is a 12 byte initialization vector (nonce).
The message authentication <code>tag</code> and
initialization vector <code>iv</code> field MUST be appended to the resulting <code>ciphertext</code>,
in that order.
Note that previous specifications and
some implementations might refer to <code>iv</code> as <code>nonce</code> or <code>salt</code>.</p>
<h4 id="asymmetric"><a class="header" href="#asymmetric">Asymmetric</a></h4>
<p>Asymmetric encryption uses the standard Elliptic Curve Integrated Encryption Scheme
(ECIES) with SECP-256k1 public key.</p>
<h4 id="ecies"><a class="header" href="#ecies">ECIES</a></h4>
<p>This section originates from the <a href="https://github.com/ethereum/devp2p/blob/master/rlpx.md#ecies-encryption">RLPx Transport Protocol spec</a>
specification with minor modifications.</p>
<p>The cryptosystem used is:</p>
<ul>
<li>The elliptic curve secp256k1 with generator <code>G</code>.</li>
<li><code>KDF(k, len)</code>: the NIST SP 800-56 Concatenation Key Derivation Function.</li>
<li><code>MAC(k, m)</code>: HMAC using the SHA-256 hash function.</li>
<li><code>AES(k, iv, m)</code>: the AES-128 encryption function in CTR mode.</li>
</ul>
<p>Special notation used: <code>X || Y</code> denotes concatenation of <code>X</code> and <code>Y</code>.</p>
<p>Alice wants to send an encrypted message that can be decrypted by
Bob's static private key <code>kB</code>.
Alice knows about Bobs static public key <code>KB</code>.</p>
<p>To encrypt the message <code>m</code>, Alice generates a random number <code>r</code> and
corresponding elliptic curve public key <code>R = r * G</code> and
computes the shared secret <code>S = Px</code> where <code>(Px, Py) = r * KB</code>.
She derives key material for encryption and
authentication as <code>kE || kM = KDF(S, 32)</code>
as well as a random initialization vector <code>iv</code>.
Alice sends the encrypted message <code>R || iv || c || d</code> where <code>c = AES(kE, iv , m)</code>
and <code>d = MAC(sha256(kM), iv || c)</code> to Bob.</p>
<p>For Bob to decrypt the message <code>R || iv || c || d</code>,
he derives the shared secret <code>S = Px</code> where <code>(Px, Py) = kB * R</code>
as well as the encryption and authentication keys <code>kE || kM = KDF(S, 32)</code>.
Bob verifies the authenticity of the message
by checking whether <code>d == MAC(sha256(kM), iv || c)</code>
then obtains the plaintext as <code>m = AES(kE, iv || c)</code>.</p>
<h3 id="padding"><a class="header" href="#padding">Padding</a></h3>
<p>The <code>padding</code> field is used to align data size,
since data size alone might reveal important metainformation.
Padding can be arbitrary size.
However, it is recommended that the size of <code>data</code> field
(excluding the <code>iv</code> and <code>tag</code>) before encryption (i.e. plain text)
SHOULD be a multiple of 256 bytes.</p>
<h3 id="decoding-a-message"><a class="header" href="#decoding-a-message">Decoding a message</a></h3>
<p>In order to decode a message, a node SHOULD try to apply both symmetric and
asymmetric decryption operations.
This is because the type of encryption is not included in the message.</p>
<h2 id="copyright-30"><a class="header" href="#copyright-30">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-27"><a class="header" href="#references-27">References</a></h2>
<ol>
<li><a href="waku/standards/application/26/waku/standards/legacy/6/waku1.html">6/WAKU1</a></li>
<li><a href="waku/standards/application/26/waku/standards/core/10/waku2.html">10/WAKU2 spec</a></li>
<li><a href="waku/standards/application/26/waku/standards/core/14/message.html">14/WAKU-MESSAGE version 1</a></li>
<li><a href="waku/standards/application/26/waku/standards/legacy/7/data.html">7/WAKU-DATA</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-627">EIP-627: Whisper spec</a></li>
<li><a href="https://github.com/ethereum/devp2p/blob/master/rlpx.md#ecies-encryption">RLPx Transport Protocol spec (ECIES encryption)</a></li>
<li><a href="waku/standards/application/26/status/deprecated/secure-transport.html">Status 5/SECURE-TRANSPORT</a></li>
<li><a href="https://tools.ietf.org/html/rfc5234">Augmented Backus-Naur form (ABNF)</a></li>
<li><a href="https://ethereum.github.io/yellowpaper/paper.pdf">Ethereum "Yellow paper": Appendix F Signing transactions</a></li>
<li><a href="https://en.wikipedia.org/wiki/Authenticated_encryption">authenticated encryption</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="53waku2-x3dh"><a class="header" href="#53waku2-x3dh">53/WAKU2-X3DH</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>X3DH usage for Waku payload encryption</td></tr>
<tr><th>Slug</th><td>53</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Aaryamann Challani &lt;p1ge0nh8er@proton.me&gt;</td></tr>
<tr><th>Contributors</th><td>Andrea Piana &lt;andreap@status.im&gt;<br>Pedro Pombeiro &lt;pedro@status.im&gt;<br>Corey Petty &lt;corey@status.im&gt;<br>Oskar Thorén &lt;oskarth@titanproxy.com&gt;<br>Dean Eigenmann &lt;dean@status.im&gt;<br>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-35"><a class="header" href="#timeline-35">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/application/53/x3dh.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/application/53/x3dh.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-07-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b60abdb2fff9b4e70d862eb2550b5225b417a311/waku/standards/application/53/x3dh.md"><code>b60abdb</code></a> — update waku/standards/application/53/x3dh.md (#150)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/application/53/x3dh.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-08-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eb25cd06d679e94409072a96841de16a6b3910d5/waku/standards/application/53/x3dh.md"><code>eb25cd0</code></a> — chore: replace email addresses (#86)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/application/53/x3dh.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/51567b183115c0300c9760a104fceac7e9329475/waku/standards/application/53/x3dh.md"><code>51567b1</code></a> — Rename X3DH.md to x3dh.md</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/9fd32660a085cc8b0a8fb16affd834f031c4c7c7/waku/standards/application/53/X3DH.md"><code>9fd3266</code></a> — Update and rename README.md to X3DH.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/standards/application/53/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/5e95a1af46b2261b550e99f9b6e79dc5fa56b69e/waku/rfcs/standards/application/53/README.md"><code>5e95a1a</code></a> — Rename README.md to README.md</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/555eb2093afb06c2e39b29951606dc14a9dd6448/waku/rfcs/standards/application/53-X3DH/README.md"><code>555eb20</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-25"><a class="header" href="#abstract-25">Abstract</a></h2>
<p>This document describes a method that can be used to provide a secure channel
between two peers, and thus provide confidentiality, integrity,
authenticity and forward secrecy.
It is transport-agnostic and works over asynchronous networks.</p>
<p>It builds on the <a href="https://signal.org/docs/specifications/x3dh/">X3DH</a>
and <a href="https://signal.org/docs/specifications/doubleratchet/">Double Ratchet</a> specifications,
with some adaptations to operate in a decentralized environment.</p>
<h2 id="motivation-17"><a class="header" href="#motivation-17">Motivation</a></h2>
<p>Nodes on a network may want to communicate with each other in a secure manner,
without other nodes network being able to read their messages.</p>
<h2 id="specification-4"><a class="header" href="#specification-4">Specification</a></h2>
<h3 id="definitions-3"><a class="header" href="#definitions-3">Definitions</a></h3>
<ul>
<li>
<p><strong>Perfect Forward Secrecy</strong> is a feature of specific key-agreement protocols
which provide assurances that session keys will not be compromised
even if the private keys of the participants are compromised.
Specifically, past messages cannot be decrypted by a third-party
who manages to obtain those private key.</p>
</li>
<li>
<p><strong>Secret channel</strong> describes a communication channel
where a Double Ratchet algorithm is in use.</p>
</li>
</ul>
<h3 id="design-requirements-4"><a class="header" href="#design-requirements-4">Design Requirements</a></h3>
<ul>
<li><strong>Confidentiality</strong>:
The adversary should not be able to learn what data is being exchanged
between two Status clients.</li>
<li><strong>Authenticity</strong>:
The adversary should not be able to cause either endpoint
to accept data from any third party as though it came from the other endpoint.</li>
<li><strong>Forward Secrecy</strong>:
The adversary should not be able to learn what data was exchanged
between two clients if, at some later time,
the adversary compromises one or both of the endpoints.</li>
<li><strong>Integrity</strong>:
The adversary should not be able to cause either endpoint
to accept data that has been tampered with.</li>
</ul>
<p>All of these properties are ensured by the use of <a href="https://signal.org/docs/specifications/doubleratchet/">Signal's Double Ratchet</a></p>
<h3 id="conventions-1"><a class="header" href="#conventions-1">Conventions</a></h3>
<p>Types used in this specification are defined using the
<a href="https://developers.google.com/protocol-buffers/">Protobuf</a> wire format.</p>
<h3 id="end-to-end-encryption"><a class="header" href="#end-to-end-encryption">End-to-End Encryption</a></h3>
<p>End-to-end encryption (E2EE) takes place between two clients.
The main cryptographic protocol is a Double Ratchet protocol,
which is derived from the
<a href="https://otr.cypherpunks.ca/Protocol-v3-4.1.1.html">Off-the-Record protocol</a>,
using a different ratchet.
<a href="waku/standards/application/53//waku/standards/core/10/waku2.html">The Waku v2 protocol</a>
subsequently encrypts the message payload, using symmetric key encryption.
Furthermore, the concept of prekeys
(through the use of <a href="https://signal.org/docs/specifications/x3dh/">X3DH</a>)
is used to allow the protocol to operate in an asynchronous environment.
It is not necessary for two parties to be online at the same time
to initiate an encrypted conversation.</p>
<h3 id="cryptographic-protocols"><a class="header" href="#cryptographic-protocols">Cryptographic Protocols</a></h3>
<p>This protocol uses the following cryptographic primitives:</p>
<ul>
<li>X3DH
<ul>
<li>Elliptic curve Diffie-Hellman key exchange (secp256k1)</li>
<li>KECCAK-256</li>
<li>ECDSA</li>
<li>ECIES</li>
</ul>
</li>
<li>Double Ratchet
<ul>
<li>
<p>HMAC-SHA-256 as MAC</p>
</li>
<li>
<p>Elliptic curve Diffie-Hellman key exchange (Curve25519)</p>
</li>
<li>
<p>AES-256-CTR with HMAC-SHA-256 and IV derived alongside an encryption key</p>
<p>The node achieves key derivation using <a href="https://www.rfc-editor.org/rfc/rfc5869">HKDF</a>.</p>
</li>
</ul>
</li>
</ul>
<h3 id="pre-keys"><a class="header" href="#pre-keys">Pre-keys</a></h3>
<p>Every client SHOULD initially generate some key material which is stored locally:</p>
<ul>
<li>Identity keypair based on secp256k1 - <code>IK</code></li>
<li>A signed prekey based on secp256k1 - <code>SPK</code></li>
<li>A prekey signature - <code>Sig(IK, Encode(SPK))</code></li>
</ul>
<p>More details can be found in the <code>X3DH Prekey bundle creation</code> section of <a href="https://specs.status.im/spec/2#x3dh-prekey-bundles">2/ACCOUNT</a>.</p>
<p>Prekey bundles MAY be extracted from any peer's messages,
or found via searching for their specific topic, <code>{IK}-contact-code</code>.</p>
<p>The following methods can be used to retrieve prekey bundles from a peer's messages:</p>
<ul>
<li>contact codes;</li>
<li>public and one-to-one chats;</li>
<li>QR codes;</li>
<li>ENS record;</li>
<li>Decentralized permanent storage (e.g. Swarm, IPFS).</li>
<li>Waku</li>
</ul>
<p>Waku SHOULD be used for retrieving prekey bundles.</p>
<p>Since bundles stored in QR codes or
ENS records cannot be updated to delete already used keys,
the bundle MAY be rotated every 24 hours, and distributed via Waku.</p>
<h3 id="flow-7"><a class="header" href="#flow-7">Flow</a></h3>
<p>The key exchange can be summarized as follows:</p>
<ol>
<li>
<p>Initial key exchange: Two parties, Alice and Bob, exchange their prekey bundles,
and derive a shared secret.</p>
</li>
<li>
<p>Double Ratchet:
The two parties use the shared secret to derive a new encryption key
for each message they send.</p>
</li>
<li>
<p>Chain key update: The two parties update their chain keys.
The chain key is used to derive new encryption keys for future messages.</p>
</li>
<li>
<p>Message key derivation:
The two parties derive a new message key from their chain key, and
use it to encrypt a message.</p>
</li>
</ol>
<h4 id="1-initial-key-exchange-flow-x3dh"><a class="header" href="#1-initial-key-exchange-flow-x3dh">1. Initial key exchange flow (X3DH)</a></h4>
<p><a href="https://signal.org/docs/specifications/x3dh/#sending-the-initial-message">Section 3 of the X3DH protocol</a>
describes the initial key exchange flow, with some additional context:</p>
<ul>
<li>The peers' identity keys <code>IK_A</code> and <code>IK_B</code> correspond to their public keys;</li>
<li>Since it is not possible to guarantee that a prekey will be used only once
in a decentralized world, the one-time prekey <code>OPK_B</code> is not used in this scenario;</li>
<li>Nodes SHOULD not send Bundles to a centralized server,
but instead provide them in a decentralized way as described in the <a href="waku/standards/application/53/x3dh.html#pre-keys">Pre-keys section</a>.</li>
</ul>
<p>Alice retrieves Bob's prekey bundle, however it is not specific to Alice.
It contains:</p>
<p>(<a href="https://github.com/status-im/status-go/blob/a904d9325e76f18f54d59efc099b63293d3dcad3/services/shhext/chat/encryption.proto#L12">reference wire format</a>)</p>
<p><strong>Wire format:</strong></p>
<pre><code class="language-protobuf">// X3DH prekey bundle
message Bundle {
  // Identity key 'IK_B'
  bytes identity = 1;
  // Signed prekey 'SPK_B' for each device, indexed by 'installation-id'
  map&lt;string,SignedPreKey&gt; signed_pre_keys = 2;
  // Prekey signature 'Sig(IK_B, Encode(SPK_B))'
  bytes signature = 4;
  // When the bundle was created locally
  int64 timestamp = 5;
}
</code></pre>
<p>(<a href="https://github.com/status-im/status-go/blob/a904d9325e76f18f54d59efc099b63293d3dcad3/services/shhext/chat/encryption.proto#L5">reference wire format</a>)</p>
<pre><code class="language-protobuf">message SignedPreKey {
  bytes signed_pre_key = 1;
  uint32 version = 2;
}
</code></pre>
<p>The <code>signature</code> is generated by sorting <code>installation-id</code> in lexicographical order,
and concatenating the <code>signed-pre-key</code> and <code>version</code>:</p>
<p><code>installation-id-1signed-pre-key1version1installation-id2signed-pre-key2-version-2</code></p>
<h4 id="2-double-ratchet"><a class="header" href="#2-double-ratchet">2. Double Ratchet</a></h4>
<p>Having established the initial shared secret <code>SK</code> through X3DH,
it SHOULD be used to seed a Double Ratchet exchange between Alice and Bob.</p>
<p>Refer to the <a href="https://signal.org/docs/specifications/doubleratchet/">Double Ratchet spec</a>
for more details.</p>
<p>The initial message sent by Alice to Bob is sent as a top-level <code>ProtocolMessage</code>
(<a href="https://github.com/status-im/status-go/blob/a904d9325e76f18f54d59efc099b63293d3dcad3/services/shhext/chat/encryption.proto#L65">reference wire format</a>)
containing a map of <code>DirectMessageProtocol</code> indexed by <code>installation-id</code>
(<a href="https://github.com/status-im/status-go/blob/1ac9dd974415c3f6dee95145b6644aeadf02f02c/services/shhext/chat/encryption.proto#L56">reference wire format</a>):</p>
<pre><code class="language-protobuf">message ProtocolMessage {
  // The installation id of the sender
  string installation_id = 2;
  // A sequence of bundles
  repeated Bundle bundles = 3;
  // One to one message, encrypted, indexed by installation_id
  map&lt;string,DirectMessageProtocol&gt; direct_message = 101;
  // Public message, not encrypted
  bytes public_message = 102;
}
</code></pre>
<pre><code class="language-protobuf">message EncryptedMessageProtocol {
  X3DHHeader X3DH_header = 1;
  DRHeader DR_header = 2; 
  DHHeader DH_header = 101;
  // Encrypted payload
  // if a bundle is available, contains payload encrypted with the Double Ratchet algorithm;
  // otherwise, payload encrypted with output key of DH exchange (no Perfect Forward Secrecy).
  bytes payload = 3;
}
</code></pre>
<p>Where:</p>
<ul>
<li>
<p><code>X3DH_header</code>: the <code>X3DHHeader</code> field in <code>DirectMessageProtocol</code> contains:</p>
<p>(<a href="https://github.com/status-im/status-go/blob/a904d9325e76f18f54d59efc099b63293d3dcad3/services/shhext/chat/encryption.proto#L47">reference wire format</a>)</p>
</li>
</ul>
<pre><code class="language-protobuf">message X3DHHeader {
  // Alice's ephemeral key `EK_A`
  bytes key = 1;
  // Bob's bundle signed prekey
  bytes id = 4;
}
</code></pre>
<ul>
<li><code>DR_header</code>: Double ratchet header (<a href="https://github.com/status-im/status-go/blob/a904d9325e76f18f54d59efc099b63293d3dcad3/services/shhext/chat/encryption.proto#L31">reference wire format</a>).
Used when Bob's public bundle is available:</li>
</ul>
<pre><code class="language-protobuf">message DRHeader {
  // Alice's current ratchet public key
  bytes key = 1;
  // number of the message in the sending chain
  uint32 n = 2;
  // length of the previous sending chain
  uint32 pn = 3;
  // Bob's bundle ID
  bytes id = 4;
}
</code></pre>
<p>Alice's current ratchet public key (above) is mentioned in
<a href="https://signal.org/docs/specifications/doubleratchet/#symmetric-key-ratchet">DR spec section 2.2</a></p>
<ul>
<li><code>DH_header</code>: Diffie-Hellman header (used when Bob's bundle is not available):
(<a href="https://github.com/status-im/status-go/blob/a904d9325e76f18f54d59efc099b63293d3dcad3/services/shhext/chat/encryption.proto#L42">reference wire format</a>)</li>
</ul>
<pre><code class="language-protobuf">message DHHeader {
  // Alice's compressed ephemeral public key.
  bytes key = 1;
}
</code></pre>
<h4 id="3-chain-key-update"><a class="header" href="#3-chain-key-update">3. Chain key update</a></h4>
<p>The chain key MUST be updated according to the <code>DR_Header</code>
received in the <code>EncryptedMessageProtocol</code> message,
described in <a href="waku/standards/application/53/x3dh.html#2-double-ratchet">2.Double Ratchet</a>.</p>
<h4 id="4-message-key-derivation"><a class="header" href="#4-message-key-derivation">4. Message key derivation</a></h4>
<p>The message key MUST be derived from a single ratchet step in the symmetric-key ratchet
as described in <a href="https://signal.org/docs/specifications/doubleratchet/#symmetric-key-ratchet">Symmetric key ratchet</a></p>
<p>The message key MUST be used to encrypt the next message to be sent.</p>
<h2 id="security-considerations-9"><a class="header" href="#security-considerations-9">Security Considerations</a></h2>
<ol>
<li>
<p>Inherits the security considerations of <a href="https://signal.org/docs/specifications/x3dh/#security-considerations">X3DH</a>
and <a href="https://signal.org/docs/specifications/doubleratchet/#security-considerations">Double Ratchet</a>.</p>
</li>
<li>
<p>Inherits the security considerations of the <a href="waku/standards/application/53//waku/standards/core/10/waku2.html">Waku v2 protocol</a>.</p>
</li>
<li>
<p>The protocol is designed to be used in a decentralized manner, however,
it is possible to use a centralized server to serve prekey bundles.
In this case, the server is trusted.</p>
</li>
</ol>
<h2 id="privacy-considerations-1"><a class="header" href="#privacy-considerations-1">Privacy Considerations</a></h2>
<ol>
<li>This protocol does not provide message unlinkability.
It is possible to link messages signed by the same keypair.</li>
</ol>
<h2 id="copyright-31"><a class="header" href="#copyright-31">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-28"><a class="header" href="#references-28">References</a></h2>
<ul>
<li><a href="https://signal.org/docs/specifications/x3dh/">X3DH</a></li>
<li><a href="https://signal.org/docs/specifications/doubleratchet/">Double Ratchet</a></li>
<li><a href="https://signal.org/docs/specifications/doubleratchet/">Signal's Double Ratchet</a></li>
<li><a href="https://developers.google.com/protocol-buffers/">Protobuf</a></li>
<li><a href="https://otr.cypherpunks.ca/Protocol-v3-4.1.1.html">Off-the-Record protocol</a></li>
<li><a href="waku/standards/application/53//waku/standards/core/10/waku2.html">The Waku v2 protocol</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc5869">HKDF</a></li>
<li><a href="https://specs.status.im/spec/2#x3dh-prekey-bundles">2/ACCOUNT</a></li>
<li><a href="https://github.com/status-im/status-go/blob/a904d9325e76f18f54d59efc099b63293d3dcad3/services/shhext/chat/encryption.proto#L12">reference wire format</a></li>
<li><a href="https://signal.org/docs/specifications/doubleratchet/#symmetric-key-ratchet">Symmetric key ratchet</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="54waku2-x3dh-sessions"><a class="header" href="#54waku2-x3dh-sessions">54/WAKU2-X3DH-SESSIONS</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Session management for Waku X3DH</td></tr>
<tr><th>Slug</th><td>54</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Aaryamann Challani &lt;p1ge0nh8er@proton.me&gt;</td></tr>
<tr><th>Contributors</th><td>Andrea Piana &lt;andreap@status.im&gt;<br>Pedro Pombeiro &lt;pedro@status.im&gt;<br>Corey Petty &lt;corey@status.im&gt;<br>Oskar Thorén &lt;oskarth@titanproxy.com&gt;<br>Dean Eigenmann &lt;dean@status.im&gt;<br>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-36"><a class="header" href="#timeline-36">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/application/54/x3dh-sessions.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/application/54/x3dh-sessions.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-24</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/db365cb756716fb76731c7988d41e9af9a850bc2/waku/standards/application/54/x3dh-sessions.md"><code>db365cb</code></a> — update waku/standards/application/54/x3dh-sessions.md (#151)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/application/54/x3dh-sessions.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-08-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eb25cd06d679e94409072a96841de16a6b3910d5/waku/standards/application/54/x3dh-sessions.md"><code>eb25cd0</code></a> — chore: replace email addresses (#86)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/application/54/x3dh-sessions.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/0e490d46bb99c2fbae1ac193fbdfc11d84fb080d/waku/standards/application/54/x3dh-sessions.md"><code>0e490d4</code></a> — Rename X3DH-sessions.md to x3dh-sessions.md</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/7f8b187f1b8b77af0c88c9fb154144494a7dfb7d/waku/standards/application/54/X3DH-sessions.md"><code>7f8b187</code></a> — Update and rename README.md to X3DH-sessions.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/a22c2a0d79058ab435fcd38fe17a9f19021d5cd4/waku/standards/application/54/README.md"><code>a22c2a0</code></a> — Rename README.md to README.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/standards/application/56/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/484df92848f90025fc538c19616fff904d72bc26/waku/rfcs/standards/application/56/README.md"><code>484df92</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-26"><a class="header" href="#abstract-26">Abstract</a></h2>
<p>This document specifies how to manage sessions based on an X3DH key exchange.
This includes how to establish new sessions,
how to re-establish them, how to maintain them, and how to close them.</p>
<p><a href="waku/standards/application/54//waku/standards/application/53/x3dh.html">53/WAKU2-X3DH</a> specifies the Waku <code>X3DH</code> protocol
for end-to-end encryption.
Once two peers complete an X3DH handshake, they SHOULD establish an X3DH session.</p>
<h2 id="session-establishment"><a class="header" href="#session-establishment">Session Establishment</a></h2>
<p>A node identifies a peer by their <code>installation-id</code>
which MAY be interpreted as a device identifier.</p>
<h3 id="discovery-of-pre-key-bundles"><a class="header" href="#discovery-of-pre-key-bundles">Discovery of pre-key bundles</a></h3>
<p>The node's pre-key bundle MUST be broadcast on a content topic
derived from the node's public key, so that the first message may be PFS-encrypted.
Each peer MUST publish their pre-key bundle periodically to this topic,
otherwise they risk not being able to perform key-exchanges with other peers.
Each peer MAY publish to this topic when their metadata changes,
so that the other peer can update their local record.</p>
<p>If peer A wants to send a message to peer B,
it MUST derive the topic from peer B's public key, which has been shared out of band.
Partitioned topics have been used to balance privacy and
efficiency of broadcasting pre-key bundles.</p>
<p>The number of partitions that MUST be used is 5000.</p>
<p>The topic MUST be derived as follows:</p>
<pre><code class="language-js">var partitionsNum *big.Int = big.NewInt(5000)
var partition *big.Int = big.NewInt(0).Mod(peerBPublicKey, partitionsNum)

partitionTopic := "contact-discovery-" + strconv.FormatInt(partition.Int64(), 10)

var hash []byte = keccak256(partitionTopic)
var topicLen int = 4

if len(hash) &lt; topicLen {
    topicLen = len(hash)
}

var contactCodeTopic [4]byte
for i = 0; i &lt; topicLen; i++ {
    contactCodeTopic[i] = hash[i]
}
</code></pre>
<h3 id="initialization"><a class="header" href="#initialization">Initialization</a></h3>
<p>A node initializes a new session once a successful X3DH exchange has taken place.
Subsequent messages will use the established session until re-keying is necessary.</p>
<h3 id="negotiated-topic-to-be-used-for-the-session"><a class="header" href="#negotiated-topic-to-be-used-for-the-session">Negotiated topic to be used for the session</a></h3>
<p>After the peers have performed the initial key exchange,
they MUST derive a topic from their shared secret to send messages on.
To obtain this value, take the first four bytes of the keccak256 hash
of the shared secret encoded in hexadecimal format.</p>
<pre><code class="language-js">sharedKey, err := ecies.ImportECDSA(myPrivateKey).GenerateShared(
    ecies.ImportECDSAPublic(theirPublicKey),
    16,
    16,
)

hexEncodedKey := hex.EncodeToString(sharedKey)

var hash []byte = keccak256(hexEncodedKey)
var topicLen int = 4

if len(hash) &lt; topicLen {
    topicLen = len(hash)
}

var topic [4]byte
for i = 0; i &lt; topicLen; i++ {
    topic[i] = hash[i]
}
</code></pre>
<p>To summarize,
following is the process for peer B to establish a session with peer A:</p>
<ol>
<li>Listen to peer B's Contact Code Topic to retrieve their bundle information,
including a list of active devices</li>
<li>Peer A sends their pre-key bundle on peer B's partitioned topic</li>
<li>Peer A and peer B perform the key-exchange using the shared pre-key bundles</li>
<li>The negotiated topic is derived from the shared secret</li>
<li>Peers A &amp; B exchange messages on the negotiated topic</li>
</ol>
<h3 id="concurrent-sessions"><a class="header" href="#concurrent-sessions">Concurrent sessions</a></h3>
<p>If a node creates two sessions concurrently between two peers,
the one with the symmetric key first in byte order SHOULD be used,
this marks that the other has expired.</p>
<h3 id="re-keying"><a class="header" href="#re-keying">Re-keying</a></h3>
<p>On receiving a bundle from a given peer with a higher version,
the old bundle SHOULD be marked as expired and
a new session SHOULD be established on the next message sent.</p>
<h3 id="multi-device-support"><a class="header" href="#multi-device-support">Multi-device support</a></h3>
<p>Multi-device support is quite challenging
as there is not a central place where information on which and how many devices
(identified by their respective <code>installation-id</code>) a peer has, is stored.</p>
<p>Furthermore, account recovery always needs to be taken into consideration,
where a user wipes clean the whole device and
the node loses all the information about any previous sessions.
Taking these considerations into account,
the way the network propagates multi-device information using X3DH bundles,
which will contain information about paired devices
as well as information about the sending device.
This means that every time a new device is paired,
the bundle needs to be updated and propagated with the new information,
the user has the responsibility to make sure the pairing is successful.</p>
<p>The method is loosely based on <a href="https://signal.org/docs/specifications/sesame/">Signal's Sesame Algorithm</a>.</p>
<h3 id="pairing"><a class="header" href="#pairing">Pairing</a></h3>
<p>A new <code>installation-id</code> MUST be generated on a per-device basis.
The device should be paired as soon as possible if other devices are present.</p>
<p>If a bundle is received, which has the same <code>IK</code> as the keypair present on the device,
the devices MAY be paired.
Once a user enables a new device,
a new bundle MUST be generated which includes pairing information.</p>
<p>The bundle MUST be propagated to contacts through the usual channels.</p>
<p>Removal of paired devices is a manual step that needs to be applied on each device,
and consist simply in disabling the device,
at which point pairing information will not be propagated anymore.</p>
<h3 id="sending-messages-to-a-paired-group"><a class="header" href="#sending-messages-to-a-paired-group">Sending messages to a paired group</a></h3>
<p>When sending a message,
the peer SHOULD send a message to other <code>installation-id</code> that they have seen.
The node caps the number of devices to <code>n</code>, ordered by last activity.
The node sends messages using pairwise encryption, including their own devices.</p>
<p>Where <code>n</code> is the maximum number of devices that can be paired.</p>
<h3 id="account-recovery"><a class="header" href="#account-recovery">Account recovery</a></h3>
<p>Account recovery is the same as adding a new device,
and it MUST be handled the same way.</p>
<h3 id="partitioned-devices"><a class="header" href="#partitioned-devices">Partitioned devices</a></h3>
<p>In some cases
(i.e. account recovery when no other pairing device is available, device not paired),
it is possible that a device will receive a message
that is not targeted to its own <code>installation-id</code>.
In this case an empty message containing bundle information MUST be sent back,
which will notify the receiving end not to include the device in any further communication.</p>
<h2 id="security-considerations-10"><a class="header" href="#security-considerations-10">Security Considerations</a></h2>
<ol>
<li>Inherits all security considerations from <a href="waku/standards/application/54//waku/standards/application/53/x3dh.html">53/WAKU2-X3DH</a>.</li>
</ol>
<h3 id="recommendations"><a class="header" href="#recommendations">Recommendations</a></h3>
<ol>
<li>The value of <code>n</code> SHOULD be configured by the app-protocol.
<ul>
<li>The default value SHOULD be 3,
since a larger number of devices will result in a larger bundle size,
which may not be desirable in a peer-to-peer network.</li>
</ul>
</li>
</ol>
<h2 id="copyright-32"><a class="header" href="#copyright-32">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-29"><a class="header" href="#references-29">References</a></h2>
<ul>
<li><a href="waku/standards/application/54//waku/standards/application/53/x3dh.html">53/WAKU2-X3DH</a></li>
<li><a href="https://signal.org/docs/specifications/sesame/">Signal's Sesame Algorithm</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="waku-standards---legacy"><a class="header" href="#waku-standards---legacy">Waku Standards - Legacy</a></h1>
<p>Legacy Waku standards retained for reference and historical compatibility.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="6waku1"><a class="header" href="#6waku1">6/WAKU1</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v1</td></tr>
<tr><th>Slug</th><td>6</td></tr>
<tr><th>Status</th><td>stable</td></tr>
<tr><th>Editor</th><td>Oskar Thorén &lt;oskarth@titanproxy.com&gt;</td></tr>
<tr><th>Contributors</th><td>Adam Babik &lt;adam@status.im&gt;<br>Andrea Maria Piana &lt;andreap@status.im&gt;<br>Dean Eigenmann &lt;dean@status.im&gt;<br>Kim De Mey &lt;kimdemey@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-37"><a class="header" href="#timeline-37">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/legacy/6/waku1.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/legacy/6/waku1.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/legacy/6/waku1.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/legacy/6/waku1.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-12</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/be052c8d76281c8ca62975d2d07ae53434744235/waku/standards/legacy/6/waku1.md"><code>be052c8</code></a> — Rename waku/standards/core/waku_legacy/6/waku1.md to waku/standards/legacy/6/waku1.md</li>
<li><strong>2024-02-12</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/7d83b3d51db2ecd04330e7d3cb713094afd59649/waku/standards/core/waku_legacy/6/waku1.md"><code>7d83b3d</code></a> — Rename waku/standards/core/6/waku1.md to waku/standards/core/waku_legacy/6/waku1.md</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/161b35a2e74c5e5d22dd1f7f70d35d952c2ba492/waku/standards/core/6/waku1.md"><code>161b35a</code></a> — Update and rename WAKU1.md to waku1.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/4c666c6754b86db60d694db23ea6f2c318b6aab2/waku/standards/core/6/WAKU1.md"><code>4c666c6</code></a> — Create WAKU1.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/61f7641fdd055e71646ccabdc9c873899417323d/waku/rfc/deprecated/5/WAKU0.md"><code>61f7641</code></a> — Create WAKU0.md</li>
</ul>
<!-- timeline:end -->
<p>This specification describes the format of Waku packets within the ÐΞVp2p Wire Protocol.
This spec substitutes <a href="https://eips.ethereum.org/EIPS/eip-627">EIP-627</a>.
Waku is a fork of the original Whisper protocol
that enables better usability for resource restricted devices,
such as mostly-offline bandwidth-constrained smartphones.
It does this through (a) light node support, (b) historic envelopes
(with a mailserver) (c) expressing topic interest for better bandwidth usage
and (d) basic rate limiting.</p>
<h2 id="motivation-18"><a class="header" href="#motivation-18">Motivation</a></h2>
<p>Waku was created to incrementally improve in areas that Whisper is lacking in,
with special attention to resource restricted devices.
We specify the standard for Waku packets in order to ensure forward compatibility
of different Waku clients, backwards compatibility with Whisper clients,
as well as to allow multiple implementations of Waku and its capabilities.
We also modify the language to be more unambiguous, concise and consistent.</p>
<h2 id="definitions-4"><a class="header" href="#definitions-4">Definitions</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Term</th><th>Definition</th></tr></thead><tbody>
<tr><td><strong>Batch Ack</strong></td><td>An abbreviated term for Batch Acknowledgment</td></tr>
<tr><td><strong>Light node</strong></td><td>A Waku node that does not forward any envelopes through the Messages packet.</td></tr>
<tr><td><strong>Envelope</strong></td><td>Messages sent and received by Waku nodes. Described in <a href="waku/standards/legacy/6/waku1.html#abnf-specification">ABNF spec <code>waku-envelope</code></a></td></tr>
<tr><td><strong>Node</strong></td><td>Some process that is able to communicate for Waku.</td></tr>
</tbody></table>
</div>
<h2 id="underlying-transports-and-prerequisites"><a class="header" href="#underlying-transports-and-prerequisites">Underlying Transports and Prerequisites</a></h2>
<h3 id="use-of-devp2p"><a class="header" href="#use-of-devp2p">Use of DevP2P</a></h3>
<p>For nodes to communicate, they MUST implement devp2p and run RLPx.
They MUST have some way of connecting to other nodes.
Node discovery is largely out of scope for this spec,
but see the appendix for some suggestions on how to do this.</p>
<p>This protocol needs to advertise the <code>waku/1</code> <a href="https://ethereum.gitbooks.io/frontier-guide/devp2p.html">capability</a>.</p>
<h3 id="gossip-based-routing"><a class="header" href="#gossip-based-routing">Gossip based routing</a></h3>
<p>In Whisper, envelopes are gossiped between peers.
Whisper is a form of rumor-mongering protocol
that works by flooding to its connected peers based on some factors.
Envelopes are eligible for retransmission until their TTL expires.
A node SHOULD relay envelopes to all connected nodes
if an envelope matches their PoW and bloom filter settings.
If a node works in light mode, it MAY choose not to forward envelopes.
A node MUST NOT send expired envelopes,
unless the envelopes are sent as a <a href="waku/standards/legacy/6/../8/mail.html">8/WAKU-MAIL</a> response.
A node SHOULD NOT send an envelope to a peer that it has already sent before.</p>
<h3 id="maximum-packet-size"><a class="header" href="#maximum-packet-size">Maximum Packet Size</a></h3>
<p>Nodes SHOULD limit the maximum size of both packets and envelopes.
If a packet or envelope exceeds its limit, it MUST be dropped.</p>
<ul>
<li><strong>RLPx Packet Size</strong> - This size MUST be checked before a message is decoded.</li>
<li><strong>Waku Envelope Size</strong> - Each envelope contained in an RLPx packet
MUST then separately be checked against the maximum envelope size.</li>
</ul>
<p>Clients MAY use their own maximum packet and envelope sizes.
The default values are <code>1.5mb</code> for the RLPx Packet and <code>1mb</code> for a Waku envelope.</p>
<h2 id="wire-specification-2"><a class="header" href="#wire-specification-2">Wire Specification</a></h2>
<h3 id="use-of-rlpx-transport-protocol"><a class="header" href="#use-of-rlpx-transport-protocol">Use of RLPx transport protocol</a></h3>
<p>All Waku packets are sent as devp2p RLPx transport protocol, version 5<sup class="footnote-reference"><a href="#1">1</a></sup> packets.
These packets MUST be RLP-encoded arrays of data containing two objects:
packet code followed by another object (whose type depends on the packet code).
See <a href="https://github.com/ethereum/wiki/wiki/RLP">informal RLP spec</a> and
the <a href="https://ethereum.github.io/yellowpaper/paper.pdf">Ethereum Yellow Paper, appendix B</a>
for more details on RLP.</p>
<p>Waku is a RLPx subprotocol called <code>waku</code> with version <code>0</code>.
The version number corresponds to the major version in the header spec.
Minor versions should not break compatibility of <code>waku</code>,
this would result in a new major.
(Some exceptions to this apply in the Draft stage
of where client implementation is rapidly change).</p>
<h3 id="abnf-specification"><a class="header" href="#abnf-specification">ABNF specification</a></h3>
<p>Using <a href="https://tools.ietf.org/html/rfc5234">Augmented Backus-Naur form (ABNF)</a>
we have the following format:</p>
<pre><code class="language-abnf">; Packet codes 0 - 127 are reserved for Waku protocol
packet-code = 1*3DIGIT

; rate limits per packet
packet-limit-ip     = 1*DIGIT
packet-limit-peerid = 1*DIGIT
packet-limit-topic  = 1*DIGIT

; rate limits by size in bytes
bytes-limit-ip     = 1*DIGIT
bytes-limit-peerid = 1*DIGIT
bytes-limit-topic  = 1*DIGIT

packet-rate-limits = "[" packet-limit-ip packet-limit-peerid packet-limit-topic "]"
bytes-rate-limits = "[" bytes-limit-ip bytes-limit-peerid bytes-limit-topic "]"

pow-requirement-key = 0
bloom-filter-key = 1
light-node-key = 2
confirmations-enabled-key = 3
packet-rate-limits-key = 4
topic-interest-key = 5
bytes-rate-limits-key = 6

status-options = "["
  [ pow-requirement-key pow-requirement ]
  [ bloom-filter-key bloom-filter ]
  [ light-node-key light-node ]
  [ confirmations-enabled-key confirmations-enabled ]
  [ packet-rate-limits-key packet-rate-limits ]
  [ topic-interest-key topic-interest ]
  [ bytes-limits-key bytes-rate-limits ]
"]"

status = status-options

status-update = status-options

confirmations-enabled = BIT

light-node = BIT

; pow is "a single floating point value of PoW.
; This value is the IEEE 754 binary representation
; of a 64-bit floating point number packed as a uint64.
; Values of qNAN, sNAN, INF and -INF are not allowed.
; Negative values are also not allowed."
pow             = 1*DIGIT "." 1*DIGIT
pow-requirement = pow

; bloom filter is "a byte array"
bloom-filter = *OCTET

waku-envelope = "[" expiry ttl topic data nonce "]"

; List of topics interested in
topic-interest = "[" *10000topic "]"

; 4 bytes (UNIX time in seconds)
expiry = 4OCTET

; 4 bytes (time-to-live in seconds)
ttl = 4OCTET

; 4 bytes of arbitrary data
topic = 4OCTET

; byte array of arbitrary size
; (contains encrypted payload)
data = *OCTET

; 8 bytes of arbitrary data
; (used for PoW calculation)
nonce = 8OCTET

messages = 1*waku-envelope

; version of the confirmation packet
version = 1*DIGIT

; keccak256 hash of the envelopes batch data (raw bytes)
; for which the confirmation is sent
hash = *OCTET

hasherror = *OCTET

; error code
code = 1*DIGIT

; a descriptive error message
description = *ALPHA

error  = "[" hasherror code description "]"
errors = *error

response = "[" hash errors "]"

confirmation = "[" version response "]"

; message confirmation packet types
batch-ack = confirmation
message-response = confirmation

; mail server / client specific
p2p-request = waku-envelope
p2p-message = 1*waku-envelope
p2p-request-complete = *OCTET

; packet-format needs to be paired with its
; corresponding packet-format
packet-format = "[" packet-code packet-format "]"

required-packet = 0 status /
                  1 messages /
                  22 status-update /

optional-packet = 11 batch-ack /
                  12 message-response /
                  126 p2p-request-complete /
                  126 p2p-request /
                  127 p2p-message

packet = "[" required-packet [ optional-packet ] "]"
</code></pre>
<p>All primitive types are RLP encoded. Note that, per RLP specification,
integers are encoded starting from <code>0x00</code>.</p>
<h3 id="packet-codes"><a class="header" href="#packet-codes">Packet Codes</a></h3>
<p>The packet codes reserved for Waku protocol: 0 - 127.</p>
<p>Packets with unknown codes MUST be ignored without generating any error,
for forward compatibility of future versions.</p>
<p>The Waku sub-protocol MUST support the following packet codes:</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Int Value</th></tr></thead><tbody>
<tr><td>Status</td><td>0</td></tr>
<tr><td>Messages</td><td>1</td></tr>
<tr><td>Status Update</td><td>22</td></tr>
</tbody></table>
</div>
<p>The following message codes are optional, but they are reserved for specific purpose.</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Int Value</th><th>Comment</th></tr></thead><tbody>
<tr><td>Batch Ack</td><td>11</td><td></td></tr>
<tr><td>Message Response</td><td>12</td><td></td></tr>
<tr><td>P2P Request Complete</td><td>125</td><td></td></tr>
<tr><td>P2P Request</td><td>126</td><td></td></tr>
<tr><td>P2P Message</td><td>127</td><td></td></tr>
</tbody></table>
</div>
<h3 id="packet-usage"><a class="header" href="#packet-usage">Packet usage</a></h3>
<h4 id="status"><a class="header" href="#status">Status</a></h4>
<p>The Status packet serves as a Waku handshake and peers MUST exchange this
packet upon connection. It MUST be sent after the RLPx handshake and prior to
any other Waku packets.</p>
<p>A Waku node MUST await the Status packet from a peer
before engaging in other Waku protocol activity with that peer.
When a node does not receive the Status packet from a peer,
before a configurable timeout, it SHOULD disconnect from that peer.</p>
<p>Upon retrieval of the Status packet, the node SHOULD validate the packet
received and validated the Status packet. Note that its peer might not be in
the same state.</p>
<p>When a node is receiving other Waku packets from a peer before a Status
packet is received, the node MUST ignore these packets and
SHOULD disconnect from that peer.
Status packets received after the handshake is completed MUST also be ignored.</p>
<p>The Status packet MUST contain an association list containing various options.
All options within this association list are OPTIONAL,
ordering of the key-value pairs is not guaranteed and
therefore MUST NOT be relied on.
Unknown keys in the association list SHOULD be ignored.</p>
<h4 id="messages"><a class="header" href="#messages">Messages</a></h4>
<p>This packet is used for sending the standard Waku envelopes.</p>
<h4 id="status-update"><a class="header" href="#status-update">Status Update</a></h4>
<p>The Status Update packet is used to communicate an update
of the settings of the node.
The format is the same as the Status packet, all fields are optional.
If none of the options are specified the packet MUST be ignored and
considered a noop.
Fields that are omitted are considered unchanged,
fields that haven't changed SHOULD not be transmitted.</p>
<h5 id="pow-requirement-field"><a class="header" href="#pow-requirement-field">PoW Requirement Field</a></h5>
<p>When PoW Requirement is updated,
peers MUST NOT deliver envelopes with PoW lower than the PoW Requirement specified.</p>
<p>PoW is defined as average number of iterations,
required to find the current BestBit
(the number of leading zero bits in the hash), divided by envelope size and TTL:</p>
<p>PoW = (2**BestBit) / (size * TTL)</p>
<p>PoW calculation:</p>
<p>fn short_rlp(envelope) = rlp of envelope, excluding env_nonce field.
fn pow_hash(envelope, env_nonce) = sha3(short_rlp(envelope) ++ env_nonce)
fn pow(pow_hash, size, ttl) = 2**leading_zeros(pow_hash) / (size * ttl)</p>
<p>where size is the size of the RLP-encoded envelope,
excluding <code>env_nonce</code> field (size of <code>short_rlp(envelope)</code>).</p>
<h5 id="bloom-filter-field"><a class="header" href="#bloom-filter-field">Bloom Filter Field</a></h5>
<p>The bloom filter is used to identify a number of topics to a peer without compromising
(too much) privacy over precisely what topics are of interest.
Precise control over the information content (and thus efficiency of the filter)
may be maintained through the addition of bits.</p>
<p>Blooms are formed by the bitwise OR operation on a number of bloomed topics.
The bloom function takes the topic and projects them onto a 512-bit slice.
At most, three bits are marked for each bloomed topic.</p>
<p>The projection function is defined as a mapping
from a 4-byte slice S to a 512-bit slice D; for ease of explanation,
S will dereference to bytes, whereas D will dereference to bits.</p>
<p>LET D[*] = 0
FOREACH i IN { 0, 1, 2 } DO
LET n = S[i]
IF S[3] &amp; (2 ** i) THEN n += 256
D[n] = 1
END FOR</p>
<p>A full bloom filter (all the bits set to 1)
means that the node is to be considered a <code>Full Node</code> and it will accept any topic.</p>
<p>If both topic interest and bloom filter are specified,
topic interest always takes precedence and bloom filter MUST be ignored.</p>
<p>If only bloom filter is specified,
the current topic interest MUST be discarded and
only the updated bloom filter MUST be used when forwarding or posting envelopes.</p>
<p>A bloom filter with all bits set to 0 signals that the node is not currently
interested in receiving any envelope.</p>
<h5 id="topic-interest-field"><a class="header" href="#topic-interest-field">Topic Interest Field</a></h5>
<p>Topic interest is used to share a node's interest in envelopes with specific topics.
It does this in a more bandwidth considerate way,
at the expense of some metadata protection.
Peers MUST only send envelopes with specified topics.</p>
<p>It is currently bounded to a maximum of 10000 topics.
If you are interested in more topics than that, this is currently underspecified
and likely requires updating it. The constant is subject to change.</p>
<p>If only topic interest is specified, the current bloom filter MUST be discarded and
only the updated topic interest MUST be used when forwarding or posting envelopes.</p>
<p>An empty array signals that the node is not currently interested in receiving
any envelope.</p>
<h5 id="rate-limits-field"><a class="header" href="#rate-limits-field">Rate Limits Field</a></h5>
<p>Rate limits is used to inform other nodes of their self defined rate limits.</p>
<p>In order to provide basic Denial-of-Service attack protection,
each node SHOULD define its own rate limits.
The rate limits SHOULD be applied on IPs, peer IDs, and envelope topics.</p>
<p>Each node MAY decide to whitelist, i.e. do not rate limit, selected IPs or peer IDs.</p>
<p>If a peer exceeds node's rate limits, the connection between them MAY be dropped.</p>
<p>Each node SHOULD broadcast its rate limits to its peers
using the <code>status-update</code> packet.
The rate limits MAY also be sent as an optional parameter in the handshake.</p>
<p>Each node SHOULD respect rate limits advertised by its peers.
The number of packets SHOULD be throttled in order not to exceed peer's rate limits.
If the limit gets exceeded, the connection MAY be dropped by the peer.</p>
<p>Two rate limits strategies are applied:</p>
<ol>
<li>Number of packets per second</li>
<li>Size of packets (in bytes) per second</li>
</ol>
<p>Both strategies SHOULD be applied per IP address, peer id and topic.</p>
<p>The size limit SHOULD be greater or equal than the maximum packet size.</p>
<h5 id="light-node-field"><a class="header" href="#light-node-field">Light Node Field</a></h5>
<p>When the node's <code>light-node</code> field is set to true,
the node SHOULD NOT forward Envelopes from its peers.</p>
<p>A node connected to a peer with the <code>light-node</code> field set to true
MUST NOT depend on the peer for forwarding Envelopes.</p>
<h5 id="confirmations-enabled-field"><a class="header" href="#confirmations-enabled-field">Confirmations Enabled Field</a></h5>
<p>When the node's <code>confirmations-enabled</code> field is set to true,
the node SHOULD send <a href="waku/standards/legacy/6/waku1.html#batch-ack-and-message-response">message confirmations</a>
to its peers.</p>
<h4 id="batch-ack-and-message-response"><a class="header" href="#batch-ack-and-message-response">Batch Ack and Message Response</a></h4>
<p>Message confirmations tell a node that an envelope
originating from it has been received by its peers,
allowing a node to know whether an envelope has or has not been received.</p>
<p>A node MAY send a message confirmation for any batch of envelopes
received with a Messages packet (<code>0x01</code>).</p>
<p>A message confirmation is sent using Batch Ack packet (<code>0x0B</code>) or
Message Response packet (<code>0x0C</code>).
The message confirmation is specified in the <a href="waku/standards/legacy/6/waku1.html#abnf-specification">ABNF specification</a>.</p>
<p>The current <code>version</code> in the <code>confirmation</code> is <code>1</code>.</p>
<p>The supported error codes:</p>
<ul>
<li><code>1</code>: time sync error which happens when an envelope is too old or
was created in the future (typically because of an unsynchronized clock of a node).</li>
</ul>
<p>The drawback of sending message confirmations is that it increases the noise
in the network because for each sent envelope,
a corresponding confirmation is broadcast by one or more peers.</p>
<h4 id="p2p-request"><a class="header" href="#p2p-request">P2P Request</a></h4>
<p>This packet is used for sending Dapp-level peer-to-peer requests,
e.g. Waku Mail Client requesting historic (expired)
envelopes from the <a href="waku/standards/legacy/6/../8/mail.html">Waku Mail Server</a>.</p>
<h4 id="p2p-message"><a class="header" href="#p2p-message">P2P Message</a></h4>
<p>This packet is used for sending the peer-to-peer envelopes,
which are not supposed to be forwarded any further.
E.g. it might be used by the Waku Mail Server for delivery of historic (expired)
envelopes, which is otherwise not allowed.</p>
<h4 id="p2p-request-complete"><a class="header" href="#p2p-request-complete">P2P Request Complete</a></h4>
<p>This packet is used to indicate that all envelopes,
requested earlier with a P2P Request packet (<code>0x7E</code>),
have been sent via one or more P2P Message packets (<code>0x7F</code>).</p>
<p>The content of the packet is explained in the <a href="waku/standards/legacy/6/../8/mail.html">Waku Mail Server</a> specification.</p>
<h3 id="payload-encryption-1"><a class="header" href="#payload-encryption-1">Payload Encryption</a></h3>
<p>Asymmetric encryption uses the standard Elliptic Curve Integrated Encryption Scheme
with SECP-256k1 public key.</p>
<p>Symmetric encryption uses AES GCM algorithm with random 96-bit nonce.</p>
<h3 id="packet-code-rationale"><a class="header" href="#packet-code-rationale">Packet code Rationale</a></h3>
<p>Packet codes <code>0x00</code> and <code>0x01</code> are already used in all Waku / Whisper versions.
Packet code <code>0x02</code> and <code>0x03</code> were previously used in Whisper but
are deprecated as of Waku v0.4</p>
<p>Packet code <code>0x22</code> is used to dynamically change the settings of a node.</p>
<p>Packet codes <code>0x7E</code> and <code>0x7F</code> may be used to implement Waku Mail Server and
Client.
Without the P2P Message packet it would be impossible to deliver the historic envelopes,
since they will be recognized as expired, and
the peer will be disconnected for violating the Waku protocol.
They might be useful for other purposes
when it is not possible to spend time on PoW,
e.g. if a stock exchange will want to provide live feed about the latest trades.</p>
<h2 id="additional-capabilities"><a class="header" href="#additional-capabilities">Additional capabilities</a></h2>
<p>Waku supports multiple capabilities.
These include light node, rate limiting and bridging of traffic.
Here we list these capabilities, how they are identified,
what properties they have and what invariants they must maintain.</p>
<p>Additionally,
there is the capability of a mailserver which is documented in its on <a href="waku/standards/legacy/6/../8/mail.html">specification</a>.</p>
<h3 id="light-node"><a class="header" href="#light-node">Light node</a></h3>
<p>The rationale for light nodes is to allow for interaction with waku
on resource restricted devices as bandwidth can often be an issue.</p>
<p>Light nodes MUST NOT forward any incoming envelopes,
they MUST only send their own envelopes.
When light nodes happen to connect to each other, they SHOULD disconnect.
As this would result in envelopes being dropped between the two.</p>
<p>Light nodes are identified by the <code>light_node</code> value in the Status packet.</p>
<h3 id="accounting-for-resources-experimental"><a class="header" href="#accounting-for-resources-experimental">Accounting for resources (experimental)</a></h3>
<p>Nodes MAY implement accounting, keeping track of resource usage.
It is heavily inspired by Swarm's <a href="https://www.bokconsulting.com.au/wp-content/uploads/2016/09/tron-fischer-sw3.pdf">SWAP protocol</a>,
and works by doing pairwise accounting for resources.</p>
<p>Each node keeps track of resource usage with all other nodes.
Whenever an envelope is received from a node that is expected
(fits bloom filter or topic interest, is legal, etc) this is tracked.</p>
<p>Every epoch (say, every minute or every time an event happens)
statistics SHOULD be aggregated and saved by the client:</p>
<div class="table-wrapper"><table><thead><tr><th>peer</th><th>sent</th><th>received</th></tr></thead><tbody>
<tr><td>peer1</td><td>0</td><td>123</td></tr>
<tr><td>peer2</td><td>10</td><td>40</td></tr>
</tbody></table>
</div>
<p>In later versions this will be amended by nodes communication thresholds,
settlements and disconnect logic.</p>
<h2 id="upgradability-and-compatibility"><a class="header" href="#upgradability-and-compatibility">Upgradability and Compatibility</a></h2>
<h3 id="general-principles-and-policy"><a class="header" href="#general-principles-and-policy">General principles and policy</a></h3>
<p>The currently advertised capability is <code>waku/1</code>.
This needs to be advertised in the <code>hello</code> <code>ÐΞVp2p</code> <a href="https://ethereum.gitbooks.io/frontier-guide/devp2p.html">packet</a>.
If a node supports multiple versions of <code>waku</code>, those needs to be explicitly advertised.
For example if both <code>waku/0</code> and <code>waku/1</code> are supported,
both <code>waku/0</code> and <code>waku/1</code> MUST be advertised.</p>
<p>These are policies that guide how we make decisions when it comes to upgradability,
compatibility, and extensibility:</p>
<ol>
<li>
<p>Waku aims to be compatible with previous and future versions.</p>
</li>
<li>
<p>In cases where we want to break this compatibility,
we do so gracefully and as a single decision point.</p>
</li>
<li>
<p>To achieve this, we employ the following two general strategies:</p>
</li>
</ol>
<ul>
<li>a) Accretion (including protocol negotiation) over changing data</li>
<li>b) When we want to change things, we give it a new name
(for example, a version number).</li>
</ul>
<p>Examples:</p>
<ul>
<li>We enable bridging between <code>shh/6</code> and
<code>waku/1</code> until such a time as when we are ready to gracefully drop support
for <code>shh/6</code> (1, 2, 3).</li>
<li>When we add parameter fields,
we (currently) do so by accreting them in a list,
so old clients can ignore new fields (dynamic list) and
new clients can use new capabilities (1, 3).</li>
<li>To better support (2) and (3) in the future,
we will likely release a new version that gives better support for open,
growable maps (association lists or native map type) (3)</li>
<li>When we we want to provide a new set of packets that have different requirements,
we do so under a new protocol version and employ protocol versioning.
This is a form of accretion at a level above -
it ensures a client can support both protocols at once and
drop support for legacy versions gracefully. (1,2,3)</li>
</ul>
<h3 id="backwards-compatibility"><a class="header" href="#backwards-compatibility">Backwards Compatibility</a></h3>
<p>Waku is a different subprotocol from Whisper so it isn't directly compatible.
However, the data format is the same,
so compatibility can be achieved by the use of a bridging mode as described below.
Any client which does not implement certain packet codes
should gracefully ignore the packets with those codes.
This will ensure the forward compatibility.</p>
<h3 id="waku-whisper-bridging"><a class="header" href="#waku-whisper-bridging">Waku-Whisper bridging</a></h3>
<p><code>waku/1</code> and <code>shh/6</code> are different DevP2P subprotocols,
however they share the same data format making their envelopes compatible.
This means we can bridge the protocols naively, this works as follows.</p>
<p><strong>Roles:</strong></p>
<ul>
<li>Waku client A, only Waku capability</li>
<li>Whisper client B, only Whisper capability</li>
<li>WakuWhisper bridge C, both Waku and Whisper capability</li>
</ul>
<p><strong>Flow:</strong></p>
<ol>
<li>A posts envelope; B posts envelope.</li>
<li>C picks up envelope from A and B and relays them both to Waku and Whisper.</li>
<li>A receives envelope on Waku; B on Whisper.</li>
</ol>
<p><strong>Note</strong>: This flow means if another bridge C1 is active,
we might get duplicate relaying for a envelope between C1 and C2.
I.e. Whisper(&lt;&gt;Waku&lt;&gt;Whisper)&lt;&gt;Waku, A-C1-C2-B.
Theoretically this bridging chain can get as long as TTL permits.</p>
<h3 id="forward-compatibility"><a class="header" href="#forward-compatibility">Forward Compatibility</a></h3>
<p>It is desirable to have a strategy for maintaining forward compatibility
between <code>waku/1</code> and future version of waku.
Here we outline some concerns and strategy for this.</p>
<ul>
<li><strong>Connecting to nodes with multiple versions:</strong>
The way this SHOULD be accomplished is by negotiating the versions of subprotocols,
within the <code>hello</code> packet nodes transmit their capabilities along with a version.
The highest common version should then be used.</li>
<li><strong>Adding new packet codes:</strong>
New packet codes can be added easily due to the available packet codes.
Unknown packet codes SHOULD be ignored.
Upgrades that add new packet codes SHOULD implement some fallback mechanism
if no response was received for nodes that do not yet understand this packet.</li>
<li><strong>Adding new options in <code>status-options</code>:</strong>
New options can be added to the <code>status-options</code> association list in the <code>status</code>
and <code>status-update</code> packet as options are OPTIONAL and
unknown option keys SHOULD be ignored.
A node SHOULD NOT disconnect from a peer when receiving <code>status-options</code>
with unknown option keys.</li>
</ul>
<h2 id="appendix-a-security-considerations-2"><a class="header" href="#appendix-a-security-considerations-2">Appendix A: Security considerations</a></h2>
<p>There are several security considerations to take into account when running Waku.
Chief among them are: scalability, DDoS-resistance and privacy.
These also vary depending on what capabilities are used.
The security considerations for extra capabilities,
such as <a href="waku/standards/legacy/6/../8/mail.html#security-considerations">mailservers</a>
can be found in their respective specifications.</p>
<h3 id="scalability-and-ux"><a class="header" href="#scalability-and-ux">Scalability and UX</a></h3>
<h4 id="bandwidth-usage"><a class="header" href="#bandwidth-usage">Bandwidth usage</a></h4>
<p>In version 0 of Waku, bandwidth usage is likely to be an issue.
For more investigation into this,
see the theoretical scaling model described
<a href="https://github.com/vacp2p/research/tree/dcc71f4779be832d3b5ece9c4e11f1f7ec24aac2/whisper_scalability">here</a>.</p>
<h4 id="gossip-based-routing-1"><a class="header" href="#gossip-based-routing-1">Gossip-based routing</a></h4>
<p>Use of gossip-based routing doesn't necessarily scale.
It means each node can see an envelope multiple times, and
having too many light nodes can cause propagation probability that is too low.
See <a href="https://our.status.im/whisper-pss-comparison/">Whisper vs PSS</a>
for more and a possible Kademlia based alternative.</p>
<h4 id="lack-of-incentives"><a class="header" href="#lack-of-incentives">Lack of incentives</a></h4>
<p>Waku currently lacks incentives to run nodes,
which means node operators are more likely to create centralized choke points.</p>
<h3 id="privacy"><a class="header" href="#privacy">Privacy</a></h3>
<h4 id="light-node-privacy"><a class="header" href="#light-node-privacy">Light node privacy</a></h4>
<p>The main privacy concern with a light node
is that it has to reveal its topic interests
(in addition to its IP/ID) to its directed peers.
This is because when a light node publishes an envelope,
its directed peers will know that the light node owns that envelope
(as light nodes do not relay other envelopes).
Therefore, the directed peers of a light node can make assumptions about what envelopes
(topics) the light node is interested in.</p>
<h4 id="mailserver-client-privacy"><a class="header" href="#mailserver-client-privacy">Mailserver client privacy</a></h4>
<p>A mailserver client fetches archival envelopes from a mailserver
through a direct connection.
In this direct connection,
the client discloses its IP/ID as well as the topics/ bloom filter
it is interested in to the mailserver.
The collection of such information allows the mailserver to link clients' IP/IDs
to their topic interests and build a profile for each client over time.
As such, the mailserver client has to trust the mailserver with this level of information.</p>
<h4 id="bloom-filter-privacy"><a class="header" href="#bloom-filter-privacy">Bloom filter privacy</a></h4>
<p>By having a bloom filter where only the topics you are interested in are set,
you reveal which envelopes you are interested in.
This is a fundamental tradeoff between bandwidth usage and privacy,
though the tradeoff space is likely suboptimal in terms of the <a href="https://eprint.iacr.org/2017/954.pdf">Anonymity</a>
<a href="https://petsymposium.org/2019/files/hotpets/slides/coordination-helps-anonymity-slides.pdf">trilemma</a>.</p>
<h4 id="privacy-guarantees-not-rigorous"><a class="header" href="#privacy-guarantees-not-rigorous">Privacy guarantees not rigorous</a></h4>
<p>Privacy for Whisper / Waku haven't been studied rigorously for various threat models
like global passive adversary, local active attacker, etc.
This is unlike e.g. Tor and mixnets.</p>
<h4 id="topic-hygiene"><a class="header" href="#topic-hygiene">Topic hygiene</a></h4>
<p>Similar to bloom filter privacy,
if you use a very specific topic you reveal more information.
See scalability model linked above.</p>
<h3 id="spam-resistance"><a class="header" href="#spam-resistance">Spam resistance</a></h3>
<p><strong>PoW bad for heterogeneous devices:</strong></p>
<p>Proof of work is a poor spam prevention mechanism.
A mobile device can only have a very low PoW
in order not to use too much CPU / burn up its phone battery.
This means someone can spin up a powerful node and overwhelm the network.</p>
<h3 id="censorship-resistance"><a class="header" href="#censorship-resistance">Censorship resistance</a></h3>
<p><strong>Devp2p TCP port blockable:</strong></p>
<p>By default Devp2p runs on port <code>30303</code>,
which is not commonly used for any other service.
This means it is easy to censor, e.g. airport WiFi.
This can be mitigated somewhat by running on e.g. port <code>80</code> or <code>443</code>,
but there are still outstanding issues.
See libp2p and Tor's Pluggable Transport for how this can be improved.</p>
<h2 id="appendix-b-implementation-notes"><a class="header" href="#appendix-b-implementation-notes">Appendix B: Implementation Notes</a></h2>
<h3 id="implementation-matrix-1"><a class="header" href="#implementation-matrix-1">Implementation Matrix</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Client</th><th>Spec supported</th><th>Details</th></tr></thead><tbody>
<tr><td><strong>Status-go</strong></td><td>0.5</td><td><a href="https://github.com/status-im/status-go/blob/develop/WAKU.md">details</a></td></tr>
<tr><td><strong>Nim-waku</strong></td><td>1.0</td><td><a href="https://github.com/status-im/nim-waku/blob/master/README.md">details</a></td></tr>
</tbody></table>
</div>
<h3 id="recommendations-for-clients-1"><a class="header" href="#recommendations-for-clients-1">Recommendations for clients</a></h3>
<p>Notes useful for implementing Waku mode.</p>
<p>1.Avoid duplicate envelopes</p>
<p>To avoid duplicate envelopes,
only connect to one Waku node.
Benign duplicate envelopes is an intrinsic property of Whisper
which often leads to a N factor increase in traffic,
where N is the number of peers you are connected to.</p>
<p>2.Topic specific recommendations</p>
<p>Consider partition topics based on some usage,
to avoid too much traffic on a single topic.</p>
<h3 id="node-discovery"><a class="header" href="#node-discovery">Node discovery</a></h3>
<p>Resource restricted devices SHOULD use <a href="https://eips.ethereum.org/EIPS/eip-1459">EIP-1459</a>
to discover nodes.</p>
<p>Known static nodes MAY also be used.</p>
<h2 id="changelog"><a class="header" href="#changelog">Changelog</a></h2>
<h3 id="initial-release"><a class="header" href="#initial-release"><a href="https://github.com/vacp2p/specs/commit/bc7e75ebb2e45d2cbf6ab27352c113e666df37c8">Initial Release</a></a></h3>
<ul>
<li>Add section on P2P Request Complete packet and update packet code table.</li>
<li>Correct the header hierarchy for the status-options fields.</li>
<li>Consistent use of the words packet, message and envelope.</li>
<li>Added section on max packet size</li>
<li>Complete the ABNF specification and minor ABNF fixes.</li>
</ul>
<h3 id="version-11"><a class="header" href="#version-11">Version 1.1</a></h3>
<p>Released <a href="https://github.com/vacp2p/specs/commit/33b8d7304c9ebece90ea94e601f11080a8ac2c4d">June 09, 2020</a></p>
<ul>
<li>Add rate limit per bytes</li>
</ul>
<h3 id="version-10"><a class="header" href="#version-10">Version 1.0</a></h3>
<p>Released <a href="https://github.com/vacp2p/specs/commit/9e650995f24179844857520c68fa3e8f6018b125">April 21,2020</a></p>
<ul>
<li>Removed <code>version</code> from handshake</li>
<li>Changed <code>RLP</code> keys from 48,49.. to 0,1..</li>
<li>Upgraded to <code>waku/1</code></li>
</ul>
<h3 id="version-06"><a class="header" href="#version-06">Version 0.6</a></h3>
<p>Released <a href="https://github.com/vacp2p/specs/commit/9e650995f24179844857520c68fa3e8f6018b125">April 21,2020</a></p>
<ul>
<li>Mark spec as Deprecated mode in terms of its lifecycle.</li>
</ul>
<h3 id="version-05"><a class="header" href="#version-05">Version 0.5</a></h3>
<p>Released <a href="https://github.com/vacp2p/specs/commit/7b9dc562bc50c6bb844ac575cb221ec9cda2530a">March 17,2020</a></p>
<ul>
<li>Clarify the preferred way of handling unknown keys
in the <code>status-options</code> association list.</li>
<li>Correct spec/implementation mismatch:
Change RLP keys to be the their int values in order to reflect production behavior</li>
</ul>
<h3 id="version-04"><a class="header" href="#version-04">Version 0.4</a></h3>
<p>Released <a href="https://github.com/vacp2p/specs/commit/17bd066e317bbe33af07146b721d73f24de47e88">February 21, 2020</a>.</p>
<ul>
<li>Simplify implementation matrix with latest state</li>
<li>Introduces a new required packet code Status Code (<code>0x22</code>)
for communicating option changes</li>
<li>Deprecates the following packet codes: PoW Requirement (<code>0x02</code>),
Bloom Filter (<code>0x03</code>), Rate limits (<code>0x20</code>), Topic interest (<code>0x21</code>) -
all superseded by the new Status Code (<code>0x22</code>)</li>
<li>Increased <code>topic-interest</code> capacity from 1000 to 10000</li>
</ul>
<h3 id="version-03"><a class="header" href="#version-03">Version 0.3</a></h3>
<p>Released <a href="https://github.com/vacp2p/specs/commit/73138d6ba954ab4c315e1b8d210ac7631b6d1428">February 13, 2020</a>.</p>
<ul>
<li>Recommend DNS based node discovery over other Discovery methods.</li>
<li>Mark spec as Draft mode in terms of its lifecycle.</li>
<li>Simplify Changelog and misc formatting.</li>
<li>Handshake/Status packet not compatible with shh/6 nodes;
specifying options as association list.</li>
<li>Include topic-interest in Status handshake.</li>
<li>Upgradability policy.</li>
<li><code>topic-interest</code> packet code.</li>
</ul>
<h3 id="version-02"><a class="header" href="#version-02">Version 0.2</a></h3>
<p>Released <a href="https://github.com/vacp2p/specs/blob/waku-0.2.0/waku.md">December 10, 2019</a>.</p>
<ul>
<li>General style improvements.</li>
<li>Fix ABNF grammar.</li>
<li>Mailserver requesting/receiving.</li>
<li>New packet codes: topic-interest (experimental), rate limits (experimental).</li>
<li>More details on handshake modifications.</li>
<li>Accounting for resources mode (experimental)</li>
<li>Appendix with security considerations: scalability and UX, privacy, and spam resistance.</li>
<li>Appendix with implementation notes and
implementation matrix across various clients with breakdown per capability.</li>
<li>More details on handshake and parameters.</li>
<li>Describe rate limits in more detail.</li>
<li>More details on mailserver and mail client API.</li>
<li>Accounting for resources mode (very experimental).</li>
<li>Clarify differences with Whisper.</li>
</ul>
<h3 id="version-01"><a class="header" href="#version-01">Version 0.1</a></h3>
<p>Initial version. Released <a href="https://github.com/vacp2p/specs/blob/b59b9247f2ac1bf45c75bd3227a2e5dd87b6d7b0/waku.md">November 21, 2019</a>.</p>
<h3 id="differences-between-shh6-and-waku1"><a class="header" href="#differences-between-shh6-and-waku1">Differences between shh/6 and waku/1</a></h3>
<p>Summary of main differences between this spec and Whisper v6, as described in <a href="https://eips.ethereum.org/EIPS/eip-627">EIP-627</a>:</p>
<ul>
<li>RLPx subprotocol is changed from <code>shh/6</code> to <code>waku/1</code>.</li>
<li>Light node capability is added.</li>
<li>Optional rate limiting is added.</li>
<li>Status packet has following additional parameters: light-node,
confirmations-enabled and rate-limits</li>
<li>Mail Server and Mail Client functionality is now part of the specification.</li>
<li>P2P Message packet contains a list of envelopes instead of a single envelope.</li>
</ul>
<h2 id="copyright-33"><a class="header" href="#copyright-33">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="footnotes-3"><a class="header" href="#footnotes-3">Footnotes</a></h2>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>Felix Lange et al. <a href="https://github.com/ethereum/devp2p/blob/master/rlpx.md">The RLPx Transport Protocol</a>. Ethereum.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="7waku-data"><a class="header" href="#7waku-data">7/WAKU-DATA</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku Envelope data field</td></tr>
<tr><th>Slug</th><td>7</td></tr>
<tr><th>Status</th><td>stable</td></tr>
<tr><th>Editor</th><td>Oskar Thorén &lt;oskarth@titanproxy.com&gt;</td></tr>
<tr><th>Contributors</th><td>Dean Eigenmann &lt;dean@status.im&gt;<br>Kim De Mey &lt;kimdemey@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-38"><a class="header" href="#timeline-38">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/legacy/7/data.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/legacy/7/data.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/legacy/7/data.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/legacy/7/data.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-12</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/a57d7b4732eb600c2f9281a26d106d526308ed49/waku/standards/legacy/7/data.md"><code>a57d7b4</code></a> — Rename data.md to data.md</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/900a3e92b4d8fd1ecbc4b8cd59429faf6aff4e71/waku/standards/application/7/data.md"><code>900a3e9</code></a> — Update and rename DATA.md to data.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/662eb12909d9ba09a345fea0864f08f5a780b913/waku/standards/application/7/DATA.md"><code>662eb12</code></a> — Rename README.md to DATA.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/standards/application/07/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/93c389620d94c46689856a85f3393b8fa50cca2e/waku/rfcs/standards/application/07/README.md"><code>93c3896</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<p>This specification describes the encryption,
decryption and signing of the content in the <a href="waku/standards/legacy/7/../6/waku1.html">data field used in Waku</a>.</p>
<h2 id="specification-5"><a class="header" href="#specification-5">Specification</a></h2>
<p>The <code>data</code> field is used within the <code>waku envelope</code>,
the field MUST contain the encrypted payload of the envelope.</p>
<p>The fields that are concatenated and encrypted as part of the <code>data</code> field are:</p>
<ul>
<li>flags</li>
<li>auxiliary field</li>
<li>payload</li>
<li>padding</li>
<li>signature</li>
</ul>
<p>In case of symmetric encryption, a <code>salt</code>
(a.k.a. AES Nonce, 12 bytes) field MUST be appended.</p>
<h3 id="abnf-1"><a class="header" href="#abnf-1">ABNF</a></h3>
<p>Using <a href="https://tools.ietf.org/html/rfc5234">Augmented Backus-Naur form (ABNF)</a>
we have the following format:</p>
<pre><code class="language-abnf">; 1 byte; first two bits contain the size of auxiliary field, 
; third bit indicates whether the signature is present.
flags           = 1OCTET

; contains the size of payload.
auxiliary-field = 4*OCTET

; byte array of arbitrary size (may be zero)
payload         = *OCTET

; byte array of arbitrary size (may be zero).
padding         = *OCTET

; 65 bytes, if present.
signature       = 65OCTET

; 2 bytes, if present (in case of symmetric encryption).
salt            = 2OCTET

data        = flags auxiliary-field payload padding [signature] [salt]
</code></pre>
<h3 id="signature-2"><a class="header" href="#signature-2">Signature</a></h3>
<p>Those unable to decrypt the envelope data are also unable to access the signature.
The signature, if provided,
is the ECDSA signature of the Keccak-256 hash of the unencrypted data
using the secret key of the originator identity.
The signature is serialized as the concatenation of the <code>R</code>, <code>S</code> and
<code>V</code> parameters of the SECP-256k1 ECDSA signature, in that order.
<code>R</code> and <code>S</code> MUST be big-endian encoded, fixed-width 256-bit unsigned.
<code>V</code> MUST be an 8-bit big-endian encoded,
non-normalized and should be either 27 or 28.</p>
<h3 id="padding-1"><a class="header" href="#padding-1">Padding</a></h3>
<p>The padding field is used to align data size,
since data size alone might reveal important metainformation.
Padding can be arbitrary size.
However, it is recommended that the size of Data Field (excluding the Salt)
before encryption (i.e. plain text) SHOULD be factor of 256 bytes.</p>
<h2 id="copyright-34"><a class="header" href="#copyright-34">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="8waku-mail"><a class="header" href="#8waku-mail">8/WAKU-MAIL</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku Mailserver</td></tr>
<tr><th>Slug</th><td>8</td></tr>
<tr><th>Status</th><td>stable</td></tr>
<tr><th>Editor</th><td>Andrea Maria Piana &lt;andreap@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Adam Babik &lt;adam@status.im&gt;<br>Dean Eigenmann &lt;dean@status.im&gt;<br>Oskar Thorén &lt;oskarth@titanproxy.com&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-39"><a class="header" href="#timeline-39">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/legacy/8/mail.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/legacy/8/mail.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/legacy/8/mail.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/legacy/8/mail.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-12</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/fa77279cd0a85432f1f1e96083c0e775b9a89bfd/waku/standards/legacy/8/mail.md"><code>fa77279</code></a> — Rename mail.md to mail.md</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/0c8e39bac9eeae649a9cca4c4e2b1b3f83d5b605/waku/standards/application/8/mail.md"><code>0c8e39b</code></a> — Rename MAIL.md to mail.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/de5cfa275a106eb1eee3961eba8dd35074746683/waku/standards/application/8/MAIL.md"><code>de5cfa2</code></a> — Rename README.md to MAIL.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/standards/application/08/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/28e786282c2843070c096aa0103578f50db68177/waku/rfcs/standards/application/08/README.md"><code>28e7862</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-27"><a class="header" href="#abstract-27">Abstract</a></h2>
<p>In this specification, we describe Mailservers.
These are nodes responsible for archiving envelopes and
delivering them to peers on-demand.</p>
<h2 id="specification-6"><a class="header" href="#specification-6">Specification</a></h2>
<p>A node which wants to provide mailserver functionality MUST store envelopes
from incoming Messages packets (Waku packet-code <code>0x01</code>).
The envelopes can be stored in any format,
however they MUST be serialized and deserialized to the Waku envelope format.</p>
<p>A mailserver SHOULD store envelopes for all topics
to be generally useful for any peer,
however for specific use cases it MAY store envelopes for a subset of topics.</p>
<h3 id="requesting-historic-envelopes"><a class="header" href="#requesting-historic-envelopes">Requesting Historic Envelopes</a></h3>
<p>In order to request historic envelopes,
a node MUST send a packet P2P Request (<code>0x7e</code>)
to a peer providing mailserver functionality.
This packet requires one argument which MUST be a Waku envelope.</p>
<p>In the Waku envelope's payload section,
there MUST be RLP-encoded information about the details of the request:</p>
<pre><code class="language-abnf">; UNIX time in seconds; oldest requested envelope's creation time
lower  = 4OCTET

; UNIX time in seconds; newest requested envelope's creation time
upper  = 4OCTET

; array of Waku topics encoded in a bloom filter to filter envelopes
bloom  = 64OCTET

; unsigned integer limiting the number of returned envelopes
limit  = 4OCTET

; array of a cursor returned from the previous request (optional)
cursor = *OCTET

; List of topics interested in
topics = "[" *1000topic "]"

; 4 bytes of arbitrary data
topic = 4OCTET

payload-without-topic = "[" lower upper bloom limit [ cursor ] "]"

payload-with-topic = "[" lower upper bloom limit cursor [ topics ] "]"

payload = payload-with-topic | payload-without-topic
</code></pre>
<p>The <code>Cursor</code> field SHOULD be filled in if a number of envelopes between <code>Lower</code> and
<code>Upper</code> is greater than <code>Limit</code> so that the requester can send another request
using the obtained <code>Cursor</code> value.
What exactly is in the <code>Cursor</code> is up to the implementation.
The requester SHOULD NOT use a <code>Cursor</code> obtained from one mailserver in a request
to another mailserver because the format or the result MAY be different.</p>
<p>The envelope MUST be encrypted with a symmetric key agreed between the requester
and Mailserver.</p>
<p>If <code>Topics</code> is used the <code>Cursor</code> field MUST be specified
for the argument order to be unambiguous.
However, it MAY be set to <code>null</code>.
<code>Topics</code> is used to specify which topics a node is interested in.
If <code>Topics</code> is not empty,
a mailserver MUST only send envelopes that belong to a topic from <code>Topics</code> list and
<code>Bloom</code> value MUST be ignored.</p>
<h3 id="receiving-historic-envelopes"><a class="header" href="#receiving-historic-envelopes">Receiving Historic Envelopes</a></h3>
<p>Historic envelopes MUST be sent to a peer as a packet with a P2P Message code (<code>0x7f</code>)
followed by an array of Waku envelopes.
A Mailserver MUST limit the amount of messages sent,
either by the <code>Limit</code> specified in the request or
limited to the maximum <a href="waku/standards/legacy/8/./waku#maximum-packet-size">RLPx packet size</a>,
whichever limit comes first.</p>
<p>In order to receive historic envelopes from a mailserver,
a node MUST trust the selected mailserver,
that is allow to receive expired packets with the P2P Message code.
By default, such packets are discarded.</p>
<p>Received envelopes MUST be passed through the Whisper envelope pipelines
so that they are picked up by registered filters and passed to subscribers.</p>
<p>For a requester, to know that all envelopes have been sent by mailserver,
it SHOULD handle P2P Request Complete code (<code>0x7d</code>).
This code is followed by a list with:</p>
<pre><code class="language-abnf">; array with a Keccak-256 hash of the envelope containing the original request.
request-id = 32OCTET

; array with a Keccak-256 hash of the last sent envelope for the request. 
last-envelope-hash = 32OCTET

; array of a cursor returned from the previous request (optional)
cursor = *OCTET

payload = "[" request-id last-envelope-hash [ cursor ] "]"
</code></pre>
<p>If <code>Cursor</code> is not empty,
it means that not all envelopes were sent due to the set <code>Limit</code> in the request.
One or more consecutive requests MAY be sent with <code>Cursor</code> field filled
in order to receive the rest of the envelopes.</p>
<h3 id="security-considerations-11"><a class="header" href="#security-considerations-11">Security considerations</a></h3>
<p>There are several security considerations to take into account when running or
interacting with Mailservers.
Chief among them are: scalability, DDoS-resistance and privacy.</p>
<p><strong>Mailserver High Availability requirement:</strong></p>
<p>A mailserver has to be online to receive envelopes for other nodes,
this puts a high availability requirement on it.</p>
<p><strong>Mailserver client privacy:</strong></p>
<p>A mailserver client fetches archival envelopes from a mailserver
through a direct connection.
In this direct connection,
the client discloses its IP/ID as well as the topics/ bloom filter
it is interested in to the mailserver.
The collection of such information allows the mailserver to link clients' IP/IDs
to their topic interests and build a profile for each client over time.
As such, the mailserver client has to trust the mailserver with this level of information.
A similar concern exists for the light nodes and
their direct peers which is discussed in the security considerations of <a href="waku/standards/legacy/8/../6/waku1.html">6/WAKU1</a>.</p>
<p><strong>Mailserver trusted connection:</strong></p>
<p>A mailserver has a direct TCP connection, which means they are trusted to send traffic.
This means a malicious or malfunctioning mailserver can overwhelm an individual node.</p>
<h2 id="changelog-1"><a class="header" href="#changelog-1">Changelog</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Version</th><th>Comment</th></tr></thead><tbody>
<tr><td style="text-align: center"><a href="https://github.com/vacp2p/specs/commit/bc7e75ebb2e45d2cbf6ab27352c113e666df37c8">1.0.0</a></td><td>marked stable as it is in use.</td></tr>
<tr><td style="text-align: center">0.2.0</td><td>Add topic interest to reduce bandwidth usage</td></tr>
<tr><td style="text-align: center"><a href="https://github.com/vacp2p/specs/blob/06d4c736c920526472a507e5d842212843a112ed/wms.md">0.1.0</a></td><td>Initial Release</td></tr>
</tbody></table>
</div>
<h3 id="difference-between-wms-01-and-wms-02"><a class="header" href="#difference-between-wms-01-and-wms-02">Difference between wms 0.1 and wms 0.2</a></h3>
<ul>
<li><code>topics</code> option</li>
</ul>
<h2 id="copyright-35"><a class="header" href="#copyright-35">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="9waku-rpc"><a class="header" href="#9waku-rpc">9/WAKU-RPC</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku RPC API</td></tr>
<tr><th>Slug</th><td>9</td></tr>
<tr><th>Status</th><td>stable</td></tr>
<tr><th>Editor</th><td>Andrea Maria Piana &lt;andreap@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Dean Eigenmann &lt;dean@status.im&gt;<br>Oskar Thorén &lt;oskarth@titanproxy.com&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-40"><a class="header" href="#timeline-40">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/standards/legacy/9/rpc.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/standards/legacy/9/rpc.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/legacy/9/rpc.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/legacy/9/rpc.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-12</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/5eb393f47c2d7c7b10f024e07a20e2b6647a14bc/waku/standards/legacy/9/rpc.md"><code>5eb393f</code></a> — Rename waku/legacy/9/rpc.md to waku/standards/legacy/9/rpc.md</li>
<li><strong>2024-02-12</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/9617146a6a5ddaa676ef6d5ee47bf073c2b86f9f/waku/legacy/9/rpc.md"><code>9617146</code></a> — Rename waku/standards/core/waku_legacy/9/waku2-rpc.md to waku/legacy/9/rpc.md</li>
<li><strong>2024-02-12</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/75705cd142342c905961c55da5914513599b2a7b/waku/standards/core/waku_legacy/9/waku2-rpc.md"><code>75705cd</code></a> — Rename waku/standards/core/9/waku2-rpc.md to waku/standards/core/waku_legacy/9/waku2-rpc.md</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/e808e36eb7f011c6f15fb2f73f9520b5cc7dbff1/waku/standards/core/9/waku2-rpc.md"><code>e808e36</code></a> — Create waku2-rpc.md</li>
</ul>
<!-- timeline:end -->
<p>This specification describes the RPC API that Waku nodes MAY adhere to.
The unified API allows clients to easily
be able to connect to any node implementation.
The API described is privileged as a node stores the keys of clients.</p>
<h2 id="introduction-3"><a class="header" href="#introduction-3">Introduction</a></h2>
<p>This API is based off the <a href="https://github.com/ethereum/go-ethereum/wiki/Whisper-v6-RPC-API">Whisper V6 RPC API</a>.</p>
<h2 id="wire-protocol-3"><a class="header" href="#wire-protocol-3">Wire Protocol</a></h2>
<h3 id="transport"><a class="header" href="#transport">Transport</a></h3>
<p>Nodes SHOULD expose a <a href="https://www.jsonrpc.org/specification">JSON RPC</a> API
that can be accessed.
The JSON RPC version SHOULD be <code>2.0</code>.
Below is an example request:</p>
<pre><code class="language-json">{
  "jsonrpc":"2.0",
  "method":"waku_version",
  "params":[],
  "id":1
}
</code></pre>
<h4 id="fields-1"><a class="header" href="#fields-1">Fields</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody>
<tr><td><code>jsonrpc</code></td><td>Contains the used JSON RPC version (<code>Default: 2.0</code>)</td></tr>
<tr><td><code>method</code></td><td>Contains the JSON RPC method that is being called</td></tr>
<tr><td><code>params</code></td><td>An array of parameters for the request</td></tr>
<tr><td><code>id</code></td><td>The request ID</td></tr>
</tbody></table>
</div>
<h3 id="objects"><a class="header" href="#objects">Objects</a></h3>
<p>In this section you will find objects used throughout the JSON RPC API.</p>
<h4 id="message-1"><a class="header" href="#message-1">Message</a></h4>
<p>The message object represents a Waku message.
Below you will find the description of the attributes contained in the message object.
A message is the decrypted payload and
padding of an <a href="waku/standards/legacy/9/../7/data.html">envelope</a> along with all of its metadata and
other extra information such as the hash.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>sig</code></td><td style="text-align: center">string</td><td>Public Key that signed this message</td></tr>
<tr><td style="text-align: right"><code>recipientPublicKey</code></td><td style="text-align: center">string</td><td>The recipients public key</td></tr>
<tr><td style="text-align: right"><code>ttl</code></td><td style="text-align: center">number</td><td>Time-to-live in seconds</td></tr>
<tr><td style="text-align: right"><code>timestamp</code></td><td style="text-align: center">number</td><td>Unix timestamp of the message generation</td></tr>
<tr><td style="text-align: right"><code>topic</code></td><td style="text-align: center">string</td><td>4 bytes, the message topic</td></tr>
<tr><td style="text-align: right"><code>payload</code></td><td style="text-align: center">string</td><td>Decrypted payload</td></tr>
<tr><td style="text-align: right"><code>padding</code></td><td style="text-align: center">string</td><td>Optional padding, byte array of arbitrary length</td></tr>
<tr><td style="text-align: right"><code>pow</code></td><td style="text-align: center">number</td><td>The proof of work value</td></tr>
<tr><td style="text-align: right"><code>hash</code></td><td style="text-align: center">string</td><td>Hash of the enveloped message</td></tr>
</tbody></table>
</div>
<h4 id="filter"><a class="header" href="#filter">Filter</a></h4>
<p>The filter object represents filters that can be applied to retrieve messages.
Below you will find the description of the attributes contained in the filter object.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>symKeyID</code></td><td style="text-align: center">string</td><td>ID of the symmetric key for message decryption</td></tr>
<tr><td style="text-align: right"><code>privateKeyID</code></td><td style="text-align: center">string</td><td>ID of private (asymmetric) key for message decryption</td></tr>
<tr><td style="text-align: right"><code>sig</code></td><td style="text-align: center">string</td><td>Public key of the signature</td></tr>
<tr><td style="text-align: right"><code>minPow</code></td><td style="text-align: center">number</td><td>Minimal PoW requirement for incoming messages</td></tr>
<tr><td style="text-align: right"><code>topics</code></td><td style="text-align: center">array</td><td>Array of possible topics, this can also contain partial topics</td></tr>
<tr><td style="text-align: right"><code>allowP2P</code></td><td style="text-align: center">boolean</td><td>Indicates if this filter allows processing of direct peer-to-peer messages</td></tr>
</tbody></table>
</div>
<p>All fields are optional, however <code>symKeyID</code> or <code>privateKeyID</code> must be present,
it cannot be both.
Additionally, the <code>topics</code> field is only optional when an asymmetric key is used.</p>
<h3 id="methods"><a class="header" href="#methods">Methods</a></h3>
<h4 id="waku_version"><a class="header" href="#waku_version"><code>waku_version</code></a></h4>
<p>The <code>waku_version</code> method returns the current version number.</p>
<h5 id="parameters-1"><a class="header" href="#parameters-1">Parameters</a></h5>
<p>none</p>
<h5 id="response-1"><a class="header" href="#response-1">Response</a></h5>
<ul>
<li><strong>string</strong> - The version number.</li>
</ul>
<h4 id="waku_info"><a class="header" href="#waku_info"><code>waku_info</code></a></h4>
<p>The <code>waku_info</code> method returns information about a Waku node.</p>
<p>Parameters</p>
<p>none</p>
<p>Response</p>
<p>The response is an <code>Object</code> containing the following fields:</p>
<ul>
<li><strong><code>minPow</code> [number]</strong> - The current PoW requirement.</li>
<li><strong><code>maxEnvelopeSize</code> [float]</strong> - The current maximum envelope size in bytes.</li>
<li><strong><code>memory</code> [number]</strong> - The memory size of the floating messages in bytes.</li>
<li><strong><code>envelopes</code> [number]</strong> - The number of floating envelopes.</li>
</ul>
<h4 id="waku_setmaxenvelopesize"><a class="header" href="#waku_setmaxenvelopesize"><code>waku_setMaxEnvelopeSize</code></a></h4>
<p>Sets the maximum envelope size allowed by this node.
Any envelopes larger than this size both incoming and outgoing will be rejected.
The envelope size can never exceed the underlying envelope size of <code>10mb</code>.</p>
<p>Parameters</p>
<ul>
<li><strong>number</strong> - The message size in bytes.</li>
</ul>
<p>Response</p>
<ul>
<li><strong>bool</strong> -
<code>true</code> on success or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h4 id="waku_setminpow"><a class="header" href="#waku_setminpow"><code>waku_setMinPoW</code></a></h4>
<p>Sets the minimal PoW required by this node.</p>
<p>Parameters</p>
<ul>
<li><strong>number</strong> - The new PoW requirement.</li>
</ul>
<p>Response</p>
<ul>
<li><strong>bool</strong> -
<code>true</code> on success or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h4 id="waku_marktrustedpeer"><a class="header" href="#waku_marktrustedpeer"><code>waku_markTrustedPeer</code></a></h4>
<p>Marks a specific peer as trusted allowing it to send expired messages.</p>
<p>Parameters</p>
<ul>
<li><strong>string</strong> - <code>enode</code> of the peer.</li>
</ul>
<p>Response</p>
<ul>
<li><strong>bool</strong> -
<code>true</code> on success or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h4 id="waku_newkeypair"><a class="header" href="#waku_newkeypair"><code>waku_newKeyPair</code></a></h4>
<p>Generates a keypair used for message encryption and decryption.</p>
<p>Parameters</p>
<p>none</p>
<p>Response</p>
<ul>
<li><strong>string</strong> -
Key ID on success or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h4 id="waku_addprivatekey"><a class="header" href="#waku_addprivatekey"><code>waku_addPrivateKey</code></a></h4>
<p>Stores a key and returns its ID.</p>
<p>Parameters</p>
<ul>
<li><strong>string</strong> - Private key as hex bytes.</li>
</ul>
<p>Response</p>
<ul>
<li><strong>string</strong> - Key ID on success or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h4 id="waku_deletekeypair"><a class="header" href="#waku_deletekeypair"><code>waku_deleteKeyPair</code></a></h4>
<p>Deletes a specific key if it exists.</p>
<p>Parameters</p>
<ul>
<li><strong>string</strong> - ID of the Key pair.</li>
</ul>
<p>Response</p>
<ul>
<li><strong>bool</strong> - <code>true</code> on success or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h4 id="waku_haskeypair"><a class="header" href="#waku_haskeypair"><code>waku_hasKeyPair</code></a></h4>
<p>Checks if the node has a private key of a key pair matching the given ID.</p>
<p>Parameters</p>
<ul>
<li><strong>string</strong> - ID of the Key pair.</li>
</ul>
<p>Response</p>
<ul>
<li><strong>bool</strong> -
<code>true</code> or
<code>false</code> or an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h4 id="waku_getpublickey"><a class="header" href="#waku_getpublickey"><code>waku_getPublicKey</code></a></h4>
<p>Returns the public key for an ID.</p>
<p>Parameters</p>
<ul>
<li><strong>string</strong> - ID of the Key.</li>
</ul>
<p>Response</p>
<ul>
<li><strong>string</strong> - The public key or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h4 id="waku_getprivatekey"><a class="header" href="#waku_getprivatekey"><code>waku_getPrivateKey</code></a></h4>
<p>Returns the private key for an ID.</p>
<p>Parameters</p>
<ul>
<li><strong>string</strong> - ID of the Key.</li>
</ul>
<p>Response</p>
<ul>
<li><strong>string</strong> - The private key or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h4 id="waku_newsymkey"><a class="header" href="#waku_newsymkey"><code>waku_newSymKey</code></a></h4>
<p>Generates a random symmetric key and stores it under an ID.
This key can be used to encrypt and
decrypt messages where the key is known to both parties.</p>
<p>Parameters</p>
<p>none</p>
<p>Response</p>
<ul>
<li><strong>string</strong> - The key ID or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h4 id="waku_addsymkey"><a class="header" href="#waku_addsymkey"><code>waku_addSymKey</code></a></h4>
<p>Stores the key and returns its ID.</p>
<p>Parameters</p>
<ul>
<li><strong>string</strong> - The raw key for symmetric encryption hex encoded.</li>
</ul>
<p>Response</p>
<ul>
<li><strong>string</strong> - The key ID or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h4 id="waku_generatesymkeyfrompassword"><a class="header" href="#waku_generatesymkeyfrompassword"><code>waku_generateSymKeyFromPassword</code></a></h4>
<p>Generates the key from a password and stores it.</p>
<p>Parameters</p>
<ul>
<li><strong>string</strong> - The password.</li>
</ul>
<p>Response</p>
<ul>
<li><strong>string</strong> - The key ID or an <a href="https://www.jsonrpc.org/specification#error_object">error</a>
on failure.</li>
</ul>
<h4 id="waku_hassymkey"><a class="header" href="#waku_hassymkey"><code>waku_hasSymKey</code></a></h4>
<p>Returns whether there is a key associated with the ID.</p>
<p>Parameters</p>
<ul>
<li><strong>string</strong> - ID of the Key.</li>
</ul>
<p>Response</p>
<ul>
<li><strong>bool</strong> - <code>true</code> or <code>false</code> or an <a href="https://www.jsonrpc.org/specification#error_object">error</a>
on failure.</li>
</ul>
<h4 id="waku_getsymkey"><a class="header" href="#waku_getsymkey"><code>waku_getSymKey</code></a></h4>
<p>Returns the symmetric key associated with an ID.</p>
<p>Parameters</p>
<ul>
<li><strong>string</strong> - ID of the Key.</li>
</ul>
<p>Response</p>
<ul>
<li><strong>string</strong> - Raw key on success or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> of failure.</li>
</ul>
<h4 id="waku_deletesymkey"><a class="header" href="#waku_deletesymkey"><code>waku_deleteSymKey</code></a></h4>
<p>Deletes the key associated with an ID.</p>
<p>Parameters</p>
<ul>
<li><strong>string</strong> - ID of the Key.</li>
</ul>
<p>Response</p>
<ul>
<li><strong>bool</strong> -
<code>true</code> or <code>false</code> or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h4 id="waku_subscribe"><a class="header" href="#waku_subscribe"><code>waku_subscribe</code></a></h4>
<p>Creates and
registers a new subscription to receive notifications for inbound Waku messages.</p>
<p>Parameters</p>
<p>The parameters for this request is an array containing the following fields:</p>
<ol>
<li><strong>string</strong> - The ID of the function call,
in case of Waku this must contain the value "messages".</li>
<li><strong>object</strong> - The <a href="waku/standards/legacy/9/rpc.html#filter">message filter</a>.</li>
</ol>
<p>Response</p>
<ul>
<li><strong>string</strong> - ID of the subscription or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<p>Notifications</p>
<p>Notifications received by the client contain a <a href="waku/standards/legacy/9/rpc.html#message">message</a> matching the filter.
Below is an example notification:</p>
<pre><code class="language-json">{
  "jsonrpc": "2.0",
  "method": "waku_subscription",
  "params": {
    "subscription": "02c1f5c953804acee3b68eda6c0afe3f1b4e0bec73c7445e10d45da333616412",
    "result": {
      "sig": "0x0498ac1951b9078a0549c93c3f6088ec7c790032b17580dc3c0c9e900899a48d89eaa27471e3071d2de6a1f48716ecad8b88ee022f4321a7c29b6ffcbee65624ff",
      "recipientPublicKey": null,
      "ttl": 10,
      "timestamp": 1498577270,
      "topic": "0xffaadd11",
      "payload": "0xffffffdddddd1122",
      "padding": "0x35d017b66b124dd4c67623ed0e3f23ba68e3428aa500f77aceb0dbf4b63f69ccfc7ae11e39671d7c94f1ed170193aa3e327158dffdd7abb888b3a3cc48f718773dc0a9dcf1a3680d00fe17ecd4e8d5db31eb9a3c8e6e329d181ecb6ab29eb7a2d9889b49201d9923e6fd99f03807b730780a58924870f541a8a97c87533b1362646e5f573dc48382ef1e70fa19788613c9d2334df3b613f6e024cd7aadc67f681fda6b7a84efdea40cb907371cd3735f9326d02854",
      "pow": 0.6714754098360656,
      "hash": "0x17f8066f0540210cf67ef400a8a55bcb32a494a47f91a0d26611c5c1d66f8c57"
    }
  }
}
</code></pre>
<h4 id="waku_unsubscribe"><a class="header" href="#waku_unsubscribe"><code>waku_unsubscribe</code></a></h4>
<p>Cancels and removes an existing subscription.
The node MUST stop sending the client notifications.</p>
<p>Parameters</p>
<ul>
<li><strong>string</strong> - The subscription ID.</li>
</ul>
<p>Response</p>
<ul>
<li><strong>bool</strong> - <code>true</code> or <code>false</code></li>
</ul>
<h4 id="waku_newmessagefilter"><a class="header" href="#waku_newmessagefilter"><code>waku_newMessageFilter</code></a></h4>
<p>Creates a new message filter within the node.
This filter can be used to poll for new messages that match the criteria.</p>
<p>Parameters</p>
<p>The request must contain a <a href="waku/standards/legacy/9/rpc.html#filter">message filter</a> as its parameter.</p>
<p>Response</p>
<ul>
<li><strong>string</strong> - The ID of the filter.</li>
</ul>
<h4 id="waku_deletemessagefilter"><a class="header" href="#waku_deletemessagefilter"><code>waku_deleteMessageFilter</code></a></h4>
<p>Removes a message filter from the node.</p>
<p>Parameters</p>
<ul>
<li><strong>string</strong> - ID of the filter created with <a href="waku/standards/legacy/9/rpc.html#waku_newmessagefilter"><code>waku_newMessageFilter</code></a>.</li>
</ul>
<p>Response</p>
<ul>
<li><strong>bool</strong> - <code>true</code> on success or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h4 id="waku_getfiltermessages"><a class="header" href="#waku_getfiltermessages"><code>waku_getFilterMessages</code></a></h4>
<p>Retrieves messages that match a filter criteria and
were received after the last time this function was called.</p>
<p>Parameters</p>
<ul>
<li><strong>string</strong> - ID of the filter created with <a href="waku/standards/legacy/9/rpc.html#waku_newmessagefilter"><code>waku_newMessageFilter</code></a>.</li>
</ul>
<p>Response</p>
<p>The response contains an array of <a href="waku/standards/legacy/9/rpc.html#message">messages</a> or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</p>
<h4 id="waku_post"><a class="header" href="#waku_post"><code>waku_post</code></a></h4>
<p>The <code>waku_post</code> method creates a waku envelope and propagates it to the network.</p>
<p>Parameters</p>
<p>The parameters is an <code>Object</code> containing the following fields:</p>
<ul>
<li><strong><code>symKeyID</code> [string]</strong> <code>optional</code> - The ID of the symmetric key used for encryption</li>
<li><strong><code>pubKey</code> [string]</strong> <code>optional</code> - The public key for message encryption.</li>
<li><strong><code>sig</code> [string]</strong> <code>optional</code> - The ID of the signing key.</li>
<li><strong><code>ttl</code> [number]</strong> - The time-to-live in seconds.</li>
<li><strong><code>topic</code> [string]</strong> - 4 bytes message topic.</li>
<li><strong><code>payload</code> [string]</strong> - The payload to be encrypted.</li>
<li><strong><code>padding</code> [string]</strong> <code>optional</code> - The padding, a byte array of arbitrary length.</li>
<li><strong><code>powTime</code> [number]</strong> - Maximum time in seconds to be spent on the proof of work.</li>
<li><strong><code>powTarget</code> [number]</strong> - Minimal PoW target required for this message.</li>
<li><strong><code>targetPeer</code> [string]</strong> <code>optional</code> - The optional peer ID for peer-to-peer messages.</li>
</ul>
<p><em>Either the <strong><code>symKeyID</code></strong> or the <strong><code>pubKey</code></strong> need to be present.
It can not be both.</em></p>
<p>Response</p>
<ul>
<li><strong>bool</strong> -
<code>true</code> on success or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h2 id="changelog-2"><a class="header" href="#changelog-2">Changelog</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Version</th><th>Comment</th></tr></thead><tbody>
<tr><td style="text-align: center"><a href="https://github.com/vacp2p/specs/commit/bc7e75ebb2e45d2cbf6ab27352c113e666df37c8">1.0.0</a></td><td>Initial release.</td></tr>
</tbody></table>
</div>
<h2 id="copyright-36"><a class="header" href="#copyright-36">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="waku-informational-rfcs"><a class="header" href="#waku-informational-rfcs">Waku Informational RFCs</a></h1>
<p>Informational Waku documents covering guidance, examples, and supporting material.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="22toy-chat"><a class="header" href="#22toy-chat">22/TOY-CHAT</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v2 Toy Chat</td></tr>
<tr><th>Slug</th><td>22</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Franck Royer &lt;franck@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Hanno Cornelius &lt;hanno@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-41"><a class="header" href="#timeline-41">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/informational/22/toy-chat.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/informational/22/toy-chat.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/informational/22/toy-chat.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/722c3d2bcfcc260f25c10b19a7bb57f1bd6127ba/waku/informational/22/toy-chat.md"><code>722c3d2</code></a> — Rename TOY-CHAT.md to toy-chat.md</li>
<li><strong>2024-01-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/5c5ea36a47d9a364a4c0dd930cf22974029d20c7/waku/informational/22/TOY-CHAT.md"><code>5c5ea36</code></a> — Update TOY-CHAT.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/411e1354d7ff125c5cf996e8813c3f29a321f716/waku/informational/22/TOY-CHAT.md"><code>411e135</code></a> — Create TOY-CHAT.md</li>
</ul>
<!-- timeline:end -->
<p><strong>Content Topic</strong>: <code>/toy-chat/2/huilong/proto</code>.</p>
<p>This specification explains a toy chat example using Waku v2.
This protocol is mainly used to:</p>
<ol>
<li>Dogfood Waku v2,</li>
<li>Show an example of how to use Waku v2.</li>
</ol>
<p>Currently, all main Waku v2 implementations support the toy chat protocol:
<a href="https://github.com/status-im/nim-waku/blob/master/examples/v2/chat2.nim">nim-waku</a>,
js-waku (<a href="https://github.com/status-im/js-waku/tree/main/examples/cli-chat">NodeJS</a>
and <a href="https://github.com/status-im/js-waku/tree/main/examples/web-chat">web</a>)
and <a href="https://github.com/status-im/go-waku/tree/master/examples/chat2">go-waku</a>.</p>
<p>Note that this is completely separate from the protocol the Status app
is using for its chat functionality.</p>
<h2 id="design"><a class="header" href="#design">Design</a></h2>
<p>The chat protocol enables sending and receiving messages in a chat room.
There is currently only one chat room, which is tied to the content topic.
The messages SHOULD NOT be encrypted.</p>
<p>The <code>contentTopic</code> MUST be set to <code>/toy-chat/2/huilong/proto</code>.</p>
<h2 id="payloads-5"><a class="header" href="#payloads-5">Payloads</a></h2>
<pre><code class="language-protobuf">syntax = "proto3";

message Chat2Message {
   uint64 timestamp = 1;
   string nick = 2;
   bytes payload = 3;
}
</code></pre>
<ul>
<li><code>timestamp</code>: The time at which the message was sent, in Unix Epoch seconds,</li>
<li><code>nick</code>: The nickname of the user sending the message,</li>
<li><code>payload</code>: The text of the messages, UTF-8 encoded.</li>
</ul>
<h2 id="copyright-37"><a class="header" href="#copyright-37">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="23waku2-topics"><a class="header" href="#23waku2-topics">23/WAKU2-TOPICS</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v2 Topic Usage Recommendations</td></tr>
<tr><th>Slug</th><td>23</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Category</th><td>Informational</td></tr>
<tr><th>Editor</th><td>Oskar Thoren &lt;oskarth@titanproxy.com&gt;</td></tr>
<tr><th>Contributors</th><td>Hanno Cornelius &lt;hanno@status.im&gt;<br>Daniel Kaiser &lt;danielkaiser@status.im&gt;<br>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-42"><a class="header" href="#timeline-42">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/informational/23/topics.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/informational/23/topics.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/4df2d5f78797cd591d0fbe835444be6c3a596810/waku/informational/23/topics.md"><code>4df2d5f</code></a> — update waku/informational/23/topics.md (#144)</li>
<li><strong>2025-01-02</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/dc7497a3123623f2834d80ebd3a7c77e0d605074/waku/informational/23/topics.md"><code>dc7497a</code></a> — add usage guidelines for waku content topics (#117)</li>
<li><strong>2024-11-20</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/ff87c84dc71d4f933bab188993914069fea12baa/waku/informational/23/topics.md"><code>ff87c84</code></a> — Update Waku Links (#104)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/informational/23/topics.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/informational/23/topics.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-07</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/e63d8a0e67d1a32cbca1aeea072c0293a117beb5/waku/informational/23/topics.md"><code>e63d8a0</code></a> — Update topics.md</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b8f088c89611d117b58883663c55e3b402e95846/waku/informational/23/topics.md"><code>b8f088c</code></a> — Update and rename README.md to topics.md</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2b693e8551c228418be07c0c764f18df8dcc8b5e/waku/informational/23/README.md"><code>2b693e8</code></a> — Update README.md</li>
<li><strong>2024-01-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/055c5254f675fdd7227772d0f371386c41201384/waku/informational/23/README.md"><code>055c525</code></a> — Update README.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/informational/23/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/a11dfed6e2622d8c71b1d5ba41f236b69192d9dc/waku/rfcs/informational/23/README.md"><code>a11dfed</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<p>This document outlines recommended usage of topic names in Waku v2.
In <a href="waku/informational/23//waku/standards/core/10/waku2.html">10/WAKU2 spec</a> there are two types of topics:</p>
<ul>
<li>Pubsub topics, used for routing</li>
<li>Content topics, used for content-based filtering</li>
</ul>
<h2 id="pubsub-topics"><a class="header" href="#pubsub-topics">Pubsub Topics</a></h2>
<p>Pubsub topics are used for routing of messages (see <a href="waku/informational/23//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a>),
and can be named implicitly by Waku sharding (see <a href="https://github.com/waku-org/specs/blob/master/standards/core/relay-sharding.md">RELAY-SHARDING</a>).
This document comprises recommendations for explicitly naming pubsub topics
(e.g. when choosing <em>named sharding</em> as specified in <a href="https://github.com/waku-org/specs/blob/master/standards/core/relay-sharding.md">RELAY-SHARDING</a>).</p>
<h3 id="pubsub-topic-format"><a class="header" href="#pubsub-topic-format">Pubsub Topic Format</a></h3>
<p>Pubsub topics SHOULD follow the following structure:</p>
<p><code>/waku/2/{topic-name}</code></p>
<p>This namespaced structure makes compatibility, discoverability,
and automatic handling of new topics easier.</p>
<p>The first two parts indicate:</p>
<ol>
<li>it relates to the Waku protocol domain, and</li>
<li>the version is 2.</li>
</ol>
<p>If applicable, it is RECOMMENDED to structure <code>{topic-name}</code>
in a hierarchical way as well.</p>
<blockquote>
<p><em>Note</em>: In previous versions of this document, the structure was <code>/waku/2/{topic-name}/{encoding}</code>.
The now deprecated <code>/{encoding}</code> was always set to <code>/proto</code>,
which indicated that the <a href="waku/informational/23//waku/standards/core/11/relay.html#protobuf-definition">data field</a>
in pubsub is serialized/encoded as protobuf.
The inspiration for this format was taken from
<a href="https://github.com/ethereum/eth2.0-specs/blob/dev/specs/phase0/p2p-interface.md#topics-and-messages">Ethereum 2 P2P spec</a>.
However, because the payload of messages transmitted over <a href="waku/informational/23//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a>
must be a <a href="waku/informational/23//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a>,
which specifies the wire format as protobuf,<code>/proto</code> is the only valid encoding.
This makes the <code>/proto</code> indication obsolete.
The encoding of the <code>payload</code> field of a WakuMessage
is indicated by the <code>/{encoding}</code> part of the content topic name.
Specifying an encoding is only significant for the actual payload/data field.
Waku preserves this option by allowing to specify an encoding
for the WakuMessage payload field as part of the content topic name.</p>
</blockquote>
<h3 id="default-pubsub-topic"><a class="header" href="#default-pubsub-topic">Default PubSub Topic</a></h3>
<p>The Waku v2 default pubsub topic is:</p>
<p><code>/waku/2/default-waku/proto</code></p>
<p>The <code>{topic name}</code> part is <code>default-waku/proto</code>,
which indicates it is default topic for exchanging WakuMessages;
<code>/proto</code> remains for backwards compatibility.</p>
<h3 id="application-specific-names"><a class="header" href="#application-specific-names">Application Specific Names</a></h3>
<p>Larger apps can segregate their pubsub meshes using topics named like:</p>
<pre><code class="language-text">/waku/2/status/
/waku/2/walletconnect/
</code></pre>
<p>This indicates that these networks carry WakuMessages,
but for different domains completely.</p>
<h3 id="named-topic-sharding-example"><a class="header" href="#named-topic-sharding-example">Named Topic Sharding Example</a></h3>
<p>The following is an example of named sharding, as specified in <a href="https://github.com/waku-org/specs/blob/master/standards/core/relay-sharding.md">RELAY-SHARDING</a>.</p>
<pre><code class="language-text">waku/2/waku-9_shard-0/
...
waku/2/waku-9_shard-9/
</code></pre>
<p>This indicates explicitly that the network traffic has been partitioned into 10 buckets.</p>
<h2 id="content-topics"><a class="header" href="#content-topics">Content Topics</a></h2>
<p>The other type of topic that exists in Waku v2 is a content topic.
This is used for content based filtering.
See <a href="waku/informational/23//waku/standards/core/14/message.html">14/WAKU2-MESSAGE spec</a>
for where this is specified.
Note that this doesn't impact routing of messages between relaying nodes,
but it does impact using request/reply protocols such as
<a href="waku/informational/23//waku/standards/core/12/filter.html">12/WAKU2-FILTER</a> and
<a href="waku/informational/23//waku/standards/core/13/store.html">13/WAKU2-STORE</a>.</p>
<p>This is especially useful for nodes that have limited bandwidth,
and only want to pull down messages that match this given content topic.</p>
<p>Since all messages are relayed using the relay protocol regardless of content topic,
you MAY use any content topic you wish
without impacting how messages are relayed.</p>
<h3 id="content-topic-format"><a class="header" href="#content-topic-format">Content Topic Format</a></h3>
<p>The format for content topics is as follows:</p>
<p><code>/{application-name}/{version-of-the-application}/{content-topic-name}/{encoding}</code></p>
<p>The name of a content topic is application-specific.
As an example, here's the content topic used for an upcoming testnet:</p>
<p><code>/toychat/2/huilong/proto</code></p>
<h3 id="content-topic-naming-recommendations"><a class="header" href="#content-topic-naming-recommendations">Content Topic Naming Recommendations</a></h3>
<p>Application names SHOULD be unique to avoid conflicting issues with other protocols.
Application version (if applicable) SHOULD be specified in the version field.
The <code>{content-topic-name}</code> portion of the content topic is up to the application,
and depends on the problem domain.
It can be hierarchical, for instance to separate content, or
to indicate different bandwidth and privacy guarantees.
The encoding field indicates the serialization/encoding scheme
for the <a href="waku/informational/23//waku/standards/core/14/message.html#payloads">WakuMessage payload</a> field.</p>
<h3 id="content-topic-usage-guidelines"><a class="header" href="#content-topic-usage-guidelines">Content Topic usage guidelines</a></h3>
<p>Applications SHOULD be mindful while designing/using content topics
so that a bloat of content-topics does not happen.
A content-topic bloat causes performance degradation in Store
and Filter protocols while trying to retrieve messages.</p>
<p>Store queries have been noticed to be considerably slow
(e.g doubling of response-time when content-topic count is increased from 10 to 100)
when a lot of content-topics are involved in a single query.
Similarly, a number of filter subscriptions increase,
which increases complexity on client side to maintain
and manage these subscriptions.</p>
<p>Applications SHOULD analyze the query/filter criteria for fetching messages from the network
and select/design content topics to match such filter criteria.
e.g: even though applications may want to segregate messages into different sets
based on some application logic,
if those sets of messages are always fetched/queried together from the network,
then all those messages SHOULD use a single content-topic.</p>
<h2 id="differences-with-waku-v1"><a class="header" href="#differences-with-waku-v1">Differences with Waku v1</a></h2>
<p>In <a href="waku/informational/23//waku/deprecated/5/waku0.html">5/WAKU1</a> there is no actual routing.
All messages are sent to all other nodes.
This means that we are implicitly using the same pubsub topic
that would be something like:</p>
<pre><code class="language-text">/waku/1/default-waku/rlp
</code></pre>
<p>Topics in Waku v1 correspond to Content Topics in Waku v2.</p>
<h3 id="bridging-waku-v1-and-waku-v2"><a class="header" href="#bridging-waku-v1-and-waku-v2">Bridging Waku v1 and Waku v2</a></h3>
<p>To bridge Waku v1 and Waku v2 we have a <a href="waku/informational/23//waku/standards/core/15/bridge.html">15/WAKU-BRIDGE</a>.
For mapping Waku v1 topics to Waku v2 content topics,
the following structure for the content topic SHOULD be used:</p>
<pre><code class="language-text">/waku/1/&lt;4bytes-waku-v1-topic&gt;/rfc26
</code></pre>
<p>The <code>&lt;4bytes-waku-v1-topic&gt;</code> SHOULD be the lowercase hex representation
of the 4-byte Waku v1 topic.
A <code>0x</code> prefix SHOULD be used.
<code>/rfc26</code> indicates that the bridged content is encoded according to RFC <a href="waku/informational/23//waku/standards/application/26/payload.html">26/WAKU2-PAYLOAD</a>.
See <a href="waku/informational/23//waku/standards/core/15/bridge.html">15/WAKU-BRIDGE</a>
for a description of the bridged fields.</p>
<p>This creates a direct mapping between the two protocols.
For example:</p>
<pre><code class="language-text">/waku/1/0x007f80ff/rfc26
</code></pre>
<h2 id="copyright-38"><a class="header" href="#copyright-38">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-30"><a class="header" href="#references-30">References</a></h2>
<ul>
<li><a href="waku/informational/23//waku/standards/core/10/waku2.html">10/WAKU2 spec</a></li>
<li><a href="waku/informational/23//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a></li>
<li><a href="https://github.com/waku-org/specs/blob/master/standards/core/relay-sharding.md">RELAY-SHARDING</a></li>
<li><a href="https://github.com/ethereum/eth2.0-specs/blob/dev/specs/phase0/p2p-interface.md#topics-and-messages">Ethereum 2 P2P spec</a></li>
<li><a href="waku/informational/23//waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a></li>
<li><a href="waku/informational/23//waku/standards/core/12/filter.html">12/WAKU2-FILTER</a></li>
<li><a href="waku/informational/23//waku/standards/core/13/store.html">13/WAKU2-STORE</a></li>
<li><a href="waku/informational/23//waku/deprecated/5/waku0.html">6/WAKU1</a></li>
<li><a href="waku/informational/23//waku/standards/core/15/bridge.html">15/WAKU-BRIDGE</a></li>
<li><a href="waku/informational/23//waku/standards/application/26/payload.html">26/WAKU-PAYLOAD</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="27waku2-peers"><a class="header" href="#27waku2-peers">27/WAKU2-PEERS</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v2 Client Peer Management Recommendations</td></tr>
<tr><th>Slug</th><td>27</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Hanno Cornelius &lt;hanno@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-43"><a class="header" href="#timeline-43">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/informational/27/peers.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/informational/27/peers.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/af7c413e64bf1e9f57a68c22b7237883b080939a/waku/informational/27/peers.md"><code>af7c413</code></a> — update waku/informational/27/peers.md (#145)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/informational/27/peers.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/informational/27/peers.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/4b77d10404952e0409f68a41620ea73c82bd644c/waku/informational/27/peers.md"><code>4b77d10</code></a> — Update and rename README.md to peers.md</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/e65c3591d7991e2f24a4632a6186ed1cef970326/waku/informational/27/README.md"><code>e65c359</code></a> — Update README.md</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/4a78cacb58706e1bb6f5b9b8d40e3fb27bc77cba/waku/informational/27/README.md"><code>4a78cac</code></a> — Update README.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/informational/27/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/7daec2f2f940535b38cc4e6d00c059a706ace3c9/waku/rfcs/informational/27/README.md"><code>7daec2f</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<p><code>27/WAKU2-PEERS</code> describes a recommended minimal set of peer storage and
peer management features to be implemented by Waku v2 clients.</p>
<p>In this context, peer <em>storage</em> refers to a client's ability to keep track of discovered
or statically-configured peers and their metadata.
It also deals with matters of peer <em>persistence</em>,
or the ability to store peer data on disk to resume state after a client restart.</p>
<p>Peer <em>management</em> is a closely related concept and
refers to the set of actions a client MAY choose to perform
based on its knowledge of its connected peers,
e.g. triggering reconnects/disconnects,
keeping certain connections alive, etc.</p>
<h2 id="peer-store"><a class="header" href="#peer-store">Peer store</a></h2>
<p>The peer store SHOULD be an in-memory data structure
where information about discovered or configured peers are stored.
It SHOULD be considered the main source of truth
for peer-related information in a Waku v2 client.
Clients MAY choose to persist this store on-disk.</p>
<h3 id="tracked-peer-metadata"><a class="header" href="#tracked-peer-metadata">Tracked peer metadata</a></h3>
<p>It is RECOMMENDED that a Waku v2 client tracks at least the following information
about each of its peers in a peer store:</p>
<div class="table-wrapper"><table><thead><tr><th>Metadata</th><th>Description</th></tr></thead><tbody>
<tr><td><em>Public key</em></td><td>The public key for this peer. This is related to the libp2p <a href="https://docs.libp2p.io/concepts/peer-id/"><code>Peer ID</code></a>.</td></tr>
<tr><td><em>Addresses</em></td><td>Known transport layer <a href="https://docs.libp2p.io/concepts/addressing/"><code>multiaddrs</code></a> for this peer.</td></tr>
<tr><td><em>Protocols</em></td><td>The libp2p <a href="https://docs.libp2p.io/concepts/protocols/#protocol-ids"><code>protocol IDs</code></a> supported by this peer. This can be used to track the client's connectivity to peers supporting different Waku v2 protocols, e.g. <a href="waku/informational/27/../../standards/core/11/relay.html"><code>11/WAKU2-RELAY</code></a> or <a href="waku/informational/27/../../standards/core/13/store.html"><code>13/WAKU2-STORE</code></a>.</td></tr>
<tr><td><em>Connectivity</em></td><td>Tracks the peer's current connectedness state. See <a href="waku/informational/27/peers.html#peer-connectivity"><strong>Peer connectivity</strong></a> below.</td></tr>
<tr><td><em>Disconnect time</em></td><td>The timestamp at which this peer last disconnected. This becomes important when managing <a href="waku/informational/27/peers.html#reconnecting-peers">peer reconnections</a></td></tr>
</tbody></table>
</div>
<h3 id="peer-connectivity"><a class="header" href="#peer-connectivity">Peer connectivity</a></h3>
<p>A Waku v2 client SHOULD track <em>at least</em> the following connectivity states
for each of its peers:</p>
<ul>
<li><strong><code>NotConnected</code></strong>: The peer has been discovered or configured on this client,
but no attempt has yet been made to connect to this peer.
This is the default state for a new peer.</li>
<li><strong><code>CannotConnect</code></strong>: The client attempted to connect to this peer, but failed.</li>
<li><strong><code>CanConnect</code></strong>: The client was recently connected to this peer and
disconnected gracefully.</li>
<li><strong><code>Connected</code></strong>: The client is actively connected to this peer.</li>
</ul>
<p>This list does not preclude clients from tracking more advanced connectivity metadata,
such as a peer's blacklist status (see <a href="waku/informational/27//waku/deprecated/18/swap.html"><code>18/WAKU2-SWAP</code></a>).</p>
<h3 id="persistence"><a class="header" href="#persistence">Persistence</a></h3>
<p>A Waku v2 client MAY choose to persist peers across restarts,
using any offline storage technology, such as an on-disk database.
Peer persistence MAY be used to resume peer connections after a client restart.</p>
<h2 id="peer-management"><a class="header" href="#peer-management">Peer management</a></h2>
<p>Waku v2 clients will have different requirements
when it comes to managing the peers tracked in the <a href="waku/informational/27/peers.html#peer-store"><strong>peer store</strong></a>.
It is RECOMMENDED that clients support:</p>
<ul>
<li><a href="waku/informational/27/peers.html#reconnecting-peers">automatic reconnection</a> to peers under certain conditions</li>
<li><a href="waku/informational/27/peers.html#connection-keep-alive">connection keep-alive</a></li>
</ul>
<h3 id="reconnecting-peers"><a class="header" href="#reconnecting-peers">Reconnecting peers</a></h3>
<p>A Waku v2 client MAY choose to reconnect to previously connected,
managed peers under certain conditions.
Such conditions include, but are not limited to:</p>
<ul>
<li>Reconnecting to all <code>relay</code>-capable peers after a client restart.
This will require <a href="waku/informational/27/peers.html#persistence">persistent peer storage</a>.</li>
</ul>
<p>If a client chooses to automatically reconnect to previous peers,
it MUST respect the
<a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md#prune-backoff-and-peer-exchange">backing off period</a>
specified for GossipSub v1.1 before attempting to reconnect.
This requires keeping track of the <a href="waku/informational/27/peers.html#tracked-peer-metadata">last time each peer was disconnected</a>.</p>
<h3 id="connection-keep-alive"><a class="header" href="#connection-keep-alive">Connection keep-alive</a></h3>
<p>A Waku v2 client MAY choose to implement a keep-alive mechanism to certain peers.
If a client chooses to implement keep-alive on a connection,
it SHOULD do so by sending periodic <a href="https://docs.libp2p.io/concepts/fundamentals/protocols/#ping">libp2p pings</a>
as per <code>10/WAKU2</code> <a href="waku/informational/27//waku/standards/core/10/waku2.html#recommendations-for-clients">client recommendations</a>.
The recommended period between pings SHOULD be <em>at most</em> 50%
of the shortest idle connection timeout for the specific client and transport.
For example, idle TCP connections often times out after 10 to 15 minutes.</p>
<blockquote>
<p><strong>Implementation note:</strong>
the <code>nim-waku</code> client currently implements a keep-alive mechanism every <code>5 minutes</code>,
in response to a TCP connection timeout of <code>10 minutes</code>.</p>
</blockquote>
<h2 id="copyright-39"><a class="header" href="#copyright-39">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-31"><a class="header" href="#references-31">References</a></h2>
<ul>
<li><a href="https://docs.libp2p.io/concepts/peer-id/"><code>Peer ID</code></a></li>
<li><a href="https://docs.libp2p.io/concepts/addressing/"><code>multiaddrs</code></a></li>
<li><a href="https://docs.libp2p.io/concepts/protocols/#protocol-ids"><code>protocol IDs</code></a></li>
<li><a href="waku/informational/27//waku/standards/core/11/relay.html"><code>11/WAKU2-RELAY</code></a></li>
<li><a href="waku/informational/27//waku/standards/core/13/store.html"><code>13/WAKU2-STORE</code></a></li>
<li><a href="waku/informational/27//waku/deprecated/18/swap.html"><code>18/WAKU2-SWAP</code></a></li>
<li><a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md/#prune-backoff-and-peer-exchange">backing off period</a></li>
<li><a href="https://docs.libp2p.io/concepts/fundamentals/protocols/#ping">libp2p pings</a></li>
<li><a href="waku/informational/27//waku/standards/core/10/waku2.html#recommendations-for-clients"><code>10/WAKU2</code> client recommendations</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="29waku2-config"><a class="header" href="#29waku2-config">29/WAKU2-CONFIG</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v2 Client Parameter Configuration Recommendations</td></tr>
<tr><th>Slug</th><td>29</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Hanno Cornelius &lt;hanno@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-44"><a class="header" href="#timeline-44">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/informational/29/config.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/informational/29/config.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/740895661662ac5f73a8bce726333d93acf5fa23/waku/informational/29/config.md"><code>7408956</code></a> — update waku/informational/29/config.md (#146)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/informational/29/config.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/c506eac87d37bf264fa001e83b80477bd93ca727/waku/informational/29/config.md"><code>c506eac</code></a> — Update and rename CONFIG.md to config.md</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/930f84d4bfc5095db197d78dde2d4dcc36739794/waku/informational/29/CONFIG.md"><code>930f84d</code></a> — Update and rename README.md to CONFIG.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/informational/29/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/e6396b9b8a0807d134caf8905e903731160fdcf0/waku/rfcs/informational/29/README.md"><code>e6396b9</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<p><code>29/WAKU2-CONFIG</code> describes the RECOMMENDED values
to assign to configurable parameters for Waku v2 clients.
Since Waku v2 is built on <a href="https://github.com/libp2p/specs">libp2p</a>,
most of the parameters and reasonable defaults are derived from there.</p>
<p>Waku v2 relay messaging is specified in <a href="waku/informational/29//waku/standards/core/11/relay.html"><code>11/WAKU2-RELAY</code></a>,
a minor extension of the <a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/README.md">libp2p GossipSub protocol</a>.
GossipSub behaviour is controlled by a series of adjustable parameters.
Waku v2 clients SHOULD configure these parameters to the recommended values below.</p>
<h2 id="gossipsub-v10-parameters"><a class="header" href="#gossipsub-v10-parameters">GossipSub v1.0 parameters</a></h2>
<p>GossipSub v1.0 parameters are defined in the <a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.0.md#parameters">corresponding libp2p specification</a>.
We repeat them here with RECOMMMENDED values for <code>11/WAKU2-RELAY</code> implementations.</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th>Purpose</th><th>RECOMMENDED value</th></tr></thead><tbody>
<tr><td><code>D</code></td><td>The desired outbound degree of the network</td><td>6</td></tr>
<tr><td><code>D_low</code></td><td>Lower bound for outbound degree</td><td>4</td></tr>
<tr><td><code>D_high</code></td><td>Upper bound for outbound degree</td><td>8</td></tr>
<tr><td><code>D_lazy</code></td><td>(Optional) the outbound degree for gossip emission</td><td><code>D</code></td></tr>
<tr><td><code>heartbeat_interval</code></td><td>Time between heartbeats</td><td>1 second</td></tr>
<tr><td><code>fanout_ttl</code></td><td>Time-to-live for each topic's fanout state</td><td>60 seconds</td></tr>
<tr><td><code>mcache_len</code></td><td>Number of history windows in message cache</td><td>5</td></tr>
<tr><td><code>mcache_gossip</code></td><td>Number of history windows to use when emitting gossip</td><td>3</td></tr>
<tr><td><code>seen_ttl</code></td><td>Expiry time for cache of seen message ids</td><td>2 minutes</td></tr>
</tbody></table>
</div>
<h2 id="gossipsub-v11-parameters"><a class="header" href="#gossipsub-v11-parameters">GossipSub v1.1 parameters</a></h2>
<p>GossipSub v1.1 extended GossipSub v1.0 and
introduced <a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md#overview-of-new-parameters">several new parameters</a>.
We repeat the global parameters here
with RECOMMMENDED values for <code>11/WAKU2-RELAY</code> implementations.</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th>Description</th><th>RECOMMENDED value</th></tr></thead><tbody>
<tr><td><code>PruneBackoff</code></td><td>Time after pruning a mesh peer before we consider grafting them again.</td><td>1 minute</td></tr>
<tr><td><code>FloodPublish</code></td><td>Whether to enable flood publishing</td><td>true</td></tr>
<tr><td><code>GossipFactor</code></td><td>% of peers to send gossip to, if we have more than <code>D_lazy</code> available</td><td>0.25</td></tr>
<tr><td><code>D_score</code></td><td>Number of peers to retain by score when pruning from oversubscription</td><td><code>D_low</code></td></tr>
<tr><td><code>D_out</code></td><td>Number of outbound connections to keep in the mesh.</td><td><code>D_low</code> - 1</td></tr>
</tbody></table>
</div>
<p><code>11/WAKU2-RELAY</code> clients SHOULD implement a peer scoring mechanism
with the parameter constraints as
<a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md#overview-of-new-parameters">specified by libp2p</a>.</p>
<h2 id="other-configuration"><a class="header" href="#other-configuration">Other configuration</a></h2>
<p>The following behavioural parameters are not specified by <code>libp2p</code>,
but nevertheless describes constraints that <code>11/WAKU2-RELAY</code> clients
MAY choose to implement.</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th>Description</th><th>RECOMMENDED value</th></tr></thead><tbody>
<tr><td><code>BackoffSlackTime</code></td><td>Slack time to add to prune backoff before attempting to graft again</td><td>2 seconds</td></tr>
<tr><td><code>IWantPeerBudget</code></td><td>Maximum number of IWANT messages to accept from a peer within a heartbeat</td><td>25</td></tr>
<tr><td><code>IHavePeerBudget</code></td><td>Maximum number of IHAVE messages to accept from a peer within a heartbeat</td><td>10</td></tr>
<tr><td><code>IHaveMaxLength</code></td><td>Maximum number of messages to include in an IHAVE message</td><td>5000</td></tr>
</tbody></table>
</div>
<h2 id="copyright-40"><a class="header" href="#copyright-40">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-32"><a class="header" href="#references-32">References</a></h2>
<ul>
<li><a href="https://github.com/libp2p/specs">libp2p</a></li>
<li><a href="waku/informational/29//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a></li>
<li><a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/README.md">libp2p GossipSub protocol</a></li>
<li><a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.0.md#parameters">corresponding libp2p specification</a></li>
<li><a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md#overview-of-new-parameters">several new parameters</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="30adaptive-nodes"><a class="header" href="#30adaptive-nodes">30/ADAPTIVE-NODES</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Adaptive nodes</td></tr>
<tr><th>Slug</th><td>30</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Oskar Thorén &lt;oskarth@titanproxy.com&gt;</td></tr>
<tr><th>Contributors</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-45"><a class="header" href="#timeline-45">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/informational/30/adaptive-nodes.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/informational/30/adaptive-nodes.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/91c9679bc89f146e6f50a2bb3a26fe4d5daa1ade/waku/informational/30/adaptive-nodes.md"><code>91c9679</code></a> — update waku/informational/30/adaptive-nodes.md (#147)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/informational/30/adaptive-nodes.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b35846a546c1a6dc4bac3d5e5457f812f56c7707/waku/informational/30/adaptive-nodes.md"><code>b35846a</code></a> — Update and rename README.md to adaptive-nodes.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/informational/30/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/04036adcabf888f6ca764b50680694b07539e89d/waku/rfcs/informational/30/README.md"><code>04036ad</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<p>This is an informational spec that show cases the concept of adaptive nodes.</p>
<h2 id="node-types---a-continuum"><a class="header" href="#node-types---a-continuum">Node types - a continuum</a></h2>
<p>We can look at node types as a continuum,
from more restricted to less restricted,
fewer resources to more resources.</p>
<p><img src="waku/informational/30/./images/adaptive_node_continuum2.png" alt="Node types - a continuum" /></p>
<h3 id="possible-limitations"><a class="header" href="#possible-limitations">Possible limitations</a></h3>
<ul>
<li>Connectivity: Not publicly connectable vs static IP and DNS</li>
<li>Connectivity: Mostly offline to mostly online to always online</li>
<li>Resources: Storage, CPU, Memory, Bandwidth</li>
</ul>
<h3 id="accessibility-and-motivation"><a class="header" href="#accessibility-and-motivation">Accessibility and motivation</a></h3>
<p>Some examples:</p>
<ul>
<li>Opening browser window: costs nothing, but contribute nothing</li>
<li>Desktop: download, leave in background, contribute somewhat</li>
<li>Cluster: expensive, upkeep, but can contribute a lot</li>
</ul>
<p>These are also illustrative,
so a node in a browser in certain environment might contribute similarly to Desktop.</p>
<h3 id="adaptive-nodes"><a class="header" href="#adaptive-nodes">Adaptive nodes</a></h3>
<p>We call these nodes <em>adaptive nodes</em> to highlights different modes of contributing,
such as:</p>
<ul>
<li>Only leeching from the network</li>
<li>Relaying messages for one or more topics</li>
<li>Providing services for lighter nodes such as lightpush and filter</li>
<li>Storing historical messages to various degrees</li>
<li>Ensuring relay network can't be spammed with RLN</li>
</ul>
<h3 id="planned-incentives"><a class="header" href="#planned-incentives">Planned incentives</a></h3>
<p>Incentives to run a node is currently planned around:</p>
<ul>
<li>SWAP for accounting and settlement of services provided</li>
<li>RLN RELAY for spam protection</li>
<li>Other incentivization schemes are likely to follow and is an area of active research</li>
</ul>
<h2 id="node-protocol-selection"><a class="header" href="#node-protocol-selection">Node protocol selection</a></h2>
<p>Each node can choose which protocols to support, depending on its resources and goals.</p>
<p><img src="waku/informational/30/./images/adaptive_node_protocol_selection2.png" alt="Protocol selection" /></p>
<p>Protocols like <a href="waku/informational/30//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a>,
as well as [12], [13], [19], and [21], correspond to libp2p protocols.</p>
<p>However, other protocols like 16/WAKU2-RPC
(local HTTP JSON-RPC), 25/LIBP2P-DNS-DISCOVERY,
Discovery v5 (DevP2P) or interfacing with distributed storage,
are running on different network stacks.</p>
<p>This is in addition to protocols that specify payloads, such as 14/WAKU2-MESSAGE,
26/WAKU2-PAYLOAD, or application specific ones.
As well as specs that act more as recommendations,
such as 23/WAKU2-TOPICS or 27/WAKU2-PEERS.</p>
<h2 id="waku-network-visualization"><a class="header" href="#waku-network-visualization">Waku network visualization</a></h2>
<p>We can better visualize the network with some illustrative examples.</p>
<h3 id="topology-and-topics"><a class="header" href="#topology-and-topics">Topology and topics</a></h3>
<p>This illustration shows an example topology with different PubSub topics
for the relay protocol.</p>
<p><img src="waku/informational/30/./images/adaptive_node_network_topology_protocols2.png" alt="Waku Network visualization" /></p>
<h3 id="legend"><a class="header" href="#legend">Legend</a></h3>
<p>This illustration shows an example of content topics a node is interested in.</p>
<p><img src="waku/informational/30/./images/adaptive_node_network_topology_protocols_legend.png" alt="Waku Network visualization legend" /></p>
<p>The dotted box shows what content topics (application-specific)
a node is interested in.</p>
<p>A node that is purely providing a service to the network might not care.</p>
<p>In this example, we see support for toy chat,
a topic in Waku v1 (Status chat), WalletConnect, and SuperRare community.</p>
<h3 id="auxiliary-network"><a class="header" href="#auxiliary-network">Auxiliary network</a></h3>
<p>This is a separate component with its own topology.</p>
<p>Behavior and interaction with other protocols specified in Vac RFCs,
e.g. <a href="waku/informational/30//vac/25/libp2p-dns-discovery.html">25/LIBP2P-DNS-DISCOVERY</a>
and <a href="waku/informational/30//waku/standards/core/15/bridge.html">15/WAKU-BRIDGE</a>.</p>
<h3 id="node-cross-section"><a class="header" href="#node-cross-section">Node Cross Section</a></h3>
<p>This one shows a cross-section of nodes in different dimensions and
shows how the connections look different for different protocols.</p>
<p><img src="waku/informational/30/./images/adaptive_node_cross_section2.png" alt="Node Cross Section" /></p>
<h2 id="copyright-41"><a class="header" href="#copyright-41">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-33"><a class="header" href="#references-33">References</a></h2>
<ul>
<li><a href="waku/informational/30//waku/standards/core/11/relay.html">11/WAKU2-RELAY</a></li>
<li><a href="waku/informational/30//vac/25/libp2p-dns-discovery.html">25/LIBP2P-DNS-DISCOVERY</a></li>
<li><a href="waku/informational/30//waku/standards/core/15/bridge.html">15/WAKU-BRIDGE</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deprecated-rfcs"><a class="header" href="#deprecated-rfcs">Deprecated RFCs</a></h1>
<p>Deprecated specifications are no longer used in Waku products.
This subdirectory is for achrive purpose and
should not be used in production ready implementations.
Visit <a href="https://github.com/waku-org/specs">Waku RFCs</a>
for new Waku specifications under discussion.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="5waku0"><a class="header" href="#5waku0">5/WAKU0</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v0</td></tr>
<tr><th>Slug</th><td>5</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Oskar Thorén &lt;oskarth@titanproxy.com&gt;</td></tr>
<tr><th>Contributors</th><td>Adam Babik &lt;adam@status.im&gt;<br>Andrea Maria Piana &lt;andreap@status.im&gt;<br>Dean Eigenmann &lt;dean@status.im&gt;<br>Kim De Mey &lt;kimdemey@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-46"><a class="header" href="#timeline-46">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/deprecated/5/waku0.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/deprecated/5/waku0.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/deprecated/5/waku0.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/97709637ad5a6ba7364191b4a4a3d1397ff41912/waku/deprecated/5/waku0.md"><code>9770963</code></a> — Rename WAKU0.md to waku0.md</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/ac8fe6dbedc162e54c2faaa997b63a58ce364e7f/waku/deprecated/5/WAKU0.md"><code>ac8fe6d</code></a> — Rename waku/rfc/deprecated/5/WAKU0.md to waku/deprecated/5/WAKU0.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/61f7641fdd055e71646ccabdc9c873899417323d/waku/rfc/deprecated/5/WAKU0.md"><code>61f7641</code></a> — Create WAKU0.md</li>
</ul>
<!-- timeline:end -->
<p>This specification describes the format of Waku messages within the ÐΞVp2p Wire Protocol.
This spec substitutes <a href="https://eips.ethereum.org/EIPS/eip-627">EIP-627</a>.
Waku is a fork of the original Whisper protocol that enables better usability
for resource restricted devices,
such as mostly-offline bandwidth-constrained smartphones.
It does this through (a) light node support,
(b) historic messages (with a mailserver)
(c) expressing topic interest for better bandwidth usage and
(d) basic rate limiting.</p>
<h2 id="motivation-19"><a class="header" href="#motivation-19">Motivation</a></h2>
<p>Waku was created to incrementally improve in areas that Whisper is lacking in,
with special attention to resource restricted devices.
We specify the standard for Waku messages
in order to ensure forward compatibility of different Waku clients,
backwards compatibility with Whisper clients,
as well as to allow multiple implementations of Waku and its capabilities.
We also modify the language to be more unambiguous, concise and consistent.</p>
<h2 id="definitions-5"><a class="header" href="#definitions-5">Definitions</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Term</th><th>Definition</th></tr></thead><tbody>
<tr><td><strong>Light node</strong></td><td>A Waku node that does not forward any messages.</td></tr>
<tr><td><strong>Envelope</strong></td><td>Messages sent and received by Waku nodes.</td></tr>
<tr><td><strong>Node</strong></td><td>Some process that is able to communicate for Waku.</td></tr>
</tbody></table>
</div>
<h2 id="underlying-transports-and-prerequisites-1"><a class="header" href="#underlying-transports-and-prerequisites-1">Underlying Transports and Prerequisites</a></h2>
<h3 id="use-of-devp2p-1"><a class="header" href="#use-of-devp2p-1">Use of DevP2P</a></h3>
<p>For nodes to communicate, they MUST implement devp2p and run RLPx.
They MUST have some way of connecting to other nodes.
Node discovery is largely out of scope for this spec,
but see the appendix for some suggestions on how to do this.</p>
<h3 id="gossip-based-routing-2"><a class="header" href="#gossip-based-routing-2">Gossip based routing</a></h3>
<p>In Whisper, messages are gossiped between peers.
Whisper is a form of rumor-mongering protocol
that works by flooding to its connected peers based on some factors.
Messages are eligible for retransmission until their TTL expires.
A node SHOULD relay messages to all connected nodes
if an envelope matches their PoW and bloom filter settings.
If a node works in light mode, it MAY choose not to forward envelopes.
A node MUST NOT send expired envelopes,
unless the envelopes are sent as a <a href="waku/deprecated/5/./mailserver.html">mailserver</a> response.
A node SHOULD NOT send a message to a peer that it has already sent before.</p>
<h2 id="wire-specification-3"><a class="header" href="#wire-specification-3">Wire Specification</a></h2>
<h3 id="use-of-rlpx-transport-protocol-1"><a class="header" href="#use-of-rlpx-transport-protocol-1">Use of RLPx transport protocol</a></h3>
<p>All Waku messages are sent as devp2p RLPx transport protocol,
version 5<sup class="footnote-reference"><a href="#1">1</a></sup> packets.
These packets MUST be RLP-encoded arrays of data containing two objects:
packet code followed by another object (whose type depends on the packet code).
See <a href="https://github.com/ethereum/wiki/wiki/RLP">informal RLP spec</a> and
the <a href="https://ethereum.github.io/yellowpaper/paper.pdf">Ethereum Yellow Paper, appendix B</a>
for more details on RLP.</p>
<p>Waku is a RLPx subprotocol called <code>waku</code> with version <code>0</code>.
The version number corresponds to the major version in the header spec.
Minor versions should not break compatibility of <code>waku</code>,
this would result in a new major.
(Some exceptions to this apply in the Draft stage
of where client implementation is rapidly change).</p>
<h3 id="abnf-specification-1"><a class="header" href="#abnf-specification-1">ABNF specification</a></h3>
<p>Using <a href="https://tools.ietf.org/html/rfc5234">Augmented Backus-Naur form (ABNF)</a>
we have the following format:</p>
<pre><code class="language-abnf">; Packet codes 0 - 127 are reserved for Waku protocol
packet-code = 1*3DIGIT

; rate limits
limit-ip     = 1*DIGIT
limit-peerid = 1*DIGIT
limit-topic  = 1*DIGIT

rate-limits = "[" limit-ip limit-peerid limit-topic "]"

pow-requirement-key = 48
bloom-filter-key = 49
light-node-key = 50
confirmations-enabled-key = 51
rate-limits-key = 52
topic-interest-key = 53

status-options = "["
  [ pow-requirement-key pow-requirement ]
  [ bloom-filter-key bloom-filter ]
  [ light-node-key light-node ]
  [ confirmations-enabled-key confirmations-enabled ]
  [ rate-limits-key rate-limits ]
  [ topic-interest-key topic-interest ]
"]"

status = "[" version status-options "]"

status-update = status-options

; version is "an integer (as specified in RLP)"
version = DIGIT

confirmations-enabled = BIT

light-node = BIT

; pow is "a single floating point value of PoW.
; This value is the IEEE 754 binary representation
; of a 64-bit floating point number.
; Values of qNAN, sNAN, INF and -INF are not allowed.
; Negative values are also not allowed."
pow             = 1*DIGIT "." 1*DIGIT
pow-requirement = pow

; bloom filter is "a byte array"
bloom-filter = *OCTET

waku-envelope = "[" expiry ttl topic data nonce "]"

; List of topics interested in
topic-interest = "[" *10000topic "]"

; 4 bytes (UNIX time in seconds)
expiry = 4OCTET

; 4 bytes (time-to-live in seconds)
ttl = 4OCTET

; 4 bytes of arbitrary data
topic = 4OCTET

; byte array of arbitrary size
; (contains encrypted message)
data = OCTET

; 8 bytes of arbitrary data
; (used for PoW calculation)
nonce = 8OCTET

messages = 1*waku-envelope

; mail server / client specific
p2p-request = waku-envelope
p2p-message = 1*waku-envelope

; packet-format needs to be paired with its
; corresponding packet-format
packet-format = "[" packet-code packet-format "]"

required-packet = 0 status /
1 messages /
22 status-update /

optional-packet = 126 p2p-request / 127 p2p-message

packet = "[" required-packet [ optional-packet ] "]"
</code></pre>
<p>All primitive types are RLP encoded. Note that, per RLP specification,
integers are encoded starting from <code>0x00</code>.</p>
<h3 id="packet-codes-1"><a class="header" href="#packet-codes-1">Packet Codes</a></h3>
<p>The message codes reserved for Waku protocol: 0 - 127.</p>
<p>Messages with unknown codes MUST be ignored without generating any error,
for forward compatibility of future versions.</p>
<p>The Waku sub-protocol MUST support the following packet codes:</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Int Value</th></tr></thead><tbody>
<tr><td>Status</td><td>0</td></tr>
<tr><td>Messages</td><td>1</td></tr>
<tr><td>Status Update</td><td>22</td></tr>
</tbody></table>
</div>
<p>The following message codes are optional, but they are reserved for specific purpose.</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Int Value</th><th>Comment</th></tr></thead><tbody>
<tr><td>Batch Ack</td><td>11</td><td></td></tr>
<tr><td>Message Response</td><td>12</td><td></td></tr>
<tr><td>P2P Request</td><td>126</td><td></td></tr>
<tr><td>P2P Message</td><td>127</td><td></td></tr>
</tbody></table>
</div>
<h3 id="packet-usage-1"><a class="header" href="#packet-usage-1">Packet usage</a></h3>
<h4 id="status-1"><a class="header" href="#status-1">Status</a></h4>
<p>The Status message serves as a Waku handshake and peers MUST exchange this
message upon connection. It MUST be sent after the RLPx handshake and prior to
any other Waku messages.</p>
<p>A Waku node MUST await the Status message from a peer
before engaging in other Waku protocol activity with that peer.
When a node does not receive the Status message from a peer,
before a configurable timeout, it SHOULD disconnect from that peer.</p>
<p>Upon retrieval of the Status message, the node SHOULD validate the message
received and validated the Status message. Note that its peer might not be in
the same state.</p>
<p>When a node is receiving other Waku messages from a peer before a Status
message is received,
the node MUST ignore these messages and SHOULD disconnect from that peer.
Status messages received after the handshake is completed MUST also be ignored.</p>
<p>The status message MUST contain an association list containing various options.
All options within this association list are OPTIONAL,
ordering of the key-value pairs is not guaranteed and
therefore MUST NOT be relied on.
Unknown keys in the association list SHOULD be ignored.</p>
<h4 id="messages-1"><a class="header" href="#messages-1">Messages</a></h4>
<p>This packet is used for sending the standard Waku envelopes.</p>
<h4 id="status-update-1"><a class="header" href="#status-update-1">Status Update</a></h4>
<p>The Status Update message is used to communicate an update
of the settings of the node.
The format is the same as the Status message, all fields are optional.
If none of the options are specified the message MUST be ignored and
considered a noop.
Fields that are omitted are considered unchanged,
fields that haven't changed SHOULD not be transmitted.</p>
<h5 id="pow-requirement-update"><a class="header" href="#pow-requirement-update">PoW Requirement update</a></h5>
<p>When PoW is updated, peers MUST NOT deliver the sender envelopes
with PoW lower than specified in this message.</p>
<p>PoW is defined as average number of iterations,
required to find the current BestBit
(the number of leading zero bits in the hash), divided by message size and TTL:</p>
<blockquote>
<p>PoW = (2**BestBit) / (size * TTL)</p>
</blockquote>
<p>PoW calculation:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span> fn short_rlp(envelope) = rlp of envelope, excluding env_nonce field.
 fn pow_hash(envelope, env_nonce) = sha3(short_rlp(envelope) ++ env_nonce)
 fn pow(pow_hash, size, ttl) = 2**leading_zeros(pow_hash) / (size * ttl)
<span class="boring">}</span></code></pre></pre>
<p>where size is the size of the RLP-encoded envelope,
excluding <code>env_nonce</code> field (size of <code>short_rlp(envelope)</code>).</p>
<h5 id="bloom-filter-update"><a class="header" href="#bloom-filter-update">Bloom filter update</a></h5>
<p>The bloom filter is used to identify a number of topics
to a peer without compromising (too much)
privacy over precisely what topics are of interest.
Precise control over the information content (and thus efficiency of the filter)
may be maintained through the addition of bits.</p>
<p>Blooms are formed by the bitwise OR operation on a number of bloomed topics.
The bloom function takes the topic and projects them onto a 512-bit slice.
At most, three bits are marked for each bloomed topic.</p>
<p>The projection function is defined as a mapping from a 4-byte slice S
to a 512-bit slice D; for ease of explanation, S will dereference to bytes,
whereas D will dereference to bits.</p>
<pre><code class="language-python"> LET D[*] = 0
 FOREACH i IN { 0, 1, 2 } DO
 LET n = S[i]
 IF S[3] &amp; (2 ** i) THEN n += 256
 D[n] = 1
 END FOR
</code></pre>
<p>A full bloom filter (all the bits set to 1)
means that the node is to be considered a <code>Full Node</code> and it will accept any topic.</p>
<p>If both Topic Interest and bloom filter are specified,
Topic Interest always takes precedence and bloom filter MUST be ignored.</p>
<p>If only bloom filter is specified, the current Topic Interest MUST be discarded and
only the updated bloom filter MUST be used when forwarding or posting envelopes.</p>
<p>A bloom filter with all bits set to 0 signals
that the node is not currently interested in receiving any envelope.</p>
<h5 id="topic-interest-update"><a class="header" href="#topic-interest-update">Topic Interest update</a></h5>
<p>This packet is used by Waku nodes for sharing their interest
in messages with specific topics.
It does this in a more bandwidth considerate way,
at the expense of some metadata protection.
Peers MUST only send envelopes with specified topics.</p>
<p>It is currently bounded to a maximum of 10000 topics.
If you are interested in more topics than that,
this is currently underspecified and likely requires updating it.
The constant is subject to change.</p>
<p>If only Topic Interest is specified,
the current bloom filter MUST be discarded and
only the updated Topic Interest MUST be used when forwarding or posting envelopes.</p>
<p>An empty array signals that the node
is not currently interested in receiving any envelope.</p>
<h5 id="rate-limits-update"><a class="header" href="#rate-limits-update">Rate Limits update</a></h5>
<p>This packet is used for informing other nodes of their self defined rate limits.</p>
<p>In order to provide basic Denial-of-Service attack protection,
each node SHOULD define its own rate limits.
The rate limits SHOULD be applied on IPs, peer IDs, and envelope topics.</p>
<p>Each node MAY decide to whitelist, i.e. do not rate limit, selected IPs or peer IDs.</p>
<p>If a peer exceeds node's rate limits, the connection between them MAY be dropped.</p>
<p>Each node SHOULD broadcast its rate limits to its peers using the rate limits packet.
The rate limits MAY also be sent as an optional parameter in the handshake.</p>
<p>Each node SHOULD respect rate limits advertised by its peers.
The number of packets SHOULD be throttled in order not to exceed peer's rate limits.
If the limit gets exceeded, the connection MAY be dropped by the peer.</p>
<h5 id="message-confirmations-update"><a class="header" href="#message-confirmations-update">Message Confirmations update</a></h5>
<p>Message confirmations tell a node that a message originating
from it has been received by its peers,
allowing a node to know whether a message has or has not been received.</p>
<p>A node MAY send a message confirmation for any batch of messages
received with a packet Messages Code.</p>
<p>A message confirmation is sent using Batch Acknowledge packet or
Message Response packet.
The Batch Acknowledge packet is followed by a keccak256 hash
of the envelopes batch data.</p>
<p>The current <code>version</code> of the message response is <code>1</code>.</p>
<p>Using <a href="https://tools.ietf.org/html/rfc5234">Augmented Backus-Naur form (ABNF)</a>
we have the following format:</p>
<pre><code class="language-abnf">; a version of the Message Response
version = 1*DIGIT

; keccak256 hash of the envelopes batch data (raw bytes) for which the confirmation is sent
hash = *OCTET

hasherror = *OCTET

; error code
code = 1*DIGIT

; a descriptive error message
description = *ALPHA

error  = "[" hasherror code description "]"
errors = *error

response = "[" hash errors "]"

confirmation = "[" version response "]"
</code></pre>
<p>The supported codes:
<code>1</code>: means time sync error which happens when an envelope is too old or
created in the future (the root cause is no time sync between nodes).</p>
<p>The drawback of sending message confirmations
is that it increases the noise in the network because for each sent message,
a corresponding confirmation is broadcast by one or more peers.</p>
<h4 id="p2p-request-1"><a class="header" href="#p2p-request-1">P2P Request</a></h4>
<p>This packet is used for sending Dapp-level peer-to-peer requests,
e.g. Waku Mail Client requesting old messages from the <a href="waku/deprecated/5/./mailserver.html">Waku Mail Server</a>.</p>
<h4 id="p2p-message-1"><a class="header" href="#p2p-message-1">P2P Message</a></h4>
<p>This packet is used for sending the peer-to-peer messages,
which are not supposed to be forwarded any further.
E.g. it might be used by the Waku Mail Server for delivery of old
(expired) messages, which is otherwise not allowed.</p>
<h3 id="payload-encryption-2"><a class="header" href="#payload-encryption-2">Payload Encryption</a></h3>
<p>Asymmetric encryption uses the standard Elliptic Curve Integrated Encryption Scheme
with SECP-256k1 public key.</p>
<p>Symmetric encryption uses AES GCM algorithm with random 96-bit nonce.</p>
<h3 id="packet-code-rationale-1"><a class="header" href="#packet-code-rationale-1">Packet code Rationale</a></h3>
<p>Packet codes <code>0x00</code> and <code>0x01</code> are already used in all Waku / Whisper versions.
Packet code <code>0x02</code> and <code>0x03</code> were previously used in Whisper but
are deprecated as of Waku v0.4</p>
<p>Packet code <code>0x22</code> is used to dynamically change the settings of a node.</p>
<p>Packet codes <code>0x7E</code> and <code>0x7F</code> may be used to implement Waku Mail Server and Client.
Without P2P messages it would be impossible to deliver the old messages,
since they will be recognized as expired,
and the peer will be disconnected for violating the Whisper protocol.
They might be useful for other purposes
when it is not possible to spend time on PoW,
e.g. if a stock exchange will want to provide live feed about the latest trades.</p>
<h2 id="additional-capabilities-1"><a class="header" href="#additional-capabilities-1">Additional capabilities</a></h2>
<p>Waku supports multiple capabilities.
These include light node, rate limiting and bridging of traffic.
Here we list these capabilities, how they are identified,
what properties they have and what invariants they must maintain.</p>
<p>Additionally there is the capability of a mailserver
which is documented in its on <a href="waku/deprecated/5/mailserver.html">specification</a>.</p>
<h3 id="light-node-1"><a class="header" href="#light-node-1">Light node</a></h3>
<p>The rationale for light nodes is to allow for interaction with waku
on resource restricted devices as bandwidth can often be an issue.</p>
<p>Light nodes MUST NOT forward any incoming messages,
they MUST only send their own messages.
When light nodes happen to connect to each other,
they SHOULD disconnect.
As this would result in messages being dropped between the two.</p>
<p>Light nodes are identified by the <code>light_node</code> value in the status message.</p>
<h3 id="accounting-for-resources-experimental-1"><a class="header" href="#accounting-for-resources-experimental-1">Accounting for resources (experimental)</a></h3>
<p>Nodes MAY implement accounting, keeping track of resource usage.
It is heavily inspired by
Swarm's <a href="https://www.bokconsulting.com.au/wp-content/uploads/2016/09/tron-fischer-sw3.pdf">SWAP protocol</a>,
and works by doing pairwise accounting for resources.</p>
<p>Each node keeps track of resource usage with all other nodes.
Whenever an envelope is received from a node that is expected
(fits bloom filter or topic interest, is legal, etc) this is tracked.</p>
<p>Every epoch (say, every minute or every time an event happens)
statistics SHOULD be aggregated and saved by the client:</p>
<div class="table-wrapper"><table><thead><tr><th>peer</th><th>sent</th><th>received</th></tr></thead><tbody>
<tr><td>peer1</td><td>0</td><td>123</td></tr>
<tr><td>peer2</td><td>10</td><td>40</td></tr>
</tbody></table>
</div>
<p>In later versions this will be amended by nodes communication thresholds,
settlements and disconnect logic.</p>
<h2 id="upgradability-and-compatibility-1"><a class="header" href="#upgradability-and-compatibility-1">Upgradability and Compatibility</a></h2>
<h3 id="general-principles-and-policy-1"><a class="header" href="#general-principles-and-policy-1">General principles and policy</a></h3>
<p>These are policies that guide how we make decisions when it comes to upgradability,
compatibility, and extensibility:</p>
<ol>
<li>
<p>Waku aims to be compatible with previous and future versions.</p>
</li>
<li>
<p>In cases where we want to break this compatibility, we do so gracefully and
as a single decision point.</p>
</li>
<li>
<p>To achieve this,
we employ the following two general strategies:</p>
</li>
</ol>
<ul>
<li>a) Accretion (including protocol negotiation) over changing data</li>
<li>b) When we want to change things, we give it a new name
(for example, a version number).</li>
</ul>
<p>Examples:</p>
<ul>
<li>We enable bridging between <code>shh/6</code> and
<code>waku/0</code> until such a time as when we are ready to gracefully drop support
for <code>shh/6</code> (1, 2, 3).</li>
<li>When we add parameter fields, we (currently) do so by accreting them in a list,
so old clients can ignore new fields (dynamic list)
and new clients can use new capabilities (1, 3).</li>
<li>To better support (2) and (3) in the future,
we will likely release a new version that gives better support for open,
growable maps (association lists or native map type) (3)</li>
<li>When we we want to provide a new set of messages that have different requirements,
we do so under a new protocol version and employ protocol versioning.
This is a form of accretion at a level above -
it ensures a client can support both protocols at once and
drop support for legacy versions gracefully. (1,2,3)</li>
</ul>
<h3 id="backwards-compatibility-1"><a class="header" href="#backwards-compatibility-1">Backwards Compatibility</a></h3>
<p>Waku is a different subprotocol from Whisper so it isn't directly compatible.
However, the data format is the same,
so compatibility can be achieved by the use of a bridging mode as described below.
Any client which does not implement certain packet codes
should gracefully ignore the packets with those codes.
This will ensure the forward compatibility.</p>
<h3 id="waku-whisper-bridging-1"><a class="header" href="#waku-whisper-bridging-1">Waku-Whisper bridging</a></h3>
<p><code>waku/0</code> and <code>shh/6</code> are different DevP2P subprotocols,
however they share the same data format making their envelopes compatible.
This means we can bridge the protocols naively, this works as follows.</p>
<p><strong>Roles:</strong></p>
<ul>
<li>Waku client A, only Waku capability</li>
<li>Whisper client B, only Whisper capability</li>
<li>WakuWhisper bridge C, both Waku and Whisper capability</li>
</ul>
<p><strong>Flow:</strong></p>
<ol>
<li>A posts message; B posts message.</li>
<li>C picks up message from A and B and relays them both to Waku and Whisper.</li>
<li>A receives message on Waku; B on Whisper.</li>
</ol>
<p><strong>Note</strong>: This flow means if another bridge C1 is active,
we might get duplicate relaying for a message between C1 and C2.
I.e. Whisper(&lt;&gt;Waku&lt;&gt;Whisper)&lt;&gt;Waku, A-C1-C2-B.
Theoretically this bridging chain can get as long as TTL permits.</p>
<h3 id="forward-compatibility-1"><a class="header" href="#forward-compatibility-1">Forward Compatibility</a></h3>
<p>It is desirable to have a strategy for maintaining forward compatibility
between <code>waku/0</code> and future version of waku.
Here we outline some concerns and strategy for this.</p>
<ul>
<li>
<p><strong>Connecting to nodes with multiple versions:</strong>
The way this SHOULD be accomplished in the future
is by negotiating the versions of subprotocols,
within the <code>hello</code> message nodes transmit their capabilities along with a version.
As suggested in <a href="https://eips.ethereum.org/EIPS/eip-8">EIP-8</a>,
if a node connects that has a higher version number for a specific capability,
the node with a lower number SHOULD assume backwards compatibility.
The node with the higher version
will decide if compatibility can be assured between versions,
if this is not the case it MUST disconnect.</p>
</li>
<li>
<p><strong>Adding new packet codes:</strong>
New packet codes can be added easily due to the available packet codes.
Unknown packet codes SHOULD be ignored.
Upgrades that add new packet codes SHOULD implement some fallback mechanism
if no response was received for nodes that do not yet understand this packet.</p>
</li>
<li>
<p><strong>Adding new options in <code>status-options</code>:</strong>
New options can be added to the <code>status-options</code> association list
in the <code>status</code> and <code>status-update</code> packet as options are OPTIONAL and
unknown option keys SHOULD be ignored.
A node SHOULD NOT disconnect from a peer
when receiving <code>status-options</code> with unknown option keys.</p>
</li>
</ul>
<h2 id="appendix-a-security-considerations-3"><a class="header" href="#appendix-a-security-considerations-3">Appendix A: Security considerations</a></h2>
<p>There are several security considerations to take into account when running Waku.
Chief among them are: scalability, DDoS-resistance and privacy.
These also vary depending on what capabilities are used.
The security considerations for extra capabilities such as <a href="waku/deprecated/5/./mailserver.html#security-considerations">mailservers</a>
can be found in their respective specifications.</p>
<h3 id="scalability-and-ux-1"><a class="header" href="#scalability-and-ux-1">Scalability and UX</a></h3>
<p><strong>Bandwidth usage:</strong></p>
<p>In version 0 of Waku, bandwidth usage is likely to be an issue.
For more investigation into this,
see the theoretical scaling model described <a href="https://github.com/vacp2p/research/tree/dcc71f4779be832d3b5ece9c4e11f1f7ec24aac2/whisper_scalability">here</a>.</p>
<p><strong>Gossip-based routing:</strong></p>
<p>Use of gossip-based routing doesn't necessarily scale.
It means each node can see a message multiple times,
and having too many light nodes can cause propagation probability that is too low.
See <a href="https://our.status.im/whisper-pss-comparison/">Whisper vs PSS</a>
for more and a possible Kademlia based alternative.</p>
<p><strong>Lack of incentives:</strong></p>
<p>Waku currently lacks incentives to run nodes,
which means node operators are more likely to create centralized choke points.</p>
<h3 id="privacy-1"><a class="header" href="#privacy-1">Privacy</a></h3>
<p><strong>Light node privacy:</strong></p>
<p>The main privacy concern with light nodes
is that directly connected peers will know that a message originates from them
(as it are the only ones it sends).
This means nodes can make assumptions about what messages (topics)
their peers are interested in.</p>
<p><strong>Bloom filter privacy:</strong></p>
<p>By having a bloom filter where only the topics you are interested in are set,
you reveal which messages you are interested in.
This is a fundamental tradeoff between bandwidth usage and privacy,
though the tradeoff space is likely suboptimal in terms of the
<a href="https://eprint.iacr.org/2017/954.pdf">Anonymity</a> <a href="https://petsymposium.org/2019/files/hotpets/slides/coordination-helps-anonymity-slides.pdf">trilemma</a>.</p>
<p><strong>Privacy guarantees not rigorous:</strong></p>
<p>Privacy for Whisper / Waku haven't been studied rigorously for various threat models
like global passive adversary, local active attacker, etc.
This is unlike e.g. Tor and mixnets.</p>
<p><strong>Topic hygiene:</strong></p>
<p>Similar to bloom filter privacy,
if you use a very specific topic you reveal more information.
See scalability model linked above.</p>
<h3 id="spam-resistance-1"><a class="header" href="#spam-resistance-1">Spam resistance</a></h3>
<p><strong>PoW bad for heterogeneous devices:</strong></p>
<p>Proof of work is a poor spam prevention mechanism.
A mobile device can only have a very low PoW
in order not to use too much CPU / burn up its phone battery.
This means someone can spin up a powerful node and overwhelm the network.</p>
<h3 id="censorship-resistance-1"><a class="header" href="#censorship-resistance-1">Censorship resistance</a></h3>
<p><strong>Devp2p TCP port blockable:</strong></p>
<p>By default Devp2p runs on port <code>30303</code>,
which is not commonly used for any other service.
This means it is easy to censor, e.g. airport WiFi.
This can be mitigated somewhat by running on e.g. port <code>80</code> or <code>443</code>,
but there are still outstanding issues.
See libp2p and Tor's Pluggable Transport for how this can be improved.</p>
<h2 id="appendix-b-implementation-notes-1"><a class="header" href="#appendix-b-implementation-notes-1">Appendix B: Implementation Notes</a></h2>
<h3 id="implementation-matrix-2"><a class="header" href="#implementation-matrix-2">Implementation Matrix</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Client</th><th>Spec supported</th><th>Details</th></tr></thead><tbody>
<tr><td><strong>Status-go</strong></td><td>0.5</td><td><a href="https://github.com/status-im/status-go/blob/develop/WAKU.md">details</a></td></tr>
<tr><td><strong>Nimbus</strong></td><td>0.4</td><td><a href="https://github.com/status-im/nimbus/tree/8747fe1ecd36fe778bb92b97634db84d364fede8/waku">details</a></td></tr>
</tbody></table>
</div>
<h3 id="recommendations-for-clients-2"><a class="header" href="#recommendations-for-clients-2">Recommendations for clients</a></h3>
<p>Notes useful for implementing Waku mode.</p>
<ul>
<li>Avoid duplicate envelopes:</li>
</ul>
<p>To avoid duplicate envelopes, only connect to one Waku node.
Benign duplicate envelopes is an intrinsic property of Whisper
which often leads to a N factor increase in traffic,
where N is the number of peers you are connected to.</p>
<ul>
<li>Topic specific recommendations -</li>
</ul>
<p>Consider partition topics based on some usage,
to avoid too much traffic on a single topic.</p>
<h3 id="node-discovery-1"><a class="header" href="#node-discovery-1">Node discovery</a></h3>
<p>Resource restricted devices SHOULD use
<a href="https://eips.ethereum.org/EIPS/eip-1459">EIP-1459</a> to discover nodes.</p>
<p>Known static nodes MAY also be used.</p>
<h2 id="changelog-3"><a class="header" href="#changelog-3">Changelog</a></h2>
<h3 id="version-06-1"><a class="header" href="#version-06-1">Version 0.6</a></h3>
<p>Released <a href="https://github.com/vacp2p/specs/commit/9e650995f24179844857520c68fa3e8f6018b125">April 21,2020</a></p>
<ul>
<li>Mark spec as Deprecated mode in terms of its lifecycle.</li>
</ul>
<h3 id="version-05-1"><a class="header" href="#version-05-1">Version 0.5</a></h3>
<p>Released <a href="https://github.com/vacp2p/specs/commit/7b9dc562bc50c6bb844ac575cb221ec9cda2530a">March 17,2020</a></p>
<ul>
<li>Clarify the preferred way of handling unknown keys
in the <code>status-options</code> association list.</li>
<li>Correct spec/implementation mismatch:
Change RLP keys to be the their int values in order to reflect production behavior</li>
</ul>
<h3 id="version-04-1"><a class="header" href="#version-04-1">Version 0.4</a></h3>
<p>Released <a href="https://github.com/vacp2p/specs/commit/17bd066e317bbe33af07146b721d73f24de47e88">February 21, 2020</a>.</p>
<ul>
<li>Simplify implementation matrix with latest state</li>
<li>Introduces a new required packet code Status Code (<code>0x22</code>)
for communicating option changes</li>
<li>Deprecates the following packet codes:
PoW Requirement (<code>0x02</code>), Bloom Filter (<code>0x03</code>), Rate limits (<code>0x20</code>),
Topic interest (<code>0x21</code>) - all superseded by the new Status Code (<code>0x22</code>)</li>
<li>Increased <code>topic-interest</code> capacity from 1000 to 10000</li>
</ul>
<h3 id="version-03-1"><a class="header" href="#version-03-1">Version 0.3</a></h3>
<p>Released <a href="https://github.com/vacp2p/specs/commit/73138d6ba954ab4c315e1b8d210ac7631b6d1428">February 13, 2020</a>.</p>
<ul>
<li>Recommend DNS based node discovery over other Discovery methods.</li>
<li>Mark spec as Draft mode in terms of its lifecycle.</li>
<li>Simplify Changelog and misc formatting.</li>
<li>Handshake/Status message not compatible with shh/6 nodes;
specifying options as association list.</li>
<li>Include topic-interest in Status handshake.</li>
<li>Upgradability policy.</li>
<li><code>topic-interest</code> packet code.</li>
</ul>
<h3 id="version-02-1"><a class="header" href="#version-02-1">Version 0.2</a></h3>
<p>Released <a href="https://github.com/vacp2p/specs/blob/waku-0.2.0/waku.md">December 10, 2019</a>.</p>
<ul>
<li>General style improvements.</li>
<li>Fix ABNF grammar.</li>
<li>Mailserver requesting/receiving.</li>
<li>New packet codes: topic-interest (experimental), rate limits (experimental).</li>
<li>More details on handshake modifications.</li>
<li>Accounting for resources mode (experimental)</li>
<li>Appendix with security considerations: scalability and UX, privacy, and spam resistance.</li>
<li>Appendix with implementation notes and
implementation matrix across various clients with breakdown per capability.</li>
<li>More details on handshake and parameters.</li>
<li>Describe rate limits in more detail.</li>
<li>More details on mailserver and mail client API.</li>
<li>Accounting for resources mode (very experimental).</li>
<li>Clarify differences with Whisper.</li>
</ul>
<h3 id="version-01-1"><a class="header" href="#version-01-1">Version 0.1</a></h3>
<p>Initial version. Released <a href="https://github.com/vacp2p/specs/blob/b59b9247f2ac1bf45c75bd3227a2e5dd87b6d7b0/waku.md">November 21, 2019</a>.</p>
<h3 id="differences-between-shh6-and-waku0"><a class="header" href="#differences-between-shh6-and-waku0">Differences between shh/6 and waku/0</a></h3>
<p>Summary of main differences between this spec and Whisper v6, as described in <a href="https://eips.ethereum.org/EIPS/eip-627">EIP-627</a>:</p>
<ul>
<li>RLPx subprotocol is changed from <code>shh/6</code> to <code>waku/0</code>.</li>
<li>Light node capability is added.</li>
<li>Optional rate limiting is added.</li>
<li>Status packet has following additional parameters: light-node,
confirmations-enabled and rate-limits</li>
<li>Mail Server and Mail Client functionality is now part of the specification.</li>
<li>P2P Message packet contains a list of envelopes instead of a single envelope.</li>
</ul>
<h2 id="copyright-42"><a class="header" href="#copyright-42">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="footnotes-4"><a class="header" href="#footnotes-4">Footnotes</a></h2>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>Felix Lange et al. <a href="https://github.com/ethereum/devp2p/blob/master/rlpx.md">The RLPx Transport Protocol</a>. Ethereum.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="16waku2-rpc"><a class="header" href="#16waku2-rpc">16/WAKU2-RPC</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v2 RPC API</td></tr>
<tr><th>Slug</th><td>16</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Hanno Cornelius &lt;hanno@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-47"><a class="header" href="#timeline-47">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/deprecated/16/rpc.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/deprecated/16/rpc.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/deprecated/16/rpc.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-04-16</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/8b552ba2e0b55fdcb0026162d14a5a64e8d18239/waku/deprecated/16/rpc.md"><code>8b552ba</code></a> — chore: mark 16/WAKU2-RPC as deprecated (#30)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/core/16/rpc.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/87b56de18e017198e9a79065b6b8e9cbc521c8c0/waku/standards/core/16/rpc.md"><code>87b56de</code></a> — Update and rename RPC.md to rpc.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/9042acf3fc1723ffe16a4ee2b5ac6cc832e05f21/waku/standards/core/16/RPC.md"><code>9042acf</code></a> — Rename README.md to RPC.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eef961bfe3b1cf6aab66df5450555afd1d3543cb/waku/standards/core/16/README.md"><code>eef961b</code></a> — remove rfs folder</li>
<li><strong>2024-01-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/8a53f2431c057fb3ccf4a25e837883e67818f86d/waku/rfcs/standards/core/16/README.md"><code>8a53f24</code></a> — Create README.md</li>
</ul>
<!-- timeline:end -->
<h2 id="introduction-4"><a class="header" href="#introduction-4">Introduction</a></h2>
<p>This specification describes the JSON-RPC API that Waku v2 nodes MAY adhere to.
Refer to the <a href="waku/deprecated/16/../10/waku2.html">Waku v2 specification</a>
for more information on Waku v2.</p>
<h2 id="wire-protocol-4"><a class="header" href="#wire-protocol-4">Wire Protocol</a></h2>
<h3 id="transport-1"><a class="header" href="#transport-1">Transport</a></h3>
<p>Nodes SHOULD expose an accessible
<a href="https://www.jsonrpc.org/specification">JSON-RPC</a> API.
The JSON-RPC version SHOULD be <code>2.0</code>. Below is an example request:</p>
<pre><code class="language-json">{
  "jsonrpc":"2.0",
  "method":"get_waku_v2_debug_info",
  "params":[],
  "id":1
}
</code></pre>
<h4 id="fields-2"><a class="header" href="#fields-2">Fields</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody>
<tr><td><code>jsonrpc</code></td><td>Contains the used JSON-RPC version (<code>Default: 2.0</code>)</td></tr>
<tr><td><code>method</code></td><td>Contains the JSON-RPC method that is being called</td></tr>
<tr><td><code>params</code></td><td>An array of parameters for the request</td></tr>
<tr><td><code>id</code></td><td>The request ID</td></tr>
</tbody></table>
</div>
<h3 id="types"><a class="header" href="#types">Types</a></h3>
<p>In this specification, the primitive types <code>Boolean</code>, <code>String</code>,
<code>Number</code> and <code>Null</code>, as well as the structured types <code>Array</code> and <code>Object</code>,
are to be interpreted according to the <a href="https://www.jsonrpc.org/specification#conventions">JSON-RPC specification</a>.
It also adopts the same capitalisation conventions.</p>
<p>The following structured types are defined for use throughout the document:</p>
<h3 id="wakumessage-1"><a class="header" href="#wakumessage-1">WakuMessage</a></h3>
<p>Refer to <a href="waku/deprecated/16/../14/message.html"><code>Waku Message</code> specification</a> for more information.</p>
<p><code>WakuMessage</code> is an <code>Object</code> containing the following fields:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>payload</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>The message payload as a <a href="https://datatracker.ietf.org/doc/html/rfc4648">base64 (with padding)</a> encoded data string</td></tr>
<tr><td style="text-align: right"><code>contentTopic</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">optional</td><td>Message content topic for optional content-based filtering</td></tr>
<tr><td style="text-align: right"><code>version</code></td><td style="text-align: center"><code>Number</code></td><td style="text-align: center">optional</td><td>Message version. Used to indicate type of payload encryption. Default version is 0 (no payload encryption).</td></tr>
<tr><td style="text-align: right"><code>timestamp</code></td><td style="text-align: center"><code>Number</code></td><td style="text-align: center">optional</td><td>The time at which the message is generated by its sender. This field holds the Unix epoch time in nanoseconds as a 64-bits integer value.</td></tr>
<tr><td style="text-align: right"><code>ephemeral</code></td><td style="text-align: center"><code>Boolean</code></td><td style="text-align: center">optional</td><td>This flag indicates the transient nature of the message. Indicates if the message is eligible to be stored by the <code>store</code> protocol, <a href="waku/deprecated/16/../13/store.html">13/WAKU2-STORE</a>.</td></tr>
</tbody></table>
</div>
<h2 id="method-naming"><a class="header" href="#method-naming">Method naming</a></h2>
<p>The JSON-RPC methods in this document are designed to be mappable to HTTP REST endpoints.
Method names follow the pattern <code>&lt;method_type&gt;_waku_&lt;protocol_version&gt;_&lt;api&gt;_&lt;api_version&gt;_&lt;resource&gt;</code></p>
<ul>
<li><code>&lt;method_type&gt;</code>:
prefix of the HTTP method type that most closely matches the JSON-RPC function.
Supported <code>method_type</code> values are <code>get</code>, <code>post</code>, <code>put</code>, <code>delete</code> or <code>patch</code>.</li>
<li><code>&lt;protocol_version&gt;</code>: Waku version. Currently <strong>v2</strong>.</li>
<li><code>&lt;api&gt;</code>: one of the listed APIs below, e.g. <code>store</code>, <code>debug</code>, or <code>relay</code>.</li>
<li><code>&lt;api_version&gt;</code>: API definition version. Currently <strong>v1</strong> for all APIs.</li>
<li><code>&lt;resource&gt;</code>: the resource or resource path being addressed</li>
</ul>
<p>The method <code>post_waku_v2_relay_v1_message</code>, for example,
would map to the HTTP REST endpoint <code>POST /waku/v2/relay/v1/message</code>.</p>
<h2 id="debug-api"><a class="header" href="#debug-api">Debug API</a></h2>
<p>Types</p>
<p>The following structured types are defined for use on the Debug API:</p>
<h3 id="wakuinfo"><a class="header" href="#wakuinfo">WakuInfo</a></h3>
<p><code>WakuInfo</code> is an <code>Object</code> containing the following fields:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>listenAddresses</code></td><td style="text-align: center"><code>Array</code>[<code>String</code>]</td><td style="text-align: center">mandatory</td><td>Listening addresses of the node</td></tr>
<tr><td style="text-align: right"><code>enrUri</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">optional</td><td>ENR URI of the node</td></tr>
</tbody></table>
</div>
<p><code>get_waku_v2_debug_v1_info</code></p>
<p>The <code>get_waku_v2_debug_v1_info</code> method retrieves information about a Waku v2 node</p>
<h4 id="parameters-2"><a class="header" href="#parameters-2">Parameters</a></h4>
<p>none</p>
<h4 id="response-2"><a class="header" href="#response-2">Response</a></h4>
<ul>
<li><a href="waku/deprecated/16/rpc.html#wakuinfo"><strong><code>WakuInfo</code></strong></a> - information about a Waku v2 node</li>
</ul>
<h3 id="get_waku_v2_debug_v1_version"><a class="header" href="#get_waku_v2_debug_v1_version"><code>get_waku_v2_debug_v1_version</code></a></h3>
<p>The <code>get_waku_v2_debug_v1_version</code> method retrieves the version of a Waku v2 node
as a string.
The version SHOULD follow <a href="https://semver.org/">semantic versioning</a>.
In case the node's current build is based on a git commit between semantic versions,
the retrieved version string MAY contain the git commit hash alone or
in combination with the latest semantic version.</p>
<p>Parameters</p>
<p>none</p>
<p>Response</p>
<ul>
<li><strong><code>string</code></strong> - represents the version of a Waku v2 node</li>
</ul>
<h2 id="relay-api"><a class="header" href="#relay-api">Relay API</a></h2>
<p>Refer to the <a href="waku/deprecated/16/../11/relay.html">Waku Relay specification</a>
for more information on the relaying of messages.</p>
<p><code>post_waku_v2_relay_v1_message</code></p>
<p>The <code>post_waku_v2_relay_v1_message</code> method publishes a message to be relayed on a
<a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topic</code></a></p>
<p>Parameters</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>topic</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>The <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topic</code></a> being published on</td></tr>
<tr><td style="text-align: right"><code>message</code></td><td style="text-align: center"><a href="waku/deprecated/16/rpc.html#wakumessage"><code>WakuMessage</code></a></td><td style="text-align: center">mandatory</td><td>The <code>message</code> being relayed</td></tr>
</tbody></table>
</div>
<p>Response</p>
<ul>
<li><strong><code>Bool</code></strong> -
<code>true</code> on success or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<p><code>post_waku_v2_relay_v1_subscriptions</code></p>
<p>The <code>post_waku_v2_relay_v1_subscriptions</code> method subscribes a node to an array of
<a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topics</code></a>.</p>
<p>Parameters</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>topics</code></td><td style="text-align: center"><code>Array</code>[<code>String</code>]</td><td style="text-align: center">mandatory</td><td>The <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topics</code></a> being subscribed to</td></tr>
</tbody></table>
</div>
<p>Response</p>
<ul>
<li><strong><code>Bool</code></strong> -
<code>true</code> on success or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<p><code>delete_waku_v2_relay_v1_subscriptions</code></p>
<p>The <code>delete_waku_v2_relay_v1_subscriptions</code> method unsubscribes a node from an array
of <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topics</code></a>.</p>
<p>Parameters</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>topics</code></td><td style="text-align: center"><code>Array</code>[<code>String</code>]</td><td style="text-align: center">mandatory</td><td>The <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topics</code></a> being unsubscribed from</td></tr>
</tbody></table>
</div>
<p>Response</p>
<ul>
<li><strong><code>Bool</code></strong> -
<code>true</code> on success or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<p><code>get_waku_v2_relay_v1_messages</code></p>
<p>The <code>get_waku_v2_relay_v1_messages</code> method returns a list of messages
that were received on a subscribed
<a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topic</code></a>
after the last time this method was called.
The server MUST respond with an <a href="https://www.jsonrpc.org/specification#error_object">error</a>
if no subscription exists for the polled <code>topic</code>.
If no message has yet been received on the polled <code>topic</code>,
the server SHOULD return an empty list.
This method can be used to poll a <code>topic</code> for new messages.</p>
<p>Parameters</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>topic</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>The <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topic</code></a> to poll for the latest messages</td></tr>
</tbody></table>
</div>
<p>Response</p>
<ul>
<li><strong><code>Array</code>[<a href="waku/deprecated/16/rpc.html#wakumessage"><code>WakuMessage</code></a>]</strong> -
the latest <code>messages</code> on the polled <code>topic</code> or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h2 id="relay-private-api"><a class="header" href="#relay-private-api">Relay Private API</a></h2>
<p>The Private API provides functionality to encrypt/decrypt <code>WakuMessage</code> payloads
using either symmetric or asymmetric cryptography.
This allows backwards compatibility with <a href="waku/deprecated/16/../../legacy/6/waku1.html">Waku v1 nodes</a>.
It is the API client's responsibility to keep track of the keys
used for encrypted communication.
Since keys must be cached by the client and
provided to the node to encrypt/decrypt payloads,
a Private API SHOULD NOT be exposed on non-local or untrusted nodes.</p>
<p>Types</p>
<p>The following structured types are defined for use on the Private API:</p>
<h3 id="keypair"><a class="header" href="#keypair">KeyPair</a></h3>
<p><code>KeyPair</code> is an <code>Object</code> containing the following fields:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>privateKey</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>Private key as hex encoded data string</td></tr>
<tr><td style="text-align: right"><code>publicKey</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>Public key as hex encoded data string</td></tr>
</tbody></table>
</div>
<h3 id="get_waku_v2_private_v1_symmetric_key"><a class="header" href="#get_waku_v2_private_v1_symmetric_key"><code>get_waku_v2_private_v1_symmetric_key</code></a></h3>
<p>Generates and returns a symmetric key that can be used for message encryption and
decryption.</p>
<p>Parameters</p>
<p>none</p>
<p>Response</p>
<ul>
<li><strong><code>String</code></strong> - A new symmetric key as hex encoded data string</li>
</ul>
<h3 id="get_waku_v2_private_v1_asymmetric_keypair"><a class="header" href="#get_waku_v2_private_v1_asymmetric_keypair"><code>get_waku_v2_private_v1_asymmetric_keypair</code></a></h3>
<p>Generates and returns a public/private key pair
that can be used for asymmetric message encryption and decryption.</p>
<p>Parameters</p>
<p>none</p>
<p>Response</p>
<ul>
<li><strong><a href="waku/deprecated/16/rpc.html#keypair"><code>KeyPair</code></a></strong> - A new public/private key pair as hex encoded data strings</li>
</ul>
<p><code>post_waku_v2_private_v1_symmetric_message</code></p>
<p>The <code>post_waku_v2_private_v1_symmetric_message</code> method publishes a message
to be relayed on a <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topic</code></a>.</p>
<p>Before being relayed,
the message payload is encrypted using the supplied symmetric key.
The client MUST provide a symmetric key.</p>
<p>Parameters</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>topic</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>The <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topic</code></a> being published on</td></tr>
<tr><td style="text-align: right"><code>message</code></td><td style="text-align: center"><a href="waku/deprecated/16/rpc.html#wakumessage"><code>WakuMessage</code></a></td><td style="text-align: center">mandatory</td><td>The (unencrypted) <code>message</code> being relayed</td></tr>
<tr><td style="text-align: right"><code>symkey</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>The hex encoded symmetric key to use for payload encryption. This field MUST be included if symmetric key cryptography is selected</td></tr>
</tbody></table>
</div>
<p>Response</p>
<ul>
<li><strong><code>Bool</code></strong> -
<code>true</code> on success or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<p><code>post_waku_v2_private_v1_asymmetric_message</code></p>
<p>The <code>post_waku_v2_private_v1_asymmetric_message</code> method publishes a message
to be relayed on a <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topic</code></a>.</p>
<p>Before being relayed,
the message payload is encrypted using the supplied public key.
The client MUST provide a public key.</p>
<p>Parameters</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>topic</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>The <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topic</code></a> being published on</td></tr>
<tr><td style="text-align: right"><code>message</code></td><td style="text-align: center"><a href="waku/deprecated/16/rpc.html#wakumessage"><code>WakuMessage</code></a></td><td style="text-align: center">mandatory</td><td>The (unencrypted) <code>message</code> being relayed</td></tr>
<tr><td style="text-align: right"><code>publicKey</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>The hex encoded public key to use for payload encryption. This field MUST be included if asymmetric key cryptography is selected</td></tr>
</tbody></table>
</div>
<p>Response</p>
<ul>
<li><strong><code>Bool</code></strong> -
<code>true</code> on success or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h3 id="get_waku_v2_private_v1_symmetric_messages"><a class="header" href="#get_waku_v2_private_v1_symmetric_messages"><code>get_waku_v2_private_v1_symmetric_messages</code></a></h3>
<p>The <code>get_waku_v2_private_v1_symmetric_messages</code> method decrypts and
returns a list of messages that were received on a subscribed
<a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topic</code></a>
after the last time this method was called.
The server MUST respond with an <a href="https://www.jsonrpc.org/specification#error_object">error</a>
if no subscription exists for the polled <code>topic</code>.
If no message has yet been received on the polled <code>topic</code>,
the server SHOULD return an empty list.
This method can be used to poll a <code>topic</code> for new messages.</p>
<p>Before returning the messages,
the server decrypts the message payloads using the supplied symmetric key.
The client MUST provide a symmetric key.</p>
<p>Parameters</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>topic</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>The <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topic</code></a> to poll for the latest messages</td></tr>
<tr><td style="text-align: right"><code>symkey</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>The hex encoded symmetric key to use for payload decryption. This field MUST be included if symmetric key cryptography is selected</td></tr>
</tbody></table>
</div>
<p>Response</p>
<ul>
<li><strong><code>Array</code>[<a href="waku/deprecated/16/rpc.html#wakumessage"><code>WakuMessage</code></a>]</strong> -
the latest <code>messages</code> on the polled <code>topic</code> or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<p><code>get_waku_v2_private_v1_asymmetric_messages</code></p>
<p>The <code>get_waku_v2_private_v1_asymmetric_messages</code> method decrypts and
returns a list of messages that were received on a subscribed <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topic</code></a>
after the last time this method was called.
The server MUST respond with an <a href="https://www.jsonrpc.org/specification#error_object">error</a>
if no subscription exists for the polled <code>topic</code>.
If no message has yet been received on the polled <code>topic</code>,
the server SHOULD return an empty list.
This method can be used to poll a <code>topic</code> for new messages.</p>
<p>Before returning the messages,
the server decrypts the message payloads using the supplied private key.
The client MUST provide a private key.</p>
<p>Parameters</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>topic</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>The <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topic</code></a> to poll for the latest messages</td></tr>
<tr><td style="text-align: right"><code>privateKey</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>The hex encoded private key to use for payload decryption. This field MUST be included if asymmetric key cryptography is selected</td></tr>
</tbody></table>
</div>
<p>Response</p>
<ul>
<li><strong><code>Array</code>[<a href="waku/deprecated/16/rpc.html#wakumessage"><code>WakuMessage</code></a>]</strong> -
the latest <code>messages</code> on the polled <code>topic</code> or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h2 id="store-api"><a class="header" href="#store-api">Store API</a></h2>
<p>Refer to the <a href="waku/deprecated/16/../13/store.html">Waku Store specification</a>
for more information on message history retrieval.</p>
<p>The following structured types are defined for use on the Store API:</p>
<h3 id="storeresponse"><a class="header" href="#storeresponse">StoreResponse</a></h3>
<p><code>StoreResponse</code> is an <code>Object</code> containing the following fields:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>messages</code></td><td style="text-align: center"><code>Array</code>[<a href="waku/deprecated/16/rpc.html#wakumessage"><code>WakuMessage</code></a>]</td><td style="text-align: center">mandatory</td><td>Array of retrieved historical messages</td></tr>
<tr><td style="text-align: right"><code>pagingOptions</code></td><td style="text-align: center"><a href="waku/deprecated/16/rpc.html#pagingoptions"><code>PagingOptions</code></a></td><td style="text-align: center"><a href="waku/deprecated/16/rpc.html#get_waku_v2_store_v1_messages">conditional</a></td><td>Paging information from which to resume further historical queries</td></tr>
</tbody></table>
</div>
<h4 id="pagingoptions"><a class="header" href="#pagingoptions">PagingOptions</a></h4>
<p><code>pagingOptions</code> is an <code>Object</code> containing the following fields:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>pageSize</code></td><td style="text-align: center"><code>Number</code></td><td style="text-align: center">mandatory</td><td>Number of messages to retrieve per page</td></tr>
<tr><td style="text-align: right"><code>cursor</code></td><td style="text-align: center"><a href="waku/deprecated/16/rpc.html#index"><code>Index</code></a></td><td style="text-align: center">optional</td><td>Message <a href="waku/deprecated/16/rpc.html#index"><code>Index</code></a> from which to perform pagination. If not included and <code>forward</code> is set to <code>true</code>, paging will be performed from the beginning of the list. If not included and <code>forward</code> is set to <code>false</code>, paging will be performed from the end of the list.</td></tr>
<tr><td style="text-align: right"><code>forward</code></td><td style="text-align: center"><code>Bool</code></td><td style="text-align: center">mandatory</td><td><code>true</code> if paging forward, <code>false</code> if paging backward</td></tr>
</tbody></table>
</div>
<h4 id="index"><a class="header" href="#index">Index</a></h4>
<p><code>Index</code> is an <code>Object</code> containing the following fields:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>digest</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>A hash for the message at this <a href="waku/deprecated/16/rpc.html#index"><code>Index</code></a></td></tr>
<tr><td style="text-align: right"><code>receivedTime</code></td><td style="text-align: center"><code>Number</code></td><td style="text-align: center">mandatory</td><td>UNIX timestamp in nanoseconds at which the message at this <a href="waku/deprecated/16/rpc.html#index"><code>Index</code></a> was received</td></tr>
</tbody></table>
</div>
<p>ContentFilter</p>
<p><code>ContentFilter</code> is an <code>Object</code> containing the following fields:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>contentTopic</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>The content topic of a <a href="waku/deprecated/16/rpc.html#wakumessage"><code>WakuMessage</code></a></td></tr>
</tbody></table>
</div>
<p><code>get_waku_v2_store_v1_messages</code></p>
<p>The <code>get_waku_v2_store_v1_messages</code> method retrieves historical messages
on specific content topics.
This method MAY be called with <a href="waku/deprecated/16/rpc.html#pagingoptions"><code>PagingOptions</code></a>,
to retrieve historical messages on a per-page basis.
If the request included <a href="waku/deprecated/16/rpc.html#pagingoptions"><code>PagingOptions</code></a>,
the node MUST return messages on a per-page basis and
include <a href="waku/deprecated/16/rpc.html#pagingoptions"><code>PagingOptions</code></a> in the response.
These <a href="waku/deprecated/16/rpc.html#pagingoptions"><code>PagingOptions</code></a> MUST contain a <code>cursor</code> pointing
to the <a href="waku/deprecated/16/rpc.html#index"><code>Index</code></a> from which a new page can be requested.</p>
<p>Parameters</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>pubsubTopic</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">optional</td><td>The pubsub topic on which a  <a href="waku/deprecated/16/rpc.html#wakumessage"><code>WakuMessage</code></a> is published</td></tr>
<tr><td style="text-align: right"><code>contentFilters</code></td><td style="text-align: center"><code>Array</code>[<a href="waku/deprecated/16/rpc.html#contentfilter"><code>ContentFilter</code></a>]</td><td style="text-align: center">optional</td><td>Array of content filters to query for historical messages</td></tr>
<tr><td style="text-align: right"><code>startTime</code></td><td style="text-align: center"><code>Number</code></td><td style="text-align: center">optional</td><td>The inclusive lower bound on the <a href="waku/deprecated/16/../14/message.html"><code>timestamp</code></a> of queried <a href="waku/deprecated/16/rpc.html#wakumessage"><code>WakuMessage</code>s</a>. This field holds the Unix epoch time in nanoseconds as a 64-bits integer value.</td></tr>
<tr><td style="text-align: right"><code>endTime</code></td><td style="text-align: center"><code>Number</code></td><td style="text-align: center">optional</td><td>The inclusive upper bound on the <a href="waku/deprecated/16/../14/message.html"><code>timestamp</code></a> of queried <a href="waku/deprecated/16/rpc.html#wakumessage"><code>WakuMessage</code>s</a>. This field holds the Unix epoch time in nanoseconds as a 64-bits integer value.</td></tr>
<tr><td style="text-align: right"><code>pagingOptions</code></td><td style="text-align: center"><a href="waku/deprecated/16/rpc.html#pagingoptions"><code>PagingOptions</code></a></td><td style="text-align: center">optional</td><td>Pagination information</td></tr>
</tbody></table>
</div>
<p>Response</p>
<ul>
<li><a href="waku/deprecated/16/rpc.html#storeresponse"><strong><code>StoreResponse</code></strong></a> -
the response to a <code>query</code> for historical messages.</li>
</ul>
<h2 id="filter-api"><a class="header" href="#filter-api">Filter API</a></h2>
<p>Refer to the <a href="waku/deprecated/16/../12/filter.html">Waku Filter specification</a>
for more information on content filtering.</p>
<p>Types</p>
<p>The following structured types are defined for use on the Filter API:</p>
<h3 id="contentfilter"><a class="header" href="#contentfilter">ContentFilter</a></h3>
<p><code>ContentFilter</code> is an <code>Object</code> containing the following fields:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>contentTopic</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>message content topic</td></tr>
</tbody></table>
</div>
<h3 id="post_waku_v2_filter_v1_subscription"><a class="header" href="#post_waku_v2_filter_v1_subscription"><code>post_waku_v2_filter_v1_subscription</code></a></h3>
<p>The <code>post_waku_v2_filter_v1_subscription</code> method creates a subscription in a
<a href="waku/deprecated/16/../12/filter.html">light node</a> for messages that matches a content filter
and, optionally, a <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topic</code></a>.</p>
<p>Parameters</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>contentFilters</code></td><td style="text-align: center"><code>Array</code>[<a href="waku/deprecated/16/rpc.html#contentfilter"><code>ContentFilter</code></a>]</td><td style="text-align: center">mandatory</td><td>Array of content filters being subscribed to</td></tr>
<tr><td style="text-align: right"><code>topic</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">optional</td><td>Message topic</td></tr>
</tbody></table>
</div>
<p>Response</p>
<ul>
<li><strong><code>Bool</code></strong> - <code>true</code> on success or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<p><code>delete_waku_v2_filter_v1_subscription</code></p>
<p>The <code>delete_waku_v2_filter_v1_subscription</code> method removes subscriptions
in a <a href="waku/deprecated/16/../12/filter.html">light node</a> matching a content filter and,
optionally, a <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#the-topic-descriptor">PubSub <code>topic</code></a>.</p>
<p>Parameters</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>contentFilters</code></td><td style="text-align: center"><code>Array</code>[<a href="waku/deprecated/16/rpc.html#contentfilter"><code>ContentFilter</code></a>]</td><td style="text-align: center">mandatory</td><td>Array of content filters being unsubscribed from</td></tr>
<tr><td style="text-align: right"><code>topic</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">optional</td><td>Message topic</td></tr>
</tbody></table>
</div>
<p>Response</p>
<ul>
<li><strong><code>Bool</code></strong> -
<code>true</code> on success or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h3 id="get_waku_v2_filter_v1_messages"><a class="header" href="#get_waku_v2_filter_v1_messages"><code>get_waku_v2_filter_v1_messages</code></a></h3>
<p>The <code>get_waku_v2_filter_v1_messages</code> method returns a list of messages
that were received on a subscribed content <code>topic</code>
after the last time this method was called.
The server MUST respond with an
<a href="https://www.jsonrpc.org/specification#error_object">error</a>
if no subscription exists for the polled content <code>topic</code>.
If no message has yet been received on the polled content <code>topic</code>,
the server SHOULD respond with an empty list.
This method can be used to poll a content <code>topic</code> for new messages.</p>
<p>Parameters</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>contentTopic</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>The content topic to poll for the latest messages</td></tr>
</tbody></table>
</div>
<p>Response</p>
<ul>
<li><strong><code>Array</code>[<a href="waku/deprecated/16/rpc.html#wakumessage"><code>WakuMessage</code></a>]</strong> -
the latest <code>messages</code> on the polled content <code>topic</code> or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h2 id="admin-api"><a class="header" href="#admin-api">Admin API</a></h2>
<p>The Admin API provides privileged accesses
to the internal operations of a Waku v2 node.</p>
<p>The following structured types are defined for use on the Admin API:</p>
<h3 id="wakupeer"><a class="header" href="#wakupeer">WakuPeer</a></h3>
<p><code>WakuPeer</code> is an <code>Object</code> containing the following fields:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>multiaddr</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>Multiaddress containing this peer's location and identity</td></tr>
<tr><td style="text-align: right"><code>protocol</code></td><td style="text-align: center"><code>String</code></td><td style="text-align: center">mandatory</td><td>Protocol that this peer is registered for</td></tr>
<tr><td style="text-align: right"><code>connected</code></td><td style="text-align: center"><code>bool</code></td><td style="text-align: center">mandatory</td><td><code>true</code> if peer has active connection for this <code>protocol</code>, <code>false</code> if not</td></tr>
</tbody></table>
</div>
<h3 id="get_waku_v2_admin_v1_peers"><a class="header" href="#get_waku_v2_admin_v1_peers"><code>get_waku_v2_admin_v1_peers</code></a></h3>
<p>The <code>get_waku_v2_admin_v1_peers</code> method returns an array of peers
registered on this node.
Since a Waku v2 node may open either continuous or ad hoc connections,
depending on the negotiated protocol,
these peers may have different connected states.
The same peer MAY appear twice in the returned array,
if it is registered for more than one protocol.</p>
<p>Parameters</p>
<ul>
<li>none</li>
</ul>
<p>Response</p>
<ul>
<li><strong><code>Array</code>[<a href="waku/deprecated/16/rpc.html#wakupeer"><code>WakuPeer</code></a>]</strong> - Array of peers registered on this node</li>
</ul>
<h3 id="post_waku_v2_admin_v1_peers"><a class="header" href="#post_waku_v2_admin_v1_peers"><code>post_waku_v2_admin_v1_peers</code></a></h3>
<p>The <code>post_waku_v2_admin_v1_peers</code> method connects a node to a list of peers.</p>
<p>Parameters</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Inclusion</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: right"><code>peers</code></td><td style="text-align: center"><code>Array</code>[<code>String</code>]</td><td style="text-align: center">mandatory</td><td>Array of peer <code>multiaddrs</code> to connect to. Each <code>multiaddr</code> must contain the <a href="https://docs.libp2p.io/concepts/addressing/">location and identity addresses</a> of a peer.</td></tr>
</tbody></table>
</div>
<p>Response</p>
<ul>
<li><strong><code>Bool</code></strong> -
<code>true</code> on success or
an <a href="https://www.jsonrpc.org/specification#error_object">error</a> on failure.</li>
</ul>
<h2 id="example-usage"><a class="header" href="#example-usage">Example usage</a></h2>
<p>Store API</p>
<h3 id="get_waku_v2_store_v1_messages"><a class="header" href="#get_waku_v2_store_v1_messages"><code>get_waku_v2_store_v1_messages</code></a></h3>
<p>This method is part of the <code>store</code> API and
the specific resources to retrieve are (historical) <code>messages</code>.
The protocol (<code>waku</code>) is on <code>v2</code>, whereas the Store API definition is on <code>v1</code>.</p>
<p>1.<code>get</code> <em>all</em> the historical messages for content topic
<strong>"/waku/2/default-content/proto"</strong>; no paging required</p>
<h4 id="request-1"><a class="header" href="#request-1">Request</a></h4>
<pre><code class="language-curl">curl -d '{"jsonrpc":"2.0","id":"id","method":"get_waku_v2_store_v1_messages", "params":["", [{"contentTopic":"/waku/2/default-content/proto"}]]}' --header "Content-Type: application/json" http://localhost:8545
</code></pre>
<pre><code class="language-jsonrpc">{
  "jsonrpc": "2.0",
  "id": "id",
  "method": "get_waku_v2_store_v1_messages",
  "params": [
    "",
    [
      {"contentTopic": "/waku/2/default-content/proto"}
    ]
  ]
}
</code></pre>
<p>Response</p>
<pre><code class="language-jsonrpc">{
  "jsonrpc": "2.0",
  "id": "id",
  "result": {
    "messages": [
      {
        "payload": dGVzdDE,
        "contentTopic": "/waku/2/default-content/proto",
        "version": 0
      },
      {
        "payload": dGVzdDI,
        "contentTopic": "/waku/2/default-content/proto",
        "version": 0
      },
      {
        "payload": dGVzdDM,
        "contentTopic": "/waku/2/default-content/proto",
        "version": 0
      }
    ],
    "pagingInfo": null
  },
  "error": null
}
</code></pre>
<hr />
<p>2.<code>get</code> a single page of historical messages for content topic <strong>"/waku/2/default-content/proto"</strong>;
2 messages per page, backward direction.
Since this is the initial query, no <code>cursor</code> is provided,
so paging will be performed from the end of the list.</p>
<p>Request</p>
<pre><code class="language-curl">curl -d '{"jsonrpc":"2.0","id":"id","method":"get_waku_v2_store_v1_messages", "params":[ "", [{"contentTopic":"/waku/2/default-content/proto"}],{"pageSize":2,"forward":false}]}' --header "Content-Type: application/json" http://localhost:8545
</code></pre>
<pre><code class="language-jsonrpc">{
  "jsonrpc": "2.0",
  "id": "id",
  "method": "get_waku_v2_store_v1_messages",
  "params": [
    "",
    [
      {"contentTopic": "/waku/2/default-content/proto"}
    ],
    {
      "pageSize": 2,
      "forward": false
    }
  ]
}
</code></pre>
<p>Response</p>
<pre><code class="language-jsonrpc">{
  "jsonrpc": "2.0",
  "id": "id",
  "result": {
    "messages": [
      {
        "payload": dGVzdDI,
        "contentTopic": "/waku/2/default-content/proto",
        "version": 0
      },
      {
        "payload": dGVzdDM,
        "contentTopic": "/waku/2/default-content/proto",
        "version": 0
      }
    ],
    "pagingInfo": {
      "pageSize": 2,
      "cursor": {
        "digest": "abcdef",
        "receivedTime": 1605887187000000000
      },
      "forward": false
    }
  },
  "error": null
}
</code></pre>
<hr />
<p>3.<code>get</code> the next page of historical messages for content topic <strong>"/waku/2/default-content/proto"</strong>,
using the cursor received above; 2 messages per page, backward direction.</p>
<p>Request</p>
<pre><code class="language-curl">curl -d '{"jsonrpc":"2.0","id":"id","method":"get_waku_v2_store_v1_messages", "params":[ "", [{"contentTopic":"/waku/2/default-content/proto"}],{"pageSize":2,"cursor":{"digest":"abcdef","receivedTime":1605887187000000000},"forward":false}]}' --header "Content-Type: application/json" http://localhost:8545
</code></pre>
<pre><code class="language-jsonrpc">{
  "jsonrpc": "2.0",
  "id": "id",
  "method": "get_waku_v2_store_v1_messages",
  "params": [
    "",
    [
      {"contentTopic": "/waku/2/default-content/proto"}
    ],
    {
      "pageSize": 2,
      "cursor": {
        "digest": "abcdef",
        "receivedTime": 1605887187000000000
      },
      "forward": false
    }
  ]
}
</code></pre>
<p>Response</p>
<pre><code class="language-jsonrpc">{
  "jsonrpc": "2.0",
  "id": "id",
  "result": {
    "messages": [
      {
        "payload": dGVzdDE,
        "contentTopic": "/waku/2/default-content/proto",
        "version": 0
      },
    ],
    "pagingInfo": {
      "pageSize": 2,
      "cursor": {
        "digest": "123abc",
        "receivedTime": 1605866187000000000
      },
      "forward": false
    }
  },
  "error": null
}
</code></pre>
<h2 id="copyright-43"><a class="header" href="#copyright-43">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-34"><a class="header" href="#references-34">References</a></h2>
<ol>
<li><a href="https://www.jsonrpc.org/specification">JSON-RPC specification</a></li>
<li><a href="https://docs.libp2p.io/concepts/addressing/">LibP2P Addressing</a></li>
<li><a href="https://github.com/libp2p/specs/tree/master/pubsub#the-topic-descriptor">LibP2P PubSub specification - topic descriptor</a></li>
<li><a href="waku/deprecated/16/../10/waku2.html">Waku v2 specification</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc4648">IETF RFC 4648 - The Base16, Base32, and Base64 Data Encodings</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="18waku2-swap"><a class="header" href="#18waku2-swap">18/WAKU2-SWAP</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku SWAP Accounting</td></tr>
<tr><th>Slug</th><td>18</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Oskar Thorén &lt;oskarth@titanproxy.com&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-48"><a class="header" href="#timeline-48">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/deprecated/18/swap.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/deprecated/18/swap.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/deprecated/18/swap.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-04-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/8f94e97cf299697f30b2a2e5887e18845712cad3/waku/deprecated/18/swap.md"><code>8f94e97</code></a> — docs: deprecate swap protocol (#31)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/application/18/swap.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/0d8ad0822259fe8961764dc82975eaaf42c3a837/waku/standards/application/18/swap.md"><code>0d8ad08</code></a> — Update and rename SWAP.md to swap.md</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3c8410c8d8702d0bae07fce4285133579fd8589f/waku/standards/application/18/SWAP.md"><code>3c8410c</code></a> — Create SWAP.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-28"><a class="header" href="#abstract-28">Abstract</a></h2>
<p>This specification outlines how we do accounting and settlement based on the provision
and usage of resources, most immediately bandwidth usage and/or
storing and retrieving of Waku message.
This enables nodes to cooperate and efficiently share resources,
and in the case of unequal nodes to settle the difference
through a relaxed payment mechanism in the form of sending cheques.</p>
<p><strong>Protocol identifier</strong>*: <code>/vac/waku/swap/2.0.0-beta1</code></p>
<h2 id="motivation-20"><a class="header" href="#motivation-20">Motivation</a></h2>
<p>The Waku network makes up a service network, and
some nodes provide a useful service to other nodes.
We want to account for that, and when imbalances arise, settle this.
The core of this approach has some theoretical backing in game theory, and
variants of it have practically been proven to work in systems such as Bittorrent.
The specific model use was developed by the Swarm project
(previously part of Ethereum), and
we re-use contracts that were written for this purpose.</p>
<p>By using a delayed payment mechanism in the form of cheques,
a barter-like mechanism can arise, and
nodes can decide on their own policy
as opposed to be strictly tied to a specific payment scheme.
Additionally, this delayed settlement eases requirements
on the underlying network in terms of transaction speed or costs.</p>
<p>Theoretically, nodes providing and using resources over a long,
indefinite, period of time can be seen as an iterated form of
<a href="https://en.wikipedia.org/wiki/Prisoner%27s_dilemma">Prisoner's Dilemma (PD)</a>.
Specifically, and more intuitively,
since we have a cost and benefit profile for each provision/usage
(of Waku Message's, e.g.), and
the pricing can be set such that mutual cooperation is incentivized,
this can be analyzed as a form of donations game.</p>
<h2 id="game-theory---iterated-prisoners-dilemma--donation-game"><a class="header" href="#game-theory---iterated-prisoners-dilemma--donation-game">Game Theory - Iterated prisoner's dilemma / donation game</a></h2>
<p>What follows is a sketch of what the game looks like between two nodes.
We can look at it as a special case of iterated prisoner's dilemma called a
<a href="https://en.wikipedia.org/wiki/Prisoner%27s_dilemma#Special_case:_donation_game">Donation game</a>
where each node can cooperate with some benefit <code>b</code> at a personal cost <code>c</code>,
where <code>b&gt;c</code>.</p>
<p>From A's point of view:</p>
<div class="table-wrapper"><table><thead><tr><th>A/B</th><th>Cooperate</th><th>Defect</th></tr></thead><tbody>
<tr><td>Cooperate</td><td>b-c</td><td>-c</td></tr>
<tr><td>Defect</td><td>b</td><td>0</td></tr>
</tbody></table>
</div>
<p>What this means is that if A and B cooperates,
A gets some benefit <code>b</code> minus a cost <code>c</code>.
If A cooperates and B defects she only gets the cost,
and if she defects and B cooperates A only gets the benefit.
If both defect they get neither benefit nor cost.</p>
<p>The generalized form of PD is:</p>
<div class="table-wrapper"><table><thead><tr><th>A/B</th><th>Cooperate</th><th>Defect</th></tr></thead><tbody>
<tr><td>Cooperate</td><td>R</td><td>S</td></tr>
<tr><td>Defect</td><td>T</td><td>P</td></tr>
</tbody></table>
</div>
<p>With R=reward, S=Sucker's payoff, T=temptation, P=punishment</p>
<p>And the following holds:</p>
<ul>
<li><code>T&gt;R&gt;P&gt;S</code></li>
<li><code>2R&gt;T+S</code></li>
</ul>
<p>In our case, this means <code>b&gt;b-c&gt;0&gt;-c</code> and <code>2(b-c)&gt; b-c</code> which is trivially true.</p>
<p>As this is an iterated game with no clear finishing point in most circumstances,
a tit-for-tat strategy is simple, elegant and functional.
To be more theoretically precise,
this also requires reasonable assumptions on error rate and discount parameter.
This captures notions such as
"does the perceived action reflect the intended action" and
"how much do you value future (uncertain) actions compared to previous actions".
See <a href="https://en.wikipedia.org/wiki/The_Evolution_of_Cooperation">Axelrod - Evolution of Cooperation (book)</a>
for more details.
In specific circumstances,
nodes can choose slightly different policies if there's a strong need for it.
A policy is simply how a node chooses to act given a set of circumstances.</p>
<p>A tit-for-tat strategy basically means:</p>
<ul>
<li>cooperate first (perform service/beneficial action to other node)</li>
<li>defect when node stops cooperating (disconnect and similar actions),
i.e. when it stops performing according to set parameters re settlement</li>
<li>resume cooperation if other node does so</li>
</ul>
<p>This can be complemented with node selection mechanisms.</p>
<h2 id="swap-protocol-overview"><a class="header" href="#swap-protocol-overview">SWAP protocol overview</a></h2>
<p>We use SWAP for accounting and
settlement in conjunction with other request/reply protocols in Waku v2,
where accounting is done in a pairwise manner.
It is an acronym with several possible meanings (as defined in the Book
of Swarm), for example:</p>
<ul>
<li>service wanted and provided</li>
<li>settle with automated payments</li>
<li>send waiver as payment</li>
<li>start without a penny</li>
</ul>
<p>This approach is based on communicating payment thresholds and
sending cheques as indications of later payments.
Communicating payment thresholds MAY be done out-of-band or as part of the handshake.
Sending cheques is done once payment threshold is hit.</p>
<p>See <a href="https://web.archive.org/web/20210126130038/https://gateway.ethswarm.org/bzz/latest.bookofswarm.eth">Book of Swarm</a>
section 3.2. on Peer-to-peer accounting etc., for more context and details.</p>
<h3 id="accounting"><a class="header" href="#accounting">Accounting</a></h3>
<p>Nodes perform their own accounting for each relevant peer
based on some "volume"/bandwidth metric.
For now we take this to mean the number of <code>WakuMessage</code>s exchanged.</p>
<p>Additionally, a price is attached to each unit.
Currently, this is simply a "karma counter" and equal to 1 per message.</p>
<p>Each accounting balance SHOULD be w.r.t. to a given protocol it is accounting for.</p>
<p>NOTE: This may later be complemented with other metrics,
either as part of SWAP or more likely outside of it.
For example, online time can be communicated and
attested to as a form of enhanced quality of service to inform peer selection.</p>
<h3 id="flow-8"><a class="header" href="#flow-8">Flow</a></h3>
<p>Assuming we have two store nodes,
one operating mostly as a client (A) and another as server (B).</p>
<ol>
<li>Node A performs a handshake with B node.
B node responds and both nodes communicate their payment threshold.</li>
<li>Node A and B creates an accounting entry for the other peer,
keep track of peer and current balance.</li>
<li>Node A issues a <code>HistoryRequest</code>, and B responds with a <code>HistoryResponse</code>.
Based on the number of WakuMessages in the response,
both nodes update their accounting records.</li>
<li>When payment threshold is reached,
Node A sends over a cheque to reach a neutral balance.
Settlement of this is currently out of scope,
but would occur through a SWAP contract (to be specified).
(mock and hard phase).</li>
<li>If disconnect threshold is reached, Node B disconnects Node A (mock and hard phase).</li>
</ol>
<p>Note that not all of these steps are mandatory in initial stages,
see below for more details.
For example, the payment threshold MAY initially be set out of bounds,
and policy is only activated in the mock and hard phase.</p>
<h3 id="protobufs"><a class="header" href="#protobufs">Protobufs</a></h3>
<p>We use protobuf to specify the handshake and signature.
This current protobuf is a work in progress.
This is needed for mock and hard phase.</p>
<p>A handshake gives initial information about payment thresholds and
possibly other information.
A cheque is best thought of as a promise to pay at a later date.</p>
<pre><code class="language-protobuf">
message Handshake {
    bytes payment_threshold = 1;
}

// TODO Signature?
// Should probably be over the whole Cheque type
message Cheque {
    bytes beneficiary = 1;
    // TODO epoch time or block time?
    uint32 date = 2;
    // TODO ERC20 extension?
    // For now karma counter
    uint32 amount = 3;
}

</code></pre>
<h2 id="incremental-integration-and-roll-out"><a class="header" href="#incremental-integration-and-roll-out">Incremental integration and roll-out</a></h2>
<p>To incrementally integrate this into Waku v2,
we have divided up the roll-out into three phases:</p>
<ul>
<li>Soft - accounting only</li>
<li>Mock - send mock cheques and take word for it</li>
<li>Hard Test - blockchain integration and deployed to public testnet
(Goerli, Optimism testnet or similar)</li>
<li>Hard Main - deployed to a public mainnet</li>
</ul>
<p>An implementation MAY support any of these phases.</p>
<h3 id="soft-phase"><a class="header" href="#soft-phase">Soft phase</a></h3>
<p>In the soft phase only accounting is performed, without consequence for the
peers. No disconnect or sending of cheques is performed at this tage.</p>
<p>SWAP protocol is performed in conjunction with another request-reply protocol
to account for its usage.
It SHOULD be done for <a href="waku/deprecated/18/../../core/13/store.html">13/WAKU2-STORE</a>
and it MAY be done for other request/reply protocols.</p>
<p>A client SHOULD log accounting state per peer
and SHOULD indicate when a peer is out of bounds (either of its thresholds met).</p>
<h3 id="mock-phase"><a class="header" href="#mock-phase">Mock phase</a></h3>
<p>In the mock phase, we send mock cheques and send cheques/disconnect peers as appropriate.</p>
<ul>
<li>If a node reaches a disconnect threshold,
which MUST be outside the payment threshold, it SHOULD disconnect the other peer.</li>
<li>If a node is within payment balance, the other node SHOULD stay connected to it.</li>
<li>If a node receives a valid Cheque it SHOULD update its internal accounting records.</li>
<li>If any node behaves badly, the other node is free to disconnect and
pick another node.
<ul>
<li>Peer rating is out of scope of this specification.</li>
</ul>
</li>
</ul>
<h3 id="hard-phase"><a class="header" href="#hard-phase">Hard phase</a></h3>
<p>In the hard phase, in addition to sending cheques and activating policy, this is
done with blockchain integration on a public testnet. More details TBD.</p>
<p>This also includes settlements where cheques can be redeemed.</p>
<h2 id="copyright-44"><a class="header" href="#copyright-44">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-35"><a class="header" href="#references-35">References</a></h2>
<ol>
<li><a href="https://en.wikipedia.org/wiki/Prisoner%27s_dilemma">Prisoner's Dilemma</a></li>
<li><a href="https://en.wikipedia.org/wiki/The_Evolution_of_Cooperation">Axelrod - Evolution of Cooperation (book)</a></li>
<li><a href="https://web.archive.org/web/20210126130038/https://gateway.ethswarm.org/bzz/latest.bookofswarm.eth">Book of Swarm</a></li>
<li><a href="waku/deprecated/18/../../core/13/store.html">13/WAKU2-STORE</a></li>
</ol>
<!--

General TODOs:

- Find new link for book of swarm
- Illustrate payment and disconnection thresholds (mscgen not great for this?)
- Elaborate on how accounting works with amount in the context of e.g. store
- Illustrate flow
- Specify chequeboo

-->
<div style="break-before: page; page-break-before: always;"></div><h1 id="21waku2-fault-tolerant-store"><a class="header" href="#21waku2-fault-tolerant-store">21/WAKU2-FAULT-TOLERANT-STORE</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku v2 Fault-Tolerant Store</td></tr>
<tr><th>Slug</th><td>21</td></tr>
<tr><th>Status</th><td>deleted</td></tr>
<tr><th>Editor</th><td>Sanaz Taheri &lt;sanaz@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-49"><a class="header" href="#timeline-49">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/waku/deprecated/fault-tolerant-store.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/waku/deprecated/fault-tolerant-store.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-11-04</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/cb4d0de84f64b37539af64b6de1e3084ffd74c6a/waku/deprecated/fault-tolerant-store.md"><code>cb4d0de</code></a> — Update 21/WAKU2-FAULT-TOLERANT-STORE: Deleted (#181)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/waku/standards/application/21/fault-tolerant-store.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/waku/standards/application/21/fault-tolerant-store.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-01-31</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/5da8a111ca9856ee53ee5b8598a7d5ecf5a2dce4/waku/standards/application/21/fault-tolerant-store.md"><code>5da8a11</code></a> — Update and rename FAULT-TOLERANT-STORE.md to fault-tolerant-store.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/206133edd978d85993f7680bd2ce384ba0079c1f/waku/standards/application/21/FAULT-TOLERANT-STORE.md"><code>206133e</code></a> — Create FAULT-TOLERANT-STORE.md</li>
</ul>
<!-- timeline:end -->
<p>The reliability of <a href="waku/deprecated/../../core/13/store.html">13/WAKU2-STORE</a>
protocol heavily relies on the fact that full nodes i.e.,
those who persist messages have high availability and
uptime and do not miss any messages.
If a node goes offline,
then it will risk missing all the messages transmitted
in the network during that time.
In this specification,
we provide a method that makes the store protocol resilient
in presence of faulty nodes.
Relying on this method,
nodes that have been offline for a time window will be able to fix the gap
in their message history when getting back online.
Moreover, nodes with lower availability and
uptime can leverage this method to reliably provide the store protocol services
as a full node.</p>
<h2 id="method-description"><a class="header" href="#method-description">Method description</a></h2>
<p>As the first step
towards making the <a href="waku/deprecated/../../core/13/store.html">13/WAKU2-STORE</a> protocol fault-tolerant,
we introduce a new type of time-based query through which nodes fetch message history
from each other based on their desired time window.
This method operates based on the assumption that the querying node
knows some other nodes in the store protocol
which have been online for that targeted time window.</p>
<h2 id="security-consideration-1"><a class="header" href="#security-consideration-1">Security Consideration</a></h2>
<p>The main security consideration to take into account
while using this method is that a querying node
has to reveal its offline time to the queried node.
This will gradually result in the extraction of the node's activity pattern
which can lead to inference attacks.</p>
<h2 id="wire-specification-4"><a class="header" href="#wire-specification-4">Wire Specification</a></h2>
<p>We extend the <a href="waku/deprecated/../../core/13/store.html">HistoryQuery</a> protobuf message
with two fields of <code>start_time</code> and <code>end_time</code> to signify the time range to be queried.</p>
<h3 id="payloads-6"><a class="header" href="#payloads-6">Payloads</a></h3>
<pre><code class="language-diff">syntax = "proto3";

message HistoryQuery {
  // the first field is reserved for future use
  string pubsubtopic = 2;
  repeated ContentFilter contentFilters = 3;
  PagingInfo pagingInfo = 4;
  + sint64 start_time = 5;
  + sint64 end_time = 6;
}

</code></pre>
<h3 id="historyquery"><a class="header" href="#historyquery">HistoryQuery</a></h3>
<p>RPC call to query historical messages.</p>
<ul>
<li><code>start_time</code>:
this field MAY be filled out to signify the starting point of the queried time window.
This field holds the Unix epoch time in nanoseconds.<br />
The <code>messages</code> field of the corresponding
<a href="waku/deprecated/../../core/13/store.html"><code>HistoryResponse</code></a>
MUST contain historical waku messages whose
<a href="waku/deprecated/../../core/14/message.html"><code>timestamp</code></a>
is larger than or equal to the <code>start_time</code>.</li>
<li><code>end_time</code>:
this field MAY be filled out to signify the ending point of the queried time window.
This field holds the Unix epoch time in nanoseconds.
The <code>messages</code> field of the corresponding
<a href="waku/deprecated/../../core/13/store.html"><code>HistoryResponse</code></a>
MUST contain historical waku messages whose
<a href="waku/deprecated/../../core/14/message.html"><code>timestamp</code></a> is less than or equal to the <code>end_time</code>.</li>
</ul>
<p>A time-based query is considered valid if
its <code>end_time</code> is larger than or equal to the <code>start_time</code>.
Queries that do not adhere to this condition will not get through e.g.
an open-end time query in which the <code>start_time</code> is given but
no  <code>end_time</code> is supplied is not valid.
If both <code>start_time</code> and
<code>end_time</code> are omitted then no time-window filter takes place.</p>
<p>In order to account for nodes asynchrony, and
assuming that nodes may be out of sync for at most 20 seconds
(i.e., 20000000000 nanoseconds),
the querying nodes SHOULD add an offset of 20 seconds to their offline time window.
That is if the original window is [<code>l</code>,<code>r</code>]
then the history query SHOULD be made for <code>[start_time: l - 20s, end_time: r + 20s]</code>.</p>
<p>Note that <code>HistoryQuery</code> preserves <code>AND</code> operation among the queried attributes.
As such, the <code>messages</code> field of the corresponding
<a href="waku/deprecated/../../core/13/store.html"><code>HistoryResponse</code></a>
MUST contain historical waku messages that satisfy the indicated  <code>pubsubtopic</code> AND
<code>contentFilters</code> AND the time range [<code>start_time</code>, <code>end_time</code>].</p>
<h2 id="copyright-45"><a class="header" href="#copyright-45">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-36"><a class="header" href="#references-36">References</a></h2>
<ul>
<li><a href="waku/deprecated/../../core/13/store.html">13/WAKU2-STORE</a></li>
<li><a href="waku/deprecated/../../standards/core/14/message.html"><code>timestamp</code></a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nomos-rfcs"><a class="header" href="#nomos-rfcs">Nomos RFCs</a></h1>
<p>Nomos is building a secure, flexible, and
scalable infrastructure for developers creating applications for the network state.
Published Specifications are currently available here,
<a href="https://nomos-tech.notion.site/project">Nomos Specifications</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nomos-raw-specifications"><a class="header" href="#nomos-raw-specifications">Nomos Raw Specifications</a></h1>
<p>Early-stage Nomos specifications that have not yet progressed beyond raw status.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nomosda-encoding"><a class="header" href="#nomosda-encoding">NOMOSDA-ENCODING</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>NomosDA Encoding Protocol</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Editor</th><td>Daniel Sanchez-Quiros &lt;danielsq@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Daniel Kashepava &lt;danielkashepava@status.im&gt;<br>Álvaro Castro-Castilla &lt;alvaro@status.im&gt;<br>Filip Dimitrijevic &lt;filip@status.im&gt;<br>Thomas Lavaur &lt;thomaslavaur@status.im&gt;<br>Mehmet Gonen &lt;mehmet@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-50"><a class="header" href="#timeline-50">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/nomos/raw/nomosda-encoding.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/nomos/raw/nomosda-encoding.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-09-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/39d6f07d4f3fdeb6e483ba61bcee76398cc514df/nomos/raw/nomosda-encoding.md"><code>39d6f07</code></a> — added nomos/raw/nomosda-encoding.md draft (#156)</li>
</ul>
<!-- timeline:end -->
<h2 id="introduction-5"><a class="header" href="#introduction-5">Introduction</a></h2>
<p>This document describes the encoding and verification processes of NomosDA, which is the data availability (DA) solution used by the Nomos blockchain. NomosDA provides an assurance that all data from Nomos blobs are accessible and verifiable by every network participant.</p>
<p>This document presents an implementation specification describing how:</p>
<ul>
<li>Encoders encode blobs they want to upload to the Data Availability layer.</li>
<li>Other nodes implement the verification of blobs that were already uploaded to DA.</li>
</ul>
<h2 id="definitions-6"><a class="header" href="#definitions-6">Definitions</a></h2>
<ul>
<li>
<p><strong>Encoder</strong>: An encoder is any actor who performs the encoding process described in this document. This involves committing to the data, generating proofs, and submitting the result to the DA layer.</p>
<p>In the Nomos architecture, the rollup sequencer typically acts as the encoder, but the role is not exclusive and any actor in the DA layer can also act as encoders.</p>
</li>
<li>
<p><strong>Verifier</strong>: Verifies its portion of the distributed blob data as per the verification protocol. In the Nomos architecture, the DA nodes act as the verifiers.</p>
</li>
</ul>
<h2 id="overview-3"><a class="header" href="#overview-3">Overview</a></h2>
<p>In the encoding stage, the encoder takes the DA parameters and the padded blob data and creates an initial matrix of data chunks. This matrix is expanded using Reed-Solomon coding and various commitments and proofs are created for the data.</p>
<p>When a verifier receives a sample, it verifies the data it receives from the encoder and broadcasts the information if the data is verified. Finally, the verifier stores the sample data for the required length of time.</p>
<h2 id="construction"><a class="header" href="#construction">Construction</a></h2>
<p>The encoder and verifier use the <a href="https://www.notion.so/NomosDA-Cryptographic-Protocol-1fd261aa09df816fa97ac81304732e77?pvs=21">NomosDA cryptographic protocol</a> to carry out their respective functions. These functions are implemented as abstracted and configurable software entities that allow the original data to be encoded and verified via high-level operations.</p>
<h3 id="glossary"><a class="header" href="#glossary">Glossary</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Description</th><th>Representation</th></tr></thead><tbody>
<tr><td><code>Commitment</code></td><td>Commitment as per the <a href="https://www.notion.so/NomosDA-Cryptographic-Protocol-1fd261aa09df816fa97ac81304732e77?pvs=21">NomosDA Cryptographic Protocol</a></td><td><code>bytes</code></td></tr>
<tr><td><code>Proof</code></td><td>Proof as per the <a href="https://www.notion.so/NomosDA-Cryptographic-Protocol-1fd261aa09df816fa97ac81304732e77?pvs=21">NomosDA Cryptographic Protocol</a></td><td><code>bytes</code></td></tr>
<tr><td><code>ChunksMatrix</code></td><td>Matrix of chunked data. Each chunk is <strong>31 bytes.</strong> Row and Column sizes depend on the encoding necessities.</td><td><code>List[List[bytes]]</code></td></tr>
</tbody></table>
</div>
<h3 id="encoder"><a class="header" href="#encoder">Encoder</a></h3>
<p>An encoder takes a set of parameters and the blob data, and creates a matrix of chunks that it uses to compute the necessary cryptographic data. It produces the set of Reed-Solomon (RS) encoded data, the commitments, and the proofs that are needed prior to <a href="https://www.notion.so/NomosDA-Dispersal-1fd261aa09df815288c9caf45ed72c95?pvs=21">dispersal</a>.</p>
<pre><code class="language-mermaid">flowchart LR
    A[DaEncoderParams] --&gt;|Input| B(Encoder)
    I[31bytes-padded-input] --&gt;|Input| B
    B --&gt;|Creates| D[Chunks matrix]
    D --&gt; |Input| C[NomosDA encoding]
    C --&gt; E{Encoded data📄}
</code></pre>
<h4 id="encoding-process"><a class="header" href="#encoding-process">Encoding Process</a></h4>
<p>The encoder executes the encoding process as follows:</p>
<ol>
<li>
<p>The encoder takes the following input parameters:</p>
<pre><code class="language-python">class DAEncoderParams:
    column_count: usize
    bytes_per_field_element: usize
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Description</th><th>Representation</th></tr></thead><tbody>
<tr><td><code>column_count</code></td><td>The number of subnets available for dispersal in the system</td><td><code>usize</code>, <code>int</code> in Python</td></tr>
<tr><td><code>bytes_per_field_element</code></td><td>The amount of bytes per data chunk. This is set to 31 bytes. Each chunk has 31 bytes rather than 32 to ensure that the chunk value does not exceed the maximum value on the <a href="https://electriccoin.co/blog/new-snark-curve/">BLS12-381 elliptic curve</a>.</td><td><code>usize</code>, <code>int</code> in Python</td></tr>
</tbody></table>
</div></li>
<li>
<p>The encoder also includes the blob data to be encoded, which must be of a size that is a multiple of <code>bytes_per_field_element</code> bytes. Clients are responsible for padding the data so it fits this constraint.</p>
</li>
<li>
<p>The encoder splits the data into <code>bytes_per_field_element</code>-sized chunks. It also arranges these chunks into rows and columns, creating a matrix.
a. The amount of columns of the matrix needs to fit with the <code>column_count</code> parameter, taking into account the <code>rs_expansion_factor</code> (currently fixed to 2).
i. This means that the size of each row in this matrix is <code>(bytes_per_field_element*column_count)/rs_expansion_factor</code>.
b. The amount of rows depends on the size of the data.</p>
</li>
<li>
<p>The data is encoded as per <a href="https://www.notion.so/NomosDA-Cryptographic-Protocol-1fd261aa09df816fa97ac81304732e77?pvs=21">the cryptographic details</a>.</p>
</li>
<li>
<p>The encoder provides the encoded data set:</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Description</th><th>Representation</th></tr></thead><tbody>
<tr><td><code>data</code></td><td>Original data</td><td><code>bytes</code></td></tr>
<tr><td><code>chunked_data</code></td><td>Matrix before RS expansion</td><td><code>ChunksMatrix</code></td></tr>
<tr><td><code>extended_matrix</code></td><td>Matrix after RS expansion</td><td><code>ChunksMatrix</code></td></tr>
<tr><td><code>row_commitments</code></td><td>Commitments for each matrix row</td><td><code>List[Commitment]</code></td></tr>
<tr><td><code>combined_column_proofs</code></td><td>Proofs for each matrix column</td><td><code>List[Proof]</code></td></tr>
</tbody></table>
</div>
<pre><code class="language-python">class EncodedData:
    data: bytes
    chunked_data: ChunksMatrix
    extended_matrix: ChunksMatrix
    row_commitments: List[Commitment]
    combined_column_proofs: List[Proof]
</code></pre>
</li>
</ol>
<h4 id="encoder-limits"><a class="header" href="#encoder-limits">Encoder Limits</a></h4>
<p>NomosDA does not impose a fixed limit on blob size at the encoding level. However, protocols that involve resource-intensive operations must include upper bounds to prevent abuse. In the case of NomosDA, blob size limits are expected to be enforced, as part of the protocol's broader responsibility for resource management and fairness.</p>
<p>Larger blobs naturally result in higher computational and bandwidth costs, particularly for the encoder, who must compute a proof for each column. Without size limits, malicious clients could exploit the system by attempting to stream unbounded data to DA nodes. Since payment is provided before blob dispersal, DA nodes are protected from performing unnecessary work. This enables the protocol to safely accept very large blobs, as the primary computational cost falls on the encoder. The protocol can accommodate generous blob sizes in practice, while rejecting only absurdly large blobs, such as those exceeding 1 GB, to prevent denial-of-service attacks and ensure network stability.</p>
<p>To mitigate this, the protocol define acceptable blob size limits, and DA implementations enforce local mitigation strategies, such as flagging or blacklisting clients that violate these constraints.</p>
<h3 id="verifier"><a class="header" href="#verifier">Verifier</a></h3>
<p>A verifier checks the proper encoding of data blobs it receives. A verifier executes the verification process as follows:</p>
<ol>
<li>
<p>The verifier receives a <code>DAShare</code> with the required verification data:</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Description</th><th>Representation</th></tr></thead><tbody>
<tr><td><code>column</code></td><td>Column chunks (31 bytes) from the encoded matrix</td><td><code>List[bytes]</code></td></tr>
<tr><td><code>column_idx</code></td><td>Column id (<code>0..2047</code>). It is directly related to the <code>subnetworks</code> in the <a href="https://www.notion.so/NomosDA-Network-Specification-1fd261aa09df81188e76cb083791252d?pvs=21">network specification</a>.</td><td><code>u16</code>, unsigned int of 16 bits. <code>int</code> in Python</td></tr>
<tr><td><code>combined_column_proof</code></td><td>Proof of the random linear combination of the column elements.</td><td><code>Proof</code></td></tr>
<tr><td><code>row_commitments</code></td><td>Commitments for each matrix row</td><td><code>List[Commitment]</code></td></tr>
<tr><td><code>blob_id</code></td><td>This is computed as the hash (<strong>blake2b</strong>) of <code>row_commitments</code></td><td><code>bytes</code></td></tr>
</tbody></table>
</div></li>
<li>
<p>Upon receiving the above data it verifies the column data as per the <a href="https://www.notion.so/NomosDA-Cryptographic-Protocol-1fd261aa09df816fa97ac81304732e77?pvs=21">cryptographic details</a>. If the verification is successful, the node triggers the <a href="https://www.notion.so/NomosDA-Subnetwork-Replication-1fd261aa09df811d93f8c6280136bfbb?pvs=21">replication protocol</a> and stores the blob.</p>
<pre><code class="language-python">class DAShare:
    column: Column
    column_idx: u16
    combined_column_proof: Proof
    row_commitments: List[Commitment]

    def blob_id(self) -&gt; BlobId:
        hasher = blake2b(digest_size=32)
        for c in self.row_commitments:
            hasher.update(bytes(c))
        return hasher.digest()
</code></pre>
</li>
</ol>
<h3 id="verification-logic"><a class="header" href="#verification-logic">Verification Logic</a></h3>
<pre><code class="language-mermaid">sequenceDiagram
    participant N as Node
    participant S as Subnetwork Column N
    loop For each incoming blob column
        N--&gt;&gt;N: If blob is valid
        N--&gt;&gt;S: Replication
        N-&gt;&gt;N: Stores blob
    end
</code></pre>
<h2 id="details"><a class="header" href="#details">Details</a></h2>
<p>The encoder and verifier processes described above make use of a variety of cryptographic functions to facilitate the correct verification of column data by verifiers. These functions rely on primitives such as polynomial commitments and Reed-Solomon erasure codes, the details of which are outside the scope of this document. These details, as well as introductions to the cryptographic primitives being used, can be found in the NomosDA Cryptographic Protocol:</p>
<p><a href="https://www.notion.so/NomosDA-Cryptographic-Protocol-1fd261aa09df816fa97ac81304732e77?pvs=21">NomosDA Cryptographic Protocol</a></p>
<h2 id="references-37"><a class="header" href="#references-37">References</a></h2>
<ul>
<li>Encoder Specification: <a href="https://github.com/logos-co/nomos-specs/blob/master/da/encoder.py">GitHub/encoder.py</a></li>
<li>Verifier Specification: <a href="https://github.com/logos-co/nomos-specs/blob/master/da/verifier.py">GitHub/verifier.py</a></li>
<li>Cryptographic protocol: <a href="https://www.notion.so/NomosDA-Cryptographic-Protocol-1fd261aa09df816fa97ac81304732e77?pvs=21">NomosDA Cryptographic Protocol</a></li>
</ul>
<h2 id="copyright-46"><a class="header" href="#copyright-46">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nomos-da-network"><a class="header" href="#nomos-da-network">NOMOS-DA-NETWORK</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>NomosDA Network</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Editor</th><td>Daniel Sanchez Quiros &lt;danielsq@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Álvaro Castro-Castilla &lt;alvaro@status.im&gt;<br>Daniel Kashepava &lt;danielkashepava@status.im&gt;<br>Gusto Bacvinka &lt;augustinas@status.im&gt;<br>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-51"><a class="header" href="#timeline-51">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/nomos/raw/nomosda-network.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/nomos/raw/nomosda-network.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-09-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/51ef4cd533d8824291d9e2884bb467235b32a450/nomos/raw/nomosda-network.md"><code>51ef4cd</code></a> — added nomos/raw/nomosda-network.md (#160)</li>
</ul>
<!-- timeline:end -->
<h2 id="introduction-6"><a class="header" href="#introduction-6">Introduction</a></h2>
<p>NomosDA is the scalability solution protocol for data availability within the Nomos network.
This document delineates the protocol's structure at the network level,
identifies participants,
and describes the interactions among its components.<br />
Please note that this document does not delve into the cryptographic aspects of the design.
For comprehensive details on the cryptographic operations,
a detailed specification is a work in progress.</p>
<h2 id="objectives"><a class="header" href="#objectives">Objectives</a></h2>
<p>NomosDA was created to ensure that data from Nomos zones is distributed, verifiable, immutable, and accessible.
At the same time, it is optimised for the following properties:</p>
<ul>
<li>
<p><strong>Decentralization</strong>: NomosDA’s data availability guarantees must be achieved with minimal trust assumptions
and centralised actors. Therefore,
permissioned DA schemes involving a Data Availability Committee (DAC) had to be avoided in the design.
Schemes that require some nodes to download the entire blob data were also off the list
due to the disproportionate role played by these “supernodes”.</p>
</li>
<li>
<p><strong>Scalability</strong>: NomosDA is intended to be a bandwidth-scalable protocol, ensuring that its functions are maintained as the Nomos network grows. Therefore, NomosDA was designed to minimise the amount of data sent to participants, reducing the communication bottleneck and allowing more parties to participate in the DA process.</p>
</li>
</ul>
<p>To achieve the above properties, NomosDA splits up zone data and
distributes it among network participants,
with cryptographic properties used to verify the data’s integrity.
A major feature of this design is that parties who wish to receive an assurance of data availability
can do so very quickly and with minimal hardware requirements.
However, this comes at the cost of additional complexity and resources required by more integral participants.</p>
<h2 id="requirements"><a class="header" href="#requirements">Requirements</a></h2>
<p>In order to ensure that the above objectives are met,
the NomosDA network requires a group of participants
that undertake a greater burden in terms of active involvement in the protocol.
Recognising that not all node operators can do so,
NomosDA assigns different roles to different kinds of participants,
depending on their ability and willingness to contribute more computing power
and bandwidth to the protocol.
It was therefore necessary for NomosDA to be implemented as an opt-in Service Network.</p>
<p>Because the NomosDA network has an arbitrary amount of participants,
and the data is split into a fixed number of portions (see the <a href="https://www.notion.so/NomosDA-Encoding-Verification-4d8ca269e96d4fdcb05abc70426c5e7c">Encoding &amp; Verification Specification</a>),
it was necessary to define exactly how each portion is assigned to a participant who will receive and verify it.
This assignment algorithm must also be flexible enough to ensure smooth operation in a variety of scenarios,
including where there are more or fewer participants than the number of portions.</p>
<h2 id="overview-4"><a class="header" href="#overview-4">Overview</a></h2>
<h3 id="network-participants"><a class="header" href="#network-participants">Network Participants</a></h3>
<p>The NomosDA network includes three categories of participants:</p>
<ul>
<li><strong>Executors</strong>: Tasked with the encoding and dispersal of data blobs.</li>
<li><strong>DA Nodes</strong>: Receive and verify the encoded data,
subsequently temporarily storing it for further network validation through sampling.</li>
<li><strong>Light Nodes</strong>: Employ sampling to ascertain data availability.</li>
</ul>
<h3 id="network-distribution"><a class="header" href="#network-distribution">Network Distribution</a></h3>
<p>The NomosDA network is segmented into <code>num_subnets</code> subnetworks.
These subnetworks represent subsets of peers from the overarching network,
each responsible for a distinct portion of the distributed encoded data.
Peers in the network may engage in one or multiple subnetworks,
contingent upon network size and participant count.</p>
<h3 id="sub-protocols"><a class="header" href="#sub-protocols">Sub-protocols</a></h3>
<p>The NomosDA protocol consists of the following sub-protocols:</p>
<ul>
<li><strong>Dispersal</strong>: Describes how executors distribute encoded data blobs to subnetworks.
<a href="https://www.notion.so/NomosDA-Dispersal-1818f96fb65c805ca257cb14798f24d4?pvs=21">NomosDA Dispersal</a></li>
<li><strong>Replication</strong>: Defines how DA nodes distribute encoded data blobs within subnetworks.
<a href="https://www.notion.so/NomosDA-Subnetwork-Replication-1818f96fb65c80119fa0e958a087cc2b?pvs=21">NomosDA Subnetwork Replication</a></li>
<li><strong>Sampling</strong>: Used by sampling clients (e.g., light clients) to verify the availability of previously dispersed
and replicated data.
<a href="https://www.notion.so/NomosDA-Sampling-1538f96fb65c8031a44cf7305d271779?pvs=21">NomosDA Sampling</a></li>
<li><strong>Reconstruction</strong>: Describes gathering and decoding dispersed data back into its original form.
<a href="https://www.notion.so/NomosDA-Reconstruction-1828f96fb65c80b2bbb9f4c5a0cf26a5?pvs=21">NomosDA Reconstruction</a></li>
<li><strong>Indexing</strong>: Tracks and exposes blob metadata on-chain.
<a href="https://www.notion.so/NomosDA-Indexing-1bb8f96fb65c8044b635da9df20c2411?pvs=21">NomosDA Indexing</a></li>
</ul>
<h2 id="construction-1"><a class="header" href="#construction-1">Construction</a></h2>
<h3 id="nomosda-network-registration"><a class="header" href="#nomosda-network-registration">NomosDA Network Registration</a></h3>
<p>Entities wishing to participate in NomosDA must declare their role via <a href="https://www.notion.so/Final-Draft-Validator-Role-Protocol-17b8f96fb65c80c69c2ef55e22e29506">SDP</a> (Service Declaration Protocol).
Once declared, they're accounted for in the subnetwork construction.</p>
<p>This enables participation in:</p>
<ul>
<li>Dispersal (as executor)</li>
<li>Replication &amp; sampling (as DA node)</li>
<li>Sampling (as light node)</li>
</ul>
<h3 id="subnetwork-assignment"><a class="header" href="#subnetwork-assignment">Subnetwork Assignment</a></h3>
<p>The NomosDA network comprises <code>num_subnets</code> subnetworks,
which are virtual in nature.
A subnetwork is a subset of peers grouped together so nodes know who they should connect with,
serving as groupings of peers tasked with executing the dispersal and replication sub-protocols.
In each subnetwork, participants establish a fully connected overlay,
ensuring all nodes maintain permanent connections for the lifetime of the SDP set
with peers within the same subnetwork.
Nodes refer to nodes in the Data Availability SDP set to ascertain their connectivity requirements across subnetworks.</p>
<h4 id="assignment-algorithm"><a class="header" href="#assignment-algorithm">Assignment Algorithm</a></h4>
<p>The concrete distribution algorithm is described in the following specification:
<a href="https://www.notion.so/DA-Subnetwork-Assignation-217261aa09df80fc8bb9cf46092741ce">DA Subnetwork Assignation</a></p>
<h2 id="executor-connections"><a class="header" href="#executor-connections">Executor Connections</a></h2>
<p>Each executor maintains a connection with one peer per subnetwork,
necessitating at least num_subnets stable and healthy connections.
Executors are expected to allocate adequate resources to sustain these connections.
An example algorithm for peer selection would be:</p>
<pre><code class="language-python">def select_peers(
    subnetworks: Sequence[Set[PeerId]],
    filtered_subnetworks: Set[int],
    filtered_peers: Set[PeerId]
) -&gt; Set[PeerId]:
    result = set()
    for i, subnetwork in enumerate(subnetworks):
        available_peers = subnetwork - filtered_peers
        if i not in filtered_subnetworks and available_peers:
            result.add(next(iter(available_peers)))
    return result
</code></pre>
<h2 id="nomosda-protocol-steps"><a class="header" href="#nomosda-protocol-steps">NomosDA Protocol Steps</a></h2>
<h3 id="dispersal"><a class="header" href="#dispersal">Dispersal</a></h3>
<ol>
<li>The NomosDA protocol is initiated by executors
who perform data encoding as outlined in the <a href="https://www.notion.so/NomosDA-Encoding-Verification-4d8ca269e96d4fdcb05abc70426c5e7c">Encoding Specification</a>.</li>
<li>Executors prepare and distribute each encoded data portion
to its designated subnetwork (from <code>0</code> to <code>num_subnets - 1</code> ).</li>
<li>Executors might opt to perform sampling to confirm successful dispersal.</li>
<li>Post-dispersal, executors publish the dispersed <code>blob_id</code> and metadata to the mempool. <!-- TODO: add link to dispersal document--></li>
</ol>
<h3 id="replication"><a class="header" href="#replication">Replication</a></h3>
<p>DA nodes receive columns from dispersal or replication
and validate the data encoding.
Upon successful validation,
they replicate the validated column to connected peers within their subnetwork.
Replication occurs once per blob; subsequent validations of the same blob are discarded.</p>
<h3 id="sampling"><a class="header" href="#sampling">Sampling</a></h3>
<ol>
<li>Sampling is <a href="https://www.notion.so/1538f96fb65c8031a44cf7305d271779?pvs=25#15e8f96fb65c8006b9d7f12ffdd9a159">invoked based on the node's current role</a>.</li>
<li>The node selects <code>sample_size</code> random subnetworks
and queries each for the availability of the corresponding column for the sampled blob. Sampling is deemed successful only if all queried subnetworks respond affirmatively.</li>
</ol>
<ul>
<li>If <code>num_subnets</code> is 2048, <code>sample_size</code> is <a href="https://www.notion.so/1708f96fb65c80a08c97d728cb8476c3?pvs=25#1708f96fb65c80bab6f9c6a946940078">20 as per the sampling research</a></li>
</ul>
<pre><code class="language-mermaid">sequenceDiagram
    SamplingClient -&gt;&gt; DANode_1: Request
    DANode_1 --&gt;&gt; SamplingClient: Response
    SamplingClient -&gt;&gt;DANode_2: Request
    DANode_2 --&gt;&gt; SamplingClient: Response
    SamplingClient -&gt;&gt; DANode_n: Request
    DANode_n --&gt;&gt; SamplingClient: Response
</code></pre>
<h3 id="network-schematics"><a class="header" href="#network-schematics">Network Schematics</a></h3>
<p>The overall network and protocol interactions is represented by the following diagram</p>
<pre><code class="language-mermaid">flowchart TD
subgraph Replication
    subgraph Subnetwork_N
        N10 --&gt;|Replicate| N20
        N20 --&gt;|Replicate| N30
        N30 --&gt;|Replicate| N10
    end
    subgraph ...
    end
    subgraph Subnetwork_0
        N1 --&gt;|Replicate| N2
        N2 --&gt;|Replicate| N3
        N3 --&gt;|Replicate| N1
    end
end
subgraph Sampling
    N9 --&gt;|Sample 0| N2
    N9 --&gt;|Sample S| N20
end
subgraph Dispersal
    Executor --&gt;|Disperse| N1
    Executor --&gt;|Disperse| N10
end
</code></pre>
<h2 id="details-1"><a class="header" href="#details-1">Details</a></h2>
<h3 id="network-specifics"><a class="header" href="#network-specifics">Network specifics</a></h3>
<p>The NomosDA network is engineered for connection efficiency.
Executors manage numerous open connections,
utilizing their resource capabilities.
DA nodes, with their resource constraints,
are designed to maximize connection reuse.</p>
<p>NomosDA uses <a href="https://docs.libp2p.io/concepts/transports/quic/#quic-native-multiplexing">multiplexed</a> streams over <a href="https://docs.libp2p.io/concepts/transports/quic/">QUIC</a> connections.
For each sub-protocol, a stream protocol ID is defined to negotiate the protocol,
triggering the specific protocol once established:</p>
<ul>
<li>Dispersal: /nomos/da/{version}/dispersal</li>
<li>Replication: /nomos/da/{version}/replication</li>
<li>Sampling: /nomos/da/{version}/sampling</li>
</ul>
<p>Through these multiplexed streams,
DA nodes can utilize the same connection for all sub-protocols.
This, combined with virtual subnetworks (membership sets),
ensures the overlay node distribution is scalable for networks of any size.</p>
<h2 id="references-38"><a class="header" href="#references-38">References</a></h2>
<ul>
<li><a href="https://www.notion.so/NomosDA-Encoding-Verification-4d8ca269e96d4fdcb05abc70426c5e7c">Encoding Specification</a></li>
<li><a href="https://www.notion.so/NomosDA-Encoding-Verification-4d8ca269e96d4fdcb05abc70426c5e7c">Encoding &amp; Verification Specification</a></li>
<li><a href="https://www.notion.so/NomosDA-Dispersal-1818f96fb65c805ca257cb14798f24d4?pvs=21">NomosDA Dispersal</a></li>
<li><a href="https://www.notion.so/NomosDA-Subnetwork-Replication-1818f96fb65c80119fa0e958a087cc2b?pvs=21">NomosDA Subnetwork Replication</a></li>
<li><a href="https://www.notion.so/DA-Subnetwork-Assignation-217261aa09df80fc8bb9cf46092741ce">DA Subnetwork Assignation</a></li>
<li><a href="https://www.notion.so/NomosDA-Sampling-1538f96fb65c8031a44cf7305d271779?pvs=21">NomosDA Sampling</a></li>
<li><a href="https://www.notion.so/NomosDA-Reconstruction-1828f96fb65c80b2bbb9f4c5a0cf26a5?pvs=21">NomosDA Reconstruction</a></li>
<li><a href="https://www.notion.so/NomosDA-Indexing-1bb8f96fb65c8044b635da9df20c2411?pvs=21">NomosDA Indexing</a></li>
<li><a href="https://www.notion.so/Final-Draft-Validator-Role-Protocol-17b8f96fb65c80c69c2ef55e22e29506">SDP</a></li>
<li><a href="https://www.notion.so/1538f96fb65c8031a44cf7305d271779?pvs=25#15e8f96fb65c8006b9d7f12ffdd9a159">invoked based on the node's current role</a></li>
<li><a href="https://www.notion.so/1708f96fb65c80a08c97d728cb8476c3?pvs=25#1708f96fb65c80bab6f9c6a946940078">20 as per the sampling research</a></li>
<li><a href="https://docs.libp2p.io/concepts/transports/quic/#quic-native-multiplexing">multiplexed</a></li>
<li><a href="https://docs.libp2p.io/concepts/transports/quic/">QUIC</a></li>
</ul>
<h2 id="copyright-47"><a class="header" href="#copyright-47">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="p2p-hardware-requirements"><a class="header" href="#p2p-hardware-requirements">P2P-HARDWARE-REQUIREMENTS</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Nomos p2p Network Hardware Requirements Specification</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>infrastructure</td></tr>
<tr><th>Editor</th><td>Daniel Sanchez-Quiros &lt;danielsq@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-52"><a class="header" href="#timeline-52">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/nomos/raw/p2p-hardware-requirements.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/nomos/raw/p2p-hardware-requirements.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-09-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/34bbd7af90df4baefd6dfeb89c625e846b2db14a/nomos/raw/p2p-hardware-requirements.md"><code>34bbd7a</code></a> — Created nomos/raw/hardware-requirements.md file (#172)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-29"><a class="header" href="#abstract-29">Abstract</a></h2>
<p>This specification defines the hardware requirements for running various types of Nomos blockchain nodes. Hardware needs vary significantly based on the node's role, from lightweight verification nodes to high-performance Zone Executors. The requirements are designed to support diverse participation levels while ensuring network security and performance.</p>
<h2 id="motivation-21"><a class="header" href="#motivation-21">Motivation</a></h2>
<p>The Nomos network is designed to be inclusive and accessible across a wide range of hardware configurations. By defining clear hardware requirements for different node types, we enable:</p>
<ol>
<li><strong>Inclusive Participation</strong>: Allow users with limited resources to participate as Light Nodes</li>
<li><strong>Scalable Infrastructure</strong>: Support varying levels of network participation based on available resources</li>
<li><strong>Performance Optimization</strong>: Ensure adequate resources for computationally intensive operations</li>
<li><strong>Network Security</strong>: Maintain network integrity through properly resourced validator nodes</li>
<li><strong>Service Quality</strong>: Define requirements for optional services that enhance network functionality</li>
</ol>
<p><strong>Important Notice</strong>: These hardware requirements are preliminary and subject to revision based on implementation testing and real-world network performance data.</p>
<h2 id="specification-7"><a class="header" href="#specification-7">Specification</a></h2>
<h3 id="node-types-overview"><a class="header" href="#node-types-overview">Node Types Overview</a></h3>
<p>Hardware requirements vary based on the node's role and services:</p>
<ul>
<li><strong>Light Node</strong>: Minimal verification with minimal resources</li>
<li><strong>Basic Bedrock Node</strong>: Standard validation participation</li>
<li><strong>Service Nodes</strong>: Enhanced capabilities for optional network services</li>
</ul>
<h3 id="light-node-2"><a class="header" href="#light-node-2">Light Node</a></h3>
<p>Light Nodes provide network verification with minimal resource requirements, suitable for resource-constrained environments.</p>
<p><strong>Target Use Cases:</strong></p>
<ul>
<li>Mobile devices and smartphones</li>
<li>Single-board computers (Raspberry Pi, etc.)</li>
<li>IoT devices with network connectivity</li>
<li>Users with limited hardware resources</li>
</ul>
<p><strong>Hardware Requirements:</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Component</th><th>Specification</th></tr></thead><tbody>
<tr><td><strong>CPU</strong></td><td>Low-power processor (smartphone/SBC capable)</td></tr>
<tr><td><strong>Memory (RAM)</strong></td><td>512 MB</td></tr>
<tr><td><strong>Storage</strong></td><td>Minimal (few GB)</td></tr>
<tr><td><strong>Network</strong></td><td>Reliable connection, 1 Mbps free bandwidth</td></tr>
</tbody></table>
</div>
<h3 id="basic-bedrock-node-validator"><a class="header" href="#basic-bedrock-node-validator">Basic Bedrock Node (Validator)</a></h3>
<p>Basic validators participate in Bedrock consensus using typical consumer hardware.</p>
<p><strong>Target Use Cases:</strong></p>
<ul>
<li>Individual validators on consumer hardware</li>
<li>Small-scale validation operations</li>
<li>Entry-level network participation</li>
</ul>
<p><strong>Hardware Requirements:</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Component</th><th>Specification</th></tr></thead><tbody>
<tr><td><strong>CPU</strong></td><td>2 cores, 2 GHz modern multi-core processor</td></tr>
<tr><td><strong>Memory (RAM)</strong></td><td>1 GB minimum</td></tr>
<tr><td><strong>Storage</strong></td><td>SSD with 100+ GB free space, expandable</td></tr>
<tr><td><strong>Network</strong></td><td>Reliable connection, 1 Mbps free bandwidth</td></tr>
</tbody></table>
</div>
<h3 id="service-specific-requirements"><a class="header" href="#service-specific-requirements">Service-Specific Requirements</a></h3>
<p>Nodes can optionally run additional Bedrock Services that require enhanced resources beyond basic validation.</p>
<h4 id="data-availability-da-service"><a class="header" href="#data-availability-da-service">Data Availability (DA) Service</a></h4>
<p>DA Service nodes store and serve data shares for the network's data availability layer.</p>
<p><strong>Service Role:</strong></p>
<ul>
<li>Store blockchain data and blob data long-term</li>
<li>Serve data shares to requesting nodes</li>
<li>Maintain high availability for data retrieval</li>
</ul>
<p><strong>Additional Requirements:</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Component</th><th>Specification</th><th>Rationale</th></tr></thead><tbody>
<tr><td><strong>CPU</strong></td><td>Same as Basic Bedrock Node</td><td>Standard processing needs</td></tr>
<tr><td><strong>Memory (RAM)</strong></td><td>Same as Basic Bedrock Node</td><td>Standard memory needs</td></tr>
<tr><td><strong>Storage</strong></td><td><strong>Fast SSD, 500+ GB free</strong></td><td>Long-term chain and blob storage</td></tr>
<tr><td><strong>Network</strong></td><td><strong>High bandwidth (10+ Mbps)</strong></td><td>Concurrent data serving</td></tr>
<tr><td><strong>Connectivity</strong></td><td><strong>Stable, accessible external IP</strong></td><td>Direct peer connections</td></tr>
</tbody></table>
</div>
<p><strong>Network Requirements:</strong></p>
<ul>
<li>Capacity to handle multiple concurrent connections</li>
<li>Stable external IP address for direct peer access</li>
<li>Low latency for efficient data serving</li>
</ul>
<h4 id="blend-protocol-service"><a class="header" href="#blend-protocol-service">Blend Protocol Service</a></h4>
<p>Blend Protocol nodes provide anonymous message routing capabilities.</p>
<p><strong>Service Role:</strong></p>
<ul>
<li>Route messages anonymously through the network</li>
<li>Provide timing obfuscation for privacy</li>
<li>Maintain multiple concurrent connections</li>
</ul>
<p><strong>Additional Requirements:</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Component</th><th>Specification</th><th>Rationale</th></tr></thead><tbody>
<tr><td><strong>CPU</strong></td><td>Same as Basic Bedrock Node</td><td>Standard processing needs</td></tr>
<tr><td><strong>Memory (RAM)</strong></td><td>Same as Basic Bedrock Node</td><td>Standard memory needs</td></tr>
<tr><td><strong>Storage</strong></td><td>Same as Basic Bedrock Node</td><td>Standard storage needs</td></tr>
<tr><td><strong>Network</strong></td><td><strong>Stable connection (10+ Mbps)</strong></td><td>Multiple concurrent connections</td></tr>
<tr><td><strong>Connectivity</strong></td><td><strong>Stable, accessible external IP</strong></td><td>Direct peer connections</td></tr>
</tbody></table>
</div>
<p><strong>Network Requirements:</strong></p>
<ul>
<li>Low-latency connection for effective message blending</li>
<li>Stable connection for timing obfuscation</li>
<li>Capability to handle multiple simultaneous connections</li>
</ul>
<h4 id="executor-network-service"><a class="header" href="#executor-network-service">Executor Network Service</a></h4>
<p>Zone Executors perform the most computationally intensive work in the network.</p>
<p><strong>Service Role:</strong></p>
<ul>
<li>Execute Zone state transitions</li>
<li>Generate zero-knowledge proofs</li>
<li>Process complex computational workloads</li>
</ul>
<p><strong>Critical Performance Note</strong>: Zone Executors perform the heaviest computational work in the network. High-performance hardware is crucial for effective participation and may provide competitive advantages in execution markets.</p>
<p><strong>Hardware Requirements:</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Component</th><th>Specification</th><th>Rationale</th></tr></thead><tbody>
<tr><td><strong>CPU</strong></td><td><strong>Very high-performance multi-core processor</strong></td><td>Zone logic execution and ZK proving</td></tr>
<tr><td><strong>Memory (RAM)</strong></td><td><strong>32+ GB strongly recommended</strong></td><td>Complex Zone execution requirements</td></tr>
<tr><td><strong>Storage</strong></td><td>Same as Basic Bedrock Node</td><td>Standard storage needs</td></tr>
<tr><td><strong>GPU</strong></td><td><strong>Highly recommended/often necessary</strong></td><td>Efficient ZK proof generation</td></tr>
<tr><td><strong>Network</strong></td><td><strong>High bandwidth (10+ Mbps)</strong></td><td>Data dispersal and high connection load</td></tr>
</tbody></table>
</div>
<p><strong>GPU Requirements:</strong></p>
<ul>
<li><strong>NVIDIA</strong>: CUDA-enabled GPU (RTX 3090 or equivalent recommended)</li>
<li><strong>Apple</strong>: Metal-compatible Apple Silicon</li>
<li><strong>Performance Impact</strong>: Strong GPU significantly reduces proving time</li>
</ul>
<p><strong>Network Requirements:</strong></p>
<ul>
<li>Support for <strong>2048+ direct UDP connections</strong> to DA Nodes (for blob publishing)</li>
<li>High bandwidth for data dispersal operations</li>
<li>Stable connection for continuous operation</li>
</ul>
<p><em>Note: DA Nodes utilizing <a href="https://docs.libp2p.io/">libp2p</a> connections need sufficient capacity to receive and serve data shares over many connections.</em></p>
<h2 id="implementation-requirements"><a class="header" href="#implementation-requirements">Implementation Requirements</a></h2>
<h3 id="minimum-requirements"><a class="header" href="#minimum-requirements">Minimum Requirements</a></h3>
<p>All Nomos nodes MUST meet:</p>
<ol>
<li><strong>Basic connectivity</strong> to the Nomos network via <a href="https://docs.libp2p.io/">libp2p</a></li>
<li><strong>Adequate storage</strong> for their designated role</li>
<li><strong>Sufficient processing power</strong> for their service level</li>
<li><strong>Reliable network connection</strong> with appropriate bandwidth for <a href="https://docs.libp2p.io/concepts/transports/quic/">QUIC</a> transport</li>
</ol>
<h3 id="optional-enhancements"><a class="header" href="#optional-enhancements">Optional Enhancements</a></h3>
<p>Node operators MAY implement:</p>
<ul>
<li>Hardware redundancy for critical services</li>
<li>Enhanced cooling for high-performance configurations</li>
<li>Dedicated network connections for service nodes utilizing <a href="https://docs.libp2p.io/">libp2p</a> protocols</li>
<li>Backup power systems for continuous operation</li>
</ul>
<h3 id="resource-scaling"><a class="header" href="#resource-scaling">Resource Scaling</a></h3>
<p>Requirements may vary based on:</p>
<ul>
<li><strong>Network Load</strong>: Higher network activity increases resource demands</li>
<li><strong>Zone Complexity</strong>: More complex Zones require additional computational resources</li>
<li><strong>Service Combinations</strong>: Running multiple services simultaneously increases requirements</li>
<li><strong>Geographic Location</strong>: Network latency affects optimal performance requirements</li>
</ul>
<h2 id="security-considerations-12"><a class="header" href="#security-considerations-12">Security Considerations</a></h2>
<h3 id="hardware-security"><a class="header" href="#hardware-security">Hardware Security</a></h3>
<ol>
<li><strong>Secure Storage</strong>: Use encrypted storage for sensitive node data</li>
<li><strong>Network Security</strong>: Implement proper firewall configurations</li>
<li><strong>Physical Security</strong>: Secure physical access to node hardware</li>
<li><strong>Backup Strategies</strong>: Maintain secure backups of critical data</li>
</ol>
<h3 id="performance-security"><a class="header" href="#performance-security">Performance Security</a></h3>
<ol>
<li><strong>Resource Monitoring</strong>: Monitor resource usage to detect anomalies</li>
<li><strong>Redundancy</strong>: Plan for hardware failures in critical services</li>
<li><strong>Isolation</strong>: Consider containerization or virtualization for service isolation</li>
<li><strong>Update Management</strong>: Maintain secure update procedures for hardware drivers</li>
</ol>
<h2 id="performance-characteristics"><a class="header" href="#performance-characteristics">Performance Characteristics</a></h2>
<h3 id="scalability"><a class="header" href="#scalability">Scalability</a></h3>
<ul>
<li><strong>Light Nodes</strong>: Minimal resource footprint, high scalability</li>
<li><strong>Validators</strong>: Moderate resource usage, network-dependent scaling</li>
<li><strong>Service Nodes</strong>: High resource usage, specialized scaling requirements</li>
</ul>
<h3 id="resource-efficiency"><a class="header" href="#resource-efficiency">Resource Efficiency</a></h3>
<ul>
<li><strong>CPU Usage</strong>: Optimized algorithms for different hardware tiers</li>
<li><strong>Memory Usage</strong>: Efficient data structures for constrained environments</li>
<li><strong>Storage Usage</strong>: Configurable retention policies and compression</li>
<li><strong>Network Usage</strong>: Adaptive bandwidth utilization based on <a href="https://docs.libp2p.io/">libp2p</a> capacity and <a href="https://docs.libp2p.io/concepts/transports/quic/">QUIC</a> connection efficiency</li>
</ul>
<h2 id="references-39"><a class="header" href="#references-39">References</a></h2>
<ol>
<li><a href="https://docs.libp2p.io/">libp2p protocol</a></li>
<li><a href="https://docs.libp2p.io/concepts/transports/quic/">QUIC protocol</a></li>
</ol>
<h2 id="copyright-48"><a class="header" href="#copyright-48">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="p2p-nat-solution"><a class="header" href="#p2p-nat-solution">P2P-NAT-SOLUTION</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Nomos P2P Network NAT Solution Specification</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>networking</td></tr>
<tr><th>Editor</th><td>Antonio Antonino &lt;antonio@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Álvaro Castro-Castilla &lt;alvaro@status.im&gt;<br>Daniel Sanchez-Quiros &lt;danielsq@status.im&gt;<br>Petar Radovic &lt;petar@status.im&gt;<br>Gusto Bacvinka &lt;augustinas@status.im&gt;<br>Youngjoon Lee &lt;youngjoon@status.im&gt;<br>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-53"><a class="header" href="#timeline-53">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/nomos/raw/p2p-nat-solution.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/nomos/raw/p2p-nat-solution.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-09-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/cfb3b78c71ed75f7859299c38704b809f3e33613/nomos/raw/p2p-nat-solution.md"><code>cfb3b78</code></a> — Created nomos/raw/p2p-nat-solution.md draft (#174)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-30"><a class="header" href="#abstract-30">Abstract</a></h2>
<p>This specification defines a comprehensive NAT (Network Address Translation) traversal solution for the Nomos P2P network. The solution enables nodes to automatically determine their NAT status and establish both outbound and inbound connections regardless of network configuration. The strategy combines <a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT</a>, dynamic port mapping protocols, and continuous verification to maximize public reachability while maintaining decentralized operation.</p>
<h2 id="motivation-22"><a class="header" href="#motivation-22">Motivation</a></h2>
<p>Network Address Translation presents a critical challenge for Nomos participants, particularly those operating on consumer hardware without technical expertise. The Nomos network requires a NAT traversal solution that:</p>
<ol>
<li><strong>Automatic Operation</strong>: Works out-of-the-box without user configuration</li>
<li><strong>Inclusive Participation</strong>: Enables nodes on consumer hardware to participate effectively</li>
<li><strong>Decentralized Approach</strong>: Leverages the existing Nomos P2P network rather than centralized services</li>
<li><strong>Progressive Fallback</strong>: Escalates through increasingly complex protocols as needed</li>
<li><strong>Dynamic Adaptation</strong>: Handles changing network environments and configurations</li>
</ol>
<p>The solution must ensure that nodes can both establish outbound connections and accept inbound connections from other peers, maintaining network connectivity across diverse NAT configurations.</p>
<h2 id="specification-8"><a class="header" href="#specification-8">Specification</a></h2>
<h3 id="terminology-4"><a class="header" href="#terminology-4">Terminology</a></h3>
<ul>
<li><strong>Public Node</strong>: A node that is publicly reachable via a public IP address or valid port mapping</li>
<li><strong>Private Node</strong>: A node that is not publicly reachable due to NAT/firewall restrictions</li>
<li><strong>Dialing</strong>: The process of establishing a connection using the <a href="https://docs.libp2p.io/">libp2p protocol</a> stack</li>
<li><strong>NAT Status</strong>: Whether a node is publicly reachable or hidden behind NAT</li>
</ul>
<h3 id="key-design-principles"><a class="header" href="#key-design-principles">Key Design Principles</a></h3>
<h4 id="optional-configuration"><a class="header" href="#optional-configuration">Optional Configuration</a></h4>
<p>The NAT traversal strategy must work out-of-the-box whenever possible. Users who do not want to engage in configuration should only need to install the node software package. However, users requiring full control must be able to configure every aspect of the strategy.</p>
<h4 id="decentralized-operation"><a class="header" href="#decentralized-operation">Decentralized Operation</a></h4>
<p>The solution leverages the existing Nomos P2P network for coordination rather than relying on centralized third-party services. This maintains the decentralized nature of the network while providing necessary NAT traversal capabilities.</p>
<h4 id="progressive-fallback"><a class="header" href="#progressive-fallback">Progressive Fallback</a></h4>
<p>The protocol begins with lightweight checks and escalates through more complex and resource-intensive protocols. Failure at any step moves the protocol to the next stage in the strategy, ensuring maximum compatibility across network configurations.</p>
<h4 id="dynamic-network-environment"><a class="header" href="#dynamic-network-environment">Dynamic Network Environment</a></h4>
<p>Unless explicitly configured for static addresses, each node's public or private status is assumed to be dynamic. A once publicly-reachable node can become unreachable and vice versa, requiring continuous monitoring and adaptation.</p>
<h3 id="node-discovery-considerations"><a class="header" href="#node-discovery-considerations">Node Discovery Considerations</a></h3>
<p>The Nomos public network encourages participation from a large number of nodes, many deployed through simple installation procedures. Some nodes will not achieve Public status, but the discovery protocol must track these peers and allow other nodes to discover them. This prevents network partitioning and ensures Private nodes remain accessible to other participants.</p>
<h3 id="nat-traversal-protocol"><a class="header" href="#nat-traversal-protocol">NAT Traversal Protocol</a></h3>
<h4 id="protocol-requirements"><a class="header" href="#protocol-requirements">Protocol Requirements</a></h4>
<p><strong>Each node MUST:</strong></p>
<ul>
<li>Run an <a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT</a> client, except for nodes statically configured as Public</li>
<li>Use the <a href="https://github.com/libp2p/specs/blob/master/identify/README.md">Identify protocol</a> to advertise support for:
<ul>
<li><code>/nomos/autonat/2/dial-request</code> for main network</li>
<li><code>/nomos-testnet/autonat/2/dial-request</code> for public testnet</li>
<li><code>/nomos/autonat/2/dial-back</code> and <code>/nomos-testnet/autonat/2/dial-back</code> respectively</li>
</ul>
</li>
</ul>
<h4 id="nat-state-machine"><a class="header" href="#nat-state-machine">NAT State Machine</a></h4>
<p>The NAT traversal process follows a multi-phase state machine:</p>
<pre><code class="language-mermaid">graph TD
  Start@{shape: circle, label: "Start"} --&gt;|Preconfigured public IP or port mapping| StaticPublic[Statically configured as&lt;br/&gt;**Public**]
  subgraph Phase0 [Phase 0]
  Start --&gt;|Default configuration| Boot
  end
  subgraph Phase1 [Phase 1]
  Boot[Bootstrap and discover AutoNAT servers]--&gt; Inspect
  Inspect[Inspect own IP addresses]--&gt;|At least 1 IP address in the public range| ConfirmPublic[AutoNAT]
  end
  subgraph Phase2 [Phase 2]
  Inspect --&gt;|No IP addresses in the public range| MapPorts[Port Mapping Client&lt;br/&gt;UPnP/NAT-PMP/PCP]
  MapPorts --&gt;|Successful port map| ConfirmMapPorts[AutoNAT]
  end
  ConfirmPublic --&gt;|Node's IP address reachable by AutoNAT server| Public[**Public** Node]
  ConfirmPublic --&gt;|Node's IP address not reachable by AutoNAT server or Timeout| MapPorts
  ConfirmMapPorts --&gt;|Mapped IP address and port reachable by AutoNAT server| Public
  ConfirmMapPorts --&gt;|Mapped IP address and port not reachable by AutoNAT server or Timeout| Private
  MapPorts --&gt;|Failure or Timeout| Private[**Private** Node]
  subgraph Phase3 [Phase 3]
  Public --&gt;Monitor
  Private --&gt; Monitor
  end
  Monitor[Network Monitoring] --&gt;|Restart| Inspect
</code></pre>
<h3 id="phase-implementation"><a class="header" href="#phase-implementation">Phase Implementation</a></h3>
<h4 id="phase-0-bootstrapping-and-identifying-public-nodes"><a class="header" href="#phase-0-bootstrapping-and-identifying-public-nodes">Phase 0: Bootstrapping and Identifying Public Nodes</a></h4>
<p>If the node is statically configured by the operator to be Public, the procedure stops here.</p>
<p>The node utilizes bootstrapping and discovery mechanisms to find other Public nodes. The <a href="https://github.com/libp2p/specs/blob/master/identify/README.md">Identify protocol</a> confirms which detected Public nodes support <a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT v2</a>.</p>
<h4 id="phase-1-nat-detection"><a class="header" href="#phase-1-nat-detection">Phase 1: NAT Detection</a></h4>
<p>The node starts an <a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT</a> client and inspects its own addresses. For each public IP address, the node verifies public reachability via <a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT</a>. If any public IP addresses are confirmed, the node assumes Public status and moves to Phase 3. Otherwise, it continues to Phase 2.</p>
<h4 id="phase-2-automated-port-mapping"><a class="header" href="#phase-2-automated-port-mapping">Phase 2: Automated Port Mapping</a></h4>
<p>The node attempts to secure port mapping on the default gateway using:</p>
<ul>
<li><strong><a href="https://datatracker.ietf.org/doc/html/rfc6887">PCP</a></strong> (Port Control Protocol) - Most reliable</li>
<li><strong><a href="https://datatracker.ietf.org/doc/html/rfc6886">NAT-PMP</a></strong> (NAT Port Mapping Protocol) - Second most reliable</li>
<li><strong><a href="https://datatracker.ietf.org/doc/html/rfc6970">UPnP-IGD</a></strong> (Universal Plug and Play Internet Gateway Device) - Most widely deployed</li>
</ul>
<p><strong>Port Mapping Algorithm:</strong></p>
<pre><code class="language-python">def try_port_mapping():
    # Step 1: Get the local IPv4 address
    local_ip = get_local_ipv4_address()
    
    # Step 2: Get the default gateway IPv4 address
    gateway_ip = get_default_gateway_address()
    
    # Step 3: Abort if local or gateway IP could not be determined
    if not local_ip or not gateway_ip:
        return "Mapping failed: Unable to get local or gateway IPv4"

    # Step 4: Probe the gateway for protocol support
    supports_pcp = probe_pcp(gateway_ip)
    supports_nat_pmp = probe_nat_pmp(gateway_ip)
    supports_upnp = probe_upnp(gateway_ip)  # Optional for logging

    # Step 5-9: Try protocols in order of reliability
    # PCP (most reliable) -&gt; NAT-PMP -&gt; UPnP -&gt; fallback attempts
    
    protocols = [
        (supports_pcp, try_pcp_mapping),
        (supports_nat_pmp, try_nat_pmp_mapping),
        (True, try_upnp_mapping),  # Always try UPnP
        (not supports_pcp, try_pcp_mapping),  # Fallback
        (not supports_nat_pmp, try_nat_pmp_mapping)  # Last resort
    ]
    
    for supported, mapping_func in protocols:
        if supported:
            mapping = mapping_func(local_ip, gateway_ip)
            if mapping:
                return mapping
    
    return "Mapping failed: No protocol succeeded"
</code></pre>
<p>If mapping succeeds, the node uses <a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT</a> to confirm public reachability. Upon confirmation, the node assumes Public status. Otherwise, it assumes Private status.</p>
<p><strong>Port Mapping Sequence:</strong></p>
<pre><code class="language-mermaid">sequenceDiagram
    box Node
        participant AutoNAT Client
        participant NAT State Machine
        participant Port Mapping Client
    end
    participant Router
    
    alt Mapping is successful
        Note left of AutoNAT Client: Phase 2
        Port Mapping Client -&gt;&gt; +Router: Requests new mapping
        Router -&gt;&gt; Port Mapping Client: Confirms new mapping
        Port Mapping Client -&gt;&gt; NAT State Machine: Mapping secured
        NAT State Machine -&gt;&gt; AutoNAT Client: Requests confirmation&lt;br/&gt;that mapped address&lt;br/&gt;is publicly reachable
        
        alt Node asserts Public status
            AutoNAT Client -&gt;&gt; NAT State Machine: Mapped address&lt;br/&gt;is publicly reachable
            Note left of AutoNAT Client: Phase 3&lt;br/&gt;Network Monitoring
        else Node asserts Private status
            AutoNAT Client -&gt;&gt; NAT State Machine: Mapped address&lt;br/&gt;is not publicly reachable
            Note left of AutoNAT Client: Phase 3&lt;br/&gt;Network Monitoring
        end
    else Mapping fails, node asserts Private status
        Note left of AutoNAT Client: Phase 2
        Port Mapping Client -&gt;&gt; Router: Requests new mapping
        Router -&gt;&gt; Port Mapping Client: Refuses new mapping or Timeout
        Port Mapping Client -&gt;&gt; NAT State Machine: Mapping failed
        Note left of AutoNAT Client: Phase 3&lt;br/&gt;Network Monitoring
    end
</code></pre>
<h4 id="phase-3-network-monitoring"><a class="header" href="#phase-3-network-monitoring">Phase 3: Network Monitoring</a></h4>
<p>Unless explicitly configured, nodes must monitor their network status and restart from Phase 1 when changes are detected.</p>
<p><strong>Public Node Monitoring:</strong></p>
<p>A Public node must restart when:</p>
<ul>
<li><a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT</a> client no longer confirms public reachability</li>
<li>A previously successful port mapping is lost or refresh fails</li>
</ul>
<p><strong>Private Node Monitoring:</strong></p>
<p>A Private node must restart when:</p>
<ul>
<li>It gains a new public IP address</li>
<li>Port mapping is likely to succeed (gateway change, sufficient time passed)</li>
</ul>
<p><strong>Network Monitoring Sequence:</strong></p>
<pre><code class="language-mermaid">sequenceDiagram
    participant AutoNAT Server
    box Node
        participant AutoNAT Client
        participant NAT State Machine
        participant Port Mapping Client
    end
    participant Router

    Note left of AutoNAT Server: Phase 3&lt;br/&gt;Network Monitoring
    par Refresh mapping and monitor changes
        loop periodically refreshes mapping
            Port Mapping Client -&gt;&gt; Router: Requests refresh
            Router -&gt;&gt; Port Mapping Client: Confirms mapping refresh
        end
        break Mapping is lost, the node loses Public status
            Router -&gt;&gt; Port Mapping Client: Refresh failed or mapping dropped
            Port Mapping Client -&gt;&gt; NAT State Machine: Mapping lost
            NAT State Machine -&gt;&gt; NAT State Machine: Restart
        end
    and Monitor public reachability of mapped addresses
        loop periodically checks public reachability
            AutoNAT Client -&gt;&gt; AutoNAT Server: Requests dialback
            AutoNAT Server -&gt;&gt; AutoNAT Client: Dialback successful
        end
        break
            AutoNAT Server -&gt;&gt; AutoNAT Client: Dialback failed or Timeout
            AutoNAT Client -&gt;&gt; NAT State Machine: Public reachability lost
            NAT State Machine -&gt;&gt; NAT State Machine: Restart
        end
    end
    Note left of AutoNAT Server: Phase 1
</code></pre>
<h3 id="public-node-responsibilities"><a class="header" href="#public-node-responsibilities">Public Node Responsibilities</a></h3>
<p><strong>A Public node MUST:</strong></p>
<ul>
<li>
<p>Run an <a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT</a> server</p>
</li>
<li>
<p>Listen on and advertise via <a href="https://github.com/libp2p/specs/blob/master/identify/README.md">Identify protocol</a> its publicly reachable <a href="https://github.com/libp2p/specs/blob/master/addressing/README.md">multiaddresses</a>:</p>
<p><code>/{public_peer_ip}/udp/{port}/quic-v1/p2p/{public_peer_id}</code></p>
</li>
<li>
<p>Periodically renew port mappings according to protocol recommendations</p>
</li>
<li>
<p>Maintain high availability for <a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT</a> services</p>
</li>
</ul>
<h3 id="peer-dialing"><a class="header" href="#peer-dialing">Peer Dialing</a></h3>
<p>Other peers can always dial a Public peer using its publicly reachable <a href="https://github.com/libp2p/specs/blob/master/addressing/README.md">multiaddresses</a>:</p>
<p><code>/{public_peer_ip}/udp/{port}/quic-v1/p2p/{public_peer_id}</code></p>
<h2 id="implementation-requirements-1"><a class="header" href="#implementation-requirements-1">Implementation Requirements</a></h2>
<h3 id="mandatory-components"><a class="header" href="#mandatory-components">Mandatory Components</a></h3>
<p>All Nomos nodes MUST implement:</p>
<ol>
<li><strong><a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT</a> client</strong> for NAT status detection</li>
<li><strong>Port mapping clients</strong> for <a href="https://datatracker.ietf.org/doc/html/rfc6887">PCP</a>, <a href="https://datatracker.ietf.org/doc/html/rfc6886">NAT-PMP</a>, and <a href="https://datatracker.ietf.org/doc/html/rfc6970">UPnP-IGD</a></li>
<li><strong><a href="https://github.com/libp2p/specs/blob/master/identify/README.md">Identify protocol</a></strong> for capability advertisement</li>
<li><strong>Network monitoring</strong> for status change detection</li>
</ol>
<h3 id="optional-enhancements-1"><a class="header" href="#optional-enhancements-1">Optional Enhancements</a></h3>
<p>Nodes MAY implement:</p>
<ul>
<li>Custom port mapping retry strategies</li>
<li>Enhanced network change detection</li>
<li>Advanced <a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT</a> server load balancing</li>
<li>Backup connectivity mechanisms</li>
</ul>
<h3 id="configuration-parameters"><a class="header" href="#configuration-parameters">Configuration Parameters</a></h3>
<h4 id="autonat-configuration"><a class="header" href="#autonat-configuration"><a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT</a> Configuration</a></h4>
<pre><code class="language-yaml">autonat:
  client:
    dial_timeout: 15s
    max_peer_addresses: 16
    throttle_global_limit: 30
    throttle_peer_limit: 3
  server:
    dial_timeout: 30s
    max_peer_addresses: 16
    throttle_global_limit: 30
    throttle_peer_limit: 3
</code></pre>
<h4 id="port-mapping-configuration"><a class="header" href="#port-mapping-configuration">Port Mapping Configuration</a></h4>
<pre><code class="language-yaml">port_mapping:
  pcp:
    timeout: 30s
    lifetime: 7200s  # 2 hours
    retry_interval: 300s
  nat_pmp:
    timeout: 30s
    lifetime: 7200s
    retry_interval: 300s
  upnp:
    timeout: 30s
    lease_duration: 7200s
    retry_interval: 300s
</code></pre>
<h2 id="security-considerations-13"><a class="header" href="#security-considerations-13">Security Considerations</a></h2>
<h3 id="nat-traversal-security"><a class="header" href="#nat-traversal-security">NAT Traversal Security</a></h3>
<ol>
<li><strong>Port Mapping Validation</strong>: Verify that requested port mappings are actually created</li>
<li><strong><a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT</a> Server Trust</strong>: Implement peer reputation for <a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT</a> servers</li>
<li><strong>Gateway Communication</strong>: Secure communication with NAT devices</li>
<li><strong>Address Validation</strong>: Validate public addresses before advertisement</li>
</ol>
<h3 id="privacy-considerations-2"><a class="header" href="#privacy-considerations-2">Privacy Considerations</a></h3>
<ol>
<li><strong>IP Address Exposure</strong>: Public nodes necessarily expose IP addresses</li>
<li><strong>Traffic Analysis</strong>: Monitor for patterns that could reveal node behavior</li>
<li><strong>Gateway Information</strong>: Minimize exposure of internal network topology</li>
</ol>
<h3 id="denial-of-service-protection"><a class="header" href="#denial-of-service-protection">Denial of Service Protection</a></h3>
<ol>
<li><strong><a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT</a> Rate Limiting</strong>: Implement request throttling for <a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT</a> services</li>
<li><strong>Port Mapping Abuse</strong>: Prevent excessive port mapping requests</li>
<li><strong>Resource Exhaustion</strong>: Limit concurrent NAT traversal attempts</li>
</ol>
<h2 id="performance-characteristics-1"><a class="header" href="#performance-characteristics-1">Performance Characteristics</a></h2>
<h3 id="scalability-1"><a class="header" href="#scalability-1">Scalability</a></h3>
<ul>
<li><strong><a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT</a> Server Load</strong>: Distributed across Public nodes</li>
<li><strong>Port Mapping Overhead</strong>: Minimal ongoing resource usage</li>
<li><strong>Network Monitoring</strong>: Efficient periodic checks</li>
</ul>
<h3 id="reliability"><a class="header" href="#reliability">Reliability</a></h3>
<ul>
<li><strong>Fallback Mechanisms</strong>: Multiple protocols ensure high success rates</li>
<li><strong>Continuous Monitoring</strong>: Automatic recovery from connectivity loss</li>
<li><strong>Protocol Redundancy</strong>: Multiple port mapping protocols increase reliability</li>
</ul>
<h2 id="references-40"><a class="header" href="#references-40">References</a></h2>
<ol>
<li><a href="https://github.com/libp2p/specs/blob/master/addressing/README.md">Multiaddress spec</a></li>
<li><a href="https://github.com/libp2p/specs/blob/master/identify/README.md">Identify protocol spec</a></li>
<li><a href="https://github.com/libp2p/specs/blob/master/autonat/autonat-v2.md">AutoNAT v2 protocol spec</a></li>
<li><a href="https://github.com/libp2p/specs/blob/master/relay/circuit-v2.md">Circuit Relay v2 protocol spec</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc6887">PCP - RFC 6887</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc6886">NAT-PMP - RFC 6886</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc6970">UPnP IGD - RFC 6970</a></li>
</ol>
<h2 id="copyright-49"><a class="header" href="#copyright-49">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="p2p-network-bootstrapping"><a class="header" href="#p2p-network-bootstrapping">P2P-NETWORK-BOOTSTRAPPING</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Nomos P2P Network Bootstrapping Specification</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>networking</td></tr>
<tr><th>Editor</th><td>Daniel Sanchez-Quiros &lt;danielsq@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Álvaro Castro-Castilla &lt;alvaro@status.im&gt;<br>Petar Radovic &lt;petar@status.im&gt;<br>Gusto Bacvinka &lt;augustinas@status.im&gt;<br>Antonio Antonino &lt;antonio@status.im&gt;<br>Youngjoon Lee &lt;youngjoon@status.im&gt;<br>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-54"><a class="header" href="#timeline-54">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/nomos/raw/p2p-network-bootstrapping.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/nomos/raw/p2p-network-bootstrapping.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-09-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/aa8a3b0c65470b97f5aeee85a8444c7d22dcafc8/nomos/raw/p2p-network-bootstrapping.md"><code>aa8a3b0</code></a> — Created nomos/raw/p2p-network-bootstrapping.md draft (#175)</li>
</ul>
<!-- timeline:end -->
<h2 id="introduction-7"><a class="header" href="#introduction-7">Introduction</a></h2>
<p>Nomos network bootstrapping is the process by which a new node discovers peers and synchronizes with the existing decentralized network. It ensures that a node can:</p>
<ol>
<li><strong>Discover Peers</strong> – Find other active nodes in the network.</li>
<li><strong>Establish Connections</strong> – Securely connect to trusted peers.</li>
<li><strong>Negotiate (libp2p) Protocols</strong> - Ensure that other peers operate in the same protocols as the node needs.</li>
</ol>
<h2 id="overview-5"><a class="header" href="#overview-5">Overview</a></h2>
<p>The Nomos P2P network bootstrapping strategy relies on a designated subset of <strong>bootstrap nodes</strong> to facilitate secure and efficient node onboarding. These nodes serve as the initial entry points for new network participants.</p>
<h3 id="key-design-principles-1"><a class="header" href="#key-design-principles-1">Key Design Principles</a></h3>
<h4 id="trusted-bootstrap-nodes"><a class="header" href="#trusted-bootstrap-nodes">Trusted Bootstrap Nodes</a></h4>
<p>A curated set of publicly announced and highly available nodes ensures reliability during initial peer discovery. These nodes are configured with elevated connection limits to handle a high volume of incoming bootstrapping requests from new participants.</p>
<h4 id="node-configuration--onboarding"><a class="header" href="#node-configuration--onboarding">Node Configuration &amp; Onboarding</a></h4>
<p>New node operators must explicitly configure their instances with the addresses of bootstrap nodes. This configuration may be preloaded or dynamically fetched from a trusted source to minimize manual setup.</p>
<h4 id="network-integration"><a class="header" href="#network-integration">Network Integration</a></h4>
<p>Upon initialization, the node establishes connections with the bootstrap nodes and begins participating in Nomos networking protocols. Through these connections, the node discovers additional peers, synchronizes with the network state, and engages in protocol-specific communication (e.g., consensus, block propagation).</p>
<h3 id="security--decentralization-considerations"><a class="header" href="#security--decentralization-considerations">Security &amp; Decentralization Considerations</a></h3>
<p><strong>Trust Minimization</strong>: While bootstrap nodes provide initial connectivity, the network rapidly transitions to decentralized peer discovery to prevent over-reliance on any single entity.</p>
<p><strong>Authenticated Announcements</strong>: The identities and addresses of bootstrap nodes are publicly verifiable to mitigate impersonation attacks. From <a href="https://docs.libp2p.io/concepts/transports/quic/#quic-in-libp2p">libp2p documentation</a>:</p>
<blockquote>
<p>To authenticate each others' peer IDs, peers encode their peer ID into a self-signed certificate, which they sign using their host's private key.</p>
</blockquote>
<p><strong>Dynamic Peer Management</strong>: After bootstrapping, nodes continuously refine their peer lists to maintain a resilient and distributed network topology.</p>
<p>This approach ensures <strong>rapid, secure, and scalable</strong> network participation while preserving the decentralized ethos of the Nomos protocol.</p>
<h2 id="protocol"><a class="header" href="#protocol">Protocol</a></h2>
<h3 id="protocol-overview-1"><a class="header" href="#protocol-overview-1">Protocol Overview</a></h3>
<p>The bootstrapping protocol follows libp2p conventions for peer discovery and connection establishment. Implementation details are handled by the underlying libp2p stack with Nomos-specific configuration parameters.</p>
<h3 id="bootstrapping-process"><a class="header" href="#bootstrapping-process">Bootstrapping Process</a></h3>
<h4 id="step-by-step-bootstrapping-process"><a class="header" href="#step-by-step-bootstrapping-process">Step-by-Step bootstrapping process</a></h4>
<ol>
<li>
<p><strong>Node Initial Configuration</strong>: New nodes load pre-configured bootstrap node addresses. Addresses may be <code>IP</code> or <code>DNS</code> embedded in a compatible <a href="https://docs.libp2p.io/concepts/fundamentals/peers/#peer-ids-in-multiaddrs">libp2p PeerId multiaddress</a>. Node operators may chose to advertise more than one address. This is out of the scope of this protocol. For example:</p>
<p><code>/ip4/198.51.100.0/udp/4242/p2p/QmYyQSo1c1Ym7orWxLYvCrM2EmxFTANf8wXmmE7DWjhx5N</code> or</p>
<p><code>/dns/foo.bar.net/udp/4242/p2p/QmYyQSo1c1Ym7orWxLYvCrM2EmxFTANf8wXmmE7DWjhx5N</code></p>
</li>
<li>
<p><strong>Secure Connection</strong>: Nodes establish connections to bootstrap nodes announced addresses. Verifies network identity and protocol compatibility.</p>
</li>
<li>
<p><strong>Peer Discovery</strong>: Requests and receives validated peer lists from bootstrap nodes. Each entry includes connectivity details as per the peer discovery protocol engaging after the initial connection.</p>
</li>
<li>
<p><strong>Network Integration</strong>: Iteratively connects to discovered peers. Gradually build peer connections.</p>
</li>
<li>
<p><strong>Protocol Engagement</strong>: Establishes required protocol channels (gossip/consensus/sync). Begins participating in network operations.</p>
</li>
<li>
<p><strong>Ongoing Maintenance</strong>: Continuously evaluates and refreshes peer connections. Ideally removes the connection to the bootstrap node itself. Bootstrap nodes may chose to remove the connection on their side to keep high availability for other nodes.</p>
</li>
</ol>
<pre><code class="language-mermaid">sequenceDiagram
    participant Nomos Network
    participant Node
    participant Bootstrap Node

    Node-&gt;&gt;Node: Fetches bootstrapping addresses

    loop Interacts with bootstrap node
        Node-&gt;&gt;+Bootstrap Node: Connects
        Bootstrap Node-&gt;&gt;-Node: Sends discovered peers information
    end

    loop Connects to Network participants
        Node-&gt;&gt;Nomos Network: Engages in connections
        Node-&gt;&gt;Nomos Network: Negotiates protocols
    end

    loop Ongoing maintenance
        Node--&gt;&gt;Nomos Network: Evaluates peer connections
        alt Bootstrap connection no longer needed
            Node--&gt;&gt;Bootstrap Node: Disconnects
        else Bootstrap enforces disconnection
            Bootstrap Node--&gt;&gt;Node: Disconnects
        end
    end
</code></pre>
<h2 id="implementation-details"><a class="header" href="#implementation-details">Implementation Details</a></h2>
<p>The bootstrapping process for the Nomos p2p network uses the <strong>QUIC</strong> transport as specified in the Nomos network specification.</p>
<p>Bootstrapping is separated from the network's peer discovery protocol. It assumes that there is one protocol that would engage as soon as the connection with the bootstrapping node triggers. Currently Nomos network uses <code>kademlia</code> as the current first approach for the Nomos p2p network, this comes granted.</p>
<h3 id="bootstrap-node-requirements"><a class="header" href="#bootstrap-node-requirements">Bootstrap Node Requirements</a></h3>
<p>Bootstrap nodes MUST fulfill the following requirements:</p>
<ul>
<li><strong>High Availability</strong>: Maintain uptime of 99.5% or higher</li>
<li><strong>Connection Capacity</strong>: Support minimum 1000 concurrent connections</li>
<li><strong>Geographic Distribution</strong>: Deploy across multiple regions</li>
<li><strong>Protocol Compatibility</strong>: Support all required Nomos network protocols</li>
<li><strong>Security</strong>: Implement proper authentication and rate limiting</li>
</ul>
<h3 id="network-configuration"><a class="header" href="#network-configuration">Network Configuration</a></h3>
<p>Bootstrap node addresses are distributed through:</p>
<ul>
<li><strong>Hardcoded addresses</strong> in node software releases</li>
<li><strong>DNS seeds</strong> for dynamic address resolution</li>
<li><strong>Community-maintained lists</strong> with cryptographic verification</li>
</ul>
<h2 id="security-considerations-14"><a class="header" href="#security-considerations-14">Security Considerations</a></h2>
<h3 id="trust-model"><a class="header" href="#trust-model">Trust Model</a></h3>
<p>Bootstrap nodes operate under a <strong>minimal trust model</strong>:</p>
<ul>
<li>Nodes verify peer identities through cryptographic authentication</li>
<li>Bootstrap connections are temporary and replaced by organic peer discovery</li>
<li>No single bootstrap node can control network participation</li>
</ul>
<h3 id="attack-mitigation"><a class="header" href="#attack-mitigation">Attack Mitigation</a></h3>
<p><strong>Sybil Attack Protection</strong>: Bootstrap nodes implement connection limits and peer verification to prevent malicious flooding.</p>
<p><strong>Eclipse Attack Prevention</strong>: Nodes connect to multiple bootstrap nodes and rapidly diversify their peer connections.</p>
<p><strong>Denial of Service Resistance</strong>: Rate limiting and connection throttling protect bootstrap nodes from resource exhaustion attacks.</p>
<h2 id="performance-characteristics-2"><a class="header" href="#performance-characteristics-2">Performance Characteristics</a></h2>
<h3 id="bootstrapping-metrics"><a class="header" href="#bootstrapping-metrics">Bootstrapping Metrics</a></h3>
<ul>
<li><strong>Initial Connection Time</strong>: Target &lt; 30 seconds to first bootstrap node</li>
<li><strong>Peer Discovery Duration</strong>: Discover minimum viable peer set within 2 minutes</li>
<li><strong>Network Integration</strong>: Full protocol engagement within 5 minutes</li>
</ul>
<h3 id="resource-requirements"><a class="header" href="#resource-requirements">Resource Requirements</a></h3>
<h4 id="bootstrap-nodes"><a class="header" href="#bootstrap-nodes">Bootstrap Nodes</a></h4>
<ul>
<li>Memory: Minimum 4GB RAM</li>
<li>Bandwidth: 100 Mbps sustained</li>
<li>Storage: 50GB available space</li>
</ul>
<h4 id="regular-nodes"><a class="header" href="#regular-nodes">Regular Nodes</a></h4>
<ul>
<li>Memory: 512MB for bootstrapping process</li>
<li>Bandwidth: 10 Mbps during initial sync</li>
<li>Storage: Minimal requirements</li>
</ul>
<h2 id="references-41"><a class="header" href="#references-41">References</a></h2>
<ul>
<li>P2P Network Specification (internal document)</li>
<li><a href="https://docs.libp2p.io/concepts/transports/quic/">libp2p QUIC Transport</a></li>
<li><a href="https://docs.libp2p.io/concepts/fundamentals/peers/">libp2p Peer IDs and Addressing</a></li>
<li><a href="https://ethereum.org/en/developers/docs/nodes-and-clients/bootnodes/">Ethereum bootnodes</a></li>
<li><a href="https://developer.bitcoin.org/devguide/p2p_network.html#peer-discovery">Bitcoin peer discovery</a></li>
<li><a href="https://docs.cardano.org/stake-pool-operators/node-connectivity">Cardano nodes connectivity</a></li>
<li><a href="https://www.coincashew.com/coins/overview-ada/guide-how-to-build-a-haskell-stakepool-node/part-v-tips/implementing-peer-sharing">Cardano peer sharing</a></li>
</ul>
<h2 id="copyright-50"><a class="header" href="#copyright-50">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nomos-p2p-network"><a class="header" href="#nomos-p2p-network">NOMOS-P2P-NETWORK</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Nomos P2P Network Specification</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Category</th><td>networking</td></tr>
<tr><th>Editor</th><td>Daniel Sanchez-Quiros &lt;danielsq@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-55"><a class="header" href="#timeline-55">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/nomos/raw/p2p-network.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/nomos/raw/p2p-network.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-09-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/a3a5b91df3e06bb9ad737056ccd2c2f1fd20af3c/nomos/raw/p2p-network.md"><code>a3a5b91</code></a> — Created nomos/raw/p2p-network.md file (#169)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-31"><a class="header" href="#abstract-31">Abstract</a></h2>
<p>This specification defines the peer-to-peer (P2P) network layer for Nomos blockchain nodes. The network serves as the comprehensive communication infrastructure enabling transaction dissemination through mempool and block propagation. The specification leverages established libp2p protocols to ensure robust, scalable performance with low bandwidth requirements and minimal latency while maintaining accessibility for diverse hardware configurations and network environments.</p>
<h2 id="motivation-23"><a class="header" href="#motivation-23">Motivation</a></h2>
<p>The Nomos blockchain requires a reliable, scalable P2P network that can:</p>
<ol>
<li><strong>Support diverse hardware</strong>: From laptops to dedicated servers across various operating systems and geographic locations</li>
<li><strong>Enable inclusive participation</strong>: Allow non-technical users to operate nodes with minimal configuration</li>
<li><strong>Maintain connectivity</strong>: Ensure nodes remain reachable even with limited connectivity or behind NAT/routers</li>
<li><strong>Scale efficiently</strong>: Support large-scale networks (+10k nodes) with eventual consistency</li>
<li><strong>Provide low-latency communication</strong>: Enable efficient transaction and block propagation</li>
</ol>
<h2 id="specification-9"><a class="header" href="#specification-9">Specification</a></h2>
<h3 id="network-architecture-overview"><a class="header" href="#network-architecture-overview">Network Architecture Overview</a></h3>
<p>The Nomos P2P network addresses three critical challenges:</p>
<ul>
<li><strong>Peer Connectivity</strong>: Mechanisms for peers to join and connect to the network</li>
<li><strong>Peer Discovery</strong>: Enabling peers to locate and identify network participants</li>
<li><strong>Message Transmission</strong>: Facilitating efficient message exchange across the network</li>
</ul>
<h3 id="transport-protocol"><a class="header" href="#transport-protocol">Transport Protocol</a></h3>
<h4 id="quic-protocol-transport"><a class="header" href="#quic-protocol-transport">QUIC Protocol Transport</a></h4>
<p>The Nomos network employs <strong><a href="https://docs.libp2p.io/concepts/transports/quic/">QUIC protocol</a></strong> as the primary transport protocol, leveraging the <a href="https://docs.libp2p.io/">libp2p protocol</a> implementation.</p>
<p><strong>Rationale for <a href="https://docs.libp2p.io/concepts/transports/quic/">QUIC protocol</a>:</strong></p>
<ul>
<li>Rapid connection establishment</li>
<li>Enhanced NAT traversal capabilities (UDP-based)</li>
<li>Built-in multiplexing simplifies configuration</li>
<li>Production-tested reliability</li>
</ul>
<h3 id="peer-discovery-1"><a class="header" href="#peer-discovery-1">Peer Discovery</a></h3>
<h4 id="kademlia-dht"><a class="header" href="#kademlia-dht">Kademlia DHT</a></h4>
<p>The network utilizes libp2p's Kademlia Distributed Hash Table (DHT) for peer discovery.</p>
<p><strong>Protocol Identifiers:</strong></p>
<ul>
<li><strong>Mainnet</strong>: <code>/nomos/kad/1.0.0</code></li>
<li><strong>Testnet</strong>: <code>/nomos-testnet/kad/1.0.0</code></li>
</ul>
<p><strong>Features:</strong></p>
<ul>
<li>Proximity-based peer discovery heuristics</li>
<li>Distributed peer routing table</li>
<li>Resilient to network partitions</li>
<li>Automatic peer replacement</li>
</ul>
<h4 id="identify-protocol"><a class="header" href="#identify-protocol">Identify Protocol</a></h4>
<p>Complements Kademlia by enabling peer information exchange.</p>
<p><strong>Protocol Identifiers:</strong></p>
<ul>
<li><strong>Mainnet</strong>: <code>/nomos/identify/1.0.0</code></li>
<li><strong>Testnet</strong>: <code>/nomos-testnet/identify/1.0.0</code></li>
</ul>
<p><strong>Capabilities:</strong></p>
<ul>
<li>Protocol support advertisement</li>
<li>Peer capability negotiation</li>
<li>Network interoperability enhancement</li>
</ul>
<h4 id="future-considerations"><a class="header" href="#future-considerations">Future Considerations</a></h4>
<p>The current Kademlia implementation is acknowledged as interim. Future improvements target:</p>
<ul>
<li>Lightweight design without full DHT overhead</li>
<li>Highly-scalable eventual consistency</li>
<li>Support for 10k+ nodes with minimal resource usage</li>
</ul>
<h3 id="nat-traversal"><a class="header" href="#nat-traversal">NAT Traversal</a></h3>
<p>The network implements comprehensive NAT traversal solutions to ensure connectivity across diverse network configurations.</p>
<p><strong>Objectives:</strong></p>
<ul>
<li>Configuration-free peer connections</li>
<li>Support for users with varying technical expertise</li>
<li>Enable nodes on standard consumer hardware</li>
</ul>
<p><strong>Implementation:</strong></p>
<ul>
<li>Tailored solutions based on user network configuration</li>
<li>Automatic NAT type detection and adaptation</li>
<li>Fallback mechanisms for challenging network environments</li>
</ul>
<p><em>Note: Detailed NAT traversal specifications are maintained in a separate document.</em></p>
<h3 id="message-dissemination"><a class="header" href="#message-dissemination">Message Dissemination</a></h3>
<h4 id="gossipsub-protocol"><a class="header" href="#gossipsub-protocol">Gossipsub Protocol</a></h4>
<p>Nomos employs <strong>gossipsub</strong> for reliable message propagation across the network.</p>
<p><strong>Integration:</strong></p>
<ul>
<li>Seamless integration with Kademlia peer discovery</li>
<li>Automatic peer list updates</li>
<li>Efficient message routing and delivery</li>
</ul>
<h4 id="topic-configuration"><a class="header" href="#topic-configuration">Topic Configuration</a></h4>
<p><strong>Mempool Dissemination:</strong></p>
<ul>
<li><strong>Mainnet</strong>: <code>/nomos/mempool/0.1.0</code></li>
<li><strong>Testnet</strong>: <code>/nomos-testnet/mempool/0.1.0</code></li>
</ul>
<p><strong>Block Propagation:</strong></p>
<ul>
<li><strong>Mainnet</strong>: <code>/nomos/cryptarchia/0.1.0</code></li>
<li><strong>Testnet</strong>: <code>/nomos-testnet/cryptarchia/0.1.0</code></li>
</ul>
<h4 id="network-parameters"><a class="header" href="#network-parameters">Network Parameters</a></h4>
<p><strong>Peering Degree:</strong></p>
<ul>
<li><strong>Minimum recommended</strong>: 8 peers</li>
<li><strong>Rationale</strong>: Ensures redundancy and efficient propagation</li>
<li><strong>Configurable</strong>: Nodes may adjust based on resources and requirements</li>
</ul>
<h3 id="bootstrapping"><a class="header" href="#bootstrapping">Bootstrapping</a></h3>
<h4 id="initial-network-entry"><a class="header" href="#initial-network-entry">Initial Network Entry</a></h4>
<p>New nodes connect to the network through designated bootstrap nodes.</p>
<p><strong>Process:</strong></p>
<ol>
<li>Connect to known bootstrap nodes</li>
<li>Obtain initial peer list through Kademlia</li>
<li>Establish gossipsub connections</li>
<li>Begin participating in network protocols</li>
</ol>
<p><strong>Bootstrap Node Requirements:</strong></p>
<ul>
<li>High availability and reliability</li>
<li>Geographic distribution</li>
<li>Version compatibility maintenance</li>
</ul>
<h3 id="message-encoding"><a class="header" href="#message-encoding">Message Encoding</a></h3>
<p>All network messages follow the Nomos Wire Format specification for consistent encoding and decoding across implementations.</p>
<p><strong>Key Properties:</strong></p>
<ul>
<li>Deterministic serialization</li>
<li>Efficient binary encoding</li>
<li>Forward/backward compatibility support</li>
<li>Cross-platform consistency</li>
</ul>
<p><em>Note: Detailed wire format specifications are maintained in a separate document.</em></p>
<h2 id="implementation-requirements-2"><a class="header" href="#implementation-requirements-2">Implementation Requirements</a></h2>
<h3 id="mandatory-protocols"><a class="header" href="#mandatory-protocols">Mandatory Protocols</a></h3>
<p>All Nomos nodes MUST implement:</p>
<ol>
<li><strong>Kademlia DHT</strong> for peer discovery</li>
<li><strong>Identify protocol</strong> for peer information exchange</li>
<li><strong>Gossipsub</strong> for message dissemination</li>
</ol>
<h3 id="optional-enhancements-2"><a class="header" href="#optional-enhancements-2">Optional Enhancements</a></h3>
<p>Nodes MAY implement:</p>
<ul>
<li>Advanced NAT traversal techniques</li>
<li>Custom peering strategies</li>
<li>Enhanced message routing optimizations</li>
</ul>
<h3 id="network-versioning"><a class="header" href="#network-versioning">Network Versioning</a></h3>
<p>Protocol versions follow semantic versioning:</p>
<ul>
<li><strong>Major version</strong>: Breaking protocol changes</li>
<li><strong>Minor version</strong>: Backward-compatible enhancements</li>
<li><strong>Patch version</strong>: Bug fixes and optimizations</li>
</ul>
<h2 id="configuration-parameters-1"><a class="header" href="#configuration-parameters-1">Configuration Parameters</a></h2>
<h3 id="implementation-note"><a class="header" href="#implementation-note">Implementation Note</a></h3>
<p><strong>Current Status</strong>: The Nomos P2P network implementation uses hardcoded libp2p protocol parameters for optimal performance and reliability. While the node configuration file (<code>config.yaml</code>) contains network-related settings, the core libp2p protocol parameters (Kademlia DHT, Identify, and Gossipsub) are embedded in the source code.</p>
<h3 id="node-configuration"><a class="header" href="#node-configuration">Node Configuration</a></h3>
<p>The following network parameters are configurable via <code>config.yaml</code>:</p>
<h4 id="network-backend-settings"><a class="header" href="#network-backend-settings">Network Backend Settings</a></h4>
<pre><code class="language-yaml">network:
  backend:
    host: 0.0.0.0
    port: 3000
    node_key: &lt;node_private_key&gt;
    initial_peers: []
</code></pre>
<h4 id="protocol-specific-topics"><a class="header" href="#protocol-specific-topics">Protocol-Specific Topics</a></h4>
<p><strong>Mempool Dissemination:</strong></p>
<ul>
<li><strong>Mainnet</strong>: <code>/nomos/mempool/0.1.0</code></li>
<li><strong>Testnet</strong>: <code>/nomos-testnet/mempool/0.1.0</code></li>
</ul>
<p><strong>Block Propagation:</strong></p>
<ul>
<li><strong>Mainnet</strong>: <code>/nomos/cryptarchia/0.1.0</code></li>
<li><strong>Testnet</strong>: <code>/nomos-testnet/cryptarchia/0.1.0</code></li>
</ul>
<h3 id="hardcoded-protocol-parameters"><a class="header" href="#hardcoded-protocol-parameters">Hardcoded Protocol Parameters</a></h3>
<p>The following libp2p protocol parameters are currently hardcoded in the implementation:</p>
<h4 id="peer-discovery-parameters"><a class="header" href="#peer-discovery-parameters">Peer Discovery Parameters</a></h4>
<ul>
<li><strong>Protocol identifiers</strong> for Kademlia DHT and Identify protocols</li>
<li><strong>DHT routing table</strong> configuration and query timeouts</li>
<li><strong>Peer discovery intervals</strong> and connection management</li>
</ul>
<h4 id="message-dissemination-parameters"><a class="header" href="#message-dissemination-parameters">Message Dissemination Parameters</a></h4>
<ul>
<li><strong>Gossipsub mesh parameters</strong> (peer degree, heartbeat intervals)</li>
<li><strong>Message validation</strong> and caching settings</li>
<li><strong>Topic subscription</strong> and fanout management</li>
</ul>
<h4 id="rationale-for-hardcoded-parameters"><a class="header" href="#rationale-for-hardcoded-parameters">Rationale for Hardcoded Parameters</a></h4>
<ol>
<li><strong>Network Stability</strong>: Prevents misconfigurations that could fragment the network</li>
<li><strong>Performance Optimization</strong>: Parameters are tuned for the target network size and latency requirements</li>
<li><strong>Security</strong>: Reduces attack surface by limiting configurable network parameters</li>
<li><strong>Simplicity</strong>: Eliminates need for operators to understand complex P2P tuning</li>
</ol>
<h2 id="security-considerations-15"><a class="header" href="#security-considerations-15">Security Considerations</a></h2>
<h3 id="network-level-security"><a class="header" href="#network-level-security">Network-Level Security</a></h3>
<ol>
<li><strong>Peer Authentication</strong>: Utilize libp2p's built-in peer identity verification</li>
<li><strong>Message Validation</strong>: Implement application-layer message validation</li>
<li><strong>Rate Limiting</strong>: Protect against spam and DoS attacks</li>
<li><strong>Blacklisting</strong>: Mechanism for excluding malicious peers</li>
</ol>
<h3 id="privacy-considerations-3"><a class="header" href="#privacy-considerations-3">Privacy Considerations</a></h3>
<ol>
<li><strong>Traffic Analysis</strong>: Gossipsub provides some resistance to traffic analysis</li>
<li><strong>Metadata Leakage</strong>: Minimize identifiable information in protocol messages</li>
<li><strong>Connection Patterns</strong>: Randomize connection timing and patterns</li>
</ol>
<h3 id="denial-of-service-protection-1"><a class="header" href="#denial-of-service-protection-1">Denial of Service Protection</a></h3>
<ol>
<li><strong>Resource Limits</strong>: Impose limits on connections and message rates</li>
<li><strong>Peer Scoring</strong>: Implement reputation-based peer management</li>
<li><strong>Circuit Breakers</strong>: Automatic protection against resource exhaustion</li>
</ol>
<h3 id="node-configuration-example"><a class="header" href="#node-configuration-example">Node Configuration Example</a></h3>
<p><a href="https://github.com/logos-co/nomos/blob/master/nodes/nomos-node/config.yaml">Nomos Node Configuration</a> is an example node configuration</p>
<h2 id="performance-characteristics-3"><a class="header" href="#performance-characteristics-3">Performance Characteristics</a></h2>
<h3 id="scalability-2"><a class="header" href="#scalability-2">Scalability</a></h3>
<ul>
<li><strong>Target Network Size</strong>: 10,000+ nodes</li>
<li><strong>Message Latency</strong>: Sub-second for critical messages</li>
<li><strong>Bandwidth Efficiency</strong>: Optimized for limited bandwidth environments</li>
</ul>
<h3 id="resource-requirements-1"><a class="header" href="#resource-requirements-1">Resource Requirements</a></h3>
<ul>
<li><strong>Memory Usage</strong>: Minimal DHT routing table overhead</li>
<li><strong>CPU Usage</strong>: Efficient cryptographic operations</li>
<li><strong>Network Bandwidth</strong>: Adaptive based on node role and capacity</li>
</ul>
<h2 id="references-42"><a class="header" href="#references-42">References</a></h2>
<p>Original working document, from Nomos Notion: <a href="https://nomos-tech.notion.site/P2P-Network-Specification-206261aa09df81db8100d5f410e39d75">P2P Network Specification</a>.</p>
<ol>
<li><a href="https://docs.libp2p.io/">libp2p Specifications</a></li>
<li><a href="https://docs.libp2p.io/concepts/transports/quic/">QUIC Protocol Specification</a></li>
<li><a href="https://docs.libp2p.io/concepts/discovery-routing/kaddht/">Kademlia DHT</a></li>
<li><a href="https://github.com/libp2p/specs/tree/master/pubsub/gossipsub">Gossipsub Protocol</a></li>
<li><a href="https://github.com/libp2p/specs/blob/master/identify/README.md">Identify Protocol</a></li>
<li><a href="https://github.com/logos-co/nomos">Nomos Implementation</a> - Reference implementation and source code</li>
<li><a href="https://github.com/logos-co/nomos/blob/master/nodes/nomos-node/config.yaml">Nomos Node Configuration</a> - Example node configuration</li>
</ol>
<h2 id="copyright-51"><a class="header" href="#copyright-51">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nomos-sdp"><a class="header" href="#nomos-sdp">NOMOS-SDP</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Nomos Service Declaration Protocol Specification</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Editor</th><td>Marcin Pawlowski &lt;marcin@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Mehmet &lt;mehmet@status.im&gt;<br>Daniel Sanchez Quiros &lt;danielsq@status.im&gt;<br>Álvaro Castro-Castilla &lt;alvaro@status.im&gt;<br>Thomas Lavaur &lt;thomaslavaur@status.im&gt;<br>Filip Dimitrijevic &lt;filip@status.im&gt;<br>Gusto Bacvinka &lt;augustinas@status.im&gt;<br>David Rusu &lt;davidrusu@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-56"><a class="header" href="#timeline-56">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/nomos/raw/sdp.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/nomos/raw/sdp.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-09-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/53dfb97bc70601433806762c132335269bd16991/nomos/raw/sdp.md"><code>53dfb97</code></a> — Created nomos/raw/sdp.md draft (#157)</li>
</ul>
<!-- timeline:end -->
<h2 id="introduction-8"><a class="header" href="#introduction-8">Introduction</a></h2>
<p>This document defines a mechanism enabling validators to declare their participation in specific protocols that require a known and agreed-upon list of participants. Some examples of this are Data Availability and the Blend Network. We create a single repository of identifiers which is used to establish secure communication between validators and provide services. Before being admitted to the repository, the validator proves that it locked at least a minimum stake.</p>
<h2 id="requirements-1"><a class="header" href="#requirements-1">Requirements</a></h2>
<p>The requirements for the protocol are defined as follows:</p>
<ul>
<li>A declaration must be backed by a confirmation that the sender of the declaration owns a certain value of the stake.</li>
<li>A declaration is valid until it is withdrawn or is not used for a service-specific amount of time.</li>
</ul>
<h2 id="overview-6"><a class="header" href="#overview-6">Overview</a></h2>
<p>The SDP enables nodes to declare their eligibility to serve a specific service in the system, and withdraw their declarations.</p>
<h3 id="protocol-actions"><a class="header" href="#protocol-actions">Protocol Actions</a></h3>
<p>The protocol defines the following actions:</p>
<ul>
<li><strong>Declare</strong>: A node sends a declaration that confirms its willingness to provide a specific service, which is confirmed by locking a threshold of stake.</li>
<li><strong>Active</strong>: A node marks that its participation in the protocol is active according to the service-specific activity logic. This action enables the protocol to monitor the node's activity. We utilize this as a non-intrusive differentiator of node activity. It is crucial to exclude inactive nodes from the set of active nodes, as it enhances the stability of services.</li>
<li><strong>Withdraw</strong>: A node withdraws its declaration and stops providing a service.</li>
</ul>
<p>The logic of the protocol is straightforward:</p>
<ol>
<li>A node sends a declaration message for a specific service and proves it has a minimum stake.</li>
<li>The declaration is registered on the ledger, and the node can commence its service according to the service-specific service logic.</li>
<li>After a service-specific service-providing time, the node confirms its activity.</li>
<li>The node must confirm its activity with a service-specific minimum frequency; otherwise, its declaration is inactive.</li>
<li>After the service-specific locking period, the node can send a withdrawal message, and its declaration is removed from the ledger, which means that the node will no longer provide the service.</li>
</ol>
<p>💡 The protocol messages are subject to a finality that means messages become part of the immutable ledger after a delay. The delay at which it happens is defined by the consensus.</p>
<h2 id="construction-2"><a class="header" href="#construction-2">Construction</a></h2>
<p>In this section, we present the main constructions of the protocol. First, we start with data definitions. Second, we describe the protocol actions. Finally, we present part of the Bedrock Mantle design responsible for storing and processing SDP-related messages and data.</p>
<h3 id="data"><a class="header" href="#data">Data</a></h3>
<p>In this section, we discuss and define data types, messages, and their storage.</p>
<h4 id="service-types"><a class="header" href="#service-types">Service Types</a></h4>
<p>We define the following services which can be used for service declaration:</p>
<ul>
<li><code>BN</code>: for Blend Network service.</li>
<li><code>DA</code>: for Data Availability service.</li>
</ul>
<pre><code class="language-python">class ServiceType(Enum):
    BN="BN"  # Blend Network
    DA="DA"  # Data Availability
</code></pre>
<p>A declaration can be generated for any of the services above. Any declaration that is not one of the above must be rejected. The number of services might grow in the future.</p>
<h4 id="minimum-stake"><a class="header" href="#minimum-stake">Minimum Stake</a></h4>
<p>The minimum stake is a global value that defines the minimum stake a node must have to perform any service.</p>
<p>The <code>MinStake</code> is a structure that holds the value of the stake <code>stake_threshold</code> and the block number it was set at: <code>timestamp</code>.</p>
<pre><code class="language-python">class MinStake:
    stake_threshold: StakeThreshold
    timestamp: BlockNumber
</code></pre>
<p>The <code>stake_thresholds</code> is a structure aggregating all defined <code>MinStake</code> values.</p>
<pre><code class="language-python">stake_thresholds: list[MinStake]
</code></pre>
<p>For more information on how the minimum stake is calculated, please refer to the Nomos documentation.</p>
<h4 id="service-parameters"><a class="header" href="#service-parameters">Service Parameters</a></h4>
<p>The service parameters structure defines the parameters set necessary for correctly handling interaction between the protocol and services. Each of the service types defined above must be mapped to a set of the following parameters:</p>
<ul>
<li><code>session_length</code> defines the session length expressed as the number of blocks; the sessions are counted from block <code>timestamp</code>.</li>
<li><code>lock_period</code> defines the minimum time (as a number of sessions) during which the declaration cannot be withdrawn, this time must include the period necessary for finalizing the declaration (which might be implicit) and provision of a service for least a single session; it can be expressed as the number of blocks by multiplying its value by the <code>session_length</code>.</li>
<li><code>inactivity_period</code> defines the maximum time (as a number of sessions) during which an activation message must be sent; otherwise, the declaration is considered inactive; it can be expressed as the number of blocks by multiplying its value by the <code>session_length</code>.</li>
<li><code>retention_period</code> defines the time (as a number of sessions) after which the declaration can be safely deleted by the Garbage Collection mechanism; it can be expressed as the number of blocks by multiplying its value by the <code>session_length</code>.</li>
<li><code>timestamp</code> defines the block number at which the parameter was set.</li>
</ul>
<pre><code class="language-python">class ServiceParameters:
    session_length: NumberOfBlocks
    lock_period: NumberOfSessions
    inactivity_period: NumberOfSessions
    retention_period: NumberOfSessions
    timestamp: BlockNumber
</code></pre>
<p>The <code>parameters</code> is a structure aggregating all defined <code>ServiceParameters</code> values.</p>
<pre><code class="language-python">parameters: list[ServiceParameters]
</code></pre>
<h4 id="identifiers"><a class="header" href="#identifiers">Identifiers</a></h4>
<p>We define the following set of identifiers which are used for service-specific cryptographic operations:</p>
<ul>
<li><code>provider_id</code>: used to sign the SDP messages and to establish secure links between validators; it is <code>Ed25519PublicKey</code>.</li>
<li><code>zk_id</code>: used for zero-knowledge operations by the validator that includes rewarding (<a href="https://www.notion.so/Zero-Knowledge-Signature-Scheme-ZkSignature-21c261aa09df8119bfb2dc74a3430df6?pvs=21">Zero Knowledge Signature Scheme (ZkSignature)</a>).</li>
</ul>
<h4 id="locators"><a class="header" href="#locators">Locators</a></h4>
<p>A <code>Locator</code> is the address of a validator which is used to establish secure communication between validators. It follows the <a href="https://docs.libp2p.io/concepts/fundamentals/addressing/">multiaddr addressing scheme from libp2p</a>, but it must contain only the location part and must not contain the node identity (<code>peer_id</code>).</p>
<p>The <code>provider_id</code> must be used as the node identity. Therefore, the <code>Locator</code> must be completed by adding the <code>provider_id</code> at the end of it, which makes the <code>Locator</code> usable in the context of libp2p.</p>
<p>The length of the <code>Locator</code> is restricted to 329 characters.</p>
<p>The syntax of every <code>Locator</code> entry must be validated.</p>
<p><strong>The common formatting of every</strong> <code>Locator</code> <strong>must be applied to maintain its unambiguity, to make deterministic ID generation work consistently.</strong> The <code>Locator</code> must at least contain only lower case letters and every part of the address must be explicit (no implicit defaults).</p>
<h4 id="declaration-message"><a class="header" href="#declaration-message">Declaration Message</a></h4>
<p>The construction of the declaration message is as follows:</p>
<pre><code class="language-python">class DeclarationMessage:
    service_type: ServiceType
    locators: list[Locator]
    provider_id: Ed25519PublicKey 
    zk_id: ZkPublicKey
</code></pre>
<p>The <code>locators</code> list length must be limited to reduce the potential for abuse. Therefore, the length of the list cannot be longer than 8.</p>
<p>The message must be signed by the <code>provider_id</code> key to prove ownership of the key that is used for network-level authentication of the validator. The message is also signed by the <code>zk_id</code> key (by default all Mantle transactions are signed with <code>zk_id</code> key).</p>
<h4 id="declaration-storage"><a class="header" href="#declaration-storage">Declaration Storage</a></h4>
<p>Only valid declaration messages can be stored on the ledger. We define the <code>DeclarationInfo</code> as follows:</p>
<pre><code class="language-python">class DeclarationInfo:
    service: ServiceType
    provider_id: Ed25519PublicKey
    zk_id: ZkPublicKey
    locators: list[Locator]
    created: BlockNumber
    active: BlockNumber
    withdrawn: BlockNumber
    nonce: Nonce
</code></pre>
<p>Where:</p>
<ul>
<li><code>service</code> defines the service type of the declaration;</li>
<li><code>provider_id</code> is an <code>Ed25519PublicKey</code> used to sign the message by the validator;</li>
<li><code>zk_id</code> is used for zero-knowledge operations by the validator that includes rewarding (<a href="https://www.notion.so/Zero-Knowledge-Signature-Scheme-ZkSignature-21c261aa09df8119bfb2dc74a3430df6?pvs=21">Zero Knowledge Signature Scheme (ZkSignature)</a>);</li>
<li><code>locators</code> are a copy of the <code>locators</code> from the <code>DeclarationMessage</code>;</li>
<li><code>created</code> refers to the block number of the block that contained the declaration;</li>
<li><code>active</code> refers to the latest block number for which the active message was sent (it is set to <code>created</code> by default);</li>
<li><code>withdrawn</code> refers to the block number for which the service declaration was withdrawn (it is set to 0 by default).</li>
<li>The <code>nonce</code> must be set to 0 for the declaration message and must increase monotonically by every message sent for the <code>declaration_id</code>.</li>
</ul>
<p>We also define the <code>declaration_id</code> (of a <code>DeclarationId</code> type) that is the unique identifier of <code>DeclarationInfo</code> calculated as a hash of the concatenation of <code>service</code>, <code>provider_id</code>, <code>locators</code> and <code>zk_id</code>. The implementation of the hash function is <code>blake2b</code> using 256 bits of the output.</p>
<pre><code class="language-python">declaration_id = Hash(service||provider_id||zk_id||locators)
</code></pre>
<p>The <code>declaration_id</code> is not stored as part of the <code>DeclarationInfo</code> but it is used to index it.</p>
<p>All <code>DeclarationInfo</code> references are stored in the <code>declarations</code> and are indexed by <code>declaration_id</code>.</p>
<pre><code class="language-python">declarations: list[declaration_id]
</code></pre>
<h4 id="active-message"><a class="header" href="#active-message">Active Message</a></h4>
<p>The construction of the active message is as follows:</p>
<pre><code class="language-python">class ActiveMessage:
    declaration_id: DeclarationId
    nonce: Nonce
    metadata: Metadata
</code></pre>
<p>where <code>metadata</code> is a service-specific node activeness metadata.</p>
<p>The message must be signed by the <code>zk_id</code> key associated with the <code>declaration_id</code>.</p>
<p>The <code>nonce</code> must increase monotonically by every message sent for the <code>declaration_id</code>.</p>
<h4 id="withdraw-message"><a class="header" href="#withdraw-message">Withdraw Message</a></h4>
<p>The construction of the withdraw message is as follows:</p>
<pre><code class="language-python">class WithdrawMessage:
    declaration_id: DeclarationId
    nonce: Nonce
</code></pre>
<p>The message must be signed by the <code>zk_id</code> key from the <code>declaration_id</code>.</p>
<p>The <code>nonce</code> must increase monotonically by every message sent for the <code>declaration_id</code>.</p>
<h4 id="indexing"><a class="header" href="#indexing">Indexing</a></h4>
<p>Every event must be correctly indexed to enable lighter synchronization of the changes. Therefore, we index every <code>declaration_id</code> according to <code>EventType</code>, <code>ServiceType</code>, and <code>Timestamp</code>. Where <code>EventType = { "created", "active", "withdrawn" }</code> follows the type of the message.</p>
<pre><code class="language-python">events = {
    event_type: {
        service_type: {
            timestamp: {
                declarations: list[declaration_id]
            }
        }
    }
}
</code></pre>
<h3 id="protocol-1"><a class="header" href="#protocol-1">Protocol</a></h3>
<h4 id="declare"><a class="header" href="#declare">Declare</a></h4>
<p>The Declare action associates a validator with a service it wants to provide. It requires sending a valid <code>DeclarationMessage</code> (as defined in Declaration Message), which is then processed (as defined below) and stored (as defined in Declaration Storage).</p>
<p>The declaration message is considered valid when all of the following are met:</p>
<ul>
<li>The sender meets the stake requirements.</li>
<li>The <code>declaration_id</code> is unique.</li>
<li>The sender knows the secret behind the <code>provider_id</code> identifier.</li>
<li>The length of the <code>locators</code> list must not be longer than 8.</li>
<li>The <code>nonce</code> is increasing monotonically.</li>
</ul>
<p>If all of the above conditions are fulfilled, then the message is stored on the ledger; otherwise, the message is discarded.</p>
<h4 id="active"><a class="header" href="#active">Active</a></h4>
<p>The Active action enables marking the provider as actively providing a service. It requires sending a valid <code>ActiveMessage</code> (as defined in Active Message), which is relayed to the service-specific node activity logic (as indicated by the service type in Common SDP Structures).</p>
<p>The Active action updates the <code>active</code> value of the <code>DeclarationInfo</code>, which means that it also activates inactive (but not expired) providers.</p>
<p>The SDP active action logic is:</p>
<ol>
<li>A node sends a <code>ActiveMessage</code> transaction.</li>
<li>The <code>ActiveMessage</code> is verified by the SDP logic.
a. The <code>declaration_id</code> returns an existing <code>DeclarationInfo</code>.
b. The transaction containing <code>ActiveMessage</code> is signed by the <code>zk_id</code>.
c. The <code>withdrawn</code> from the <code>DeclarationInfo</code> is set to zero.
d. The <code>nonce</code> is increasing monotonically.</li>
<li>If any of these conditions fail, discard the message and stop processing.</li>
<li>The message is processed by the service-specific activity logic alongside the <code>active</code> value indicating the period since the last active message was sent. The <code>active</code> value comes from the <code>DeclarationInfo</code>.</li>
<li>If the service-specific activity logic approves the node active message, then the <code>active</code> field of the <code>DeclarationInfo</code> is set to the current block height.</li>
</ol>
<h4 id="withdraw"><a class="header" href="#withdraw">Withdraw</a></h4>
<p>The withdraw action enables a withdrawal of a service declaration. It requires sending a valid <code>WithdrawMessage</code> (as defined in Withdraw Message). The withdrawal cannot happen before the end of the locking period, which is defined as the number of blocks counted since <code>created</code>. This lock period is stored as <code>lock_period</code> in the Service Parameters.</p>
<p>The logic of the withdraw action is:</p>
<ol>
<li>A node sends a <code>WithdrawMessage</code> transaction.</li>
<li>The <code>WithdrawMessage</code> is verified by the SDP logic:
a. The <code>declaration_id</code> returns an existing <code>DeclarationInfo</code>.
b. The transaction containing <code>WithdrawMessage</code> is signed by the <code>zk_id</code>.
c. The <code>withdrawn</code> from <code>DeclarationInfo</code> is set to zero.
d. The <code>nonce</code> is increasing monotonically.</li>
<li>If any of the above is not correct, then discard the message and stop.</li>
<li>Set the <code>withdrawn</code> from the <code>DeclarationInfo</code> to the current block height.</li>
<li>Unlock the stake.</li>
</ol>
<h4 id="garbage-collection"><a class="header" href="#garbage-collection">Garbage Collection</a></h4>
<p>The protocol requires a garbage collection mechanism that periodically removes unused <code>DeclarationInfo</code> entries.</p>
<p>The logic of garbage collection is:</p>
<p>For every <code>DeclarationInfo</code> in the <code>declarations</code> set, remove the entry if either:</p>
<ol>
<li>The entry is past the retention period: <code>withdrawn + retention_period &lt; current_block_height</code>.</li>
<li>The entry is inactive beyond the inactivity and retention periods: <code>active + inactivity_period + retention_period &lt; current_block_height</code>.</li>
</ol>
<h4 id="query"><a class="header" href="#query">Query</a></h4>
<p>The protocol must enable querying the ledger in at least the following manner:</p>
<ul>
<li><code>GetAllProviderId(timestamp)</code>, returns all <code>provider_id</code>s associated with the <code>timestamp</code>.</li>
<li><code>GetAllProviderIdSince(timestamp)</code>, returns all <code>provider_id</code>s since the <code>timestamp</code>.</li>
<li><code>GetAllDeclarationInfo(timestamp)</code>, returns all <code>DeclarationInfo</code> entries associated with the <code>timestamp</code>.</li>
<li><code>GetAllDeclarationInfoSince(timestamp)</code>, returns all <code>DeclarationInfo</code> entries since the <code>timestamp</code>.</li>
<li><code>GetDeclarationInfo(provider_id)</code>, returns the <code>DeclarationInfo</code> entry identified by the <code>provider_id</code>.</li>
<li><code>GetDeclarationInfo(declaration_id)</code>, returns the <code>DeclarationInfo</code> entry identified by the <code>declaration_id</code>.</li>
<li><code>GetAllServiceParameters(timestamp)</code>, returns all entries of the <code>ServiceParameters</code> store for the requested <code>timestamp</code>.</li>
<li><code>GetAllServiceParametersSince(timestamp)</code>, returns all entries of the <code>ServiceParameters</code> store since the requested <code>timestamp</code>.</li>
<li><code>GetServiceParameters(service_type, timestamp)</code>, returns the service parameter entry from the <code>ServiceParameters</code> store of a <code>service_type</code> for a specified <code>timestamp</code>.</li>
<li><code>GetMinStake(timestamp)</code>, returns the <code>MinStake</code> structure at the requested <code>timestamp</code>.</li>
<li><code>GetMinStakeSince(timestamp)</code>, returns a set of <code>MinStake</code> structures since the requested <code>timestamp</code>.</li>
</ul>
<p>The query must return an error if the retention period for the delegation has passed and the requested information is not available.</p>
<p>The list of queries may be extended.</p>
<p>Every query must return information for a finalized state only.</p>
<h3 id="mantle-and-zk-proof"><a class="header" href="#mantle-and-zk-proof">Mantle and ZK Proof</a></h3>
<p>For more information about the Mantle and ZK proofs, please refer to <a href="https://www.notion.so/Mantle-Specification-21c261aa09df810c8820fab1d78b53d9?pvs=21">Mantle Specification</a>.</p>
<h2 id="appendix-1"><a class="header" href="#appendix-1">Appendix</a></h2>
<h3 id="future-improvements"><a class="header" href="#future-improvements">Future Improvements</a></h3>
<p>Refer to the <a href="https://www.notion.so/Mantle-Specification-21c261aa09df810c8820fab1d78b53d9?pvs=21">Mantle Specification</a> for a list of potential improvements to the protocol.</p>
<h2 id="references-43"><a class="header" href="#references-43">References</a></h2>
<ul>
<li>Mantle and ZK Proof: <a href="https://www.notion.so/Mantle-Specification-21c261aa09df810c8820fab1d78b53d9?pvs=21">Mantle Specification</a></li>
<li>Ed25519 Digital Signatures: <a href="https://datatracker.ietf.org/doc/html/rfc8032">RFC 8032</a></li>
<li>BLAKE2b Cryptographic Hash: <a href="https://datatracker.ietf.org/doc/html/rfc7693">RFC 7693</a></li>
<li>libp2p Multiaddr: <a href="https://docs.libp2p.io/concepts/fundamentals/addressing/">Addressing Specification</a></li>
<li>Zero Knowledge Signatures: <a href="https://www.notion.so/Zero-Knowledge-Signature-Scheme-ZkSignature-21c261aa09df8119bfb2dc74a3430df6?pvs=21">ZkSignature Scheme</a></li>
</ul>
<h2 id="copyright-52"><a class="header" href="#copyright-52">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nomos-deprecated-specifications"><a class="header" href="#nomos-deprecated-specifications">Nomos Deprecated Specifications</a></h1>
<p>Deprecated Nomos specifications kept for archival and reference purposes.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="consensus-claro"><a class="header" href="#consensus-claro">CONSENSUS-CLARO</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Claro Consensus Protocol</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Corey Petty &lt;corey@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Álvaro Castro-Castilla<br>Mark Evenson</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-57"><a class="header" href="#timeline-57">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/nomos/deprecated/claro.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/nomos/deprecated/claro.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-02-15</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/1ddddc799466c7440ca86e7b7c1262b28354c04d/nomos/deprecated/claro.md"><code>1ddddc7</code></a> — update to tree structure (#128)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/nomos/38/claro.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-02-02</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/f52c54fb5ac763f7cafe811eb7526a771f9246b1/nomos/38/claro.md"><code>f52c54f</code></a> — Update and rename CLARO.md to claro.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/01e27811ea782c11f3db1b97c05299425b09df12/nomos/38/CLARO.md"><code>01e2781</code></a> — Create CLARO.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-32"><a class="header" href="#abstract-32">Abstract</a></h2>
<p>This document specifies Claro: a Byzantine, fault-tolerant, binary decision
agreement algorithm that utilizes bounded memory for its execution.
Claro is a novel variant of the Snow family providing a probabilistic
leaderless BFT consensus algorithm that achieves metastablity via
network sub-sampling.  We present an application context of the use of
Claro in an efficient, leaderless, probabilistic permission-less
consensus mechanism.  We outline a simple taxonomy of Byzantine
adversaries, leaving explicit explorations of to subsequent
publication.</p>
<p>NOTE: We have renamed this variant to <code>Claro</code> from <code>Glacier</code>
in order to disambiguate from a previously released research endeavor by
<a href="https://arxiv.org/pdf/2210.03423.pdf">Amores-Sesar, Cachin, and Tedeschi</a>.
Their naming was coincidentally named the same as our work but
is sufficiently differentiated from how ours works.</p>
<h2 id="motivation-24"><a class="header" href="#motivation-24">Motivation</a></h2>
<p>This work is a part of a larger research endeavor to
explore highly scalable Byzantine Fault Tolerant (BFT) consensus protocols.
Consensus lies at the heart of many decentralized protocols, and
thus its characteristics and properties are inherited by applications built on top.
Thus, we seek to improve upon the current state of the art in two main directions:
base-layer scalability and censorship resistance.</p>
<p>Avalanche has shown to exibit the former in a production environment in a way
that is differentiated from Nakamoto consensus and
other Proof of Stake (PoS) protocols based in practical Byzantine Fault Tolerant
(pBFT) methodologies.
We aim to understand its limitations and improve upon them.</p>
<h2 id="background-3"><a class="header" href="#background-3">Background</a></h2>
<p>Our starting point is Avalanche’s Binary Byzantine Agreement algorithm,
called Snowball.
As long as modifications allow a DAG to be constructed later on,
this simplifies the design significantly.
The DAG stays the same in principle: it supports confidence,
but the core algorithm can be modeled without.</p>
<p>The concept of the Snowball algorithm is relatively simple.
Following is a simplified description (lacking some details, but giving an overview).
For further details, please refer to the <a href="https://assets.website-files.com/5d80307810123f5ffbb34d6e/6009805681b416f34dcae012_Avalanche%20Consensus%20Whitepaper.pdf">Avalanche paper</a>.</p>
<ol>
<li>The objective is to vote yes/no on a decision
(this decision could be a single bit or,
in our DAG use case, whether a vertex should be included or not).</li>
<li>Every node has an eventually-consistent complete view of the network.
It will select at random k nodes, and
will ask their opinion on the decision (yes/no).</li>
<li>After this sampling is finished,
if there is a vote that has more than an <code>alpha</code> threshold,
it accumulates one count for this opinion,
as well as changes its opinion to this one.
But, if a different opinion is received, the counter is reset to 1.
If no threshold <code>alpha</code> is reached, the counter is reset to 0 instead.</li>
<li>After several iterations of this algorithm,
we will reach a threshold <code>beta</code>, and decide on that as final.</li>
</ol>
<p>Next, we will proceed to describe our new algorithm, based on Snowball.</p>
<p>We have identified a shortcoming of the Snowball algorithm
that was a perfect starting point for devising improvements.
The scenario is as follows:</p>
<ul>
<li>There is a powerful adversary in the network,
that controls a large percentage of the node population: 10% to ~50%.</li>
<li>This adversary follows a strategy that allows them to
rapidly change the decision bit
(possibly even in a coordinated way) so as to maximally confuse the honest nodes.</li>
<li>Under normal conditions,
honest nodes will accumulate supermajorities soon enough, and
reach the <code>beta</code> threshold.
However, when an honest node performs a query and does not reach the threshold
<code>alpha</code> of responses, the counter will be set to 0.</li>
<li>The highest threat to Snowball is an adversary
that keeps it from reaching the <code>beta</code> threshold,
managing to continuously reset the counter, and
steering Snowball away from making a decision.</li>
</ul>
<p>This document only outlines the specification to Claro.
Subsequent analysis work on Claro
(both on its performance and how it differentiates with Snowball)
will be published shortly and this document will be updated.</p>
<h2 id="claro-algorithm-specification"><a class="header" href="#claro-algorithm-specification">Claro Algorithm Specification</a></h2>
<p>The Claro consensus algorithm computes a boolean decision on a
proposition via a set of distributed computational nodes.  Claro is
a leaderless, probabilistic, binary consensus algorithm with fast
finality that provides good reliability for network and Byzantine
fault tolerance.</p>
<h3 id="algorithmic-concept"><a class="header" href="#algorithmic-concept">Algorithmic concept</a></h3>
<p>Claro is an evolution of the Snowball Byzantine Binary Agreement (BBA) algorithm,
in which we tackle specifically the perceived weakness described above.
The main focus is going to be the counter and the triggering of the reset.
Following, we elaborate the different modifications and
features that have been added to the reference algorithm:</p>
<ol>
<li>Instead of allowing the latest evidence to change the opinion completely,
we take into account all accumulated evidence,
to reduce the impact of high variability when there is already a
large amount of evidence collected.</li>
<li>Eliminate the counter and threshold scheme,
and introduce instead two regimes of operation:
<ul>
<li>One focused on grabbing opinions and reacting as soon as possible.
This part is somewhat closer conceptually to the reference algorithm.</li>
<li>Another one focused on interpreting the accumulated data
instead of reacting to the latest information gathered.</li>
</ul>
</li>
<li>Finally, combine those two phases via a transition function.
This avoids the creation of a step function, or
a sudden change in behavior that could complicate analysis and
understanding of the dynamics.
Instead, we can have a single algorithm that transfers weight
from one operation to the other as more evidence is gathered.</li>
<li>Additionally, we introduce a function for weighted sampling.
This will allow the combination of different forms of weighting:
<ul>
<li>Staking</li>
<li>Heuristic reputation</li>
<li>Manual reputation.</li>
</ul>
</li>
</ol>
<p>It’s worth delving a bit into the way the data is interpreted
in order to reach a decision.
Our approach is based conceptually on the paper <a href="https://cis.temple.edu/~pwang/Publication/confidence.pdf">Confidence as Higher-Order Uncertainty</a>,
which describes a frequentist approach to decision certainty.
The first-order certainty, measured by frequency,
is caused by known positive evidence, and
the higher-order certainty is caused by potential positive evidence.
Because confidence is a relative measurement defined on evidence,
it naturally follows comparing the amount of evidence the system knows
with the amount that it will know in the near future (defining “near” as a constant).</p>
<p>Intuitively, we are looking for a function of evidence, <strong><code>w</code></strong>,
call it <strong><code>c</code></strong> for confidence, that satisfies the following conditions:</p>
<ol>
<li>Confidence <code>c</code> is a continuous and monotonically increasing function of <code>w</code>.
(More evidence, higher confidence.)</li>
<li>When <code>w = 0</code>, <code>c = 0</code>. (Without any evidence, confidence is minimum.)</li>
<li>When <code>w</code> goes to infinity, <code>c</code> converges to 1.
(With infinite evidence, confidence is maximum.)</li>
</ol>
<p>The paper describes also a set of operations for the evidence/confidence pairs,
so that different sources of knowledge could be combined.
However, we leave here the suggestion of a possible research line in the future
combining an algebra of evidence/confidence pairs with
swarm-propagation algorithm like the one described in
<a href="http://replicated.cc/files/schmebulock.pdf">this paper</a>.</p>
<h3 id="initial-opinion"><a class="header" href="#initial-opinion">Initial opinion</a></h3>
<p>A proposal is formulated to which consensus of truth or falsity is
desired.  Each node that participates starts the protocol with an
opinion on the proposal, represented in the sequel as <code>NO</code>, <code>NONE</code>,
and <code>YES</code>.</p>
<p>A new proposition is discovered either by local creation or in
response to a query, a node checks its local opinion.  If the node can
compute a justification of the proposal, it sets its opinion to one of
<code>YES</code> or <code>NO</code>.  If it cannot form an opinion, it leaves its opinion as
<code>NONE</code>.</p>
<p>For now, we will ignore the proposal dissemination process and
assume all nodes participating have an initial opinion
to respond to within a given request.
Further research will relax this assumption and
analyze timing attacks on proposal propagation through the network.</p>
<p>The node then participates in a number of query rounds in which it
solicits other node's opinion in query rounds.  Given a set of <code>N</code>
leaderless computational nodes, a gossip-based protocol is presumed to
exist which allows members to discover, join, and leave a weakly
transitory maximally connected graph.  Joining this graph allows each
node to view a possibly incomplete node membership list of all other
nodes.  This view may change as the protocol advances, as nodes join
and leave.  Under generalized Internet conditions, the membership of
the graph would experience a churn rate varying across different
time-scales, as the protocol rounds progress.  As such, a given node
may not have a view on the complete members participating in the
consensus on a proposal in a given round.</p>
<p>The algorithm is divided into 4 phases:</p>
<ol>
<li>Querying</li>
<li>Computing <code>confidence</code>, <code>evidence</code>, and <code>accumulated evidence</code></li>
<li>Transition function</li>
<li>Opinion and Decision</li>
</ol>
<!-- NOTE from CP: not sure this fits, commenting for now -->
<!-- ### Proposal Identification

The node has a semantics and serialization of the proposal, of which
it sets an initial opinion:

     opinion
        <-- initial opinion on truth of the proposal
            as one of: {NO, NONE, YES}
    
The proposal proceeds in asynchronous rounds, in which each node
queries `k` randomly sampled nodes for their opinions until a decision
about local finality is achieved.  The liveness of the algorithm is
severely constrained in the absence of timeouts for a round to
proceed.  When a given node has finalized its decision on the
proposal, it enters a quiescent state in which it optionally discards
all information gathered during the query process retaining only the
final opinion on the truth of the proposal. -->
<h3 id="setup-parameters"><a class="header" href="#setup-parameters">Setup Parameters</a></h3>
<p>The node initializes the following integer ratios as constants:</p>
<pre><code class="language-markdown"># The following values are constants chosen with justification from experiments
# performed with the adversarial models

# 
confidence_threshold
  &lt;-- 1   
         
# constant look ahead for number of rounds we expect to finalize a
# decision.  Could be set dependent on number of nodes 
# visible in the current gossip graph.
look_ahead 
  &lt;-- 19

# the confidence weighting parameter (aka alpha_1)
certainty 
  &lt;-- 4 / 5  
doubt ;; the lack of confidence weighting parameter (aka alpha_2)
  &lt;-- 2 / 5 

k_multiplier     ;; neighbor threshold multiplier
  &lt;-- 2

;;; maximal threshold multiplier, i.e. we will never exceed 
;;; questioning k_initial * k_multiplier ^ max_k_multiplier_power peers
max_k_multiplier_power 
  &lt;-- 4
    
;;; Initial number of nodes queried in a round
k_initial 
  &lt;-- 7

;;; maximum query rounds before termination
max_rounds ;; placeholder for simulation work, no justification yet
   &lt;-- 100 
</code></pre>
<p>The following variables are needed to keep the state of Claro:</p>
<pre><code class="language-markdown">;; current number of nodes to attempt to query in a round
k 
  &lt;-- k_original
  
;; total number of votes examined over all rounds
total_votes 
   &lt;-- 0 
;; total number of YES (i.e. positive) votes for the truth of the proposal
total_positive 
   &lt;-- 0
;; the current query round, an integer starting from zero
round
  &lt;-- 0
</code></pre>
<h3 id="phase-one-query"><a class="header" href="#phase-one-query">Phase One: Query</a></h3>
<p>A node selects <code>k</code> nodes randomly from the complete pool of peers in the
network. This query is can optionally be weighted, so the probability
of selecting nodes is proportional to their</p>
<p>Node Weighting
$$
P(i) = \frac{w_i}{\sum_{j=0}^{j=N} w_j}
$$</p>
<p>where <code>w</code> is evidence.
The list of nodes is maintained by a separate protocol (the network layer),
and eventual consistency of this knowledge in the network
suffices. Even if there are slight divergences in the network view
from different nodes, the algorithm is resilient to those.</p>
<p>A query is sent to each neighbor with the node's current <code>opinion</code> of
the proposal.</p>
<p>Each node replies with their current opinion on the proposal.</p>
<p>See <a href="nomos/deprecated/claro.html#wire-protocol">the wire protocol Interoperability section</a> for
details on the semantics and syntax of the "on the wire"
representation of this query.</p>
<p><strong>Adaptive querying</strong>. An additional optimization in the query
consists of adaptively growing the <em><code>k</code></em> constant in the event of
<strong>high confusion</strong>. We define high confusion as the situation in
which neither opinion is strongly held in a query (<em>i.e.</em> a
threshold is not reached for either yes or no). For this, we will
use the <em><code>alpha</code></em> threshold defined below. This adaptive growth of
the query size is done as follows:</p>
<p>Every time the threshold is not reached, we multiply <em><code>k</code></em> by a
constant. In our experiments, we found that a constant of 2 works
well, but what really matters is that it stays within that order of
magnitude.</p>
<p>The growth is capped at 4 times the initial <em><code>k</code></em> value. Again, this
is an experimental value, and could potentially be increased. This
depends mainly on complex factors such as the size of the query
messages, which could saturate the node bandwidth if the number of
nodes queried is too high.</p>
<p>When the query finishes, the node now initializes the following two
values:</p>
<pre><code class="language-markdown">    new_votes 
      &lt;-- |total vote replies received in this round to the current query|
    positive_votes 
      &lt;-- |YES votes received from the query| 
</code></pre>
<h3 id="phase-two-computation"><a class="header" href="#phase-two-computation">Phase Two: Computation</a></h3>
<p>When the query returns, three ratios are used later on to compute the
transition function and the opinion forming. Confidence encapsulates
the notion of how much we know (as a node) in relation to how much we
will know in the near future (this being encoded in the look-ahead
parameter <em><code>l</code></em>.) Evidence accumulated keeps the ratio of total positive
votes vs the total votes received (positive and negative), whereas the
evidence per round stores the ratio of the current round only.</p>
<p>Parameters
$$
\begin{array}{lc}
\text{Look-ahead parameter}      &amp; l = 20 \newline
\text{First evidence parameter}  &amp; \alpha_1 = 0.8 \newline
\text{Second evidence parameter} &amp; \alpha_2 = 0.5 \newline
\end{array}
$$</p>
<p>Computation
$$
\begin{array}{lc}
\text{Confidence}                &amp; c_{accum} \impliedby \frac{total\ votes}
{total\ votes + l} \newline
\text{Total accumulated evidence}&amp; e_{accum} \impliedby \frac{total\ positive<br />
votes}{total\ votes} \newline
\text{Evidence per round}        &amp; e_{round} \impliedby \frac{round\ positive<br />
votes}{round\ votes} \newline
\end{array}
$$</p>
<p>The node runs the <code>new_votes</code> and <code>positive_votes</code> parameters received
in the query round through the following algorithm:</p>
<pre><code class="language-markdown">
    total_votes 
      +== new_votes
    total_positive 
      +== positive_votes
    confidence 
      &lt;-- total_votes / (total_votes + look_ahead) 
    total_evidence 
      &lt;-- total_positive / total_votes
    new_evidence 
      &lt;-- positive_votes / new_votes
    evidence 
      &lt;-- new_evidence * ( 1 - confidence ) + total_evidence * confidence 
    alpha 
      &lt;-- doubt * ( 1 - confidence ) + certainty * confidence 
</code></pre>
<h3 id="phase-three-computation"><a class="header" href="#phase-three-computation">Phase Three: Computation</a></h3>
<p>In order to eliminate the need for a step function (a conditional in
the code), we introduce a transition function from one regime to the
other. Our interest in removing the step function is twofold:</p>
<ol>
<li>
<p>Simplify the algorithm. With this change the number of branches is
reduced, and everything is expressed as a set of equations.</p>
</li>
<li>
<p>The transition function makes the regime switch smooth,
making it harder to potentially exploit the sudden regime change in
some unforeseen manner. Such a swift change in operation mode could
potentially result in a more complex behavior than initially
understood, opening the door to elaborated attacks. The transition
function proposed is linear with respect to the confidence.</p>
</li>
</ol>
<p>Transition Function
$$
\begin{array}{cl}
evidence &amp; \impliedby e_{round} (1 - c_{accum}) + e_{accum} c_{accum} \newline
\alpha &amp;  \impliedby \alpha_1 (1 - c_{accum}) + \alpha_2 c_{accum} \newline
\end{array}
$$</p>
<p>Since the confidence is modeled as a ratio that depends on the
constant <em><code>l</code></em>, we can visualize the transition function at
different values of <em><code>l</code></em>. Recall that this constant encapsulates
the idea of “near future” in the frequentist certainty model: the
higher it is, the more distant in time we consider the next
valuable input of evidence to happen.</p>
<p>We have observed via experiment that for a transition function to be
useful, we need establish two requirements:</p>
<ol>
<li>
<p>The change has to be balanced and smooth, giving an
opportunity to the first regime to operate and not jump directly
to the second regime.</p>
</li>
<li>
<p>The convergence to 1.0 (fully operating in the second regime)
should happen within a reasonable time-frame. We’ve set this
time-frame experimentally at 1000 votes, which is in the order of
~100 queries given a <em><code>k</code></em> of 9.</p>
</li>
</ol>
<p>[[ Note: Avalanche uses k = 20, as an experimental result from their
deployment. Due to the fundamental similarities between the
algorithms, it’s a good start for us. ]]</p>
<p>The node updates its local opinion on the consensus proposal by
examining the relationship between the evidence accumulated for a
proposal with the confidence encoded in the <code>alpha</code> parameter:</p>
<pre><code class="language-php">    IF
      evidence &gt; alpha
    THEN 
      opinion &lt;-- YES
    ELSE IF       
      evidence &lt; 1 - alpha
    THEN 
      opinion &lt;-- NO
</code></pre>
<p>If the opinion of the node is <code>NONE</code> after evaluating the relation
between <code>evidence</code> and <code>alpha</code>, adjust the number of uniform randomly
queried nodes by multiplying the neighbors <code>k</code> by the <code>k_multiplier</code>
up to the limit of <code>k_max_multiplier_power</code> query size increases.</p>
<pre><code class="language-php">
    ;; possibly increase number nodes to uniformly randomly query in next round
    WHEN
         opinion is NONE
      AND 
         k &lt; k_original * k_multiplier ^ max_k_multiplier_power
    THEN 
       k &lt;-- k * k_multiplier
</code></pre>
<h3 id="decision"><a class="header" href="#decision">Decision</a></h3>
<p>The next step is a simple one: change our opinion if the threshold
<em><code>alpha</code></em> is reached. This needs to be done separately for the <code>YES/NO</code>
decision, checking both boundaries. The last step is then to <em><code>decide</code></em>
on the current opinion. For that, a confidence threshold is
employed. This threshold is derived from the network size, and is
directly related to the number of total votes received.</p>
<p>Decision
$$
\begin{array}{cl}
evidence &gt; \alpha &amp; \implies \text{opinion YES} \newline
evidence &lt; 1 - \alpha &amp; \implies \text{opinion NO} \newline
if\ \text{confidence} &gt; c_{target} &amp; THEN \ \text{finalize decision} \newline
\end{array}
$$</p>
<p>After the <code>OPINION</code> phase is executed, the current value of <code>confidence</code>
is considered: if <code>confidence</code> exceeds a threshold derived from the
network size and directly related to the total votes received, an
honest node marks the decision as final, and always returns this
opinion is response to further queries from other nodes on the
network.</p>
<pre><code class="language-php">
    IF 
      confidence &gt; confidence_threshold
    OR 
      round &gt; max_rounds
    THEN
      finalized &lt;-- T
      QUERY LOOP TERMINATES
    ELSE 
      round +== 1
      QUERY LOOP CONTINUES
</code></pre>
<p>Thus, after the decision phase, either a decision has been finalized
and the local node becomes quiescent never initiating a new query, or
it initiates a <a href="nomos/deprecated/query">new query</a>.</p>
<h3 id="termination"><a class="header" href="#termination">Termination</a></h3>
<p>A local round of Claro terminates in one of the following
execution model considerations:</p>
<ol>
<li>
<p>No queries are received for any newly initiated round for temporal
periods observed via a locally computed passage of time.  See <a href="nomos/deprecated/claro.html#clock">the
following point on local time</a>.</p>
</li>
<li>
<p>The <code>confidence</code> on the proposal exceeds our threshold for
finalization.</p>
</li>
<li>
<p>The number of <code>rounds</code> executed would be greater than
<code>max_rounds</code>.</p>
</li>
</ol>
<h4 id="quiescence"><a class="header" href="#quiescence">Quiescence</a></h4>
<p>After a local node has finalized an <code>opinion</code> into a <code>decision</code>, it enters a quiescent
state whereby it never solicits new votes on the proposal.  The local
node MUST reply with the currently finalized <code>decision</code>.</p>
<h4 id="clock"><a class="header" href="#clock">Clock</a></h4>
<p>The algorithm only requires that nodes have computed the drift of
observation of the passage of local time, not that that they have
coordinated an absolute time with their peers.  For an implementation
of a phase locked-loop feedback to measure local clock drift see
<a href="https://www.rfc-editor.org/rfc/rfc5905.html">NTP</a>.</p>
<h2 id="further-points"><a class="header" href="#further-points">Further points</a></h2>
<h3 id="node-receives-information-during-round"><a class="header" href="#node-receives-information-during-round">Node receives information during round</a></h3>
<p>In the query step, the node is envisioned as packing information into
the query to cut down on the communication overhead a query to each of
this <code>k</code> nodes containing the node's own current opinion on the
proposal (<code>YES</code>, <code>NO</code>, or <code>NONE</code>).  The algorithm does not currently
specify how a given node utilizes this incoming information.  A
possible use may be to count unsolicited votes towards a currently
active round, and discard the information if the node is in a
quiescent state.</p>
<h4 id="problems-with-weighting-node-value-of-opinions"><a class="header" href="#problems-with-weighting-node-value-of-opinions">Problems with Weighting Node Value of Opinions</a></h4>
<p>If the view of other nodes is incomplete, then the sum of the optional
weighting will not be a probability distribution normalized to 1.</p>
<p>The current algorithm doesn't describe how the initial opinions are formed.</p>
<h2 id="implementation-status"><a class="header" href="#implementation-status">Implementation status</a></h2>
<p>The following implementations have been created for various testing and
simulation purposes:</p>
<ul>
<li><a href="https://github.com/logos-co/consensus-research">Rust</a></li>
<li><a href="nomos/deprecated/none">Python</a> - FILL THIS IN WITH NEWLY CREATED REPO</li>
<li><a href="nomos/deprecated/none">Common Lisp</a> - FILL THIS IN WITH NEWLY CREATED REPO</li>
</ul>
<h2 id="wire-protocol-5"><a class="header" href="#wire-protocol-5">Wire Protocol</a></h2>
<p>For interoperability we present a wire protocol semantics by requiring
the validity of the following statements expressed in Notation3 (aka
<code>n3</code>) about any query performed by a query node:</p>
<pre><code class="language-n3">@prefix rdf:         &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt; .
@prefix rdfs:        &lt;http://www.w3.org/2000/01/rdf-schema#&gt; .
@prefix xsd:         &lt;http://www.w3.org/2001/XMLSchema#&gt; .

@prefix Claro      &lt;https://rdf.logos.co/protocol/Claro#&gt; .

Claro:query
  :holds (
    :_0 [ rdfs:label "round";
          a xsd:postitiveInteger; ],
          rdfs:comment """
The current round of this query 

A value of zero corresponds to the initial round.
""" ;

    :_1 [ rdfs:label "uri";
          rdfs:comment """
A unique URI for the proposal.

It MAY be possible to examine the proposal by resolving this resource, 
and its associated URIs.
""" ;
          a xsd:anyURI ],
          
    :_2 [ rdfs:label "opinion";
          rdfs:comment """
The opinion on the proposal

One of the strings "YES" "NO" or "NONE".
""" ;
          # TODO constrain as an enumeration on three values efficiently
          a xsd:string ] 
    ) .
</code></pre>
<p>Nodes are advised to use Waku messages to include their own
metadata in serializations as needed.</p>
<h2 id="syntax-2"><a class="header" href="#syntax-2">Syntax</a></h2>
<p>The semantic description presented above can be reliably round-tripped
through a suitable serialization mechanism.  JSON-LD provides a
canonical mapping to UTF-8 JSON.</p>
<p>At their core, the query messages are a simple enumeration of the
three possible values of the opinion:</p>
<blockquote>
<p>{ NO, NONE, YES }</p>
</blockquote>
<p>When represented via integers, such as choosing</p>
<blockquote>
<p>{ -1, 0, +1 }</p>
</blockquote>
<p>the parity summations across network invariants often become easier to
manipulate.</p>
<h2 id="security-considerations-16"><a class="header" href="#security-considerations-16">Security Considerations</a></h2>
<h3 id="privacy-2"><a class="header" href="#privacy-2">Privacy</a></h3>
<p>In practice, each honest node gossips its current opinion which
reduces the number of messages that need to be gossiped for a given
proposal.  The resulting impact on the privacy of the node's opinion
is not currently analyzed.</p>
<h3 id="security-with-respect-to-various-adversarial-models"><a class="header" href="#security-with-respect-to-various-adversarial-models">Security with respect to various Adversarial Models</a></h3>
<p>Adversarial models have been tested for which the values for current
parameters of Claro have been tuned.  Exposition of the
justification of this tuning need to be completed.</p>
<h3 id="local-strategies"><a class="header" href="#local-strategies">Local Strategies</a></h3>
<h4 id="random-adversaries"><a class="header" href="#random-adversaries">Random Adversaries</a></h4>
<p>A random adversary optionally chooses to respond to all queries with a
random decision.  Note that this adversary may be in some sense
Byzantine but not malicious.  The random adversary also models some
software defects involved in not "understanding" how to derive a truth
value for a given proposition.</p>
<h4 id="infantile-adversary"><a class="header" href="#infantile-adversary">Infantile Adversary</a></h4>
<p>Like a petulant child, an infantile adversary responds with the
opposite vote of the honest majority on an opinion.</p>
<h3 id="omniscient-adversaries"><a class="header" href="#omniscient-adversaries">Omniscient Adversaries</a></h3>
<p>Omniscient adversaries have somehow gained an "unfair" participation in
consensus by being able to control <code>f</code> of <code>N</code> nodes with a out-of-band
"supra-liminal" coordination mechanism.  Such adversaries use this
coordinated behavior to delay or sway honest majority consensus.</p>
<h4 id="passive-gossip-adversary"><a class="header" href="#passive-gossip-adversary">Passive Gossip Adversary</a></h4>
<p>The passive network omniscient adversary is fully aware at all times
of the network state. Such an adversary can always chose to vote in
the most efficient way to block the distributed consensus from
finalizing.</p>
<h4 id="active-gossip-adversary"><a class="header" href="#active-gossip-adversary">Active Gossip Adversary</a></h4>
<p>An omniscient gossip adversary somehow not only controls <code>f</code> of <code>N</code>
nodes, but has also has corrupted communications between nodes such
that she may inspect, delay, and drop arbitrary messages.  Such an
adversary uses capability to corrupt consensus away from honest
decisions to ones favorable to itself.  This adversary will, of
course, choose to participate in an honest manner until defecting is
most advantageous.</p>
<h3 id="future-directions"><a class="header" href="#future-directions">Future Directions</a></h3>
<p>Although we have proposed a normative description of the
implementation of the underlying binary consensus algorithm (Claro),
we believe we have prepared for analysis its adversarial performance
in a manner that is amenable to replacement by another member of the
<a href="nomos/deprecated/snow">snow*</a> family.</p>
<p>We have presumed the existence of a general family of algorithms that
can be counted on to vote on nodes in the DAG in a fair manner.
Avalanche provides an example of the construction of votes on UTXO
transactions.  One can express all state machine, i.e. account-based
models as checkpoints anchored in UTXO trust, so we believe that this
presupposition has some justification.  We can envision a need for
tooling abstraction that allow one to just program the DAG itself, as
they should be of stable interest no matter if Claro isn't.</p>
<h2 id="informative-references"><a class="header" href="#informative-references">Informative References</a></h2>
<ol start="0">
<li>
<p><a href="https://logos.co/">Logos</a></p>
</li>
<li>
<p><a href="https://dahliamalkhi.github.io/posts/2022/06/dag-bft/">On BFT Consensus Evolution: From Monolithic to
DAG</a></p>
</li>
<li>
<p><a href="https://ipfs.io/ipfs/QmUy4jh5mGNZvLkjies1RWM4YuvJh5o2FYopNPVYwrRVGV">snow-ipfs</a></p>
</li>
<li>
<p><a href="https://www.avalabs.org/whitepapers">snow*</a> The Snow family of
algorithms</p>
</li>
<li>
<p><a href="https://cloud.google.com/composer/docs/how-to/using/writing-dags">Move</a>
Move: a Language for Writing DAG Abstractions</p>
</li>
<li>
<p><a href="http://www.w3.org/1999/02/22-rdf-syntax-ns#">rdf</a></p>
</li>
<li>
<p><a href="http://www.w3.org/2000/01/rdf-schema#">rdfs</a></p>
</li>
<li>
<p><a href="http://www.w3.org/2001/XMLSchema#">xsd</a></p>
</li>
<li>
<p><a href="https://www.w3.org/TeamSubmission/n3/">n3-w3c-notes</a></p>
</li>
<li>
<p><a href="https://www.ntp.org/downloads.html">ntp</a></p>
</li>
</ol>
<h2 id="normative-references"><a class="header" href="#normative-references">Normative References</a></h2>
<ol start="0">
<li>
<p><a href="https://rdf.logos.co/protocol/Claro/1/0/0/raw">Claro</a></p>
</li>
<li>
<p><a href="https://www.w3.org/DesignIssues/Notation3.html">n3</a></p>
</li>
<li>
<p><a href="https://json-ld.org/">json-ld</a></p>
</li>
</ol>
<h2 id="copyright-53"><a class="header" href="#copyright-53">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/public">CC0</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="codex-rfcs"><a class="header" href="#codex-rfcs">Codex RFCs</a></h1>
<p>Specifications related the Codex decentralised data storage platform.
Visit <a href="https://github.com/codex-storage/codex-spec">Codex specs</a>
to view the new Codex specifications currently under discussion.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="codex-raw-specifications"><a class="header" href="#codex-raw-specifications">Codex Raw Specifications</a></h1>
<p>Early-stage Codex specifications collected before reaching draft status.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="codex-block-exchange"><a class="header" href="#codex-block-exchange">CODEX-BLOCK-EXCHANGE</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Codex Block Exchange Protocol</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Codex Team</td></tr>
<tr><th>Contributors</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-58"><a class="header" href="#timeline-58">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/codex/raw/codex-block-exchange.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/codex/raw/codex-block-exchange.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-12-12</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b2f35644a4ffd6ec871d1a0e73c62dbffedb93e2/codex/raw/codex-block-exchange.md"><code>b2f3564</code></a> — Improved codex/raw/codex-block-exchange.md file (#215)</li>
<li><strong>2025-11-19</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/63107d3830ae5d19c520923fde8fdfa7c89543b5/codex/raw/codex-block-exchange.md"><code>63107d3</code></a> — Created new codex/raw/codex-block-exchange.md file (#211)</li>
</ul>
<!-- timeline:end -->
<h2 id="specification-status"><a class="header" href="#specification-status">Specification Status</a></h2>
<p>This specification contains a mix of:</p>
<ul>
<li><strong>Verified protocol elements</strong>: Core message formats, protobuf structures, and addressing modes confirmed from implementation</li>
<li><strong>Design specifications</strong>: Payment flows, state machines, and negotiation strategies representing intended behavior</li>
<li><strong>Recommended values</strong>: Protocol limits and timeouts that serve as guidelines (actual implementations may vary)</li>
<li><strong>Pending verification</strong>: Some technical details (e.g., multicodec 0xCD02) require further validation</li>
</ul>
<p>Sections marked with notes indicate areas where implementation details may differ from this specification.</p>
<h2 id="abstract-33"><a class="header" href="#abstract-33">Abstract</a></h2>
<p>The Block Exchange (BE) is a core Codex component responsible for
peer-to-peer content distribution across the network.
It manages the sending and receiving of data blocks between nodes,
enabling efficient data sharing and retrieval.
This specification defines both an internal service interface and a
network protocol for referring to and providing data blocks.
Blocks are uniquely identifiable by means of an address and represent
fixed-length chunks of arbitrary data.</p>
<h2 id="semantics-3"><a class="header" href="#semantics-3">Semantics</a></h2>
<p>The keywords "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
document are to be interpreted as described in
<a href="https://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>.</p>
<h3 id="definitions-7"><a class="header" href="#definitions-7">Definitions</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Term</th><th>Description</th></tr></thead><tbody>
<tr><td><strong>Block</strong></td><td>Fixed-length chunk of arbitrary data, uniquely identifiable</td></tr>
<tr><td><strong>Standalone Block</strong></td><td>Self-contained block addressed by SHA256 hash (CID)</td></tr>
<tr><td><strong>Dataset Block</strong></td><td>Block in ordered set, addressed by dataset CID + index</td></tr>
<tr><td><strong>Block Address</strong></td><td>Unique identifier for standalone/dataset addressing</td></tr>
<tr><td><strong>WantList</strong></td><td>List of block requests sent by a peer</td></tr>
<tr><td><strong>Block Delivery</strong></td><td>Transmission of block data from one peer to another</td></tr>
<tr><td><strong>Block Presence</strong></td><td>Indicator of whether peer has requested block</td></tr>
<tr><td><strong>Merkle Proof</strong></td><td>Proof verifying dataset block position correctness</td></tr>
<tr><td><strong>CodexProof</strong></td><td>Codex-specific Merkle proof format verifying a block's position within a dataset tree</td></tr>
<tr><td><strong>Stream</strong></td><td>Bidirectional libp2p communication channel between two peers for exchanging messages</td></tr>
<tr><td><strong>Peer Context Store</strong></td><td>Internal data structure tracking active peer connections, their WantLists, and exchange state</td></tr>
<tr><td><strong>CID</strong></td><td>Content Identifier - hash-based identifier for content</td></tr>
<tr><td><strong>Multicodec</strong></td><td>Self-describing format identifier for data encoding</td></tr>
<tr><td><strong>Multihash</strong></td><td>Self-describing hash format</td></tr>
</tbody></table>
</div>
<h2 id="motivation-25"><a class="header" href="#motivation-25">Motivation</a></h2>
<p>The Block Exchange module serves as the fundamental layer for content
distribution in the Codex network.
It provides primitives for requesting and delivering blocks of data
between peers, supporting both standalone blocks and blocks that are
part of larger datasets.
The protocol is designed to work over libp2p streams and integrates
with Codex's discovery, storage, and payment systems.</p>
<p>When a peer wishes to obtain a block, it registers its unique address
with the Block Exchange, and the Block Exchange will then be in charge
of procuring it by finding a peer that has the block, if any, and then
downloading it.
The Block Exchange will also accept requests from peers which might
want blocks that the node has, and provide them.</p>
<p><strong>Discovery Separation:</strong> Throughout this specification we assume that
if a peer wants a block, then the peer has the means to locate and
connect to peers which either: (1) have the block; or (2) are
reasonably expected to obtain the block in the future.
In practical implementations, the Block Exchange will typically require
the support of an underlying discovery service, e.g., the Codex DHT,
to look up such peers, but this is beyond the scope of this document.</p>
<p>The protocol supports two distinct block types to accommodate different
use cases: standalone blocks for independent data chunks and dataset
blocks for ordered collections of data that form larger structures.</p>
<h2 id="block-format"><a class="header" href="#block-format">Block Format</a></h2>
<p>The Block Exchange protocol supports two types of blocks:</p>
<h3 id="standalone-blocks"><a class="header" href="#standalone-blocks">Standalone Blocks</a></h3>
<p>Standalone blocks are self-contained pieces of data addressed by their
SHA256 content identifier (CID).
These blocks are independent and do not reference any larger structure.</p>
<p><strong>Properties:</strong></p>
<ul>
<li>Addressed by content hash (SHA256)</li>
<li>Default size: 64 KiB</li>
<li>Self-contained and independently verifiable</li>
</ul>
<h3 id="dataset-blocks"><a class="header" href="#dataset-blocks">Dataset Blocks</a></h3>
<p>Dataset blocks are part of ordered sets and are addressed by a
<code>(datasetCID, index)</code> tuple.
The datasetCID refers to the Merkle tree root of the entire dataset,
and the index indicates the block's position within that dataset.</p>
<p>Formally, we can define a block as a tuple consisting of raw data and
its content identifier: <code>(data: seq[byte], cid: Cid)</code>, where standalone
blocks are addressed by <code>cid</code>, and dataset blocks can be addressed
either by <code>cid</code> or a <code>(datasetCID, index)</code> tuple.</p>
<p><strong>Properties:</strong></p>
<ul>
<li>Addressed by <code>(treeCID, index)</code> tuple</li>
<li>Part of a Merkle tree structure</li>
<li>Require Merkle proof for verification</li>
<li>Must be uniformly sized within a dataset</li>
<li>Final blocks MUST be zero-padded if incomplete</li>
</ul>
<h3 id="block-specifications"><a class="header" href="#block-specifications">Block Specifications</a></h3>
<p>All blocks in the Codex Block Exchange protocol adhere to the
following specifications:</p>
<div class="table-wrapper"><table><thead><tr><th>Property</th><th>Value</th><th>Description</th></tr></thead><tbody>
<tr><td>Default Block Size</td><td>64 KiB</td><td>Standard size for data blocks</td></tr>
<tr><td>Maximum Block Size</td><td>100 MiB</td><td>Upper limit for block data field</td></tr>
<tr><td>Multicodec</td><td><code>codex-block</code> (0xCD02)*</td><td>Format identifier</td></tr>
<tr><td>Multihash</td><td><code>sha2-256</code> (0x12)</td><td>Hash algorithm for addressing</td></tr>
<tr><td>Padding Requirement</td><td>Zero-padding</td><td>Incomplete final blocks padded</td></tr>
</tbody></table>
</div>
<p><strong>Note:</strong> *The multicodec value 0xCD02 is not currently registered in the official <a href="https://github.com/multiformats/multicodec/blob/master/table.csv">multiformats multicodec table</a>. This may be a reserved/private code pending official registration.</p>
<h3 id="protocol-limits"><a class="header" href="#protocol-limits">Protocol Limits</a></h3>
<p>To ensure network stability and prevent resource exhaustion, implementations
SHOULD enforce reasonable limits. The following are <strong>recommended values</strong>
(actual implementation limits may vary):</p>
<div class="table-wrapper"><table><thead><tr><th>Limit</th><th>Recommended Value</th><th>Description</th></tr></thead><tbody>
<tr><td><strong>Maximum Block Size</strong></td><td>100 MiB</td><td>Maximum size of block data in BlockDelivery</td></tr>
<tr><td><strong>Maximum WantList Size</strong></td><td>1000 entries</td><td>Maximum entries per WantList message</td></tr>
<tr><td><strong>Maximum Concurrent Requests</strong></td><td>256 per peer</td><td>Maximum simultaneous block requests per peer</td></tr>
<tr><td><strong>Stream Timeout</strong></td><td>60 seconds</td><td>Idle stream closure timeout</td></tr>
<tr><td><strong>Request Timeout</strong></td><td>300 seconds</td><td>Maximum time to fulfill a block request</td></tr>
<tr><td><strong>Maximum Message Size</strong></td><td>105 MiB</td><td>Maximum total message size (protobuf)</td></tr>
<tr><td><strong>Maximum Pending Bytes</strong></td><td>10 GiB</td><td>Maximum pending data per peer connection</td></tr>
</tbody></table>
</div>
<p><strong>Note:</strong> These values are <strong>not verified from implementation</strong> and serve as
reasonable guidelines. Actual implementations MAY use different limits based
on their resource constraints and deployment requirements.</p>
<p><strong>Enforcement:</strong></p>
<ul>
<li>Implementations MUST reject messages exceeding their configured size limits</li>
<li>Implementations SHOULD track per-peer request counts</li>
<li>Implementations SHOULD close streams exceeding configured timeout limits</li>
<li>Implementations MAY implement stricter or more lenient limits based on local resources</li>
</ul>
<h2 id="service-interface"><a class="header" href="#service-interface">Service Interface</a></h2>
<p>The Block Exchange module exposes two core primitives for
block management:</p>
<h3 id="requestblock"><a class="header" href="#requestblock"><code>requestBlock</code></a></h3>
<pre><code class="language-python">async def requestBlock(address: BlockAddress) -&gt; Block
</code></pre>
<p>Registers a block address for retrieval and returns the block data
when available.
This function can be awaited by the caller until the block is retrieved
from the network or local storage.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>address</code>: BlockAddress - The unique address identifying the block
to retrieve</li>
</ul>
<p><strong>Returns:</strong></p>
<ul>
<li><code>Block</code> - The retrieved block data</li>
</ul>
<h3 id="cancelrequest"><a class="header" href="#cancelrequest"><code>cancelRequest</code></a></h3>
<pre><code class="language-python">async def cancelRequest(address: BlockAddress) -&gt; bool
</code></pre>
<p>Cancels a previously registered block request.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>address</code>: BlockAddress - The address of the block request to cancel</li>
</ul>
<p><strong>Returns:</strong></p>
<ul>
<li><code>bool</code> - True if the cancellation was successful, False otherwise</li>
</ul>
<h2 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h2>
<p>The Block Exchange module depends on and interacts with several other
Codex components:</p>
<div class="table-wrapper"><table><thead><tr><th>Component</th><th>Purpose</th></tr></thead><tbody>
<tr><td><strong>Discovery Module</strong></td><td>DHT-based peer discovery for locating nodes</td></tr>
<tr><td><strong>Local Store (Repo)</strong></td><td>Persistent block storage for local blocks</td></tr>
<tr><td><strong>Advertiser</strong></td><td>Announces block availability to the network</td></tr>
<tr><td><strong>Network Layer</strong></td><td>libp2p connections and stream management</td></tr>
</tbody></table>
</div>
<h2 id="protocol-specification"><a class="header" href="#protocol-specification">Protocol Specification</a></h2>
<h3 id="protocol-identifier"><a class="header" href="#protocol-identifier">Protocol Identifier</a></h3>
<p>The Block Exchange protocol uses the following libp2p protocol
identifier:</p>
<pre><code class="language-text">/codex/blockexc/1.0.0
</code></pre>
<h3 id="version-negotiation"><a class="header" href="#version-negotiation">Version Negotiation</a></h3>
<p>The protocol version is negotiated through libp2p's multistream-select
protocol during connection establishment. The following describes standard
libp2p version negotiation behavior; actual Codex implementation details
may vary.</p>
<h4 id="protocol-versioning"><a class="header" href="#protocol-versioning">Protocol Versioning</a></h4>
<p><strong>Version Format</strong>: <code>/codex/blockexc/&lt;major&gt;.&lt;minor&gt;.&lt;patch&gt;</code></p>
<ul>
<li><strong>Major version</strong>: Incompatible protocol changes</li>
<li><strong>Minor version</strong>: Backward-compatible feature additions</li>
<li><strong>Patch version</strong>: Backward-compatible bug fixes</li>
</ul>
<p><strong>Current Version</strong>: <code>1.0.0</code></p>
<h4 id="version-negotiation-process"><a class="header" href="#version-negotiation-process">Version Negotiation Process</a></h4>
<pre><code class="language-text">1. Initiator opens stream
2. Initiator proposes: "/codex/blockexc/1.0.0"
3. Responder checks supported versions
4. If supported:
     Responder accepts: "/codex/blockexc/1.0.0"
     → Connection established
5. If not supported:
     Responder rejects with: "na" (not available)
     → Try fallback version or close connection
</code></pre>
<h4 id="compatibility-rules"><a class="header" href="#compatibility-rules">Compatibility Rules</a></h4>
<p><strong>Major Version Compatibility:</strong></p>
<ul>
<li>Major version <code>1.x.x</code> is incompatible with <code>2.x.x</code></li>
<li>Nodes MUST support only their major version</li>
<li>Cross-major-version communication requires protocol upgrade</li>
</ul>
<p><strong>Minor Version Compatibility:</strong></p>
<ul>
<li>Version <code>1.1.0</code> MUST be backward compatible with <code>1.0.0</code></li>
<li>Newer minors MAY include optional features</li>
<li>Older nodes ignore unknown message fields (protobuf semantics)</li>
</ul>
<p><strong>Patch Version Compatibility:</strong></p>
<ul>
<li>All patches within same minor version are fully compatible</li>
<li>Patches fix bugs without changing protocol behavior</li>
</ul>
<h4 id="multi-version-support"><a class="header" href="#multi-version-support">Multi-Version Support</a></h4>
<p>Implementations MAY support multiple protocol versions simultaneously:</p>
<pre><code class="language-text">Supported protocols (in preference order):
  1. /codex/blockexc/1.2.0  (preferred, latest features)
  2. /codex/blockexc/1.1.0  (fallback, stable)
  3. /codex/blockexc/1.0.0  (legacy support)
</code></pre>
<p><strong>Negotiation Strategy:</strong></p>
<ol>
<li>Propose highest supported version first</li>
<li>If rejected, try next lower version</li>
<li>If all rejected, connection fails</li>
<li>Track peer's supported version for future connections</li>
</ol>
<h4 id="feature-detection"><a class="header" href="#feature-detection">Feature Detection</a></h4>
<p>For optional features within same major.minor version:</p>
<pre><code class="language-text">Method 1: Message field presence
  - Send message with optional field
  - Peer ignores if not supported (protobuf default)

Method 2: Capability exchange (future extension)
  - Exchange capability bitmask in initial message
  - Enable features only if both peers support
</code></pre>
<h4 id="version-upgrade-path"><a class="header" href="#version-upgrade-path">Version Upgrade Path</a></h4>
<p><strong>Backward Compatibility:</strong></p>
<ul>
<li>New versions MUST handle messages from older versions</li>
<li>Unknown message fields silently ignored</li>
<li>Unknown WantList flags ignored</li>
<li>Unknown BlockPresence types treated as DontHave</li>
</ul>
<p><strong>Forward Compatibility:</strong></p>
<ul>
<li>Older versions MAY ignore new message types</li>
<li>Critical features require major version bump</li>
<li>Optional features use minor version bump</li>
</ul>
<h3 id="connection-model"><a class="header" href="#connection-model">Connection Model</a></h3>
<p>The protocol operates over libp2p streams.
When a node wants to communicate with a peer:</p>
<ol>
<li>The initiating node dials the peer using the protocol identifier</li>
<li>A bidirectional stream is established</li>
<li>Both sides can send and receive messages on this stream</li>
<li>Messages are encoded using Protocol Buffers</li>
<li>The stream remains open for the duration of the exchange session</li>
<li>Peers track active connections in a peer context store</li>
</ol>
<p>The protocol handles peer lifecycle events:</p>
<ul>
<li><strong>Peer Joined</strong>: When a peer connects, it is added to the active
peer set</li>
<li><strong>Peer Departed</strong>: When a peer disconnects gracefully, its context
is cleaned up</li>
<li><strong>Peer Dropped</strong>: When a peer connection fails, it is removed from
the active set</li>
</ul>
<h3 id="message-flow-examples"><a class="header" href="#message-flow-examples">Message Flow Examples</a></h3>
<p>This section illustrates typical message exchange sequences for common
block exchange scenarios.</p>
<h4 id="example-1-standalone-block-request"><a class="header" href="#example-1-standalone-block-request">Example 1: Standalone Block Request</a></h4>
<p><strong>Scenario</strong>: Node A requests a standalone block from Node B</p>
<pre><code class="language-text">Node A                                    Node B
  |                                         |
  |--- Message(wantlist) ------------------&gt;|
  |    wantlist.entries[0]:                 |
  |      address.cid = QmABC123              |
  |      wantType = wantBlock               |
  |      priority = 0                       |
  |                                         |
  |&lt;-- Message(blockPresences, payload) ----|
  |    blockPresences[0]:                   |
  |      address.cid = QmABC123              |
  |      type = presenceHave                |
  |    payload[0]:                          |
  |      cid = QmABC123                      |
  |      data = &lt;64 KiB block data&gt;         |
  |      address.cid = QmABC123              |
  |                                         |
</code></pre>
<p><strong>Steps:</strong></p>
<ol>
<li>Node A sends WantList requesting block with <code>wantType = wantBlock</code></li>
<li>Node B checks local storage, finds block</li>
<li>Node B responds with BlockPresence confirming availability</li>
<li>Node B includes BlockDelivery with actual block data</li>
<li>Node A verifies CID matches SHA256(data)</li>
<li>Node A stores block locally</li>
</ol>
<h4 id="example-2-dataset-block-request-with-merkle-proof"><a class="header" href="#example-2-dataset-block-request-with-merkle-proof">Example 2: Dataset Block Request with Merkle Proof</a></h4>
<p><strong>Scenario</strong>: Node A requests a dataset block from Node B</p>
<pre><code class="language-text">Node A                                    Node B
  |                                         |
  |--- Message(wantlist) ------------------&gt;|
  |    wantlist.entries[0]:                 |
  |      address.leaf = true                |
  |      address.treeCid = QmTree456         |
  |      address.index = 42                 |
  |      wantType = wantBlock               |
  |                                         |
  |&lt;-- Message(payload) ---------------------|
  |    payload[0]:                          |
  |      cid = QmBlock789                    |
  |      data = &lt;64 KiB zero-padded data&gt;   |
  |      address.leaf = true                |
  |      address.treeCid = QmTree456         |
  |      address.index = 42                 |
  |      proof = &lt;CodexProof bytes&gt;         |
  |                                         |
</code></pre>
<p><strong>Steps:</strong></p>
<ol>
<li>Node A sends WantList for dataset block at specific index</li>
<li>Node B locates block in dataset</li>
<li>Node B generates CodexProof for block position in Merkle tree</li>
<li>Node B delivers block with proof</li>
<li>Node A verifies proof against treeCid</li>
<li>Node A verifies block data integrity</li>
<li>Node A stores block with dataset association</li>
</ol>
<h4 id="example-3-block-presence-check-wanthave"><a class="header" href="#example-3-block-presence-check-wanthave">Example 3: Block Presence Check (wantHave)</a></h4>
<p><strong>Scenario</strong>: Node A checks if Node B has a block without requesting full data</p>
<pre><code class="language-text">Node A                                    Node B
  |                                         |
  |--- Message(wantlist) ------------------&gt;|
  |    wantlist.entries[0]:                 |
  |      address.cid = QmCheck999            |
  |      wantType = wantHave                |
  |      sendDontHave = true                |
  |                                         |
  |&lt;-- Message(blockPresences) -------------|
  |    blockPresences[0]:                   |
  |      address.cid = QmCheck999            |
  |      type = presenceHave                |
  |      price = 0x00 (free)                |
  |                                         |
</code></pre>
<p><strong>Steps:</strong></p>
<ol>
<li>Node A sends WantList with <code>wantType = wantHave</code></li>
<li>Node B checks local storage without loading block data</li>
<li>Node B responds with BlockPresence only (no payload)</li>
<li>Node A updates peer availability map</li>
<li>If Node A decides to request, sends new WantList with <code>wantType = wantBlock</code></li>
</ol>
<h4 id="example-4-block-not-available"><a class="header" href="#example-4-block-not-available">Example 4: Block Not Available</a></h4>
<p><strong>Scenario</strong>: Node A requests block Node B doesn't have</p>
<pre><code class="language-text">Node A                                    Node B
  |                                         |
  |--- Message(wantlist) ------------------&gt;|
  |    wantlist.entries[0]:                 |
  |      address.cid = QmMissing111          |
  |      wantType = wantBlock               |
  |      sendDontHave = true                |
  |                                         |
  |&lt;-- Message(blockPresences) -------------|
  |    blockPresences[0]:                   |
  |      address.cid = QmMissing111          |
  |      type = presenceDontHave            |
  |                                         |
</code></pre>
<p><strong>Steps:</strong></p>
<ol>
<li>Node A requests block with <code>sendDontHave = true</code></li>
<li>Node B checks storage, block not found</li>
<li>Node B sends BlockPresence with <code>presenceDontHave</code></li>
<li>Node A removes Node B from candidates for this block</li>
<li>Node A queries discovery service for alternative peers</li>
</ol>
<h4 id="example-5-wantlist-cancellation"><a class="header" href="#example-5-wantlist-cancellation">Example 5: WantList Cancellation</a></h4>
<p><strong>Scenario</strong>: Node A cancels a previous block request</p>
<pre><code class="language-text">Node A                                    Node B
  |                                         |
  |--- Message(wantlist) ------------------&gt;|
  |    wantlist.entries[0]:                 |
  |      address.cid = QmCancel222           |
  |      cancel = true                      |
  |                                         |
</code></pre>
<p><strong>Steps:</strong></p>
<ol>
<li>Node A sends WantList entry with <code>cancel = true</code></li>
<li>Node B removes block request from peer's want queue</li>
<li>Node B stops any pending block transfer for this address</li>
<li>No response message required for cancellation</li>
</ol>
<h4 id="example-6-delta-wantlist-update"><a class="header" href="#example-6-delta-wantlist-update">Example 6: Delta WantList Update</a></h4>
<p><strong>Scenario</strong>: Node A adds requests to existing WantList</p>
<pre><code class="language-text">Node A                                    Node B
  |                                         |
  |--- Message(wantlist) ------------------&gt;|
  |    wantlist.full = false                |
  |    wantlist.entries[0]:                 |
  |      address.cid = QmNew1                |
  |      wantType = wantBlock               |
  |    wantlist.entries[1]:                 |
  |      address.cid = QmNew2                |
  |      wantType = wantBlock               |
  |                                         |
</code></pre>
<p><strong>Steps:</strong></p>
<ol>
<li>Node A sends WantList with <code>full = false</code> (delta update)</li>
<li>Node B merges entries with existing WantList for Node A</li>
<li>Node B begins processing new requests</li>
<li>Previous WantList entries remain active</li>
</ol>
<h3 id="sequence-diagrams"><a class="header" href="#sequence-diagrams">Sequence Diagrams</a></h3>
<p>These diagrams illustrate the complete flow of block exchange operations
including service interface, peer discovery, and network protocol interactions.</p>
<h4 id="complete-block-request-flow"><a class="header" href="#complete-block-request-flow">Complete Block Request Flow</a></h4>
<p>The protocol supports two strategies for WantBlock requests,
each with different trade-offs.
Implementations may choose the strategy based on network conditions,
peer availability, and resource constraints.</p>
<h5 id="strategy-1-parallel-request-low-latency"><a class="header" href="#strategy-1-parallel-request-low-latency">Strategy 1: Parallel Request (Low Latency)</a></h5>
<p>In this strategy, the requester sends <code>wantType = wantBlock</code> to all
discovered peers simultaneously.
This minimizes latency as the first peer to respond with the block
data wins, but it wastes bandwidth since multiple peers may send
the same block data.</p>
<p><strong>Trade-offs:</strong></p>
<ul>
<li><strong>Pro</strong>: Lowest latency - block arrives as soon as any peer can deliver it</li>
<li><strong>Pro</strong>: More resilient to slow or unresponsive peers</li>
<li><strong>Con</strong>: Bandwidth-wasteful - multiple peers may send duplicate data</li>
<li><strong>Con</strong>: Higher network overhead for the requester</li>
<li><strong>Best for</strong>: Time-critical data retrieval, unreliable networks</li>
</ul>
<pre><code class="language-mermaid">sequenceDiagram
    participant Client
    participant BlockExchange
    participant LocalStore
    participant Discovery
    participant PeerA
    participant PeerB
    participant PeerC

    Client-&gt;&gt;BlockExchange: requestBlock(address)
    BlockExchange-&gt;&gt;LocalStore: checkBlock(address)
    LocalStore--&gt;&gt;BlockExchange: Not found

    BlockExchange-&gt;&gt;Discovery: findPeers(address)
    Discovery--&gt;&gt;BlockExchange: [PeerA, PeerB, PeerC]

    par Send wantBlock to all peers
        BlockExchange-&gt;&gt;PeerA: Message(wantlist: wantBlock)
        BlockExchange-&gt;&gt;PeerB: Message(wantlist: wantBlock)
        BlockExchange-&gt;&gt;PeerC: Message(wantlist: wantBlock)
    end

    Note over PeerA,PeerC: All peers start preparing block data

    PeerB--&gt;&gt;BlockExchange: Message(payload: BlockDelivery)
    Note over BlockExchange: First response wins

    BlockExchange-&gt;&gt;BlockExchange: Verify block
    BlockExchange-&gt;&gt;LocalStore: Store block

    par Cancel requests to other peers
        BlockExchange-&gt;&gt;PeerA: Message(wantlist: cancel)
        BlockExchange-&gt;&gt;PeerC: Message(wantlist: cancel)
    end

    Note over PeerA,PeerC: May have already sent data (wasted bandwidth)

    BlockExchange--&gt;&gt;Client: Return block
</code></pre>
<h5 id="strategy-2-two-phase-discovery-bandwidth-efficient"><a class="header" href="#strategy-2-two-phase-discovery-bandwidth-efficient">Strategy 2: Two-Phase Discovery (Bandwidth Efficient)</a></h5>
<p>In this strategy, the requester first sends <code>wantType = wantHave</code> to
discover which peers have the block, then sends <code>wantType = wantBlock</code>
only to a single selected peer.
This conserves bandwidth but adds an extra round-trip of latency.</p>
<p><strong>Trade-offs:</strong></p>
<ul>
<li><strong>Pro</strong>: Bandwidth-efficient - only one peer sends block data</li>
<li><strong>Pro</strong>: Enables price comparison before committing to a peer</li>
<li><strong>Pro</strong>: Allows selection based on peer reputation or proximity</li>
<li><strong>Con</strong>: Higher latency due to extra round-trip for presence check</li>
<li><strong>Con</strong>: Selected peer may become unavailable between phases</li>
<li><strong>Best for</strong>: Large blocks, paid content, bandwidth-constrained networks</li>
</ul>
<pre><code class="language-mermaid">sequenceDiagram
    participant Client
    participant BlockExchange
    participant LocalStore
    participant Discovery
    participant PeerA
    participant PeerB
    participant PeerC

    Client-&gt;&gt;BlockExchange: requestBlock(address)
    BlockExchange-&gt;&gt;LocalStore: checkBlock(address)
    LocalStore--&gt;&gt;BlockExchange: Not found

    BlockExchange-&gt;&gt;Discovery: findPeers(address)
    Discovery--&gt;&gt;BlockExchange: [PeerA, PeerB, PeerC]

    Note over BlockExchange: Phase 1: Discovery

    par Send wantHave to all peers
        BlockExchange-&gt;&gt;PeerA: Message(wantlist: wantHave)
        BlockExchange-&gt;&gt;PeerB: Message(wantlist: wantHave)
        BlockExchange-&gt;&gt;PeerC: Message(wantlist: wantHave)
    end

    PeerA--&gt;&gt;BlockExchange: BlockPresence(presenceDontHave)
    PeerB--&gt;&gt;BlockExchange: BlockPresence(presenceHave, price=X)
    PeerC--&gt;&gt;BlockExchange: BlockPresence(presenceHave, price=Y)

    BlockExchange-&gt;&gt;BlockExchange: Select best peer (PeerB: lower price)

    Note over BlockExchange: Phase 2: Retrieval

    BlockExchange-&gt;&gt;PeerB: Message(wantlist: wantBlock)
    PeerB--&gt;&gt;BlockExchange: Message(payload: BlockDelivery)

    BlockExchange-&gt;&gt;BlockExchange: Verify block
    BlockExchange-&gt;&gt;LocalStore: Store block
    BlockExchange--&gt;&gt;Client: Return block
</code></pre>
<h5 id="hybrid-approach"><a class="header" href="#hybrid-approach">Hybrid Approach</a></h5>
<p>Implementations MAY combine both strategies:</p>
<ol>
<li>Use two-phase discovery for large blocks or paid content</li>
<li>Use parallel requests for small blocks or time-critical data</li>
<li>Adaptively switch strategies based on network conditions</li>
</ol>
<pre><code class="language-mermaid">flowchart TD
    A[Block Request] --&gt; B{Block Size?}
    B --&gt;|Small &lt; 64 KiB| C[Parallel Strategy]
    B --&gt;|Large &gt;= 64 KiB| D{Paid Content?}
    D --&gt;|Yes| E[Two-Phase Discovery]
    D --&gt;|No| F{Network Condition?}
    F --&gt;|Reliable| E
    F --&gt;|Unreliable| C
    C --&gt; G[Return Block]
    E --&gt; G
</code></pre>
<h4 id="dataset-block-verification-flow"><a class="header" href="#dataset-block-verification-flow">Dataset Block Verification Flow</a></h4>
<pre><code class="language-mermaid">sequenceDiagram
    participant Requester
    participant Provider
    participant Verifier

    Requester-&gt;&gt;Provider: WantList(leaf=true, treeCid, index)
    Provider-&gt;&gt;Provider: Load block at index
    Provider-&gt;&gt;Provider: Generate CodexProof
    Provider-&gt;&gt;Requester: BlockDelivery(data, proof)

    Requester-&gt;&gt;Verifier: Verify proof

    alt Proof valid
        Verifier--&gt;&gt;Requester: Valid
        Requester-&gt;&gt;Requester: Verify CID
        alt CID matches
            Requester-&gt;&gt;Requester: Store block
            Requester--&gt;&gt;Requester: Success
        else CID mismatch
            Requester-&gt;&gt;Requester: Reject block
            Requester-&gt;&gt;Provider: Disconnect
        end
    else Proof invalid
        Verifier--&gt;&gt;Requester: Invalid
        Requester-&gt;&gt;Requester: Reject block
        Requester-&gt;&gt;Provider: Disconnect
    end
</code></pre>
<h4 id="payment-flow-with-state-channels"><a class="header" href="#payment-flow-with-state-channels">Payment Flow with State Channels</a></h4>
<pre><code class="language-mermaid">sequenceDiagram
    participant Buyer
    participant Seller
    participant StateChannel

    Buyer-&gt;&gt;Seller: Message(wantlist)
    Seller-&gt;&gt;Seller: Check block availability
    Seller-&gt;&gt;Buyer: BlockPresence(price)

    alt Buyer accepts price
        Buyer-&gt;&gt;StateChannel: Create update
        StateChannel--&gt;&gt;Buyer: Signed state
        Buyer-&gt;&gt;Seller: Message(payment: StateChannelUpdate)
        Seller-&gt;&gt;StateChannel: Verify update

        alt Payment valid
            StateChannel--&gt;&gt;Seller: Valid
            Seller-&gt;&gt;Buyer: BlockDelivery(data)
            Buyer-&gt;&gt;Buyer: Verify block
            Buyer-&gt;&gt;StateChannel: Finalize
        else Payment invalid
            StateChannel--&gt;&gt;Seller: Invalid
            Seller-&gt;&gt;Buyer: BlockPresence(price)
        end
    else Buyer rejects price
        Buyer-&gt;&gt;Seller: Message(wantlist.cancel)
    end
</code></pre>
<h4 id="peer-lifecycle-management"><a class="header" href="#peer-lifecycle-management">Peer Lifecycle Management</a></h4>
<pre><code class="language-mermaid">sequenceDiagram
    participant Network
    participant BlockExchange
    participant PeerStore
    participant Peer

    Network-&gt;&gt;BlockExchange: PeerJoined(Peer)
    BlockExchange-&gt;&gt;PeerStore: AddPeer(Peer)
    BlockExchange-&gt;&gt;Peer: Open stream

    loop Active exchange
        BlockExchange-&gt;&gt;Peer: Message(wantlist/payload)
        Peer-&gt;&gt;BlockExchange: Message(payload/presence)
    end

    alt Graceful disconnect
        Peer-&gt;&gt;BlockExchange: Close stream
        BlockExchange-&gt;&gt;PeerStore: RemovePeer(Peer)
    else Connection failure
        Network-&gt;&gt;BlockExchange: PeerDropped(Peer)
        BlockExchange-&gt;&gt;PeerStore: RemovePeer(Peer)
        BlockExchange-&gt;&gt;BlockExchange: Requeue pending requests
    end
</code></pre>
<h3 id="message-format"><a class="header" href="#message-format">Message Format</a></h3>
<p>All messages use Protocol Buffers encoding for serialization.
The main message structure supports multiple operation types in a
single message.</p>
<h4 id="main-message-structure"><a class="header" href="#main-message-structure">Main Message Structure</a></h4>
<pre><code class="language-protobuf">message Message {
  Wantlist wantlist = 1;
  // Field 2 reserved for future use
  repeated BlockDelivery payload = 3;
  repeated BlockPresence blockPresences = 4;
  int32 pendingBytes = 5;
  AccountMessage account = 6;
  StateChannelUpdate payment = 7;
}
</code></pre>
<p><strong>Fields:</strong></p>
<ul>
<li><code>wantlist</code>: Block requests from the sender</li>
<li>Field 2: Reserved (unused, see note below)</li>
<li><code>payload</code>: Block deliveries (actual block data)</li>
<li><code>blockPresences</code>: Availability indicators for requested blocks</li>
<li><code>pendingBytes</code>: Number of bytes pending delivery</li>
<li><code>account</code>: Account information for micropayments</li>
<li><code>payment</code>: State channel update for payment processing</li>
</ul>
<p><strong>Note on Missing Field 2:</strong></p>
<p>Field number 2 is intentionally skipped in the Message protobuf definition.
This is a common protobuf practice for several reasons:</p>
<ul>
<li><strong>Protocol Evolution</strong>: Field 2 may have been used in earlier versions and
removed, with the field number reserved to prevent reuse</li>
<li><strong>Forward Compatibility</strong>: Reserving field numbers ensures old clients can
safely ignore new fields</li>
<li><strong>Implementation History</strong>: May have been used during development and removed
before final release</li>
</ul>
<p>The gap does not affect protocol operation. Protobuf field numbers need not be
sequential, and skipping numbers is standard practice for protocol evolution.</p>
<h4 id="block-address"><a class="header" href="#block-address">Block Address</a></h4>
<p>The BlockAddress structure supports both standalone and dataset
block addressing:</p>
<pre><code class="language-protobuf">message BlockAddress {
  bool leaf = 1;
  bytes treeCid = 2;    // Present when leaf = true
  uint64 index = 3;     // Present when leaf = true
  bytes cid = 4;        // Present when leaf = false
}
</code></pre>
<p><strong>Fields:</strong></p>
<ul>
<li><code>leaf</code>: Indicates if this is dataset block (true) or standalone
(false)</li>
<li><code>treeCid</code>: Merkle tree root CID (present when <code>leaf = true</code>)</li>
<li><code>index</code>: Position of block within dataset (present when <code>leaf = true</code>)</li>
<li><code>cid</code>: Content identifier of the block (present when <code>leaf = false</code>)</li>
</ul>
<p><strong>Addressing Modes:</strong></p>
<ul>
<li><strong>Standalone Block</strong> (<code>leaf = false</code>): Direct CID reference to a
standalone content block</li>
<li><strong>Dataset Block</strong> (<code>leaf = true</code>): Reference to a block within an
ordered set, identified by a Merkle tree root and an index.
The Merkle root may refer to either a regular dataset, or a dataset
that has undergone erasure-coding</li>
</ul>
<h4 id="wantlist"><a class="header" href="#wantlist">WantList</a></h4>
<p>The WantList communicates which blocks a peer desires to receive:</p>
<pre><code class="language-protobuf">message Wantlist {
  enum WantType {
    wantBlock = 0;
    wantHave = 1;
  }

  message Entry {
    BlockAddress address = 1;
    int32 priority = 2;
    bool cancel = 3;
    WantType wantType = 4;
    bool sendDontHave = 5;
  }

  repeated Entry entries = 1;
  bool full = 2;
}
</code></pre>
<p><strong>WantType Values:</strong></p>
<ul>
<li><code>wantBlock (0)</code>: Request full block delivery</li>
<li><code>wantHave (1)</code>: Request availability information only (presence check)</li>
</ul>
<p><strong>Entry Fields:</strong></p>
<ul>
<li><code>address</code>: The block being requested</li>
<li><code>priority</code>: Request priority (currently always 0, reserved for future use)</li>
<li><code>cancel</code>: If true, cancels a previous want for this block</li>
<li><code>wantType</code>: Specifies whether full block or presence is desired
<ul>
<li><code>wantHave (1)</code>: Only check if peer has the block</li>
<li><code>wantBlock (0)</code>: Request full block data</li>
</ul>
</li>
<li><code>sendDontHave</code>: If true, peer should respond even if it doesn't have
the block</li>
</ul>
<p><strong>Priority Field Clarification:</strong></p>
<p>The <code>priority</code> field is currently fixed at <code>0</code> in all implementations and is
reserved for future protocol extensions. Originally intended for request
prioritization, this feature is not yet implemented.</p>
<p><strong>Current Behavior:</strong></p>
<ul>
<li>All WantList entries use <code>priority = 0</code></li>
<li>Implementations MUST accept priority values but MAY ignore them</li>
<li>Blocks are processed in order received, not by priority</li>
</ul>
<p><strong>Future Extensions:</strong></p>
<p>The priority field is reserved for:</p>
<ul>
<li><strong>Bandwidth Management</strong>: Higher priority blocks served first during congestion</li>
<li><strong>Time-Critical Data</strong>: Urgent blocks (e.g., recent dataset indices) prioritized</li>
<li><strong>Fair Queueing</strong>: Priority-based scheduling across multiple peers</li>
<li><strong>QoS Tiers</strong>: Different service levels based on payment/reputation</li>
</ul>
<p><strong>Implementation Notes:</strong></p>
<ul>
<li>Senders SHOULD set <code>priority = 0</code> for compatibility</li>
<li>Receivers MUST NOT reject messages with non-zero priority</li>
<li>Future protocol versions may activate priority-based scheduling</li>
<li>When activated, higher priority values = higher priority (0 = lowest)</li>
</ul>
<p><strong>WantList Fields:</strong></p>
<ul>
<li><code>entries</code>: List of block requests</li>
<li><code>full</code>: If true, replaces all previous entries; if false, delta update</li>
</ul>
<p><strong>Delta Updates:</strong></p>
<p>WantLists support delta updates for efficiency.
When <code>full = false</code>, entries represent additions or modifications to
the existing WantList rather than a complete replacement.</p>
<h4 id="block-delivery"><a class="header" href="#block-delivery">Block Delivery</a></h4>
<p>Block deliveries contain the actual block data along with verification
information:</p>
<pre><code class="language-protobuf">message BlockDelivery {
  bytes cid = 1;
  bytes data = 2;
  BlockAddress address = 3;
  bytes proof = 4;
}
</code></pre>
<p><strong>Fields:</strong></p>
<ul>
<li><code>cid</code>: Content identifier of the block</li>
<li><code>data</code>: Raw block data (up to 100 MiB)</li>
<li><code>address</code>: The BlockAddress identifying this block</li>
<li><code>proof</code>: Merkle proof (CodexProof) verifying block correctness
(required for dataset blocks)</li>
</ul>
<p><strong>Merkle Proof Verification:</strong></p>
<p>When delivering dataset blocks (<code>address.leaf = true</code>):</p>
<ul>
<li>The delivery MUST include a Merkle proof (CodexProof)</li>
<li>The proof verifies that the block at the given index is correctly
part of the Merkle tree identified by the tree CID</li>
<li>This applies to all datasets, irrespective of whether they have been
erasure-coded or not</li>
<li>Recipients MUST verify the proof before accepting the block</li>
<li>Invalid proofs result in block rejection</li>
</ul>
<h4 id="block-presence"><a class="header" href="#block-presence">Block Presence</a></h4>
<p>Block presence messages indicate whether a peer has or does not have a
requested block:</p>
<pre><code class="language-protobuf">enum BlockPresenceType {
  presenceHave = 0;
  presenceDontHave = 1;
}

message BlockPresence {
  BlockAddress address = 1;
  BlockPresenceType type = 2;
  bytes price = 3;
}
</code></pre>
<p><strong>Fields:</strong></p>
<ul>
<li><code>address</code>: The block address being referenced</li>
<li><code>type</code>: Whether the peer has the block or not</li>
<li><code>price</code>: Price in wei (UInt256 format, see below)</li>
</ul>
<p><strong>UInt256 Price Format:</strong></p>
<p>The <code>price</code> field encodes a 256-bit unsigned integer representing the cost in
wei (the smallest Ethereum denomination, where 1 ETH = 10^18 wei).</p>
<p><strong>Encoding Specification:</strong></p>
<ul>
<li><strong>Format</strong>: 32 bytes, big-endian byte order</li>
<li><strong>Type</strong>: Unsigned 256-bit integer</li>
<li><strong>Range</strong>: 0 to 2^256 - 1</li>
<li><strong>Zero Price</strong>: <code>0x0000000000000000000000000000000000000000000000000000000000000000</code>
(block is free)</li>
</ul>
<p><strong>Examples:</strong></p>
<pre><code class="language-text">Free (0 wei):
  0x0000000000000000000000000000000000000000000000000000000000000000

1 wei:
  0x0000000000000000000000000000000000000000000000000000000000000001

1 gwei (10^9 wei):
  0x000000000000000000000000000000000000000000000000000000003b9aca00

0.001 ETH (10^15 wei):
  0x00000000000000000000000000000000000000000000000000038d7ea4c68000

1 ETH (10^18 wei):
  0x0000000000000000000000000000000000000000000000000de0b6b3a7640000

Maximum (2^256 - 1):
  0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
</code></pre>
<p><strong>Conversion Logic:</strong></p>
<pre><code class="language-python"># Wei to bytes (big-endian)
def wei_to_bytes(amount_wei: int) -&gt; bytes:
    return amount_wei.to_bytes(32, byteorder='big')

# Bytes to wei
def bytes_to_wei(price_bytes: bytes) -&gt; int:
    return int.from_bytes(price_bytes, byteorder='big')

# ETH to wei to bytes
def eth_to_price_bytes(amount_eth: float) -&gt; bytes:
    amount_wei = int(amount_eth * 10**18)
    return wei_to_bytes(amount_wei)
</code></pre>
<h4 id="payment-messages"><a class="header" href="#payment-messages">Payment Messages</a></h4>
<p>Payment-related messages for micropayments using Nitro state channels.</p>
<p><strong>Account Message:</strong></p>
<pre><code class="language-protobuf">message AccountMessage {
  bytes address = 1;  // Ethereum address to which payments should be made
}
</code></pre>
<p><strong>Fields:</strong></p>
<ul>
<li><code>address</code>: Ethereum address for receiving payments</li>
</ul>
<h3 id="concrete-message-examples"><a class="header" href="#concrete-message-examples">Concrete Message Examples</a></h3>
<p>This section provides real-world examples of protobuf messages for different
block exchange scenarios.</p>
<h4 id="example-1-simple-standalone-block-request"><a class="header" href="#example-1-simple-standalone-block-request">Example 1: Simple Standalone Block Request</a></h4>
<p><strong>Scenario</strong>: Request a single standalone block</p>
<p><strong>Protobuf (wire format representation):</strong></p>
<pre><code class="language-protobuf">Message {
  wantlist: Wantlist {
    entries: [
      Entry {
        address: BlockAddress {
          leaf: false
          cid: 0x0155a0e40220b94d27b9934d3e08a52e52d7da7dabfac484efe37a5380ee9088f7ace2efcde9  // CID bytes
        }
        priority: 0
        cancel: false
        wantType: wantBlock  // 0
        sendDontHave: true
      }
    ]
    full: true
  }
}
</code></pre>
<p><strong>Hex representation (sample):</strong></p>
<pre><code class="language-text">0a2e 0a2c 0a24 0001 5512 2012 20b9 4d27
b993 4d3e 08a5 2e52 d7da 7dab fac4 84ef
e37a 5380 ee90 88f7 ace2 efcd e910 0018
0020 0028 011201 01
</code></pre>
<h4 id="example-2-dataset-block-request"><a class="header" href="#example-2-dataset-block-request">Example 2: Dataset Block Request</a></h4>
<p><strong>Scenario</strong>: Request block at index 100 from dataset</p>
<p><strong>Protobuf:</strong></p>
<pre><code class="language-protobuf">Message {
  wantlist: Wantlist {
    entries: [
      Entry {
        address: BlockAddress {
          leaf: true
          treeCid: 0x0155a0e40220c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470  // Tree CID
          index: 100
        }
        priority: 0
        cancel: false
        wantType: wantBlock
        sendDontHave: true
      }
    ]
    full: false  // Delta update
  }
}
</code></pre>
<h4 id="example-3-block-delivery-with-proof"><a class="header" href="#example-3-block-delivery-with-proof">Example 3: Block Delivery with Proof</a></h4>
<p><strong>Scenario</strong>: Provider sends dataset block with Merkle proof</p>
<p><strong>Protobuf:</strong></p>
<pre><code class="language-protobuf">Message {
  payload: [
    BlockDelivery {
      cid: 0x0155a0e40220a1b2c3d4e5f6071829...  // Block CID
      data: &lt;65536 bytes of block data&gt;  // 64 KiB
      address: BlockAddress {
        leaf: true
        treeCid: 0x0155a0e40220c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470
        index: 100
      }
      proof: &lt;CodexProof bytes&gt;  // Merkle proof data
        // Contains: path indices, sibling hashes, tree height
        // Format: Implementation-specific (e.g., [height][index][hash1][hash2]...[hashN])
        // Size varies by tree depth (illustrative: ~1KB for depth-10 tree)
    }
  ]
}
</code></pre>
<h4 id="example-4-block-presence-response"><a class="header" href="#example-4-block-presence-response">Example 4: Block Presence Response</a></h4>
<p><strong>Scenario</strong>: Provider indicates block availability with price</p>
<p><strong>Protobuf:</strong></p>
<pre><code class="language-protobuf">Message {
  blockPresences: [
    BlockPresence {
      address: BlockAddress {
        leaf: false
        cid: 0x0155a0e40220b94d27b9934d3e08a52e52d7da7dabfac484efe37a5380ee9088f7ace2efcde9
      }
      type: presenceHave  // 0
      price: 0x00000000000000000000000000000000000000000000000000038d7ea4c68000  // 0.001 ETH in wei
    }
  ]
}
</code></pre>
<h4 id="example-5-payment-message"><a class="header" href="#example-5-payment-message">Example 5: Payment Message</a></h4>
<p><strong>Scenario</strong>: Send payment via state channel update</p>
<p><strong>Protobuf:</strong></p>
<pre><code class="language-protobuf">Message {
  account: AccountMessage {
    address: 0x742d35Cc6634C0532925a3b844200a717C48D6d9  // 20 bytes Ethereum address
  }
  payment: StateChannelUpdate {
    update: &lt;JSON bytes&gt;
      // Contains signed Nitro state as UTF-8 JSON string
      // Example: {"channelId":"0x1234...","nonce":42,...}
  }
}
</code></pre>
<h4 id="example-6-multiple-operations-in-one-message"><a class="header" href="#example-6-multiple-operations-in-one-message">Example 6: Multiple Operations in One Message</a></h4>
<p><strong>Scenario</strong>: Combined WantList, BlockPresence, and Delivery</p>
<p><strong>Protobuf:</strong></p>
<pre><code class="language-protobuf">Message {
  wantlist: Wantlist {
    entries: [
      Entry {
        address: BlockAddress {
          leaf: false
          cid: 0x0155a0e40220...  // Requesting new block
        }
        wantType: wantBlock
        priority: 0
        cancel: false
        sendDontHave: true
      }
    ]
    full: false
  }
  blockPresences: [
    BlockPresence {
      address: BlockAddress {
        leaf: false
        cid: 0x0155a0e40220...  // Response to previous request
      }
      type: presenceHave
      price: 0x00  // Free
    }
  ]
  payload: [
    BlockDelivery {
      cid: 0x0155a0e40220...  // Delivering another block
      data: &lt;65536 bytes&gt;
      address: BlockAddress {
        leaf: false
        cid: 0x0155a0e40220...
      }
    }
  ]
  pendingBytes: 131072  // 128 KiB more data pending
}
</code></pre>
<h4 id="example-7-wantlist-cancellation"><a class="header" href="#example-7-wantlist-cancellation">Example 7: WantList Cancellation</a></h4>
<p><strong>Scenario</strong>: Cancel multiple pending requests</p>
<p><strong>Protobuf:</strong></p>
<pre><code class="language-protobuf">Message {
  wantlist: Wantlist {
    entries: [
      Entry {
        address: BlockAddress {
          leaf: false
          cid: 0x0155a0e40220abc123...
        }
        cancel: true  // Cancellation flag
      },
      Entry {
        address: BlockAddress {
          leaf: true
          treeCid: 0x0155a0e40220def456...
          index: 50
        }
        cancel: true
      }
    ]
    full: false
  }
}
</code></pre>
<h4 id="cid-format-details"><a class="header" href="#cid-format-details">CID Format Details</a></h4>
<p><strong>CID Structure:</strong></p>
<pre><code class="language-text">CID v1 format (multibase + multicodec + multihash):
[0x01] [0x55] [0xa0] [0xe4] [0x02] [0x20] [&lt;32 bytes SHA256 hash&gt;]
  │      │      │      │      │      │       │
  │      │      │      │      │      │       └─ Hash digest
  │      │      │      │      │      └───────── Hash length (32)
  │      │      │      │      └──────────────── Hash algorithm (SHA2-256)
  │      │      │      └─────────────────────── Codec size
  │      │      └────────────────────────────── Codec (raw = 0x55)
  │      └───────────────────────────────────── Multicodec prefix
  └──────────────────────────────────────────── CID version (1)

Actual: 0x01 55 a0 e4 02 20 &lt;hash bytes&gt;
</code></pre>
<p><strong>Example Block CID Breakdown:</strong></p>
<pre><code class="language-text">Full CID: 0x0155a0e40220b94d27b9934d3e08a52e52d7da7dabfac484efe37a5380ee9088f7ace2efcde9

Parts:
  Version:   0x01           (CID v1)
  Multicodec: 0x55          (raw)
  Codec Size: 0xa0e402      (codex-block = 0xCD02, varint encoded)*
  Hash Type:  0x20          (SHA2-256)
  Hash Len:   0x12 (20)     (32 bytes)
  Hash:       b94d27b993... (32 bytes SHA256)
</code></pre>
<p><strong>State Channel Update:</strong></p>
<pre><code class="language-protobuf">message StateChannelUpdate {
  bytes update = 1;   // Signed Nitro state, serialized as JSON
}
</code></pre>
<p><strong>Fields:</strong></p>
<ul>
<li><code>update</code>: Nitro state channel update containing payment information</li>
</ul>
<h3 id="payment-flow-and-price-negotiation"><a class="header" href="#payment-flow-and-price-negotiation">Payment Flow and Price Negotiation</a></h3>
<p>The Block Exchange protocol integrates with Nitro state channels to enable
micropayments for block delivery.</p>
<h4 id="payment-requirements"><a class="header" href="#payment-requirements">Payment Requirements</a></h4>
<p><strong>When Payment is Required:</strong></p>
<ul>
<li>Blocks marked as paid content by the provider</li>
<li>Provider's local policy requires payment for specific blocks</li>
<li>Block size exceeds free tier threshold (implementation-defined)</li>
<li>Requester has insufficient credit with provider</li>
</ul>
<p><strong>Free Blocks:</strong></p>
<ul>
<li>Blocks explicitly marked as free (<code>price = 0x00</code>)</li>
<li>Blocks exchanged between trusted peers</li>
<li>Small metadata blocks (implementation-defined)</li>
</ul>
<h4 id="price-discovery"><a class="header" href="#price-discovery">Price Discovery</a></h4>
<p><strong>Initial Price Advertisement:</strong></p>
<ol>
<li>Requester sends WantList with <code>wantType = wantHave</code></li>
<li>Provider responds with BlockPresence including <code>price</code> field</li>
<li>Price encoded as UInt256 in wei (smallest Ethereum unit)</li>
<li>Requester evaluates price against local policy</li>
</ol>
<p><strong>Price Format:</strong></p>
<pre><code class="language-text">price: bytes (32 bytes, big-endian UInt256)
Example: 0x0000000000000000000000000000000000000000000000000de0b6b3a7640000
         represents 1 ETH = 10^18 wei
</code></pre>
<h4 id="payment-negotiation-process"><a class="header" href="#payment-negotiation-process">Payment Negotiation Process</a></h4>
<h5 id="step-1-price-quote"><a class="header" href="#step-1-price-quote">Step 1: Price Quote</a></h5>
<pre><code class="language-text">Requester → Provider: Message(wantlist: wantHave)
Provider → Requester: BlockPresence(type=presenceHave, price=&lt;amount&gt;)
</code></pre>
<h5 id="step-2-payment-decision"><a class="header" href="#step-2-payment-decision">Step 2: Payment Decision</a></h5>
<p>Requester evaluates price:</p>
<ul>
<li><strong>Accept</strong>: Proceed to payment</li>
<li><strong>Reject</strong>: Send cancellation</li>
<li><strong>Counter</strong>: Not supported in current protocol (future extension)</li>
</ul>
<h5 id="step-3-state-channel-update"><a class="header" href="#step-3-state-channel-update">Step 3: State Channel Update</a></h5>
<p>If accepted:</p>
<pre><code class="language-text">Requester:
  1. Load existing state channel with Provider
  2. Create new state with updated balance
  3. Sign state update
  4. Encode as JSON

Requester → Provider: Message(payment: StateChannelUpdate(update=&lt;signed JSON&gt;))
</code></pre>
<h5 id="step-4-payment-verification"><a class="header" href="#step-4-payment-verification">Step 4: Payment Verification</a></h5>
<pre><code class="language-text">Provider:
  1. Decode state channel update
  2. Verify signatures
  3. Check balance increase matches price
  4. Verify state channel validity
  5. Check nonce/sequence number

If valid:
  Provider → Requester: BlockDelivery(data, proof)
Else:
  Provider → Requester: BlockPresence(price) // Retry with correct payment
</code></pre>
<h5 id="step-5-delivery-and-finalization"><a class="header" href="#step-5-delivery-and-finalization">Step 5: Delivery and Finalization</a></h5>
<pre><code class="language-text">Requester:
  1. Receive and verify block
  2. Store block locally
  3. Finalize state channel update
  4. Update peer credit balance
</code></pre>
<h4 id="payment-state-machine"><a class="header" href="#payment-state-machine">Payment State Machine</a></h4>
<p><strong>Note:</strong> The following state machine represents a <strong>design specification</strong> for
payment flow logic. Actual implementation may differ.</p>
<pre><code class="language-text">State: INIT
  → Send wantHave
  → Transition to PRICE_DISCOVERY

State: PRICE_DISCOVERY
  ← Receive BlockPresence(price)
  → If price acceptable: Transition to PAYMENT_CREATION
  → If price rejected: Transition to CANCELLED

State: PAYMENT_CREATION
  → Create state channel update
  → Send payment message
  → Transition to PAYMENT_PENDING

State: PAYMENT_PENDING
  ← Receive BlockDelivery: Transition to DELIVERY_VERIFICATION
  ← Receive BlockPresence(price): Transition to PAYMENT_FAILED

State: PAYMENT_FAILED
  → Retry with corrected payment: Transition to PAYMENT_CREATION
  → Abort: Transition to CANCELLED

State: DELIVERY_VERIFICATION
  → Verify block
  → If valid: Transition to COMPLETED
  → If invalid: Transition to DISPUTE

State: COMPLETED
  → Finalize state channel
  → End

State: CANCELLED
  → Send cancellation
  → End

State: DISPUTE
  → Reject block
  → Dispute state channel update
  → End
</code></pre>
<h4 id="state-channel-integration"><a class="header" href="#state-channel-integration">State Channel Integration</a></h4>
<p><strong>Account Message Usage:</strong></p>
<p>Sent early in connection to establish payment address:</p>
<pre><code class="language-protobuf">Message {
  account: AccountMessage {
    address: 0x742d35Cc6634C0532925a3b8...  // Ethereum address
  }
}
</code></pre>
<p><strong>State Channel Update Format:</strong></p>
<pre><code class="language-json">{
  "channelId": "0x1234...",
  "nonce": 42,
  "balances": {
    "0x742d35Cc...": "1000000000000000000",  // Seller balance
    "0x8ab5d2F3...": "500000000000000000"    // Buyer balance
  },
  "signatures": [
    "0x789abc...",  // Buyer signature
    "0x456def..."   // Seller signature
  ]
}
</code></pre>
<h4 id="error-scenarios"><a class="header" href="#error-scenarios">Error Scenarios</a></h4>
<p><strong>Insufficient Funds:</strong></p>
<ul>
<li>State channel balance &lt; block price</li>
<li>Response: BlockPresence with price (retry after funding)</li>
</ul>
<p><strong>Invalid Signature:</strong></p>
<ul>
<li>State update signature verification fails</li>
<li>Response: Reject payment, close stream if repeated</li>
</ul>
<p><strong>Nonce Mismatch:</strong></p>
<ul>
<li>State update nonce doesn't match expected sequence</li>
<li>Response: Request state sync, retry with correct nonce</li>
</ul>
<p><strong>Channel Expired:</strong></p>
<ul>
<li>State channel past expiration time</li>
<li>Response: Refuse payment, request new channel creation</li>
</ul>
<h2 id="error-handling"><a class="header" href="#error-handling">Error Handling</a></h2>
<p>The Block Exchange protocol defines error handling for common failure scenarios:</p>
<h3 id="verification-failures"><a class="header" href="#verification-failures">Verification Failures</a></h3>
<p><strong>Merkle Proof Verification Failure:</strong></p>
<ul>
<li><strong>Condition</strong>: CodexProof validation fails for dataset block</li>
<li><strong>Action</strong>: Reject block delivery, do NOT store block</li>
<li><strong>Response</strong>: Send BlockPresence with <code>presenceDontHave</code> for the address</li>
<li><strong>Logging</strong>: Log verification failure with peer ID and block address</li>
<li><strong>Peer Management</strong>: Track repeated failures; disconnect after threshold</li>
</ul>
<p><strong>CID Mismatch:</strong></p>
<ul>
<li><strong>Condition</strong>: SHA256 hash of block data doesn't match provided CID</li>
<li><strong>Action</strong>: Reject block delivery immediately</li>
<li><strong>Response</strong>: Close stream and mark peer as potentially malicious</li>
<li><strong>Logging</strong>: Log CID mismatch with peer ID and expected/actual CIDs</li>
</ul>
<h3 id="network-failures"><a class="header" href="#network-failures">Network Failures</a></h3>
<p><strong>Stream Disconnection:</strong></p>
<ul>
<li><strong>Condition</strong>: libp2p stream closes unexpectedly during transfer</li>
<li><strong>Action</strong>: Cancel pending block requests for that peer</li>
<li><strong>Recovery</strong>: Attempt to request blocks from alternative peers</li>
<li><strong>Timeout</strong>: Wait for stream timeout (60s) before peer cleanup</li>
</ul>
<p><strong>Missing Blocks:</strong></p>
<ul>
<li><strong>Condition</strong>: Peer responds with <code>presenceDontHave</code> for requested block</li>
<li><strong>Action</strong>: Remove peer from candidates for this block</li>
<li><strong>Recovery</strong>: Query discovery service for alternative peers</li>
<li><strong>Fallback</strong>: If no peers have block, return error to <code>requestBlock</code> caller</li>
</ul>
<p><strong>Request Timeout:</strong></p>
<ul>
<li><strong>Condition</strong>: Block not received within request timeout (300s)</li>
<li><strong>Action</strong>: Cancel request with that peer</li>
<li><strong>Recovery</strong>: Retry with different peer if available</li>
<li><strong>User Notification</strong>: If all retry attempts exhausted, <code>requestBlock</code> returns timeout error</li>
</ul>
<h3 id="protocol-violations"><a class="header" href="#protocol-violations">Protocol Violations</a></h3>
<p><strong>Oversized Messages:</strong></p>
<ul>
<li><strong>Condition</strong>: Message exceeds maximum size limits</li>
<li><strong>Action</strong>: Close stream immediately</li>
<li><strong>Peer Management</strong>: Mark peer as non-compliant</li>
<li><strong>No Response</strong>: Do not send error message (message may be malicious)</li>
</ul>
<p><strong>Invalid WantList:</strong></p>
<ul>
<li><strong>Condition</strong>: WantList exceeds entry limit or contains malformed addresses</li>
<li><strong>Action</strong>: Ignore malformed entries, process valid ones</li>
<li><strong>Response</strong>: Continue processing stream</li>
<li><strong>Logging</strong>: Log validation errors for debugging</li>
</ul>
<p><strong>Payment Failures:</strong></p>
<ul>
<li><strong>Condition</strong>: State channel update invalid or payment insufficient</li>
<li><strong>Action</strong>: Do not deliver blocks requiring payment</li>
<li><strong>Response</strong>: Send BlockPresence with price indicating payment needed</li>
<li><strong>Stream</strong>: Keep stream open for payment retry</li>
</ul>
<h3 id="recovery-strategies"><a class="header" href="#recovery-strategies">Recovery Strategies</a></h3>
<h4 id="retry-responsibility-model"><a class="header" href="#retry-responsibility-model">Retry Responsibility Model</a></h4>
<p>The protocol defines a clear separation between system-level and caller-level
retry responsibilities:</p>
<p><strong>System-Level Retry (Automatic):</strong></p>
<p>The Block Exchange module automatically retries in these scenarios:</p>
<ul>
<li><strong>Peer failure</strong>: If a peer disconnects or times out, the system
transparently tries alternative peers from the discovery set</li>
<li><strong>Transient errors</strong>: Network glitches, temporary unavailability</li>
<li><strong>Peer rotation</strong>: Automatic failover to next available peer</li>
</ul>
<p>The caller's <code>requestBlock</code> call remains pending during system-level retries.
This is transparent to the caller.</p>
<p><strong>Caller-Level Retry (Manual):</strong></p>
<p>The caller is responsible for retry decisions when:</p>
<ul>
<li><strong>All peers exhausted</strong>: No more peers available from discovery</li>
<li><strong>Permanent failures</strong>: Block doesn't exist in the network</li>
<li><strong>Timeout exceeded</strong>: Request timeout (300s) expired</li>
<li><strong>Verification failures</strong>: All peers provided invalid data</li>
</ul>
<p>In these cases, <code>requestBlock</code> returns an error and the caller decides
whether to retry, perhaps after waiting or refreshing the peer list
via discovery.</p>
<p><strong>Retry Flow:</strong></p>
<pre><code class="language-text">requestBlock(address)
    │
    ├─► System tries Peer A ──► Fails
    │       │
    │       └─► System tries Peer B ──► Fails (automatic, transparent)
    │               │
    │               └─► System tries Peer C ──► Success ──► Return block
    │
    └─► All peers failed ──► Return error to caller
                                    │
                                    └─► Caller decides: retry? wait? abort?
</code></pre>
<p><strong>Peer Rotation:</strong></p>
<p>When a peer fails to deliver blocks:</p>
<ol>
<li>Mark peer as temporarily unavailable for this block</li>
<li>Query discovery service for alternative peers</li>
<li>Send WantList to new peers</li>
<li>Implement exponential backoff before retrying failed peer</li>
</ol>
<p><strong>Graceful Degradation:</strong></p>
<ul>
<li>If verification fails, request block from alternative peer</li>
<li>If all peers fail, propagate error to caller</li>
<li>Clean up resources (memory, pending requests) on unrecoverable failures</li>
</ul>
<p><strong>Error Propagation:</strong></p>
<ul>
<li>Service interface functions (<code>requestBlock</code>, <code>cancelRequest</code>) return errors
to callers only after system-level retries are exhausted</li>
<li>Internal errors logged for debugging</li>
<li>Network errors trigger automatic peer rotation before surfacing to caller</li>
<li>Verification errors result in block rejection and peer reputation impact</li>
</ul>
<h2 id="security-considerations-17"><a class="header" href="#security-considerations-17">Security Considerations</a></h2>
<h3 id="block-verification"><a class="header" href="#block-verification">Block Verification</a></h3>
<ul>
<li>All dataset blocks MUST include and verify Merkle proofs before acceptance</li>
<li>Standalone blocks MUST verify CID matches the SHA256 hash of the data</li>
<li>Peers SHOULD reject blocks that fail verification immediately</li>
</ul>
<h3 id="dos-protection"><a class="header" href="#dos-protection">DoS Protection</a></h3>
<ul>
<li>Implementations SHOULD limit the number of concurrent block requests per peer</li>
<li>Implementations SHOULD implement rate limiting for WantList updates</li>
<li>Large WantLists MAY be rejected to prevent resource exhaustion</li>
</ul>
<h3 id="data-integrity"><a class="header" href="#data-integrity">Data Integrity</a></h3>
<ul>
<li>All blocks MUST be validated before being stored or forwarded</li>
<li>Zero-padding in dataset blocks MUST be verified to prevent data corruption</li>
<li>Block sizes MUST be validated against protocol limits</li>
</ul>
<h3 id="privacy-considerations-4"><a class="header" href="#privacy-considerations-4">Privacy Considerations</a></h3>
<ul>
<li>Block requests reveal information about what data a peer is seeking</li>
<li>Implementations MAY implement request obfuscation strategies</li>
<li>Presence information can leak storage capacity details</li>
</ul>
<h2 id="rationale"><a class="header" href="#rationale">Rationale</a></h2>
<h3 id="design-decisions"><a class="header" href="#design-decisions">Design Decisions</a></h3>
<p><strong>Two-Tier Block Addressing:</strong>
The protocol supports both standalone and dataset blocks to accommodate
different use cases.
Standalone blocks are simpler and don't require Merkle proofs, while
dataset blocks enable efficient verification of large datasets without
requiring the entire dataset.</p>
<p><strong>WantList Delta Updates:</strong>
Supporting delta updates reduces bandwidth consumption when peers only
need to modify a small portion of their wants, which is common in
long-lived connections.</p>
<p><strong>Separate Presence Messages:</strong>
Decoupling presence information from block delivery allows peers to
quickly assess availability without waiting for full block transfers.</p>
<p><strong>Fixed Block Size:</strong>
The 64 KiB default block size balances efficient network transmission
with manageable memory overhead.</p>
<p><strong>Zero-Padding Requirement:</strong>
Requiring zero-padding for incomplete dataset blocks ensures uniform
block sizes within datasets, simplifying Merkle tree construction and
verification.</p>
<p><strong>Protocol Buffers:</strong>
Using Protocol Buffers provides efficient serialization, forward
compatibility, and wide language support.</p>
<h2 id="copyright-54"><a class="header" href="#copyright-54">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-44"><a class="header" href="#references-44">References</a></h2>
<h3 id="normative-1"><a class="header" href="#normative-1">Normative</a></h3>
<ul>
<li><a href="https://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a> - Key words for use
in RFCs to Indicate Requirement Levels</li>
<li><strong>libp2p</strong>: <a href="https://libp2p.io">https://libp2p.io</a></li>
<li><strong>Protocol Buffers</strong>: <a href="https://protobuf.dev">https://protobuf.dev</a></li>
<li><strong>Multihash</strong>: <a href="https://multiformats.io/multihash/">https://multiformats.io/multihash/</a></li>
<li><strong>Multicodec</strong>: <a href="https://github.com/multiformats/multicodec">https://github.com/multiformats/multicodec</a></li>
</ul>
<h3 id="informative-3"><a class="header" href="#informative-3">Informative</a></h3>
<ul>
<li><strong>Codex Documentation</strong>: <a href="https://docs.codex.storage">https://docs.codex.storage</a></li>
<li><strong>Codex Block Exchange Module Spec</strong>:
<a href="https://github.com/codex-storage/codex-docs-obsidian/blob/main/10%20Notes/Specs/Block%20Exchange%20Module%20Spec.md">https://github.com/codex-storage/codex-docs-obsidian/blob/main/10%20Notes/Specs/Block%20Exchange%20Module%20Spec.md</a></li>
<li><strong>Merkle Trees</strong>: <a href="https://en.wikipedia.org/wiki/Merkle_tree">https://en.wikipedia.org/wiki/Merkle_tree</a></li>
<li><strong>Content Addressing</strong>:
<a href="https://en.wikipedia.org/wiki/Content-addressable_storage">https://en.wikipedia.org/wiki/Content-addressable_storage</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="codex-marketplace"><a class="header" href="#codex-marketplace">CODEX-MARKETPLACE</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Codex Storage Marketplace</td></tr>
<tr><th>Slug</th><td>codex-marketplace</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Codex Team and Dmitriy Ryajov &lt;dryajov@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Mark Spanbroek &lt;mark@codex.storage&gt;<br>Adam Uhlíř &lt;adam@codex.storage&gt;<br>Eric Mastro &lt;eric@codex.storage&gt;<br>Jimmy Debe &lt;jimmy@status.im&gt;<br>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-59"><a class="header" href="#timeline-59">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/codex/raw/codex-marketplace.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/codex/raw/codex-marketplace.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-11-19</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d2df7e0c2dbb38d5b01a504f0b8ccbaea95fe821/codex/raw/codex-marketplace.md"><code>d2df7e0</code></a> — Created codex/raw/codex-marketplace.md file, without integration of Sales a… (#208)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-34"><a class="header" href="#abstract-34">Abstract</a></h2>
<p>Codex Marketplace and its interactions are defined by a smart contract deployed on an EVM-compatible blockchain. This specification describes these interactions for the various roles within the network.</p>
<p>The document is intended for implementors of Codex nodes.</p>
<h2 id="semantics-4"><a class="header" href="#semantics-4">Semantics</a></h2>
<p>The keywords "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">2119</a>.</p>
<h3 id="definitions-8"><a class="header" href="#definitions-8">Definitions</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Terminology</th><th>Description</th></tr></thead><tbody>
<tr><td>Storage Provider (SP)</td><td>A node in the Codex network that provides storage services to the marketplace.</td></tr>
<tr><td>Validator</td><td>A node that assists in identifying missing storage proofs.</td></tr>
<tr><td>Client</td><td>A node that interacts with other nodes in the Codex network to store, locate, and retrieve data.</td></tr>
<tr><td>Storage Request or Request</td><td>A request created by a client node to persist data on the Codex network.</td></tr>
<tr><td>Slot or Storage Slot</td><td>A space allocated by the storage request to store a piece of the request's dataset.</td></tr>
<tr><td>Smart Contract</td><td>A smart contract implementing the marketplace functionality.</td></tr>
<tr><td>Token</td><td>The ERC20-based token used within the Codex network.</td></tr>
</tbody></table>
</div>
<h2 id="motivation-26"><a class="header" href="#motivation-26">Motivation</a></h2>
<p>The Codex network aims to create a peer-to-peer storage engine with robust data durability, data persistence guarantees, and a comprehensive incentive structure.</p>
<p>The marketplace is a critical component of the Codex network, serving as a platform where all involved parties interact to ensure data persistence. It provides mechanisms to enforce agreements and facilitate data repair when SPs fail to fulfill their duties.</p>
<p>Implemented as a smart contract on an EVM-compatible blockchain, the marketplace enables various scenarios where nodes assume one or more roles to maintain a reliable persistence layer for users. This specification details these interactions.</p>
<p>The marketplace contract manages storage requests, maintains the state of allocated storage slots, and orchestrates SP rewards, collaterals, and storage proofs.</p>
<p>A node that wishes to participate in the Codex persistence layer MUST implement one or more roles described in this document.</p>
<h3 id="roles-3"><a class="header" href="#roles-3">Roles</a></h3>
<p>A node can assume one of the three main roles in the network: the client, SP, and validator.</p>
<p>A client is a potentially short-lived node in the network with the purpose of persisting its data in the Codex persistence layer.</p>
<p>An SP is a long-lived node providing storage for clients in exchange for profit. To ensure a reliable, robust service for clients, SPs are required to periodically provide proofs that they are persisting the data.</p>
<p>A validator ensures that SPs have submitted valid proofs each period where the smart contract required a proof to be submitted for slots filled by the SP.</p>
<hr />
<h2 id="part-i-protocol-specification"><a class="header" href="#part-i-protocol-specification">Part I: Protocol Specification</a></h2>
<p>This part defines the <strong>normative requirements</strong> for the Codex Marketplace protocol. All implementations MUST comply with these requirements to participate in the Codex network. The protocol is defined by smart contract interactions on an EVM-compatible blockchain.</p>
<h2 id="storage-request-lifecycle"><a class="header" href="#storage-request-lifecycle">Storage Request Lifecycle</a></h2>
<p>The diagram below depicts the lifecycle of a storage request:</p>
<pre><code class="language-text">                      ┌───────────┐
                      │ Cancelled │
                      └───────────┘
                            ▲
                            │ Not all
                            │ Slots filled
                            │
    ┌───────────┐    ┌──────┴─────────────┐           ┌─────────┐
    │ Submitted ├───►│ Slots Being Filled ├──────────►│ Started │
    └───────────┘    └────────────────────┘ All Slots └────┬────┘
                                            Filled         │
                                                           │
                                   ┌───────────────────────┘
                           Proving ▼
    ┌────────────────────────────────────────────────────────────┐
    │                                                            │
    │                 Proof submitted                            │
    │       ┌─────────────────────────► All good                 │
    │       │                                                    │
    │ Proof required                                             │
    │       │                                                    │
    │       │         Proof missed                               │
    │       └─────────────────────────► After some time slashed  │
    │                                   eventually Slot freed    │
    │                                                            │
    └────────┬─┬─────────────────────────────────────────────────┘
             │ │                                      ▲
             │ │                                      │
             │ │ SP kicked out and Slot freed ┌───────┴────────┐
All good     │ ├─────────────────────────────►│ Repair process │
Time ran out │ │                              └────────────────┘
             │ │
             │ │ Too many Slots freed         ┌────────┐
             │ └─────────────────────────────►│ Failed │
             ▼                                └────────┘
       ┌──────────┐
       │ Finished │
       └──────────┘
</code></pre>
<h2 id="client-role"><a class="header" href="#client-role">Client Role</a></h2>
<p>A node implementing the client role mediates the persistence of data within the Codex network.</p>
<p>A client has two primary responsibilities:</p>
<ul>
<li>Requesting storage from the network by sending a storage request to the smart contract.</li>
<li>Withdrawing funds from the storage requests previously created by the client.</li>
</ul>
<h3 id="creating-storage-requests"><a class="header" href="#creating-storage-requests">Creating Storage Requests</a></h3>
<p>When a user prompts the client node to create a storage request, the client node SHOULD receive the input parameters for the storage request from the user.</p>
<p>To create a request to persist a dataset on the Codex network, client nodes MUST split the dataset into data chunks, $(c_1, c_2, c_3, \ldots, c_{n})$. Using the erasure coding method and the provided input parameters, the data chunks are encoded and distributed over a number of slots. The applied erasure coding method MUST use the <a href="https://hackmd.io/FB58eZQoTNm-dnhu0Y1XnA">Reed-Solomon algorithm</a>. The final slot roots and other metadata MUST be placed into a <code>Manifest</code> (TODO: Manifest RFC). The CID for the <code>Manifest</code> MUST then be used as the <code>cid</code> for the stored dataset.</p>
<p>After the dataset is prepared, a client node MUST call the smart contract function <code>requestStorage(request)</code>, providing the desired request parameters in the <code>request</code> parameter. The <code>request</code> parameter is of type <code>Request</code>:</p>
<pre><code class="language-solidity">struct Request {
  address client;
  Ask ask;
  Content content;
  uint64 expiry;
  bytes32 nonce;
}

struct Ask {
  uint256 proofProbability;
  uint256 pricePerBytePerSecond;
  uint256 collateralPerByte;
  uint64 slots;
  uint64 slotSize;
  uint64 duration;
  uint64 maxSlotLoss;
}

struct Content {
  bytes cid;
  bytes32 merkleRoot;
}
</code></pre>
<p>The table below provides the description of the <code>Request</code> and the associated types attributes:</p>
<div class="table-wrapper"><table><thead><tr><th>attribute</th><th>type</th><th>description</th></tr></thead><tbody>
<tr><td><code>client</code></td><td><code>address</code></td><td>The Codex node requesting storage.</td></tr>
<tr><td><code>ask</code></td><td><code>Ask</code></td><td>Parameters of Request.</td></tr>
<tr><td><code>content</code></td><td><code>Content</code></td><td>The dataset that will be hosted with the storage request.</td></tr>
<tr><td><code>expiry</code></td><td><code>uint64</code></td><td>Timeout in seconds during which all the slots have to be filled, otherwise Request will get cancelled. The final deadline timestamp is calculated at the moment the transaction is mined.</td></tr>
<tr><td><code>nonce</code></td><td><code>bytes32</code></td><td>Random value to differentiate from other requests of same parameters. It SHOULD be a random byte array.</td></tr>
<tr><td><code>pricePerBytePerSecond</code></td><td><code>uint256</code></td><td>Amount of tokens that will be awarded to SPs for finishing the storage request. It MUST be an amount of tokens offered per slot per second per byte. The Ethereum address that submits the <code>requestStorage()</code> transaction MUST have <a href="https://docs.openzeppelin.com/contracts/2.x/api/token/erc20#IERC20-approve-address-uint256-">approval</a> for the transfer of at least an equivalent amount of full reward (<code>pricePerBytePerSecond * duration * slots * slotSize</code>) in tokens.</td></tr>
<tr><td><code>collateralPerByte</code></td><td><code>uint256</code></td><td>The amount of tokens per byte of slot's size that SPs submit when they fill slots. Collateral is then slashed or forfeited if SPs fail to provide the service requested by the storage request (more information in the [Slashing](#### Slashing) section).</td></tr>
<tr><td><code>proofProbability</code></td><td><code>uint256</code></td><td>Determines the average frequency that a proof is required within a period: $\frac{1}{proofProbability}$. SPs are required to provide proofs of storage to the marketplace contract when challenged. To prevent hosts from only coming online when proofs are required, the frequency at which proofs are requested from SPs is stochastic and is influenced by the <code>proofProbability</code> parameter.</td></tr>
<tr><td><code>duration</code></td><td><code>uint64</code></td><td>Total duration of the storage request in seconds. It MUST NOT exceed the limit specified in the configuration <code>config.requestDurationLimit</code>.</td></tr>
<tr><td><code>slots</code></td><td><code>uint64</code></td><td>The number of requested slots. The slots will all have the same size.</td></tr>
<tr><td><code>slotSize</code></td><td><code>uint64</code></td><td>Amount of storage per slot in bytes.</td></tr>
<tr><td><code>maxSlotLoss</code></td><td><code>uint64</code></td><td>Max slots that can be lost without data considered to be lost.</td></tr>
<tr><td><code>cid</code></td><td><code>bytes</code></td><td>An identifier used to locate the Manifest representing the dataset. It MUST be a <a href="https://github.com/multiformats/cid#cidv1">CIDv1</a>, SHA-256 <a href="https://github.com/multiformats/multihash">multihash</a> and the data it represents SHOULD be discoverable in the network, otherwise the request will be eventually canceled.</td></tr>
<tr><td><code>merkleRoot</code></td><td><code>bytes32</code></td><td>Merkle root of the dataset, used to verify storage proofs</td></tr>
</tbody></table>
</div>
<h4 id="renewal-of-storage-requests"><a class="header" href="#renewal-of-storage-requests">Renewal of Storage Requests</a></h4>
<p>It should be noted that the marketplace does not support extending requests. It is REQUIRED that if the user wants to extend the duration of a request, a new request with the same CID must be [created](### Creating Storage Requests) <strong>before the original request completes</strong>.</p>
<p>This ensures that the data will continue to persist in the network at the time when the new (or existing) SPs need to retrieve the complete dataset to fill the slots of the new request.</p>
<h3 id="monitoring-and-state-management"><a class="header" href="#monitoring-and-state-management">Monitoring and State Management</a></h3>
<p>Client nodes MUST implement the following smart contract interactions for monitoring and state management:</p>
<ul>
<li>
<p><strong>getRequest(requestId)</strong>: Retrieve the full <code>StorageRequest</code> data from the marketplace. This function is used for recovery and state verification after restarts or failures.</p>
</li>
<li>
<p><strong>requestState(requestId)</strong>: Query the current state of a storage request. Used for monitoring request progress and determining the appropriate client actions.</p>
</li>
<li>
<p><strong>requestExpiresAt(requestId)</strong>: Query when the request will expire if not fulfilled.</p>
</li>
<li>
<p><strong>getRequestEnd(requestId)</strong>: Query when a fulfilled request will end (used to determine when to call <code>freeSlot</code> or <code>withdrawFunds</code>).</p>
</li>
</ul>
<p>Client nodes MUST subscribe to the following marketplace events:</p>
<ul>
<li>
<p><strong>RequestFulfilled(requestId)</strong>: Emitted when a storage request has enough filled slots to start. Clients monitor this event to determine when their request becomes active and transitions from the submission phase to the active phase.</p>
</li>
<li>
<p><strong>RequestFailed(requestId)</strong>: Emitted when a storage request fails due to proof failures or other reasons. Clients observe this event to detect failed requests and initiate fund withdrawal.</p>
</li>
</ul>
<h3 id="withdrawing-funds"><a class="header" href="#withdrawing-funds">Withdrawing Funds</a></h3>
<p>The client node MUST monitor the status of the requests it created. When a storage request enters the <code>Cancelled</code>, <code>Failed</code>, or <code>Finished</code> state, the client node MUST initiate the withdrawal of the remaining or refunded funds from the smart contract using the <code>withdrawFunds(requestId)</code> function.</p>
<p>Request states are determined as follows:</p>
<ul>
<li>The request is considered <code>Cancelled</code> if no <code>RequestFulfilled(requestId)</code> event is observed during the timeout specified by the value returned from the <code>requestExpiresAt(requestId)</code> function.</li>
<li>The request is considered <code>Failed</code> when the <code>RequestFailed(requestId)</code> event is observed.</li>
<li>The request is considered <code>Finished</code> after the interval specified by the value returned from the <code>getRequestEnd(requestId)</code> function has elapsed.</li>
</ul>
<h2 id="storage-provider-role"><a class="header" href="#storage-provider-role">Storage Provider Role</a></h2>
<p>A Codex node acting as an SP persists data across the network by hosting slots requested by clients in their storage requests.</p>
<p>The following tasks need to be considered when hosting a slot:</p>
<ul>
<li>Filling a slot</li>
<li>Proving</li>
<li>Repairing a slot</li>
<li>Collecting request reward and collateral</li>
</ul>
<h3 id="filling-slots"><a class="header" href="#filling-slots">Filling Slots</a></h3>
<p>When a new request is created, the <code>StorageRequested(requestId, ask, expiry)</code> event is emitted with the following properties:</p>
<ul>
<li><code>requestId</code> - the ID of the request.</li>
<li><code>ask</code> - the specification of the request parameters. For details, see the definition of the <code>Request</code> type in the [Creating Storage Requests](### Creating Storage Requests) section above.</li>
<li><code>expiry</code> - a Unix timestamp specifying when the request will be canceled if all slots are not filled by then.</li>
</ul>
<p>It is then up to the SP node to decide, based on the emitted parameters and node's operator configuration, whether it wants to participate in the request and attempt to fill its slot(s) (note that one SP can fill more than one slot). If the SP node decides to ignore the request, no further action is required. However, if the SP decides to fill a slot, it MUST follow the remaining steps described below.</p>
<p>The node acting as an SP MUST decide which slot, specified by the slot index, it wants to fill. The SP MAY attempt to fill more than one slot. To fill a slot, the SP MUST first reserve the slot in the smart contract using <code>reserveSlot(requestId, slotIndex)</code>. If reservations for this slot are full, or if the SP has already reserved the slot, the transaction will revert. If the reservation was unsuccessful, then the SP is not allowed to fill the slot. If the reservation was successful, the node MUST then download the slot data using the CID of the manifest (<strong>TODO: Manifest RFC</strong>) and the slot index. The CID is specified in <code>request.content.cid</code>, which can be retrieved from the smart contract using <code>getRequest(requestId)</code>. Then, the node MUST generate a proof over the downloaded data (<strong>TODO: Proving RFC</strong>).</p>
<p>When the proof is ready, the SP MUST call <code>fillSlot()</code> on the smart contract with the following REQUIRED parameters:</p>
<ul>
<li><code>requestId</code> - the ID of the request.</li>
<li><code>slotIndex</code> - the slot index that the node wants to fill.</li>
<li><code>proof</code> - the <code>Groth16Proof</code> proof structure, generated over the slot data.</li>
</ul>
<p>The Ethereum address of the SP node from which the transaction originates MUST have <a href="https://docs.openzeppelin.com/contracts/2.x/api/token/erc20#IERC20-approve-address-uint256-">approval</a> for the transfer of at least the amount of tokens required as collateral for the slot (<code>collateralPerByte * slotSize</code>).</p>
<p>If the proof delivered by the SP is invalid or the slot was already filled by another SP, then the transaction will revert. Otherwise, a <code>SlotFilled(requestId, slotIndex)</code> event is emitted. If the transaction is successful, the SP SHOULD transition into the <strong>proving</strong> state, where it will need to submit proof of data possession when challenged by the smart contract.</p>
<p>It should be noted that if the SP node observes a <code>SlotFilled</code> event for the slot it is currently downloading the dataset for or generating the proof for, it means that the slot has been filled by another node in the meantime. In response, the SP SHOULD stop its current operation and attempt to fill a different, unfilled slot.</p>
<h3 id="proving"><a class="header" href="#proving">Proving</a></h3>
<p>Once an SP fills a slot, it MUST submit proofs to the marketplace contract when a challenge is issued by the contract. SPs SHOULD detect that a proof is required for the current period using the <code>isProofRequired(slotId)</code> function, or that it will be required using the <code>willProofBeRequired(slotId)</code> function in the case that the <a href="https://github.com/codex-storage/codex-research/blob/41c4b4409d2092d0a5475aca0f28995034e58d14/design/storage-proof-timing.md">proving clock pointer is in downtime</a>.</p>
<p>Once an SP knows it has to provide a proof it MUST get the proof challenge using <code>getChallenge(slotId)</code>, which then
MUST be incorporated into the proof generation as described in Proving RFC (<strong>TODO: Proving RFC</strong>).</p>
<p>When the proof is generated, it MUST be submitted by calling the <code>submitProof(slotId, proof)</code> smart contract function.</p>
<h4 id="slashing-2"><a class="header" href="#slashing-2">Slashing</a></h4>
<p>There is a slashing scheme orchestrated by the smart contract to incentivize correct behavior and proper proof submissions by SPs. This scheme is configured at the smart contract level and applies uniformly to all participants in the network. The configuration of the slashing scheme can be obtained via the <code>configuration()</code> contract call.</p>
<p>The slashing works as follows:</p>
<ul>
<li>When SP misses a proof and a validator trigger detection of this event using the <code>markProofAsMissing()</code> call, the SP is slashed by <code>config.collateral.slashPercentage</code> <strong>of the originally required collateral</strong> (hence the slashing amount is always the same for a given request).</li>
<li>If the number of slashes exceeds <code>config.collateral.maxNumberOfSlashes</code>, the slot is freed, the remaining collateral is burned, and the slot is offered to other nodes for repair. The smart contract also emits the <code>SlotFreed(requestId, slotIndex)</code> event.</li>
</ul>
<p>If, at any time, the number of freed slots exceeds the value specified by the <code>request.ask.maxSlotLoss</code> parameter, the dataset is considered lost, and the request is deemed <em>failed</em>. The collateral of all SPs that hosted the slots associated with the storage request is burned, and the <code>RequestFailed(requestId)</code> event is emitted.</p>
<h3 id="repair"><a class="header" href="#repair">Repair</a></h3>
<p>When a slot is freed due to too many missed proofs, which SHOULD be detected by listening to the <code>SlotFreed(requestId, slotIndex)</code> event, an SP node can decide whether to participate in repairing the slot. Similar to filling a slot, the node SHOULD consider the operator's configuration when making this decision. The SP that originally hosted the slot but failed to comply with proving requirements MAY also participate in the repair. However, by refilling the slot, the SP <strong>will not</strong> recover its original collateral and must submit new collateral using the <code>fillSlot()</code> call.</p>
<p>The repair process is similar to filling slots. If the original slot dataset is no longer present in the network, the SP MAY use erasure coding to reconstruct the dataset. Reconstructing the original slot dataset requires retrieving other pieces of the dataset stored in other slots belonging to the request. For this reason, the node that successfully repairs a slot is entitled to an additional reward. (<strong>TODO: Implementation</strong>)</p>
<p>The repair process proceeds as follows:</p>
<ol>
<li>The SP observes the <code>SlotFreed</code> event and decides to repair the slot.</li>
<li>The SP MUST reserve the slot with the <code>reserveSlot(requestId, slotIndex)</code> call. For more information see the [Filling Slots](###filling slots) section.</li>
<li>The SP MUST download the chunks of data required to reconstruct the freed slot's data. The node MUST use the <a href="https://hackmd.io/FB58eZQoTNm-dnhu0Y1XnA">Reed-Solomon algorithm</a> to reconstruct the missing data.</li>
<li>The SP MUST generate proof over the reconstructed data.</li>
<li>The SP MUST call the <code>fillSlot()</code> smart contract function with the same parameters and collateral allowance as described in the [Filling Slots](###filling slots) section.</li>
</ol>
<h3 id="collecting-funds"><a class="header" href="#collecting-funds">Collecting Funds</a></h3>
<p>An SP node SHOULD monitor the requests and the associated slots it hosts.</p>
<p>When a storage request enters the <code>Cancelled</code>, <code>Finished</code>, or <code>Failed</code> state, the SP node SHOULD call the <code>freeSlot(slotId)</code> smart contract function.</p>
<p>The aforementioned storage request states (<code>Cancelled</code>, <code>Finished</code>, and <code>Failed</code>) can be detected as follows:</p>
<ul>
<li>A storage request is considered <code>Cancelled</code> if no <code>RequestFulfilled(requestId)</code> event is observed within the time indicated by the <code>expiry</code> request parameter. Note that a <code>RequestCancelled</code> event may also be emitted, but the node SHOULD NOT rely on this event to assert the request expiration, as the <code>RequestCancelled</code> event is not guaranteed to be emitted at the time of expiry.</li>
<li>A storage request is considered <code>Finished</code> when the time indicated by the value returned from the <code>getRequestEnd(requestId)</code> function has elapsed.</li>
<li>A node concludes that a storage request has <code>Failed</code> upon observing the <code>RequestFailed(requestId)</code> event.</li>
</ul>
<p>For each of the states listed above, different funds are handled as follows:</p>
<ul>
<li>In the <code>Cancelled</code> state, the collateral is returned along with a proportional payout based on the time the node actually hosted the dataset before the expiry was reached.</li>
<li>In the <code>Finished</code> state, the full reward for hosting the slot, along with the collateral, is collected.</li>
<li>In the <code>Failed</code> state, no funds are collected. The reward is returned to the client, and the collateral is burned. The slot is removed from the list of slots and is no longer included in the list of slots returned by the <code>mySlots()</code> function.</li>
</ul>
<h2 id="validator-role"><a class="header" href="#validator-role">Validator Role</a></h2>
<p>In a blockchain, a contract cannot change its state without a transaction and gas initiating the state change. Therefore, our smart contract requires an external trigger to periodically check and confirm that a storage proof has been delivered by the SP. This is where the validator role is essential.</p>
<p>The validator role is fulfilled by nodes that help to verify that SPs have submitted the required storage proofs.</p>
<p>It is the smart contract that checks if the proof requested from an SP has been delivered. The validator only triggers the decision-making function in the smart contract. To incentivize validators, they receive a reward each time they correctly mark a proof as missing corresponding to the percentage of the slashed collateral defined by <code>config.collateral.validatorRewardPercentage</code>.</p>
<p>Each time a validator observes the <code>SlotFilled</code> event, it SHOULD add the slot reported in the <code>SlotFilled</code> event to the validator's list of watched slots. Then, after the end of each period, a validator has up to <code>config.proofs.timeout</code> seconds (a configuration parameter retrievable with <code>configuration()</code>) to validate all the slots. If a slot lacks the required proof, the validator SHOULD call the <code>markProofAsMissing(slotId, period)</code> function on the smart contract. This function validates the correctness of the claim, and if right, will send a reward to the validator.</p>
<p>If validating all the slots observed by the validator is not feasible within the specified <code>timeout</code>, the validator MAY choose to validate only a subset of the observed slots.</p>
<hr />
<h2 id="part-ii-implementation-suggestions"><a class="header" href="#part-ii-implementation-suggestions">Part II: Implementation Suggestions</a></h2>
<blockquote>
<p><strong>IMPORTANT</strong>: The sections above (Abstract through Validator Role) define the normative Codex Marketplace protocol requirements. All implementations MUST comply with those protocol requirements to participate in the Codex network.</p>
<p><strong>The sections below are non-normative</strong>. They document implementation approaches used in the nim-codex reference implementation. These are suggestions to guide implementors but are NOT required by the protocol. Alternative implementations MAY use different approaches as long as they satisfy the protocol requirements defined in Part I.</p>
</blockquote>
<h2 id="implementation-suggestions-3"><a class="header" href="#implementation-suggestions-3">Implementation Suggestions</a></h2>
<p>This section describes implementation approaches used in reference implementations. These are <strong>suggestions and not normative requirements</strong>. Implementations are free to use different internal architectures, state machines, and data structures as long as they correctly implement the protocol requirements defined above.</p>
<h3 id="storage-provider-implementation"><a class="header" href="#storage-provider-implementation">Storage Provider Implementation</a></h3>
<p>The nim-codex reference implementation provides a complete Storage Provider implementation with state machine management, slot queueing, and resource management. This section documents the nim-codex approach.</p>
<h4 id="state-machine"><a class="header" href="#state-machine">State Machine</a></h4>
<p>The Sales module implements a deterministic state machine for each slot, progressing through the following states:</p>
<ol>
<li><strong>SalePreparing</strong> - Find a matching availability and create a reservation</li>
<li><strong>SaleSlotReserving</strong> - Reserve the slot on the marketplace</li>
<li><strong>SaleDownloading</strong> - Stream and persist the slot's data</li>
<li><strong>SaleInitialProving</strong> - Wait for stable challenge and generate initial proof</li>
<li><strong>SaleFilling</strong> - Compute collateral and fill the slot</li>
<li><strong>SaleFilled</strong> - Post-filling operations and expiry updates</li>
<li><strong>SaleProving</strong> - Generate and submit proofs periodically</li>
<li><strong>SalePayout</strong> - Free slot and calculate collateral</li>
<li><strong>SaleFinished</strong> - Terminal success state</li>
<li><strong>SaleFailed</strong> - Free slot on market and transition to error</li>
<li><strong>SaleCancelled</strong> - Cancellation path</li>
<li><strong>SaleIgnored</strong> - Sale ignored (no matching availability or other conditions)</li>
<li><strong>SaleErrored</strong> - Terminal error state</li>
<li><strong>SaleUnknown</strong> - Recovery state for crash recovery</li>
<li><strong>SaleProvingSimulated</strong> - Proving with injected failures for testing</li>
</ol>
<p>All states move to <code>SaleErrored</code> if an error is raised.</p>
<h5 id="salepreparing"><a class="header" href="#salepreparing">SalePreparing</a></h5>
<ul>
<li>Find a matching availability based on the following criteria: <code>freeSize</code>, <code>duration</code>, <code>collateralPerByte</code>, <code>minPricePerBytePerSecond</code> and <code>until</code></li>
<li>Create a reservation</li>
<li>Move to <code>SaleSlotReserving</code> if successful</li>
<li>Move to <code>SaleIgnored</code> if no availability is found or if <code>BytesOutOfBoundsError</code> is raised because of no space available.</li>
<li>Move to <code>SaleFailed</code> on <code>RequestFailed</code> event from the <code>marketplace</code></li>
<li>Move to <code>SaleCancelled</code> on cancelled timer elapsed, set to storage contract expiry</li>
</ul>
<h5 id="saleslotreserving"><a class="header" href="#saleslotreserving">SaleSlotReserving</a></h5>
<ul>
<li>Check if the slot can be reserved</li>
<li>Move to <code>SaleDownloading</code> if successful</li>
<li>Move to <code>SaleIgnored</code> if <code>SlotReservationNotAllowedError</code> is raised or the slot cannot be reserved. The collateral is returned.</li>
<li>Move to <code>SaleFailed</code> on <code>RequestFailed</code> event from the <code>marketplace</code></li>
<li>Move to <code>SaleCancelled</code> on cancelled timer elapsed, set to storage contract expiry</li>
</ul>
<h5 id="saledownloading"><a class="header" href="#saledownloading">SaleDownloading</a></h5>
<ul>
<li>Select the correct data expiry:
<ul>
<li>When the request is started, the request end date is used</li>
<li>Otherwise the expiry date is used</li>
</ul>
</li>
<li>Stream and persist data via <code>onStore</code></li>
<li>For each written batch, release bytes from the reservation</li>
<li>Move to <code>SaleInitialProving</code> if successful</li>
<li>Move to <code>SaleFailed</code> on <code>RequestFailed</code> event from the <code>marketplace</code></li>
<li>Move to <code>SaleCancelled</code> on cancelled timer elapsed, set to storage contract expiry</li>
<li>Move to <code>SaleFilled</code> on <code>SlotFilled</code> event from the <code>marketplace</code></li>
</ul>
<h5 id="saleinitialproving"><a class="header" href="#saleinitialproving">SaleInitialProving</a></h5>
<ul>
<li>Wait for a stable initial challenge</li>
<li>Produce the initial proof via <code>onProve</code></li>
<li>Move to <code>SaleFilling</code> if successful</li>
<li>Move to <code>SaleFailed</code> on <code>RequestFailed</code> event from the <code>marketplace</code></li>
<li>Move to <code>SaleCancelled</code> on cancelled timer elapsed, set to storage contract expiry</li>
</ul>
<h5 id="salefilling"><a class="header" href="#salefilling">SaleFilling</a></h5>
<ul>
<li>Get the slot collateral</li>
<li>Fill the slot</li>
<li>Move to <code>SaleFilled</code> if successful</li>
<li>Move to <code>SaleIgnored</code> on <code>SlotStateMismatchError</code>. The collateral is returned.</li>
<li>Move to <code>SaleFailed</code> on <code>RequestFailed</code> event from the <code>marketplace</code></li>
<li>Move to <code>SaleCancelled</code> on cancelled timer elapsed, set to storage contract expiry</li>
</ul>
<h5 id="salefilled"><a class="header" href="#salefilled">SaleFilled</a></h5>
<ul>
<li>Ensure that the current host has filled the slot by checking the signer address</li>
<li>Notify by calling <code>onFilled</code> hook</li>
<li>Call <code>onExpiryUpdate</code> to change the data expiry from expiry date to request end date</li>
<li>Move to <code>SaleProving</code> (or <code>SaleProvingSimulated</code> for simulated mode)</li>
<li>Move to <code>SaleFailed</code> on <code>RequestFailed</code> event from the <code>marketplace</code></li>
<li>Move to <code>SaleCancelled</code> on cancelled timer elapsed, set to storage contract expiry</li>
</ul>
<h5 id="saleproving"><a class="header" href="#saleproving">SaleProving</a></h5>
<ul>
<li>For each period: fetch challenge, call <code>onProve</code>, and submit proof</li>
<li>Move to <code>SalePayout</code> when the slot request ends</li>
<li>Re-raise <code>SlotFreedError</code> when the slot is freed</li>
<li>Raise <code>SlotNotFilledError</code> when the slot is not filled</li>
<li>Move to <code>SaleFailed</code> on <code>RequestFailed</code> event from the <code>marketplace</code></li>
<li>Move to <code>SaleCancelled</code> on cancelled timer elapsed, set to storage contract expiry</li>
</ul>
<h5 id="saleprovingsimulated"><a class="header" href="#saleprovingsimulated">SaleProvingSimulated</a></h5>
<ul>
<li>Submit invalid proofs every <code>N</code> periods (<code>failEveryNProofs</code> in configuration) to test failure scenarios</li>
</ul>
<h5 id="salepayout"><a class="header" href="#salepayout">SalePayout</a></h5>
<ul>
<li>Get the current collateral and try to free the slot to ensure that the slot is freed after payout.</li>
<li>Forward the returned collateral to cleanup</li>
<li>Move to <code>SaleFinished</code> if successful</li>
<li>Move to <code>SaleFailed</code> on <code>RequestFailed</code> event from the <code>marketplace</code></li>
<li>Move to <code>SaleCancelled</code> on cancelled timer elapsed, set to storage contract expiry</li>
</ul>
<h5 id="salefinished"><a class="header" href="#salefinished">SaleFinished</a></h5>
<ul>
<li>Call <code>onClear</code> hook</li>
<li>Call <code>onCleanUp</code> hook</li>
</ul>
<h5 id="salefailed"><a class="header" href="#salefailed">SaleFailed</a></h5>
<ul>
<li>Free the slot</li>
<li>Move to <code>SaleErrored</code> with the failure message</li>
</ul>
<h5 id="salecancelled"><a class="header" href="#salecancelled">SaleCancelled</a></h5>
<ul>
<li>Ensure that the node hosting the slot frees the slot</li>
<li>Call <code>onClear</code> hook</li>
<li>Call <code>onCleanUp</code> hook with the current collateral</li>
</ul>
<h5 id="saleignored"><a class="header" href="#saleignored">SaleIgnored</a></h5>
<ul>
<li>Call <code>onCleanUp</code> hook with the current collateral</li>
</ul>
<h5 id="saleerrored"><a class="header" href="#saleerrored">SaleErrored</a></h5>
<ul>
<li>Call <code>onClear</code> hook</li>
<li>Call <code>onCleanUp</code> hook</li>
</ul>
<h5 id="saleunknown"><a class="header" href="#saleunknown">SaleUnknown</a></h5>
<ul>
<li>Recovery entry: get the <code>on-chain</code> state and jump to the appropriate state</li>
</ul>
<h4 id="slot-queue"><a class="header" href="#slot-queue">Slot Queue</a></h4>
<p>Slot queue schedules slot work and instantiates one <code>SalesAgent</code> per item with bounded concurrency.</p>
<ul>
<li>Accepts <code>(requestId, slotIndex, …)</code> items and orders them by priority</li>
<li>Spawns one <code>SalesAgent</code> for each dequeued item, in other words, one item for one agent</li>
<li>Caps concurrent agents to <code>maxWorkers</code></li>
<li>Supports pause/resume</li>
<li>Allows controlled requeue when an agent finishes with <code>reprocessSlot</code></li>
</ul>
<h5 id="slot-ordering"><a class="header" href="#slot-ordering">Slot Ordering</a></h5>
<p>The criteria are in the following order:</p>
<ol>
<li><strong>Unseen before seen</strong> - Items that have not been seen are dequeued first.</li>
<li><strong>More profitable first</strong> - Higher <code>profitability</code> wins. <code>profitability</code> is <code>duration * pricePerSlotPerSecond</code>.</li>
<li><strong>Less collateral first</strong> - The item with the smaller <code>collateral</code> wins.</li>
<li><strong>Later expiry first</strong> - If both items carry an <code>expiry</code>, the one with the greater timestamp wins.</li>
</ol>
<p>Within a single request, per-slot items are shuffled before enqueuing so the default slot-index order does not influence priority.</p>
<h5 id="pause--resume"><a class="header" href="#pause--resume">Pause / Resume</a></h5>
<p>When the Slot queue processes an item with <code>seen = true</code>, it means that the item was already evaluated against the current availabilities and did not match.
To avoid draining the queue with untenable requests (due to insufficient availability), the queue pauses itself.</p>
<p>The queue resumes when:</p>
<ul>
<li><code>OnAvailabilitySaved</code> fires after an availability update that increases one of: <code>freeSize</code>, <code>duration</code>, <code>minPricePerBytePerSecond</code>, or <code>totalRemainingCollateral</code>.</li>
<li>A new unseen item (<code>seen = false</code>) is pushed.</li>
<li><code>unpause()</code> is called explicitly.</li>
</ul>
<h5 id="reprocess"><a class="header" href="#reprocess">Reprocess</a></h5>
<p>Availability matching occurs in <code>SalePreparing</code>.
If no availability fits at that time, the sale is ignored with <code>reprocessSlot</code> to true, meaning that the slot is added back to the queue with the flag <code>seen</code> to true.</p>
<h5 id="startup"><a class="header" href="#startup">Startup</a></h5>
<p>On <code>SlotQueue.start()</code>, the sales module first deletes reservations associated with inactive storage requests, then starts a new <code>SalesAgent</code> for each active storage request:</p>
<ul>
<li>Fetch the active <code>on-chain</code> active slots.</li>
<li>Delete the local reservations for slots that are not in the active list.</li>
<li>Create a new agent for each slot and assign the <code>onCleanUp</code> callback.</li>
<li>Start the agent in the <code>SaleUnknown</code> state.</li>
</ul>
<h4 id="main-behaviour"><a class="header" href="#main-behaviour">Main Behaviour</a></h4>
<p>When a new slot request is received, the sales module extracts the pair <code>(requestId, slotIndex, …)</code> from the request.
A <code>SlotQueueItem</code> is then created with metadata such as <code>profitability</code>, <code>collateral</code>, <code>expiry</code>, and the <code>seen</code> flag set to <code>false</code>.
This item is pushed into the <code>SlotQueue</code>, where it will be prioritised according to the ordering rules.</p>
<h4 id="salesagent"><a class="header" href="#salesagent">SalesAgent</a></h4>
<p>SalesAgent is the instance that executes the state machine for a single slot.</p>
<ul>
<li>Executes the sale state machine across the slot lifecycle</li>
<li>Holds a <code>SalesContext</code> with dependencies and host hooks</li>
<li>Supports crash recovery via the <code>SaleUnknown</code> state</li>
<li>Handles errors by entering <code>SaleErrored</code>, which runs cleanup routines</li>
</ul>
<h4 id="salescontext"><a class="header" href="#salescontext">SalesContext</a></h4>
<p>SalesContext is a container for dependencies used by all sales.</p>
<ul>
<li>Provides external interfaces: <code>Market</code> (marketplace) and <code>Clock</code></li>
<li>Provides access to <code>Reservations</code></li>
<li>Provides host hooks: <code>onStore</code>, <code>onProve</code>, <code>onExpiryUpdate</code>, <code>onClear</code>, <code>onSale</code></li>
<li>Shares the <code>SlotQueue</code> handle for scheduling work</li>
<li>Provides configuration such as <code>simulateProofFailures</code></li>
<li>Passed to each <code>SalesAgent</code></li>
</ul>
<h4 id="marketplace-subscriptions"><a class="header" href="#marketplace-subscriptions">Marketplace Subscriptions</a></h4>
<p>The sales module subscribes to on-chain events to keep the queue and agents consistent.</p>
<h5 id="storagerequested"><a class="header" href="#storagerequested">StorageRequested</a></h5>
<p>When the marketplace signals a new request, the sales module:</p>
<ul>
<li>Computes collateral for free slots.</li>
<li>Creates per-slot <code>SlotQueueItem</code> entries (one per <code>slotIndex</code>) with <code>seen = false</code>.</li>
<li>Pushes the items into the <code>SlotQueue</code>.</li>
</ul>
<h5 id="slotfreed"><a class="header" href="#slotfreed">SlotFreed</a></h5>
<p>When the marketplace signals a freed slot (needs repair), the sales module:</p>
<ul>
<li>Retrieves the request data for the <code>requestId</code>.</li>
<li>Computes collateral for repair.</li>
<li>Creates a <code>SlotQueueItem</code>.</li>
<li>Pushes the item into the <code>SlotQueue</code>.</li>
</ul>
<h5 id="requestcancelled"><a class="header" href="#requestcancelled">RequestCancelled</a></h5>
<p>When a request is cancelled, the sales module removes all queue items for that <code>requestId</code>.</p>
<h5 id="requestfulfilled"><a class="header" href="#requestfulfilled">RequestFulfilled</a></h5>
<p>When a request is fulfilled, the sales module removes all queue items for that <code>requestId</code> and notifies active agents bound to the request.</p>
<h5 id="requestfailed"><a class="header" href="#requestfailed">RequestFailed</a></h5>
<p>When a request fails, the sales module removes all queue items for that <code>requestId</code> and notifies active agents bound to the request.</p>
<h5 id="slotfilled"><a class="header" href="#slotfilled">SlotFilled</a></h5>
<p>When a slot is filled, the sales module removes the queue item for that specific <code>(requestId, slotIndex)</code> and notifies the active agent for that slot.</p>
<h5 id="slotreservationsfull"><a class="header" href="#slotreservationsfull">SlotReservationsFull</a></h5>
<p>When the marketplace signals that reservations are full, the sales module removes the queue item for that specific <code>(requestId, slotIndex)</code>.</p>
<h4 id="reservations"><a class="header" href="#reservations">Reservations</a></h4>
<p>The Reservations module manages both Availabilities and Reservations.
When an Availability is created, it reserves bytes in the storage module so no other modules can use those bytes.
Before a dataset for a slot is downloaded, a Reservation is created, and the freeSize of the Availability is reduced.
When bytes are downloaded, the reservation of those bytes in the storage module is released.
Accounting of both reserved bytes in the storage module and freeSize in the Availability are cleaned up upon completion of the state machine.</p>
<pre><code class="language-mermaid">graph TD
    A[Availability] --&gt;|creates| R[Reservation]
    A --&gt;|reserves bytes in| SM[Storage Module]
    R --&gt;|reduces| AF[Availability.freeSize]
    R --&gt;|downloads data| D[Dataset]
    D --&gt;|releases bytes to| SM
    TC[Terminal State] --&gt;|triggers cleanup| C[Cleanup]
    C --&gt;|returns bytes to| AF
    C --&gt;|deletes| R
    C --&gt;|returns collateral to| A
</code></pre>
<h4 id="hooks"><a class="header" href="#hooks">Hooks</a></h4>
<ul>
<li><strong>onStore</strong>: streams data into the node's storage</li>
<li><strong>onProve</strong>: produces proofs for initial and periodic proving</li>
<li><strong>onExpiryUpdate</strong>: notifies the client node of a change in the expiry data</li>
<li><strong>onSale</strong>: notifies that the host is now responsible for the slot</li>
<li><strong>onClear</strong>: notification emitted once the state machine has concluded; used to reconcile Availability bytes and reserved bytes in the storage module</li>
<li><strong>onCleanUp</strong>: cleanup hook called in terminal states to release resources, delete reservations, and return collateral to availabilities</li>
</ul>
<h4 id="error-handling-1"><a class="header" href="#error-handling-1">Error Handling</a></h4>
<ul>
<li>Always catch <code>CancelledError</code> from <code>nim-chronos</code> and log a trace, exiting gracefully</li>
<li>Catch <code>CatchableError</code>, log it, and route to <code>SaleErrored</code></li>
</ul>
<h4 id="cleanup"><a class="header" href="#cleanup">Cleanup</a></h4>
<p>Cleanup releases resources held by a sales agent and optionally requeues the slot.</p>
<ul>
<li>Return reserved bytes to the availability if a reservation exists</li>
<li>Delete the reservation and return any remaining collateral</li>
<li>If <code>reprocessSlot</code> is true, push the slot back into the queue marked as seen</li>
<li>Remove the agent from the sales set and track the removal future</li>
</ul>
<h4 id="resource-management-approach"><a class="header" href="#resource-management-approach">Resource Management Approach</a></h4>
<p>The nim-codex implementation uses Availabilities and Reservations to manage local storage resources:</p>
<h5 id="reservation-management"><a class="header" href="#reservation-management">Reservation Management</a></h5>
<ul>
<li>Maintain <code>Availability</code> and <code>Reservation</code> records locally</li>
<li>Match incoming slot requests to available capacity using prioritisation rules</li>
<li>Lock capacity and collateral when creating a reservation</li>
<li>Release reserved bytes progressively during download and free all remaining resources in terminal states</li>
</ul>
<p><strong>Note:</strong> Availabilities and Reservations are completely local to the Storage Provider implementation and are not visible at the protocol level. They provide one approach to managing storage capacity, but other implementations may use different resource management strategies.</p>
<hr />
<blockquote>
<p><strong>Protocol Compliance Note</strong>: The Storage Provider implementation described above is specific to nim-codex. The only normative requirements for Storage Providers are defined in the <a href="codex/raw/codex-marketplace.html#storage-provider-role">Storage Provider Role</a> section of Part I. Implementations must satisfy those protocol requirements but may use completely different internal designs.</p>
</blockquote>
<h3 id="client-implementation"><a class="header" href="#client-implementation">Client Implementation</a></h3>
<p>The nim-codex reference implementation provides a complete Client implementation with state machine management for storage request lifecycles. This section documents the nim-codex approach.</p>
<p>The nim-codex implementation uses a state machine pattern to manage purchase lifecycles, providing deterministic state transitions, explicit terminal states, and recovery support. The state machine definitions (state identifiers, transitions, state descriptions, requirements, data models, and interfaces) are documented in the subsections below.</p>
<blockquote>
<p><strong>Note</strong>: The Purchase module terminology and state machine design are specific to the nim-codex implementation. The protocol only requires that clients interact with the marketplace smart contract as specified in the Client Role section.</p>
</blockquote>
<h4 id="state-identifiers"><a class="header" href="#state-identifiers">State Identifiers</a></h4>
<ul>
<li>PurchasePending: <code>pending</code></li>
<li>PurchaseSubmitted: <code>submitted</code></li>
<li>PurchaseStarted: <code>started</code></li>
<li>PurchaseFinished: <code>finished</code></li>
<li>PurchaseErrored: <code>errored</code></li>
<li>PurchaseCancelled: <code>cancelled</code></li>
<li>PurchaseFailed: <code>failed</code></li>
<li>PurchaseUnknown: <code>unknown</code></li>
</ul>
<h4 id="general-rules-for-all-states"><a class="header" href="#general-rules-for-all-states">General Rules for All States</a></h4>
<ul>
<li>If a <code>CancelledError</code> is raised, the state machine logs the cancellation message and takes no further action.</li>
<li>If a <code>CatchableError</code> is raised, the state machine moves to <code>errored</code> with the error message.</li>
</ul>
<h4 id="state-transitions"><a class="header" href="#state-transitions">State Transitions</a></h4>
<pre><code class="language-text">                                                                      |
                                                                      v
                                         ------------------------- unknown
        |                               /                             /
        v                              v                             /
     pending ----&gt; submitted ----&gt; started ---------&gt; finished &lt;----/
                        \              \                           /
                         \              ------------&gt; failed &lt;----/
                          \                                      /
                           --&gt; cancelled &lt;-----------------------
</code></pre>
<p><strong>Note:</strong></p>
<p>Any state can transition to errored upon a <code>CatchableError</code>.
<code>failed</code> is an intermediate state before <code>errored</code>.
<code>finished</code>, <code>cancelled</code>, and <code>errored</code> are terminal states.</p>
<h4 id="state-descriptions"><a class="header" href="#state-descriptions">State Descriptions</a></h4>
<p><strong>Pending State (<code>pending</code>)</strong></p>
<p>A storage request is being created by making a call <code>on-chain</code>. If the storage request creation fails, the state machine moves to the <code>errored</code> state with the corresponding error.</p>
<p><strong>Submitted State (<code>submitted</code>)</strong></p>
<p>The storage request has been created and the purchase waits for the request to start. When it starts, an <code>on-chain</code> event <code>RequestFulfilled</code> is emitted, triggering the subscription callback, and the state machine moves to the <code>started</code> state. If the expiry is reached before the callback is called, the state machine moves to the <code>cancelled</code> state.</p>
<p><strong>Started State (<code>started</code>)</strong></p>
<p>The purchase is active and waits until the end of the request, defined by the storage request parameters, before moving to the <code>finished</code> state. A subscription is made to the marketplace to be notified about request failure. If a request failure is notified, the state machine moves to <code>failed</code>.</p>
<p>Marketplace subscription signature:</p>
<pre><code class="language-nim">method subscribeRequestFailed*(market: Market, requestId: RequestId, callback: OnRequestFailed): Future[Subscription] {.base, async.}
</code></pre>
<p><strong>Finished State (<code>finished</code>)</strong></p>
<p>The purchase is considered successful and cleanup routines are called. The purchase module calls <code>marketplace.withdrawFunds</code> to release the funds locked by the marketplace:</p>
<pre><code class="language-nim">method withdrawFunds*(market: Market, requestId: RequestId) {.base, async: (raises: [CancelledError, MarketError]).}
</code></pre>
<p>After that, the purchase is done; no more states are called and the state machine stops successfully.</p>
<p><strong>Failed State (<code>failed</code>)</strong></p>
<p>If the marketplace emits a <code>RequestFailed</code> event, the state machine moves to the <code>failed</code> state and the purchase module calls <code>marketplace.withdrawFunds</code> (same signature as above) to release the funds locked by the marketplace. After that, the state machine moves to <code>errored</code>.</p>
<p><strong>Cancelled State (<code>cancelled</code>)</strong></p>
<p>The purchase is cancelled and the purchase module calls <code>marketplace.withdrawFunds</code> to release the funds locked by the marketplace (same signature as above). After that, the purchase is terminated; no more states are called and the state machine stops with the reason of failure as error.</p>
<p><strong>Errored State (<code>errored</code>)</strong></p>
<p>The purchase is terminated; no more states are called and the state machine stops with the reason of failure as error.</p>
<p><strong>Unknown State (<code>unknown</code>)</strong></p>
<p>The purchase is in recovery mode, meaning that the state has to be determined. The purchase module calls the marketplace to get the request data (<code>getRequest</code>) and the request state (<code>requestState</code>):</p>
<pre><code class="language-nim">method getRequest*(market: Market, id: RequestId): Future[?StorageRequest] {.base, async: (raises: [CancelledError]).}

method requestState*(market: Market, requestId: RequestId): Future[?RequestState] {.base, async.}
</code></pre>
<p>Based on this information, it moves to the corresponding next state.</p>
<blockquote>
<p><strong>Note</strong>: Functional and non-functional requirements for the client role are summarized in the <a href="https://github.com/codex-storage/codex-spec/blob/master/specs/marketplace.md">Codex Marketplace Specification</a>. The requirements listed below are specific to the nim-codex Purchase module implementation.</p>
</blockquote>
<h4 id="functional-requirements"><a class="header" href="#functional-requirements">Functional Requirements</a></h4>
<h5 id="purchase-definition"><a class="header" href="#purchase-definition">Purchase Definition</a></h5>
<ul>
<li>Every purchase MUST represent exactly one <code>StorageRequest</code></li>
<li>The purchase MUST have a unique, deterministic identifier <code>PurchaseId</code> derived from <code>requestId</code></li>
<li>It MUST be possible to restore any purchase from its <code>requestId</code> after a restart</li>
<li>A purchase is considered expired when the expiry timestamp in its <code>StorageRequest</code> is reached before the request start, i.e, an event <code>RequestFulfilled</code> is emitted by the <code>marketplace</code></li>
</ul>
<h5 id="state-machine-progression"><a class="header" href="#state-machine-progression">State Machine Progression</a></h5>
<ul>
<li>New purchases MUST start in the <code>pending</code> state (submission flow)</li>
<li>Recovered purchases MUST start in the <code>unknown</code> state (recovery flow)</li>
<li>The state machine MUST progress step-by-step until a deterministic terminal state is reached</li>
<li>The choice of terminal state MUST be based on the <code>RequestState</code> returned by the <code>marketplace</code></li>
</ul>
<h5 id="failure-handling"><a class="header" href="#failure-handling">Failure Handling</a></h5>
<ul>
<li>On marketplace failure events, the purchase MUST immediately transition to <code>errored</code> without retries</li>
<li>If a <code>CancelledError</code> is raised, the state machine MUST log the cancellation and stop further processing</li>
<li>If a <code>CatchableError</code> is raised, the state machine MUST transition to <code>errored</code> and record the error</li>
</ul>
<h4 id="non-functional-requirements"><a class="header" href="#non-functional-requirements">Non-Functional Requirements</a></h4>
<h5 id="execution-model"><a class="header" href="#execution-model">Execution Model</a></h5>
<p>A purchase MUST be handled by a single thread; only one worker SHOULD process a given purchase instance at a time.</p>
<h5 id="reliability-1"><a class="header" href="#reliability-1">Reliability</a></h5>
<p><code>load</code> supports recovery after process restarts.</p>
<h5 id="performance"><a class="header" href="#performance">Performance</a></h5>
<p>State transitions should be non-blocking; all I/O is async.</p>
<h5 id="logging"><a class="header" href="#logging">Logging</a></h5>
<p>All state transitions and errors should be clearly logged for traceability.</p>
<h5 id="safety"><a class="header" href="#safety">Safety</a></h5>
<ul>
<li>Avoid side effects during <code>new</code> other than initialising internal fields; <code>on-chain</code> interactions are delegated to states using <code>marketplace</code> dependency.</li>
<li>Retry policy for external calls.</li>
</ul>
<h5 id="testing"><a class="header" href="#testing">Testing</a></h5>
<ul>
<li>Unit tests check that each state handles success and error properly.</li>
<li>Integration tests check that a full purchase flows correctly through states.</li>
</ul>
<hr />
<blockquote>
<p><strong>Protocol Compliance Note</strong>: The Client implementation described above is specific to nim-codex. The only normative requirements for Clients are defined in the <a href="codex/raw/codex-marketplace.html#client-role">Client Role</a> section of Part I. Implementations must satisfy those protocol requirements but may use completely different internal designs.</p>
</blockquote>
<hr />
<h2 id="copyright-55"><a class="header" href="#copyright-55">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-45"><a class="header" href="#references-45">References</a></h2>
<h3 id="normative-2"><a class="header" href="#normative-2">Normative</a></h3>
<ul>
<li><a href="https://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a> - Key words for use in RFCs to Indicate Requirement Levels</li>
<li><a href="https://hackmd.io/FB58eZQoTNm-dnhu0Y1XnA">Reed-Solomon algorithm</a> - Erasure coding algorithm used for data encoding</li>
<li><a href="https://github.com/multiformats/cid#cidv1">CIDv1</a> - Content Identifier specification</li>
<li><a href="https://github.com/multiformats/multihash">multihash</a> - Self-describing hashes</li>
<li><a href="https://hackmd.io/2uRBltuIT7yX0CyczJevYg?view">Proof-of-Data-Possession</a> - Zero-knowledge proof system for storage verification</li>
<li><a href="https://github.com/codex-storage/codex-spec/blob/master/specs/marketplace.md">Original Codex Marketplace Spec</a> - Source specification for this document</li>
</ul>
<h3 id="informative-4"><a class="header" href="#informative-4">Informative</a></h3>
<ul>
<li><a href="https://github.com/codex-storage/nim-codex">Codex Implementation</a> - Reference implementation in Nim</li>
<li><a href="https://github.com/codex-storage/nim-codex/blob/master/codex/market.nim">Codex market implementation</a> - Marketplace module implementation</li>
<li><a href="https://github.com/codex-storage/codex-docs-obsidian/blob/main/10%20Notes/Specs/Component%20Specification%20-%20Sales.md">Codex Sales Component Spec</a> - Storage Provider implementation details</li>
<li><a href="https://github.com/codex-storage/codex-docs-obsidian/blob/main/10%20Notes/Specs/Component%20Specification%20-%20Purchase.md">Codex Purchase Component Spec</a> - Client implementation details</li>
<li><a href="https://github.com/status-im/nim-chronos">Nim Chronos</a> - Async/await framework for Nim</li>
<li><a href="https://github.com/codex-storage/codex-research/blob/41c4b4409d2092d0a5475aca0f28995034e58d14/design/storage-proof-timing.md">Storage proof timing design</a> - Proof timing mechanism</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="status-rfcs"><a class="header" href="#status-rfcs">Status RFCs</a></h1>
<p>Status is a communication tool providing privacy features for the user.
Specifications can also be viewed at <a href="https://status.app/specs">Status</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="24status-curation"><a class="header" href="#24status-curation">24/STATUS-CURATION</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Status Community Directory Curation Voting using Waku v2</td></tr>
<tr><th>Slug</th><td>24</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Szymon Szlachtowicz &lt;szymon.s@ethworks.io&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-60"><a class="header" href="#timeline-60">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/24/curation.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/24/curation.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/status/24/curation.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-02-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/60fcdd5737ad55b4d9da90e09610ffa06fa4032c/status/24/curation.md"><code>60fcdd5</code></a> — Update curation.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/de298338905426f9f2cb0e374e11b789ecc543bf/status/24/curation.md"><code>de29833</code></a> — Create curation.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-35"><a class="header" href="#abstract-35">Abstract</a></h2>
<p>This specification is a voting protocol for peers to submit votes to a smart contract.
Voting is immutable,
this will help avoid sabotage from malicious peers.</p>
<h2 id="motivation-27"><a class="header" href="#motivation-27">Motivation</a></h2>
<p>In open p2p protocol there is an issue with voting off-chain
as there is much room for malicious peers to only include votes that support
their case when submitting votes to chain.</p>
<p>Proposed solution is to aggregate votes over waku and
allow users to submit votes to smart contract that aren't already submitted.</p>
<h3 id="smart-contract"><a class="header" href="#smart-contract">Smart contract</a></h3>
<p>Voting should be finalized on chain so that the finished vote is immutable.
Because of that, smart contract needs to be deployed.
When votes are submitted
smart contract has to verify what votes are properly signed and
that sender has correct amount of SNT.
When Vote is verified
the amount of SNT voted on specific topic by specific sender is saved on chain.</p>
<h3 id="double-voting"><a class="header" href="#double-voting">Double voting</a></h3>
<p>Smart contract should also keep a list of all signatures so
that no one can send the same vote twice.
Another possibility is to allow each sender to only vote once.</p>
<h3 id="initializing-vote"><a class="header" href="#initializing-vote">Initializing Vote</a></h3>
<p>When someone wants to initialize vote
he has to send a transaction to smart contract that will create a new voting session.
When initializing a user has to specify type of vote (Addition, Deletion),
amount of his initial SNT to submit and public key of community under vote.
Smart contract will return a ID which is identifier of voting session.
Also there will be function on Smart Contract that
when given community public key it will return voting session ID or
undefined if community isn't under vote.</p>
<h2 id="voting"><a class="header" href="#voting">Voting</a></h2>
<h3 id="sending-votes"><a class="header" href="#sending-votes">Sending votes</a></h3>
<p>Sending votes is simple every peer is able to send a message to Waku topic
specific to given application:</p>
<pre><code class="language-json">
/status-community-directory-curation-vote/1/{voting-session-id}/json

</code></pre>
<p>vote object that is sent over waku should contain information about:</p>
<pre><code class="language-ts">type Vote = {
    sender: string // address of the sender
    vote: string // vote sent eg. 'yes' 'no'
    sntAmount: BigNumber //number of snt cast on vote
    sign: string // cryptographic signature of a transaction (signed fields: sender,vote,sntAmount,nonce,sessionID)
    nonce: number // number of votes cast from this address on current vote 
    // (only if we allow multiple votes from the same sender)
    sessionID: number // ID of voting session
}
</code></pre>
<h3 id="aggregating-votes"><a class="header" href="#aggregating-votes">Aggregating votes</a></h3>
<p>Every peer that is opening specific voting session
will listen to votes sent over p2p network, and
aggregate them for a single transaction to chain.</p>
<h3 id="submitting-to-chain"><a class="header" href="#submitting-to-chain">Submitting to chain</a></h3>
<p>Every peer that has aggregated at least one vote
will be able to send them to smart contract.
When someone votes he will aggregate his own vote and
will be able to immediately send it.</p>
<p>Peer doesn't need to vote to be able to submit the votes to the chain.</p>
<p>Smart contract needs to verify that all votes are valid
(eg. all senders had enough SNT, all votes are correctly signed) and
that votes aren't duplicated on smart contract.</p>
<h3 id="finalizing"><a class="header" href="#finalizing">Finalizing</a></h3>
<p>Once the vote deadline has expired, the smart contract will not accept votes anymore.
Also directory will be updated according to vote results
(community added to directory, removed etc.)</p>
<h2 id="copyright-56"><a class="header" href="#copyright-56">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="28status-featuring"><a class="header" href="#28status-featuring">28/STATUS-FEATURING</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Status community featuring using waku v2</td></tr>
<tr><th>Slug</th><td>28</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>Szymon Szlachtowicz &lt;szymon.s@ethworks.io&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-61"><a class="header" href="#timeline-61">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/28/featuring.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/28/featuring.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/status/28/featuring.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-02-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/1255162d40f33f6a037596174690a9eb4d99c572/status/28/featuring.md"><code>1255162</code></a> — Update featuring.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/86cafd8523ee34e6c5aa28a54b22e5a8483ff638/status/28/featuring.md"><code>86cafd8</code></a> — Create featuring.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-36"><a class="header" href="#abstract-36">Abstract</a></h2>
<p>This specification describes a voting method to feature different active Status Communities.</p>
<h2 id="overview-7"><a class="header" href="#overview-7">Overview</a></h2>
<p>When there is a active community that is seeking new members,
current users of community should be able to feature their community so
that it will be accessible to larger audience.
Status community curation DApp should provide such a tool.</p>
<p>Rules of featuring:
- Given community can't be featured twice in a row.
- Only one vote per user per community (single user can vote on multiple communities)
- Voting will be done off-chain
- If community hasn't been featured
votes for given community are still valid for the next 4 weeks</p>
<p>Since voting for featuring is similar to polling solutions proposed
in this spec could be also used for different applications.</p>
<h3 id="voting-1"><a class="header" href="#voting-1">Voting</a></h3>
<p>Voting for featuring will be done through waku v2.</p>
<p>Payload of waku message will be :</p>
<pre><code class="language-ts">type FeatureVote = {
    voter: string // address of a voter
    sntAmount: BigNumber // amount of snt voted on featuring
    communityPK: string // public key of community
    timestamp: number // timestamp of message, must match timestamp of wakuMessage
    sign: string // cryptographic signature of a transaction (signed fields: voterAddress,sntAmount,communityPK,timestamp)
}
</code></pre>
<p>timestamp is necessary so that votes can't be reused after 4 week period</p>
<h3 id="counting-votes"><a class="header" href="#counting-votes">Counting Votes</a></h3>
<p>Votes will be counted by the DApp itself.
DApp will aggregate all the votes in the last 4 weeks and
calculate which communities should be displayed in the Featured tab of DApp.</p>
<p>Rules of counting:
- When multiple votes from the same address on the same community are encountered
only the vote with highest timestamp is considered valid.
- If a community has been featured in a previous week
it can't be featured in current week.
- In a current week top 5 (or 10) communities with highest amount of SNT votes
up to previous Sunday 23:59:59 UTC are considered featured.</p>
<h2 id="copyright-57"><a class="header" href="#copyright-57">Copyright</a></h2>
<p>Copyright and related rights waived via
<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="55status-1to1-chat"><a class="header" href="#55status-1to1-chat">55/STATUS-1TO1-CHAT</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Status 1-to-1 Chat</td></tr>
<tr><th>Slug</th><td>55</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Aaryamann Challani &lt;p1ge0nh8er@proton.me&gt;</td></tr>
<tr><th>Contributors</th><td>Andrea Piana &lt;andreap@status.im&gt;<br>Pedro Pombeiro &lt;pedro@status.im&gt;<br>Corey Petty &lt;corey@status.im&gt;<br>Oskar Thorén &lt;oskarth@titanproxy.com&gt;<br>Dean Eigenmann &lt;dean@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-62"><a class="header" href="#timeline-62">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/55/1to1-chat.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/55/1to1-chat.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/status/55/1to1-chat.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-09-12</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/0b4d15163850762de0c62445ac093bfd2315a076/status/55/1to1-chat.md"><code>0b4d151</code></a> — Update 1to1-chat.md (#92)</li>
<li><strong>2024-08-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eb25cd06d679e94409072a96841de16a6b3910d5/status/55/1to1-chat.md"><code>eb25cd0</code></a> — chore: replace email addresses (#86)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/status/55/1to1-chat.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-07</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/e95c5c694731481588b25fedadba913461413f31/status/55/1to1-chat.md"><code>e95c5c6</code></a> — Update 1to1-chat.md</li>
<li><strong>2024-02-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/44baefd1e692b3c0a9a8258840b85885d945d1ee/status/55/1to1-chat.md"><code>44baefd</code></a> — Update 1to1-chat.md</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/e105bea76bf0324660226a752f36c509559bdf93/status/55/1to1-chat.md"><code>e105bea</code></a> — Update and rename 1TO1-CHAT.md to 1to1-chat.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/4a8585b25be704a52e668f1cf0a0e0546809b66c/status/55/1TO1-CHAT.md"><code>4a8585b</code></a> — Create 1TO1-CHAT.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-37"><a class="header" href="#abstract-37">Abstract</a></h2>
<p>This specification describes how the Status 1-to-1 chat protocol is implemented
on top of the Waku v2 protocol.
This protocol can be used to send messages to a single recipient.</p>
<h2 id="terminology-5"><a class="header" href="#terminology-5">Terminology</a></h2>
<ul>
<li><strong>Participant</strong>: A participant is a user that is able to send and receive messages.</li>
<li><strong>1-to-1 chat</strong>: A chat between two participants.</li>
<li><strong>Public chat</strong>: A chat where any participant can join and read messages.</li>
<li><strong>Private chat</strong>: A chat where only invited participants can join and read messages.</li>
<li><strong>Group chat</strong>: A chat where multiple select participants can join and read messages.</li>
<li><strong>Group admin</strong>: A participant that is able to
add/remove participants from a group chat.</li>
</ul>
<h2 id="background-4"><a class="header" href="#background-4">Background</a></h2>
<p>This document describes how 2 peers communicate with each other
to send messages in a 1-to-1 chat, with privacy and authenticity guarantees.</p>
<h2 id="specification-10"><a class="header" href="#specification-10">Specification</a></h2>
<h3 id="overview-8"><a class="header" href="#overview-8">Overview</a></h3>
<p>This protocol MAY use any key-exchange mechanism previously discussed -</p>
<ol>
<li><a href="status/55/../../waku/standards/application/53/x3dh.html">53/WAKU2-X3DH</a></li>
<li><a href="https://github.com/waku-org/specs/blob/master/standards/application/noise.md">WAKU2-NOISE</a></li>
</ol>
<p>This protocol can provide end-to-end encryption
to give peers a strong degree of privacy and security.
Public chat messages are publicly readable by anyone since
there's no permission model for who is participating in a public chat.</p>
<h2 id="chat-flow"><a class="header" href="#chat-flow">Chat Flow</a></h2>
<h3 id="negotiation-of-a-11-chat"><a class="header" href="#negotiation-of-a-11-chat">Negotiation of a 1:1 chat</a></h3>
<p>There are two phases in the initial negotiation of a 1:1 chat:</p>
<ol>
<li><strong>Identity verification</strong>
(e.g., face-to-face contact exchange through QR code, Identicon matching).
A QR code serves two purposes simultaneously -
identity verification and initial key material retrieval;</li>
<li><strong>Asynchronous initial key exchange</strong></li>
</ol>
<p>For more information on account generation and trust establishment, see <a href="status/55/../65/account-address.html">65/ACCOUNT-ADDRESS</a></p>
<h3 id="post-negotiation"><a class="header" href="#post-negotiation">Post Negotiation</a></h3>
<p>After the peers have shared their public key material,
a 1:1 chat can be established using the methods described in the
key-exchange protocols mentioned above.</p>
<h3 id="session-management"><a class="header" href="#session-management">Session management</a></h3>
<p>The 1:1 chat is made robust by having sessions between peers.
It is handled by the key-exchange protocol used. For example,</p>
<ol>
<li>
<p><a href="status/55/../../waku/standards/application/53/x3dh.html">53/WAKU2-X3DH</a>,
the session management is described in <a href="status/55/../../waku/standards/application/54/x3dh-sessions.html">54/WAKU2-X3DH-SESSIONS</a></p>
</li>
<li>
<p><a href="https://github.com/waku-org/specs/blob/master/standards/application/noise.md">WAKU2-NOISE</a>,
the session management is described in <a href="https://github.com/waku-org/specs/blob/master/standards/application/noise-sessions.md">WAKU2-NOISE-SESSIONS</a></p>
</li>
</ol>
<h2 id="negotiation-of-a-11-chat-amongst-multiple-participants-group-chat"><a class="header" href="#negotiation-of-a-11-chat-amongst-multiple-participants-group-chat">Negotiation of a 1:1 chat amongst multiple participants (group chat)</a></h2>
<p>A small, private group chat can be constructed by having multiple participants
negotiate a 1:1 chat amongst each other.
Each participant MUST
maintain a session with all other participants in the group chat.
This allows for a group chat to be created with a small number of participants.</p>
<p>However, this method does not scale as the number of participants increases,
for the following reasons -</p>
<ol>
<li>The number of messages sent over the network increases with the number of participants.</li>
<li>Handling the X3DH key exchange for each participant is computationally expensive.</li>
</ol>
<p>The above issues are addressed in <a href="status/55/../56/communities.html">56/STATUS-COMMUNITIES</a>,
with other trade-offs.</p>
<h3 id="flow-9"><a class="header" href="#flow-9">Flow</a></h3>
<p>The following flow describes how a group chat is created and maintained.</p>
<h4 id="membership-update-flow"><a class="header" href="#membership-update-flow">Membership Update Flow</a></h4>
<p>Membership updates have the following wire format:</p>
<pre><code class="language-protobuf">message MembershipUpdateMessage {
  // The chat id of the private group chat
  // derived in the following way:
  // chat_id = hex(chat_creator_public_key) + "-" + random_uuid
  // This chat_id MUST be validated by all participants
  string chat_id = 1;
  // A list of events for this group chat, first 65 bytes are the signature, 
  then is a 
  // protobuf encoded MembershipUpdateEvent
  repeated bytes events = 2;
  oneof chat_entity {
    // An optional chat message
    ChatMessage message = 3;
    // An optional reaction to a message
    EmojiReaction emoji_reaction = 4; 
  }
}
</code></pre>
<p>Note that in <code>events</code>, the first element is the signature, and
all other elements after are encoded <code>MembershipUpdateEvent</code>'s.</p>
<p>where <code>MembershipUpdateEvent</code> is defined as follows:</p>
<pre><code class="language-protobuf">message MembershipUpdateEvent {
  // Lamport timestamp of the event
  uint64 clock = 1;
  // Optional list of public keys of the targets of the action
  repeated string members = 2;
  // Name of the chat for the CHAT_CREATED/NAME_CHANGED event types
  string name = 3;
  // The type of the event
  EventType type = 4;
  // Color of the chat for the CHAT_CREATED/COLOR_CHANGED event types
  string color = 5;
  // Chat image
  bytes image = 6;

  enum EventType {
    UNKNOWN = 0;
    CHAT_CREATED = 1; // See [CHAT_CREATED](#chat-created)
    NAME_CHANGED = 2; // See [NAME_CHANGED](#name-changed)
    MEMBERS_ADDED = 3; // See [MEMBERS_ADDED](#members-added)
    MEMBER_JOINED = 4; // See [MEMBER_JOINED](#member-joined)
    MEMBER_REMOVED = 5; // See [MEMBER_REMOVED](#member-removed)
    ADMINS_ADDED = 6; // See [ADMINS_ADDED](#admins-added)
    ADMIN_REMOVED = 7; // See [ADMIN_REMOVED](#admin-removed)
    COLOR_CHANGED = 8; // See [COLOR_CHANGED](#color-changed)
    IMAGE_CHANGED = 9; // See [IMAGE_CHANGED](#image-changed)
  }
}
</code></pre>
<!-- Note: 
I don't like defining wire formats which are out of the scope of the rfc this way. 
Should explore alternatives -->
<p>Note that the definitions for <code>ChatMessage</code> and
<code>EmojiReaction</code> can be found in
<a href="https://github.com/status-im/status-go/blob/5fd9e93e9c298ed087e6716d857a3951dbfb3c1e/protocol/protobuf/chat_message.proto#L1">chat_message.proto</a>
and <a href="https://github.com/status-im/status-go/blob/5fd9e93e9c298ed087e6716d857a3951dbfb3c1e/protocol/protobuf/emoji_reaction.proto">emoji_reaction.proto</a>.</p>
<h5 id="chat-created"><a class="header" href="#chat-created">Chat Created</a></h5>
<p>When creating a group chat, this is the first event that MUST be sent.
Any event with a clock value lower than this MUST be discarded.
Upon receiving this event a client MUST validate the <code>chat_id</code>
provided with the update and
create a chat with identified by <code>chat_id</code>.</p>
<p>By default, the creator of the group chat is the only group admin.</p>
<h5 id="name-changed"><a class="header" href="#name-changed">Name Changed</a></h5>
<p>To change the name of the group chat, group admins MUST use a <code>NAME_CHANGED</code> event.
Upon receiving this event,
a client MUST validate the <code>chat_id</code> provided with the updates and
MUST ensure the author of the event is an admin of the chat,
otherwise the event MUST be ignored.
If the event is valid the chat name SHOULD be changed according to the provided message.</p>
<h5 id="members-added"><a class="header" href="#members-added">Members Added</a></h5>
<p>To add members to the chat, group admins MUST use a <code>MEMBERS_ADDED</code> event.
Upon receiving this event,
a participant MUST validate the <code>chat_id</code> provided with the updates and
MUST ensure the author of the event is an admin of the chat,
otherwise the event MUST be ignored.
If the event is valid,
a participant MUST update the list of members of the chat who have not joined,
adding the members received.</p>
<h5 id="member-joined"><a class="header" href="#member-joined">Member Joined</a></h5>
<p>To signal the intent to start receiving messages from a given chat,
new participants MUST use a <code>MEMBER_JOINED</code> event.
Upon receiving this event,
a participant MUST validate the <code>chat_id</code> provided with the updates.
If the event is valid a participant,
a participant MUST add the new participant to the list of participants stored locally.
Any message sent to the group chat MUST now include the new participant.</p>
<h5 id="member-removed"><a class="header" href="#member-removed">Member Removed</a></h5>
<p>There are two ways in which a member MAY be removed from a group chat:</p>
<ul>
<li>A member MAY leave the chat by sending a <code>MEMBER_REMOVED</code> event,
with the <code>members</code> field containing their own public key.</li>
<li>An admin MAY remove a member by sending a <code>MEMBER_REMOVED</code> event,
with the <code>members</code> field containing the public key of the member to be removed.</li>
</ul>
<p>Each participant MUST validate the <code>chat_id</code> provided with the updates and
MUST ensure the author of the event is an admin of the chat,
otherwise the event MUST be ignored.
If the event is valid, a participant MUST update the local list of members accordingly.</p>
<h5 id="admins-added"><a class="header" href="#admins-added">Admins Added</a></h5>
<p>To promote participants to group admin, group admins MUST use an <code>ADMINS_ADDED</code> event.
Upon receiving this event,
a participant MUST validate the <code>chat_id</code> provided with the updates,
MUST ensure the author of the event is an admin of the chat,
otherwise the event MUST be ignored.
If the event is valid,
a participant MUST update the list of admins of the chat accordingly.</p>
<h5 id="admin-removed"><a class="header" href="#admin-removed">Admin Removed</a></h5>
<p>Group admins MUST NOT be able to remove other group admins.
An admin MAY remove themselves by sending an <code>ADMIN_REMOVED</code> event,
with the <code>members</code> field containing their own public key.
Each participant MUST validate the <code>chat_id</code> provided with the updates and
MUST ensure the author of the event is an admin of the chat,
otherwise the event MUST be ignored.
If the event is valid, a participant MUST update the list of admins of the chat accordingly.</p>
<h5 id="color-changed"><a class="header" href="#color-changed">Color Changed</a></h5>
<p>To change the text color of the group chat name,
group admins MUST use a <code>COLOR_CHANGED</code> event.</p>
<h5 id="image-changed"><a class="header" href="#image-changed">Image Changed</a></h5>
<p>To change the display image of the group chat,
group admins MUST use an <code>IMAGE_CHANGED</code> event.</p>
<h2 id="security-considerations-18"><a class="header" href="#security-considerations-18">Security Considerations</a></h2>
<ol>
<li>Inherits the security considerations of the key-exchange mechanism used,
e.g., <a href="status/55/../../waku/standards/application/53/x3dh.html">53/WAKU2-X3DH</a> or <a href="https://github.com/waku-org/specs/blob/master/standards/application/noise.md">WAKU2-NOISE</a></li>
</ol>
<h2 id="copyright-58"><a class="header" href="#copyright-58">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-46"><a class="header" href="#references-46">References</a></h2>
<ol>
<li><a href="status/55/../../waku/standards/application/53/x3dh.html">53/WAKU2-X3DH</a></li>
<li><a href="https://github.com/waku-org/specs/blob/master/standards/application/noise.md">WAKU2-NOISE</a></li>
<li><a href="status/55/../65/account-address.html">65/STATUS-ACCOUNT</a></li>
<li><a href="status/55/../../waku/standards/application/54/x3dh-sessions.html">54/WAKU2-X3DH-SESSIONS</a></li>
<li><a href="https://github.com/waku-org/specs/blob/master/standards/application/noise-sessions.md">WAKU2-NOISE-SESSIONS</a></li>
<li><a href="status/55/../56/communities.html">56/STATUS-COMMUNITIES</a></li>
<li><a href="https://github.com/status-im/status-go/blob/5fd9e93e9c298ed087e6716d857a3951dbfb3c1e/protocol/protobuf/chat_message.proto#L1">chat_message.proto</a></li>
<li><a href="https://github.com/status-im/status-go/blob/5fd9e93e9c298ed087e6716d857a3951dbfb3c1e/protocol/protobuf/emoji_reaction.proto">emoji_reaction.proto</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="56status-communities"><a class="header" href="#56status-communities">56/STATUS-COMMUNITIES</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Status Communities that run over Waku v2</td></tr>
<tr><th>Slug</th><td>56</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Aaryamann Challani &lt;p1ge0nh8er@proton.me&gt;</td></tr>
<tr><th>Contributors</th><td>Andrea Piana &lt;andreap@status.im&gt;<br>Prem Chaitanya Prathi &lt;prem@waku.org&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-63"><a class="header" href="#timeline-63">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/56/communities.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/56/communities.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-03-07</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/f4b34afd1a1e198b0d99b911bf8b371b5b13a6b8/status/56/communities.md"><code>f4b34af</code></a> — Fix Linting Errors (#135)</li>
<li><strong>2025-02-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/9bed57e4ad5d6609202a18f581a00b2fd81f6acb/status/56/communities.md"><code>9bed57e</code></a> — docs: define basic sharding for Communities (#132)</li>
<li><strong>2025-01-02</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/dc7497a3123623f2834d80ebd3a7c77e0d605074/status/56/communities.md"><code>dc7497a</code></a> — add usage guidelines for waku content topics (#117)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/status/56/communities.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-08-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eb25cd06d679e94409072a96841de16a6b3910d5/status/56/communities.md"><code>eb25cd0</code></a> — chore: replace email addresses (#86)</li>
<li><strong>2024-02-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/11bdc3bbb705afe1b493bbb40d61e2e6d7af6a6a/status/56/communities.md"><code>11bdc3b</code></a> — Update communities.md</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/83507420c3060f93acac0454276a69df40c4b52c/status/56/communities.md"><code>8350742</code></a> — Update and rename COMMUNITIES.md to communities.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/a786356887a5443d4624a076e878314b30aa4609/status/56/COMMUNITIES.md"><code>a786356</code></a> — Create COMMUNITIES.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-38"><a class="header" href="#abstract-38">Abstract</a></h2>
<p>This document describes the design of Status Communities over Waku v2,
allowing for multiple users to communicate in a discussion space.
This is a key feature for the Status messaging app.</p>
<h2 id="background-and-motivation-1"><a class="header" href="#background-and-motivation-1">Background and Motivation</a></h2>
<p>The purpose of Status communities, as specified in this document,
is allowing for large group chats.
Communities can have further substructure, e.g. specific channels.</p>
<p>Smaller group chats, on the other hand,
are out of scope for this document and
can be built over <a href="status/56/../55/1to1-chat.html">55/STATUS-1TO1-CHAT</a>.
We refer to these smaller group chats simply as "group chats",
to differentiate them from Communities.</p>
<p>For group chats based on <a href="status/56/../55/1to1-chat.html">55/STATUS-1TO1-CHAT</a>,
the key exchange mechanism MUST be X3DH,
as described in <a href="status/56/../../waku/standards/application/53/x3dh.html">53/WAKU2-X3DH</a>.</p>
<p>However, this method does not scale as the number of participants increases,
for the following reasons -</p>
<ol>
<li>The number of messages sent over the network increases with the number of participants.</li>
<li>Handling the X3DH key exchange for each participant is computationally expensive.</li>
</ol>
<p>Having multicast channels reduces the overhead of a group chat based on 1:1 chat.
Additionally, if all the participants of the group chat have a shared key,
then the number of messages sent over the network is reduced to one per message.</p>
<h2 id="terminology-6"><a class="header" href="#terminology-6">Terminology</a></h2>
<ul>
<li><strong>Community</strong>: A group of peers that can communicate with each other.</li>
<li><strong>Member</strong>: A peer that is part of a community.</li>
<li><strong>Admin</strong>: A member that has administrative privileges.
Used interchangeably with "owner".</li>
<li><strong>Channel</strong>: A designated subtopic for a community. Used interchangeably with "chat".</li>
</ul>
<h2 id="design-requirements-5"><a class="header" href="#design-requirements-5">Design Requirements</a></h2>
<p>Due to the nature of communities,
the following requirements are necessary for the design of communities  -</p>
<ol>
<li>The creator of the Community is the owner of the Community.</li>
<li>The Community owner is trusted.</li>
<li>The Community owner can add or remove members from the Community.
This extends to banning and kicking members.</li>
<li>The Community owner can add, edit and remove channels.</li>
<li>Community members can send/receive messages
to the channels which they have access to.</li>
<li>Communities may be encrypted (private) or unencrypted (public).</li>
<li>A Community is uniquely identified by a public key.</li>
<li>The public key of the Community is shared out of band.</li>
<li>The metadata of the Community can be found by listening on a content topic
derived from the public key of the Community.</li>
<li>Community members run their own Waku nodes,
with the configuration described in <a href="status/56/communities.html#waku-protocols">Waku-Protocols</a>.
Light nodes solely implementing
<a href="status/56/../../waku/standards/core/19/lightpush.html">19/WAKU2-LIGHTPUSH</a>
may not be able to run their own Waku node with the configuration described.</li>
</ol>
<h2 id="design-1"><a class="header" href="#design-1">Design</a></h2>
<h3 id="cryptographic-primitives-1"><a class="header" href="#cryptographic-primitives-1">Cryptographic Primitives</a></h3>
<p>The following cryptographic primitives are used in the design -</p>
<ul>
<li>X3DH</li>
<li>Single Ratchet
<ul>
<li>The single ratchet is used to encrypt the messages sent to the Community.</li>
<li>The single ratchet is re-keyed when a member is added/removed from the Community.</li>
</ul>
</li>
</ul>
<h2 id="wire-format-4"><a class="header" href="#wire-format-4">Wire format</a></h2>
<!--   
The wire format is described first to give an overview of the protocol.
It is referenced in the flow of community creation and community management.
More or less an intersection of https://github.com/status-im/specs/blob/403b5ce316a270565023fc6a1f8dec138819f4b0/docs/raw/organisation-channels.md 
and https://github.com/status-im/status-go/blob/6072bd17ab1e5d9fc42cf844fcb8ad18aa07760c/protocol/protobuf/communities.proto,

-->
<pre><code class="language-protobuf">syntax = "proto3";

message IdentityImage {
  // payload is a context based payload for the profile image data,
  // context is determined by the `source_type`
  bytes payload = 1;
  // source_type signals the image payload source
  SourceType source_type = 2;
  // image_type signals the image type and method of parsing the payload
  ImageType image_type = 3;
  // encryption_keys is a list of encrypted keys that can be used to decrypt an 
  // encrypted payload
  repeated bytes encryption_keys = 4;
  // encrypted signals the encryption state of the payload, default is false.
  bool encrypted = 5;
  // SourceType are the predefined types of image source allowed
  enum SourceType {
    UNKNOWN_SOURCE_TYPE = 0;

    // RAW_PAYLOAD image byte data
    RAW_PAYLOAD = 1;

    // ENS_AVATAR uses the ENS record's resolver get-text-data.avatar data
    // The `payload` field will be ignored if ENS_AVATAR is selected
    // The application will read and 
    // parse the ENS avatar data as image payload data, URLs will be ignored
    // The parent `ChatMessageIdentity` must have a valid `ens_name` set
    ENS_AVATAR = 2;
  }
}

// SocialLinks represents social link associated with given chat identity (personal/community)
message SocialLink {
  // Type of the social link
  string text = 1;
  // URL of the social link
  string url = 2;
}
// ChatIdentity represents identity of a community/chat
message ChatIdentity {
  // Lamport timestamp of the message
  uint64 clock = 1;
  // ens_name is the valid ENS name associated with the chat key
  string ens_name = 2;
  // images is a string indexed mapping of images associated with an identity
  map&lt;string, IdentityImage&gt; images = 3;
  // display name is the user set identity
  string display_name = 4;
  // description is the user set description
  string description = 5;
  string color = 6;
  string emoji = 7;
  repeated SocialLink social_links = 8;
  // first known message timestamp in seconds 
  // (valid only for community chats for now)
  // 0 - unknown
  // 1 - no messages
  uint32 first_message_timestamp = 9;
}

message Grant {
  // Community ID (The public key of the community)
  bytes community_id = 1;
  // The member ID (The public key of the member)
  bytes member_id = 2;
  // The chat for which the grant is given
  string chat_id = 3;
  // The Lamport timestamp of the grant
  uint64 clock = 4;
}

message CommunityMember {
  // The roles a community member MAY have
  enum Roles {
    UNKNOWN_ROLE = 0;
    ROLE_ALL = 1;
    ROLE_MANAGE_USERS = 2;
    ROLE_MODERATE_CONTENT = 3;
  }
  repeated Roles roles = 1;
}

message CommunityPermissions {
  // The type of access a community MAY have
  enum Access {
    UNKNOWN_ACCESS = 0;
    NO_MEMBERSHIP = 1;
    INVITATION_ONLY = 2;
    ON_REQUEST = 3;
  }

  // If the community should be available only to ens users
  bool ens_only = 1;
  // If the community is private
  bool private = 2;
  Access access = 3;
}

message CommunityAdminSettings {
  // If the Community admin may pin messages
  bool pin_message_all_members_enabled = 1;
}

message CommunityChat {
  // A map of members in the community to their roles in a chat
  map&lt;string,CommunityMember&gt; members = 1;
  // The permissions of the chat
  CommunityPermissions permissions = 2;
  // The metadata of the chat
  ChatIdentity identity = 3;
  // The category of the chat
  string category_id = 4;
  // The position of chat in the display
  int32 position = 5;
}

message CommunityCategory {
  // The category id 
  string category_id = 1;
  // The name of the category
  string name = 2;
  // The position of the category in the display
  int32 position = 3;
}

message CommunityInvitation {
  // Encrypted/unencrypted community description
  bytes community_description = 1;
  // The grant offered by the community
  bytes grant = 2;
  // The chat id requested to join
  string chat_id = 3;
  // The public key of the community
  bytes public_key = 4;
}

message CommunityRequestToJoin {
  // The Lamport timestamp of the request  
  uint64 clock = 1;
  // The ENS name of the requester
  string ens_name = 2;
  // The chat id requested to join
  string chat_id = 3;
  // The public key of the community
  bytes community_id = 4;
  // The display name of the requester
  string display_name = 5;
}

message CommunityCancelRequestToJoin {
  // The Lamport timestamp of the request
  uint64 clock = 1;
  // The ENS name of the requester
  string ens_name = 2;
  // The chat id requested to join
  string chat_id = 3;
  // The public key of the community
  bytes community_id = 4;
  // The display name of the requester
  string display_name = 5;
  // Magnet uri for community history protocol
  string magnet_uri = 6;
}

message CommunityRequestToJoinResponse {
  // The Lamport timestamp of the request
  uint64 clock = 1;
  // The community description
  CommunityDescription community = 2;
  // If the request was accepted
  bool accepted = 3;
  // The grant offered by the community
  bytes grant = 4;
  // The community public key
  bytes community_id = 5;
}

message CommunityRequestToLeave {
  // The Lamport timestamp of the request
  uint64 clock = 1;
  // The community public key
  bytes community_id = 2;
}

message CommunityDescription {
  // The Lamport timestamp of the message
  uint64 clock = 1;
  // A mapping of members in the community to their roles
  map&lt;string,CommunityMember&gt; members = 2;
  // The permissions of the Community
  CommunityPermissions permissions = 3;
  // The metadata of the Community
  ChatIdentity identity = 5;
  // A mapping of chats to their details
  map&lt;string,CommunityChat&gt; chats = 6;
  // A list of banned members
  repeated string ban_list = 7;
  // A mapping of categories to their details
  map&lt;string,CommunityCategory&gt; categories = 8;
  // The admin settings of the Community
  CommunityAdminSettings admin_settings = 10;
  // If the community is encrypted
  bool encrypted = 13;
  // The list of tags
  repeated string tags = 14;
}
</code></pre>
<p>Note: The usage of the clock is described in the <a href="status/56/communities.html#clock">Clock</a> section.</p>
<h3 id="functional-scope-and-shard-assignment"><a class="header" href="#functional-scope-and-shard-assignment">Functional scope and shard assignment</a></h3>
<p>We define two special <a href="status/56/../raw/status-app-protocols.html#functional-scope">functional scopes</a> for messages related to Status Communities:</p>
<ol>
<li>Global community control</li>
<li>Global community content</li>
</ol>
<p>All messages that relate to controlling communities MUST be assigned the <em>global community control</em> scope.
All messages that carry user-generated content for communities MUST be assigned the <em>global community content</em> scope.</p>
<blockquote>
<p><strong>Note:</strong> a previous iteration of Status Communities defined separate community-wide scopes for each community.
However, this model was deprecated and all communities now operate on a global, shared scope.
This implies that different communities will share shards on the routing layer.</p>
</blockquote>
<p>The following <a href="status/56/../raw/status-app-protocols.html#waku-transport-layer">Waku transport layer</a> allocations are reserved for communities:
As per <a href="https://rfc.vac.dev/status/raw/simple-scaling/#relay-shards">STATUS-SIMPLE-SCALING</a>, communities use the default cluster ID <code>16</code>
set aside for all Status app protocols.
Within this cluster, the following <a href="status/56/../raw/status-app-protocols.html#pubsub-topics-and-sharding">shards</a> are reserved for the community functional scopes:</p>
<ol>
<li>All messages with a <em>global community control</em> scope MUST be published to shard <code>128</code></li>
<li>All messages with a <em>global community content</em> scope MUST be published to shard <code>256</code></li>
</ol>
<h3 id="content-topic-level-encryption"><a class="header" href="#content-topic-level-encryption">Content topic level encryption</a></h3>
<p>-a universal chat identifier is used for all community chats.</p>
<!-- Don't enforce any constraints on the unique id generation -->
<p>All messages are encrypted before they are handed over to waku ir-respective of the encryption explained above.
All community chats are encrypted using a symmetric key generated from universal chat id using pbkdf2.</p>
<pre><code class="language-js">symKey = pbkdf2(password:universalChatID, salt:nil, iteration-count:65356,key-length:32, hash-func: random-sha256)
</code></pre>
<h3 id="content-topic-usage"><a class="header" href="#content-topic-usage">Content topic usage</a></h3>
<p>"Content topic" refers to the field in <a href="status/56/../../waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a>,
further elaborated in <a href="status/56/../../waku/standards/core/10/waku2.html">10/WAKU2</a>.
The content-topic usage follows the guidelines specified at <a href="status/56/../../waku/informational/23/topics.html#content-topic-usage-guidelines">23/topics</a></p>
<h4 id="advertising-a-community"><a class="header" href="#advertising-a-community">Advertising a Community</a></h4>
<p>The content topic that the community is advertised on
MUST be derived from the public key of the community.
The content topic MUST be the first four bytes of the keccak-256 hash
of the compressed (33 bytes) public key of the community encoded into a hex string.</p>
<pre><code class="language-js">hash = hex(keccak256(encodeToHex(compressedPublicKey)))

topicLen = 4
if len(hash) &lt; topicLen {
    topicLen = len(hash)
}

var topic [4]byte
for i = 0; i &lt; topicLen; i++ {
    topic[i] = hash[i]
}

contentTopic = "/waku/1/0x" + topic + "/rfc26"
</code></pre>
<h4 id="community-event-messages"><a class="header" href="#community-event-messages">Community event messages</a></h4>
<p>Message such as community description
MUST be sent to the content topic derived from the public key of the community.
The content topic
MUST be the hex-encoded keccak-256 hash of the public key of the community.</p>
<pre><code class="language-js">hash = hex(keccak256(encodeToHex(publicKey)))

topicLen = 4
if len(hash) &lt; topicLen {
    topicLen = len(hash)
}
var topic [4]byte
for i = 0; i &lt; topicLen; i++ {
    topic[i] = hash[i]
}

contentTopic = "/waku/1/0x" + topic + "/rfc26"
</code></pre>
<h4 id="community-requests"><a class="header" href="#community-requests">Community Requests</a></h4>
<p>Requests to leave, join, kick and ban, as well as key exchange messages, MUST be sent to the content topic derived from the public key of the community on the common shard.</p>
<p>The content topic
MUST be the keccak-256 hash of hex-encoded universal chat id (public key appended with fixed string) of the community omitting the first 2 bytes.</p>
<pre><code class="language-js">universalChatId = publicKey+"-memberUpdate"
hash = hex(keccak256(encodeToHex(universalChatId))[2:])

topicLen = 4
if len(hash) &lt; topicLen {
    topicLen = len(hash)
}
var topic [4]byte
for i = 0; i &lt; topicLen; i++ {
    topic[i] = hash[i]
}

contentTopic = "/waku/1/0x" + topic + "/rfc26"
</code></pre>
<h4 id="community-shard-info"><a class="header" href="#community-shard-info">Community Shard Info</a></h4>
<p>If a community is assigned a dedicated shard then the shard info for that community is published on a content topic derived from a specialized key. This is useful for users joining the new community so that they can subscribe to this specific content topic.</p>
<pre><code class="language-js">chatID = publicKey+"-shard-info"
hash = hex(keccak256(encodeToHex(chatID))[2:])

topicLen = 4
if len(hash) &lt; topicLen {
    topicLen = len(hash)
}
var topic [4]byte
for i = 0; i &lt; topicLen; i++ {
    topic[i] = hash[i]
}

contentTopic = "/waku/1/0x" + topic + "/rfc26"
</code></pre>
<h4 id="community-channelschats"><a class="header" href="#community-channelschats">Community channels/chats</a></h4>
<p>All channels/chats shall use a single content-topic which is derived from a universal chat id irrespective of their individual unique chat ids.</p>
<h3 id="community-management"><a class="header" href="#community-management">Community Management</a></h3>
<p>The flows for Community management are as described below.</p>
<h4 id="community-creation-flow"><a class="header" href="#community-creation-flow">Community Creation Flow</a></h4>
<ol>
<li>The Community owner generates a public/private key pair.</li>
<li>The Community owner configures the Community metadata,
according to the wire format "CommunityDescription".</li>
<li>The Community owner publishes the Community metadata on a content topic
derived from the public key of the Community.
the Community metadata SHOULD be encrypted with the public key of the Community.
The Community metadata is sent during fixed intervals,
to ensure that the Community metadata is available to members.
The Community metadata SHOULD be sent every time the Community metadata is updated.</li>
<li>The Community owner MAY advertise the Community out of band,
by sharing the public key of the Community on other mediums of communication.</li>
</ol>
<h4 id="community-join-flow-peer-requests-to-join-a-community"><a class="header" href="#community-join-flow-peer-requests-to-join-a-community">Community Join Flow (peer requests to join a Community)</a></h4>
<ol>
<li>A peer and the Community owner establish a 1:1 chat as described in <a href="status/56/../55/1to1-chat.html">55/STATUS-1TO1-CHAT</a>.</li>
<li>The peer requests to join a Community by sending a
"CommunityRequestToJoin" message to the Community.
At this point, the peer MAY send a
"CommunityCancelRequestToJoin" message to cancel the request.</li>
<li>The Community owner MAY accept or reject the request.</li>
<li>If the request is accepted,
the Community owner sends a "CommunityRequestToJoinResponse" message to the peer.</li>
<li>The Community owner then adds the member to the Community metadata, and
publishes the updated Community metadata.</li>
</ol>
<h4 id="community-join-flow-peer-is-invited-to-join-a-community"><a class="header" href="#community-join-flow-peer-is-invited-to-join-a-community">Community Join Flow (peer is invited to join a Community)</a></h4>
<ol>
<li>The Community owner and peer establish a 1:1 chat as described in <a href="status/56/../55/1to1-chat.html">55/STATUS-1TO1-CHAT</a>.</li>
<li>The peer is invited to join a Community by the Community owner,
by sending a "CommunityInvitation" message.</li>
<li>The peer decrypts the "CommunityInvitation" message, and verifies the signature.</li>
<li>The peer requests to join a Community by sending a
"CommunityRequestToJoin" message to the Community.</li>
<li>The Community owner MAY accept or reject the request.</li>
<li>If the request is accepted,
the Community owner sends a "CommunityRequestToJoinResponse" message to the peer.</li>
<li>The Community owner then adds the member to the Community metadata, and
publishes the updated Community metadata.</li>
</ol>
<h4 id="community-leave-flow"><a class="header" href="#community-leave-flow">Community Leave Flow</a></h4>
<ol>
<li>A member requests to leave a Community by sending a
"CommunityRequestToLeave" message to the Community.</li>
<li>The Community owner MAY accept or reject the request.</li>
<li>If the request is accepted,
the Community owner removes the member from the Community metadata,
and publishes the updated Community metadata.</li>
</ol>
<h4 id="community-ban-flow"><a class="header" href="#community-ban-flow">Community Ban Flow</a></h4>
<ol>
<li>The Community owner adds a member to the ban list, revokes their grants,
and publishes the updated Community metadata.</li>
<li>If the Community is Private,
Re-keying is performed between the members of the Community,
to ensure that the banned member is unable to decrypt any messages.</li>
</ol>
<h3 id="waku-protocols"><a class="header" href="#waku-protocols">Waku Protocols</a></h3>
<p>The following Waku protocols SHOULD be used to implement Status Communities -</p>
<ol>
<li><a href="status/56/../../waku/standards/core/11/relay.html">11/WAKU2-RELAY</a> -
To send and receive messages</li>
<li><a href="status/56/../../waku/standards/application/53/x3dh.html">53/WAKU2-X3DH</a> -
To encrypt and decrypt messages</li>
<li><a href="status/56/../../waku/standards/application/54/x3dh-sessions.html">54/WAKU2-X3DH-SESSIONS</a>-
To handle session keys</li>
<li><a href="status/56/../../waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a> -
To wrap community messages in a Waku message</li>
<li><a href="status/56/../../waku/standards/core/13/store.html">13/WAKU2-STORE</a> -
To store and retrieve messages for offline devices</li>
</ol>
<p>The following Waku protocols MAY be used to implement Status Communities -</p>
<ol>
<li><a href="status/56/../../waku/standards/core/12/filter.html">12/WAKU2-FILTER</a> -
Content filtering for resource restricted devices</li>
<li><a href="status/56/../../waku/standards/core/19/lightpush.html">19/WAKU2-LIGHTPUSH</a> -
Allows Light clients to participate in the network</li>
</ol>
<h3 id="backups"><a class="header" href="#backups">Backups</a></h3>
<p>The member MAY back up their local settings,
by encrypting it with their public key, and
sending it to a given content topic.
The member MAY then rely on this backup to restore their local settings,
in case of a data loss.
This feature relies on
<a href="status/56/../../waku/standards/core/13/store.html">13/WAKU2-STORE</a>
for storing and retrieving messages.</p>
<h3 id="clock-1"><a class="header" href="#clock-1">Clock</a></h3>
<p>The clock used in the wire format refers to the Lamport timestamp of the message.
The Lamport timestamp is a logical clock that is used to determine the order of events
in a distributed system.
This allows ordering of messages in an asynchronous network
where messages may be received out of order.</p>
<h2 id="security-considerations-19"><a class="header" href="#security-considerations-19">Security Considerations</a></h2>
<ol>
<li>
<p>The Community owner is a single point of failure.
If the Community owner is compromised, the Community is compromised.</p>
</li>
<li>
<p>Follows the same security considerations as the
<a href="status/56/../../waku/standards/application/53/x3dh.html">53/WAKU2-X3DH</a> protocol.</p>
</li>
</ol>
<h2 id="future-work-3"><a class="header" href="#future-work-3">Future work</a></h2>
<ol>
<li>
<p>To scale and optimize the Community management,
the Community metadata should be stored on a decentralized storage system, and
only the references to the Community metadata should be broadcasted.
The following document describes this method in more detail -
<a href="https://hackmd.io/rD1OfIbJQieDe3GQdyCRTw">Optimizing the <code>CommunityDescription</code> dissemination</a></p>
</li>
<li>
<p>Token gating for communities</p>
</li>
<li>
<p>Sharding the content topic used for <a href="status/56/communities.html#community-event-messages">#Community Event Messages</a>,
since members of the community don't need to receive all the control messages.</p>
</li>
</ol>
<h2 id="copyright-59"><a class="header" href="#copyright-59">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-47"><a class="header" href="#references-47">References</a></h2>
<ul>
<li><a href="status/56/../55/1to1-chat.html">55/STATUS-1TO1-CHAT</a></li>
<li><a href="status/56/../../waku/standards/application/53/x3dh.html">53/WAKU2-X3DH</a></li>
<li><a href="status/56/../../waku/standards/core/19/lightpush.html">19/WAKU2-LIGHTPUSH</a></li>
<li><a href="status/56/../../waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a></li>
<li><a href="status/56/../../waku/standards/core/10/waku2.html">10/WAKU2</a></li>
<li><a href="status/56/../../waku/standards/core/11/relay.html">11/WAKU2-RELAY</a></li>
<li><a href="status/56/../../waku/standards/application/54/x3dh-sessions.html">54/WAKU2-X3DH-SESSIONS</a></li>
<li><a href="status/56/../../waku/standards/core/13/store.html">13/WAKU2-STORE</a></li>
<li><a href="status/56/../../waku/standards/core/12/filter.html">12/WAKU2-FILTER</a></li>
</ul>
<h3 id="informative-5"><a class="header" href="#informative-5">informative</a></h3>
<ul>
<li><a href="https://github.com/status-im/status-go/blob/6072bd17ab1e5d9fc42cf844fcb8ad18aa07760c/protocol/communities/community.go">community.go</a></li>
<li><a href="https://github.com/status-im/specs/blob/403b5ce316a270565023fc6a1f8dec138819f4b0/docs/raw/organisation-channels.md">organisation-channels.md</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="61status-community-history-service"><a class="header" href="#61status-community-history-service">61/STATUS-Community-History-Service</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Status Community History Service</td></tr>
<tr><th>Slug</th><td>61</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>r4bbit &lt;r4bbit@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Sanaz Taheri &lt;sanaz@status.im&gt;<br>John Lea &lt;john@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-64"><a class="header" href="#timeline-64">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/61/community-history-service.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/61/community-history-service.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/status/61/community-history-service.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-03-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/2eaa7949c4abe7d14e2b9560e8c045bf2e937c9a/status/61/community-history-service.md"><code>2eaa794</code></a> — Broken Links + Change Editors (#26)</li>
<li><strong>2024-02-07</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d8ba50ea62a367f476cd07f0de00b5cd66b128be/status/61/community-history-service.md"><code>d8ba50e</code></a> — Update community-history-service.md</li>
<li><strong>2024-02-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/ad72c49f1ec7780549a78164e4c248584e52793b/status/61/community-history-service.md"><code>ad72c49</code></a> — Create community-history-service.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-39"><a class="header" href="#abstract-39">Abstract</a></h2>
<p>Messages are stored permanently by store nodes
(<a href="status/61/../../waku/standards/core/13/store.html">13/WAKU2-STORE</a>)
for up to a certain configurable period of time,
limited by the overall storage provided by a store node.
Messages older than that period are no longer provided by store nodes,
making it impossible for other nodes to request historical messages
that go beyond that time range.
This raises issues in the case of Status communities,
where recently joined members of a community
are not able to request complete message histories of the community channels.</p>
<p>This specification describes how <strong>Control Nodes</strong>
(which are specific nodes in Status communities)
archive historical message data of their communities,
beyond the time range limit provided by Store Nodes using
the <a href="https://bittorrent.org">BitTorrent</a> protocol.
It also describes how the archives are distributed to community members via
the Status network,
so they can fetch them and gain access to a complete message history.</p>
<h2 id="terminology-7"><a class="header" href="#terminology-7">Terminology</a></h2>
<p>The following terminology is used throughout this specification.
Notice that some actors listed here are nodes that operate in Waku networks only,
while others operate in the Status communities layer):</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>References</th></tr></thead><tbody>
<tr><td>Waku node</td><td>An Waku node (<a href="status/61/../../waku/standards/core/10/waku2.html">10/WAKU2</a>) that implements <a href="status/61/../../waku/standards/core/11/relay.html">11/WAKU2-RELAY</a></td></tr>
<tr><td>Store node</td><td>A Waku node that implements <a href="status/61/../../waku/standards/core/13/store.html">13/WAKU2-STORE</a></td></tr>
<tr><td>Waku network</td><td>A group of Waku nodes forming a graph, connected via <a href="status/61/../../waku/standards/core/11/relay.html">11/WAKU2-RELAY</a></td></tr>
<tr><td>Status user</td><td>An Status account that is used in a Status consumer product, such as Status Mobile or Status Desktop</td></tr>
<tr><td>Status node</td><td>A Status client run by a Status application</td></tr>
<tr><td>Control node</td><td>A Status node that owns the private key for a Status community</td></tr>
<tr><td>Community member</td><td>A Status user that is part of a Status community, not owning the private key of the community</td></tr>
<tr><td>Community member node</td><td>A Status node with message archive capabilities enabled, run by a community member</td></tr>
<tr><td>Live messages</td><td>Waku messages received through the Waku network</td></tr>
<tr><td>BitTorrent client</td><td>A program implementing the <a href="https://bittorrent.org">BitTorrent</a> protocol</td></tr>
<tr><td>Torrent/Torrent file</td><td>A file containing metadata about data to be downloaded by BitTorrent clients</td></tr>
<tr><td>Magnet link</td><td>A link encoding the metadata provided by a torrent file (<a href="https://en.wikipedia.org/wiki/Magnet_URI_scheme">Magnet URI scheme</a>)</td></tr>
</tbody></table>
</div>
<h2 id="requirements--assumptions"><a class="header" href="#requirements--assumptions">Requirements / Assumptions</a></h2>
<p>This specification has the following assumptions:</p>
<ul>
<li>Store nodes,
(<a href="status/61/../../waku/standards/core/13/store.html">13/WAKU2-STORE</a>),
are available 24/7 ensuring constant live message availability.</li>
<li>The storage time range limit is 30 days.</li>
<li>Store nodes have enough storage to persist historical messages for up to 30 days.</li>
<li>No store nodes have storage to persist historical messages older than 30 days.</li>
<li>All nodes are honest.</li>
<li>The network is reliable.</li>
</ul>
<p>Furthermore, it assumes that:</p>
<ul>
<li>Control nodes have enough storage to persist historical messages
older than 30 days.</li>
<li>Control nodes provide archives with historical messages <strong>at least</strong> every 30 days.</li>
<li>Control nodes receive all community messages.</li>
<li>Control nodes are honest.</li>
<li>Control nodes know at least one store node from which it can query historical messages.</li>
</ul>
<p>These assumptions are less than ideal and will be enhanced in future work.
This <a href="https://forum.vac.dev/t/status-communities-protocol-and-product-point-of-view/114">forum discussion</a>
provides more details.</p>
<h2 id="overview-9"><a class="header" href="#overview-9">Overview</a></h2>
<p>The following is a high-level overview of the user flow and
features this specification describes.
For more detailed descriptions, read the dedicated sections in this specification.</p>
<h3 id="serving-community-history-archives"><a class="header" href="#serving-community-history-archives">Serving community history archives</a></h3>
<p>Control nodes go through the following
(high level) process to provide community members with message histories:</p>
<ol>
<li>Community owner creates a Status community
(previously known as <a href="https://github.com/status-im/specs/pull/151">org channels</a>)
which makes its node a Control node.</li>
<li>Community owner enables message archive capabilities
(on by default but can be turned off as well - see <a href="https://github.com/status-im/feature-specs/pull/36">UI feature spec</a>).</li>
<li>A special type of channel to exchange metadata about the archival data is created,
this channel is not visible in the user interface.</li>
<li>Community owner invites community members.</li>
<li>Control node receives messages published in channels and
stores them into a local database.</li>
<li>After 7 days, the control node exports and
compresses last 7 days worth of messages from database and
bundles it together with a
<a href="status/61/community-history-service.html#wakumessagearchiveindex">message archive index</a> into a torrent,
from which it then creates a magnet link (<a href="https://en.wikipedia.org/wiki/Magnet_URI_scheme">Magnet URI scheme</a>,
<a href="https://www.bittorrent.org/beps/bep_0009.html">Extensions for Peers to Send Metadata Files</a>).</li>
<li>Control node sends the magnet link created in step 6 to community members via
special channel created in step 3 through the Waku network.</li>
<li>Every subsequent 7 days,
steps 6 and 7 are repeated and
the new message archive data
is appended to the previously created message archive data.</li>
</ol>
<h3 id="serving-archives-for-missed-messages"><a class="header" href="#serving-archives-for-missed-messages">Serving archives for missed messages</a></h3>
<p>If the control node goes offline
(where "offline" means, the control node's main process is no longer running),
it MUST go through the following process:</p>
<ol>
<li>Control node restarts</li>
<li>Control node requests messages from store nodes
for the missed time range for all channels in their community</li>
<li>All missed messages are stored into control node's local message database</li>
<li>If 7 or more days have elapsed since the last message history torrent was created,
the control node will perform step 6 and
7 of <a href="status/61/community-history-service.html#serving-community-history-archives">Serving community history archives</a>
for every 7 days worth of messages in the missed time range
(e.g. if the node was offline for 30 days, it will create 4 message history archives)</li>
</ol>
<h3 id="receiving-community-history-archives"><a class="header" href="#receiving-community-history-archives">Receiving community history archives</a></h3>
<p>Community member nodes go through the following (high level) process to fetch and
restore community message histories:</p>
<ol>
<li>User joins community and becomes community member (see <a href="status/61/../56/communities.html">org channels spec</a>)</li>
<li>By joining a community,
member nodes automatically subscribe to special channel for
message archive metadata exchange provided by the community</li>
<li>Member node requests live message history
(last 30 days) of all the community channels,
including the special channel from store nodes</li>
<li>Member node receives Waku message
(<a href="status/61/../../waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a>)
that contains the metadata magnet link from the special channel</li>
<li>Member node extracts the magnet link from the Waku message and
passes it to torrent client</li>
<li>Member node downloads
<a href="status/61/community-history-service.html#message-history-archive-index">message archive index</a> file and
determines which message archives are not downloaded yet (all or some)</li>
<li>Member node fetches missing message archive data via torrent</li>
<li>Member node unpacks and
decompresses message archive data to then hydrate its local database,
deleting any messages,
for that community that the database previously stored in the same time range,
as covered by the message history archive</li>
</ol>
<h2 id="storing-live-messages"><a class="header" href="#storing-live-messages">Storing live messages</a></h2>
<p>For archival data serving, the control node MUST store live messages as <a href="status/61/../../waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a>.
This is in addition to their database of application messages.
This is required to provide confidentiality, authenticity,
and integrity of message data distributed via the BitTorrent layer, and
later validated by community members when they unpack message history archives.</p>
<p>Control nodes SHOULD remove those messages from their local databases
once they are older than 30 days and
after they have been turned into message archives and
distributed to the BitTorrent network.</p>
<h3 id="exporting-messages-for-bundling"><a class="header" href="#exporting-messages-for-bundling">Exporting messages for bundling</a></h3>
<p>Control nodes export Waku messages from their local database for creating and
bundling history archives using the following criteria:</p>
<ul>
<li>Waku messages to be exported MUST have a <code>contentTopic</code>
that match any of the topics of the community channels</li>
<li>Waku messages to be exported MUST have a <code>timestamp</code>
that lies within a time range of 7 days</li>
</ul>
<p>The <code>timestamp</code> is determined by the context in which the control node attempts
to create a message history archives as described below:</p>
<ol>
<li>The control node attempts to create an archive periodically
for the past seven days (including the current day).
In this case, the <code>timestamp</code> has to lie within those 7 days.</li>
<li>The control node has been offline
(control node's main process has stopped and needs restart) and
attempts to create archives for all the live messages it has missed
since it went offline.
In this case,
the <code>timestamp</code> has to lie within the day the latest message was received and
the current day.</li>
</ol>
<p>Exported messages MUST be restored as
<a href="status/61/../../waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a> for bundling.
Waku messages that are older than 30 days and
have been exported for bundling can be removed from the control node's database
(control nodes still maintain a database of application messages).</p>
<h2 id="message-history-archives"><a class="header" href="#message-history-archives">Message history archives</a></h2>
<p>Message history archives are represented as <code>WakuMessageArchive</code> and
created from Waku messages exported from the local database.
Message history archives are implemented using the following protocol buffer.</p>
<h3 id="wakumessagehistoryarchive"><a class="header" href="#wakumessagehistoryarchive">WakuMessageHistoryArchive</a></h3>
<p>The <code>from</code> field SHOULD contain a timestamp of the time range's lower bound.
The type parallels the <code>timestamp</code> of <a href="status/61/../../waku/standards/core/14/message.html">WakuMessage</a>.</p>
<p>The <code>to</code> field SHOULD contain a timestamp of the time range's the higher bound.</p>
<p>The <code>contentTopic</code> field MUST contain a list of all communiity channel topics.</p>
<p>The <code>messages</code> field MUST contain all messages that belong into the archive
given its <code>from</code>, <code>to</code> and <code>contentTopic</code> fields.</p>
<p>The <code>padding</code> field MUST contain the amount of zero bytes needed so
that the overall byte size of the protobuf encoded <code>WakuMessageArchive</code>
is a multiple of the <code>pieceLength</code> used to divide the message archive data into pieces.
This is needed for seamless encoding and
decoding of archival data in interation with BitTorrent,
as explained in <a href="status/61/community-history-service.html#creating-message-archive-torrents">creating message archive torrents</a>.</p>
<pre><code class="language-protobuf">syntax = "proto3"

message WakuMessageArchiveMetadata {
  uint8 version = 1
  uint64 from = 2
  uint64 to = 3
  repeated string contentTopic = 4
}

message WakuMessageArchive {
  uint8 version = 1
  WakuMessageArchiveMetadata metadata = 2
  repeated WakuMessage messages = 3 // `WakuMessage` is provided by 14/WAKU2-MESSAGE
  bytes padding = 4
}
</code></pre>
<h2 id="message-history-archive-index"><a class="header" href="#message-history-archive-index">Message History Archive Index</a></h2>
<p>Control nodes MUST provide message archives for the entire community history.
The entirey history consists of a set of <code>WakuMessageArchive</code>'s
where each archive contains a subset of historical <code>WakuMessage</code>s
for a time range of seven days.
All the <code>WakuMessageArchive</code>s are concatenated into a single file as a byte string
(see <a href="status/61/community-history-service.html#ensuring-reproducible-data-pieces">Ensuring reproducible data pieces</a>).</p>
<p>Control nodes MUST create a message history archive index
(<code>WakuMessageArchiveIndex</code>) with metadata that allows receiving nodes
to only fetch the message history archives they are interested in.</p>
<h3 id="wakumessagearchiveindex"><a class="header" href="#wakumessagearchiveindex">WakuMessageArchiveIndex</a></h3>
<p>A <code>WakuMessageArchiveIndex</code> is a map where the key is the KECCAK-256 hash of
the <code>WakuMessageArchiveIndexMetadata</code> derived from a 7-day archive and
the value is an instance of that <code>WakuMessageArchiveIndexMetadata</code>
corresponding to that archive.</p>
<p>The <code>offset</code> field MUST contain the position at which the message history archive
starts in the byte string of the total message archive data.
This MUST be the sum of the length of all previously created message archives
in bytes (see <a href="status/61/community-history-service.html#creating-message-archive-torrents">Creating message archive torrents</a>).</p>
<pre><code class="language-protobuf">syntax = "proto3"

message WakuMessageArchiveIndexMetadata {
  uint8 version = 1
  WakuMessageArchiveMetadata metadata = 2
  uint64 offset = 3
  uint64 num_pieces = 4
}

message WakuMessageArchiveIndex {
  map&lt;string, WakuMessageArchiveIndexMetadata&gt; archives = 1
}
</code></pre>
<p>The control node MUST update the <code>WakuMessageArchiveIndex</code>
every time it creates one or
more <code>WakuMessageArchive</code>s and bundle it into a new torrent.
For every created <code>WakuMessageArchive</code>,
there MUST be a <code>WakuMessageArchiveIndexMetadata</code> entry in the <code>archives</code> field <code>WakuMessageArchiveIndex</code>.</p>
<h2 id="creating-message-archive-torrents"><a class="header" href="#creating-message-archive-torrents">Creating message archive torrents</a></h2>
<p>Control nodes MUST create a torrent file ("torrent")
containing metadata to all message history archives.
To create a torrent file, and
later serve the message archive data in the BitTorrent network,
control nodes MUST store the necessary data in dedicated files on the file system.</p>
<p>A torrent's source folder MUST contain the following two files:</p>
<ul>
<li><code>data</code> - Contains all protobuf encoded <code>WakuMessageArchive</code>'s (as bit strings)
concatenated in ascending order based on their time</li>
<li><code>index</code> - Contains the protobuf encoded <code>WakuMessageArchiveIndex</code></li>
</ul>
<p>Control nodes SHOULD store these files in a dedicated folder that is identifiable,
via the community id.</p>
<h3 id="ensuring-reproducible-data-pieces"><a class="header" href="#ensuring-reproducible-data-pieces">Ensuring reproducible data pieces</a></h3>
<p>The control node MUST ensure that the byte string resulting from
the protobuf encoded <code>data</code> is equal to the byte string <code>data</code>
from the previously generated message archive torrent,
plus the data of the latest 7 days worth of messages encoded as <code>WakuMessageArchive</code>.
Therefore, the size of <code>data</code> grows every seven days as it's append only.</p>
<p>The control nodes also MUST ensure that the byte size of every individual <code>WakuMessageArchive</code>
encoded protobuf is a multiple of <code>pieceLength: ???</code> (<strong>TODO</strong>)
using the <code>padding</code> field.
If the protobuf encoded <code>WakuMessageArchive</code> is not a multiple of <code>pieceLength</code>,
its <code>padding</code> field MUST be filled with zero bytes and
the <code>WakuMessageArchive</code> MUST be re-encoded until its size becomes multiple of <code>pieceLength</code>.</p>
<p>This is necessary because the content of the <code>data</code> file
will be split into pieces of <code>pieceLength</code> when the torrent file is created,
and the SHA1 hash of every piece is then stored in the torrent file and
later used by other nodes to request the data for each individual data piece.</p>
<p>By fitting message archives into a multiple of <code>pieceLength</code> and
ensuring they fill possible remaining space with zero bytes,
control nodes prevent the <strong>next</strong> message archive to
occupy that remaining space of the last piece,
which will result in a different SHA1 hash for that piece.</p>
<h4 id="example-without-padding"><a class="header" href="#example-without-padding"><strong>Example: Without padding</strong></a></h4>
<p>Let <code>WakuMessageArchive</code> "A1" be of size 20 bytes:</p>
<pre><code class="language-json"> 0 11 22 33 44 55 66 77 88 99
10 11 12 13 14 15 16 17 18 19 
</code></pre>
<p>With a <code>pieceLength</code> of 10 bytes, A1 will fit into <code>20 / 10 = 2</code> pieces:</p>
<pre><code class="language-json"> 0 11 22 33 44 55 66 77 88 99 // piece[0] SHA1: 0x123
10 11 12 13 14 15 16 17 18 19 // piece[1] SHA1: 0x456
</code></pre>
<h4 id="example-with-padding"><a class="header" href="#example-with-padding"><strong>Example: With padding</strong></a></h4>
<p>Let <code>WakuMessageArchive</code> "A2" be of size 21 bytes:</p>
<pre><code class="language-json"> 0 11 22 33 44 55 66 77 88 99
10 11 12 13 14 15 16 17 18 19
20
</code></pre>
<p>With a <code>pieceLength</code> of 10 bytes, A2 will fit into <code>21 / 10 = 2</code> pieces.
The remainder will introduce a third piece:</p>
<pre><code class="language-json"> 0 11 22 33 44 55 66 77 88 99 // piece[0] SHA1: 0x123
10 11 12 13 14 15 16 17 18 19 // piece[1] SHA1: 0x456
20                            // piece[2] SHA1: 0x789
</code></pre>
<p>The next <code>WakuMessageArchive</code> "A3" will be appended ("#3") to the existing data
and occupy the remaining space of the third data piece.
The piece at index 2 will now produce a different SHA1 hash:</p>
<pre><code class="language-json"> 0 11 22 33 44 55 66 77 88 99 // piece[0] SHA1: 0x123
10 11 12 13 14 15 16 17 18 19 // piece[1] SHA1: 0x456
20 #3 #3 #3 #3 #3 #3 #3 #3 #3 // piece[2] SHA1: 0xeef
#3 #3 #3 #3 #3 #3 #3 #3 #3 #3 // piece[3]
</code></pre>
<p>By filling up the remaining space of the third piece
with A2 using its <code>padding</code> field,
it is guaranteed that its SHA1 will stay the same:</p>
<pre><code class="language-json"> 0 11 22 33 44 55 66 77 88 99 // piece[0] SHA1: 0x123
10 11 12 13 14 15 16 17 18 19 // piece[1] SHA1: 0x456
20  0  0  0  0  0  0  0  0  0 // piece[2] SHA1: 0x999
#3 #3 #3 #3 #3 #3 #3 #3 #3 #3 // piece[3]
#3 #3 #3 #3 #3 #3 #3 #3 #3 #3 // piece[4]
</code></pre>
<h3 id="seeding-message-history-archives"><a class="header" href="#seeding-message-history-archives">Seeding message history archives</a></h3>
<p>The control node MUST seed the
<a href="status/61/community-history-service.html#creating-message-archive-torrents">generated torrent</a>
until a new <code>WakuMessageArchive</code> is created.</p>
<p>The control node SHOULD NOT seed torrents for older message history archives.
Only one torrent at a time should be seeded.</p>
<h3 id="creating-magnet-links"><a class="header" href="#creating-magnet-links">Creating magnet links</a></h3>
<p>Once a torrent file for all message archives is created,
the control node MUST derive a magnet link following the
<a href="https://en.wikipedia.org/wiki/Magnet_URI_scheme">Magnet URI scheme</a>
using the underlying BitTorrent protocol client.</p>
<h3 id="message-archive-distribution"><a class="header" href="#message-archive-distribution">Message archive distribution</a></h3>
<p>Message archives are available via the BitTorrent network as they are being
<a href="status/61/community-history-service.html#seeding-message-history-archives">seeded by the control node</a>.
Other community member nodes will download the message archives
from the BitTorrent network once they receive a magnet link
that contains a message archive index.</p>
<p>The control node MUST send magnet links containing message archives and
the message archive index to a special community channel.
The topic of that special channel follows the following format:</p>
<pre><code class="language-text">/{application-name}/{version-of-the-application}/{content-topic-name}/{encoding}
</code></pre>
<p>All messages sent with this topic MUST be instances of <code>ApplicationMetadataMessage</code>
(<a href="status/61/../62/payloads.html">62/STATUS-PAYLOADS</a>) with a <code>payload</code> of <code>CommunityMessageArchiveIndex</code>.</p>
<p>Only the control node MAY post to the special channel.
Other messages on this specified channel MUST be ignored by clients.
Community members MUST NOT have permission to send messages to the special channel.
However, community member nodes MUST subscribe to special channel
to receive Waku messages containing magnet links for message archives.</p>
<h3 id="canonical-message-histories"><a class="header" href="#canonical-message-histories">Canonical message histories</a></h3>
<p>Only control nodes are allowed to distribute messages with magnet links via
the special channel for magnet link exchange.
Community members MUST NOT be allowed to post any messages to the special channel.</p>
<p>Status nodes MUST ensure that any message
that isn't signed by the control node in the special channel is ignored.</p>
<p>Since the magnet links are created from the control node's database
(and previously distributed archives),
the message history provided by the control node becomes the canonical message history
and single source of truth for the community.</p>
<p>Community member nodes MUST replace messages in their local databases
with the messages extracted from archives within the same time range.
Messages that the control node didn't receive MUST be removed and
are no longer part of the message history of interest,
even if it already existed in a community member node's database.</p>
<h2 id="fetching-message-history-archives"><a class="header" href="#fetching-message-history-archives">Fetching message history archives</a></h2>
<p>Generally, fetching message history archives is a three step process:</p>
<ol>
<li>Receive <a href="status/61/community-history-service.html#message-history-archive-index">message archive index</a>
magnet link as described in [Message archive distribution],
download <code>index</code> file from torrent, then determine which message archives to download</li>
<li>Download individual archives</li>
</ol>
<p>Community member nodes subscribe to the special channel
that control nodes publish magnet links for message history archives to.
There are two scenarios in which member nodes can receive such a magnet link message
from the special channel:</p>
<ol>
<li>The member node receives it via live messages, by listening to the special channel</li>
<li>The member node requests messages for a time range of up to 30 days
from store nodes (this is the case when a new community member joins a community)</li>
</ol>
<h3 id="downloading-message-archives"><a class="header" href="#downloading-message-archives">Downloading message archives</a></h3>
<p>When member nodes receive a message with a <code>CommunityMessageHistoryArchive</code>
(<a href="status/61/../62/payloads.html">62/STATUS-PAYLOADS</a>) from the aforementioned channnel,
they MUST extract the <code>magnet_uri</code> and
pass it to their underlying BitTorrent client
so they can fetch the latest message history archive index,
which is the <code>index</code> file of the torrent (see <a href="status/61/community-history-service.html#creating-message-archive-torrents">Creating message archive torrents</a>).</p>
<p>Due to the nature of distributed systems,
there's no guarantee that a received message is the "last" message.
This is especially true
when member nodes request historical messages from store nodes.</p>
<p>Therefore, member nodes MUST wait for 20 seconds
after receiving the last <code>CommunityMessageArchive</code>
before they start extracting the magnet link to fetch the latest archive index.</p>
<p>Once a message history archive index is downloaded and
parsed back into <code>WakuMessageArchiveIndex</code>,
community member nodes use a local lookup table
to determine which of the listed archives are missing
using the KECCAK-256 hashes stored in the index.</p>
<p>For this lookup to work,
member nodes MUST store the KECCAK-256 hashes
of the <code>WakuMessageArchiveIndexMetadata</code> provided by the <code>index</code> file
for all of the message history archives that have been downlaoded
in their local database.</p>
<p>Given a <code>WakuMessageArchiveIndex</code>,
member nodes can access individual <code>WakuMessageArchiveIndexMetadata</code>
to download individual archives.</p>
<p>Community member nodes MUST choose one of the following options:</p>
<ol>
<li><strong>Download all archives</strong> - Request and
download all data pieces for <code>data</code> provided by the torrent
(this is the case for new community member nodes
that haven't downloaded any archives yet)</li>
<li><strong>Download only the latest archive</strong> -
Request and download all pieces starting at the <code>offset</code> of the latest <code>WakuMessageArchiveIndexMetadata</code>
(this the case for any member node
that already has downloaded all previous history and
is now interested in only the latst archive)</li>
<li><strong>Download specific archives</strong> -
Look into <code>from</code> and
<code>to</code> fields of every <code>WakuMessageArchiveIndexMetadata</code> and
determine the pieces for archives of a specific time range
(can be the case for member nodes that have recently joined the network and
are only interested in a subset of the complete history)</li>
</ol>
<h3 id="storing-historical-messages"><a class="header" href="#storing-historical-messages">Storing historical messages</a></h3>
<p>When message archives are fetched,
community member nodes MUST unwrap the resulting <code>WakuMessage</code> instances
into <code>ApplicationMetadataMessage</code> instances and store them in their local database.
Community member nodes SHOULD NOT store the wrapped <code>WakuMessage</code> messages.</p>
<p>All message within the same time range
MUST be replaced with the messages provided by the message history archive.</p>
<p>Community members nodes MUST ignore the expiration state of each archive message.</p>
<h2 id="considerations"><a class="header" href="#considerations">Considerations</a></h2>
<p>The following are things to cosider when implementing this specification.</p>
<h2 id="control-node-honesty"><a class="header" href="#control-node-honesty">Control node honesty</a></h2>
<p>This spec assumes that all control nodes are honest and behave according to the spec.
Meaning they don't inject their own messages into, or
remove any messages from historic archives.</p>
<h2 id="bandwidth-consumption"><a class="header" href="#bandwidth-consumption">Bandwidth consumption</a></h2>
<p>Community member nodes will download the latest archive
they've received from the archive index,
which includes messages from the last seven days.
Assuming that community members nodes were online for that time range,
they have already downloaded that message data and
will now download an archive that contains the same.</p>
<p>This means there's a possibility member nodes
will download the same data at least twice.</p>
<h2 id="multiple-community-owners"><a class="header" href="#multiple-community-owners">Multiple community owners</a></h2>
<p>It is possible for control nodes
to export the private key of their owned community and
pass it to other users so they become control nodes as well.
This means, it's possible for multiple control nodes to exist.</p>
<p>This might conflict with the assumption that the control node
serves as a single source of thruth.
Multiple control nodes can have different message histories.</p>
<p>Not only will multiple control nodes
multiply the amount of archive index messages being distributed to the network,
they might also contain different sets of magnet links and their corresponding hashes.</p>
<p>Even if just a single message is missing in one of the histories,
the hashes presented in archive indices will look completely different,
resulting in the community member node to download the corresponding archive
(which might be identical to an archive that was already downloaded,
except for that one message).</p>
<h2 id="copyright-60"><a class="header" href="#copyright-60">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-48"><a class="header" href="#references-48">References</a></h2>
<ul>
<li><a href="status/61/../../waku/standards/core/13/store.html">13/WAKU2-STORE</a></li>
<li><a href="https://bittorrent.org">BitTorrent</a></li>
<li><a href="status/61/../../waku/standards/core/10/waku2.html">10/WAKU2</a></li>
<li><a href="status/61/../../waku/standards/core/11/relay.html">11/WAKU2-RELAY</a></li>
<li><a href="https://en.wikipedia.org/wiki/Magnet_URI_scheme">Magnet URI scheme</a></li>
<li><a href="https://forum.vac.dev/t/status-communities-protocol-and-product-point-of-view/114">forum discussion</a></li>
<li><a href="https://github.com/status-im/specs/pull/151">org channels</a></li>
<li><a href="https://github.com/status-im/feature-specs/pull/36">UI feature spec</a></li>
<li><a href="https://www.bittorrent.org/beps/bep_0009.html">Extensions for Peers to Send Metadata Files</a></li>
<li><a href="status/61/../56/communities.html">org channels spec</a></li>
<li><a href="status/61/../../waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a></li>
<li><a href="status/61/../62/payloads.html">62/STATUS-PAYLOADS</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="62status-payloads"><a class="header" href="#62status-payloads">62/STATUS-PAYLOADS</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Status Message Payloads</td></tr>
<tr><th>Slug</th><td>62</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Editor</th><td>r4bbit &lt;r4bbit@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Adam Babik &lt;adam@status.im&gt;<br>Andrea Maria Piana &lt;andreap@status.im&gt;<br>Oskar Thoren &lt;oskarth@titanproxy.com&gt;<br>Samuel Hawksby-Robinson &lt;samuel@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-65"><a class="header" href="#timeline-65">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/62/payloads.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/62/payloads.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-16</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/ad80a59e2ba8f18c179158973d31e7fac2cb714a/status/62/payloads.md"><code>ad80a59</code></a> — 62/STATUS-PAYLOAD: Add Description (#95)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/status/62/payloads.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-02-07</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/1abf2c9c7bbef07b75637d8f897d25108b984dc2/status/62/payloads.md"><code>1abf2c9</code></a> — Rename payload.md to payloads.md</li>
<li><strong>2024-02-07</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/e2b9e32028c91650310e786c377c938510ba229a/status/62/payload.md"><code>e2b9e32</code></a> — Update payload.md</li>
<li><strong>2024-02-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/20e9a66cf80cbc565ccff914a0d97f87b8fcbe2e/status/62/payload.md"><code>20e9a66</code></a> — Rename payloads.md to payload.md</li>
<li><strong>2024-02-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/488ce9b72cc0b670cbbdcbacedc3a92dc8295a24/status/62/payloads.md"><code>488ce9b</code></a> — Create payloads.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-40"><a class="header" href="#abstract-40">Abstract</a></h2>
<p>This specification describes how the payload of each message in Status looks
like.
It is primarily centered around chat and chat-related use cases.</p>
<p>The payloads aims to be flexible enough to support messaging but also cases
described in the <a href="https://status.im/whitepaper.pdf">Status Whitepaper</a> as well
as various clients created using different technologies.</p>
<h2 id="wire-format-specification-4"><a class="header" href="#wire-format-specification-4">Wire Format Specification</a></h2>
<h3 id="payload-wrapper"><a class="header" href="#payload-wrapper">Payload wrapper</a></h3>
<p>The node wraps all payloads in a <a href="https://developers.google.com/protocol-buffers/">protobuf record</a>
record:</p>
<pre><code class="language-protobuf">message StatusProtocolMessage {
  bytes signature = 4001;
  bytes payload = 4002;
}
</code></pre>
<p><code>signature</code> is the bytes of the signed <code>SHA3-256</code> of the payload,
signed with the key of the author of the message.
The node needs the signature to validate authorship of the message,
so that the message can be relayed to third parties.
If a signature is not present, but an author is provided by a layer below,
the message is not to be relayed to third parties,
and it is considered plausibly deniable.</p>
<h3 id="encoding"><a class="header" href="#encoding">Encoding</a></h3>
<p>The node encodes the payload using <a href="https://developers.google.com/protocol-buffers">Protobuf</a></p>
<h3 id="types-of-messages"><a class="header" href="#types-of-messages">Types of messages</a></h3>
<h4 id="chatmessage"><a class="header" href="#chatmessage">ChatMessage</a></h4>
<p>The type <code>ChatMessage</code> represents a chat message exchanged between clients.</p>
<p>Payload</p>
<p>The protobuf description is:</p>
<pre><code class="language-protobuf">message ChatMessage {
  // Lamport timestamp of the chat message
  uint64 clock = 1;
  // Unix timestamps in milliseconds, currently not used as we use whisper as
  // more reliable, but here so that we don't rely on it
  uint64 timestamp = 2;
  // Text of the message
  string text = 3;
  // Id of the message that we are replying to
  string response_to = 4;
  // Ens name of the sender
  string ens_name = 5;
  // Chat id, this field is symmetric for public-chats and private group chats,
  // but asymmetric in case of one-to-ones, as the sender will use the chat-id
  // of the received, while the receiver will use the chat-id of the sender.
  // Probably should be the concatenation of sender-pk &amp; receiver-pk in
  // alphabetical order
  string chat_id = 6;

  // The type of message (public/one-to-one/private-group-chat)
  MessageType message_type = 7;
  // The type of the content of the message
  ContentType content_type = 8;

  oneof payload {
    StickerMessage sticker = 9;
    ImageMessage image = 10;
    AudioMessage audio = 11;
    bytes community = 12;
    DiscordMessage discord_message = 99;
  }

  // Grant for community chat messages
  bytes grant = 13;

  // Message author's display name, introduced in version 1
  string display_name = 14;

  ContactRequestPropagatedState contact_request_propagated_state = 15;

  repeated UnfurledLink unfurled_links = 16;

  enum ContentType {
    UNKNOWN_CONTENT_TYPE = 0;
    TEXT_PLAIN = 1;
    STICKER = 2;
    STATUS = 3;
    EMOJI = 4;
    TRANSACTION_COMMAND = 5;
    // Only local
    SYSTEM_MESSAGE_CONTENT_PRIVATE_GROUP = 6;
    IMAGE = 7;
    AUDIO = 8;
    COMMUNITY = 9;
    // Only local
    SYSTEM_MESSAGE_GAP = 10;
    CONTACT_REQUEST = 11;
    DISCORD_MESSAGE = 12;
    IDENTITY_VERIFICATION = 13;
    // Only local
    SYSTEM_MESSAGE_PINNED_MESSAGE = 14;
    // Only local
    SYSTEM_MESSAGE_MUTUAL_EVENT_SENT = 15;
    // Only local
    SYSTEM_MESSAGE_MUTUAL_EVENT_ACCEPTED = 16;
    // Only local
    SYSTEM_MESSAGE_MUTUAL_EVENT_REMOVED = 17;
  }
}
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>The clock of the chat</td></tr>
<tr><td>2</td><td>timestamp</td><td><code>uint64</code></td><td>The sender timestamp at message creation</td></tr>
<tr><td>3</td><td>text</td><td><code>string</code></td><td>The content of the message</td></tr>
<tr><td>4</td><td>response_to</td><td><code>string</code></td><td>The ID of the message replied to</td></tr>
<tr><td>5</td><td>ens_name</td><td><code>string</code></td><td>The ENS name of the user sending the message</td></tr>
<tr><td>6</td><td>chat_id</td><td><code>string</code></td><td>The local ID of the chat the message is sent to</td></tr>
<tr><td>7</td><td>message_type</td><td><code>MessageType</code></td><td>The type of message, different for one-to-one, public or group chats</td></tr>
<tr><td>8</td><td>content_type</td><td><code>ContentType</code></td><td>The type of the content of the message</td></tr>
<tr><td>9</td><td>payload</td><td><code>Sticker</code> I <code>Image</code> I <code>Audio</code> I <code>DiscordMessage</code> I <code>bytes</code> I nil`</td><td>The payload of the message based on the content type</td></tr>
<tr><td>13</td><td>grant</td><td><code>bytes</code></td><td>Grant for community chat messages</td></tr>
<tr><td>14</td><td>display_name</td><td><code>string</code></td><td>The message author's display name</td></tr>
<tr><td>15</td><td>contact_request_propagated_state</td><td><code>ContactRequestPropagatedState</code></td><td>Contact request clock values</td></tr>
<tr><td>16</td><td>unfurled_links</td><td><code>UnfurledLink[]</code></td><td>Unfurled links and their metadata that have been attached to the message</td></tr>
</tbody></table>
</div>
<h4 id="content-types"><a class="header" href="#content-types">Content types</a></h4>
<p>A node requires content types for a proper interpretation of incoming messages.
Not each message is plain text but may carry different information.</p>
<p>The following content types MUST be supported:</p>
<ul>
<li><code>TEXT_PLAIN</code> identifies a message which content is a plaintext.</li>
</ul>
<p>There are other content types that MAY be implemented by the client:</p>
<ul>
<li><code>STICKER</code></li>
<li><code>STATUS</code></li>
<li><code>EMOJI</code></li>
<li><code>TRANSACTION_COMMAND</code></li>
<li><code>IMAGE</code></li>
<li><code>AUDIO</code></li>
<li><code>COMMUNITY</code></li>
<li><code>CONTACT_REQUEST</code></li>
<li><code>DISCORD_MESSAGE</code></li>
<li><code>IDENTITY_VERIFICATION</code></li>
</ul>
<h5 id="mentions"><a class="header" href="#mentions">Mentions</a></h5>
<p>A mention MUST be represented as a string with the <code>@0xpk</code> format,
where <code>pk</code> is the public key of the
<a href="https://specs.status.im/spec/2">user account</a> to be mentioned,
within the <code>text</code> field of a message with content_type <code>TEXT_PLAIN</code>.
A message MAY contain more than one mention.
This specification RECOMMENDs that the application
does not require the user to enter the entire pk.
This specification RECOMMENDs that the application
allows the user to create a mention by typing @ followed by the related ENS or
3-word pseudonym.
This specification RECOMMENDs that the application
provides the user auto-completion functionality to create a mention.
For better user experience,
the client SHOULD display a known
<a href="https://specs.status.im/spec/2#contact-verification">ens name or the 3-word pseudonym corresponding to the key</a>
instead of the <code>pk</code>.</p>
<h5 id="sticker-content-type"><a class="header" href="#sticker-content-type">Sticker content type</a></h5>
<p>A <code>ChatMessage</code> with <code>STICKER</code> <code>Content/Type</code> MUST also specify the ID of the <code>Pack</code>
and the <code>Hash</code> of the pack, in the <code>Sticker</code> field of <code>ChatMessage</code></p>
<pre><code class="language-protobuf">message StickerMessage {
  string hash = 1;
  int32 pack = 2;
}
</code></pre>
<h5 id="image-content-type"><a class="header" href="#image-content-type">Image content type</a></h5>
<p>A <code>ChatMessage</code> with <code>IMAGE</code> <code>Content/Type</code> MUST also
specify the <code>payload</code> of the image and the <code>type</code>.</p>
<p>Clients MUST sanitize the payload before accessing its content, in particular:</p>
<ul>
<li>Clients MUST choose a secure decoder</li>
<li>Clients SHOULD strip metadata if present without parsing/decoding it</li>
<li>Clients SHOULD NOT add metadata/exif when sending an image file for privacy
and security reasons</li>
<li>Clients MUST make sure that the transport layer constraints the size of the payload
to limit they are able to handle securely</li>
</ul>
<pre><code class="language-protobuf">message ImageMessage {
  bytes payload = 1;
  ImageType type = 2;
  enum ImageType {
    UNKNOWN_IMAGE_TYPE = 0;
    PNG = 1;
    JPEG = 2;
    WEBP = 3;
    GIF = 4;
  }
}
</code></pre>
<h5 id="audio-content-type"><a class="header" href="#audio-content-type">Audio content type</a></h5>
<p>A <code>ChatMessage</code> with <code>AUDIO</code>,
<code>Content/Type</code> MUST also specify the <code>payload</code> of the audio,
the <code>type</code> and the duration in milliseconds (<code>duration_ms</code>).</p>
<p>Clients MUST sanitize the payload before accessing its content, in particular:</p>
<ul>
<li>Clients MUST choose a secure decoder</li>
<li>Clients SHOULD strip metadata if present without parsing/decoding it</li>
<li>Clients SHOULD NOT add metadata/exif when sending an audio file for privacy
and security reasons</li>
<li>Clients MUST make sure that the transport layer constraints the size
of the payload to limit they are able to handle securely</li>
</ul>
<pre><code class="language-protobuf">message AudioMessage {
  bytes payload = 1;
  AudioType type = 2;
  uint64 duration_ms = 3;
  enum AudioType {
    UNKNOWN_AUDIO_TYPE = 0;
    AAC = 1;
    AMR = 2;
</code></pre>
<h5 id="community-content-type"><a class="header" href="#community-content-type">Community content type</a></h5>
<p>A <code>ChatMessage</code> with <code>COMMUNITY</code> <code>Content/Type</code>,
MUST also specify the <code>payload</code> of the community as bytes from a <a href="status/62/payloads.html#communitydescription">CommunityDescription</a>.</p>
<h5 id="discordmessage-content-type"><a class="header" href="#discordmessage-content-type">DiscordMessage content type</a></h5>
<p>A <code>ChatMessage</code> with <code>DISCORD_MESSAGE</code> <code>Content/Type</code>,
MUST also specify the <code>payload</code> of the <code>DiscordMessage</code>.</p>
<pre><code class="language-protobuf">message DiscordMessage {
  string id = 1;
  string type = 2;
  string timestamp = 3;
  string timestampEdited = 4;
  string content = 5;
  DiscordMessageAuthor author = 6;
  DiscordMessageReference reference = 7;
  repeated DiscordMessageAttachment attachments = 8;
}

message DiscordMessageAuthor {
  string id = 1;
  string name = 2;
  string discriminator = 3;
  string nickname = 4;
  string avatarUrl = 5;
  bytes avatarImagePayload = 6;
  string localUrl = 7;
}

message DiscordMessageReference {
  string messageId = 1;
  string channelId = 2;
  string guildId = 3;
}

message DiscordMessageAttachment {
  string id = 1;
  string messageId = 2;
  string url = 3;
  string fileName = 4;
  uint64 fileSizeBytes = 5;
  string contentType = 6;
  bytes payload = 7;
  string localUrl = 8;
}
</code></pre>
<h4 id="message-types-1"><a class="header" href="#message-types-1">Message types</a></h4>
<p>A node requires message types to decide how to encrypt a particular message and
what metadata needs to be attached when passing a message to the transport layer.
For more on this, see <a href="status/62/../../waku/standards/core/10/waku2.html">10/WAKU2</a>.</p>
<!-- TODO: This reference is a bit odd,
considering the layer payloads should interact with is Secure Transport, and
not Whisper/Waku. This requires more detail -->
<p>The following messages types MUST be supported:</p>
<ul>
<li><code>ONE_TO_ONE</code> is a message to the public group</li>
<li><code>PUBLIC_GROUP</code> is a private message</li>
<li><code>PRIVATE_GROUP</code> is a message to the private group.</li>
<li><code>COMMUNITY_CHAT</code> is a message to a community channe.</li>
</ul>
<pre><code class="language-protobuf">enum MessageType {
  UNKNOWN_MESSAGE_TYPE = 0;
  ONE_TO_ONE = 1;
  PUBLIC_GROUP = 2;
  PRIVATE_GROUP = 3;
  // Only local
  SYSTEM_MESSAGE_PRIVATE_GROUP = 4;
  COMMUNITY_CHAT = 5;
  // Only local
  SYSTEM_MESSAGE_GAP = 6;
}
</code></pre>
<h4 id="clock-vs-timestamp-and-message-ordering"><a class="header" href="#clock-vs-timestamp-and-message-ordering">Clock vs Timestamp and message ordering</a></h4>
<p>If a user sends a new message,
before the messages sent while the user was offline are received,
the new message is supposed to be displayed last in a chat.
This is where the basic algorithm of Lamport timestamp would fall short as
it's only meant to order causally related events.</p>
<p>The status client therefore makes a "bid",
speculating that it will beat the current chat-timestamp,
s.t. the status client's Lamport timestamp format is:
<code>clock = max({timestamp}, chat_clock + 1)</code></p>
<p>This will satisfy the Lamport requirement, namely: a -&gt; b then T(a) &lt; T(b)</p>
<p><code>timestamp</code> MUST be Unix time calculated, when the node creates the message,
in milliseconds.
This field SHOULD not be relied upon for message ordering.</p>
<p><code>clock</code> SHOULD be calculated using the algorithm of
<a href="https://en.wikipedia.org/wiki/Lamport_timestamps">Lamport timestamps</a>.
When there are messages available in a chat,
the node calculates <code>clock</code>'s value
based on the last received message in a particular chat:
<code>max(timeNowInMs, last-message-clock-value + 1)</code>.
If there are no messages, <code>clock</code> is initialized with <code>timestamp</code>'s value.</p>
<p>Messages with a <code>clock</code> greater than <code>120</code> seconds over the Whisper/Waku timestamp
SHOULD be discarded,
in order to avoid malicious users to increase the <code>clock</code> of a chat arbitrarily.</p>
<p>Messages with a <code>clock</code> less than <code>120</code> seconds under the Whisper/Waku timestamp
might indicate an attempt to insert messages in the chat history,
which is not distinguishable from a <code>datasync</code> layer re-transit event.
A client MAY mark this messages with a warning to the user, or discard them.</p>
<p>The node uses <code>clock</code> value for the message ordering.
The algorithm used, and
the distributed nature of the system produces casual ordering,
which might produce counter-intuitive results in some edge cases.
For example, when a user joins a public chat and
sends a message before receiving the exist messages,
their message <code>clock</code> value might be lower and
the message will end up in the past when the historical messages are fetched.</p>
<h4 id="chats"><a class="header" href="#chats">Chats</a></h4>
<p>Chat is a structure that helps organize messages.
It's usually desired to display messages only from a single recipient,
or a group of recipients at a time and chats help to achieve that.</p>
<p>All incoming messages can be matched against a chat.
The below table describes how to calculate a chat ID for each message type.</p>
<div class="table-wrapper"><table><thead><tr><th>Message Type</th><th>Chat ID Calculation</th><th>Direction</th><th>Comment</th></tr></thead><tbody>
<tr><td>PUBLIC_GROUP</td><td>chat ID is equal to a public channel name; it should equal <code>chatId</code> from the message</td><td>Incoming/Outgoing</td><td></td></tr>
<tr><td>ONE_TO_ONE</td><td>let <code>P</code> be a public key of the recipient; <code>hex-encode(P)</code> is a chat ID; use it as <code>chatId</code> value in the message</td><td>Outgoing</td><td></td></tr>
<tr><td>user-message</td><td>let <code>P</code> be a public key of message's signature; <code>hex-encode(P)</code> is a chat ID; discard <code>chat-id</code> from message</td><td>Incoming</td><td>if there is no matched chat, it might be the first message from public key <code>P</code>; the node MAY discard the message or MAY create a new chat; Status official clients create a new chat</td></tr>
<tr><td>PRIVATE_GROUP</td><td>use <code>chatId</code> from the message</td><td>Incoming/Outgoing</td><td>find an existing chat by <code>chatId</code>; if none is found, the user is not a member of that chat or the user hasn't joined that chat, the message MUST be discarded</td></tr>
<tr><td>COMMUNITY_CHAT</td><td>use <code>chatId</code> from the message</td><td>Incoming/Outgoing</td><td>find existing community chat within a community based on <code>chatId</code>; the <code>chatId</code> includes a community id prefix</td></tr>
</tbody></table>
</div>
<h3 id="contactupdate"><a class="header" href="#contactupdate">ContactUpdate</a></h3>
<p><code>ContactUpdate</code> is a message exchange to notify peers
that either the user has been added as a contact, or
that information about the sending user have changed.</p>
<pre><code class="language-protobuf">message ContactUpdate {
  uint64 clock = 1;
  string ens_name = 2;
  string profile_image = 3;
  string display_name = 4;
  uint64 contact_request_clock = 5;
  ContactRequestPropagatedState contact_request_propagated_state = 6;
  string public_key = 7;
}

message ContactRequestPropagatedState {
  uint64 local_clock = 1;
  uint64 local_state = 2;
  uint64 remote_clock = 3;
  uint64 remote_state = 4;
}
</code></pre>
<h4 id="payload-fields"><a class="header" href="#payload-fields">Payload Fields</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>The clock of the chat with the user</td></tr>
<tr><td>2</td><td>ens_name</td><td><code>string</code></td><td>The ENS name if set</td></tr>
<tr><td>3</td><td>profile_image</td><td><code>string</code></td><td>The base64 encoded profile picture of the user</td></tr>
<tr><td>4</td><td>display_name</td><td><code>string</code></td><td>The display name of the user</td></tr>
<tr><td>5</td><td>contact_request_clock</td><td><code>uint64</code></td><td>The clock at which a contact request was sent</td></tr>
<tr><td>6</td><td>contact_request_propagated_state</td><td><code>ContactRequestPropagatedState</code></td><td>Additional propagation clock values</td></tr>
<tr><td>7</td><td>public_key</td><td><code>string</code></td><td>The public key of the user</td></tr>
</tbody></table>
</div>
<h4 id="contact-update"><a class="header" href="#contact-update">Contact update</a></h4>
<p>A client SHOULD send a <code>ContactUpdate</code> to all the contacts each time:</p>
<ul>
<li>The ens_name has changed</li>
<li>A user edits the profile image</li>
</ul>
<p>A client SHOULD also periodically send a <code>ContactUpdate</code> to all the contacts,
the interval is up to the client,
the Status official client sends these updates every 48 hours.</p>
<h3 id="emojireaction"><a class="header" href="#emojireaction">EmojiReaction</a></h3>
<p><code>EmojiReaction</code>s represents a user's "reaction" to a specific chat message.
For more information about the concept of emoji reactions see <a href="https://en.wikipedia.org/wiki/Facebook_like_button#Use_on_Facebook">Facebook Reactions</a>.</p>
<p>This specification RECOMMENDS that the UI/UX implementation of sending <code>EmojiReactions</code>
requires only a single click operation,
as users have an expectation that emoji reactions are effortless
and simple to perform.</p>
<pre><code class="language-protobuf">message EmojiReaction {
  // clock Lamport timestamp of the chat message
  uint64 clock = 1;

  // chat_id the ID of the chat the message belongs to, for query efficiency the
  // chat_id is stored in the db even though the
  // target message also stores the chat_id
  string chat_id = 2;

  // message_id the ID of the target message that the user wishes to react to
  string message_id = 3;

  // message_type 
  // is (somewhat confusingly) the ID of the type of chat the message belongs to
  MessageType message_type = 4;

  // type the ID of the emoji the user wishes to react with
  Type type = 5;

  enum Type {
    UNKNOWN_EMOJI_REACTION_TYPE = 0;
    LOVE = 1;
    THUMBS_UP = 2;
    THUMBS_DOWN = 3;
    LAUGH = 4;
    SAD = 5;
    ANGRY = 6;
  }

 // whether this is a retraction of a previously sent emoji
  bool retracted = 6;
}
</code></pre>
<p>Clients MUST specify <code>clock</code>, <code>chat_id</code>, <code>message_id</code>, <code>type</code> and <code>message_type</code>.</p>
<p>This specification RECOMMENDS that the UI/UX implementation of retracting an <code>EmojiReaction</code>s
requires only a single click operation,
as users have an expectation that emoji reaction removals are effortless and
simple to perform.</p>
<h3 id="membershipupdatemessage-and-membershipupdateevent"><a class="header" href="#membershipupdatemessage-and-membershipupdateevent">MembershipUpdateMessage and MembershipUpdateEvent</a></h3>
<p><code>MembershipUpdateEvent</code> is a message used to propagate information
about group membership changes in a group chat.
The details are in the <a href="status/62/../56/communities.html">Group chats specs</a>.</p>
<pre><code class="language-protobuf">message MembershipUpdateMessage {
  // The chat id of the private group chat
  string chat_id = 1;
  // A list of events for this group chat, first x bytes are the signature, 
  // then is a protobuf encoded MembershipUpdateEvent
  repeated bytes events = 2;

  // An optional chat message
  oneof chat_entity {
    ChatMessage message = 3;
    EmojiReaction emoji_reaction = 4;
  }
}

message MembershipUpdateEvent {
  // Lamport timestamp of the event
  uint64 clock = 1;
  // List of public keys of objects of the action
  repeated string members = 2;
  // Name of the chat for the CHAT_CREATED/NAME_CHANGED event types
  string name = 3;
  // The type of the event
  EventType type = 4;
  // Color of the chat for the CHAT_CREATED/COLOR_CHANGED event types
  string color = 5;
  // Chat image
  bytes image = 6;

  enum EventType {
    UNKNOWN = 0;
    CHAT_CREATED = 1;
    NAME_CHANGED = 2;
    MEMBERS_ADDED = 3;
    MEMBER_JOINED = 4;
    MEMBER_REMOVED = 5;
    ADMINS_ADDED = 6;
    ADMIN_REMOVED = 7;
    COLOR_CHANGED = 8;
    IMAGE_CHANGED = 9;
  }
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>chat_id</td><td><code>string</code></td><td>The chat id of the private group chat</td></tr>
<tr><td>2</td><td>events</td><td><code>bytes[]</code></td><td>The list of events for this group chat</td></tr>
</tbody></table>
</div>
<h4 id="chat-entities"><a class="header" href="#chat-entities">Chat entities</a></h4>
<p>A <code>MembershipUpdateMessage</code> includes either a <code>ChatMessage</code> or <code>EmojiReaction</code>.</p>
<h3 id="syncinstallationcontactv2"><a class="header" href="#syncinstallationcontactv2">SyncInstallationContactV2</a></h3>
<p>The node uses <code>SyncInstallationContact</code> messages to synchronize
in a best-effort the contacts to other devices.</p>
<pre><code class="language-protobuf">message SyncInstallationContactV2 {
  uint64 last_updated_locally = 1;
  string id = 2;
  string profile_image = 3;
  string ens_name = 4;
  uint64 last_updated = 5;
  repeated string system_tags = 6;
  string local_nickname = 7;
  bool added = 9;
  bool blocked = 10;
  bool muted = 11;
  bool removed = 12;
  bool has_added_us = 13;
  int64 verification_status = 14;
  int64 trust_status = 15;
  int64 contact_request_local_state = 16;
  int64 contact_request_local_clock = 17;
  int64 contact_request_remote_state = 18;
  int64 contact_request_remote_clock = 19;
  string display_name = 20;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>last_updated_locally</td><td><code>uint64</code></td><td>Timestamp of last local update</td></tr>
<tr><td>2</td><td>id</td><td><code>string</code></td><td>id of the contact synced</td></tr>
<tr><td>3</td><td>profile_image</td><td><code>string</code></td><td><code>base64</code> encoded profile picture of the user</td></tr>
<tr><td>4</td><td>ens_name</td><td><code>string</code></td><td>ENS name of the contact</td></tr>
<tr><td>5</td><td></td><td><code>array[string]</code></td><td>Array of <code>system_tags</code> for the user, this can currently be: <code>":contact/added", ":contact/blocked", ":contact/request-received"</code></td></tr>
<tr><td>7</td><td>local_nickname</td><td><code>string</code></td><td>Local display name of the contact</td></tr>
<tr><td>9</td><td>added</td><td><code>bool</code></td><td>Wether the contact is added</td></tr>
<tr><td>10</td><td>blocked</td><td><code>bool</code></td><td>Wether the contact is blocked</td></tr>
<tr><td>11</td><td>muted</td><td><code>bool</code></td><td>Wether the contact is muted</td></tr>
<tr><td>12</td><td>removed</td><td><code>bool</code></td><td>Wether the contact is removed</td></tr>
<tr><td>13</td><td>has_added_us</td><td><code>bool</code></td><td>Wether the contact has added us</td></tr>
<tr><td>14</td><td>verification_status</td><td><code>int64</code></td><td>The verification status of the contact</td></tr>
<tr><td>15</td><td>trust_status</td><td><code>int64</code></td><td>The trust status of the contact</td></tr>
<tr><td>16</td><td>contact_request_local_state</td><td><code>int64</code></td><td>The local contact request state</td></tr>
<tr><td>17</td><td>contact_request_local_clock</td><td><code>int64</code></td><td>The local contact request clock</td></tr>
<tr><td>18</td><td>contact_request_remote_state</td><td><code>int64</code></td><td>The remote contact request state</td></tr>
<tr><td>19</td><td>contact_request_remote_clock</td><td><code>int64</code></td><td>The remote contact request clock</td></tr>
</tbody></table>
</div>
<h3 id="syncinstallationpublicchat"><a class="header" href="#syncinstallationpublicchat">SyncInstallationPublicChat</a></h3>
<p>The node uses <code>SyncInstallationPublicChat</code> message to synchronize
in a best-effort the public chats to other devices.</p>
<pre><code class="language-protobuf">message SyncInstallationPublicChat {
  uint64 clock = 1;
  string id = 2;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>clock value of the chat</td></tr>
<tr><td>2</td><td>id</td><td><code>string</code></td><td>id of the chat synced</td></tr>
</tbody></table>
</div>
<h3 id="syncpairinstallation"><a class="header" href="#syncpairinstallation">SyncPairInstallation</a></h3>
<p>The node uses <code>PairInstallation</code> messages to propagate information
about a device to its paired devices.</p>
<pre><code class="language-protobuf">message SyncPairInstallation {
  uint64 clock = 1;
  string installation_id = 2;
  string device_type = 3;
  string name = 4;
  // following fields used for local pairing
  uint32 version = 5;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>clock value of the chat</td></tr>
<tr><td>2</td><td>installation_id</td><td><code>string</code></td><td>A randomly generated id that identifies this device</td></tr>
<tr><td>3</td><td>device_type</td><td><code>string</code></td><td>The OS of the device <code>ios</code>,<code>android</code> or <code>desktop</code></td></tr>
<tr><td>4</td><td>name</td><td><code>string</code></td><td>The self-assigned name of the device</td></tr>
</tbody></table>
</div>
<h3 id="chatidentity"><a class="header" href="#chatidentity">ChatIdentity</a></h3>
<p><code>ChatIdentity</code> represents the user defined identity associated
with their public chat key.</p>
<pre><code class="language-protobuf">message ChatIdentity {
  uint64 clock = 1;
  string ens_name = 2;
  map&lt;string, IdentityImage&gt; images = 3;
  string display_name = 4;
  string description = 5;
  string color = 6;
  string emoji = 7;
  repeated SocialLink social_links = 8;
  // first known message timestamp in seconds 
  // (valid only for community chats for now)
  // 0 - unknown
  // 1 - no messages
  uint32 first_message_timestamp = 9;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>Clock value of the message</td></tr>
<tr><td>2</td><td>ens_name</td><td><code>string</code></td><td>A valid ENS associated with the chat key</td></tr>
<tr><td>3</td><td>images</td><td><code>map&lt;string, IdentityImage&gt;</code></td><td>Image data associated with the chat key</td></tr>
<tr><td>4</td><td>display_name</td><td><code>string</code></td><td>The self-assigned display_name of the chat key</td></tr>
<tr><td>5</td><td>description</td><td><code>string</code></td><td>The description of the chat</td></tr>
<tr><td>6</td><td>color</td><td><code>string</code></td><td>The color of the chat</td></tr>
<tr><td>7</td><td>emoji</td><td><code>string</code></td><td>The emoji of the chat</td></tr>
<tr><td>8</td><td>social_links</td><td><code>array&lt;SocialLink&gt;</code></td><td>A list of links to social platforms</td></tr>
<tr><td>9</td><td>first_message_timestamp</td><td><code>uint32</code></td><td>First known message timestamp in seconds</td></tr>
</tbody></table>
</div>
<h3 id="communitydescription"><a class="header" href="#communitydescription">CommunityDescription</a></h3>
<p><code>CommunityDescription</code> represents a community metadata
that is used to discover communities and share community updates.</p>
<pre><code class="language-protobuf">message CommunityDescription {
  uint64 clock = 1;
  map&lt;string,CommunityMember&gt; members = 2;
  CommunityPermissions permissions = 3;
  ChatIdentity identity = 5;
  map&lt;string,CommunityChat&gt; chats = 6;
  repeated string ban_list = 7;
  map&lt;string,CommunityCategory&gt; categories = 8;
  uint64 archive_magnetlink_clock = 9;
  CommunityAdminSettings admin_settings = 10;
  string intro_message = 11;
  string outro_message = 12;
  bool encrypted = 13;
  repeated string tags = 14;
  map&lt;string, CommunityTokenPermission&gt; token_permissions = 15;
  repeated CommunityTokenMetadata community_tokens_metadata = 16;
  uint64 active_members_count = 17;
}

message CommunityMember {
  enum Roles {
    reserved 2, 3;
    reserved "ROLE_MANAGE_USERS", "ROLE_MODERATE_CONTENT";
    ROLE_NONE = 0;
    ROLE_OWNER = 1;
    ROLE_ADMIN = 4;
    ROLE_TOKEN_MASTER = 5;
  }
  repeated Roles roles = 1;
  repeated RevealedAccount revealed_accounts = 2 [deprecated = true];
  uint64 last_update_clock = 3;
}

message CommunityPermissions {
  enum Access {
    UNKNOWN_ACCESS = 0;
    NO_MEMBERSHIP = 1;
    INVITATION_ONLY = 2;
    ON_REQUEST = 3;
  }

  bool ens_only = 1;
  // https://gitlab.matrix.org/matrix-org/olm/blob/master/docs/megolm.md is a 
  // candidate for the algorithm to be used in case we want to have private 
  // communityal chats, lighter than pairwise encryption using the DR, less secure,
  // but more efficient for large number of participants
  bool private = 2;
  Access access = 3;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>Clock value of the message</td></tr>
<tr><td>2</td><td>members</td><td><code>map&lt;string, CommunityMember&gt;</code></td><td>The members of the community</td></tr>
<tr><td>3</td><td>permissions</td><td><code>CommunityPermissions</code></td><td>Image data associated with the chat key</td></tr>
<tr><td>4</td><td>display_name</td><td><code>string</code></td><td>The self-assigned display_name of the chat key</td></tr>
<tr><td>5</td><td>description</td><td><code>string</code></td><td>The description of the chat</td></tr>
<tr><td>6</td><td>color</td><td><code>string</code></td><td>The color of the chat</td></tr>
<tr><td>7</td><td>emoji</td><td><code>string</code></td><td>The emoji of the chat</td></tr>
<tr><td>8</td><td>social_links</td><td><code>array&lt;SocialLink&gt;</code></td><td>A list of links to social platforms</td></tr>
<tr><td>9</td><td>first_message_timestamp</td><td><code>uint32</code></td><td>First known message timestamp in seconds</td></tr>
</tbody></table>
</div>
<h3 id="communityrequesttojoin"><a class="header" href="#communityrequesttojoin">CommunityRequestToJoin</a></h3>
<p>A <code>CommunityRequestToJoin</code> represents a request to join a community,
sent by a user that is not yet a member of that community.
A request to join a community includes a list of <code>RevealedAccount</code>.
These are wallet addresses that users are willing to reveal
with the community's control node and admins.</p>
<pre><code class="language-protobuf">message CommunityRequestToJoin {
  uint64 clock = 1;
  string ens_name = 2;
  string chat_id = 3;
  bytes community_id = 4;
  string display_name = 5;
  repeated RevealedAccount revealed_accounts = 6;
}

message RevealedAccount {
  string address = 1;
  bytes signature = 2;
  repeated uint64 chain_ids = 3;
  bool isAirdropAddress = 4;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>Clock value of the message</td></tr>
<tr><td>2</td><td>ens_name</td><td><code>string</code></td><td>The ENS of the user sending the request</td></tr>
<tr><td>3</td><td>chat_id</td><td><code>string</code></td><td>The id of the chat to request access to</td></tr>
<tr><td>4</td><td>community_id</td><td><code>bytes</code></td><td>The public key of the community</td></tr>
<tr><td>5</td><td>display_name</td><td><code>string</code></td><td>The display name of the usre sending the request</td></tr>
<tr><td>6</td><td>revealed_accounts</td><td><code>array&lt;RevealedAccount&gt;</code></td><td>A list of accounts to reveal to the control node</td></tr>
</tbody></table>
</div>
<h3 id="pinmessage"><a class="header" href="#pinmessage">PinMessage</a></h3>
<p>A <code>PinMessage</code> is a signal that tells a client that a specific message
has to be marked as pinned.</p>
<pre><code class="language-protobuf">message PinMessage {
  uint64 clock = 1;
  string message_id = 2;
  string chat_id = 3;
  bool pinned = 4;
  MessageType message_type = 5;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>Clock value of the message</td></tr>
<tr><td>2</td><td>message_id</td><td><code>string</code></td><td>The id of the message to be pinned</td></tr>
<tr><td>3</td><td>chat_id</td><td><code>string</code></td><td>The id of the chat of the message to be pinned</td></tr>
<tr><td>4</td><td>pinned</td><td><code>bool</code></td><td>Whether the message should be pinned or unpinned</td></tr>
<tr><td>5</td><td>message_type</td><td><code>MessageType</code></td><td>The type of message (public/one-to-one/private-group-chat)</td></tr>
</tbody></table>
</div>
<h3 id="editmessage"><a class="header" href="#editmessage">EditMessage</a></h3>
<p>A <code>EditMessage</code> represents an update to an existing message.</p>
<pre><code class="language-protobuf">message EditMessage {
  uint64 clock = 1;
  string text = 2;

  string chat_id = 3;
  string message_id = 4;

  bytes grant = 5;

  MessageType message_type = 6;

  ChatMessage.ContentType content_type = 7;
  repeated UnfurledLink unfurled_links = 8;
}

</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>Clock value of the message</td></tr>
<tr><td>2</td><td>text</td><td><code>string</code></td><td>The updated message text</td></tr>
<tr><td>3</td><td>chat_id</td><td><code>string</code></td><td>The id of the chat of the message</td></tr>
<tr><td>4</td><td>message_id</td><td><code>string</code></td><td>The id of the message to be edited</td></tr>
<tr><td>5</td><td>grant</td><td><code>bytes</code></td><td>A grant for a community edit messages</td></tr>
<tr><td>6</td><td>message_type</td><td><code>MessageType</code></td><td>The type of message</td></tr>
<tr><td>7</td><td>content_type</td><td><code>ChatMessage.ContentType</code></td><td>The updated content type of the message</td></tr>
<tr><td>8</td><td>unfurled_links</td><td><code>array&lt;UnfurledLink&gt;</code></td><td>Updated link metadata</td></tr>
</tbody></table>
</div>
<h3 id="deletemessage"><a class="header" href="#deletemessage">DeleteMessage</a></h3>
<p>A <code>DeleteMessage</code> represents a signal to delete a message
from the local database of a client.</p>
<pre><code class="language-protobuf">message DeleteMessage {
  uint64 clock = 1;

  string chat_id = 2;
  string message_id = 3;

  // Grant for community delete messages
  bytes grant = 4;

  // The type of message (public/one-to-one/private-group-chat)
  MessageType message_type = 5;

  string deleted_by = 6;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>Clock value of the message</td></tr>
<tr><td>2</td><td>chat_id</td><td><code>string</code></td><td>The id of the chat of the message</td></tr>
<tr><td>3</td><td>message_id</td><td><code>string</code></td><td>The id of the message to delete</td></tr>
<tr><td>4</td><td>grant</td><td><code>bytes</code></td><td>A grant for a community edit messages</td></tr>
<tr><td>5</td><td>message_type</td><td><code>MessageType</code></td><td>The type of message</td></tr>
<tr><td>6</td><td>deleted_by</td><td><code>string</code></td><td>The public key of the user who deleted the message</td></tr>
</tbody></table>
</div>
<h3 id="communitymessagearchivelink"><a class="header" href="#communitymessagearchivelink">CommunityMessageArchiveLink</a></h3>
<p>A <code>CommunityMessageArchiveLink</code> contains a magnet uri for a community's message archive,
created using <a href="status/62/../61/community-history-service.html">61/STATUS-Community-History-Archives</a>.</p>
<pre><code class="language-protobuf">message CommunityMessageArchiveMagnetlink {
  uint64 clock = 1;
  string magnet_uri = 2;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>Clock value of the message</td></tr>
<tr><td>2</td><td>magnet_uri</td><td><code>string</code></td><td>The magnet uri of the community archive torrent</td></tr>
</tbody></table>
</div>
<h3 id="acceptcontactrequest"><a class="header" href="#acceptcontactrequest">AcceptContactRequest</a></h3>
<p>A <code>AcceptContractRequest</code> message signals to the requester that the request was accepted.</p>
<pre><code class="language-protobuf">message AcceptContactRequest {
  string id = 1;
  uint64 clock = 2;
}

</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>id</td><td><code>string</code></td><td>The id of the contact request</td></tr>
<tr><td>2</td><td>clock</td><td><code>uint64</code></td><td>Clock value of the message</td></tr>
</tbody></table>
</div>
<h3 id="retractcontactrequest"><a class="header" href="#retractcontactrequest">RetractContactRequest</a></h3>
<p>A <code>RetractContractRequest</code> message signals to the reiver, of a request,
that the request was retracted.</p>
<pre><code class="language-protobuf">message RetractContactRequest {
  string id = 1;
  uint64 clock = 2;
}

</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>id</td><td><code>string</code></td><td>The id of the contact request</td></tr>
<tr><td>2</td><td>clock</td><td><code>uint64</code></td><td>Clock value of the message</td></tr>
</tbody></table>
</div>
<h3 id="communityrequesttojoinresponse"><a class="header" href="#communityrequesttojoinresponse">CommunityRequestToJoinResponse</a></h3>
<p>A <code>CommunityRequestToJoinResponse</code> represents a response to a request to join a community.</p>
<pre><code class="language-protobuf">message CommunityRequestToJoinResponse {
  uint64 clock = 1;
  CommunityDescription community = 2;
  bool accepted = 3;
  bytes grant = 4;
  bytes community_id = 5;
  string magnet_uri = 6;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>Clock value of the message</td></tr>
<tr><td>2</td><td>community</td><td><code>CommunityDescription</code></td><td>The community metadata</td></tr>
<tr><td>3</td><td>accepted</td><td><code>bool</code></td><td>Whether the request was accepted</td></tr>
<tr><td>4</td><td>grant</td><td><code>bytes</code></td><td>The grant</td></tr>
<tr><td>5</td><td>community_id</td><td><code>bytes</code></td><td>The id of the community</td></tr>
<tr><td>6</td><td>magnet_uri</td><td><code>string</code></td><td>The latest magnet uri of the community's archive torrent</td></tr>
</tbody></table>
</div>
<h3 id="communityrequesttoleave"><a class="header" href="#communityrequesttoleave">CommunityRequestToLeave</a></h3>
<p>A <code>CommunityRequestToLeave</code> represents a signal to a community
that a user wants to be removed from the community's member list.</p>
<pre><code class="language-protobuf">message CommunityRequestToLeave {
  uint64 clock = 1;
  bytes community_id = 2;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>Clock value of the message</td></tr>
<tr><td>2</td><td>community_id</td><td><code>bytes</code></td><td>The id of the community</td></tr>
</tbody></table>
</div>
<h3 id="requestcontactverification"><a class="header" href="#requestcontactverification">RequestContactVerification</a></h3>
<p>A <code>RequestContactVerification</code> is a request to verify a contact using a "challenge",
which can by any string message and
typically involves questions that only the contact should know.</p>
<pre><code class="language-protobuf">message RequestContactVerification {
  uint64 clock = 1;
  string challenge = 3;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>Clock value of the message</td></tr>
<tr><td>2</td><td>challenge</td><td><code>string</code></td><td>The challenge message used for verification</td></tr>
</tbody></table>
</div>
<h3 id="acceptcontactverification"><a class="header" href="#acceptcontactverification">AcceptContactVerification</a></h3>
<p>A <code>AcceptContactVerification</code> signals that a verification request was accepted and
includes a response to the challenge.</p>
<pre><code class="language-protobuf">message AcceptContactVerification {
  uint64 clock = 1;
  string id = 2;
  string response = 3;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>Clock value of the message</td></tr>
<tr><td>2</td><td>id</td><td><code>string</code></td><td>The verification request id</td></tr>
<tr><td>3</td><td>response</td><td><code>string</code></td><td>The response for the challenge</td></tr>
</tbody></table>
</div>
<h3 id="declinecontactverification"><a class="header" href="#declinecontactverification">DeclineContactVerification</a></h3>
<p>A <code>DeclineContactVerification</code> declines a contact verification request.</p>
<pre><code class="language-protobuf">message DeclineContactVerification {
  uint64 clock = 1;
  string id = 2;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>Clock value of the message</td></tr>
<tr><td>2</td><td>id</td><td><code>string</code></td><td>The verification request id</td></tr>
</tbody></table>
</div>
<h3 id="cancelcontactverification"><a class="header" href="#cancelcontactverification">CancelContactVerification</a></h3>
<p>A <code>CancelContactVerification</code> cancels a contact verification request.</p>
<pre><code class="language-protobuf">message CancelContactVerification {
  uint64 clock = 1;
  string id = 2;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>Clock value of the message</td></tr>
<tr><td>2</td><td>id</td><td><code>string</code></td><td>The verification request id</td></tr>
</tbody></table>
</div>
<h3 id="communitycancelrequesttojoin"><a class="header" href="#communitycancelrequesttojoin">CommunityCancelRequestToJoin</a></h3>
<p>A <code>CommunityCancelRequestToJoin</code> cancels a pending request to join.</p>
<pre><code class="language-protobuf">message CommunityCancelRequestToJoin {
  uint64 clock = 1;
  string ens_name = 2;
  string chat_id = 3;
  bytes community_id = 4;
  string display_name = 5;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>Clock value of the message</td></tr>
<tr><td>2</td><td>ens_name</td><td><code>string</code></td><td>The ENS name of the account cancelling the request</td></tr>
<tr><td>3</td><td>chat_id</td><td><code>string</code></td><td>The id of the chat</td></tr>
<tr><td>4</td><td>community_id</td><td><code>bytes</code></td><td>The id of the community</td></tr>
<tr><td>5</td><td>display_name</td><td><code>string</code></td><td>The display name of the account cancelling the request</td></tr>
</tbody></table>
</div>
<h3 id="communityeditsharedaddresses"><a class="header" href="#communityeditsharedaddresses">CommunityEditSharedAddresses</a></h3>
<p>A <code>CommunityEditSharedAddresses</code> message allows users to edit the shared accounts
they've revealed when requesting to join a community.</p>
<pre><code class="language-protobuf">message CommunityEditSharedAddresses {
  uint64 clock = 1;
  bytes community_id = 2;
  repeated RevealedAccount revealed_accounts = 3;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>Clock value of the message</td></tr>
<tr><td>2</td><td>community_id</td><td><code>bytes</code></td><td>The id of the community</td></tr>
<tr><td>3</td><td>revealed_accounts</td><td><code>array&lt;RevealedAccount&gt;</code></td><td>A list of revealed accounts</td></tr>
</tbody></table>
</div>
<h2 id="upgradability"><a class="header" href="#upgradability">Upgradability</a></h2>
<p>There are two ways to upgrade the protocol without breaking compatibility:</p>
<ul>
<li>A node always supports accretion</li>
<li>A node does not support deletion of existing fields or messages,
which might break compatibility</li>
</ul>
<h2 id="security-considerations-20"><a class="header" href="#security-considerations-20">Security Considerations</a></h2>
<h2 id="changelog-4"><a class="header" href="#changelog-4">Changelog</a></h2>
<h3 id="version-05-2"><a class="header" href="#version-05-2">Version 0.5</a></h3>
<p>Released <a href="https://github.com/status-im/specs/commit/968fafff23cdfc67589b34dd64015de29aaf41f0">August 25, 2020</a></p>
<ul>
<li>Added support for emoji reactions</li>
</ul>
<h3 id="version-04-2"><a class="header" href="#version-04-2">Version 0.4</a></h3>
<p>Released <a href="https://github.com/status-im/specs/commit/ad45cd5fed3c0f79dfa472253a404f670dd47396">July 16, 2020</a></p>
<ul>
<li>Added support for images</li>
<li>Added support for audio</li>
</ul>
<h3 id="version-03-2"><a class="header" href="#version-03-2">Version 0.3</a></h3>
<p>Released <a href="https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8">May 22, 2020</a></p>
<ul>
<li>Added language to include Waku in all relevant places</li>
</ul>
<h2 id="copyright-61"><a class="header" href="#copyright-61">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="63status-keycard-usage"><a class="header" href="#63status-keycard-usage">63/STATUS-Keycard-Usage</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Status Keycard Usage</td></tr>
<tr><th>Slug</th><td>63</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Aaryamann Challani &lt;p1ge0nh8er@proton.me&gt;</td></tr>
<tr><th>Contributors</th><td>Jimmy Debe &lt;jimmy@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-66"><a class="header" href="#timeline-66">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/63/keycard-usage.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/63/keycard-usage.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/status/63/keycard-usage.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-08-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eb25cd06d679e94409072a96841de16a6b3910d5/status/63/keycard-usage.md"><code>eb25cd0</code></a> — chore: replace email addresses (#86)</li>
<li><strong>2024-02-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/928173d2fc1ea67035db433561de65592c1f0a24/status/63/keycard-usage.md"><code>928173d</code></a> — Update keycard-usage.md</li>
<li><strong>2024-02-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/68e6d453c2f932d5bf5feff6f20e4cce0342af13/status/63/keycard-usage.md"><code>68e6d45</code></a> — Update keycard-usage.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/100e0e86afb9b9525b8050aa83a360555258bc49/status/63/keycard-usage.md"><code>100e0e8</code></a> — Create keycard-usage.md</li>
</ul>
<!-- timeline:end -->
<h2 id="terminology-8"><a class="header" href="#terminology-8">Terminology</a></h2>
<ul>
<li><strong>Account</strong>: A valid
<a href="https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki">BIP-32</a>
compliant key.</li>
<li><strong>Multiaccount</strong>: An account from which multiple Accounts can be derived.</li>
</ul>
<h2 id="abstract-41"><a class="header" href="#abstract-41">Abstract</a></h2>
<p>This specification describes how an application can use the Status Keycard to -</p>
<ol>
<li>Create Multiaccounts</li>
<li>Store Multiaccounts</li>
<li>Use Multiaccounts for transaction or message signing</li>
<li>Derive Accounts from Multiaccounts</li>
</ol>
<p>More documentation on the Status Keycard can be found <a href="https://keycard.tech/docs/">here</a></p>
<h2 id="motivation-28"><a class="header" href="#motivation-28">Motivation</a></h2>
<p>The Status Keycard is a hardware wallet that can be used to store and
sign transactions.
For the purpose of the Status App,
this specification describes how the Keycard SHOULD be used to store and
sign transactions.</p>
<h2 id="usage-2"><a class="header" href="#usage-2">Usage</a></h2>
<h3 id="endpoints"><a class="header" href="#endpoints">Endpoints</a></h3>
<h4 id="1-initialize-keycard-init-keycard"><a class="header" href="#1-initialize-keycard-init-keycard">1. Initialize Keycard (<code>/init-keycard</code>)</a></h4>
<p>To initialize the keycard for use with the application.
The keycard is locked with a 6 digit pin.</p>
<p>Request wire format</p>
<pre><code class="language-json">{
  "pin": 6_digit_pin
}
</code></pre>
<p>Response wire format</p>
<pre><code class="language-json">{
  "password": password_to_unlock_keycard,
  "puk": 12_digit_recovery_code,
  "pin": provided_pin,
}
</code></pre>
<p>The keycard MUST be initialized before it can be used with the application.
The application SHOULD provide a way to recover the keycard in case the pin is forgotten.</p>
<h3 id="2-get-application-info-get-application-info"><a class="header" href="#2-get-application-info-get-application-info">2. Get Application Info (<code>/get-application-info</code>)</a></h3>
<p>To fetch if the keycard is ready to be used by the application.</p>
<p>Request wire format</p>
<p>The requester MAY add a <code>pairing</code> field to filter through the generated keys</p>
<pre><code class="language-json">{
  "pairing": &lt;shared_secret&gt;/&lt;pairing_index&gt;/&lt;256_bit_salt&gt; OR null
}
</code></pre>
<p>Response wire format</p>
<h4 id="if-the-keycard-is-not-initialized-yet"><a class="header" href="#if-the-keycard-is-not-initialized-yet">If the keycard is not initialized yet</a></h4>
<pre><code class="language-json">{
  "initialized?": false
}
</code></pre>
<h4 id="if-the-keycard-is-initialized"><a class="header" href="#if-the-keycard-is-initialized">If the keycard is initialized</a></h4>
<pre><code class="language-json">{
  "free-pairing-slots": number, 
  "app-version": major_version.minor_version, 
  "secure-channel-pub-key": valid_bip32_key,, 
  "key-uid": unique_id_of_the_default_key,
  "instance-uid": unique_instance_id, 
  "paired?": bool,
  "has-master-key?": bool, 
  "initialized?" true
}
</code></pre>
<h3 id="3-pairing-the-keycard-to-the-client-device-pair"><a class="header" href="#3-pairing-the-keycard-to-the-client-device-pair">3. Pairing the Keycard to the Client device (<code>/pair</code>)</a></h3>
<p>To establish a secure communication channel described <a href="https://keycard.tech/docs/apdu/opensecurechannel.html">here</a>,
the keycard and the client device need to be paired.</p>
<p>Request wire format</p>
<pre><code class="language-json">{
  "password": password_to_unlock_keycard
}
</code></pre>
<p>Response wire format</p>
<pre><code class="language-json">"&lt;shared_secret&gt;/&lt;pairing_index&gt;/&lt;256_bit_salt&gt;"
</code></pre>
<h3 id="4-generate-a-new-set-of-keys-generate-and-load-keys"><a class="header" href="#4-generate-a-new-set-of-keys-generate-and-load-keys">4. Generate a new set of keys (<code>/generate-and-load-keys</code>)</a></h3>
<p>To generate a new set of keys and load them onto the keycard.</p>
<p>Request wire format</p>
<pre><code class="language-json">{
  "mnemonic": 12_word_mnemonic,
  "pairing": &lt;shared_secret&gt;/&lt;pairing_index&gt;/&lt;256_bit_salt&gt;,
  "pin": 6_digit_pin
}
</code></pre>
<p>Response wire format</p>
<pre><code class="language-json">{
  "whisper-address": 20_byte_whisper_compatible_address, 
  "whisper-private-key": whisper_private_key, 
  "wallet-root-public-key": 256_bit_wallet_root_public_key, 
  "encryption-public-key": 256_bit_encryption_public_key,, 
  "wallet-root-address": 20_byte_wallet_root_address, 
  "whisper-public-key": 256_bit_whisper_public_key,
  "address": 20_byte_address, 
  "wallet-address": 20_byte_wallet_address,, 
  "key-uid": 64_byte_unique_key_id, 
  "wallet-public-key": 256_bit_wallet_public_key,
  "public-key": 256_bit_public_key,
  "instance-uid": 32_byte_unique_instance_id,
}
</code></pre>
<h3 id="5-get-a-set-of-generated-keys-get-keys"><a class="header" href="#5-get-a-set-of-generated-keys-get-keys">5. Get a set of generated keys (<code>/get-keys</code>)</a></h3>
<p>To fetch the keys that are currently loaded on the keycard.</p>
<p>Request wire format</p>
<pre><code class="language-json">{
  "pairing": &lt;shared_secret&gt;/&lt;pairing_index&gt;/&lt;256_bit_salt&gt;,
  "pin": 6_digit_pin
}
</code></pre>
<p>Response wire format</p>
<pre><code class="language-json">{
  "whisper-address": 20_byte_whisper_compatible_address, 
  "whisper-private-key": whisper_private_key, 
  "wallet-root-public-key": 256_bit_wallet_root_public_key, 
  "encryption-public-key": 256_bit_encryption_public_key,
  "wallet-root-address": 20_byte_wallet_root_address, 
  "whisper-public-key": 256_bit_whisper_public_key,
  "address": 20_byte_address, 
  "wallet-address": 20_byte_wallet_address, 
  "key-uid": 64_byte_unique_key_id, 
  "wallet-public-key": 256_bit_wallet_public_key,
  "public-key": 256_bit_public_key,
  "instance-uid": 32_byte_unique_instance_id,
}
</code></pre>
<h3 id="6-sign-a-transaction-sign"><a class="header" href="#6-sign-a-transaction-sign">6. Sign a transaction (<code>/sign</code>)</a></h3>
<p>To sign a transaction using the keycard, passing in the pairing information and
the transaction to be signed.</p>
<p>Request wire format</p>
<pre><code class="language-json">{
  "hash": 64_byte_hash_of_the_transaction,
  "pairing": &lt;shared_secret&gt;/&lt;pairing_index&gt;/&lt;256_bit_salt&gt;,
  "pin": 6_digit_pin,
  "path": bip32_path_to_the_key
}
</code></pre>
<p>Response wire format</p>
<pre><code class="language-json">&lt;256_bit_signature&gt;
</code></pre>
<h3 id="7-export-a-key-export-key"><a class="header" href="#7-export-a-key-export-key">7. Export a key (<code>/export-key</code>)</a></h3>
<p>To export a key from the keycard, passing in the pairing information and
the path to the key to be exported.</p>
<p>Request wire format</p>
<pre><code class="language-json">{
  "pairing": &lt;shared_secret&gt;/&lt;pairing_index&gt;/&lt;256_bit_salt&gt;,
  "pin": 6_digit_pin,
  "path": bip32_path_to_the_key
}
</code></pre>
<p>Response wire format</p>
<pre><code class="language-json">&lt;256_bit_public_key&gt;
</code></pre>
<h3 id="8-verify-a-pin-verify-pin"><a class="header" href="#8-verify-a-pin-verify-pin">8. Verify a pin (<code>/verify-pin</code>)</a></h3>
<p>To verify the pin of the keycard.</p>
<p>Request wire format</p>
<pre><code class="language-json">{
  "pin": 6_digit_pin
}
</code></pre>
<p>Response wire format</p>
<pre><code class="language-json">1_digit_status_code
</code></pre>
<p>Status code reference:</p>
<ul>
<li>3: PIN is valid</li>
</ul>
<!--TODO: what are the other status codes?-->
<h3 id="9-change-the-pin-change-pin"><a class="header" href="#9-change-the-pin-change-pin">9. Change the pin (<code>/change-pin</code>)</a></h3>
<p>To change the pin of the keycard.</p>
<p>Request wire format</p>
<pre><code class="language-json">{
  "new-pin": 6_digit_new_pin,
  "current-pin": 6_digit_new_pin,
  "pairing": &lt;shared_secret&gt;/&lt;pairing_index&gt;/&lt;256_bit_salt&gt;
}
</code></pre>
<p>Response wire format</p>
<h4 id="if-the-operation-was-successful"><a class="header" href="#if-the-operation-was-successful">If the operation was successful</a></h4>
<pre><code class="language-json">true
</code></pre>
<h4 id="if-the-operation-was-unsuccessful"><a class="header" href="#if-the-operation-was-unsuccessful">If the operation was unsuccessful</a></h4>
<pre><code class="language-json">false
</code></pre>
<h3 id="10-unblock-the-keycard-unblock-pin"><a class="header" href="#10-unblock-the-keycard-unblock-pin">10. Unblock the keycard (<code>/unblock-pin</code>)</a></h3>
<p>If the Keycard is blocked due to too many incorrect pin attempts,
it can be unblocked using the PUK.</p>
<p>Request wire format</p>
<pre><code class="language-json">{
  "puk": 12_digit_recovery_code,
  "new-pin": 6_digit_new_pin,
  "pairing": &lt;shared_secret&gt;/&lt;pairing_index&gt;/&lt;256_bit_salt&gt;
}
</code></pre>
<p>Response wire format</p>
<p>If the operation was successful</p>
<pre><code class="language-json">true
</code></pre>
<p>If the operation was unsuccessful</p>
<pre><code class="language-json">false
</code></pre>
<h2 id="flows"><a class="header" href="#flows">Flows</a></h2>
<p>Any application that uses the Status Keycard
MAY implement the following flows according to the actions listed above.</p>
<h3 id="1-a-new-user-wants-to-use-the-keycard-with-the-application"><a class="header" href="#1-a-new-user-wants-to-use-the-keycard-with-the-application">1. A new user wants to use the Keycard with the application</a></h3>
<ol>
<li>The user initializes the Keycard using the <code>/init-keycard</code> endpoint.</li>
<li>The user pairs the Keycard with the client device using the <code>/pair</code> endpoint.</li>
<li>The user generates a new set of keys using the <code>/generate-and-load-keys</code> endpoint.</li>
<li>The user can now use the Keycard to sign transactions using the <code>/sign</code> endpoint.</li>
</ol>
<h3 id="2-an-existing-user-wants-to-use-the-keycard-with-the-application"><a class="header" href="#2-an-existing-user-wants-to-use-the-keycard-with-the-application">2. An existing user wants to use the Keycard with the application</a></h3>
<ol>
<li>The user pairs the Keycard with the client device using the <code>/pair</code> endpoint.</li>
<li>The user can now use the Keycard to sign transactions using the <code>/sign</code> endpoint.</li>
</ol>
<h3 id="3-an-existing-user-wants-to-use-the-keycard-with-a-new-client-device"><a class="header" href="#3-an-existing-user-wants-to-use-the-keycard-with-a-new-client-device">3. An existing user wants to use the Keycard with a new client device</a></h3>
<ol>
<li>The user pairs the Keycard with the new client device using the <code>/pair</code> endpoint.</li>
<li>The user can now use the Keycard to sign transactions using the <code>/sign</code> endpoint.</li>
</ol>
<h3 id="4-an-existing-user-wishes-to-verify-the-pin-of-the-keycard"><a class="header" href="#4-an-existing-user-wishes-to-verify-the-pin-of-the-keycard">4. An existing user wishes to verify the pin of the Keycard</a></h3>
<ol>
<li>The user verifies the pin of the Keycard using the <code>/verify-pin</code> endpoint.</li>
</ol>
<h3 id="5-an-existing-user-wishes-to-change-the-pin-of-the-keycard"><a class="header" href="#5-an-existing-user-wishes-to-change-the-pin-of-the-keycard">5. An existing user wishes to change the pin of the Keycard</a></h3>
<ol>
<li>The user changes the pin of the Keycard using the <code>/change-pin</code> endpoint.</li>
</ol>
<h3 id="6-an-existing-user-wishes-to-unblock-the-keycard"><a class="header" href="#6-an-existing-user-wishes-to-unblock-the-keycard">6. An existing user wishes to unblock the Keycard</a></h3>
<ol>
<li>The user unblocks the Keycard using the <code>/unblock-pin</code> endpoint.</li>
</ol>
<h2 id="security-considerations-21"><a class="header" href="#security-considerations-21">Security Considerations</a></h2>
<p>Inherits the security considerations of <a href="https://keycard.tech/docs/">Status Keycard</a></p>
<h2 id="privacy-considerations-5"><a class="header" href="#privacy-considerations-5">Privacy Considerations</a></h2>
<p>Inherits the privacy considerations of <a href="https://keycard.tech/docs/">Status Keycard</a></p>
<h2 id="copyright-62"><a class="header" href="#copyright-62">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-49"><a class="header" href="#references-49">References</a></h2>
<ol>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki">BIP-32 specification</a></li>
<li><a href="https://keycard.tech/docs/">Keycard documentation</a></li>
<li><a href="https://specs.status.im/draft/16">16/Keycard-Usage</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="65status-account-address"><a class="header" href="#65status-account-address">65/STATUS-ACCOUNT-ADDRESS</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Status Account Address</td></tr>
<tr><th>Slug</th><td>65</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Aaryamann Challani &lt;p1ge0nh8er@proton.me&gt;</td></tr>
<tr><th>Contributors</th><td>Corey Petty &lt;corey@status.im&gt;<br>Oskar Thorén &lt;oskarth@titanproxy.com&gt;<br>Samuel Hawksby-Robinson &lt;samuel@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-67"><a class="header" href="#timeline-67">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/65/account-address.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/65/account-address.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/status/65/account-address.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-08-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eb25cd06d679e94409072a96841de16a6b3910d5/status/65/account-address.md"><code>eb25cd0</code></a> — chore: replace email addresses (#86)</li>
<li><strong>2024-02-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/67a1221ab0b0b27e3376c389575c77bfa38057de/status/65/account-address.md"><code>67a1221</code></a> — Update account-address.md</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/91874da9b18b40078d4932819b30d271b321ac53/status/65/account-address.md"><code>91874da</code></a> — Update and rename ACCOUNT-ADDRESS.md to account-address.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/ae04f026594cf6c4ede40b5d4ba8bb4e3462a447/status/65/ACCOUNT-ADDRESS.md"><code>ae04f02</code></a> — Create ACCOUNT-ADDRESS.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-42"><a class="header" href="#abstract-42">Abstract</a></h2>
<p>This specification details what a Status account address is and
how account addresses are created and used.</p>
<h2 id="background-5"><a class="header" href="#background-5">Background</a></h2>
<p>The core concept of an account in Status is a set of cryptographic keypairs.
Namely, the combination of the following:</p>
<ol>
<li>a Waku chat identity keypair</li>
<li>a set of cryptocurrency wallet keypairs</li>
</ol>
<p>The Status node verifies or
derives everything else associated with the contact from the above items, including:</p>
<ul>
<li>Ethereum address (future verification, currently the same base keypair)</li>
<li>identicon</li>
<li>message signatures</li>
</ul>
<h2 id="initial-key-generation"><a class="header" href="#initial-key-generation">Initial Key Generation</a></h2>
<h3 id="publicprivate-keypairs"><a class="header" href="#publicprivate-keypairs">Public/Private Keypairs</a></h3>
<ul>
<li>
<p>An ECDSA (secp256k1 curve) public/private keypair MUST be generated via a
<a href="https://github.com/bitcoin/bips/blob/master/bip-0043.mediawiki">BIP43</a>
derived path from a
<a href="https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki">BIP39</a>
mnemonic seed phrase.</p>
</li>
<li>
<p>The default paths are defined as such:</p>
<ul>
<li>Waku Chat Key (<code>IK</code>): <code>m/43'/60'/1581'/0'/0</code>  (post Multiaccount integration)
<ul>
<li>following <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1581.md">EIP1581</a></li>
</ul>
</li>
<li>Status Wallet paths: <code>m/44'/60'/0'/0/i</code> starting at <code>i=0</code>
<ul>
<li>following <a href="https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki">BIP44</a></li>
<li>NOTE: this (<code>i=0</code>) is also the current (and only)
path for Waku key before Multiaccount integration</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="account-broadcasting"><a class="header" href="#account-broadcasting">Account Broadcasting</a></h2>
<ul>
<li>A user is responsible for broadcasting certain information publicly so
that others may contact them.</li>
</ul>
<h3 id="x3dh-prekey-bundles"><a class="header" href="#x3dh-prekey-bundles">X3DH Prekey bundles</a></h3>
<ul>
<li>Refer to <a href="status/65/../../waku/standards/application/53/x3dh.html">53/WAKU2-X3DH</a>
for details on the X3DH prekey bundle broadcasting, as well as regeneration.</li>
</ul>
<h2 id="optional-account-additions"><a class="header" href="#optional-account-additions">Optional Account additions</a></h2>
<h3 id="ens-username"><a class="header" href="#ens-username">ENS Username</a></h3>
<ul>
<li>A user MAY register a public username on the Ethereum Name System (ENS).
This username is a user-chosen subdomain of the <code>stateofus.eth</code>
ENS registration that maps to their Waku identity key (<code>IK</code>).</li>
</ul>
<h3 id="user-profile-picture"><a class="header" href="#user-profile-picture">User Profile Picture</a></h3>
<ul>
<li>An account MAY edit the <code>IK</code> generated identicon with a chosen picture.
This picture will become part of the publicly broadcasted profile of the account.</li>
</ul>
<!-- TODO: Elaborate on wallet account and multiaccount -->
<h2 id="wire-format-5"><a class="header" href="#wire-format-5">Wire Format</a></h2>
<p>Below is the wire format for the account information that is broadcasted publicly.
An Account is referred to as a Multiaccount in the wire format.</p>
<pre><code class="language-proto">message MultiAccount {
  string name = 1; // name of the account
  int64 timestamp = 2; // timestamp of the message
  string identicon = 3; // base64 encoded identicon
  repeated ColorHash color_hash = 4; // color hash of the identicon
  int64 color_id = 5; // color id of the identicon
  string keycard_pairing = 6; // keycard pairing code
  string key_uid = 7; // unique identifier of the account
  repeated IdentityImage images = 8; // images associated with the account
  string customization_color = 9; // color of the identicon
  uint64 customization_color_clock = 10; // clock of the identicon color, to track updates

  message ColorHash {
    repeated int64 index = 1;
  }

  message IdentityImage {
    string key_uid = 1; // unique identifier of the image
    string name = 2; // name of the image
    bytes payload = 3; // payload of the image
    int64 width = 4; // width of the image
    int64 height = 5; // height of the image
    int64 filesize = 6; // filesize of the image
    int64 resize_target = 7; // resize target of the image
    uint64 clock = 8; // clock of the image, to track updates
  }
}
</code></pre>
<p>The above payload is broadcasted when 2 devices
that belong to a user need to be paired.</p>
<h2 id="security-considerations-22"><a class="header" href="#security-considerations-22">Security Considerations</a></h2>
<ul>
<li>This specification inherits security considerations of
<a href="status/65/../../waku/standards/application/53/x3dh.html">53/WAKU2-X3DH</a> and
<a href="status/65/../../waku/standards/application/54/x3dh-sessions.html">54/WAKU2-X3DH-SESSIONS</a>.</li>
</ul>
<h2 id="copyright-63"><a class="header" href="#copyright-63">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-50"><a class="header" href="#references-50">References</a></h2>
<h3 id="normative-3"><a class="header" href="#normative-3">normative</a></h3>
<ul>
<li><a href="status/65/../../waku/standards/application/53/x3dh.html">53/WAKU2-X3DH</a></li>
<li><a href="status/65/../../waku/standards/application/54/x3dh-sessions.html">54/WAKU2-X3DH-SESSIONS</a></li>
<li><a href="status/65/../55/1to1-chat.html">55/STATUS-1TO1-CHAT</a></li>
</ul>
<h2 id="informative-6"><a class="header" href="#informative-6">informative</a></h2>
<ul>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0043.mediawiki">BIP43</a></li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki">BIP39</a></li>
<li><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1581.md">EIP1581</a></li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki">BIP44</a></li>
<li><a href="https://ens.domains/">Ethereum Name System</a></li>
<li><a href="status/65/../63/account-address.html">Status Multiaccount</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="71status-push-notification-server"><a class="header" href="#71status-push-notification-server">71/STATUS-PUSH-NOTIFICATION-SERVER</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Push Notification Server</td></tr>
<tr><th>Slug</th><td>71</td></tr>
<tr><th>Status</th><td>draft</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Jimmy Debe &lt;jimmy@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Andrea Maria Piana &lt;andreap@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-68"><a class="header" href="#timeline-68">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/71/push-notification-server.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/71/push-notification-server.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/status/71/push-notification-server.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-02-07</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3e21cc0aabe72b00bf2e6ce51ed889e929e4a047/status/71/push-notification-server.md"><code>3e21cc0</code></a> — Update push-notification-server.md</li>
<li><strong>2024-02-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/5bce32702ae3dcb1c05f491804a745724533db7e/status/71/push-notification-server.md"><code>5bce327</code></a> — Update push-notification-server.md</li>
<li><strong>2024-02-02</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/8df3f006cf6a9dd64c3cfa8c99256330cc696df7/status/71/push-notification-server.md"><code>8df3f00</code></a> — Update and rename PUSH-NOTIFICATIONS.md to push-notification-server.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/eb7c5bf71edd47cf0b5d0f0919013cdea17c4f43/status/71/PUSH-NOTIFICATIONS.md"><code>eb7c5bf</code></a> — Create PUSH-NOTIFICATIONS.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-43"><a class="header" href="#abstract-43">Abstract</a></h2>
<p>A push notification server implementation for IOS devices and Android devices.
This specification provides a set of methods that allow clients
to use push notification services in mobile environments.</p>
<h2 id="background-6"><a class="header" href="#background-6">Background</a></h2>
<p>Push notification for iOS and
Android devices can only be implemented by relying on
<a href="https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/APNSOverview.html#//apple_ref/doc/uid/TP40008194-CH8-SW1">APN</a>,
Apple Push Notification, service for iOS or
<a href="https://firebase.google.com/">Firebase</a> for Android.</p>
<p>For some Android devices, foreground services are restricted,
requiring a user to grant authorization to applications
to use foreground notifications.
Apple iOS devices restrict notifications to
a few internal functions that every application can not use.
Applications on iOS can request execution time when they are in the background.
This has a limited set of use cases for example,
it will not schedule any time if the application was closed with force quit.
Requesting execution time is not responsive enough to
implement a push notification system.
Status provides a set of methods to acheive push notification services.</p>
<p>Since this can not be safely implemented in a privacy-preserving manner,
clients need to be given an option to opt-in to receive and send push notifications.
They are disabled by default.</p>
<h2 id="specification-11"><a class="header" href="#specification-11">Specification</a></h2>
<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”,
“SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and
“OPTIONAL” in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">2119</a>.</p>
<h3 id="definitions-9"><a class="header" href="#definitions-9">Definitions</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Terminology</th><th>Description</th></tr></thead><tbody>
<tr><td>client</td><td>A node that implements the Status specifications.</td></tr>
<tr><td>user</td><td>The owner of a device that runs a client.</td></tr>
<tr><td>server</td><td>A service that performs push notifications.</td></tr>
<tr><td>Waku-Store</td><td>A Waku node that decides to provide functionality to store messages permanently and deliver the messages to requesting clients. As described in <a href="status/71/../../waku/standards/core/13/store.html">13/WAKU-STORE</a> specification.</td></tr>
</tbody></table>
</div>
<h3 id="server-components"><a class="header" href="#server-components">Server Components</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Components</th><th>Description</th></tr></thead><tbody>
<tr><td>gorush Instance</td><td>Only used by push notification servers and MUST be publicly available.</td></tr>
<tr><td>Push Notification Server</td><td>Used by clients to register for receiving and sending notifications.</td></tr>
<tr><td>Registering Client</td><td>A client that wants to receive push notifications.</td></tr>
<tr><td>Sending Client</td><td>A client that wants to send push notifications.</td></tr>
</tbody></table>
</div>
<h3 id="requirements-2"><a class="header" href="#requirements-2">Requirements</a></h3>
<p>The party releasing the app MUST possess a certificate
for the Apple Push Notification service and
it MUST run a <a href="https://github.com/appleboy/gorush">gorush</a>
publicly accessible server for sending the actual notification.
The party releasing the app MUST run its own <a href="https://github.com/appleboy/gorush">gorush</a>.</p>
<h3 id="push-notification-server-flow"><a class="header" href="#push-notification-server-flow">Push Notification Server Flow</a></h3>
<h4 id="registration-process"><a class="header" href="#registration-process">Registration Process</a></h4>
<p><img src="status/71/./images/registration.png" alt="registration" /></p>
<h4 id="sending-and-receiving-notification-process"><a class="header" href="#sending-and-receiving-notification-process">Sending and Receiving Notification Process</a></h4>
<p><img src="status/71/./images/notification.png" alt="notification" /></p>
<h3 id="registering-client"><a class="header" href="#registering-client">Registering Client</a></h3>
<p>Registering a client with a push notification service.</p>
<ul>
<li>
<p>A client MAY register with one or
more push notification services in order to increase availability.</p>
</li>
<li>
<p>A client SHOULD make sure that all the notification services they registered with
have the same information about their tokens.</p>
</li>
<li>
<p>A <code>PNR message</code> (Push Notification Registration) MUST be sent to the
<a href="status/71/../../waku/standards/application/54/x3dh-sessions.html">partitioned topic</a>
for the public key of the node, encrypted with this key.</p>
</li>
<li>
<p>The message MUST be wrapped in a
<a href="status/71/../62/payloads.html"><code>ApplicationMetadataMessage</code></a> with type set to <code>PUSH_NOTIFICATION_REGISTRATION</code>.</p>
</li>
<li>
<p>The marshaled protobuf payload MUST also be encrypted with AES-GCM
using the Diffie–Hellman key generated from the client and server identity.
This is done in order to ensure that the extracted key from the signature
will be considered invalid if it can’t decrypt the payload.</p>
</li>
</ul>
<p>The content of the message MUST contain the following <a href="https://developers.google.com/protocol-buffers/">protobuf record</a>:</p>
<pre><code class="language-protobuf">message PushNotificationRegistration {
  enum TokenType {
    UNKNOWN_TOKEN_TYPE = 0;
    APN_TOKEN = 1;
    FIREBASE_TOKEN = 2;
  }
  TokenType token_type = 1;
  string device_token = 2;
  string installation_id = 3;
  string access_token = 4;
  bool enabled = 5;
  uint64 version = 6;
  repeated bytes allowed_key_list = 7;
  repeated bytes blocked_chat_list = 8;
  bool unregister = 9;
  bytes grant = 10;
  bool allow_from_contacts_only = 11;
  string apn_topic = 12;
  bool block_mentions = 13;
  repeated bytes allowed_mentions_chat_list = 14;
}
</code></pre>
<p>A push notification server will handle the message according to the following rules:</p>
<ul>
<li>
<p>it MUST extract the public key of the sender from the signature and
verify that the payload can be decrypted successfully.</p>
</li>
<li>
<p>it MUST verify that <code>token_type</code> is supported.</p>
</li>
<li>
<p>it MUST verify that <code>device_token</code> is non empty.</p>
</li>
<li>
<p>it MUST verify that <code>installation_id</code> is non empty.</p>
</li>
<li>
<p>it MUST verify that <code>version</code> is non-zero and
greater than the currently stored version for the public key and
<code>installation_id</code> of the sender, if any.</p>
</li>
<li>
<p>it MUST verify that <code>grant</code> is non empty and according to the Grant Server specs.</p>
</li>
<li>
<p>it MUST verify that <code>access_token</code> is a valid uuid.</p>
</li>
<li>
<p>it MUST verify that <code>apn_topic</code> is set if token_type is APN_TOKEN.</p>
</li>
<li>
<p>The message MUST be wrapped in a
<a href="status/71/../62/payloads.html"><code>ApplicationMetadataMessage</code></a> with type set to <code>PUSH_NOTIFICATION_REGISTRATION_RESPONSE</code>.</p>
</li>
</ul>
<p>The payload of the response is:</p>
<pre><code class="language-protobuf">message PushNotificationRegistrationResponse {
  bool success = 1;
  ErrorType error = 2;
  bytes request_id = 3;

  enum ErrorType {
    UNKNOWN_ERROR_TYPE = 0;
    MALFORMED_MESSAGE = 1;
    VERSION_MISMATCH = 2;
    UNSUPPORTED_TOKEN_TYPE = 3;
    INTERNAL_ERROR = 4;
  }
}

</code></pre>
<p>A client SHOULD listen for a response sent on the
<a href="status/71/../../waku/standards/application/54/x3dh-sessions.html">partitioned topic</a>
that the key used to register.
If success is true the client has registered successfully.</p>
<p>If <code>success</code> is <code>false</code>:</p>
<blockquote>
<p>If <code>MALFORMED_MESSAGE</code> is returned,
the request SHOULD NOT be retried without ensuring that it is correctly formed.
If <code>INTERNAL_ERROR</code> is returned, the request MAY be retried,
but the client MUST backoff exponentially.</p>
</blockquote>
<h4 id="handle-errors"><a class="header" href="#handle-errors">Handle Errors</a></h4>
<ul>
<li>
<p>If the message can’t be decrypted, the message MUST be discarded.</p>
</li>
<li>
<p>If <code>token_type</code> is not supported, a response MUST be sent with <code>error</code> set to <code>UNSUPPORTED_TOKEN_TYPE</code>.</p>
</li>
<li>
<p>If <code>token</code>, <code>installation_id</code>, <code>device_tokens</code>, <code>version</code> are empty,
a response MUST be sent with <code>error</code> set to <code>MALFORMED_MESSAGE</code>.</p>
</li>
<li>
<p>If the <code>version</code> is equal or less than the currently stored <code>version</code>,
a response MUST be sent with <code>error</code> set to <code>VERSION_MISMATCH</code>.</p>
</li>
<li>
<p>If any other error occurs the <code>error</code> SHOULD be set to <code>INTERNAL_ERROR</code>.</p>
</li>
<li>
<p>If the response is successful <code>success</code> MUST be set to <code>true</code> otherwise
a response MUST be sent with <code>success</code> set to <code>false</code>.</p>
</li>
<li>
<p><code>request_id</code> SHOULD be set to the
<a href="https://nvlpubs.nist.gov/nistpubs/fips/nist.fips.202.pdf"><code>SHAKE-256</code></a>
of the encrypted payload.</p>
</li>
<li>
<p>The response MUST be sent on the
<a href="status/71/../../waku/standards/application/54/x3dh-sessions.html">partitioned topic</a>
of the sender and MUST not be encrypted using
the secure transport to facilitate the usage of ephemeral keys.</p>
</li>
<li>
<p>If no response is returned, the request SHOULD be considered failed and
MAY be retried with the same server or a different one, but clients
MUST exponentially backoff after each trial.</p>
</li>
</ul>
<h2 id="push-notification-server"><a class="header" href="#push-notification-server">Push Notification Server</a></h2>
<p>A node that handles receiving and sending push notifications for clients.</p>
<h3 id="query-topic"><a class="header" href="#query-topic">Query Topic</a></h3>
<p>On successful registration the server MUST be listening to the topic derived from:</p>
<blockquote>
<p><code>0x</code> + HexEncode(Shake256(CompressedClientPublicKey))</p>
</blockquote>
<p>Using the topic derivation algorithm described here and listen for client queries.</p>
<h4 id="server-grant"><a class="header" href="#server-grant">Server Grant</a></h4>
<p>A client MUST authorize a push notification server to send them push notifications.
This is done by building a grant which is specific to a given client-server pair.
When receiving a grant,
the server MUST validate that the signature matches the registering client.</p>
<p>The grant is built as:</p>
<pre><code class="language-js">`Signature(Keccak256(CompressedPublicKeyOfClient.CompressedPublicKeyOfServer.AccessToken), PrivateKeyOfClient)`
</code></pre>
<h4 id="unregistering-with-a-server"><a class="header" href="#unregistering-with-a-server">Unregistering with a Server</a></h4>
<ul>
<li>To unregister a client MUST send a <code>PushNotificationRegistration</code>
request as described above with <code>unregister</code> set to <code>true</code>,
or removing their device information.</li>
<li>The server MUST remove all data about this user if <code>unregistering</code> is <code>true</code>,
apart from the <code>hash</code> of the public key and
the <code>version</code> of the last options,
in order to make sure that old messages are not processed.</li>
<li>A client MAY unregister from a server on explicit logout
if multiple chat keys are used on a single device.</li>
</ul>
<h4 id="re-registering-with-a-server"><a class="header" href="#re-registering-with-a-server">Re-registering with a Server</a></h4>
<ul>
<li>A client SHOULD re-register with the node if the APN or FIREBASE token changes.</li>
<li>When re-registering a client SHOULD ensure
that it has the most up-to-date <code>PushNotificationRegistration</code> and
increment <code>version</code> if necessary.</li>
<li>Once re-registered, a client SHOULD advertise the changes.
Changing options is handled the same as re-registering.</li>
</ul>
<h4 id="advertising-a-server"><a class="header" href="#advertising-a-server">Advertising a Server</a></h4>
<p>Each user registered with one or more push notification servers
SHOULD advertise periodically the push notification services
they have registered with for each device they own.</p>
<pre><code class="language-protobuf">message PushNotificationQueryInfo {
  string access_token = 1;
  string installation_id = 2;
  bytes public_key = 3;
  repeated bytes allowed_user_list = 4;
  bytes grant = 5;
  uint64 version = 6;
  bytes server_public_key = 7;
}

message ContactCodeAdvertisement {
  repeated PushNotificationQueryInfo push_notification_info = 1;
}

</code></pre>
<h4 id="handle-advertisement-message"><a class="header" href="#handle-advertisement-message">Handle Advertisement Message</a></h4>
<ul>
<li>The message MUST be wrapped in a
<a href="status/71/../62/payloads.html"><code>ApplicationMetadataMessage</code></a> with type set to <code>PUSH_NOTIFICATION_QUERY_INFO</code>.</li>
<li>If no filtering is done based on public keys,
the access token SHOULD be included in the advertisement.
Otherwise it SHOULD be left empty.</li>
<li>This SHOULD be advertised on the
<a href="status/71/../../waku/standards/application/53/x3dh.html">contact code topic</a> and
SHOULD be coupled with normal contact-code advertisement.</li>
<li>When a user register or re-register with a push notification service,
their contact-code SHOULD be re-advertised.</li>
<li>Multiple servers MAY be advertised for the same installation_id
 for redundancy reasons.</li>
</ul>
<h4 id="discovering-a-server"><a class="header" href="#discovering-a-server">Discovering a Server</a></h4>
<p>To discover a push notification service for a given user, their
<a href="status/71/../../waku/standards/application/53/x3dh.html">contact code topic</a>
SHOULD be listened to.
A Waku-Store node can be queried for the specific topic
to retrieve the most up-to-date contact code.</p>
<h4 id="querying-a-server"><a class="header" href="#querying-a-server">Querying a Server</a></h4>
<p>If a token is not present in the latest advertisement for a user,
the server SHOULD be queried directly.</p>
<p>To query a server a message:</p>
<pre><code class="language-protobuf">message PushNotificationQuery {
  repeated bytes public_keys = 1;
}

</code></pre>
<h4 id="handle-query-message"><a class="header" href="#handle-query-message">Handle Query Message</a></h4>
<ul>
<li>The message MUST be wrapped in a
<a href="status/71/../62/payloads.html"><code>ApplicationMetadataMessage</code></a> with type set to <code>PUSH_NOTIFICATION_QUERY</code>.</li>
<li>it MUST be sent to the server on the topic derived from the hashed public key
of the key we are querying,
<a href="status/71/push-notification-server.html#query-topic">as described above</a>.</li>
<li>An ephemeral key SHOULD be used and SHOULD NOT be encrypted using the <a href="status/71/../../waku/standards/application/53/x3dh.html">secure transport</a>.</li>
</ul>
<p>If the server has information about the client a response MUST be sent:</p>
<pre><code class="language-protobuf">message PushNotificationQueryInfo {
  string access_token = 1;
  string installation_id = 2;
  bytes public_key = 3;
  repeated bytes allowed_user_list = 4;
  bytes grant = 5;
  uint64 version = 6;
  bytes server_public_key = 7;
}

message PushNotificationQueryResponse {
  repeated PushNotificationQueryInfo info = 1;
  bytes message_id = 2;
  bool success = 3;
}

</code></pre>
<h4 id="handle-query-response"><a class="header" href="#handle-query-response">Handle Query Response</a></h4>
<ul>
<li>
<p>A <code>PushNotificationQueryResponse</code> message MUST be wrapped in a
<a href="status/71/../62/payloads.html"><code>ApplicationMetadataMessage</code></a> with type set to <code>PUSH_NOTIFICATION_QUERY_RESPONSE</code>.
Otherwise a response MUST NOT be sent.</p>
</li>
<li>
<p>If <code>allowed_key_list</code> is not set <code>access_token</code> MUST be set
and <code>allowed_key_list</code> MUST NOT be set.</p>
</li>
<li>
<p>If <code>allowed_key_list</code> is set <code>allowed_key_list</code> MUST be set and
<code>access_token</code> MUST NOT be set.</p>
</li>
<li>
<p>If <code>access_token</code> is returned,
the <code>access_token</code> SHOULD be used to send push notifications.</p>
</li>
<li>
<p>If <code>allowed_key_list</code> are returned,
the client SHOULD decrypt each token by generating an <code>AES-GCM</code> symmetric key
from the Diffie–Hellman between the target client and itself.
If AES decryption succeeds,
it will return a valid <code>uuid</code> which is what is used for access_token.
The token SHOULD be used to send push notifications.</p>
</li>
<li>
<p>The response MUST be sent on the
<a href="status/71/../../waku/standards/application/54/x3dh-sessions.html">partitioned topic</a>
of the sender and
MUST NOT be encrypted using the
<a href="status/71/../../waku/standards/application/53/x3dh.html">secure transport</a>
to facilitate the usage of ephemeral keys.</p>
</li>
<li>
<p>On receiving a response,
a client MUST verify <code>grant</code> to ensure that the server
has been authorized to send push notification to a given client.</p>
</li>
</ul>
<h3 id="sending-client"><a class="header" href="#sending-client">Sending Client</a></h3>
<p>Sending a push notification</p>
<ul>
<li>
<p>When sending a push notification,
only the <code>installation_id</code> for the devices targeted by the message SHOULD be used.</p>
</li>
<li>
<p>If a message is for all the user devices,
all the <code>installation_id</code> known to the client MAY be used.</p>
</li>
<li>
<p>The number of devices MAY be capped in order to reduce resource consumption.</p>
</li>
<li>
<p>At least 3 devices SHOULD be targeted, ordered by last activity.</p>
</li>
<li>
<p>For any device that a token is available, or that
a token is successfully queried,
a push notification message SHOULD be sent to the corresponding
push notification server.</p>
</li>
</ul>
<pre><code class="language-protobuf">message PushNotification {
  string access_token = 1;
  string chat_id = 2;
  bytes public_key = 3;
  string installation_id = 4;
  bytes message = 5;
  PushNotificationType type = 6;
  enum PushNotificationType {
    UNKNOWN_PUSH_NOTIFICATION_TYPE = 0;
    MESSAGE = 1;
    MENTION = 2;
  }
  bytes author = 7;
}

message PushNotificationRequest {
  repeated PushNotification requests = 1;
  bytes message_id = 2;
}

</code></pre>
<h4 id="handle-notification-request"><a class="header" href="#handle-notification-request">Handle Notification Request</a></h4>
<ul>
<li>
<p>A <code>PushNotificationRequest</code> message MUST be wrapped in a
<a href="status/71/../62/payloads.html"><code>ApplicationMetadataMessage</code></a> with type set to <code>PUSH_NOTIFICATION_REQUEST</code>.</p>
</li>
<li>
<p>Where <code>message</code> is the encrypted payload of the message and
<code>chat_id</code> is the <code>SHAKE-256</code> of the <code>chat_id</code>.
<code>message_id</code> is the id of the message,
<code>author</code> is the <code>SHAKE-256</code> of the public key of the sender.</p>
</li>
<li>
<p>If multiple server are available for a given push notification,
only one notification MUST be sent.</p>
</li>
<li>
<p>If no response is received a client SHOULD wait at least 3 seconds,
after which the request MAY be retried against a different server.</p>
</li>
<li>
<p>This message SHOULD be sent using an ephemeral key.</p>
</li>
</ul>
<p>On receiving the message, the push notification server MUST validate the access token.
If the access token is valid, a notification MUST be sent to the
<a href="https://github.com/appleboy/gorush">gorush</a> instance with the following data:</p>
<pre><code class="language-yaml">{
  "notifications": [
    {
      "tokens": ["token_a", "token_b"],
      "platform": 1,
      "message": "You have a new message",
      "data": {
        "chat_id": chat_id,
        "message": message,
        "installation_ids": [installation_id_1, installation_id_2]
      }
    }
  ]
}

</code></pre>
<p>Where platform is 1 for iOS and 2 for Firebase, according to the <a href="https://github.com/appleboy/gorush">gorush documentation</a>.</p>
<p>A server MUST return a response message:</p>
<pre><code class="language-protobuf">message PushNotificationReport {
  bool success = 1;
  ErrorType error = 2;
  enum ErrorType {
    UNKNOWN_ERROR_TYPE = 0;
    WRONG_TOKEN = 1;
    INTERNAL_ERROR = 2;
    NOT_REGISTERED = 3;
  }
  bytes public_key = 3;
  string installation_id = 4;
}

</code></pre>
<pre><code class="language-protobuf">message PushNotificationResponse {
  bytes message_id = 1;
  repeated PushNotificationReport reports = 2;
}

</code></pre>
<p>Where <code>message_id</code> is the <code>message_id</code> sent by the client.</p>
<h4 id="handle-notification-response"><a class="header" href="#handle-notification-response">Handle Notification Response</a></h4>
<ul>
<li>
<p>A <code>PushNotificationResponse</code> message MUST be wrapped in a
<a href="status/71/../62/payloads.html"><code>ApplicationMetadataMessage</code></a> with type set to <code>PUSH_NOTIFICATION_RESPONSE</code>.</p>
</li>
<li>
<p>The response MUST be sent on the
<a href="status/71/../../waku/standards/application/54/x3dh-sessions.html">partitioned topic</a>
of the sender and
MUST not be encrypted using the
<a href="status/71/../../waku/standards/application/53/x3dh.html">secure transport</a>
to facilitate the usage of ephemeral keys.</p>
</li>
<li>
<p>If the request is accepted <code>success</code> MUST be set to <code>true</code>.
Otherwise <code>success</code> MUST be set to <code>false</code>.</p>
</li>
<li>
<p>If <code>error</code> is <code>BAD_TOKEN</code> the client MAY query again the server for the token and
retry the request.</p>
</li>
<li>
<p>If <code>error</code> is <code>INTERNAL_ERROR</code> the client MAY retry the request.</p>
</li>
</ul>
<h3 id="protobuf-description"><a class="header" href="#protobuf-description">Protobuf Description</a></h3>
<h4 id="pushnotificationregistration"><a class="header" href="#pushnotificationregistration">PushNotificationRegistration</a></h4>
<p><code>token_type</code>: the type of token. Currently supported is <code>APN_TOKEN</code> for Apple Push.</p>
<p><code>device_token</code>: the actual push notification token sent by <code>Firebase</code> or
<code>APN</code> and <code>FIREBASE_TOKEN</code> for firebase.</p>
<p><code>installation_id</code>: the <code>installation_id</code> of the device.</p>
<p><code>access_token</code>: the access token that will be given to clients to send push notifications.</p>
<p><code>enabled</code>: whether the device wants to be sent push notifications.</p>
<p><code>version</code>: a monotonically increasing number identifying the current <code>PushNotificationRegistration</code>.
Any time anything is changed in the record it MUST be increased by the client,
otherwise the request will not be accepted.</p>
<p><code>allowed_key_list</code>: a list of <code>access_token</code> encrypted with the AES key
generated by Diffie–Hellman between the publisher and the allowed contact.</p>
<p><code>blocked_chat_list</code>: a list of <code>SHA2-256</code> hashes of chat ids.
Any chat id in this list will not trigger a notification.</p>
<p><code>unregister</code>: whether the account should be unregistered.</p>
<p><code>grant</code>: the grant for this specific server.</p>
<p><code>allow_from_contacts_only</code>: whether the client only wants
push notifications from contacts.</p>
<p><code>apn_topic</code>: the APN topic for the push notification.</p>
<p><code>block_mentions</code>: whether the client does not want to be notified on mentions.</p>
<p><code>allowed_mentions_chat_list</code>: a list of SHA2-256 hashes of chat ids
where we want to receive mentions.</p>
<p>DATA DISCLOSED</p>
<ul>
<li>
<p>Type of device owned by a given user.</p>
</li>
<li>
<p>The <code>FIREBASE</code> or <code>APN</code> push notification token,</p>
</li>
<li>
<p>Hash of the <code>chat_id</code> a user is not interested in for notifications,</p>
</li>
<li>
<p>The number of times a push notification record has been modified by the user,</p>
</li>
<li>
<p>The number of contacts a client has, in case <code>allowed_key_list</code> is set.</p>
</li>
</ul>
<h4 id="pushnotificationregistrationresponse"><a class="header" href="#pushnotificationregistrationresponse">PushNotificationRegistrationResponse</a></h4>
<p><code>success</code>: whether the registration was successful</p>
<p><code>error</code>: the error type, if any</p>
<p><code>request_id</code>: the <code>SHAKE-256</code> hash of the <code>signature</code> of the request</p>
<p><code>preferences</code>: the server stored preferences in case of an error</p>
<h4 id="contactcodeadvertisement"><a class="header" href="#contactcodeadvertisement">ContactCodeAdvertisement</a></h4>
<p><code>push_notification_info</code>: the information for each device advertised</p>
<p>DATA DISCLOSED</p>
<ul>
<li>The chat key of the sender</li>
</ul>
<h4 id="pushnotificationquery"><a class="header" href="#pushnotificationquery">PushNotificationQuery</a></h4>
<p><code>public_keys</code>: the <code>SHAKE-256</code> of the public keys the client is interested in</p>
<p>DATA DISCLOSED</p>
<ul>
<li>The hash of the public keys the client is interested in</li>
</ul>
<h4 id="pushnotificationqueryinfo"><a class="header" href="#pushnotificationqueryinfo">PushNotificationQueryInfo</a></h4>
<p><code>access_token</code>: the access token used to send a push notification</p>
<p><code>installation_id</code>: the <code>installation_id</code> of the device associated with the <code>access_token</code>.</p>
<p><code>public_key</code>: the <code>SHAKE-256</code> of the public key associated with this <code>access_token</code>
and <code>installation_id</code>.</p>
<p><code>allowed_key_list</code>: a list of encrypted access tokens to be returned
to the client in case there’s any filtering on public keys in place.</p>
<p><code>grant</code>: the grant used to register with this server.</p>
<p><code>version</code>: the version of the registration on the server.</p>
<p><code>server_public_key</code>: the compressed public key of the server.</p>
<h4 id="pushnotificationqueryresponse"><a class="header" href="#pushnotificationqueryresponse">PushNotificationQueryResponse</a></h4>
<p><code>info</code>: a list of <code>PushNotificationQueryInfo</code>.</p>
<p><code>message_id</code>: the message id of the <code>PushNotificationQueryInfo</code>
the server is replying to.</p>
<p><code>success</code>: whether the query was successful.</p>
<h4 id="pushnotification"><a class="header" href="#pushnotification">PushNotification</a></h4>
<p><code>access_token</code>: the access token used to send a push notification.
<code>chat_id</code>: the <code>SHAKE-256</code> of the <code>chat_id</code>.
<code>public_key</code>: the <code>SHAKE-256</code> of the compressed public key of the receiving client.
<code>installation_id</code>: the <code>installation_id</code> of the receiving client.
<code>message</code>: the encrypted message that is being notified on.
<code>type</code>: the type of the push notification, either <code>MESSAGE</code> or <code>MENTION</code>
<code>author</code>: the <code>SHAKE-256</code> of the public key of the sender</p>
<p>Data disclosed</p>
<ul>
<li>
<p>The <code>SHAKE-256</code> hash of the <code>chat_id</code> the notification is to be sent for</p>
</li>
<li>
<p>The cypher text of the message</p>
</li>
<li>
<p>The <code>SHAKE-256</code> hash of the public key of the sender</p>
</li>
<li>
<p>The type of notification</p>
</li>
</ul>
<h4 id="pushnotificationrequest"><a class="header" href="#pushnotificationrequest">PushNotificationRequest</a></h4>
<p><code>requests</code>: a list of PushNotification
<code>message_id</code>: the <a href="status/71/../62/payloads.html">Status message id</a></p>
<p>Data disclosed</p>
<ul>
<li>The status <code>message_id</code> for which the notification is for</li>
</ul>
<h4 id="pushnotificationresponse"><a class="header" href="#pushnotificationresponse">PushNotificationResponse</a></h4>
<p><code>message_id</code>: the <code>message_id</code> being notified on.
<code>reports</code>: a list of <code>PushNotificationReport</code></p>
<h4 id="pushnotificationreport"><a class="header" href="#pushnotificationreport">PushNotificationReport</a></h4>
<p><code>success</code>: whether the push notification was successful.
<code>error</code>: the type of the error in case of failure.
<code>public_key</code>: the public key of the user being notified.
<code>installation_id</code>: the <code>installation_id</code> of the user being notified.</p>
<h3 id="anonymous-mode"><a class="header" href="#anonymous-mode">Anonymous Mode</a></h3>
<p>In order to preserve privacy, the client MAY provide anonymous mode of operations
to propagate information about the user.
A client in anonymous mode can register with the server
using a key that is different from their chat key.
This will hide their real chat key. This public key is effectively a secret and
SHOULD only be disclosed to clients approved to notify a user.</p>
<ul>
<li>
<p>A client MAY advertise the access token on the
<a href="status/71/../../waku/standards/application/53/x3dh.html">contact-code topic</a>
of the key generated.</p>
</li>
<li>
<p>A client MAY share their public key contact updates in the
<a href="https://developers.google.com/protocol-buffers/">protobuf record</a>.</p>
</li>
<li>
<p>A client receiving a push notification public key
SHOULD listen to the contact code topic of the push notification public key for updates.</p>
</li>
</ul>
<p>The method described above effectively does not share the identity of the sender
nor the receiver to the server, but
MAY result in missing push notifications
as the propagation of the secret is left to the client.
This can be mitigated by <a href="status/71/../62/payloads.html">device syncing</a>,
but not completely addressed.</p>
<h2 id="securityprivacy-considerations-3"><a class="header" href="#securityprivacy-considerations-3">Security/Privacy Considerations</a></h2>
<p>If anonymous mode is not used,
when registering with a push notification service a client will disclose:</p>
<ul>
<li>
<p>The devices that will receive notifications.</p>
</li>
<li>
<p>The chat key.</p>
</li>
</ul>
<p>A client MAY disclose:</p>
<ul>
<li>The hash of the <code>chat_id</code> they want to filter out.</li>
</ul>
<p>When running in anonymous mode, the client’s chat key is not disclosed.</p>
<p>When querying a push notification server a client will disclose:</p>
<ul>
<li>That it is interested in sending push notification to another client,
but querying client’s chat key is not disclosed.</li>
</ul>
<p>When sending a push notification a client will disclose:</p>
<ul>
<li>The <code>shake-256</code> of the <code>chat_id</code>.</li>
</ul>
<h2 id="copyright-64"><a class="header" href="#copyright-64">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-51"><a class="header" href="#references-51">References</a></h2>
<ol>
<li><a href="https://github.com/status-im/specs/blob/master/docs/raw/push-notification-server.md">PUSH-NOTIFICATION-SERVER, Initial Specification</a></li>
<li><a href="https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/APNSOverview.html#//apple_ref/doc/uid/TP40008194-CH8-SW1">Push Notification, Apple Developer</a></li>
<li><a href="https://firebase.google.com">Firebase</a></li>
<li><a href="status/71/../../waku/standards/core/13/store.html">13/WAKU2-STORE</a></li>
<li><a href="https://github.com/appleboy/gorush">gorush</a></li>
<li><a href="status/71/../../waku/standards/application/54/x3dh-sessions.html">54/WAKU2-X3DH-SESSIONS</a></li>
<li><a href="status/71/../62/payloads.html">62/PAYLOAD</a></li>
<li><a href="https://nvlpubs.nist.gov/nistpubs/fips/nist.fips.202.pdf">SHAKE-256</a></li>
<li><a href="https://developers.google.com/protocol-buffers">Protocol Buffers</a></li>
<li><a href="status/71/../../waku/standards/application/53/x3dh.html">53/WAKU2-X3DH</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="status-raw-specifications"><a class="header" href="#status-raw-specifications">Status Raw Specifications</a></h1>
<p>Early-stage Status specifications that precede draft or stable status.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="status-simple-scaling"><a class="header" href="#status-simple-scaling">STATUS-SIMPLE-SCALING</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Status Simple Scaling</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>Informational</td></tr>
<tr><th>Editor</th><td>Daniel Kaiser &lt;danielkaiser@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Alvaro Revuelta &lt;alrevuelta@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-69"><a class="header" href="#timeline-69">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/raw/simple-scaling.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/raw/simple-scaling.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-11-20</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/ff87c84dc71d4f933bab188993914069fea12baa/status/raw/simple-scaling.md"><code>ff87c84</code></a> — Update Waku Links (#104)</li>
<li><strong>2024-09-17</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/9b5e2194cf2a2464740de6798fddd21a24b2dc7e/status/raw/simple-scaling.md"><code>9b5e219</code></a> — Update simple-scaling (#93)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/status/raw/simple-scaling.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-06-14</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/a189a72146978307ede84708d89c580dab5bc142/status/raw/simple-scaling.md"><code>a189a72</code></a> — fix: messageHash in 57 (#22)</li>
<li><strong>2024-03-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/61a39e26d7b8a1ced4c9e56b971a20c72679556d/status/raw/simple-scaling.md"><code>61a39e2</code></a> — Update and rename vac/raw/57/simple-scaling.md to status/raw/simple-scaling.md</li>
<li><strong>2024-02-28</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/18a16ae6954f49fba0046d8e418f7bc55ae4c7aa/vac/raw/57/simple-scaling.md"><code>18a16ae</code></a> — Update and rename simple-scaling.md to simple-scaling.md</li>
<li><strong>2024-02-12</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/f19a136ea6c0ae18c4a8afaed88a81b0aaa30262/status/raw/57/simple-scaling.md"><code>f19a136</code></a> — Update and rename status/57/simple-scaling.md to status/raw/57/simple-scaling.md</li>
<li><strong>2024-02-07</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/27fae4fe9168cb2318f54ee94852150019be5652/status/57/simple-scaling.md"><code>27fae4f</code></a> — Update simple-scaling.md</li>
<li><strong>2024-02-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/fa8c750dd762ccef1cc6c8d775f57a57a6f9bd21/status/57/simple-scaling.md"><code>fa8c750</code></a> — Update simple-scaling.md</li>
<li><strong>2024-02-01</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/59190400c67b7a2d9b7bfa1ab5504eabb3637317/status/57/simple-scaling.md"><code>5919040</code></a> — Update simple-scaling.md</li>
<li><strong>2024-01-27</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/f7a51b9fdfc3155fa09795cf6902f5d4d82f83b7/status/57/simple-scaling.md"><code>f7a51b9</code></a> — Create simple-scaling.md</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-44"><a class="header" href="#abstract-44">Abstract</a></h2>
<p>This document describes how to scale
<a href="status/raw/../56/communities.html">56/STATUS-COMMUNITIES</a> as well as <a href="status/raw/../55/1to1-chat.html">55/STATUS-1TO1-CHAT</a>
using Waku v2 protocol and components.
It also adds a few new aspects,
where more sophisticated components are not yet researched and evaluated.</p>
<blockquote>
<p><em>Note:</em> (Parts of) this RFC will be deprecated in the future
as we continue research to scale specific components
in a way that aligns better with our principles of decentralization and
protecting anonymity.
This document informs about scaling at the current stage of research and
shows it is practically possible.
Practical feasibility is also a core goal for us.
We believe in incremental improvement, i.e.
having a working decentralized scaling solution with trade-offs
is better than a fully centralized solution.</p>
</blockquote>
<h2 id="background-and-motivation-2"><a class="header" href="#background-and-motivation-2">Background and Motivation</a></h2>
<p><a href="status/raw/../56/communities.html">56/STATUS-COMMUNITIES</a> as well as
<a href="status/raw/../55/1to1-chat.html">55/STATUS-1TO1-CHAT</a> use Waku v2 protocols.
Both use Waku content topics
(see <a href="status/raw/../../waku/informational/23/topics.html">23/WAKU2-TOPICS</a>)
for content based filtering.</p>
<p>Waku v2 currently has scaling limitations in two dimensions:</p>
<ol>
<li>
<p>Messages that are part of a specific content topic
have to be disseminated in a single mesh network (i.e. pubsub topic).
This limits scaling the number of messages disseminated in a specific content topic,
and by extension, the number of active nodes that are part of this content topic.</p>
</li>
<li>
<p>Scaling a large set of content topics requires distributing these over several
mesh networks (which this document refers to as pubsub topic shards).</p>
</li>
</ol>
<p>This document focuses on the second scaling dimension.
With the scaling solutions discussed in this document,
each content topics can have a large set of active users,
but still has to fit in a single pubsub mesh.</p>
<blockquote>
<p><em>Note:</em> While it is possible to use the same content topic name on several shards,
each node that is interested in this content topic
has to be subscribed to all respective shards, which does not scale.
Splitting content topics in a more sophisticated and
efficient way will be part of a future document.</p>
</blockquote>
<h2 id="relay-shards"><a class="header" href="#relay-shards">Relay Shards</a></h2>
<p>Sharding the <a href="status/raw/../../waku/standards/core/11/relay.html">11/WAKU2-RELAY</a>
network is an integral part of scaling the Status app.</p>
<p><a href="https://github.com/waku-org/specs/blob/master/standards/core/relay-sharding.md">WAKU2-RELAY-SHARDING</a>
specifies shards clusters, which are sets of <code>1024</code> shards
(separate pubsub mesh networks).
Content topics specified by application protocols can be distributed over these shards.
The Status app protocols are assigned to shard cluster <code>16</code>,
as defined in <a href="https://github.com/waku-org/specs/blob/master/informational/relay-static-shard-alloc.md">WAKU2-RELAY-STATIC-SHARD-ALLOC</a>.</p>
<p><a href="https://github.com/waku-org/specs/blob/master/standards/core/relay-sharding.md">WAKU2-RELAY-SHARDING</a>
specifies three sharding methods.
This document uses <em>static sharding</em>,
which leaves the distribution of content topics to application protocols,
but takes care of shard discovery.</p>
<p>The 1024 shards within the main Status shard cluster are allocated as follows.</p>
<h3 id="shard-allocation"><a class="header" href="#shard-allocation">Shard Allocation</a></h3>
<div class="table-wrapper"><table><thead><tr><th>shard index</th><th>usage</th></tr></thead><tbody>
<tr><td>0 - 15</td><td>reserved</td></tr>
<tr><td>16 - 127</td><td>specific (large) communities</td></tr>
<tr><td>128 - 767</td><td>communities</td></tr>
<tr><td>768 - 895</td><td>1:1 chat</td></tr>
<tr><td>896 - 1023</td><td>media and control msgs</td></tr>
</tbody></table>
</div>
<p>Shard indices are mapped to pubsub topic names as follows (specified in <a href="https://github.com/waku-org/specs/blob/master/standards/core/relay-sharding.md">WAKU2-RELAY-SHARDING</a>).</p>
<p><code>/waku/2/rs/&lt;cluster_id&gt;/&lt;shard_number&gt;</code></p>
<p>an example for the shard with index <code>18</code> in the Status shard cluster:</p>
<p><code>/waku/2/rs/16/18</code></p>
<p>In other words, the mesh network with the pubsub topic name <code>/waku/2/rs/16/18</code>,
carries messages associated with shard <code>18</code> in the Status shard cluster.</p>
<h4 id="implementation-suggestion"><a class="header" href="#implementation-suggestion">Implementation Suggestion</a></h4>
<p>The Waku implementation should offer an interface that
allows Status nodes to subscribe to Status specific content topics like</p>
<pre><code class="language-yaml">subscribe("/status/xyz", 16, 18)
</code></pre>
<p>The shard cluster index <code>16</code> can be kept in the Status app configuration,
so that Status nodes can simply use</p>
<pre><code class="language-yaml">subscribe("/status/xyz", 18)
</code></pre>
<p>which means: connect to the <code>"status/xyz"</code> content topic on shard <code>18</code>
within the Status shard cluster.</p>
<h3 id="status-communities"><a class="header" href="#status-communities">Status Communities</a></h3>
<p>In order to associate a community with a shard,
the community description protobuf is extended by the field
<code>uint16 relay_shard_index = 15</code>:</p>
<pre><code class="language-protobuf">
syntax = "proto3";

message CommunityDescription {
  // The Lamport timestamp of the message
  uint64 clock = 1;
  // A mapping of members in the community to their roles
  map&lt;string,CommunityMember&gt; members = 2;
  // The permissions of the Community
  CommunityPermissions permissions = 3;
  // The metadata of the Community
  ChatIdentity identity = 5;
  // A mapping of chats to their details
  map&lt;string,CommunityChat&gt; chats = 6;
  // A list of banned members
  repeated string ban_list = 7;
  // A mapping of categories to their details
  map&lt;string,CommunityCategory&gt; categories = 8;
  // The admin settings of the Community
  CommunityAdminSettings admin_settings = 10;
  // If the community is encrypted
  bool encrypted = 13;
  // The list of tags
  repeated string tags = 14;
  // index of the community's shard within the Status shard cluster
  uint16 relay_shard_index = 15
}
</code></pre>
<blockquote>
<p><em>Note</em>: Currently, Status app has allocated shared cluster <code>16</code> in <a href="https://github.com/waku-org/specs/blob/master/informational/relay-static-shard-alloc.md">WAKU2-RELAY-STATIC-SHARD-ALLOC</a>.
Status app could allocate more shard clusters, for instance to establish a test net.
We could add the shard cluster index to the community description as well.
The recommendation for now,
is to keep it as a configuration option of the Status app.
<em>Note</em>: Once this RFC moves forward,
the new community description protobuf fields should be mentioned in <a href="status/raw/../56/communities.html">56/STATUS-COMMUNITIES</a>.</p>
</blockquote>
<p>Status communities can be mapped to shards in two ways: static, and owner-based.</p>
<h4 id="static-mapping"><a class="header" href="#static-mapping">Static Mapping</a></h4>
<p>With static mapping,
communities are assigned a specific shard index within the Status shard cluster.
This mapping is similar in nature to the shard cluster allocation in <a href="https://github.com/waku-org/specs/blob/master/informational/relay-static-shard-alloc.md">WAKU2-RELAY-STATIC-SHARD-ALLOC</a>.
Shard indices allocated in that way are in the range <code>16 - 127</code>.
The Status CC community uses index <code>16</code>
(not to confuse with shard cluster index <code>16</code>, which is the Status shard cluster).</p>
<h4 id="owner-mapping"><a class="header" href="#owner-mapping">Owner Mapping</a></h4>
<blockquote>
<p><em>Note</em>: This way of mapping will be specified post-MVP.</p>
</blockquote>
<p>Community owners can choose to map their communities to any shard within
the index range <code>128 - 767</code>.</p>
<h3 id="11-chat"><a class="header" href="#11-chat">1:1 Chat</a></h3>
<p><a href="status/raw/../55/1to1-chat.html">55/STATUS-1TO1-CHAT</a>
uses partitioned topics to map 1:1 chats to a set of 5000 content topics.
This document extends this mapping to 8192 content topics that are, in turn,
mapped to 128 shards in the index range of <code>768 - 895</code>.</p>
<pre><code class="language-js">contentPartitionsNum = 8192
contentPartition = mod(publicKey, contentPartitionsNum)
partitionContentTopic = "contact-discovery-" + contentPartition

partitionContentTopic = keccak256(partitionContentTopic)

shardNum = 128
shardIndex = 768 + mod(publicKey, shardNum)

</code></pre>
<h2 id="infrastructure-nodes"><a class="header" href="#infrastructure-nodes">Infrastructure Nodes</a></h2>
<p>As described in <a href="status/raw/../../waku/informational/30/adaptive-nodes.html">30/ADAPTIVE-NODES</a>,
Waku supports a continuum of node types with respect to available resources.
Infrastructure nodes are powerful nodes that have a high bandwidth connection and
a high up-time.</p>
<p>This document, which informs about simple ways of scaling Status over Waku,
assumes the presence of a set of such infrastructure nodes in each shard.
Infrastructure nodes are especially important for
providing connectivity in the roll-out phase.</p>
<p>Infrastructure nodes are not limited to Status fleets, or
nodes run by community owners.
Anybody can run infrastructure nodes.</p>
<h3 id="statically-mapped-communities"><a class="header" href="#statically-mapped-communities">Statically-Mapped Communities</a></h3>
<p>Infrastructure nodes are provided by the community owner,
or by members of the respective community.</p>
<h3 id="owner-mapped-communities"><a class="header" href="#owner-mapped-communities">Owner-Mapped Communities</a></h3>
<p>Infrastructure nodes are part of a subset of the shards in the range <code>128 - 767</code>.
Recommendations on choosing this subset will be added
in a future version of this document.</p>
<p>Status fleet nodes make up a part of these infrastructure nodes.</p>
<h3 id="11-chat-1"><a class="header" href="#11-chat-1">1:1 chat</a></h3>
<p>Infrastructure nodes are part of a subset of the shards in the range <code>768 - 985</code>
(similar to owner-mapped communities).
Recommendations on choosing this subset will be added
in a future version of this document.</p>
<p>Desktop clients can choose to only use filter and lightpush.</p>
<blockquote>
<p><em>Note</em>: Discussion: I'd suggest to set this as the default for the MVP.
The load on infrastructure nodes would not be higher, because
they have to receive and relay each message anyways.
This comes as a trade-off to anonymity and decentralization,
but can significantly improve scaling.
We still have k-anonymity because
several chat pairs are mapped into one content topic.
We could improve on this in the future, and research the applicability of PIR
(private information retrieval) techniques in the future.</p>
</blockquote>
<h2 id="infrastructure-shards"><a class="header" href="#infrastructure-shards">Infrastructure Shards</a></h2>
<p>Waku messages are typically relayed in larger mesh networks
comprised of nodes with varying resource profiles
(see <a href="status/raw/../../waku/informational/30/adaptive-nodes.html">30/ADAPTIVE-NODES</a>).
To maximise scaling, relaying of specific message types can be dedicated to shards
where only infrastructure nodes with very strong resource profiles relay messages.
This comes as a trade-off to decentralization.</p>
<h2 id="control-message-shards"><a class="header" href="#control-message-shards">Control Message Shards</a></h2>
<p>To get the maximum scaling for select large communities for the Status scaling MVP,
specific control messages that cause significant load
(at a high user number) SHOULD be moved to a separate control message shard.
These control messages comprise:</p>
<ul>
<li>community description</li>
<li>membership update</li>
<li>backup</li>
<li>community request to join response</li>
<li>sync profile picture</li>
</ul>
<p>The relay functionality of control messages shards SHOULD
be provided by infrastructure nodes.
Desktop clients should use light protocols as the default for control message shards.
Strong Desktop clients MAY opt in to support the relay network.</p>
<p>Each large community (in the index range of <code>16 - 127</code>)
can get its dedicated control message shard
(in the index range <code>896 - 1023</code>) if deemed necessary.
The Status CC community uses shard <code>896</code> as its control message shard.
This comes with trade-offs to decentralization and anonymity
(see <em>Security Considerations</em> section).</p>
<h2 id="media-shards"><a class="header" href="#media-shards">Media Shards</a></h2>
<p>Similar to control messages, media-heavy communities should use separate media shards
(in the index range <code>896 - 1023</code>) for disseminating messages with large media data.
The Status CC community uses shard <code>897</code> as its media shard.</p>
<h2 id="infrastructure-focused-community"><a class="header" href="#infrastructure-focused-community">Infrastructure-focused Community</a></h2>
<p>Large communities MAY choose to mainly rely on infrastructure nodes
for <em>all</em> message transfers (not limited to control, and media messages).
Desktop clients of such communities should use light protocols as the default.
Strong Desktop clients MAY opt in to support the relay network.</p>
<blockquote>
<p><em>Note</em>: This is not planned for the MVP.</p>
</blockquote>
<h2 id="light-protocols"><a class="header" href="#light-protocols">Light Protocols</a></h2>
<p>Light protocols may be used to save bandwidth,
at the (global) cost of not contributing to the network.
Using light protocols is RECOMMENDED for resource restricted nodes,
e.g. browsers,
and devices that (temporarily)
have a low bandwidth connection or a connection with usage-based billing.</p>
<p>Light protocols comprise</p>
<ul>
<li><a href="status/raw/../../waku/standards/core/19/lightpush.html">19/WAKU2-LIGHTPUSH</a> for sending messages</li>
<li><a href="status/raw/../../waku/standards/core/12/filter.html">12/WAKU2-FILTER</a>
for requesting messages with specific attributes</li>
<li><a href="https://github.com/waku-org/specs/blob/master/standards/core/peer-exchange.md">WAKU2-PEER-EXCHANGE</a>
for discovering peers</li>
</ul>
<h2 id="waku-archive"><a class="header" href="#waku-archive">Waku Archive</a></h2>
<p>Archive nodes are Waku nodes that offer the Waku archive service via
the Waku store protocol (<a href="status/raw/../../waku/standards/core/13/store.html">13/WAKU2-STORE</a>).
They are part of a set of shards and store all messages disseminated in these shards.
Nodes can request history messages via the <a href="status/raw/../../waku/standards/core/13/store.html">13/WAKU2-STORE</a>.</p>
<p>The store service is not limited to a Status fleet.
Anybody can run a Waku Archive node in the Status shards.</p>
<blockquote>
<p><em>Note</em>: There is no specification for discovering archive nodes
associated with specific shards yet.
Nodes expect archive nodes to store all messages, regardless of shard association.</p>
</blockquote>
<p>The recommendation for the allocation of archive nodes to shards is similar to the
allocation of infrastructure nodes to shards described above.
In fact, the archive service can be offered by infrastructure nodes.</p>
<h2 id="discovery"><a class="header" href="#discovery">Discovery</a></h2>
<p>Shard discovery is covered by <a href="https://github.com/waku-org/specs/blob/master/standards/core/relay-sharding.md">WAKU2-RELAY-SHARDING</a>.
This allows the Status app to abstract from the discovery process and
simply address shards by their index.</p>
<h3 id="libp2p-rendezvous-and-circuit-relay"><a class="header" href="#libp2p-rendezvous-and-circuit-relay">Libp2p Rendezvous and Circuit-Relay</a></h3>
<p>To make nodes behind restrictive NATs discoverable,
this document suggests using <a href="https://github.com/libp2p/specs/blob/master/rendezvous/README.md">libp2p rendezvous</a>.
Nodes can check whether they are behind a restrictive NAT using the
<a href="https://github.com/libp2p/specs/blob/master/autonat/README.md">libp2p AutoNAT protocol</a>.</p>
<blockquote>
<p><em>Note:</em> The following will move into <a href="https://github.com/waku-org/specs/blob/master/standards/core/relay-sharding.md">WAKU2-RELAY-SHARDING</a>,
or <a href="status/raw/../../waku/standards/core/33/discv5.html">33/WAKU2-DISCV5</a>:
Nodes behind restrictive NATs SHOULD not announce their publicly unreachable address
via <a href="status/raw/../../waku/standards/core/33/discv5.html">33/WAKU2-DISCV5</a> discovery.</p>
</blockquote>
<p>It is RECOMMENDED that nodes that are part of the relay network also
act as rendezvous points.
This includes accepting register queries from peers,
as well as answering rendezvous discover queries.
Nodes MAY opt-out of the rendezvous functionality.</p>
<p>To allow nodes to initiate connections to peers behind restrictive NATs
(after discovery via rendezvous),
it is RECOMMENDED that nodes that are part of the Waku relay network also offer
<a href="https://github.com/libp2p/specs/blob/6634ca7abb2f955645243d48d1cd2fd02a8e8880/relay/circuit-v2.md">libp2p circuit relay</a>
functionality.</p>
<p>To minimize the load on circuit-relay nodes, nodes SHOULD</p>
<ol>
<li>make use of the <a href="https://github.com/libp2p/specs/blob/6634ca7abb2f955645243d48d1cd2fd02a8e8880/relay/circuit-v2.md#reservation">limiting</a>
functionality offered by the libp2p circuit relay protocols, and</li>
<li>use <a href="https://github.com/libp2p/specs/blob/master/relay/DCUtR.md">DCUtR</a>
to upgrade to a direct connection.</li>
</ol>
<p>Nodes that do not announce themselves at all and only plan to use light protocols,
MAY use rendezvous discovery instead of or along-side <a href="https://github.com/waku-org/specs/blob/master/standards/core/peer-exchange.md">WAKU2-PEER-EXCHANGE</a>.
For these nodes, rendezvous and
<a href="https://github.com/waku-org/specs/blob/master/standards/core/peer-exchange.md">WAKU2-PEER-EXCHANGE</a>
offer the same functionality,
but return node sets sampled in different ways.
Using both can help increasing connectivity.</p>
<p>Nodes that are not behind restrictive NATs MAY register at rendezvous points, too;
this helps increasing discoverability, and by extension connectivity.
Such nodes SHOULD, however, not register at circuit relays.</p>
<h3 id="announcing-shard-participation"><a class="header" href="#announcing-shard-participation">Announcing Shard Participation</a></h3>
<p>Registering a namespace via <a href="https://github.com/libp2p/specs/blob/master/rendezvous/README.md#interaction">lib-p2p rendezvous</a>
is done via a register query:</p>
<pre><code class="language-rs">REGISTER{my-app, {QmA, AddrA}}
</code></pre>
<p>The app name, <code>my-app</code> contains the encoding of a single shard in string form:</p>
<pre><code class="language-rs">"rs/"| to_string(&lt;2-byte shard cluster index&gt;) | "/" | to_string(&lt;2-byte shard index&gt;)
</code></pre>
<p>The string conversion SHOULD remove leading zeros.</p>
<blockquote>
<p><em>Note:</em> Since the <a href="https://github.com/libp2p/specs/blob/master/rendezvous/README.md#protobuf">ns</a>
field is of type string, a more efficient byte encoding is not utilized.</p>
</blockquote>
<p>Registering shard 2 in the Status shard cluster (with shard cluster index 16,
see <a href="https://github.com/waku-org/specs/blob/master/informational/relay-static-shard-alloc.md">WAKU2-RELAY-STATIC-SHARD-ALLOC</a>,
the register query would look like</p>
<pre><code class="language-rs">REGISTER{"rs/16/2", {QmA, AddrA}}
</code></pre>
<p>Participation in further shards is registered with further queries;
one register query per shard.</p>
<p>A discovery query for nodes that are part of this shard would look like</p>
<pre><code class="language-rs">DISCOVER{ns: "rs/16/2"}
</code></pre>
<h2 id="dos-protection-1"><a class="header" href="#dos-protection-1">DoS Protection</a></h2>
<p>Hereunder we describe the "opt-in message signing for DoS prevention" solution,
designed <em>ad hoc</em> for Status MVP.</p>
<p>Since publishing messages to pubsub topics has no limits,
anyone can publish messages at a very high rate and DoS the network.
This would elevate the bandwidth consumption of all nodes subscribed
to said pubsub topic, making it prohibitive (in terms of bandwidth)
to be subscribed to it.
In order to scale, we need some mechanism to prevent this from happening,
otherwise all scaling efforts will be in vain.
Since RLN is not ready yet,
hereunder we describe a simpler approach designed <em>ad hoc</em> for Status use case,
feasible to implement for the MVP and
that validates some of the ideas that will evolve to solutions such as RLN.</p>
<p>With this approach, certain pubsub topics can be optionally configured
to only accept messages signed with a given key,
that only trusted entities know.
This key can be pre-shared among a set of participants,
that are trusted to make fair usage of the network,
publishing messages at a reasonable rate/size.
Note that this key can be shared/reused among multiple participants, and
only one key is whitelisted per pubsub topic.
This is an opt-in solution that operators can choose to deploy in their shards
(i.e. pubsub topics), but it's not enforced in the default one.
Operators can freely choose how they want to generate, and
distribute the public keys.
It's also their responsibility to handle the private key,
sharing it with only trusted parties and keeping proper custody of it.</p>
<p>The following concepts are introduced:</p>
<ul>
<li><code>private-key-topic</code>: A private key of 32 bytes,
that allows the holder to sign messages and it's mapped to a <code>protected-pubsub-topic</code>.</li>
<li><code>app-message-hash</code>: Application <code>WakuMessage</code> hash,
calculated as <code>sha256(concat(pubsubTopic, payload, contentTopic, timestamp, ephemeral))</code>
with all elements in bytes.</li>
<li><code>message-signature</code>: ECDSA signature of <code>application-message-hash</code>
using a given <code>private-key-topic</code>, 64 bytes.</li>
<li><code>public-key-topic</code>: The equivalent public key of <code>private-key-topic</code>.</li>
<li><code>protected-pubsub-topic</code>: Pubsub topic that only accepts messages
that were signed with <code>private-key-topic</code>,
where <code>verify(message-signature, app-message-hash, public-key-topic)</code>
is only correct if the <code>message-signature</code> was produced by <code>private-key-topic</code>.
See ECDSA signature verification algorithm.</li>
</ul>
<p>This solution introduces two roles:</p>
<ul>
<li>Publisher: A node that knows the <code>private-key-topic</code> associated to <code>public-key-topic</code>,
that can publish messages with a valid <code>message-signature</code> that are accepted and
relayed by the nodes implementing this feature.</li>
<li>Relayer: A node that knows the <code>public-key-topic</code>,
which can be used to verify if the messages were signed with the equivalent <code>private-key-topic</code>.
It allows distinguishing valid from invalid messages
which protect the node against DoS attacks,
assuming that the users of the key send messages of a reasonable size and rate.
Note that a node can validate messages and
relay them or not without knowing the private key.</li>
</ul>
<h3 id="design-requirements-publisher"><a class="header" href="#design-requirements-publisher">Design requirements (publisher)</a></h3>
<p>A publisher that wants to send messages
that are relayed in the network for a given <code>protected-pubsub-topic</code> shall:</p>
<ul>
<li>be able to sign messages with the <code>private-key-topic</code> configured for that topic,
producing a ECDSA signature of 64 bytes using
deterministic signing complying with RFC 6979.</li>
<li>include the signature of the <code>app-message-hash</code> (<code>message-signature</code>)
that wishes to send in the <code>WakuMessage</code> <code>meta</code> field.</li>
</ul>
<p>The <code>app-message-hash</code> of the message shall be calculated as the <code>sha256</code> hash
of the following fields of the message:</p>
<pre><code class="language-rs">sha256(concat(pubsubTopic, payload, contentTopic, timestamp, ephemeral))
</code></pre>
<p>Where fields are serialized into bytes using little-endian.
Note that <code>ephemeral</code> is a boolean that is serialized to <code>0</code> if <code>false</code> and
<code>1</code> if <code>true</code>.</p>
<h3 id="design-requirements-relay"><a class="header" href="#design-requirements-relay">Design requirements (relay)</a></h3>
<p>Requirements for the relay are listed below:</p>
<ul>
<li>A valid <code>protected-pubsub-topic</code> shall be configured with a <code>public-key-topic</code>,
(derived from a <code>private-key-topic</code>).
Note that the relay does not need to know the private key.
For simplicity, there is just one key per topic.
Since this approach has clear privacy implications,
this configuration is not part of the waku protocol, but of the application.</li>
</ul>
<p>Requirements on the gossipsub validator:</p>
<ul>
<li>Relay nodes should use the existing gossipsub validators that allow to <code>Accept</code>
or <code>Reject</code> messages, according to the following criteria:</li>
<li>If <code>timestamp</code> is not set (equals to 0) then <code>Reject</code> the message.</li>
<li>If the <code>timestamp</code> is <code>abs(current_timestamp-timestamp) &gt; MessageWindowInSec</code>
then <code>Reject</code> the message.</li>
<li>If <code>meta</code> is empty, <code>Reject</code> the message.</li>
<li>If <code>meta</code> exists but its size is different than 64 bytes, <code>Reject</code> the message.</li>
<li>If <code>meta</code> does not successfully verifies according to the ECDSA signature
verification algorithm using <code>public-key-topic</code> and <code>app-message-hash</code>,
then <code>Reject</code> the message.</li>
<li>If and only if all above conditions are met then <code>Accept</code> the message.</li>
</ul>
<p>Other requirements:</p>
<ul>
<li>The node shall keep metrics on the messages validation output,
<code>Accept</code> or <code>Reject</code>.</li>
<li>(Optional). To further strengthen DoS protection,
gossipsub <a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md#extended-validators">scoring</a>
can be used to trigger disconnections from peers sending multiple invalid messages.
See <code>P4</code> penalty.
This protects each peer from DoS,
since this score is used to trigger disconnections from nodes attempting to DoS them.</li>
</ul>
<h3 id="required-changes"><a class="header" href="#required-changes">Required changes</a></h3>
<p>This solution is designed to be backward compatible so
that nodes validating messages can coexist in the same topic
with other nodes that don't perform validation.
But note that only nodes that perform message validation
will be protected against DoS.
Nodes wishing to opt-in this DoS protection feature shall:</p>
<ul>
<li>Generate a <code>private-key-topic</code> and distribute it to a curated list of users,
that are trusted to send messages at a reasonable rate.</li>
<li>Redeploy the nodes, adding a new configuration
where a <code>protected-pubsub-topic</code> is configured with a <code>public-key-topic</code>,
used to verify the messages being relayed.</li>
</ul>
<h3 id="test-vectors-1"><a class="header" href="#test-vectors-1">Test vectors</a></h3>
<p>Relay nodes complying with this specification
shall accept the following message in the configured pubsub topic.</p>
<p>Given the following key pair:</p>
<pre><code class="language-js">private-key-topic = 5526a8990317c9b7b58d07843d270f9cd1d9aaee129294c1c478abf7261dd9e6
public-key-topic = 049c5fac802da41e07e6cdf51c3b9a6351ad5e65921527f2df5b7d59fd9b56ab02bab736cdcfc37f25095e78127500da371947217a8cd5186ab890ea866211c3f6
</code></pre>
<p>And the following message to send:</p>
<pre><code class="language-js">protected-pubsub-topic = pubsub-topic
contentTopic = content-topic
payload = 1A12E077D0E89F9CAC11FBBB6A676C86120B5AD3E248B1F180E98F15EE43D2DFCF62F00C92737B2FF6F59B3ABA02773314B991C41DC19ADB0AD8C17C8E26757B
timestamp = 1683208172339052800
ephemeral = true
</code></pre>
<p>The message hash and meta (aka signature) are calculated as follows.</p>
<pre><code class="language-js">app-message-hash = 662F8C20A335F170BD60ABC1F02AD66F0C6A6EE285DA2A53C95259E7937C0AE9
message.meta = 127FA211B2514F0E974A055392946DC1A14052182A6ABEFB8A6CD7C51DA1BF2E40595D28EF1A9488797C297EED3AAC45430005FB3A7F037BDD9FC4BD99F59E63
</code></pre>
<p>Using <code>message.meta</code>, the relay node shall calculate the <code>app-message-hash</code>
of the received message using <code>public-key-topic</code>,
and with the values above, the signature should be verified,
making the node <code>Accept</code> the message and relaying it to other nodes in the network.</p>
<h2 id="owner-mapped-communities-1"><a class="header" href="#owner-mapped-communities-1">Owner Mapped Communities</a></h2>
<p>Basic idea:
Tokenized load.</p>
<h3 id="1-to-1-chat"><a class="header" href="#1-to-1-chat">1 to 1 Chat</a></h3>
<p>An idea we plan to explore in the future:
Map 1:1 chats to community shards, if both A and B are part of the respective community.
This increases k-anonymity and benefits from community DoS protection.
It could be rate-limited with RLN.</p>
<h2 id="securityprivacy-considerations-4"><a class="header" href="#securityprivacy-considerations-4">Security/Privacy Considerations</a></h2>
<p>This document makes several trade-offs to privacy and anonymity.
Todo: elaborate.
See <a href="https://github.com/waku-org/specs/blob/master/informational/adversarial-models.md">WAKU2-ADVERSARIAL-MODELS</a>
for information on Waku Anonymity.</p>
<h2 id="copyright-65"><a class="header" href="#copyright-65">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-52"><a class="header" href="#references-52">References</a></h2>
<ul>
<li><a href="status/raw/../56/communities.html">56/STATUS-COMMUNITIES</a></li>
<li><a href="status/raw/../55/1to1-chat.html">55/STATUS-1TO1-CHAT</a></li>
<li><a href="status/raw/../../waku/informational/23/topics.html">23/WAKU2-TOPICS</a></li>
<li><a href="status/raw/../../waku/standards/core/11/relay.html">11/WAKU2-RELAY</a></li>
<li><a href="https://github.com/waku-org/specs/blob/master/standards/core/relay-sharding.md">WAKU2-RELAY-SHARDING</a></li>
<li><a href="https://github.com/waku-org/specs/blob/master/informational/relay-static-shard-alloc.md">WAKU2-RELAY-STATIC-SHARD-ALLOC</a></li>
<li><a href="status/raw/../../waku/informational/30/adaptive-nodes.html">30/ADAPTIVE-NODES</a></li>
<li><a href="status/raw/../../waku/standards/core/19/lightpush.html">19/WAKU2-LIGHTPUSH</a></li>
<li><a href="status/raw/../../waku/standards/core/12/filter.html">12/WAKU2-FILTER</a></li>
<li><a href="https://github.com/waku-org/specs/blob/master/standards/core/peer-exchange.md">WAKU2-PEER-EXCHANGE</a></li>
<li><a href="status/raw/../../waku/standards/core/13/store.html">13/WAKU2-STORE</a></li>
<li><a href="https://github.com/libp2p/specs/blob/master/rendezvous/README.md">libp2p rendezvous</a></li>
<li><a href="https://github.com/libp2p/specs/blob/master/autonat/README.md">libp2p AutoNAT protocol</a></li>
<li><a href="status/raw/../../waku/standards/core/33/discv5.html">33/WAKU2-DISCV5</a></li>
<li><a href="https://github.com/libp2p/specs/blob/6634ca7abb2f955645243d48d1cd2fd02a8e8880/relay/circuit-v2.md">libp2p circuit relay</a></li>
<li><a href="https://github.com/libp2p/specs/blob/6634ca7abb2f955645243d48d1cd2fd02a8e8880/relay/circuit-v2.md#reservation">limiting</a></li>
<li><a href="https://github.com/libp2p/specs/blob/master/relay/DCUtR.md">DCUtR</a></li>
<li><a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md#extended-validators">scoring</a></li>
<li><a href="https://docs.libp2p.io/concepts/nat/circuit-relay/">Circuit Relay</a></li>
<li><a href="https://github.com/waku-org/specs/blob/master/informational/adversarial-models.md">WAKU2-ADVERSARIAL-MODELS</a></li>
</ul>
<h2 id="informative-7"><a class="header" href="#informative-7">Informative</a></h2>
<ul>
<li><a href="https://docs.libp2p.io/concepts/nat/circuit-relay/">Circuit Relay</a></li>
<li><a href="https://github.com/waku-org/specs/blob/master/standards/core/enr.md">WAKU2-ENR</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="status-protocols"><a class="header" href="#status-protocols">STATUS-PROTOCOLS</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Status Protocol Stack</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Hanno Cornelius &lt;hanno@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Jimmy Debe &lt;jimmy@status.im&gt;<br>Aaryamann Challani &lt;p1ge0nh8er@proton.me&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-70"><a class="header" href="#timeline-70">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/raw/status-app-protocols.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/raw/status-app-protocols.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-03-07</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/f4b34afd1a1e198b0d99b911bf8b371b5b13a6b8/status/raw/status-app-protocols.md"><code>f4b34af</code></a> — Fix Linting Errors (#135)</li>
<li><strong>2025-02-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/9bed57e4ad5d6609202a18f581a00b2fd81f6acb/status/raw/status-app-protocols.md"><code>9bed57e</code></a> — docs: define basic sharding for Communities (#132)</li>
<li><strong>2024-11-20</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/776c1b76cda73aa1feaf5746a4cdb56b6836b4be/status/raw/status-app-protocols.md"><code>776c1b7</code></a> — rfc-index: Update (#110)</li>
<li><strong>2024-10-25</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/37b3edfba3a103ef138a345a2a0cac7f28c07f7a/status/raw/status-app-protocols.md"><code>37b3edf</code></a> — docs: add spec for status protocol stack, deprecate waku-usage spec (#105)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-45"><a class="header" href="#abstract-45">Abstract</a></h2>
<p>This specification describes the Status Application protocol stack.
It focuses on elements and features in the protocol stack for all application-level functions:</p>
<ul>
<li>functional scope (also <em>broadcast audience</em>)</li>
<li>content topic</li>
<li>ephemerality</li>
<li>end-to-end reliability layer</li>
<li>encryption layer</li>
<li>transport layer (Waku)</li>
</ul>
<p>It also introduces strategies to restrict resource usage, distribute large messages, etc.
Application-level functions are out of scope and specified separately. See:</p>
<ul>
<li><a href="status/raw/../55/1to1-chat.html">55/STATUS-1TO1-CHAT</a></li>
<li><a href="status/raw/../56/communities.html">56/STATUS-COMMUNITIES</a></li>
</ul>
<h2 id="status-protocol-stack"><a class="header" href="#status-protocol-stack">Status protocol stack</a></h2>
<p>The keywords “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”,
“SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and
“OPTIONAL” in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">2119</a>.
See the simplified diagram of the Status application protocol stack:</p>
<div class="table-wrapper"><table><thead><tr><th></th></tr></thead><tbody>
<tr><td>Status application layer</td></tr>
<tr><td>End-to-end reliability layer</td></tr>
<tr><td>Encryption layer</td></tr>
<tr><td>Transport layer (Waku)</td></tr>
<tr><td></td></tr>
</tbody></table>
</div>
<h2 id="status-application-layer"><a class="header" href="#status-application-layer">Status application layer</a></h2>
<p>Application level functions are defined in the <em>application</em> layer.
Status currently defines functionality to support three main application features:</p>
<ul>
<li>Status Communities, as specified in <a href="status/raw/../56/communities.html">56/STATUS-COMMUNITIES</a></li>
<li>Status 1:1 Chat, as specified in <a href="status/raw/../55/1to1-chat.html">55/STATUS-1TO1-CHAT</a></li>
<li>Status Private Group Chat, as specified in a subsection of <a href="status/raw/../55/1to1-chat.html#negotiation-of-a-11-chat-amongst-multiple-participants-group-chat">55/STATUS-1TO1-CHAT</a></li>
</ul>
<!-- TODO: list functions not related to main app features, such as user sync, backup, push notifications, etc. -->
<p>Each application-level function, regardless which feature set it supports, has the following properties:</p>
<ol>
<li>Functional scope</li>
<li>Content topic</li>
<li>Ephemerality</li>
</ol>
<h3 id="functional-scope"><a class="header" href="#functional-scope">Functional Scope</a></h3>
<p>Each Status app-level message MUST define a functional scope.
The functional scope MUST define the <em>minimum</em> scope of the audience that should <em>participate</em> in the app function the message is related to.
In other words, it determines the minimum subset of Status app participants
that should have access to messages related to that function.</p>
<p>Note that the functional scope is distinct from the number of participants that is <em>addressed</em> by a specific message.
For example, a participant will address a 1:1 chat to only one other participant.
However, since all users of the Status app MUST be able to participate in 1:1 chats,
the functional scope of messages enabling 1:1 chats MUST be a global scope.
Similarly, since private group chats can be set up between any subset of Status app users,
the functional scope for messages related to private group chats MUST be global.
Along the same principle, messages that originate within communities are of global interest
for all users who have an interest in the Status Communities feature.
Such messages MUST have a global functional scope,
that can be accessed by any app users interested in communities.
A different group of messages are addressed only to the participant that generated those messages itself.
These <em>self-addressed</em> messages MUST have a local functional scope.</p>
<p>If we further make a distinction between "control" and "content" messages,
we can distinguish five distinct functional scopes.</p>
<p>All Status messages MUST have one of these functional scopes:</p>
<h4 id="global-general-scope"><a class="header" href="#global-general-scope">Global general scope</a></h4>
<ol>
<li><em>Global control</em>: messages enabling the basic functioning of the app to control general features that all app users should be able to participate in. Examples include Contact Requests, global Status Updates, Group Chat Invites, etc.</li>
<li><em>Global content</em>: messages carrying user-generated content for global functions. Examples include 1:1 chat messages, images shared over private group chats, etc.</li>
</ol>
<h4 id="global-community-scope"><a class="header" href="#global-community-scope">Global community scope</a></h4>
<ol>
<li><em>Global community control</em>: messages enabling the basic functioning of the app to control features related to communities. Examples include Community Invites, Community Membership Updates, community Status Updates, etc.</li>
<li><em>Global community content</em>: messages carrying user-generated content for members of any community.</li>
</ol>
<blockquote>
<p><strong>Note:</strong> a previous iteration of the Status Communities feature defined separate community-wide scopes for each community.
However, this model was deprecated and all communities now operate on a global, shared scope.
This implies that different communities will share shards on the routing layer.</p>
</blockquote>
<h4 id="local-scope"><a class="header" href="#local-scope">Local scope</a></h4>
<ol>
<li><em>Local</em>: messages related to functions that are only relevant to a single user. Also known as <em>self-addressed messages</em>. Examples include messages used to exchange information between app installations, such as User Backup and Sync messages.</li>
</ol>
<p>Note that the functional scope is a logical property of Status messages.
It SHOULD however inform the underlying <a href="status/raw/status-app-protocols.html#pubsub-topics-and-sharding">transport layer sharding</a> and <a href="status/raw/status-app-protocols.html#subscribing">transport layer subscriptions</a>.
In general a Status client SHOULD subscribe to participate in:</p>
<ul>
<li>all global functions</li>
<li>global community functions if it is interested in this feature, and</li>
<li>its own local functions.</li>
</ul>
<h3 id="content-topics-1"><a class="header" href="#content-topics-1">Content topics</a></h3>
<p>Each Status app-level message MUST define a content topic that links messages in related app-level functions and sub-functions together.
This MUST be based on the filter use cases for <a href="status/raw/status-app-protocols.html#subscribing">transport layer subscriptions</a>
and <a href="status/raw/status-app-protocols.html#retrieving-historical-messages">retrieving historical messages</a>.
A content topic SHOULD be identical across all messages that are always part of the same filter use case (or always form part of the same content-filtered query criteria).
In other words, the number of content topics defined in the app SHOULD match the number of filter use cases.
For the sake of illustration, consider the following common content topic and filter use cases:</p>
<ul>
<li>if all messages belonging to the same 1:1 chat are always filtered together, they SHOULD use the same content topic (see <a href="status/raw/../55/1to1-chat.html">55/STATUS-1TO1-CHAT</a>)</li>
<li>if all messages belonging to the same Community are always filtered together, they SHOULD use the same content topic (see <a href="status/raw/../56/communities.html">56/STATUS-COMMUNITIES</a>).</li>
</ul>
<p>The app-level content topic MUST be populated in the <code>content_topic</code> field in the encapsulating Waku message (see <a href="status/raw/status-app-protocols.html#waku-messages">Waku messages</a>).</p>
<h3 id="ephemerality"><a class="header" href="#ephemerality">Ephemerality</a></h3>
<p>Each Status app-level message MUST define its <em>ephemerality</em>.
Ephemerality is a boolean value, set to <code>true</code> if a message is considered ephemeral.
Ephemeral messages are messages emitted by the app that are transient in nature.
They only have temporary "real-time" value
and SHOULD NOT be stored and retrievable from historical message stores and sync caches.
Similarly, ephemeral message delivery is best-effort in nature and SHOULD NOT be considered in message reliability mechanisms (see <a href="status/raw/status-app-protocols.html#end-to-end-reliability-layer">End-to-end reliability layer</a>).</p>
<p>An example of ephemeral messages would be periodic status update messages, indicating a particular user's online status.
Since only a user's current online status is of value, there is no need to store historical status update messages.
Since status updates are periodic, there is no strong need for end-to-end reliability as subsequent updates are always to follow.</p>
<p>App-level messages that are considered ephemeral, MUST set the <code>ephemeral</code> field in the encapsulating Waku message to <code>true</code> (see <a href="status/raw/status-app-protocols.html#waku-messages">Waku messages</a>)</p>
<h2 id="end-to-end-reliability-layer"><a class="header" href="#end-to-end-reliability-layer">End-to-end reliability layer</a></h2>
<p>The end-to-end reliability layer contains the functions related to one of the two end-to-end reliability schemes defined for Status app messages:</p>
<ol>
<li>Minimum Viable protocol for Data Synchronisation, or MVDS (see <a href="status/raw/./status-mvds.html">STATUS-MVDS-USAGE</a>)</li>
<li>Scalable distributed log reliability (spec and a punchier name TBD, see the <a href="https://forum.vac.dev/t/end-to-end-reliability-for-scalable-distributed-logs/293/16">original forum post announcement</a>)</li>
</ol>
<p>Ephemeral messages SHOULD omit this layer.
Non-ephemeral 1:1 chat messages SHOULD make use of MVDS to achieve reliable data synchronisation between the two parties involved in the communication.
Non-ephemeral private group chat messages build on a set of 1:1 chat links
and consequently SHOULD also make use of MVDS to achieve reliable data synchronisation between all parties involved in the communication.
Non-ephemeral 1:1 and private group chat messages MAY make use of of <a href="https://forum.vac.dev/t/end-to-end-reliability-for-scalable-distributed-logs/293/16">scalable distributed log reliability</a> in future.
Since MVDS does not scale for large number of participants in the communication,
non-ephemeral community messages MUST use scalable distributed log reliability as defined in this <a href="https://forum.vac.dev/t/end-to-end-reliability-for-scalable-distributed-logs/293/16">original forum post announcement</a>.
The app MUST use a single channel ID per community.</p>
<h2 id="encryption-layer"><a class="header" href="#encryption-layer">Encryption layer</a></h2>
<p>The encryption layer wraps the Status App and Reliability layers in an encrypted payload.</p>
<!-- TODO: This section is TBD. We may want to design a way for Communities to use de-MLS in a separate spec and generally simplify Status encryption. -->
<h2 id="waku-transport-layer"><a class="header" href="#waku-transport-layer">Waku transport layer</a></h2>
<p>The Waku transport layer contains the functions allowing Status protocols to use <a href="status/raw/../../waku/standards/core/10/waku2.html">10/WAKU2</a> infrastructure as transport.</p>
<h3 id="waku-messages"><a class="header" href="#waku-messages">Waku messages</a></h3>
<p>Each Status application message MUST be transformed to a <a href="status/raw/../../waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a> with the following structure:</p>
<pre><code class="language-protobuf">syntax = "proto3";

message WakuMessage {
  bytes payload = 1;
  string content_topic = 2;
  optional uint32 version = 3;
  optional sint64 timestamp = 10;
  optional bytes meta = 11;
  optional bool ephemeral = 31;
}
</code></pre>
<ul>
<li><code>payload</code> MUST be set to the full encrypted payload received from the higher layers</li>
<li><code>version</code> MUST be set to <code>1</code></li>
<li><code>ephemeral</code> MUST be set to <code>true</code> if the app-level message is ephemeral</li>
<li><code>content_topic</code> MUST be set to the app-level content topic</li>
<li><code>timestamp</code> MUST be set to the current Unix epoch timestamp (in nanosecond precision)</li>
</ul>
<h3 id="pubsub-topics-and-sharding"><a class="header" href="#pubsub-topics-and-sharding">Pubsub topics and sharding</a></h3>
<p>All Waku messages are published to pubsub topics as defined in <a href="status/raw/../../waku/informational/23/topics.html">23/WAKU2-TOPICS</a>.
Since pubsub topics define a routing layer for messages,
they can be used to shard traffic.
The pubsub topic used for publishing a message depends on the app-level <a href="status/raw/status-app-protocols.html#functional-scope">functional scope</a>.</p>
<h4 id="self-addressed-messages"><a class="header" href="#self-addressed-messages">Self-addressed messages</a></h4>
<p>The application MUST define at least one distinct pubsub topic for self-addressed messages.
The application MAY define a set of more than one pubsub topic for self-addressed messages to allow traffic sharding for scalability.</p>
<h4 id="global-messages"><a class="header" href="#global-messages">Global messages</a></h4>
<p>The application MUST define at least one distinct pubsub topic for global control messages and global content messages.
The application MAY defined a set of more than one pubsub topic for global messages to allow traffic sharding for scalability.
It is RECOMMENDED that separate pubsub topics be used for global control messages and global content messages.</p>
<h4 id="community-messages"><a class="header" href="#community-messages">Community messages</a></h4>
<p>The application SHOULD define at least one distinct pubsub topic for global community control messages and global community content messages.
The application MAY define a set of more than one pubsub topic for global community messages to allow traffic sharding for scalability.
It is RECOMMENDED that separate pubsub topics be used for global community control messages and global community content messages.</p>
<h4 id="large-messages"><a class="header" href="#large-messages">Large messages</a></h4>
<p>The application MAY define separate pubsub topics for large messages.
These pubsub topics for large messages MAY be distinct for each functional scope.</p>
<h3 id="resource-usage"><a class="header" href="#resource-usage">Resource usage</a></h3>
<p>The application SHOULD use a range of Waku protocols to interact with the Waku transport layer.
The specific set of Waku protocols used depend on desired functionality and resource usage profile for the specific client.
Resources can be restricted in terms of bandwidth and computing resources.</p>
<p>Waku protocols that are more appropriate for resource-restricted environments are often termed "light protocols".
Waku protocols that consume more resources, but simultaneously contribute more to Waku infrastructure, are often termed "full protocols".
The terms "full" and "light" is just a useful abstraction than a strict binary, though,
and Status clients can operate along a continuum of resource usage profiles,
each using the combination of "full" and "light" protocols most appropriate to match its environment and motivations.</p>
<p>To simplify interaction with the selection of "full" and "light" protocols,
Status clients MUST define a "full mode" and "light mode"
to allow users to select whether their client would prefer "full protocols" or "light protocols" by default.
Status Desktop clients are assumed to have more resources available and SHOULD use full mode by default.
Status Mobile clients are assumed to operate with more resource restrictions and SHOULD use light mode by default.</p>
<p>For the purposes of the rest of this document,
clients in full mode will be referred to as "full clients" and
clients in light mode will be referred to as "light clients".</p>
<h3 id="discovery-1"><a class="header" href="#discovery-1">Discovery</a></h3>
<p>The application MUST make use of at least one discovery method to discover and connect to Waku peers
useful for the user functions specific to that instance of the application.</p>
<p>The specific Waku discovery protocol used for discovery depends on the use case and resource-availability of the client.</p>
<ol>
<li><a href="https://eips.ethereum.org/EIPS/eip-1459">EIP-1459: DNS-based discovery</a> is useful for initial connection to bootstrap peers.</li>
<li><a href="status/raw/../../waku/standards/core/33/discv5.html">33/WAKU2-DISCV5</a> allows decentralized discovery of Waku peers.</li>
<li><a href="https://github.com/waku-org/specs/blob/315264c202e0973476e2f1e2d0b01bea4fe1ad31/standards/core/peer-exchange.md">34/WAKU2-PEER-EXCHANGE</a> allows requesting peers from a service node
and is appropriate for resource-restricted discovery.</li>
</ol>
<p>All clients SHOULD use DNS-based discovery on startup
to discover a set of bootstrap peers for initial connection.</p>
<p>Full clients SHOULD use <a href="status/raw/../../waku/standards/core/33/discv5.html">33/WAKU2-DISCV5</a> for continuous ambient peer discovery.</p>
<p>Light clients SHOULD use <a href="https://github.com/waku-org/specs/blob/315264c202e0973476e2f1e2d0b01bea4fe1ad31/standards/core/peer-exchange.md">34/WAKU2-PEER-EXCHANGE</a> to discover a set of service peers
used by that instance of the application.</p>
<h3 id="subscribing"><a class="header" href="#subscribing">Subscribing</a></h3>
<p>The application MUST subscribe to receive the traffic necessary for minimal app operation
and to enable the user functions specific to that instance of the application.</p>
<p>The specific Waku protocol used for subscription depends on the resource-availability of the client:</p>
<ol>
<li>Filter client protocol, as specified in <a href="status/raw/../../waku/standards/core/12/filter.html">12/WAKU2-FILTER</a>, allows subscribing for traffic with content topic granularity and is appropriate for resource-restricted subscriptions.</li>
<li>Relay protocol, as specified in <a href="status/raw/../../waku/standards/core/11/relay.html">11/WAKU2-RELAY</a>, allows subscribing to traffic only with pubsub topic granularity and therefore is more resource-intensive. Relay subscription also allows the application instance to contribute to the overall routing infrastructure, which adds to its overall higher resource usage but benefits the ecosystem.</li>
</ol>
<p>Full clients SHOULD use relay protocol as preferred method to subscribe to pubsub topics matching the scopes:</p>
<ol>
<li>Global control</li>
<li>Global content</li>
<li>Global community control, if the client has activated the Status Communities feature</li>
<li>Global community content, if the client has activated the Status Communities feature</li>
</ol>
<p>Light clients SHOULD use filter protocol to subscribe only to the content topics relevant to the user.</p>
<h4 id="self-addressed-messages-1"><a class="header" href="#self-addressed-messages-1">Self-addressed messages</a></h4>
<p>Status clients (full or light) MUST NOT subscribe to topics for messages with self-addressed scopes.
See <a href="status/raw/status-app-protocols.html#self-addressed-messages-4">Self-addressed messages</a>.</p>
<h4 id="large-messages-1"><a class="header" href="#large-messages-1">Large messages</a></h4>
<p>Status clients (full or light) SHOULD NOT subscribe to topics set aside for large messages.
See <a href="status/raw/status-app-protocols.html#large-messages-4">Large messages</a>.</p>
<h3 id="publishing-1"><a class="header" href="#publishing-1">Publishing</a></h3>
<p>The application MUST publish user and app generated messages via the Waku transport layer.
The specific Waku protocol used for publishing depends on the resource-availability of the client:</p>
<ol>
<li>Lightpush protocol, as specified in <a href="status/raw/../../waku/standards/core/19/lightpush.html">19/WAKU2-LIGHTPUSH</a> allows publishing to a pubsub topic via an intermediate "full node" and is more appropriate for resource-restricted publishing.</li>
<li>Relay protocol, as specified in <a href="status/raw/../../waku/standards/core/11/relay.html">11/WAKU2-RELAY</a>, allows publishing directly into the relay routing network and is therefore more resource-intensive.</li>
</ol>
<p>Full clients SHOULD use relay protocol to publish to pubsub topics matching the scopes:</p>
<ol>
<li>Global control</li>
<li>Global content</li>
<li>Global community control, if the client has activated the Status Communities feature</li>
<li>Global community content, if the client has activated the Status Communities feature</li>
</ol>
<p>Light clients SHOULD use lightpush protocol to publish control and content messages.</p>
<h4 id="self-addressed-messages-2"><a class="header" href="#self-addressed-messages-2">Self-addressed messages</a></h4>
<p>Status clients (full or light) MUST use lightpush protocol to publish self-addressed messages.
See <a href="status/raw/status-app-protocols.html#self-addressed-messages-4">Self-addressed messages</a>.</p>
<h4 id="large-messages-2"><a class="header" href="#large-messages-2">Large messages</a></h4>
<p>Status clients (full or light) SHOULD use lightpush protocols to publish to pubsub topics set aside for large messages.
See <a href="status/raw/status-app-protocols.html#large-messages-4">Large messages</a>.</p>
<h3 id="retrieving-historical-messages"><a class="header" href="#retrieving-historical-messages">Retrieving historical messages</a></h3>
<p>Status clients SHOULD use the store query protocol, as specified in <a href="https://github.com/waku-org/specs/blob/8fea97c36c7bbdb8ddc284fa32aee8d00a2b4467/standards/core/store.md">WAKU2-STORE</a>, to retrieve historical messages relevant to the client from store service nodes in the network.</p>
<p>Status clients SHOULD use <a href="https://github.com/waku-org/specs/blob/8fea97c36c7bbdb8ddc284fa32aee8d00a2b4467/standards/core/store.md#content-filtered-queries">content filtered queries</a> with <code>include_data</code> set to <code>true</code>,
to retrieve the full contents of historical messages that the client may have missed during offline periods,
or to populate the local message database when the client starts up for the first time.</p>
<h4 id="store-queries-for-reliability"><a class="header" href="#store-queries-for-reliability">Store queries for reliability</a></h4>
<p>Status clients MAY use periodic content filtered queries with <code>include_data</code> set to <code>false</code>,
to retrieve only the message hashes of past messages on content topics relevant to the client.
This can be used to compare the hashes available in the local message database with the hashes in the query response
in order to identify possible missing messages.
Once the Status client has identified a set of missing message hashes
it SHOULD use <a href="https://github.com/waku-org/specs/blob/8fea97c36c7bbdb8ddc284fa32aee8d00a2b4467/standards/core/store.md#message-hash-lookup-queries">message hash lookup queries</a> with <code>include_data</code> set to <code>true</code>
to retrieve the full contents of the missing messages based on the hash.</p>
<p>Status clients MAY use <a href="https://github.com/waku-org/specs/blob/8fea97c36c7bbdb8ddc284fa32aee8d00a2b4467/standards/core/store.md#presence-queries">presence queries</a>
to determine if one or more message hashes known to the client is present in the store service node.
Clients MAY use this method to determine if a message that originated from the client
has been successfully stored.</p>
<h4 id="self-addressed-messages-3"><a class="header" href="#self-addressed-messages-3">Self-addressed messages</a></h4>
<p>Status clients (full or light) SHOULD use store queries (rather than subscriptions) to retrieve self-addressed messages relevant to that client.
See <a href="status/raw/status-app-protocols.html#self-addressed-messages-4">Self-addressed messages</a>.</p>
<h4 id="large-messages-3"><a class="header" href="#large-messages-3">Large messages</a></h4>
<p>Status clients (full or light) SHOULD use store queries (rather than subscriptions) to retrieve large messages relevant to that client.
See <a href="status/raw/status-app-protocols.html#large-messages-4">Large messages</a>.</p>
<h3 id="providing-services"><a class="header" href="#providing-services">Providing services</a></h3>
<p>Status clients MAY provide service-side protocols to other clients.</p>
<p>Full clients SHOULD mount
the filter service protocol (see <a href="status/raw/../../waku/standards/core/12/filter.html">12/WAKU2-FILTER</a>)
and lightpush service protocol (see <a href="status/raw/../../waku/standards/core/19/lightpush.html">19/WAKU2-LIGHTPUSH</a>)
in order to provide light subscription and publishing services to other clients
for each pubsub topic to which they have a relay subscription.</p>
<p>Full clients SHOULD mount
the peer exchange service protocol (see <a href="https://github.com/waku-org/specs/blob/315264c202e0973476e2f1e2d0b01bea4fe1ad31/standards/core/peer-exchange.md">34/WAKU2-PEER-EXCHANGE</a>)
to provide light discovery services to other clients.</p>
<p>Status clients MAY mount the store query protocol as service node (see <a href="https://github.com/waku-org/specs/blob/8fea97c36c7bbdb8ddc284fa32aee8d00a2b4467/standards/core/store.md">WAKU2-STORE</a>)
to store historical messages and
provide store services to other clients
for each pubsub topic to which they have a relay subscription</p>
<h3 id="self-addressed-messages-4"><a class="header" href="#self-addressed-messages-4">Self-addressed messages</a></h3>
<p>Messages with a <em>local</em> functional scope (see <a href="status/raw/status-app-protocols.html#functional-scope">Functional scope</a>),
also known as <em>self-addressed</em> messages,
MUST be published to a distinct pubsub topic or a distinct <em>set</em> of pubsub topics
used exclusively for messages with local scope (see <a href="status/raw/status-app-protocols.html#pubsub-topics-and-sharding">Pubsub topics and sharding</a>).
Status clients (full or light) MUST use lightpush protocol to publish self-addressed messages (see <a href="status/raw/status-app-protocols.html#publishing">Publishing</a>).
Status clients (full or light) MUST NOT subscribe to topics for messages with self-addressed scopes (see <a href="status/raw/status-app-protocols.html#subscribing">Subscribing</a>).
Status clients (full or light) SHOULD use store queries (rather than subscriptions) to retrieve self-addressed messages relevant to that client (see <a href="status/raw/status-app-protocols.html#retrieving-historical-messages">Retrieving historical messages</a>).</p>
<h3 id="large-messages-4"><a class="header" href="#large-messages-4">Large messages</a></h3>
<p>The application MAY define separate pubsub topics for large messages.
These pubsub topics for large messages MAY be distinct for each functional scope (see <a href="status/raw/status-app-protocols.html#pubsub-topics-and-sharding">Pubsub topics and sharding</a>).
Status clients (full or light) SHOULD use lightpush protocols to publish to pubsub topics set aside for large messages (see <a href="status/raw/status-app-protocols.html#publishing">Publishing</a>).
Status clients (full or light) SHOULD NOT subscribe to topics set aside for large messages (see <a href="status/raw/status-app-protocols.html#subscribing">Subscribing</a>).
Status clients (full or light) SHOULD use store queries (rather than subscriptions) to retrieve large messages relevant to that client (see <a href="status/raw/status-app-protocols.html#retrieving-historical-messages">Retrieving historical messages</a>).</p>
<h4 id="chunking"><a class="header" href="#chunking">Chunking</a></h4>
<p>The Status application MAY use a chunking mechanism to break down large payloads
into smaller segments for individual Waku transport.
The definition of a large message is up to the application.
However, the maximum size for a <a href="status/raw/../../waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a> payload is 150KB.
Status application payloads that exceed this size MUST be chunked into smaller pieces
and MUST be considered a "large message".</p>
<h2 id="copyright-66"><a class="header" href="#copyright-66">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-53"><a class="header" href="#references-53">References</a></h2>
<ol>
<li><a href="status/raw/../55/1to1-chat.html">55/STATUS-1TO1-CHAT</a></li>
<li><a href="status/raw/../56/communities.html">56/STATUS-COMMUNITIES</a></li>
<li><a href="status/raw/../../waku/standards/core/10/waku2.html">10/WAKU2</a></li>
<li><a href="status/raw/../../waku/standards/core/11/relay.html">11/WAKU2-RELAY</a></li>
<li><a href="status/raw/../../waku/standards/core/12/filter.html">12/WAKU2-FILTER</a></li>
<li><a href="status/raw/../../waku/standards/core/14/message.html">14/WAKU2-MESSAGE</a></li>
<li><a href="status/raw/../../waku/informational/23/topics.html">23/WAKU2-TOPICS</a></li>
<li><a href="status/raw/../../waku/standards/core/19/lightpush.html">19/WAKU2-LIGHTPUSH</a></li>
<li><a href="https://forum.vac.dev/t/end-to-end-reliability-for-scalable-distributed-logs/293/16">Scalable distributed log reliability</a></li>
<li><a href="status/raw/./status-mvds.html">STATUS-MVDS-USAGE</a></li>
<li><a href="https://github.com/waku-org/specs/blob/8fea97c36c7bbdb8ddc284fa32aee8d00a2b4467/standards/core/store.md">WAKU2-STORE</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="status-mvds-usage"><a class="header" href="#status-mvds-usage">STATUS-MVDS-USAGE</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>MVDS Usage in Status</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>Best Current Practice</td></tr>
<tr><th>Editor</th><td>Kaichao Sun &lt;kaichao@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-71"><a class="header" href="#timeline-71">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/raw/status-mvds.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/raw/status-mvds.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/status/raw/status-mvds.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-08-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/751a01ece441d0fa4265c4deb0ff7f106dd8244f/status/raw/status-mvds.md"><code>751a01e</code></a> — feat: status mvds usage (#87)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-46"><a class="header" href="#abstract-46">Abstract</a></h2>
<p>This document lists the types of messages that are using <a href="status/raw//vac/2/mvds.html">MVDS</a>
in the Status application.</p>
<h2 id="background-7"><a class="header" href="#background-7">Background</a></h2>
<p>Status app uses MVDS to ensure messages going through Waku
are acknolwedged by the recipient.
This is to ensure that the messages are not missed by any interested parties.</p>
<h2 id="message-types-2"><a class="header" href="#message-types-2">Message types</a></h2>
<p>Various Message Types contain distinct information defined by the app
to facilitate convenient serialization and deserialization.</p>
<p>E2E reliability is a feature that ensures messages are delivered to the recipient.
This is initially achieved by using MVDS in Status.</p>
<p>Chat Type specifies the category of chat that a message belongs to.
It can be OneToOne (aka Direct Message), GroupChat, or CommunityChat.
These are the three main types of chats in Status.</p>
<div class="table-wrapper"><table><thead><tr><th>Message Type</th><th>Use MVDS</th><th>Need e2e reliability</th><th>Chat Type</th></tr></thead><tbody>
<tr><td>ApplicationMetadataMessage_UNKNOWN</td><td>No</td><td>No</td><td>Not Applied</td></tr>
<tr><td>ApplicationMetadataMessage_CHAT_MESSAGE</td><td>Yes for OneToOne &amp; PrivateGroupChat</td><td>Yes</td><td>One &amp; Group &amp; Community</td></tr>
<tr><td>ApplicationMetadataMessage_CONTACT_UPDATE</td><td>Yes</td><td>Yes</td><td>OneToOne</td></tr>
<tr><td>ApplicationMetadataMessage_MEMBERSHIP_UPDATE_MESSAGE</td><td>No</td><td>Yes</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_PAIR_INSTALLATION</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_DEPRECATED_SYNC_INSTALLATION</td><td>No</td><td>No</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_REQUEST_ADDRESS_FOR_TRANSACTION</td><td>Yes for OneToOne</td><td>Yes</td><td>One &amp; Group &amp; Community</td></tr>
<tr><td>ApplicationMetadataMessage_ACCEPT_REQUEST_ADDRESS_FOR_TRANSACTION</td><td>Yes for OneToOne</td><td>Yes</td><td>One &amp; Group &amp; Community</td></tr>
<tr><td>ApplicationMetadataMessage_DECLINE_REQUEST_ADDRESS_FOR_TRANSACTION</td><td>Yes for OneToOne</td><td>Yes</td><td>One &amp; Group &amp; Community</td></tr>
<tr><td>ApplicationMetadataMessage_REQUEST_TRANSACTION</td><td>Yes for OneToOne</td><td>Yes</td><td>OneToOne &amp; GroupChat</td></tr>
<tr><td>ApplicationMetadataMessage_SEND_TRANSACTION</td><td>Yes for OneToOne</td><td>Yes</td><td>One &amp; Group &amp; Community</td></tr>
<tr><td>ApplicationMetadataMessage_DECLINE_REQUEST_TRANSACTION</td><td>Yes for OneToOne</td><td>Yes</td><td>One &amp; Group &amp; Community</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_INSTALLATION_CONTACT_V2</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_INSTALLATION_ACCOUNT</td><td>No</td><td>No</td><td>Not Applied</td></tr>
<tr><td>ApplicationMetadataMessage_CONTACT_CODE_ADVERTISEMENT</td><td>No</td><td>No</td><td>Not Applied</td></tr>
<tr><td>ApplicationMetadataMessage_PUSH_NOTIFICATION_REGISTRATION</td><td>No</td><td>No</td><td>One &amp; Group &amp; Community</td></tr>
<tr><td>ApplicationMetadataMessage_PUSH_NOTIFICATION_REGISTRATION_RESPONSE</td><td>No</td><td>No</td><td>One &amp; Group &amp; Community</td></tr>
<tr><td>ApplicationMetadataMessage_PUSH_NOTIFICATION_QUERY</td><td>No</td><td>No</td><td>One &amp; Group &amp; Community</td></tr>
<tr><td>ApplicationMetadataMessage_PUSH_NOTIFICATION_QUERY_RESPONSE</td><td>No</td><td>No</td><td>One &amp; Group &amp; Community</td></tr>
<tr><td>ApplicationMetadataMessage_PUSH_NOTIFICATION_REQUEST</td><td>No</td><td>No</td><td>One &amp; Group &amp; Community</td></tr>
<tr><td>ApplicationMetadataMessage_PUSH_NOTIFICATION_RESPONSE</td><td>No</td><td>No</td><td>One &amp; Group &amp; Community</td></tr>
<tr><td>ApplicationMetadataMessage_EMOJI_REACTION</td><td>No</td><td>Yes</td><td>One &amp; Group &amp; Community</td></tr>
<tr><td>ApplicationMetadataMessage_GROUP_CHAT_INVITATION</td><td>Yes</td><td>Yes</td><td>GroupChat</td></tr>
<tr><td>ApplicationMetadataMessage_CHAT_IDENTITY</td><td>No</td><td>No</td><td>OneToOne</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_DESCRIPTION</td><td>No</td><td>Weak Yes</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_INVITATION</td><td>No</td><td>Weak Yes</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_REQUEST_TO_JOIN</td><td>No</td><td>Yes</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_PIN_MESSAGE</td><td>Yes for OneToOne &amp; PrivateGroupChat</td><td>Yes</td><td>One &amp; Group &amp; Community</td></tr>
<tr><td>ApplicationMetadataMessage_EDIT_MESSAGE</td><td>Yes for OneToOne &amp; PrivateGroupChat</td><td>Yes</td><td>One &amp; Group &amp; Community</td></tr>
<tr><td>ApplicationMetadataMessage_STATUS_UPDATE</td><td>No</td><td>No</td><td>Not Applied</td></tr>
<tr><td>ApplicationMetadataMessage_DELETE_MESSAGE</td><td>Yes for OneToOne &amp; PrivateGroupChat</td><td>Yes</td><td>One &amp; Group &amp; Community</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_INSTALLATION_COMMUNITY</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_ANONYMOUS_METRIC_BATCH</td><td>No</td><td>No</td><td>Not Applied</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_CHAT_REMOVED</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_CHAT_MESSAGES_READ</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_BACKUP</td><td>No</td><td>No</td><td>Not Applied</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_ACTIVITY_CENTER_READ</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_ACTIVITY_CENTER_ACCEPTED</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_ACTIVITY_CENTER_DISMISSED</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_BOOKMARK</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_CLEAR_HISTORY</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_SETTING</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_MESSAGE_ARCHIVE_MAGNETLINK</td><td>No</td><td>No</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_PROFILE_PICTURES</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_ACCOUNT</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_ACCEPT_CONTACT_REQUEST</td><td>Yes</td><td>Yes</td><td>OneToOne</td></tr>
<tr><td>ApplicationMetadataMessage_RETRACT_CONTACT_REQUEST</td><td>Yes</td><td>Yes</td><td>OneToOne</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_REQUEST_TO_JOIN_RESPONSE</td><td>No</td><td>Weak Yes</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_COMMUNITY_SETTINGS</td><td>Yes</td><td>Yes</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_REQUEST_CONTACT_VERIFICATION</td><td>Yes</td><td>Yes</td><td>OneToOne</td></tr>
<tr><td>ApplicationMetadataMessage_ACCEPT_CONTACT_VERIFICATION</td><td>Yes</td><td>Yes</td><td>OneToOne</td></tr>
<tr><td>ApplicationMetadataMessage_DECLINE_CONTACT_VERIFICATION</td><td>Yes</td><td>Yes</td><td>OneToOne</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_TRUSTED_USER</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_VERIFICATION_REQUEST</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_CONTACT_REQUEST_DECISION</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_REQUEST_TO_LEAVE</td><td>No</td><td>Weak Yes</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_DELETE_FOR_ME_MESSAGE</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_SAVED_ADDRESS</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_CANCEL_REQUEST_TO_JOIN</td><td>No</td><td>Yes</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_CANCEL_CONTACT_VERIFICATION</td><td>Yes</td><td>Yes</td><td>OneToOne</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_KEYPAIR</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_SOCIAL_LINKS</td><td>No</td><td>No</td><td>Not Applied</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_ENS_USERNAME_DETAIL</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_EVENTS_MESSAGE</td><td>No</td><td>No</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_EDIT_SHARED_ADDRESSES</td><td>No</td><td>No</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_ACCOUNT_CUSTOMIZATION_COLOR</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_ACCOUNTS_POSITIONS</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_PRIVILEGED_USER_SYNC_MESSAGE</td><td>No</td><td>No</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_SHARD_KEY</td><td>Yes</td><td>Yes</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_CHAT</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_ACTIVITY_CENTER_DELETED</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_ACTIVITY_CENTER_UNREAD</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_ACTIVITY_CENTER_COMMUNITY_REQUEST_DECISION</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_TOKEN_PREFERENCES</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_PUBLIC_SHARD_INFO</td><td>No</td><td>No</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_COLLECTIBLE_PREFERENCES</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_USER_KICKED</td><td>No</td><td>No</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_SYNC_PROFILE_SHOWCASE_PREFERENCES</td><td>Yes</td><td>Yes</td><td>Pair</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_PUBLIC_STORENODES_INFO</td><td>No</td><td>Weak Yes</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_REEVALUATE_PERMISSIONS_REQUEST</td><td>No</td><td>Weak Yes</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_DELETE_COMMUNITY_MEMBER_MESSAGES</td><td>No</td><td>Weak Yes</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_UPDATE_GRANT</td><td>No</td><td>Weak Yes</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_ENCRYPTION_KEYS_REQUEST</td><td>No</td><td>Yes</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_TOKEN_ACTION</td><td>No</td><td>Weak Yes</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_SHARED_ADDRESSES_REQUEST</td><td>No</td><td>No</td><td>CommunityChat</td></tr>
<tr><td>ApplicationMetadataMessage_COMMUNITY_SHARED_ADDRESSES_RESPONSE</td><td>No</td><td>No</td><td>CommunityChat</td></tr>
</tbody></table>
</div>
<h2 id="copyright-67"><a class="header" href="#copyright-67">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-54"><a class="header" href="#references-54">References</a></h2>
<ul>
<li><a href="status/raw//vac/2/mvds.html">MVDS</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="status-url-data"><a class="header" href="#status-url-data">STATUS-URL-DATA</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Status URL Data</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Felicio Mununga &lt;felicio@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Aaryamann Challani &lt;aaryamann@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-72"><a class="header" href="#timeline-72">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/raw/url-data.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/raw/url-data.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-11-20</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/ff87c84dc71d4f933bab188993914069fea12baa/status/raw/url-data.md"><code>ff87c84</code></a> — Update Waku Links (#104)</li>
<li><strong>2024-09-17</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/36f64f01f0979412fcbdf0c89143ef39442b7675/status/raw/url-data.md"><code>36f64f0</code></a> — feat(59/STATUS-URL-DATA): initial draft (#13)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-47"><a class="header" href="#abstract-47">Abstract</a></h2>
<p>This document specifies serialization, compression, and
encoding techniques used to transmit data within URLs in the context of Status protocols.</p>
<h2 id="motivation-29"><a class="header" href="#motivation-29">Motivation</a></h2>
<p>When sharing URLs,
link previews often expose metadata to the websites behind those links.
To reduce reliance on external servers for providing appropriate link previews,
this specification proposes a standard method for encoding data within URLs.</p>
<h2 id="terminology-9"><a class="header" href="#terminology-9">Terminology</a></h2>
<ul>
<li>Community: Refer to <a href="status/raw/../56/communities.html">STATUS-COMMUNITIES</a></li>
<li>Channel: Refer to terminology in <a href="status/raw/../56/communities.html">STATUS-COMMUNITIES</a></li>
<li>User: Refer to terminology in <a href="status/raw/../56/communities.html">STATUS-COMMUNITIES</a></li>
<li>Shard Refer to terminology in <a href="https://github.com/waku-org/specs/blob/master/standards/core/relay-sharding.md">WAKU2-RELAY-SHARDING</a></li>
</ul>
<h2 id="wire-format-6"><a class="header" href="#wire-format-6">Wire Format</a></h2>
<pre><code class="language-protobuf">syntax = "proto3";

message Community {
    // Display name of the community
    string display_name = 1;
    // Description of the community
    string description = 2;
    // Number of members in the community
    uint32 members_count = 3;
    // Color of the community title
    string color = 4;
    // List of tag indices
    repeated uint32 tag_indices = 5;
}

message Channel {
    // Display name of the channel
    string display_name = 1;
    // Description of the channel
    string description = 2;
    // Emoji of the channel
    string emoji = 3;
    // Color of the channel title
    string color = 4;
    // Community the channel belongs to
    Community community = 5;
    // UUID of the channel
    string uuid = 6;
}

message User {
    // Display name of the user
    string display_name = 1;
    // Description of the user
    string description = 2;
    // Color of the user title
    string color = 3;
}

message URLData {
    // Community, Channel, or User
    bytes content = 1;
    uint32 shard_cluster = 2;
    uint32 shard_index = 3;
}
</code></pre>
<h2 id="implementation"><a class="header" href="#implementation">Implementation</a></h2>
<p>The above wire format describes the data encoded in the URL.
The data MUST be serialized, compressed, and encoded using the following standards:</p>
<p>Encoding</p>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc4648">Base64url</a></li>
</ul>
<h3 id="compression"><a class="header" href="#compression">Compression</a></h3>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7932">Brotli</a></li>
</ul>
<h3 id="serialization"><a class="header" href="#serialization">Serialization</a></h3>
<ul>
<li><a href="https://protobuf.dev/reference/protobuf/proto3-spec/">Protocol buffers version 3</a></li>
</ul>
<h3 id="implementation-pseudocode"><a class="header" href="#implementation-pseudocode">Implementation Pseudocode</a></h3>
<p>Encoding</p>
<p>Encoding the URL MUST be done in the following order:</p>
<pre><code class="language-protobuf">raw_data = {User | Channel | Community}
serialized_data = protobuf_serialize(raw_data)
compressed_data = brotli_compress(serialized_data)
encoded_url_data = base64url_encode(compressed_data)
</code></pre>
<p>The <code>encoded_url_data</code> is then used to generate a signature using the private key.</p>
<h4 id="decoding"><a class="header" href="#decoding">Decoding</a></h4>
<p>Decoding the URL MUST be done in the following order:</p>
<pre><code class="language-protobuf">url_data = base64url_decode(encoded_url_data)
decompressed_data = brotli_decompress(url_data)
deserialized_data = protobuf_deserialize(decompressed_data)
raw_data = deserialized_data.content
</code></pre>
<p>The <code>raw_data</code> is then used to construct the appropriate data structure
(User, Channel, or Community).</p>
<h3 id="example"><a class="header" href="#example">Example</a></h3>
<ul>
<li>See <a href="https://github.com/status-im/status-web/pull/345/files">https://github.com/status-im/status-web/pull/345/files</a></li>
</ul>
<!-- # (Further Optional Sections) -->
<h2 id="discussions"><a class="header" href="#discussions">Discussions</a></h2>
<ul>
<li>See <a href="https://github.com/status-im/status-web/issues/327">https://github.com/status-im/status-web/issues/327</a></li>
</ul>
<h2 id="proof-of-concept-1"><a class="header" href="#proof-of-concept-1">Proof of concept</a></h2>
<ul>
<li>See <a href="https://github.com/felicio/status-web/blob/825262c4f07a68501478116c7382862607a5544e/packages/status-js/src/utils/encode-url-data.compare.test.ts#L4">https://github.com/felicio/status-web/blob/825262c4f07a68501478116c7382862607a5544e/packages/status-js/src/utils/encode-url-data.compare.test.ts#L4</a></li>
</ul>
<!-- # Security Considerations -->
<h2 id="copyright-68"><a class="header" href="#copyright-68">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-55"><a class="header" href="#references-55">References</a></h2>
<ol>
<li><a href="https://docs.google.com/spreadsheets/d/1JD4kp0aUm90piUZ7FgM_c2NGe2PdN8BFB11wmt5UZIY/edit?usp=sharing">Proposal Google Sheet</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc4648">Base64url</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7932">Brotli</a></li>
<li><a href="https://protobuf.dev/reference/protobuf/proto3-spec/">Protocol buffers version 3</a></li>
<li><a href="status/raw/./url-scheme.html">STATUS-URL-SCHEME</a></li>
</ol>
<!-- ## informative

A list of additional references. -->
<div style="break-before: page; page-break-before: always;"></div><h1 id="status-url-scheme"><a class="header" href="#status-url-scheme">STATUS-URL-SCHEME</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Status URL Scheme</td></tr>
<tr><th>Status</th><td>raw</td></tr>
<tr><th>Category</th><td>Standards Track</td></tr>
<tr><th>Editor</th><td>Felicio Mununga &lt;felicio@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-73"><a class="header" href="#timeline-73">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/raw/url-scheme.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/raw/url-scheme.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2024-09-17</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/a519e677527d7f66e9df1af94b8b5dd129877e67/status/raw/url-scheme.md"><code>a519e67</code></a> — Move Status-URL-scheme (#98)</li>
<li><strong>2024-09-13</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/3ab314d87d4525ff1296bf3d9ec634d570777b91/vac/raw/url-scheme.md"><code>3ab314d</code></a> — Fix Files for Linting (#94)</li>
<li><strong>2024-06-21</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/89cac77ae4a5fa88142f0a01185eff383b60ef09/vac/raw/url-scheme.md"><code>89cac77</code></a> — feat(60/STATUS-URL-SCHEME): initial draft (#14)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-48"><a class="header" href="#abstract-48">Abstract</a></h2>
<p>This document describes URL scheme for previewing and
deep linking content as well as for triggering actions.</p>
<h2 id="background--rationale--motivation-1"><a class="header" href="#background--rationale--motivation-1">Background / Rationale / Motivation</a></h2>
<h3 id="requirements-3"><a class="header" href="#requirements-3">Requirements</a></h3>
<h4 id="related-scope"><a class="header" href="#related-scope">Related scope</a></h4>
<h5 id="features"><a class="header" href="#features">Features</a></h5>
<ul>
<li>Onboarding website</li>
<li>Link preview</li>
<li>Link sharing</li>
<li>Deep linking</li>
<li>Routing and navigation</li>
<li>Payment requests</li>
<li>Chat creation</li>
</ul>
<h2 id="wire-format-specification--syntax-1"><a class="header" href="#wire-format-specification--syntax-1">Wire Format Specification / Syntax</a></h2>
<h3 id="schemes"><a class="header" href="#schemes">Schemes</a></h3>
<ul>
<li>Internal <code>status-app://</code></li>
<li>External <code>https://</code> (i.e. univers/deep links)</li>
</ul>
<h3 id="paths"><a class="header" href="#paths">Paths</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Url</th><th>Description</th></tr></thead><tbody>
<tr><td>User profile</td><td><code>/u/&lt;encoded_data&gt;#&lt;user_chat_key&gt;</code></td><td>Preview/Open user profile</td></tr>
<tr><td></td><td><code>/u#&lt;user_chat_key&gt;</code></td><td></td></tr>
<tr><td></td><td><code>/u#&lt;ens_name&gt;</code></td><td></td></tr>
<tr><td>Community</td><td><code>/c/&lt;encoded_data&gt;#&lt;community_chat_key&gt;</code></td><td>Preview/Open community</td></tr>
<tr><td></td><td><code>/c#&lt;community_chat_key&gt;</code></td><td></td></tr>
<tr><td>Community channel</td><td><code>/cc/&lt;encoded_data&gt;#&lt;community_chat_key &gt;</code></td><td>Preview/Open community channel</td></tr>
<tr><td></td><td><code>/cc/&lt;channel_uuid&gt;#&lt;community_chat_key&gt;</code></td><td></td></tr>
</tbody></table>
</div><!-- # Security/Privacy Considerations

A standard track RFC in `stable` status MUST feature this section.
A standard track RFC in `raw` or `draft` status SHOULD feature this section.
Informational RFCs (in any state) may feature this section.
If there are none, this section MUST explicitly state that fact.
This section MAY contain additional relevant information,
e.g. an explanation as to why there are no security consideration
for the respective document. -->
<h2 id="discussions-1"><a class="header" href="#discussions-1">Discussions</a></h2>
<ul>
<li>See <a href="https://github.com/status-im/specs/pull/159">https://github.com/status-im/specs/pull/159</a></li>
<li>See <a href="https://github.com/status-im/status-web/issues/327">https://github.com/status-im/status-web/issues/327</a></li>
</ul>
<h2 id="copyright-69"><a class="header" href="#copyright-69">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-56"><a class="header" href="#references-56">References</a></h2>
<ul>
<li><a href="status/raw/./url-data.html">STATUS-URL-DATA</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="status-deprecated-specifications"><a class="header" href="#status-deprecated-specifications">Status Deprecated Specifications</a></h1>
<p>Deprecated Status specifications maintained for archival purposes.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="3rd-party"><a class="header" href="#3rd-party">3RD-PARTY</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>3rd party</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Volodymyr Kozieiev &lt;volodymyr@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-74"><a class="header" href="#timeline-74">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/deprecated/3rd-party.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/deprecated/3rd-party.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/614348a4982aa9e519ccff8b8fbcd4c554683288/status/deprecated/3rd-party.md"><code>614348a</code></a> — Status deprecated update2 (#134)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-49"><a class="header" href="#abstract-49">Abstract</a></h2>
<p>This specification discusses 3rd party APIs that Status relies on.<br />
These APIs provide various capabilities, including:</p>
<ul>
<li>communicating with the Ethereum network,</li>
<li>allowing users to view address and transaction details on external websites,</li>
<li>retrieving fiat/crypto exchange rates,</li>
<li>obtaining information about collectibles,</li>
<li>hosting the privacy policy.</li>
</ul>
<h2 id="definitions-10"><a class="header" href="#definitions-10">Definitions</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Term</th><th>Description</th></tr></thead><tbody>
<tr><td>Fiat money</td><td>Currency established as money, often by government regulation, but without intrinsic value.</td></tr>
<tr><td>Full node</td><td>A computer, connected to the Ethereum network, that enforces all Ethereum consensus rules.</td></tr>
<tr><td>Crypto-collectible</td><td>A unique, non-fungible digital asset, distinct from cryptocurrencies where tokens are identical.</td></tr>
</tbody></table>
</div>
<h2 id="why-3rd-party-apis-can-be-a-problem"><a class="header" href="#why-3rd-party-apis-can-be-a-problem">Why 3rd Party APIs Can Be a Problem</a></h2>
<p>Relying on 3rd party APIs conflicts with Status’s censorship-resistance principle.
Since Status aims to avoid suppression of information,<br />
it is important to minimize reliance on 3rd parties that are critical to app functionality.</p>
<h2 id="3rd-party-apis-used-by-the-current-status-app"><a class="header" href="#3rd-party-apis-used-by-the-current-status-app">3rd Party APIs Used by the Current Status App</a></h2>
<h3 id="infura"><a class="header" href="#infura">Infura</a></h3>
<p><strong>What is it?</strong><br />
Infura hosts a collection of Ethereum full nodes and provides an API<br />
to access the Ethereum and IPFS networks without requiring a full node.</p>
<p><strong>How Status Uses It</strong><br />
Since Status operates on mobile devices,<br />
it cannot rely on a local node.<br />
Therefore, all Ethereum network communication happens via Infura.</p>
<p><strong>Concerns</strong><br />
Making an HTTP request can reveal user metadata,<br />
which could be exploited in attacks if Infura is compromised.<br />
Infura uses centralized hosting providers;<br />
if these providers fail or cut off service,<br />
Ethereum-dependent features in Status would be affected.</p>
<h3 id="etherscan"><a class="header" href="#etherscan">Etherscan</a></h3>
<p><strong>What is it?</strong><br />
Etherscan is a service that allows users to explore the Ethereum blockchain<br />
for transactions, addresses, tokens, prices,<br />
and other blockchain activities.</p>
<p><strong>How Status Uses It</strong><br />
The Status Wallet allows users to view address and transaction details on Etherscan.</p>
<p><strong>Concerns</strong><br />
If Etherscan becomes unavailable,<br />
users won’t be able to view address or transaction details through Etherscan.<br />
However, in-app information will still be accessible.</p>
<h3 id="cryptocompare"><a class="header" href="#cryptocompare">CryptoCompare</a></h3>
<p><strong>What is it?</strong><br />
CryptoCompare provides live crypto prices, charts, and analysis from major exchanges.</p>
<p><strong>How Status Uses It</strong><br />
Status regularly fetches crypto prices from CryptoCompare,<br />
using this information to calculate fiat values<br />
for transactions or wallet assets.</p>
<p><strong>Concerns</strong><br />
HTTP requests can reveal metadata,<br />
which could be exploited if CryptoCompare is compromised.<br />
If CryptoCompare becomes unavailable,<br />
Status won’t be able to show fiat equivalents for crypto in the wallet.</p>
<h3 id="collectibles"><a class="header" href="#collectibles">Collectibles</a></h3>
<p>Various services provide information on collectibles:</p>
<ul>
<li><a href="https://api.pixura.io/graphql">Service 1</a></li>
<li><a href="https://www.etheremon.com/api">Service 2</a></li>
<li><a href="https://us-central1-cryptostrikers-prod.cloudfunctions.net/cards/">Service 3</a></li>
<li><a href="https://api.cryptokitties.co/">Service 4</a></li>
</ul>
<p><strong>Concerns</strong><br />
HTTP requests can reveal metadata,<br />
which could be exploited if these services are compromised.</p>
<h3 id="iubenda"><a class="header" href="#iubenda">Iubenda</a></h3>
<p><strong>What is it?</strong><br />
Iubenda helps create compliance documents for websites and apps across jurisdictions.</p>
<p><strong>How Status Uses It</strong><br />
Status’s privacy policy is hosted on Iubenda.</p>
<p><strong>Concerns</strong><br />
If Iubenda becomes unavailable,<br />
users will be unable to view the app's privacy policy.</p>
<h2 id="changelog-5"><a class="header" href="#changelog-5">Changelog</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Version</th><th>Comment</th></tr></thead><tbody>
<tr><td>0.1.0</td><td>Initial release</td></tr>
</tbody></table>
</div>
<h2 id="copyright-70"><a class="header" href="#copyright-70">Copyright</a></h2>
<p>Copyright and related rights waived via CC0.</p>
<h2 id="references-57"><a class="header" href="#references-57">References</a></h2>
<ul>
<li><a href="https://api.pixura.io/graphql">GraphQL</a></li>
<li><a href="https://www.etheremon.com/api">Etheremon</a></li>
<li><a href="https://us-central1-cryptostrikers-prod.cloudfunctions.net/cards/">Cryptostrikers</a></li>
<li><a href="https://api.cryptokitties.co/">Cryptokitties</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="account"><a class="header" href="#account">ACCOUNT</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Account</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Corey Petty &lt;corey@status.im&gt;<br>Oskar Thorén &lt;oskar@status.im&gt;<br>Samuel Hawksby-Robinson &lt;samuel@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-75"><a class="header" href="#timeline-75">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/deprecated/account.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/deprecated/account.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-06-05</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/36caaa621a711c7d73b5ecc80e7ba5f938d30691/status/deprecated/account.md"><code>36caaa6</code></a> — Fix Errors rfc.vac.dev (#165)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/614348a4982aa9e519ccff8b8fbcd4c554683288/status/deprecated/account.md"><code>614348a</code></a> — Status deprecated update2 (#134)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-50"><a class="header" href="#abstract-50">Abstract</a></h2>
<p>This specification explains what a Status account is,<br />
and how a node establishes trust.</p>
<h2 id="introduction-9"><a class="header" href="#introduction-9">Introduction</a></h2>
<p>The core concept of an account in Status is a set of cryptographic keypairs.
Namely, the combination of the following:</p>
<ol>
<li>a Whisper/Waku chat identity keypair</li>
<li>a set of cryptocurrency wallet keypairs</li>
</ol>
<p>The node verifies or derives everything else associated with the contact from the above items, including:</p>
<ul>
<li>Ethereum address (future verification, currently the same base keypair)</li>
<li>3 word mnemonic name</li>
<li>identicon</li>
<li>message signatures</li>
</ul>
<h2 id="initial-key-generation-1"><a class="header" href="#initial-key-generation-1">Initial Key Generation</a></h2>
<h3 id="publicprivate-keypairs-1"><a class="header" href="#publicprivate-keypairs-1">Public/Private Keypairs</a></h3>
<ul>
<li>An ECDSA (secp256k1 curve) public/private keypair MUST be generated via a <a href="https://github.com/bitcoin/bips/blob/master/bip-0043.mediawiki">BIP43</a> derived path from a <a href="https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki">BIP39</a> mnemonic seed phrase.</li>
<li>The default paths are defined as such:
<ul>
<li>Whisper/Waku Chat Key (<code>IK</code>): <code>m/43'/60'/1581'/0'/0</code>  (post Multiaccount integration)
<ul>
<li>following <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1581.md">EIP1581</a></li>
</ul>
<!-- WE CURRENTLY DO NOT IMPLEMENT ENCRYPTION KEY, FOR FUTURE - C.P. -->
<!-- - DB encryption Key (`DBK`): `m/43'/60'/1581'/1'/0` (post Multiaccount integration) -->
<!-- - following [EIP1581](https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1581.md) -->
<ul>
<li>Status Wallet paths: <code>m/44'/60'/0'/0/i</code> starting at <code>i=0</code>
<ul>
<li>following <a href="https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki">BIP44</a></li>
<li>NOTE: this (<code>i=0</code>) is also the current (and only) path for Whisper/Waku key before Multiaccount integration</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="x3dh-prekey-bundle-creation"><a class="header" href="#x3dh-prekey-bundle-creation">X3DH Prekey bundle creation</a></h3>
<ul>
<li>
<p>Status follows the X3DH prekey bundle scheme that <a href="https://en.wikipedia.org/wiki/Signal_Messenger#2013%E2%80%932018:_Open_Whisper_Systems">Open Whisper Systems</a> (not to be confused with the Whisper sub-protocol) outlines <a href="https://signal.org/docs/specifications/x3dh/#the-x3dh-protocol">in their documentation</a> with the following exceptions:</p>
<ul>
<li>Status does not publish one-time keys <code>OPK</code> or perform DH including them, because there are no central servers in the Status implementation.</li>
</ul>
</li>
<li>
<p>A client MUST create X3DH prekey bundles, each defined by the following items:</p>
<ul>
<li>Identity Key: <code>IK</code></li>
<li>Signed prekey: <code>SPK</code></li>
<li>Prekey signature: <code>Sig(IK, Encode(SPK))</code></li>
<li>Timestamp</li>
</ul>
</li>
<li>
<p>These bundles are made available in a variety of ways, as defined in section 2.1.</p>
</li>
</ul>
<h2 id="account-broadcasting-1"><a class="header" href="#account-broadcasting-1">Account Broadcasting</a></h2>
<ul>
<li>A user is responsible for broadcasting certain information publicly so that others may contact them.</li>
</ul>
<h3 id="x3dh-prekey-bundles-1"><a class="header" href="#x3dh-prekey-bundles-1">X3DH Prekey bundles</a></h3>
<ul>
<li>A client SHOULD regenerate a new X3DH prekey bundle every 24 hours.  This MAY be done in a lazy way, such that a client that does not come online past this time period does not regenerate or broadcast bundles.</li>
<li>The current bundle SHOULD be broadcast on a Whisper/Waku topic specific to his Identity Key, <code>{IK}-contact-code</code>, intermittently.  This MAY be done every 6 hours.</li>
<li>A bundle SHOULD accompany every message sent.</li>
<li>TODO: retrieval of long-time offline users bundle via <code>{IK}-contact-code</code></li>
</ul>
<h2 id="optional-account-additions-1"><a class="header" href="#optional-account-additions-1">Optional Account additions</a></h2>
<h3 id="ens-username-1"><a class="header" href="#ens-username-1">ENS Username</a></h3>
<ul>
<li>A user MAY register a public username on the Ethereum Name System (ENS).  This username is a user-chosen subdomain of the <code>stateofus.eth</code> ENS registration that maps to their Whisper/Waku identity key (<code>IK</code>).</li>
</ul>
<!-- ### User Profile Picture
- An account MAY edit the `IK` generated identicon with a chosen picture.  This picture will become part of the publicly broadcast profile of the account. -->
<!-- TODO: Elaborate on wallet account and multiaccount -->
<!-- TODO: Elaborate on security implications -->
<h2 id="trust-establishment"><a class="header" href="#trust-establishment">Trust establishment</a></h2>
<p><strong>Trust establishment deals with users verifying they are communicating with who they think they are.</strong></p>
<h3 id="terms-glossary"><a class="header" href="#terms-glossary">Terms Glossary</a></h3>
<div class="table-wrapper"><table><thead><tr><th>term</th><th>description</th></tr></thead><tbody>
<tr><td>privkey</td><td>ECDSA secp256k1 private key</td></tr>
<tr><td>pubkey</td><td>ECDSA secp256k1 public key</td></tr>
<tr><td>Whisper/Waku key</td><td>pubkey for chat with HD derivation path m/43'/60'/1581'/0'/0</td></tr>
</tbody></table>
</div>
<h3 id="contact-discovery"><a class="header" href="#contact-discovery">Contact Discovery</a></h3>
<h4 id="public-channels"><a class="header" href="#public-channels">Public channels</a></h4>
<ul>
<li>Public group channels in Status are a broadcast/subscription system.  All public messages are encrypted with a symmetric key derived from the channel name, <code>K_{pub,sym}</code>, which is publicly known.</li>
<li>A public group channel's symmetric key MUST creation must follow the <a href="https://web3js.readthedocs.io/en/1.0/web3-shh.html#generatesymkeyfrompassword">web3 API</a>'s <code>web3.ssh.generateSymKeyFromPassword</code> function</li>
<li>In order to post to a public group channel, a client MUST have a valid account created.</li>
<li>In order to listen to a public group channel, a client must subscribe to the channel name.
The sender of a message is derived from the message's signature.</li>
<li>Discovery of channel names is not currently part of the protocol, and is typically done out of band.
If a channel name is used that has not been used, it will be created.</li>
<li>A client MUST sign the message otherwise it will be discarded by the recipients.</li>
<li>channel name specification:
<ul>
<li>matches <code>[a-z0-9\-]</code></li>
<li>is not a public key</li>
</ul>
</li>
</ul>
<h4 id="private-11-messages"><a class="header" href="#private-11-messages">Private 1:1 messages</a></h4>
<p>This can be done in the following ways:</p>
<ol>
<li>scanning a user generated QR code</li>
<li>discovery through the Status app</li>
<li>asynchronous X3DH key exchange</li>
<li>public key via public channel listening
<ul>
<li><code>status-mobile/src/status_im/contact_code/core.cljs</code></li>
</ul>
</li>
<li>contact codes</li>
<li>decentralized storage (not implemented)</li>
<li>Whisper/Waku</li>
</ol>
<h3 id="initial-key-exchange"><a class="header" href="#initial-key-exchange">Initial Key Exchange</a></h3>
<h4 id="bundles"><a class="header" href="#bundles">Bundles</a></h4>
<ul>
<li>
<p>An X3DH prekey bundle is defined as (<a href="https://github.com/status-im/status-go/messaging/chat/protobuf/encryption.pb.go">code</a>):</p>
<pre><code class="language-golang">Identity                // Identity key
SignedPreKeys           // a map of installation id to array of signed prekeys by that installation id
Signature               // Prekey signature
Timestamp               // When the bundle was lasted created locally
</code></pre>
<ul>
<li>include BundleContainer</li>
</ul>
</li>
<li>
<p>a new bundle SHOULD be created at least every 12 hours</p>
</li>
<li>
<p>a node only generates a bundle when it is used</p>
</li>
<li>
<p>a bundle SHOULD be distributed on the contact code channel. This is the Whisper and Waku topic <code>{IK}-contact-code</code>,
where <code>IK</code> is the hex encoded public key of the user, prefixed with <code>0x</code>.
The node encrypts the channel in the same way it encrypted public chats.</p>
</li>
</ul>
<h3 id="contact-verification"><a class="header" href="#contact-verification">Contact Verification</a></h3>
<p>To verify that contact key information is as it should be, use the following.</p>
<h4 id="identicon"><a class="header" href="#identicon">Identicon</a></h4>
<p>A low-poly identicon is deterministically generated from the Whisper/Waku chat public key.
This can be compared out of band to ensure the receiver's public key is the one stored locally.</p>
<h4 id="3-word-pseudonym--whisperwaku-key-fingerprint"><a class="header" href="#3-word-pseudonym--whisperwaku-key-fingerprint">3 word pseudonym / Whisper/Waku key fingerprint</a></h4>
<p>Status generates a deterministic 3-word random pseudonym from the Whisper/Waku chat public key.
This pseudonym acts as a human readable fingerprint to the Whisper/Waku chat public key.
This name also shows when viewing a contact's public profile and in the chat UI.</p>
<ul>
<li>implementation: <a href="https://github.com/status-im/status-mobile/tree/develop/src/status_im/utils/gfycat">gfycat</a></li>
</ul>
<h4 id="ens-name"><a class="header" href="#ens-name">ENS name</a></h4>
<p>Status offers the ability to register a mapping of a human readable subdomain of <code>stateofus.eth</code> to their Whisper/Waku chat public key.
The user purchases this registration (currently by staking 10 SNT)
and the node stores it on the Ethereum mainnet blockchain for public lookup.</p>
<!-- TODO: Elaborate on security implications -->
<!-- TODO: Incorporate or cut below into proper spec

### Possible Connection Breakdown

possible connections
- client - client (not really ever, this is facilitated through all other connections)
    - personal chat
        - ratcheted with X3DH
    - private group chat
        - pairwise ratcheted with X3DH
    - public chat
- client - mailserver (statusd + ???)
    - a mailserver identifies itself by an [enode address](https://github.com/ethereum/wiki/wiki/enode-url-format) 
- client - Whisper/Waku node (statusd)
    - a node identifies itself by an enode address
- client - bootnode (go-ethereum)
    - a bootnode identifies itself by
        - an enode address
        - `NOTE: redezvous information here`
- client - ENS registry (ethereum blockchain -> default to infura)
- client - Ethereum RPC (custom go-ethereum RPC API -> default to infura API)
- client - IPFS (Status hosted IPFS gateway -> defaults to ???)
    - we have a status hosted IPFS gateway for pinning but it currently isn't used much.

### Notes

A user in the system is a public-private key pair using the Elliptic-Curve Cryptography secp256k1 that Ethereum uses.
- A 3-word random name is derived from the public key using the following package
    - `NOTE: need to find package`
    - This provides an associated human-readble fingerprint to the user's public key
- A user can optionally add additional layers on top of this keypair
    - Chosen username
    - ENS username

All messages sent are encrypted with the public key of the destination and signed by the private key of the given user using the following scheme:
- private chat
    - X3DH is used to define shared secrets which is then double ratcheted
- private group chat
    - considered pairwise private chats 
- public group chat
    - the message is encrypted with a symmetric key derived from the chat name

-->
<h2 id="public-key-serialization"><a class="header" href="#public-key-serialization">Public Key Serialization</a></h2>
<p>Idiomatically known as "public key compression" and "public key decompression".</p>
<p>The node SHOULD provide functionality for the serialization and deserialization of public / chat keys.</p>
<p>For maximum flexibility, when implementing this functionality, the node MUST support public keys encoded in a range of encoding formats, detailed below.</p>
<h3 id="basic-serialization-example"><a class="header" href="#basic-serialization-example">Basic Serialization Example</a></h3>
<p>In the example of a typical hexadecimal encoded elliptical curve (EC) public key (such as a secp256k1 pk),</p>
<pre><code class="language-text">0x04261c55675e55ff25edb50b345cfb3a3f35f60712d251cbaaab97bd50054c6ebc3cd4e22200c68daf7493e1f8da6a190a68a671e2d3977809612424c7c3888bc6
</code></pre>
<p>minor modification for compatibility and flexibility makes the key self-identifiable and easily parsable,</p>
<pre><code class="language-text">fe70104261c55675e55ff25edb50b345cfb3a3f35f60712d251cbaaab97bd50054c6ebc3cd4e22200c68daf7493e1f8da6a190a68a671e2d3977809612424c7c3888bc6
</code></pre>
<p>EC serialization and compact encoding produces a much smaller string representation of the original key.</p>
<pre><code class="language-text">zQ3shPyZJnxZK4Bwyx9QsaksNKDYTPmpwPvGSjMYVHoXHeEgB
</code></pre>
<h3 id="public-key-compression-rationale"><a class="header" href="#public-key-compression-rationale">Public Key "Compression" Rationale</a></h3>
<p>Serialized and compactly encoded ("compressed") public keys have a number of UI / UX advantages
over non-serialized less densely encoded public keys.</p>
<p>Compressed public keys are smaller, and users may perceive them as less intimidating and less unnecessarily large.
Compare the "compressed" and "uncompressed" version of the same public key from above example:</p>
<ul>
<li><code>0xe70104261c55675e55ff25edb50b345cfb3a3f35f60712d251cbaaab97bd50054c6ebc3cd4e22200c68daf7493e1f8da6a190a68a671e2d3977809612424c7c3888bc6</code></li>
<li><code>zQ3shPyZJnxZK4Bwyx9QsaksNKDYTPmpwPvGSjMYVHoXHeEgB</code></li>
</ul>
<p>The user can transmit and share the same data, but at one third of the original size.
136 characters uncompressed vs 49 characters compressed, giving a significant character length reduction of 64%.</p>
<p>The user client app MAY use the compressed public keys throughout the user interface.
For example in the <code>status-mobile</code> implementation of the user interface
the following places could take advantage of a significantly smaller public key:</p>
<ul>
<li><code>Onboarding</code> &gt; <code>Choose a chat name</code></li>
<li><code>Profile</code> &gt; <code>Header</code></li>
<li><code>Profile</code> &gt; <code>Share icon</code> &gt; <code>QR code popover</code></li>
<li><code>Invite friends</code> url from <code>Invite friends</code> button and <code>+ -button</code> &gt; <code>Invite friends</code></li>
<li>Other user <code>Profile details</code></li>
<li><code>Profile details</code> &gt; <code>Share icon</code> &gt; <code>QR code popover</code></li>
</ul>
<p>In the case of QR codes a compressed public key can reduce the complexity of the derived codes:</p>
<div class="table-wrapper"><table><thead><tr><th>Uncompressed</th></tr></thead><tbody>
<tr><td><img src="status/deprecated//status/deprecated/images/qr-code1-accountmd.png" alt="image" /></td></tr>
</tbody></table>
</div><div class="table-wrapper"><table><thead><tr><th>Compressed</th></tr></thead><tbody>
<tr><td><img src="status/deprecated//status/deprecated/images/qr-code2-accountmd.png" alt="image" /></td></tr>
</tbody></table>
</div>
<h3 id="key-encoding"><a class="header" href="#key-encoding">Key Encoding</a></h3>
<p>When implementing the pk de/serialization functionality, the node MUST use the <a href="https://github.com/multiformats/multibase">multiformats/multibase</a>
encoding protocol to interpret incoming key data and to return key data in a desired encoding.</p>
<p>The node SHOULD support the following <code>multibase</code> encoding formats.</p>
<pre><code class="language-csv">encoding,          code, description,                                              status
identity,          0x00, 8-bit binary (encoder and decoder keeps data unmodified), default
base2,             0,    binary (01010101),                                        candidate
base8,             7,    octal,                                                    draft
base10,            9,    decimal,                                                  draft
base16,            f,    hexadecimal,                                              default
base16upper,       F,    hexadecimal,                                              default
base32hex,         v,    rfc4648 case-insensitive - no padding - highest char,     candidate
base32hexupper,    V,    rfc4648 case-insensitive - no padding - highest char,     candidate
base32hexpad,      t,    rfc4648 case-insensitive - with padding,                  candidate
base32hexpadupper, T,    rfc4648 case-insensitive - with padding,                  candidate
base32,            b,    rfc4648 case-insensitive - no padding,                    default
base32upper,       B,    rfc4648 case-insensitive - no padding,                    default
base32pad,         c,    rfc4648 case-insensitive - with padding,                  candidate
base32padupper,    C,    rfc4648 case-insensitive - with padding,                  candidate
base32z,           h,    z-base-32 (used by Tahoe-LAFS),                           draft
base36,            k,    base36 [0-9a-z] case-insensitive - no padding,            draft
base36upper,       K,    base36 [0-9a-z] case-insensitive - no padding,            draft
base58btc,         z,    base58 bitcoin,                                           default
base58flickr,      Z,    base58 flicker,                                           candidate
base64,            m,    rfc4648 no padding,                                       default
base64pad,         M,    rfc4648 with padding - MIME encoding,                     candidate
base64url,         u,    rfc4648 no padding,                                       default
base64urlpad,      U,    rfc4648 with padding,                                     default
</code></pre>
<p><strong>Note</strong> this specification RECOMMENDs that implementations extend the standard <code>multibase</code> protocol
to parse strings prepended with <code>0x</code> as <code>f</code> hexadecimal encoded bytes.</p>
<p>Implementing this recommendation will allow the node to correctly interpret traditionally identified hexadecimal strings (e.g. <code>0x1337c0de</code>).</p>
<p><em>Example:</em></p>
<p><code>0xe70102261c55675e55ff25edb50b345cfb3a3f35f60712d251cbaaab97bd50054c6ebc</code></p>
<p>SHOULD be interpreted as</p>
<p><code>fe70102261c55675e55ff25edb50b345cfb3a3f35f60712d251cbaaab97bd50054c6ebc</code></p>
<p>This specification RECOMMENDs that the consuming service of the node uses a compact encoding type,
such as base64 or base58 to allow for as short representations of the key as possible.</p>
<h3 id="public-key-types"><a class="header" href="#public-key-types">Public Key Types</a></h3>
<p>When implementing the pk de/serialization functionality, The node MUST support the <a href="https://github.com/multiformats/multicodec">multiformats/multicodec</a> key type identifiers for the following public key type.</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Tag</th><th>Code</th><th>Description</th></tr></thead><tbody>
<tr><td><code>secp256k1-pub</code></td><td>key</td><td><code>0xe7</code></td><td>Secp256k1 public key</td></tr>
</tbody></table>
</div>
<p>For a public key to be identifiable to the node the public key data MUST be prepended with the relevant <a href="https://github.com/multiformats/unsigned-varint">multiformats/unsigned-varint</a> formatted code.</p>
<p><em>Example:</em></p>
<p>Below is a representation of an deserialized secp256k1 public key.</p>
<pre><code class="language-text">04
26 | 1c | 55 | 67 | 5e | 55 | ff | 25
ed | b5 | 0b | 34 | 5c | fb | 3a | 3f
35 | f6 | 07 | 12 | d2 | 51 | cb | aa
ab | 97 | bd | 50 | 05 | 4c | 6e | bc
3c | d4 | e2 | 22 | 00 | c6 | 8d | af
74 | 93 | e1 | f8 | da | 6a | 19 | 0a
68 | a6 | 71 | e2 | d3 | 97 | 78 | 09
61 | 24 | 24 | c7 | c3 | 88 | 8b | c6
</code></pre>
<p>The <code>multicodec</code> code for a secp256k1 public key is <code>0xe7</code>.</p>
<p>After parsing the code <code>0xe7</code> as a <code>multiformats/uvarint</code>, the byte value is <code>0xe7 0x01</code>, prepending this to the public key results in the below representation.</p>
<pre><code class="language-text">e7 | 01 | 04
26 | 1c | 55 | 67 | 5e | 55 | ff | 25
ed | b5 | 0b | 34 | 5c | fb | 3a | 3f
35 | f6 | 07 | 12 | d2 | 51 | cb | aa
ab | 97 | bd | 50 | 05 | 4c | 6e | bc
3c | d4 | e2 | 22 | 00 | c6 | 8d | af
74 | 93 | e1 | f8 | da | 6a | 19 | 0a
68 | a6 | 71 | e2 | d3 | 97 | 78 | 09
61 | 24 | 24 | c7 | c3 | 88 | 8b | c6
</code></pre>
<h3 id="deserialization-process-flow"><a class="header" href="#deserialization-process-flow">De/Serialization Process Flow</a></h3>
<p>When implementing the pk de/serialization functionality, the node MUST be passed a <code>multicodec</code> identified public key,
of the above supported types, encoded with a valid <code>multibase</code> identifier.</p>
<p>This specification RECOMMENDs that the node also accept an encoding type parameter to encode the output data.
This provides for the case where the user requires the de/serialization key to be in a different encoding to the encoding of the given key.</p>
<h4 id="serialization-example"><a class="header" href="#serialization-example">Serialization Example</a></h4>
<p>A hexadecimal encoded secp256k1 public chat key typically is represented as below:</p>
<pre><code class="language-text">0x04261c55675e55ff25edb50b345cfb3a3f35f60712d251cbaaab97bd50054c6ebc3cd4e22200c68daf7493e1f8da6a190a68a671e2d3977809612424c7c3888bc6
</code></pre>
<p>To be properly interpreted by the node for serialization the public key MUST be prepended with the <code>multicodec</code> <code>uvarint</code> code <code>0xea 0x01</code>
and encoded with a valid <code>multibase</code> encoding, therefore giving the following:</p>
<pre><code class="language-text">fea0104261c55675e55ff25edb50b345cfb3a3f35f60712d251cbaaab97bd50054c6ebc3cd4e22200c68daf7493e1f8da6a190a68a671e2d3977809612424c7c3888bc6
</code></pre>
<p>If adhering to the specification recommendation to provide the user with an output encoding parameter,
the above string would be passed to the node with the following <code>multibase</code> encoding identifier.</p>
<p>In this example the output encoding is defined as <code>base58 bitcoin</code>.</p>
<pre><code class="language-text">z
</code></pre>
<p>The return value in this case would be</p>
<pre><code class="language-text">zQ3shPyZJnxZK4Bwyx9QsaksNKDYTPmpwPvGSjMYVHoXHeEgB
</code></pre>
<p>Which after <code>multibase</code> decoding can be represented in bytes as below:</p>
<pre><code class="language-text">e7 | 01 | 02
26 | 1c | 55 | 67 | 5e | 55 | ff | 25
ed | b5 | 0b | 34 | 5c | fb | 3a | 3f
35 | f6 | 07 | 12 | d2 | 51 | cb | aa
ab | 97 | bd | 50 | 05 | 4c | 6e | bc
</code></pre>
<h4 id="deserialization-example"><a class="header" href="#deserialization-example">Deserialization Example</a></h4>
<p>For the user, the deserialization process is exactly the same as serialization with the exception
that the user MUST provide a serialized public key for deserialization. Else the deserialization algorithm will fail.</p>
<p>For further guidance on the implementation of public key de/serialization consult the <a href="https://github.com/status-im/status-go/blob/c9772325f2dca76b3504191c53313663ca2efbe5/api/utils_test.go"><code>status-go</code> implementation and tests</a>.</p>
<h2 id="security-considerations-23"><a class="header" href="#security-considerations-23">Security Considerations</a></h2>
<ul>
<li></li>
</ul>
<h2 id="changelog-6"><a class="header" href="#changelog-6">Changelog</a></h2>
<h3 id="version-04-3"><a class="header" href="#version-04-3">Version 0.4</a></h3>
<p>Released <a href="https://github.com/status-im/specs/commit/e98a9b76b7d4e1ce93e0b692e1521c2d54f72c59">June 24, 2020</a></p>
<ul>
<li>Added details of public key serialization and deserialization</li>
</ul>
<h3 id="version-03-3"><a class="header" href="#version-03-3">Version 0.3</a></h3>
<p>Released <a href="https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8">May 22, 2020</a></p>
<ul>
<li>Added language to include Waku in all relevant places</li>
<li>Change to keep <code>Mailserver</code> term consistent</li>
<li>Added clarification to Open Whisper Systems</li>
</ul>
<h2 id="copyright-71"><a class="header" href="#copyright-71">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-58"><a class="header" href="#references-58">References</a></h2>
<ul>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0043.mediawiki">BIP43</a></li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki">BIP39</a></li>
<li><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1581.md">EIP1581</a></li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki">BIP44</a></li>
<li><a href="https://en.wikipedia.org/wiki/Signal_Messenger#2013%E2%80%932018:_Open_Whisper_Systems">Open Whisper Systems</a></li>
<li><a href="https://signal.org/docs/specifications/x3dh/#the-x3dh-protocol">X3DH</a></li>
<li><a href="https://web3js.readthedocs.io/en/1.0/web3-shh.html#generatesymkeyfrompassword">web3 API</a></li>
<li><a href="https://github.com/status-im/status-go/messaging/chat/protobuf/encryption.pb.go">Protobuf encryption</a></li>
<li><a href="https://github.com/status-im/status-mobile/tree/develop/src/status_im/utils/gfycat">gfycat in Status</a></li>
<li><a href="https://github.com/multiformats/">multiformats</a></li>
<li><a href="https://github.com/status-im/status-go/blob/c9772325f2dca76b3504191c53313663ca2efbe5/api/utils_test.go">status-go implementation and tests</a></li>
<li><a href="https://github.com/status-im/specs/commit/e98a9b76b7d4e1ce93e0b692e1521c2d54f72c59">June 24, 2020 change commit</a></li>
<li><a href="https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8">May 22, 2020 change commit</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="client"><a class="header" href="#client">CLIENT</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Client</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Adam Babik &lt;adam@status.im&gt;<br>Andrea Maria Piana &lt;andreap@status.im&gt;<br>Dean Eigenmann &lt;dean@status.im&gt;<br>Corey Petty &lt;corey@status.im&gt;<br>Oskar Thorén &lt;oskar@status.im&gt;<br>Samuel Hawksby-Robinson &lt;samuel@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-76"><a class="header" href="#timeline-76">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/deprecated/client.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/deprecated/client.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/614348a4982aa9e519ccff8b8fbcd4c554683288/status/deprecated/client.md"><code>614348a</code></a> — Status deprecated update2 (#134)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-51"><a class="header" href="#abstract-51">Abstract</a></h2>
<p>This specification describes how to write a Status client for communicating<br />
with other Status clients.<br />
This specification presents a reference implementation of the protocol
used in a command-line client and a mobile app.</p>
<p>This document consists of two parts.<br />
The first outlines the specifications required to be a full Status client.<br />
The second provides a design rationale and answers some common questions.</p>
<h2 id="introduction-10"><a class="header" href="#introduction-10">Introduction</a></h2>
<h3 id="protocol-layers"><a class="header" href="#protocol-layers">Protocol layers</a></h3>
<p>Implementing a Status clients largely means implementing the following layers.
Additionally, there are separate specifications for things like key management and account lifecycle.</p>
<p>Other aspects, such as how a node uses IPFS for stickers or how the browser works, are currently underspecified.
These specifications facilitate the implementation of a Status client for basic private communication.</p>
<div class="table-wrapper"><table><thead><tr><th>Layer</th><th>Purpose</th><th>Technology</th></tr></thead><tbody>
<tr><td>Data and payloads</td><td>End user functionality</td><td>1:1, group chat, public chat</td></tr>
<tr><td>Data sync</td><td>Data consistency</td><td>MVDS.</td></tr>
<tr><td>Secure transport</td><td>Confidentiality, PFS, etc</td><td>Double Ratchet</td></tr>
<tr><td>Transport privacy</td><td>Routing, Metadata protection</td><td>Waku / Whisper</td></tr>
<tr><td>P2P Overlay</td><td>Overlay routing, NAT traversal</td><td>devp2p</td></tr>
</tbody></table>
</div>
<h3 id="protobuf-1"><a class="header" href="#protobuf-1">Protobuf</a></h3>
<p><a href="https://developers.google.com/protocol-buffers/"><code>protobuf</code></a> is used in different layers, version <code>proto3</code> used is unless stated otherwise.</p>
<h2 id="components"><a class="header" href="#components">Components</a></h2>
<h3 id="p2p-overlay"><a class="header" href="#p2p-overlay">P2P Overlay</a></h3>
<p>Status clients run on a public, permissionless peer-to-peer network, as specified by the devP2P
network protocols. devP2P provides a protocol for node discovery which is in
draft mode
<a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5.md">here</a>. See
more on node discovery and management in the next section.</p>
<p>To communicate between Status nodes, the <a href="https://github.com/ethereum/devp2p/blob/master/rlpx.md">RLPx Transport
Protocol, v5</a> is used, which
allows for TCP-based communication between nodes.</p>
<p>On top of this RLPx-based subprotocols are ran, the client
SHOULD NOT use <a href="https://eips.ethereum.org/EIPS/eip-627">Whisper V6</a>, the client
SHOULD use <a href="status/deprecated//waku/standards/legacy/6/waku1.html">Waku V1</a>
for privacy-preserving messaging and efficient usage of a node's bandwidth.</p>
<h4 id="node-discovery-and-roles"><a class="header" href="#node-discovery-and-roles">Node discovery and roles</a></h4>
<p>There are four types of node roles:</p>
<ol>
<li><code>Bootstrap node</code></li>
<li><code>Whisper/Waku relayer</code></li>
<li><code>Mailserver</code> (servers and clients)</li>
<li><code>Mobile node</code> (Status Clients)</li>
</ol>
<p>A standard Status client MUST implement both <code>Whisper/Waku relayer</code> and <code>Mobile node</code> node types. The
other node types are optional, but it is RECOMMEND to implement a <code>Mailserver</code>
client mode, otherwise the user experience is likely to be poor.</p>
<h4 id="bootstrapping-1"><a class="header" href="#bootstrapping-1">Bootstrapping</a></h4>
<p>Bootstrap nodes allow Status nodes to discover and connect to other Status nodes
in the network.</p>
<p>Currently, Status Gmbh provides the main bootstrap nodes, but anyone can
run these provided they are connected to the rest of the Whisper/Waku network.</p>
<p>Status maintains a list of production fleet bootstrap nodes in the following locations:</p>
<p><strong>Hong Kong:</strong></p>
<ul>
<li><code>enode://6e6554fb3034b211398fcd0f0082cbb6bd13619e1a7e76ba66e1809aaa0c5f1ac53c9ae79cf2fd4a7bacb10d12010899b370c75fed19b991d9c0cdd02891abad@47.75.99.169:443</code></li>
<li><code>enode://23d0740b11919358625d79d4cac7d50a34d79e9c69e16831c5c70573757a1f5d7d884510bc595d7ee4da3c1508adf87bbc9e9260d804ef03f8c1e37f2fb2fc69@47.52.106.107:443</code></li>
</ul>
<p><strong>Amsterdam:</strong></p>
<ul>
<li><code>enode://436cc6f674928fdc9a9f7990f2944002b685d1c37f025c1be425185b5b1f0900feaf1ccc2a6130268f9901be4a7d252f37302c8335a2c1a62736e9232691cc3a@178.128.138.128:443</code></li>
<li><code>enode://5395aab7833f1ecb671b59bf0521cf20224fe8162fc3d2675de4ee4d5636a75ec32d13268fc184df8d1ddfa803943906882da62a4df42d4fccf6d17808156a87@178.128.140.188:443</code></li>
</ul>
<p><strong>Central US:</strong></p>
<ul>
<li><code>enode://32ff6d88760b0947a3dee54ceff4d8d7f0b4c023c6dad34568615fcae89e26cc2753f28f12485a4116c977be937a72665116596265aa0736b53d46b27446296a@34.70.75.208:443</code></li>
<li><code>enode://5405c509df683c962e7c9470b251bb679dd6978f82d5b469f1f6c64d11d50fbd5dd9f7801c6ad51f3b20a5f6c7ffe248cc9ab223f8bcbaeaf14bb1c0ef295fd0@35.223.215.156:443</code></li>
</ul>
<p>These bootstrap nodes MAY change and are not guaranteed to stay this way forever
and at some point circumstances might force them to change.</p>
<h4 id="discovery-2"><a class="header" href="#discovery-2">Discovery</a></h4>
<p>A Status client MUST discover or have a list of peers to connect to. Status uses a
light discovery mechanism based on a combination of <a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5.md">Discovery v5</a> and
<a href="https://github.com/libp2p/specs/tree/master/rendezvous">Rendezvous Protocol</a>,
(with some <a href="https://github.com/status-im/rendezvous#differences-with-original-rendezvous">modifications</a>).
Additionally, some static nodes MAY also be used.</p>
<p>A Status client MUST use at least one discovery method or use static nodes
to communicate with other clients.</p>
<p>Discovery V5 uses bootstrap nodes to discover other peers. Bootstrap nodes MUST support
Discovery V5 protocol as well in order to provide peers. It is kademlia-based discovery mechanism
and it might consume significant (at least on mobile) amount of network traffic to operate.</p>
<p>In order to take advantage from simpler and more mobile-friendly peers discovery mechanism,
i.e. Rendezvous protocol, one MUST provide a list of Rendezvous nodes which speak
Rendezvous protocol. Rendezvous protocol is request-response discovery mechanism.
It uses Ethereum Node Records (ENR) to report discovered peers.</p>
<p>Both peers discovery mechanisms use topics to provide peers with certain capabilities.
There is no point in returning peers that do not support a particular protocol.
Status nodes that want to be discovered MUST register to Discovery V5 and/or Rendezvous
with the <code>whisper</code> topic. Status nodes that are <code>Mailservers</code> and want to
be discoverable MUST additionally register with the <code>whispermail</code> topic.</p>
<p>It is RECOMMENDED to use both mechanisms but at the same time implement a structure
called <code>PeerPool</code>. <code>PeerPool</code> is responsible for maintaining an optimal number of peers.
For mobile nodes, there is no significant advantage to have more than 2-3 peers and one <code>Mailserver</code>.
<code>PeerPool</code> can notify peers discovery protocol implementations that they should suspend
their execution because the optimal number of peers is found. They should resume
if the number of connected peers drops or a <code>Mailserver</code> disconnects.</p>
<p>It is worth noticing that an efficient caching strategy MAY be of great use, especially,
on mobile devices. Discovered peers can be cached as they rarely change and used
when the client starts again. In such a case, there might be no need to even start
peers discovery protocols because cached peers will satisfy the optimal number of peers.</p>
<p>Alternatively, a client MAY rely exclusively on a list of static peers. This is the most efficient
way because there are no peers discovery algorithm overhead introduced. The disadvantage
is that these peers might be gone and without peers discovery mechanism, it won't be possible to find
new ones.</p>
<p>The current list of static peers is published on <a href="https://fleets.status.im/">https://fleets.status.im/</a>. <code>eth.prod</code> is the current
group of peers the official Status client uses. The others are test networks.</p>
<p>Finally, Waku node addresses can be retrieved by traversing
the merkle tree found at <a href="https://fleets.status.im"><code>fleets.status.im</code></a>, as described in <a href="https://eips.ethereum.org/EIPS/eip-1459#client-protocol">EIP-1459</a>.</p>
<h4 id="mobile-nodes"><a class="header" href="#mobile-nodes">Mobile nodes</a></h4>
<p>A <code>Mobile node</code> is a Whisper and/or Waku node which connects to part of the respective Whisper
and/or Waku network(s). A <code>Mobile node</code> MAY relay messages. See next section for more details on how
to use Whisper and/or Waku to communicate with other Status nodes.</p>
<h3 id="transport-privacy-and-whisper--waku-usage"><a class="header" href="#transport-privacy-and-whisper--waku-usage">Transport privacy and Whisper / Waku usage</a></h3>
<p>Once a Whisper and/or Waku node is up and running there are some specific settings required
to communicate with other Status nodes.</p>
<p>See <a href="status/deprecated//status/deprecated/whisper-usage.html">WHISPER-USAGE</a> and <a href="status/deprecated//status/deprecated/waku-usage.html">WAKU-USAGE</a> for more details.</p>
<p>For providing an offline inbox, see the complementary <a href="status/deprecated//status/deprecated/whisper-mailserver.html">WHISPER-MAILSERVER</a> and <a href="status/deprecated//status/deprecated/waku-mailserver.html">WAKU-MAILSERVER</a>.</p>
<h3 id="secure-transport-1"><a class="header" href="#secure-transport-1">Secure Transport</a></h3>
<p>In order to provide confidentiality, integrity, authentication and forward
secrecy of messages the node implements a secure transport on top of Whisper and Waku. This is
used in 1:1 chats and group chats, but not for public chats. See <a href="status/deprecated//status/deprecated/secure-transport.html">SECURE-TRANSPORT</a> for more.</p>
<h3 id="data-sync"><a class="header" href="#data-sync">Data Sync</a></h3>
<p><a href="status/deprecated//vac/2/mvds.html">MVDS</a> is used for 1:1 and group chats, however it is currently not in use for public chats.
<a href="status/deprecated/client.html#payloads-and-clients">Status payloads</a> are serialized and then wrapped inside an
MVDS message which is added to an <a href="status/deprecated//vac/2/mvds.html#payloads">MVDS payload</a>,
the node encrypts this payload (if necessary for 1-to-1 / group-chats) and sends it using
Whisper or Waku which also encrypts it.</p>
<h3 id="payloads-and-clients"><a class="header" href="#payloads-and-clients">Payloads and clients</a></h3>
<p>On top of secure transport, various types of data sync clients and
the node uses payload formats for things like 1:1 chat, group chat and public chat. These have
various degrees of standardization. Please refer to <a href="status/deprecated//status/deprecated/payloads.html">PAYLOADS</a> for more details.</p>
<h3 id="bips-and-eips-standards-support"><a class="header" href="#bips-and-eips-standards-support">BIPs and EIPs Standards support</a></h3>
<p>For a list of EIPs and BIPs that SHOULD be supported by Status client, please
see <a href="status/deprecated//status/deprecated/eips.html">EIPS</a>.</p>
<h2 id="security-considerations-24"><a class="header" href="#security-considerations-24">Security Considerations</a></h2>
<p>See <a href="status/deprecated/client.html#appendix-a-security-considerations">Appendix A</a></p>
<h2 id="design-rationale"><a class="header" href="#design-rationale">Design Rationale</a></h2>
<p>P2P Overlay</p>
<h3 id="why-devp2p-why-not-use-libp2p"><a class="header" href="#why-devp2p-why-not-use-libp2p">Why devp2p? Why not use libp2p?</a></h3>
<p>At the time Status developed the main Status clients, devp2p was the most
mature. However, in the future libp2p is likely to be used, as it'll
provide us with multiple transports, better protocol negotiation, NAT traversal,
etc.</p>
<p>For very experimental bridge support, see the bridge between libp2p and devp2p
in <a href="https://github.com/status-im/murmur">Murmur</a>.</p>
<h3 id="what-about-other-rlpx-subprotocols-like-les-and-swarm"><a class="header" href="#what-about-other-rlpx-subprotocols-like-les-and-swarm">What about other RLPx subprotocols like LES, and Swarm?</a></h3>
<p>Status is primarily optimized for resource restricted devices, and at present
time light client support for these protocols are suboptimal. This is a work in
progress.</p>
<p>For better Ethereum light client support, see <a href="https://github.com/status-im/status-go/issues/1025">Re-enable LES as
option</a>. For better Swarm
support, see <a href="https://github.com/ethersphere/SWIPs/pull/12">Swarm adaptive
nodes</a>.</p>
<p>For transaction support, Status clients currently have to rely on Infura.</p>
<p>Status clients currently do not offer native support for file storage.</p>
<h3 id="why-do-you-use-whisper"><a class="header" href="#why-do-you-use-whisper">Why do you use Whisper?</a></h3>
<p>Whisper is one of the <a href="http://gavwood.com/dappsweb3.html">three parts</a> of the
vision of Ethereum as the world computer, Ethereum and Swarm being the other
two. Status was started as an encapsulation of and a clear window to this world
computer.</p>
<h3 id="why-do-you-use-waku"><a class="header" href="#why-do-you-use-waku">Why do you use Waku?</a></h3>
<p>Waku is a direct upgrade and replacement for Whisper, the main motivation for
developing and implementing Waku can be found in the <a href="status/deprecated//waku/">Waku specs</a>.</p>
<blockquote>
<p>Waku was created to incrementally improve in areas that Whisper is lacking in,
with special attention to resource restricted devices. We specify the standard for
Waku messages in order to ensure forward compatibility of different Waku clients,
backwards compatibility with Whisper clients, as well as to allow multiple
implementations of Waku and its capabilities. We also modify the language to be more
unambiguous, concise and consistent.</p>
</blockquote>
<p>Considerable work has gone into the active development of Ethereum, in contrast Whisper
is not currently under active development, and it has several drawbacks. Among others:</p>
<ul>
<li>Whisper is very wasteful bandwidth-wise and doesn't appear to be scalable</li>
<li>Proof of work is a poor spam protection mechanism for heterogeneous devices</li>
<li>The privacy guarantees provided are not rigorous</li>
<li>There are no incentives to run a node</li>
</ul>
<p>Finding a more suitable transport privacy is an ongoing research effort,
together with <a href="https://vac.dev/vac-overview">Vac</a> and other teams in the space.</p>
<h3 id="why-is-pow-for-waku-set-so-low"><a class="header" href="#why-is-pow-for-waku-set-so-low">Why is PoW for Waku set so low?</a></h3>
<p>A higher PoW would be desirable, but this kills the battery on mobile phones,
which is a prime target for Status clients.</p>
<p>This means the network is currently vulnerable to DDoS attacks. Alternative
methods of spam protection are currently being researched.</p>
<h3 id="why-do-you-not-use-discovery-v5-for-node-discovery"><a class="header" href="#why-do-you-not-use-discovery-v5-for-node-discovery">Why do you not use Discovery v5 for node discovery?</a></h3>
<p>At the time of implementing dynamic node discovery, Discovery v5 wasn't completed
yet. Additionally, running a DHT on a mobile leads to slow node discovery, bad
battery and poor bandwidth usage. Instead, each client can choose to turn on
Discovery v5 for a short period until the node populates their peer list.</p>
<p>For some further investigation, see
<a href="https://github.com/status-im/swarms/blob/master/ideas/092-disc-v5-research.md">here</a>.</p>
<h3 id="i-heard-something-about-mailservers-being-trusted-somehow"><a class="header" href="#i-heard-something-about-mailservers-being-trusted-somehow">I heard something about <code>Mailservers</code> being trusted somehow?</a></h3>
<p>In order to use a <code>Mailserver</code>, a given node needs to connect to it directly, i.e. add the <code>Mailserver</code>
as its peer and mark it as trusted.
This means that the <code>Mailserver</code> is able to send direct p2p messages to the node instead of broadcasting them.
Effectively, it knows the bloom filter of the topics the node is interested in,
when it is online as well as many metadata like IP address.</p>
<h3 id="data-sync-1"><a class="header" href="#data-sync-1">Data sync</a></h3>
<h4 id="why-is-mvds-not-used-for-public-chats"><a class="header" href="#why-is-mvds-not-used-for-public-chats">Why is MVDS not used for public chats?</a></h4>
<p>Currently, public chats are broadcast-based, and there's no direct way of finding
out who is receiving messages. Hence there's no clear group sync state context
whereby participants can sync. Additionally, MVDS is currently not optimized for
large group contexts, which means bandwidth usage will be a lot higher than
reasonable. See <a href="https://vac.dev/p2p-data-sync-for-mobile">P2P Data Sync for Mobile</a> for more.
This is an active area of research.</p>
<h2 id="footnotes-5"><a class="header" href="#footnotes-5">Footnotes</a></h2>
<ol>
<li><a href="https://github.com/status-im/status-protocol-go/">https://github.com/status-im/status-protocol-go/</a></li>
<li><a href="https://github.com/status-im/status-console-client/">https://github.com/status-im/status-console-client/</a></li>
<li><a href="https://github.com/status-im/status-mobile/">https://github.com/status-im/status-mobile/</a></li>
</ol>
<h2 id="appendix-a-security-considerations-4"><a class="header" href="#appendix-a-security-considerations-4">Appendix A: Security considerations</a></h2>
<p>There are several security considerations to take into account when running Status.
Chief among them are: scalability, DDoS-resistance and privacy.
These also vary depending on what capabilities are used, such as <code>Mailserver</code>, light node, and so on.</p>
<h3 id="scalability-and-ux-2"><a class="header" href="#scalability-and-ux-2">Scalability and UX</a></h3>
<p><strong>Bandwidth usage:</strong></p>
<p>In version 1 of Status, bandwidth usage is likely to be an issue.
In Status version 1.1 this is partially addressed with Waku usage, see <a href="https://github.com/vacp2p/research/tree/dcc71f4779be832d3b5ece9c4e11f1f7ec24aac2/whisper_scalability">the theoretical scaling model</a>.</p>
<p><strong><code>Mailserver</code> High Availability requirement:</strong></p>
<p>A <code>Mailserver</code> has to be online to receive messages for other nodes, this puts a high availability requirement on it.</p>
<p><strong>Gossip-based routing:</strong></p>
<p>Use of gossip-based routing doesn't necessarily scale.
It means each node can see a message multiple times,
and having too many light nodes can cause propagation probability that is too low.
See <a href="https://our.status.im/whisper-pss-comparison/">Whisper vs PSS</a> for more and a possible Kademlia based alternative.</p>
<p><strong>Lack of incentives:</strong></p>
<p>Status currently lacks incentives to run nodes, which means node operators are more likely to create centralized choke points.</p>
<h3 id="privacy-3"><a class="header" href="#privacy-3">Privacy</a></h3>
<p><strong>Light node privacy:</strong></p>
<p>The main privacy concern with light nodes is that directly connected peers will know that a message originates from them (as it are the only ones it sends). This means nodes can make assumptions about what messages (topics) their peers are interested in.</p>
<p><strong>Bloom filter privacy:</strong></p>
<p>A user reveals which messages they are interested in, by setting only the topics they are interested in on the bloom filter.
This is a fundamental trade-off between bandwidth usage and privacy,
though the trade-off space is likely suboptimal in terms of the <a href="https://eprint.iacr.org/2017/954.pdf">Anonymity</a> <a href="https://petsymposium.org/2019/files/hotpets/slides/coordination-helps-anonymity-slides.pdf">trilemma</a>.</p>
<p><strong><code>Mailserver client</code> privacy:</strong></p>
<p>A <code>Mailserver client</code> has to trust a <code>Mailserver</code>, which means they can send direct traffic. This reveals what topics / bloom filter a node is interested in, along with its peerID (with IP).</p>
<p><strong>Privacy guarantees not rigorous:</strong></p>
<p>Privacy for Whisper or Waku hasn't been studied rigorously for various threat models like global passive adversary, local active attacker, etc. This is unlike e.g. Tor and mixnets.</p>
<p><strong>Topic hygiene:</strong></p>
<p>Similar to bloom filter privacy, using a very specific topic reveals more information. See scalability model linked above.</p>
<h3 id="spam-resistance-2"><a class="header" href="#spam-resistance-2">Spam resistance</a></h3>
<p><strong>PoW bad for heterogeneous devices:</strong></p>
<p>Proof of work is a poor spam prevention mechanism. A mobile device can only have a very low PoW in order not to use too much CPU / burn up its phone battery. This means someone can spin up a powerful node and overwhelm the network.</p>
<p><strong><code>Mailserver</code> trusted connection:</strong></p>
<p>A <code>Mailserver</code> has a direct TCP connection, which means they are trusted to send traffic. This means a malicious or malfunctioning <code>Mailserver</code> can overwhelm an individual node.</p>
<h3 id="censorship-resistance-2"><a class="header" href="#censorship-resistance-2">Censorship resistance</a></h3>
<p><strong>Devp2p TCP port blockable:</strong></p>
<p>By default Devp2p runs on port <code>30303</code>, which is not commonly used for any other service. This means it is easy to censor, e.g. airport WiFi. This can be mitigated somewhat by running on e.g. port <code>80</code> or <code>443</code>, but there are still outstanding issues. See libp2p and Tor's Pluggable Transport for how this can be improved.</p>
<p>See <a href="https://github.com/status-im/status-mobile/issues/6351">https://github.com/status-im/status-mobile/issues/6351</a> for some discussion.</p>
<h2 id="acknowledgments-2"><a class="header" href="#acknowledgments-2">Acknowledgments</a></h2>
<p>Jacek Sieka</p>
<h2 id="changelog-7"><a class="header" href="#changelog-7">Changelog</a></h2>
<h3 id="version-03-4"><a class="header" href="#version-03-4">Version 0.3</a></h3>
<p>Released <a href="https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8">May 22, 2020</a></p>
<ul>
<li>Added that Waku SHOULD be used</li>
<li>Added that Whisper SHOULD NOT be used</li>
<li>Added language to include Waku in all relevant places</li>
<li>Change to keep <code>Mailserver</code> term consistent</li>
</ul>
<h2 id="copyright-72"><a class="header" href="#copyright-72">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-59"><a class="header" href="#references-59">References</a></h2>
<ul>
<li><a href="https://developers.google.com/protocol-buffers/">Protobuf</a></li>
<li><a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5.md">Discv5</a></li>
<li><a href="https://github.com/ethereum/devp2p/blob/master/rlpx.md">RLPx Transport Protocol, v5</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-627">Whisper V6</a></li>
<li><a href="status/deprecated//waku/standards/legacy/6/waku1.html">Waku V1</a></li>
<li><a href="https://github.com/libp2p/specs/tree/master/rendezvous">Rendezvous Protocol</a></li>
<li><a href="https://github.com/status-im/rendezvous#differences-with-original-rendezvous">Rendezvous Protocol modifications</a></li>
<li><a href="https://fleets.status.im">Fleets Status</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-1459#client-protocol">EIP-1459</a></li>
<li><a href="status/deprecated//status/deprecated/whisper-usage.html">WHISPER-USAGE</a></li>
<li><a href="status/deprecated//status/deprecated/waku-usage.html">WAKU-USAGE</a></li>
<li><a href="status/deprecated//status/deprecated/whisper-mailserver.html">WHISPER-MAILSERVER</a></li>
<li><a href="status/deprecated//status/deprecated/waku-mailserver.html">WAKU-MAILSERVER</a></li>
<li><a href="status/deprecated//status/deprecated/secure-transport.html">SECURE-TRANSPORT</a></li>
<li><a href="status/deprecated//vac/2/mvds.html">MVDS</a></li>
<li><a href="status/deprecated//status/deprecated/payloads.html">PAYLOADS</a></li>
<li><a href="status/deprecated//status/deprecated/eips.html">EIPS</a></li>
<li><a href="https://github.com/status-im/murmur">Murmur</a></li>
<li><a href="https://github.com/status-im/status-go/issues/1025">Re-enable LES as option</a></li>
<li><a href="https://github.com/ethersphere/SWIPs/pull/12">Swarm adaptive nodes</a></li>
<li><a href="https://our.status.im/whisper-pss-comparison/">Whisper vs PSS</a></li>
<li><a href="status/deprecated//waku/">Waku specs</a></li>
<li><a href="https://vac.dev/vac-overview">Vac</a></li>
<li><a href="https://github.com/vacp2p/research/tree/dcc71f4779be832d3b5ece9c4e11f1f7ec24aac2/whisper_scalability">theoretical scaling model</a></li>
<li><a href="https://eprint.iacr.org/2017/954.pdf">Anonymity</a></li>
<li><a href="https://petsymposium.org/2019/files/hotpets/slides/coordination-helps-anonymity-slides.pdf">trilemma</a></li>
<li><a href="https://our.status.im/whisper-pss-comparison/">Whisper vs PSS</a></li>
<li><a href="https://github.com/status-im/swarms/blob/master/ideas/092-disc-v5-research.md">Discovery v5 research</a></li>
<li><a href="https://vac.dev/p2p-data-sync-for-mobile">P2P Data Sync for Mobile</a></li>
<li><a href="https://github.com/status-im/status-protocol-go/">Status protocol go</a></li>
<li><a href="https://github.com/status-im/status-console-client/">Status console client</a></li>
<li><a href="https://github.com/status-im/status-mobile/">Status mobile</a></li>
<li><a href="https://github.com/status-im/status-mobile/issues/6351">Status mobile issue 6351</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dapp-browser-api-usage"><a class="header" href="#dapp-browser-api-usage">Dapp browser API usage</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Dapp browser API usage</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-77"><a class="header" href="#timeline-77">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/deprecated/dapp-browser-API-usage.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/deprecated/dapp-browser-API-usage.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/614348a4982aa9e519ccff8b8fbcd4c554683288/status/deprecated/dapp-browser-API-usage.md"><code>614348a</code></a> — Status deprecated update2 (#134)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-52"><a class="header" href="#abstract-52">Abstract</a></h2>
<p>This document describes requirements that an application must fulfill in order to provide a proper environment for Dapps running inside a browser.
A description of the Status Dapp API is provided, along with an overview of bidirectional communication underlying the API implementation.
The document also includes a list of EIPs that this API implements.</p>
<h2 id="definitions-11"><a class="header" href="#definitions-11">Definitions</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Term</th><th>Description</th></tr></thead><tbody>
<tr><td><strong>Webview</strong></td><td>Platform-specific browser core implementation.</td></tr>
<tr><td><strong>Ethereum Provider</strong></td><td>A JS object (<code>window.ethereum</code>) injected into each web page opened in the browser providing web3 compatible provider.</td></tr>
<tr><td><strong>Bridge</strong></td><td>A set of facilities allow bidirectional communication between JS code and the application.</td></tr>
</tbody></table>
</div>
<h2 id="overview-10"><a class="header" href="#overview-10">Overview</a></h2>
<p>The application should expose an Ethereum Provider object (<code>window.ethereum</code>) to JS code running inside the browser.
It is important to have the <code>window.ethereum</code> object available before the page loads, otherwise Dapps might not work correctly.</p>
<p>Additionally, the browser component should also provide bidirectional communication between JS code and the application.</p>
<h2 id="usage-in-dapps"><a class="header" href="#usage-in-dapps">Usage in Dapps</a></h2>
<p>Dapps can use the below properties and methods of <code>window.ethereum</code> object.</p>
<h3 id="properties"><a class="header" href="#properties">Properties</a></h3>
<h4 id="isstatus"><a class="header" href="#isstatus"><code>isStatus</code></a></h4>
<p>Returns true. Can be used by the Dapp to find out whether it's running inside Status.</p>
<h4 id="status-2"><a class="header" href="#status-2"><code>status</code></a></h4>
<p>Returns a <code>StatusAPI</code> object. For now it supports one method: <code>getContactCode</code> that sends a <code>contact-code</code> request to Status.</p>
<h3 id="methods-1"><a class="header" href="#methods-1">Methods</a></h3>
<h4 id="isconnected"><a class="header" href="#isconnected"><code>isConnected</code></a></h4>
<p>Similarly to Ethereum JS API <a href="https://github.com/ethereum/wiki/wiki/JavaScript-API#web3isconnected">docs</a>,
it should be called to check if connection to a node exists. On Status, this fn always returns true, as once Status is up and running, node is automatically started.</p>
<h4 id="scanqrcode"><a class="header" href="#scanqrcode"><code>scanQRCode</code></a></h4>
<p>Sends a <code>qr-code</code> Status API request.</p>
<h4 id="request-2"><a class="header" href="#request-2"><code>request</code></a></h4>
<p><code>request</code> method as defined by EIP-1193.</p>
<h3 id="unused"><a class="header" href="#unused">Unused</a></h3>
<p>Below are some legacy methods that some Dapps might still use.</p>
<h4 id="enable-deprecated"><a class="header" href="#enable-deprecated"><code>enable</code> (DEPRECATED)</a></h4>
<p>Sends a <code>web3</code> Status API request. It returns a first entry in the list of available accounts.</p>
<p>Legacy <code>enable</code> method as defined by <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1102.md">EIP1102</a>.</p>
<h4 id="send-deprecated"><a class="header" href="#send-deprecated"><code>send</code> (DEPRECATED)</a></h4>
<p>Legacy <code>send</code> method as defined by <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1193.md">EIP1193</a>.</p>
<h4 id="sendasync-deprecated"><a class="header" href="#sendasync-deprecated"><code>sendAsync</code> (DEPRECATED)</a></h4>
<p>Legacy <code>sendAsync</code> method as defined by <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1193.md">EIP1193</a>.</p>
<h4 id="sendsync-deprecated"><a class="header" href="#sendsync-deprecated"><code>sendSync</code> (DEPRECATED)</a></h4>
<p>Legacy <code>send</code> method.</p>
<h2 id="implementation-1"><a class="header" href="#implementation-1">Implementation</a></h2>
<p>Status uses a <a href="https://github.com/status-im/react-native-webview">forked version</a> of <a href="https://github.com/react-native-community/react-native-webview">react-native-webview</a>  to display web or dapps content.
The fork provides an Android implementation of JS injection before page load.
It is required in order to properly inject Ethereum Provider object.</p>
<p>Status injects two JS scripts:</p>
<ul>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/resources/js/provider.js">provider.js</a>: <code>window.ethereum</code> object</li>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/resources/js/webview.js">webview.js</a>: override for <code>history.pushState</code> used internally</li>
</ul>
<p>Dapps running inside a browser communicate with Status Ethereum node by means of a <em>bridge</em> provided by react-native-webview library.
The bridge allows for bidirectional communication between browser and Status. In order to do so, it injects a special <code>ReactNativeWebview</code> object into each page it loads.</p>
<p>On Status (React Native) end, <code>react-native-webview</code> library provides <code>WebView.injectJavascript</code> function
on a webview component that allows to execute arbitrary code inside the webview.
Thus it is possible to inject a function call passing Status node response back to the Dapp.</p>
<p>Below is the table briefly describing what functions/properties are used. More details available in package <a href="https://github.com/react-native-community/react-native-webview/blob/master/docs/Guide.md#communicating-between-js-and-native">docs</a>.</p>
<div class="table-wrapper"><table><thead><tr><th>Direction</th><th>Side</th><th>Method</th></tr></thead><tbody>
<tr><td>Browser-&gt;Status</td><td>JS</td><td><code>ReactNativeWebView.postMessage()</code></td></tr>
<tr><td>Browser-&gt;Status</td><td>RN</td><td><code>WebView.onMessage()</code></td></tr>
<tr><td>Status-&gt;Browser</td><td>JS</td><td><code>ReactNativeWebView.onMessage()</code></td></tr>
<tr><td>Status-&gt;Browser</td><td>RN</td><td><code>WebView.injectJavascript()</code></td></tr>
</tbody></table>
</div>
<h2 id="compatibility"><a class="header" href="#compatibility">Compatibility</a></h2>
<p>Status browser supports the following EIPs:</p>
<ul>
<li><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1102.md">EIP1102</a>: <code>eth_requestAccounts</code> support</li>
<li><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1193.md">EIP1193</a>: <code>connect</code>, <code>disconnect</code>, <code>chainChanged</code>, and <code>accountsChanged</code> event support is not implemented</li>
</ul>
<h2 id="changelog-8"><a class="header" href="#changelog-8">Changelog</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Version</th><th>Comment</th></tr></thead><tbody>
<tr><td style="text-align: center">0.1.0</td><td>Initial Release</td></tr>
</tbody></table>
</div>
<h2 id="copyright-73"><a class="header" href="#copyright-73">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-60"><a class="header" href="#references-60">References</a></h2>
<ul>
<li><a href="https://github.com/ethereum/wiki/wiki/JavaScript-API#web3isconnected">Ethereum JS API docs</a></li>
<li><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1102.md">EIP1102</a></li>
<li><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1193.md">EIP1193</a></li>
<li><a href="https://github.com/status-im/react-native-webview">forked version</a></li>
<li><a href="https://github.com/react-native-community/react-native-webview">react-native-webview</a></li>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/resources/js/provider.js">provider.js</a></li>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/resources/js/webview.js">webview.js</a></li>
<li><a href="https://github.com/react-native-community/react-native-webview/blob/master/docs/Guide.md#communicating-between-js-and-native">docs</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="eips"><a class="header" href="#eips">EIPS</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>EIPS</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Ricardo Guilherme Schmidt &lt;ricardo3@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>None</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-78"><a class="header" href="#timeline-78">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/deprecated/eips.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/deprecated/eips.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/614348a4982aa9e519ccff8b8fbcd4c554683288/status/deprecated/eips.md"><code>614348a</code></a> — Status deprecated update2 (#134)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-53"><a class="header" href="#abstract-53">Abstract</a></h2>
<p>This specification describes how Status relates with EIPs.</p>
<h2 id="introduction-11"><a class="header" href="#introduction-11">Introduction</a></h2>
<p>Status should follow all standards as possible.
Whenever the Status app needs a feature, it should be first checked if there is a standard for that,
if not, Status should propose a standard.</p>
<h3 id="support-table"><a class="header" href="#support-table">Support table</a></h3>
<div class="table-wrapper"><table><thead><tr><th></th><th>Status v0</th><th>Status v1</th><th>Other</th><th>State</th></tr></thead><tbody>
<tr><td>BIP32</td><td>N</td><td>Y</td><td>N</td><td><code>stable</code></td></tr>
<tr><td>BIP39</td><td>Y</td><td>Y</td><td>Y</td><td><code>stable</code></td></tr>
<tr><td>BIP43</td><td>N</td><td>Y</td><td>N</td><td><code>stable</code></td></tr>
<tr><td>BIP44</td><td>N</td><td>Y</td><td>N</td><td><code>stable</code></td></tr>
<tr><td>EIP20</td><td>Y</td><td>Y</td><td>Y</td><td><code>stable</code></td></tr>
<tr><td>EIP55</td><td>Y</td><td>Y</td><td>Y</td><td><code>stable</code></td></tr>
<tr><td>EIP67</td><td>P</td><td>P</td><td>N</td><td><code>stable</code></td></tr>
<tr><td>EIP137</td><td>P</td><td>P</td><td>N</td><td><code>stable</code></td></tr>
<tr><td>EIP155</td><td>Y</td><td>Y</td><td>Y</td><td><code>stable</code></td></tr>
<tr><td>EIP165</td><td>P</td><td>N</td><td>N</td><td><code>stable</code></td></tr>
<tr><td>EIP181</td><td>P</td><td>N</td><td>N</td><td><code>stable</code></td></tr>
<tr><td>EIP191</td><td>Y?</td><td>N</td><td>Y</td><td><code>stable</code></td></tr>
<tr><td>EIP627</td><td>Y</td><td>Y</td><td>N</td><td><code>stable</code></td></tr>
<tr><td>EIP681</td><td>Y</td><td>N</td><td>Y</td><td><code>stable</code></td></tr>
<tr><td>EIP712</td><td>P</td><td>P</td><td>Y</td><td><code>stable</code></td></tr>
<tr><td>EIP721</td><td>P</td><td>P</td><td>Y</td><td><code>stable</code></td></tr>
<tr><td>EIP831</td><td>N</td><td>Y</td><td>N</td><td><code>stable</code></td></tr>
<tr><td>EIP945</td><td>Y</td><td>Y</td><td>N</td><td><code>stable</code></td></tr>
<tr><td>EIP1102</td><td>Y</td><td>Y</td><td>Y</td><td><code>stable</code></td></tr>
<tr><td>EIP1193</td><td>Y</td><td>Y</td><td>Y</td><td><code>stable</code></td></tr>
<tr><td>EIP1577</td><td>Y</td><td>P</td><td>N</td><td><code>stable</code></td></tr>
<tr><td>EIP1581</td><td>N</td><td>Y</td><td>N</td><td><code>stable</code></td></tr>
<tr><td>EIP1459</td><td>N</td><td></td><td>N</td><td><code>raw</code></td></tr>
</tbody></table>
</div>
<h2 id="components-1"><a class="header" href="#components-1">Components</a></h2>
<h3 id="bip32---hierarchical-deterministic-wallets"><a class="header" href="#bip32---hierarchical-deterministic-wallets">BIP32 - Hierarchical Deterministic Wallets</a></h3>
<p>Support: Dependency.<br />
<a href="https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki">Reference</a>
Description: Enable wallets to derive multiple private keys from the same seed.<br />
Used for: Dependency of BIP39 and BIP43.</p>
<h3 id="bip39---mnemonic-code-for-generating-deterministic-keys"><a class="header" href="#bip39---mnemonic-code-for-generating-deterministic-keys">BIP39 - Mnemonic code for generating deterministic keys</a></h3>
<p>Support: Dependency.<br />
<a href="https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki">Reference</a>
Description: Enable wallet to create private key based on a safe seed phrase.
Used for: Security and user experience.</p>
<h3 id="bip43---purpose-field-for-deterministic-wallets"><a class="header" href="#bip43---purpose-field-for-deterministic-wallets">BIP43 - Purpose Field for Deterministic Wallets</a></h3>
<p>Support: Dependency.<br />
<a href="https://github.com/bitcoin/bips/blob/master/bip-0043.mediawiki">Reference</a>
Description: Enable wallet to create private keys branched for a specific purpose.
Used for: Dependency of BIP44, uses "ethereum" coin.</p>
<h3 id="bip44---multi-account-hierarchy-for-deterministic-wallets"><a class="header" href="#bip44---multi-account-hierarchy-for-deterministic-wallets">BIP44 - Multi-Account Hierarchy for Deterministic Wallets</a></h3>
<p>Support: Dependency.
<a href="https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki">Reference</a>
Description: Enable wallet to derive multiple accounts in top of BIP39.<br />
Used for: Privacy.<br />
<a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/constants.cljs#L240">Source code</a>
Observation: BIP44 don't solve privacy issues regarding the transparency of transactions, therefore directly connected addresses through a transactions can be identifiable by a "network reconnaissance attack" over transaction history, this attack together with leakage of information from centralized services, such as exchanges, would be fatal against the whole privacy of users, regardless of BIP44.</p>
<h3 id="eip20---fungible-token"><a class="header" href="#eip20---fungible-token">EIP20 - Fungible Token</a></h3>
<p>Support: Full.<br />
<a href="https://eips.ethereum.org/EIPS/eip-20">Reference</a>
Description: Enable wallets to use tokens based on smart contracts compliant with this standard.<br />
Used for: Wallet feature.<br />
<a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/tokens.cljs">Sourcecode</a></p>
<h3 id="eip55---mixed-case-checksum-address-encoding"><a class="header" href="#eip55---mixed-case-checksum-address-encoding">EIP55 - Mixed-case checksum address encoding</a></h3>
<p>Support: Full.<br />
<a href="https://eips.ethereum.org/EIPS/eip-55">Reference</a>
Description: Checksum standard that uses lowercase and uppercase inside address hex value.<br />
Used for: Sanity check of forms using ethereum address.<br />
<a href="https://github.com/status-im/status-mobile/issues/4959">Related</a> <a href="https://github.com/status-im/status-mobile/issues/8707">Also</a>
<a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/eip55.cljs">Sourcecode</a></p>
<h3 id="eip67---standard-uri-scheme-with-metadata-value-and-byte-code"><a class="header" href="#eip67---standard-uri-scheme-with-metadata-value-and-byte-code">EIP67 - Standard URI scheme with metadata, value and byte code</a></h3>
<p>Support: Partial.<br />
<a href="https://github.com/ethereum/EIPs/issues/67">Reference</a>
Description: A standard way of creating Ethereum URIs for various use-cases.<br />
Used for: Legacy support.<br />
<a href="https://github.com/status-im/status-mobile/issues/875">Issue</a></p>
<h3 id="eip137---ethereum-domain-name-service---specification"><a class="header" href="#eip137---ethereum-domain-name-service---specification">EIP137 - Ethereum Domain Name Service - Specification</a></h3>
<p>Support: Partial.<br />
<a href="https://eips.ethereum.org/EIPS/eip-137">Reference</a>
Description: Enable wallets to lookup ENS names.<br />
Used for: User experience, as a wallet and identity feature, usernames.<br />
<a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/ens.cljs#L86">Sourcecode</a></p>
<h3 id="eip155---simple-replay-attack-protection"><a class="header" href="#eip155---simple-replay-attack-protection">EIP155 - Simple replay attack protection</a></h3>
<p>Support: Full.<br />
<a href="https://eips.ethereum.org/EIPS/eip-155">Reference</a>
Description: Defined chainId parameter in the singed ethereum transaction payload.<br />
Used for: Signing transactions, crucial to safety of users against replay attacks.<br />
<a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/core.cljs">Sourcecode</a></p>
<h3 id="eip165---standard-interface-detection"><a class="header" href="#eip165---standard-interface-detection">EIP165 - Standard Interface Detection</a></h3>
<p>Support: Dependency/Partial.<br />
<a href="https://eips.ethereum.org/EIPS/eip-165">Reference</a>
Description: Standard interface for contract to answer if it supports other interfaces.<br />
Used for: Dependency of ENS and EIP721.<br />
<a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/eip165.cljs">Sourcecode</a></p>
<h3 id="eip181---ens-support-for-reverse-resolution-of-ethereum-addresses"><a class="header" href="#eip181---ens-support-for-reverse-resolution-of-ethereum-addresses">EIP181 - ENS support for reverse resolution of Ethereum addresses</a></h3>
<p>Support: Partial.<br />
<a href="https://eips.ethereum.org/EIPS/eip-181">Reference</a>
Description: Enable wallets to render reverse resolution of Ethereum addresses.<br />
Used for: Wallet feature.<br />
<a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/ens.cljs#L86">Sourcecode</a></p>
<h3 id="eip191---signed-message"><a class="header" href="#eip191---signed-message">EIP191 - Signed Message</a></h3>
<p>Support: Full.<br />
<a href="https://eips.ethereum.org/EIPS/eip-191">Reference</a>
Description: Contract signature standard, adds an obligatory padding to signed message to differentiate from Ethereum Transaction messages.<br />
Used for: Dapp support, security, dependency of ERC712.</p>
<h3 id="eip627---whisper-specification"><a class="header" href="#eip627---whisper-specification">EIP627 - Whisper Specification</a></h3>
<p>Support: Full.<br />
<a href="https://eips.ethereum.org/EIPS/eip-627">Reference</a>
Description: format of Whisper messages within the ÐΞVp2p Wire Protocol.<br />
Used for: Chat protocol.</p>
<h3 id="eip681---url-format-for-transaction-requests"><a class="header" href="#eip681---url-format-for-transaction-requests">EIP681 - URL Format for Transaction Requests</a></h3>
<p>Support: Partial.<br />
<a href="https://eips.ethereum.org/EIPS/eip-681">Reference</a>
Description: A link that pop up a transaction in the wallet.<br />
Used for: Useful as QR code data for transaction requests, chat transaction requests and for dapp links to transaction requests.<br />
<a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/eip681.cljs">Sourcecode</a>
Related: <a href="https://github.com/status-im/status-mobile/issues/9183">Issue #9183: URL Format for Transaction Requests (EIP681) is poorly supported</a> <a href="https://github.com/status-im/status-mobile/pull/9240">Issue #9240</a> <a href="https://github.com/status-im/status-mobile/issues/9238">Issue #9238</a> <a href="https://github.com/status-im/status-mobile/issues/7214">Issue #7214</a> <a href="https://github.com/status-im/status-mobile/issues/7325">Issue #7325</a> <a href="https://github.com/status-im/status-mobile/issues/8150">Issue #8150</a></p>
<h3 id="eip712---typed-signed-message"><a class="header" href="#eip712---typed-signed-message">EIP712 - Typed Signed Message</a></h3>
<p>Support: Partial.<br />
<a href="https://eips.ethereum.org/EIPS/eip-712">Reference</a>
Description: Standardize types for contract signature, allowing users to easily inspect whats being signed.<br />
Used for: User experience, security.<br />
Related: <a href="https://github.com/status-im/status-mobile/issues/5461">Isse #5461</a> <a href="https://github.com/status-im/status-mobile/commit/ba37f7b8d029d3358c7b284f6a2383b9ef9526c9">Commit</a></p>
<h3 id="eip721---non-fungible-token"><a class="header" href="#eip721---non-fungible-token">EIP721 - Non Fungible Token</a></h3>
<p>Support: Partial.<br />
<a href="https://eips.ethereum.org/EIPS/eip-721">Reference</a>
Description: Enable wallets to use tokens based on smart contracts compliant with this standard.<br />
Used for: Wallet feature.<br />
Related: <a href="https://github.com/status-im/status-mobile/issues/8909">Issue #8909</a>
<a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/erc721.cljs">Sourcecode</a> <a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/tokens.cljs">Sourcecode</a></p>
<h3 id="eip945---web-3-qr-code-scanning-api"><a class="header" href="#eip945---web-3-qr-code-scanning-api">EIP945 - Web 3 QR Code Scanning API</a></h3>
<p>Support: Full.<br />
<a href="https://github.com/ethereum/EIPs/issues/945">Reference</a>
Used for: Sharing contactcode, reading transaction requests.<br />
Related: <a href="https://github.com/status-im/status-mobile/issues/5870">Issue #5870</a></p>
<h3 id="eip1102---opt-in-account-exposure"><a class="header" href="#eip1102---opt-in-account-exposure">EIP1102 - Opt-in account exposure</a></h3>
<p>Support: Full.<br />
<a href="https://eips.ethereum.org/EIPS/eip-1102">Reference</a>
Description: Allow users to opt-in the exposure of their ethereum address to dapps they browse.<br />
Used for: Privacy, DApp support.<br />
Related: <a href="https://github.com/status-im/status-mobile/issues/7985">Issue #7985</a></p>
<h3 id="eip1193---ethereum-provider-javascript-api"><a class="header" href="#eip1193---ethereum-provider-javascript-api">EIP1193 - Ethereum Provider JavaScript API</a></h3>
<p>Support: Full.<br />
<a href="https://eips.ethereum.org/EIPS/eip-1193">Reference</a>
Description: Allows dapps to recognize event changes on wallet.<br />
Used for: DApp support.<br />
Related: <a href="https://github.com/status-im/status-mobile/pull/7246">Issue #7246</a></p>
<h3 id="eip1577---contenthash-field-for-ens"><a class="header" href="#eip1577---contenthash-field-for-ens">EIP1577 - contenthash field for ENS</a></h3>
<p>Support: Partial.<br />
<a href="https://eips.ethereum.org/EIPS/eip-1577">Reference</a><br />
Description: Allows users browse ENS domains using contenthash standard.<br />
Used for: Browser, DApp support.<br />
Related: <a href="https://github.com/status-im/status-mobile/issues/6688">Isse #6688</a>
<a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/utils/contenthash.cljs">Sourcecode</a> <a href="https://github.com/status-im/status-mobile/blob/develop/test/cljs/status_im/test/utils/contenthash.cljs#L5">Sourcecode</a></p>
<h3 id="eip1581---non-wallet-usage-of-keys-derived-from-bip-32-trees"><a class="header" href="#eip1581---non-wallet-usage-of-keys-derived-from-bip-32-trees">EIP1581 - Non-wallet usage of keys derived from BIP-32 trees</a></h3>
<p>Support: Partial.<br />
<a href="https://eips.ethereum.org/EIPS/eip-1581">Reference</a>
Description: Allow wallet to derive keys that are less sensible (non wallet).<br />
Used for: Security (don't reuse wallet key) and user experience (don't request keycard every login).<br />
Related: <a href="https://github.com/status-im/status-mobile/issues/9088">Issue #9096</a> <a href="https://github.com/status-im/status-mobile/pull/9096">Issue #9096</a><br />
<a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/constants.cljs#L242">Sourcecode</a></p>
<h3 id="eip1459---node-discovery-via-dns"><a class="header" href="#eip1459---node-discovery-via-dns">EIP1459 - Node Discovery via DNS</a></h3>
<p>Support: -
<a href="https://eips.ethereum.org/EIPS/eip-1459">Reference</a>
Description: Allows the storing and retrieving of nodes through merkle trees stored in TXT records of a domain.
Used for: Finding Waku nodes.
Related: -
Sourcecode: -</p>
<h2 id="copyright-74"><a class="header" href="#copyright-74">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-61"><a class="header" href="#references-61">References</a></h2>
<ul>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki">BIP32 - Hierarchical Deterministic Wallets</a></li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki">BIP39 - Mnemonic code for generating deterministic keys</a></li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0043.mediawiki">BIP43 - Purpose Field for Deterministic Wallets</a></li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki">BIP44 - Multi-Account Hierarchy for Deterministic Wallets</a></li>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/constants.cljs#L240">BIP44 Source Code</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-20">EIP20 - Fungible Token</a></li>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/tokens.cljs">EIP20 Source Code</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-55">EIP55 - Mixed-case checksum address encoding</a></li>
<li><a href="https://github.com/status-im/status-mobile/issues/4959">EIP55 Related Issue 4959</a></li>
<li><a href="https://github.com/status-im/status-mobile/issues/8707">EIP55 Related Issue 8707</a></li>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/eip55.cljs">EIP55 Source Code</a></li>
<li><a href="https://github.com/ethereum/EIPs/issues/67">EIP67 - Standard URI scheme with metadata, value and byte code</a></li>
<li><a href="https://github.com/status-im/status-mobile/issues/875">EIP67 Related Issue 875</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-137">EIP137 - Ethereum Domain Name Service - Specification</a></li>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/ens.cljs#L86">EIP137 Source Code</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-155">EIP155 - Simple replay attack protection</a></li>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/core.cljs">EIP155 Source Code</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-165">EIP165 - Standard Interface Detection</a></li>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/eip165.cljs">EIP165 Source Code</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-181">EIP181 - ENS support for reverse resolution of Ethereum addresses</a></li>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/ens.cljs#L86">EIP181 Source Code</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-191">EIP191 - Signed Message</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-627">EIP627 - Whisper Specification</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-681">EIP681 - URL Format for Transaction Requests</a></li>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/eip681.cljs">EIP681 Source Code</a></li>
<li><a href="https://github.com/status-im/status-mobile/issues/9183">EIP681 Related Issue 9183</a></li>
<li><a href="https://github.com/status-im/status-mobile/pull/9240">EIP681 Related Issue 9240</a></li>
<li><a href="https://github.com/status-im/status-mobile/issues/9238">EIP681 Related Issue 9238</a></li>
<li><a href="https://github.com/status-im/status-mobile/issues/7214">EIP681 Related Issue 7214</a></li>
<li><a href="https://github.com/status-im/status-mobile/issues/7325">EIP681 Related Issue 7325</a></li>
<li><a href="https://github.com/status-im/status-mobile/issues/8150">EIP681 Related Issue 8150</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-712">EIP712 - Typed Signed Message</a></li>
<li><a href="https://github.com/status-im/status-mobile/issues/5461">EIP712 Related Issue 5461</a></li>
<li><a href="https://github.com/status-im/status-mobile/commit/ba37f7b8d029d3358c7b284f6a2383b9ef9526c9">EIP712 Related Commit</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-721">EIP721 - Non Fungible Token</a></li>
<li><a href="https://github.com/status-im/status-mobile/issues/8909">EIP721 Related Issue 8909</a></li>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/erc721.cljs">EIP721 Source Code</a></li>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/tokens.cljs">EIP721 Source Code (Tokens)</a></li>
<li><a href="https://github.com/ethereum/EIPs/issues/945">EIP945 - Web 3 QR Code Scanning API</a></li>
<li><a href="https://github.com/status-im/status-mobile/issues/5870">EIP945 Related Issue 5870</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-1102">EIP1102 - Opt-in account exposure</a></li>
<li><a href="https://github.com/status-im/status-mobile/issues/7985">EIP1102 Related Issue 7985</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-1193">EIP1193 - Ethereum Provider JavaScript API</a></li>
<li><a href="https://github.com/status-im/status-mobile/pull/7246">EIP1193 Related Issue 7246</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-1577">EIP1577 - contenthash field for ENS</a></li>
<li><a href="https://github.com/status-im/status-mobile/issues/6688">EIP1577 Related Issue 6688</a></li>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/utils/contenthash.cljs">EIP1577 Source Code</a></li>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/test/cljs/status_im/test/utils/contenthash.cljs#L5">EIP1577 Test Source Code</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-1581">EIP1581 - Non-wallet usage of keys derived from BIP-32 trees</a></li>
<li><a href="https://github.com/status-im/status-mobile/issues/9088">EIP1581 Related Issue 9088</a></li>
<li><a href="https://github.com/status-im/status-mobile/pull/9096">EIP1581 Related Issue 9096</a></li>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/constants.cljs#L242">EIP1581 Source Code</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-1459">EIP1459 - Node Discovery via DNS</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ethereum-usage"><a class="header" href="#ethereum-usage">ETHEREUM-USAGE</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Status interactions with the Ethereum blockchain</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Andrea Maria Piana &lt;andreap@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-79"><a class="header" href="#timeline-79">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/deprecated/ethereum-usage.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/deprecated/ethereum-usage.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/614348a4982aa9e519ccff8b8fbcd4c554683288/status/deprecated/ethereum-usage.md"><code>614348a</code></a> — Status deprecated update2 (#134)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-54"><a class="header" href="#abstract-54">Abstract</a></h2>
<p>This specification documents all the interactions that the Status client has
with the <a href="https://ethereum.org/developers/">Ethereum</a> blockchain.</p>
<h2 id="background-8"><a class="header" href="#background-8">Background</a></h2>
<p>All the interactions are made through <a href="https://github.com/ethereum/wiki/wiki/JSON-RPC">JSON-RPC</a>.
Currently <a href="https://infura.io/">Infura</a> is used.
The client assumes high-availability,
otherwise it will not be able to interact with the Ethereum blockchain.
Status nodes rely on these Infura nodes
to validate the integrity of the transaction and report a consistent history.</p>
<p>Key handling is described <a href="status/deprecated//status/deprecated/account.html">here</a></p>
<ol>
<li><a href="status/deprecated/ethereum-usage.html#wallet">Wallet</a></li>
<li><a href="status/deprecated/ethereum-usage.html#ens">ENS</a></li>
</ol>
<h2 id="wallet"><a class="header" href="#wallet">Wallet</a></h2>
<p>The wallet in Status has two main components:</p>
<ol>
<li>Sending transactions</li>
<li>Fetching balance</li>
</ol>
<p>In the section below are described the <code>RPC</code> calls made the nodes, with a brief
description of their functionality and how it is used by Status.</p>
<p>1.<a href="status/deprecated/ethereum-usage.html#sending-transactions">Sending transactions</a></p>
<ul>
<li><a href="status/deprecated/ethereum-usage.html#estimategas">EstimateGas</a></li>
<li><a href="status/deprecated/ethereum-usage.html#pendingnonceat">PendingNonceAt</a></li>
<li><a href="status/deprecated/ethereum-usage.html#suggestgasprice">SuggestGasPrice</a></li>
<li><a href="status/deprecated/ethereum-usage.html#sendtransaction">SendTransaction</a></li>
</ul>
<p>2.<a href="status/deprecated/ethereum-usage.html#fetching-balance">Fetching balance</a></p>
<ul>
<li><a href="status/deprecated/ethereum-usage.html#blockbyhash">BlockByHash</a></li>
<li><a href="status/deprecated/ethereum-usage.html#blockbynumber">BlockByNumber</a></li>
<li><a href="status/deprecated/ethereum-usage.html#filterlogs">FilterLogs</a></li>
<li><a href="status/deprecated/ethereum-usage.html#headerbynumber">HeaderByNumber</a></li>
<li><a href="status/deprecated/ethereum-usage.html#nonceat">NonceAt</a></li>
<li><a href="status/deprecated/ethereum-usage.html#transactionbyhash">TransactionByHash</a></li>
<li><a href="status/deprecated/ethereum-usage.html#transactionreceipt">TransactionReceipt</a></li>
</ul>
<h3 id="sending-transactions"><a class="header" href="#sending-transactions">Sending transactions</a></h3>
<h4 id="estimategas"><a class="header" href="#estimategas">EstimateGas</a></h4>
<p>EstimateGas tries to estimate the gas needed to execute a specific transaction
based on the current pending state of the backend blockchain.
There is no guarantee that this is the true gas limit requirement
as other transactions may be added or removed by miners,
but it should provide a basis for setting a reasonable default.</p>
<pre><code class="language-go">func (ec *Client) EstimateGas(ctx context.Context, msg ethereum.CallMsg) (uint64, error)
</code></pre>
<p><a href="https://github.com/ethereum/go-ethereum/blob/26d271dfbba1367326dec38068f9df828d462c61/ethclient/ethclient.go#L499">L499</a></p>
<h4 id="pendingnonceat"><a class="header" href="#pendingnonceat">PendingNonceAt</a></h4>
<p><code>PendingNonceAt</code> returns the account nonce of the given account in the pending state.
This is the nonce that should be used for the next transaction.</p>
<pre><code class="language-go">func (ec *Client) PendingNonceAt(ctx context.Context, account common.Address) (uint64, error)
</code></pre>
<p><a href="https://github.com/ethereum/go-ethereum/blob/26d271dfbba1367326dec38068f9df828d462c61/ethclient/ethclient.go#L440">L440</a></p>
<h4 id="suggestgasprice"><a class="header" href="#suggestgasprice">SuggestGasPrice</a></h4>
<p><code>SuggestGasPrice</code> retrieves the currently suggested gas price to allow a timely
execution of a transaction.</p>
<pre><code class="language-go">func (ec *Client) SuggestGasPrice(ctx context.Context) (*big.Int, error)
</code></pre>
<p><a href="https://github.com/ethereum/go-ethereum/blob/26d271dfbba1367326dec38068f9df828d462c61/ethclient/ethclient.go#L487">L487</a></p>
<h4 id="sendtransaction"><a class="header" href="#sendtransaction">SendTransaction</a></h4>
<p><code>SendTransaction</code> injects a signed transaction into the pending pool for execution.</p>
<p>If the transaction was a contract creation use the TransactionReceipt method to get the
contract address after the transaction has been mined.</p>
<pre><code class="language-go">func (ec *Client) SendTransaction(ctx context.Context, tx *types.Transaction) error 
</code></pre>
<p><a href="https://github.com/ethereum/go-ethereum/blob/26d271dfbba1367326dec38068f9df828d462c61/ethclient/ethclient.go#L512">L512</a></p>
<h3 id="fetching-balance"><a class="header" href="#fetching-balance">Fetching balance</a></h3>
<p>A Status node fetches the current and historical <a href="https://eips.ethereum.org/EIPS/eip-20">ECR20</a> and ETH balance for the user wallet address.
Collectibles following the <a href="https://eips.ethereum.org/EIPS/eip-721">ERC-721</a> are also fetched if enabled.</p>
<p>A Status node supports by default the following <a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/tokens.cljs">tokens</a>. Custom tokens can be added by specifying the <code>address</code>, <code>symbol</code> and <code>decimals</code>.</p>
<h4 id="blockbyhash"><a class="header" href="#blockbyhash">BlockByHash</a></h4>
<p><code>BlockByHash</code> returns the given full block.</p>
<p>It is used by status to fetch a given block which will then be inspected
for transfers to the user address, both tokens and ETH.</p>
<pre><code class="language-go">func (ec *Client) BlockByHash(ctx context.Context, hash common.Hash) (*types.Block, error)
</code></pre>
<p><a href="https://github.com/ethereum/go-ethereum/blob/26d271dfbba1367326dec38068f9df828d462c61/ethclient/ethclient.go#L78">L78</a></p>
<h4 id="blockbynumber"><a class="header" href="#blockbynumber">BlockByNumber</a></h4>
<p><code>BlockByNumber</code> returns a block from the current canonical chain. If number is nil, the
latest known block is returned.</p>
<pre><code class="language-go">func (ec *Client) BlockByNumber(ctx context.Context, number *big.Int) (*types.Block, error)
</code></pre>
<p><a href="https://github.com/ethereum/go-ethereum/blob/26d271dfbba1367326dec38068f9df828d462c61/ethclient/ethclient.go#L82">L82</a></p>
<h4 id="filterlogs"><a class="header" href="#filterlogs">FilterLogs</a></h4>
<p><code>FilterLogs</code> executes a filter query.</p>
<p>Status uses this function to filter out logs, using the hash of the block
and the address of interest, both inbound and outbound.</p>
<pre><code class="language-go">func (ec *Client) FilterLogs(ctx context.Context, q ethereum.FilterQuery) ([]types.Log, error) 
</code></pre>
<p><a href="https://github.com/ethereum/go-ethereum/blob/26d271dfbba1367326dec38068f9df828d462c61/ethclient/ethclient.go#L377">L377</a></p>
<h4 id="nonceat"><a class="header" href="#nonceat">NonceAt</a></h4>
<p><code>NonceAt</code> returns the account nonce of the given account.</p>
<pre><code class="language-go">func (ec *Client) NonceAt(ctx context.Context, account common.Address, blockNumber *big.Int) (uint64, error)
</code></pre>
<p><a href="https://github.com/ethereum/go-ethereum/blob/26d271dfbba1367326dec38068f9df828d462c61/ethclient/ethclient.go#L366">L366</a></p>
<h4 id="transactionbyhash"><a class="header" href="#transactionbyhash">TransactionByHash</a></h4>
<p><code>TransactionByHash</code> returns the transaction with the given hash,
used to inspect those transactions made/received by the user.</p>
<pre><code class="language-go">func (ec *Client) TransactionByHash(ctx context.Context, hash common.Hash) (tx *types.Transaction, isPending bool, err error)
</code></pre>
<p><a href="https://github.com/ethereum/go-ethereum/blob/26d271dfbba1367326dec38068f9df828d462c61/ethclient/ethclient.go#L202">L202</a></p>
<h4 id="headerbynumber"><a class="header" href="#headerbynumber">HeaderByNumber</a></h4>
<p><code>HeaderByNumber</code> returns a block header from the current canonical chain.</p>
<pre><code class="language-go">func (ec *Client) HeaderByNumber(ctx context.Context, number *big.Int) (*types.Header, error) 
</code></pre>
<p><a href="https://github.com/ethereum/go-ethereum/blob/26d271dfbba1367326dec38068f9df828d462c61/ethclient/ethclient.go#L172">L172</a></p>
<h4 id="transactionreceipt"><a class="header" href="#transactionreceipt">TransactionReceipt</a></h4>
<p><code>TransactionReceipt</code> returns the receipt of a transaction by transaction hash.
It is used in status to check if a token transfer was made to the user address.</p>
<pre><code class="language-go">func (ec *Client) TransactionReceipt(ctx context.Context, txHash common.Hash) (*types.Receipt, error)
</code></pre>
<p><a href="https://github.com/ethereum/go-ethereum/blob/26d271dfbba1367326dec38068f9df828d462c61/ethclient/ethclient.go#L270">L270</a></p>
<h2 id="ens"><a class="header" href="#ens">ENS</a></h2>
<p>All the interactions with <code>ENS</code> are made through the <a href="https://github.com/ensdomains/ens">ENS contract</a></p>
<p>For the <code>stateofus.eth</code> username, one can be registered through these <a href="https://github.com/status-im/ens-usernames">contracts</a></p>
<h3 id="registering-releasing-and-updating"><a class="header" href="#registering-releasing-and-updating">Registering, releasing and updating</a></h3>
<ul>
<li><a href="https://github.com/status-im/ens-usernames/blob/77d9394d21a5b6213902473b7a16d62a41d9cd09/contracts/registry/UsernameRegistrar.sol#L113">Registering a username</a></li>
<li><a href="https://github.com/status-im/ens-usernames/blob/77d9394d21a5b6213902473b7a16d62a41d9cd09/contracts/registry/UsernameRegistrar.sol#L131">Releasing a username</a></li>
<li><a href="https://github.com/status-im/ens-usernames/blob/77d9394d21a5b6213902473b7a16d62a41d9cd09/contracts/registry/UsernameRegistrar.sol#L174">Updating a username</a></li>
</ul>
<h3 id="slashing-3"><a class="header" href="#slashing-3">Slashing</a></h3>
<p>Usernames MUST be in a specific format, otherwise they MAY be slashed:</p>
<ul>
<li>
<p>They MUST only contain alphanumeric characters</p>
</li>
<li>
<p>They MUST NOT  be in the form <code>0x[0-9a-f]{5}.*</code> and have more than 12 characters</p>
</li>
<li>
<p>They MUST NOT be in the <a href="https://github.com/status-im/ens-usernames/blob/47c4c6c2058be0d80b7d678e611e166659414a3b/config/ens-usernames/reservedNames.js">reserved list</a></p>
</li>
<li>
<p>They MUST NOT be too short, this is dynamically set in the contract and can be checked against the <a href="https://github.com/status-im/ens-usernames/blob/master/contracts/registry/UsernameRegistrar.sol#L26">contract</a></p>
</li>
<li>
<p><a href="https://github.com/status-im/ens-usernames/blob/77d9394d21a5b6213902473b7a16d62a41d9cd09/contracts/registry/UsernameRegistrar.sol#L237">Slash a reserved username</a></p>
</li>
<li>
<p><a href="https://github.com/status-im/ens-usernames/blob/77d9394d21a5b6213902473b7a16d62a41d9cd09/contracts/registry/UsernameRegistrar.sol#L261">Slash an invalid username</a></p>
</li>
<li>
<p><a href="https://github.com/status-im/ens-usernames/blob/77d9394d21a5b6213902473b7a16d62a41d9cd09/contracts/registry/UsernameRegistrar.sol#L215">Slash a username too similar to an address</a></p>
</li>
<li>
<p><a href="https://github.com/status-im/ens-usernames/blob/77d9394d21a5b6213902473b7a16d62a41d9cd09/contracts/registry/UsernameRegistrar.sol#L200">Slash a username that is too short</a></p>
</li>
</ul>
<p>ENS names are propagated through <code>ChatMessage</code> and <code>ContactUpdate</code> <a href="status/deprecated//status/deprecated/payloads.html">payload</a>.
A client SHOULD verify ens names against the public key of the sender on receiving the message against the <a href="https://github.com/ensdomains/ens">ENS contract</a></p>
<h2 id="copyright-75"><a class="header" href="#copyright-75">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-62"><a class="header" href="#references-62">References</a></h2>
<ul>
<li><a href="https://ethereum.org/developers/">Ethereum Developers</a></li>
<li><a href="https://github.com/ethereum/wiki/wiki/JSON-RPC">JSON-RPC</a></li>
<li><a href="https://infura.io/">Infura</a></li>
<li><a href="status/deprecated//status/deprecated/account.html">Key Handling</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-20">ERC-20 Token Standard</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-721">ERC-721 Non-Fungible Token Standard</a></li>
<li><a href="https://github.com/status-im/status-mobile/blob/develop/src/status_im/ethereum/tokens.cljs">Supported Tokens Source Code</a></li>
<li><a href="https://github.com/ethereum/go-ethereum/">go-ethereum</a></li>
<li><a href="https://github.com/ensdomains/ens">ENS Contract</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="group-chat"><a class="header" href="#group-chat">GROUP-CHAT</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Group Chat</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Andrea Piana &lt;andreap@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-80"><a class="header" href="#timeline-80">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/deprecated/group-chat.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/deprecated/group-chat.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/614348a4982aa9e519ccff8b8fbcd4c554683288/status/deprecated/group-chat.md"><code>614348a</code></a> — Status deprecated update2 (#134)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-55"><a class="header" href="#abstract-55">Abstract</a></h2>
<p>This document describes the group chat protocol used by the Status application.
The node uses pairwise encryption among members so a message is exchanged<br />
between each participant, similarly to a one-to-one message.</p>
<h2 id="membership-updates"><a class="header" href="#membership-updates">Membership updates</a></h2>
<p>The node uses membership updates messages to propagate group chat membership changes.
The protobuf format is described in the <a href="status/deprecated//status/deprecated/payloads.html">PAYLOADS</a>.
Below describes each specific field.</p>
<p>The protobuf messages are:</p>
<pre><code class="language-protobuf">// MembershipUpdateMessage is a message used to propagate information
// about group membership changes.
message MembershipUpdateMessage {
  // The chat id of the private group chat
  string chat_id = 1;
  // A list of events for this group chat, first 65 bytes are the signature, then is a 
  // protobuf encoded MembershipUpdateEvent
  repeated bytes events = 2;
  // An optional chat message
  ChatMessage message = 3;
}

message MembershipUpdateEvent {
  // Lamport timestamp of the event as described in [Status Payload Specs](status-payload-specs.md#clock-vs-timestamp-and-message-ordering)
  uint64 clock = 1;
  // List of public keys of the targets of the action
  repeated string members = 2;
  // Name of the chat for the CHAT_CREATED/NAME_CHANGED event types
  string name = 3;
  // The type of the event
  EventType type = 4;

  enum EventType {
    UNKNOWN = 0;
    CHAT_CREATED = 1; // See [CHAT_CREATED](#chat-created)
    NAME_CHANGED = 2; // See [NAME_CHANGED](#name-changed)
    MEMBERS_ADDED = 3; // See [MEMBERS_ADDED](#members-added)
    MEMBER_JOINED = 4; // See [MEMBER_JOINED](#member-joined)
    MEMBER_REMOVED = 5; // See [MEMBER_REMOVED](#member-removed)
    ADMINS_ADDED = 6; // See [ADMINS_ADDED](#admins-added)
    ADMIN_REMOVED = 7; // See [ADMIN_REMOVED](#admin-removed)
  }
}
</code></pre>
<h3 id="payload"><a class="header" href="#payload">Payload</a></h3>
<p><code>MembershipUpdateMessage</code>:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>chat-id</td><td><code>string</code></td><td>The chat id of the chat where the change is to take place</td></tr>
<tr><td>2</td><td>events</td><td>See details</td><td>A list of events that describe the membership changes, in their encoded protobuf form</td></tr>
<tr><td>3</td><td>message</td><td><code>ChatMessage</code></td><td>An optional message, described in <a href="status/deprecated//status/deprecated/payloads.html">Message</a></td></tr>
</tbody></table>
</div>
<p><code>MembershipUpdateEvent</code>:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>The clock value of the event</td></tr>
<tr><td>2</td><td>members</td><td><code>[]string</code></td><td>An optional list of hex encoded (prefixed with <code>0x</code>) public keys, the targets of the action</td></tr>
<tr><td>3</td><td>name</td><td><code>name</code></td><td>An optional name, for those events that make use of it</td></tr>
<tr><td>4</td><td>type</td><td><code>EventType</code></td><td>The type of event sent, described below</td></tr>
</tbody></table>
</div>
<h3 id="chat-id"><a class="header" href="#chat-id">Chat ID</a></h3>
<p>Each membership update MUST be sent with a corresponding <code>chatId</code>.
The format of this chat ID MUST be a string of <a href="https://tools.ietf.org/html/rfc4122">UUID</a>,
concatenated with the hex-encoded public key of the creator of the chat, joined by <code>-</code>.
This chatId MUST be validated by all clients, and MUST be discarded if it does not follow these rules.</p>
<h3 id="signature-3"><a class="header" href="#signature-3">Signature</a></h3>
<p>The node calculates the signature for each event by encoding each <code>MembershipUpdateEvent</code> in its protobuf representation
and prepending the bytes of the chatID, lastly the node signs the <code>Keccak256</code> of the bytes
using the private key by the author and added to the <code>events</code> field of MembershipUpdateMessage.</p>
<h3 id="group-membership-event"><a class="header" href="#group-membership-event">Group membership event</a></h3>
<p>Any <code>group membership</code> event received MUST be verified by calculating the signature as per the method described above.
The author MUST be extracted from it, if the verification fails the event MUST be discarded.</p>
<h4 id="chat_created"><a class="header" href="#chat_created">CHAT_CREATED</a></h4>
<p>Chat <code>created event</code> is the first event that needs to be sent.
Any event with a clock value lower than this MUST be discarded.
Upon receiving this event a client MUST validate the <code>chatId</code>
provided with the updates and create a chat with identified by <code>chatId</code> and named <code>name</code>.</p>
<h4 id="name_changed"><a class="header" href="#name_changed">NAME_CHANGED</a></h4>
<p><code>admins</code> use a <code>name changed</code> event to change the name of the group chat.
Upon receiving this event a client MUST validate the <code>chatId</code> provided with the updates
and MUST ensure the author of the event is an admin of the chat, otherwise the event MUST be ignored.
If the event is valid the chat name SHOULD be changed to <code>name</code>.</p>
<h4 id="members_added"><a class="header" href="#members_added">MEMBERS_ADDED</a></h4>
<p><code>admins</code> use a <code>members added</code> event to add members to the chat.
Upon receiving this event a client MUST validate the <code>chatId</code>
provided with the updates and MUST ensure the author of the event is an admin of the chat, otherwise the event MUST be ignored.
If the event is valid a client MUST update the list of members of the chat who have not joined, adding the <code>members</code> received.
<code>members</code> is an array of hex encoded public keys.</p>
<h4 id="member_joined"><a class="header" href="#member_joined">MEMBER_JOINED</a></h4>
<p><code>members</code> use a <code>members joined</code> event to signal that they want to start receiving messages from this chat.
Upon receiving this event a client MUST validate the <code>chatId</code> provided with the updates.
If the event is valid a client MUST update the list of members of the chat who joined, adding the signer.
Any <code>message</code> sent to the group chat should now include the newly joined member.</p>
<h4 id="admins_added"><a class="header" href="#admins_added">ADMINS_ADDED</a></h4>
<p><code>admins</code> use an <code>admins added</code> event to add make other admins in the chat.
Upon receiving this event a client MUST validate the <code>chatId</code> provided with the updates,
MUST ensure the author of the event is an admin of the chat
and MUST ensure all <code>members</code> are already <code>members</code> of the chat, otherwise the event MUST be ignored.
If the event is valid a client MUST update the list of admins of the chat, adding the <code>members</code> received.
<code>members</code> is an array of hex encoded public keys.</p>
<h4 id="member_removed"><a class="header" href="#member_removed">MEMBER_REMOVED</a></h4>
<p><code>members</code> and/or <code>admins</code> use a <code>member-removed</code> event to leave or kick members of the chat.
Upon receiving this event a client MUST validate the <code>chatId</code> provided with the updates, MUST ensure that:</p>
<ul>
<li>If the author of the event is an admin, target can only be themselves or a non-admin member.</li>
<li>If the author of the event is not an admin, the target of the event can only be themselves.</li>
</ul>
<p>If the event is valid a client MUST remove the member from the list of <code>members</code>/<code>admins</code> of the chat,
and no further message should be sent to them.</p>
<h4 id="admin_removed"><a class="header" href="#admin_removed">ADMIN_REMOVED</a></h4>
<p><code>Admins</code> use an <code>admin-removed</code> event to drop admin privileges.
Upon receiving this event a client MUST validate the <code>chatId</code> provided with the updates,
MUST ensure that the author of the event is also the target of the event.</p>
<p>If the event is valid a client MUST remove the member from the list of <code>admins</code> of the chat.</p>
<h2 id="copyright-76"><a class="header" href="#copyright-76">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-63"><a class="header" href="#references-63">References</a></h2>
<ul>
<li><a href="status/deprecated//status/deprecated/payloads.html">PAYLOADS</a></li>
<li><a href="https://tools.ietf.org/html/rfc4122">UUID</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ipfs-gateway-for-sticker-pack"><a class="header" href="#ipfs-gateway-for-sticker-pack">IPFS-gateway-for-Sticker-Pack</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>IPFS gateway for Sticker Pack</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Gheorghe Pinzaru &lt;gheorghe@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-81"><a class="header" href="#timeline-81">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/deprecated/IPFS-gateway-for-sticker-Pack.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/deprecated/IPFS-gateway-for-sticker-Pack.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/614348a4982aa9e519ccff8b8fbcd4c554683288/status/deprecated/IPFS-gateway-for-sticker-Pack.md"><code>614348a</code></a> — Status deprecated update2 (#134)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-56"><a class="header" href="#abstract-56">Abstract</a></h2>
<p>This specification describes how Status uses the IPFS gateway<br />
to store stickers.<br />
The specification explores image format,<br />
how a user uploads stickers,<br />
and how an end user can see them inside the Status app.</p>
<h2 id="definition"><a class="header" href="#definition">Definition</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Term</th><th>Description</th></tr></thead><tbody>
<tr><td><strong>Stickers</strong></td><td>A set of images which can be used to express emotions</td></tr>
<tr><td><strong>Sticker Pack</strong></td><td>ERC721 token which includes the set of stickers</td></tr>
<tr><td><strong>IPFS</strong></td><td>P2P network used to store and share data, in this case, the images for the stickerpack</td></tr>
</tbody></table>
</div>
<h2 id="specification-12"><a class="header" href="#specification-12">Specification</a></h2>
<h3 id="image-format"><a class="header" href="#image-format">Image format</a></h3>
<p>Accepted image file types are <code>PNG</code>, <code>JPG/JPEG</code> and <code>GIF</code>,
with a maximum allowed size of 300kb.
The minimum sticker image resolution is 512x512,
and its background SHOULD be transparent.</p>
<h3 id="distribution"><a class="header" href="#distribution">Distribution</a></h3>
<p>The node implements sticker packs as <a href="https://eips.ethereum.org/EIPS/eip-721">ERC721 token</a>
and contain a set of stickers.
The node stores these stickers inside the sticker pack as a set of hyperlinks pointing to IPFS storage.
These hyperlinks are publicly available and can be accessed by any user inside the status chat.
Stickers can be sent in chat only by accounts that own the sticker pack.</p>
<h3 id="ipfs-gateway"><a class="header" href="#ipfs-gateway">IPFS gateway</a></h3>
<p>At the moment of writing, the current main Status app uses the <a href="https://infura.io/">Infura</a> gateway.
However, clients could choose a different gateway or to run own IPFS node.
Infura gateway is an HTTPS gateway,
which based on an HTTP GET request with the multihash block will return the stored content at that block address.</p>
<p>The node requires the use of a gateway to enable easy access to the resources over HTTP.
The node stores each image of a sticker inside IPFS using a unique address that is
derived from the hash of the file.
This ensures that a file can't be overridden,
and an end-user of the IPFS will receive the same file at a given address.</p>
<h3 id="security-1"><a class="header" href="#security-1">Security</a></h3>
<p>The IPFS gateway acts as an end-user of the IPFS
and allows users of the gateway to access IPFS without connection to the P2P network.
Usage of a gateway introduces potential risk for the users of that gateway provider.
In case of a compromise in the security of the provider, meta information such as IP address,
User-Agent and other of its users can be leaked.
If the provider servers are unavailable the node loses access through the gateway to the IPFS network.</p>
<h3 id="status-sticker-usage"><a class="header" href="#status-sticker-usage">Status sticker usage</a></h3>
<p>When the app shows a sticker, the Status app makes an HTTP GET request to IPFS gateway using the hyperlink.</p>
<p>To send a sticker in chat, a user of Status should buy or install a sticker pack.</p>
<p>To be available for installation a Sticker Pack should be submitted to Sticker market by an author.</p>
<h4 id="submit-a-sticker"><a class="header" href="#submit-a-sticker">Submit a sticker</a></h4>
<p>To submit a sticker pack, the author should upload all assets to IPFS.
Then generate a payload including name, author, thumbnail,
preview and a list of stickers in the <a href="https://github.com/edn-format/edn">EDN format</a>. Following this structure:
<code>{meta {:name "Sticker pack name"        :author "Author Name"        :thumbnail "e30101701220602163b4f56c747333f43775fdcbe4e62d6a3e147b22aaf6097ce0143a6b2373"        :preview "e30101701220ef54a5354b78ef82e542bd468f58804de71c8ec268da7968a1422909357f2456"        :stickers [{:hash "e301017012207737b75367b8068e5bdd027d7b71a25138c83e155d1f0c9bc5c48ff158724495"}        {:hash "e301017012201a9cdea03f27cda1aede7315f79579e160c7b2b6a2eb51a66e47a96f47fe5284"}]}}</code>
All asset fields, are contenthash fields as per <a href="https://eips.ethereum.org/EIPS/eip-1577">EIP 1577</a>.
The node also uploads this payload to IPFS, and the node uses the IPFS address in the content field of the Sticker Market contract.
See <a href="https://github.com/status-im/sticker-market/blob/651e88e5f38c690e57ecaad47f46b9641b8b1e27/docs/specification.md">Sticker Market spec</a> for a detailed description of the contract.</p>
<h4 id="install-a-sticker-pack"><a class="header" href="#install-a-sticker-pack">Install a sticker pack</a></h4>
<p>To install a sticker pack, the node fetches all sticker packs available in Sticker Market.
The node needs the following steps to fetch all sticker packs:</p>
<h4 id="1-get-total-number-of-sticker-packs"><a class="header" href="#1-get-total-number-of-sticker-packs">1. Get total number of sticker packs</a></h4>
<p>Call <code>packCount()</code> on the sticker market contract, will return number of sticker pack registered as <code>uint256</code>.</p>
<h4 id="2-get-sticker-pack-by-id"><a class="header" href="#2-get-sticker-pack-by-id">2. Get sticker pack by id</a></h4>
<p>ID's are represented as <code>uint256</code> and are incremental from <code>0</code> to total number of sticker packs in the contract,
received in the previous step.
To get a sticker pack call <code>getPackData(sticker-pack-id)</code>, the return type is  <code>["bytes4[]" "address" "bool" "uint256" "uint256" "bytes"]</code>
which represents the following fields: <code>[category owner mintable timestamp price contenthash]</code>.
Price is the SNT value in wei set by sticker pack owner.
The contenthash is the IPFS address described in the <a href="status/deprecated/IPFS-gateway-for-sticker-Pack.html#submit-a-sticker">submit description</a> above.
Other fields specification could be found in <a href="https://github.com/status-im/sticker-market/blob/651e88e5f38c690e57ecaad47f46b9641b8b1e27/docs/specification.md">Sticker Market spec</a></p>
<h5 id="3-get-owned-sticker-packs"><a class="header" href="#3-get-owned-sticker-packs">3. Get owned sticker packs</a></h5>
<p>The current Status app fetches owned sticker packs during the open of any sticker view
(a screen which shows a sticker pack, or the list of sticker packs).
To get owned packs, get all owned tokens for the current account address,
by calling <code>balanceOf(address)</code> where address is the address for the current account.
This method returns a <code>uint256</code> representing the count of available tokens. Using <code>tokenOfOwnerByIndex(address,uint256)</code> method,
with the address of the user and ID in form of a <code>uint256</code>
which is an incremented int from 0 to the total number of tokens, gives the token id.
To get the sticker pack id from a token call<code>tokenPackId(uint256)</code> where <code>uint256</code> is the token id.
This method will return an <code>uint256</code> which is the id of the owned sticker pack.</p>
<h5 id="4-buy-a-sticker-pack"><a class="header" href="#4-buy-a-sticker-pack">4. Buy a sticker pack</a></h5>
<p>To buy a sticker pack call <code>approveAndCall(address,uint256,bytes)</code>
where <code>address</code> is the address of buyer,<code>uint256</code> is the price and third parameters <code>bytes</code> is the callback  called if approved.
In the callback, call <code>buyToken(uint256,address,uint256)</code>, first parameter is sticker pack id, second buyers address, and the last is the price.</p>
<h2 id="copyright-77"><a class="header" href="#copyright-77">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-64"><a class="header" href="#references-64">References</a></h2>
<ul>
<li><a href="https://eips.ethereum.org/EIPS/eip-721">ERC721 Token Standard</a></li>
<li><a href="https://infura.io/">Infura</a></li>
<li><a href="https://github.com/edn-format/edn">EDN Format</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-1577">EIP 1577</a></li>
<li><a href="https://github.com/status-im/sticker-market/blob/651e88e5f38c690e57ecaad47f46b9641b8b1e27/docs/specification.md">Sticker Market Specification</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="keycard-usage-for-wallet-and-chat-keys"><a class="header" href="#keycard-usage-for-wallet-and-chat-keys">Keycard Usage for Wallet and Chat Keys</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Keycard Usage for Wallet and Chat Keys</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Roman Volosovskyi &lt;roman@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-82"><a class="header" href="#timeline-82">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/deprecated/keycard-usage-for-wallet-and-chat-keys.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/deprecated/keycard-usage-for-wallet-and-chat-keys.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/614348a4982aa9e519ccff8b8fbcd4c554683288/status/deprecated/keycard-usage-for-wallet-and-chat-keys.md"><code>614348a</code></a> — Status deprecated update2 (#134)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-57"><a class="header" href="#abstract-57">Abstract</a></h2>
<p>In this specification, we describe how Status communicates with Keycard to create, store and use multiaccount.</p>
<h2 id="definitions-12"><a class="header" href="#definitions-12">Definitions</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Term</th><th>Description</th></tr></thead><tbody>
<tr><td>Keycard Hardwallet</td><td><a href="https://keycard.tech/docs/">https://keycard.tech/docs/</a></td></tr>
<tr><td></td><td></td></tr>
</tbody></table>
</div>
<h2 id="multiaccount-creationrestoring"><a class="header" href="#multiaccount-creationrestoring">Multiaccount creation/restoring</a></h2>
<h3 id="creation-and-restoring-via-mnemonic"><a class="header" href="#creation-and-restoring-via-mnemonic">Creation and restoring via mnemonic</a></h3>
<ol>
<li>
<p><code>status-im.hardwallet.card/get-application-info</code>
request: <code>nil</code>
response: <code>{"initialized?" false}</code></p>
</li>
<li>
<p><code>status-im.hardwallet.card/init-card</code>
request: <code>{:pin 123123}</code>
response:</p>
<pre><code class="language-clojure">{"password" "nEJXqf6VWbqeC5oN", 
 "puk" "411810112887", 
 "pin" "123123"}
</code></pre>
</li>
<li>
<p><code>status-im.hardwallet.card/get-application-info</code>
request: <code>nil</code>
response:</p>
<pre><code class="language-clojure">{"free-pairing-slots" 5, 
 "app-version" "2.2", 
 "secure-channel-pub-key" "04e70d7af7d91b8cd23adbefdfc242c096adee6c1b5ad27a4013a8f926864c1a4f816b338238dc4a04226ab42f23672585c6dca03627885530643f1656ee69b025", 
 "key-uid" "", 
 "instance-uid" "9f149d438988a7af5e1a186f650c9328", 
 "paired?" false, 
 "has-master-key?" false, 
 "initialized?" true}
</code></pre>
</li>
<li>
<p><code>status-im.hardwallet.card/pair</code>
params: <code>{:password "nEJXqf6VWbqeC5oN"}</code>
response: <code>AAVefVX0kPGsxnvQV5OXRbRTLGI3k8/S27rpsq/lZrVR</code> (<code>pairing</code>)</p>
</li>
<li>
<p><code>status-im.hardwallet.card/generate-and-load-keys</code></p>
</li>
</ol>
<pre><code class="language-clojure">   {:mnemonic "lift mansion moment version card type uncle sunny lock gather nerve math", 
    :pairing "AAVefVX0kPGsxnvQV5OXRbRTLGI3k8/S27rpsq/lZrVR", 
    :pin "123123"}
</code></pre>
<pre><code>response:
```clojure
{"whisper-address" "1f29a1a60c8a12f80c397a91c6ae0323f420e609", 
 "whisper-private-key" "123123123123123", 
 "wallet-root-public-key" "04eb9d01990a106a65a6dfaa48300f72aecfeabe502d9f4f7aeaccb146dc2f16e2dec81dcec0a1a52c1df4450f441a48c210e1a73777c0161030378df22e4ae015", 
 "encryption-public-key" "045ee42f012d72be74b31a28ce320df617e0cd5b9b343fad34fcd61e2f5dfa89ab23d880473ba4e95401a191764c7f872b7af92ea0d8c39462147df6f3f05c2a11", 
 "wallet-root-address" "132dd67ff47cc1c376879c474fd2afd0f1eee6de", 
 "whisper-public-key" "0450ad84bb95f32c64f4e5027cc11d1b363a0566a0cfc475c5653e8af9964c5c9b0661129b75e6e1bc6e96ba2443238e53e7f49f2c5f2d16fcf04aca4826765d46", 
 "address" "bf93eb43fea2ce94bf3a6463c16680b56aa4a08a", 
 "wallet-address" "7eee1060d8e4722d36c99f30ff8291caa3cfc40c", 
 "key-uid" "472d8436ccedb64bcbd897bed5895ec3458b306352e1bcee377df87db32ef2c2", 
 "wallet-public-key" "0495ab02978ea1f8b059140e0be5a87aad9b64bb7d9706735c47dda6e182fd5ca41744ca37583b9a10c316b01d4321d6c85760c61301874089acab041037246294", 
 "public-key" "0465d452d12171711f32bb931f9ea26fe1b88fe2511a7909a042b914fde10a99719136365d506e2d1694fc14627f9d557da33865efc6001da3942fc1d4d2469ca1", 
 "instance-uid" "9f149d438988a7af5e1a186f650c9328"}
```
</code></pre>
<h3 id="multiaccount-restoring-via-pairing"><a class="header" href="#multiaccount-restoring-via-pairing">Multiaccount restoring via pairing</a></h3>
<p>This flow is required in case if a user want to pair a card with an existing multiaccount on it.</p>
<ol>
<li>
<p><code>status-im.hardwallet.card/get-application-info</code>
request: <code>nil</code>
response:</p>
<pre><code class="language-clojure">{"free-pairing-slots" 4, 
 "app-version" "2.2", 
 "secure-channel-pub-key" "04e70d7af7d91b8cd23adbefdfc242c096adee6c1b5ad27a4013a8f926864c1a4f816b338238dc4a04226ab42f23672585c6dca03627885530643f1656ee69b025", 
 "key-uid" "", 
 "instance-uid" "9f149d438988a7af5e1a186f650c9328", 
 "paired?" false, 
 "has-master-key?" false, 
 "initialized?" true}
</code></pre>
</li>
<li>
<p><code>status-im.hardwallet.card/pair</code>
params: <code>{:password "nEJXqf6VWbqeC5oN"}</code>
response: <code>AAVefVX0kPGsxnvQV5OXRbRTLGI3k8/S27rpsq/lZrVR</code> (<code>pairing</code>)</p>
</li>
<li>
<p><code>status-im.hardwallet.card/generate-and-load-keys</code></p>
<pre><code class="language-clojure">{:mnemonic "lift mansion moment version card type uncle sunny lock gather nerve math", 
 :pairing "AAVefVX0kPGsxnvQV5OXRbRTLGI3k8/S27rpsq/lZrVR", 
 :pin "123123"}
</code></pre>
<p>response:</p>
<pre><code class="language-clojure">{"whisper-address" "1f29a1a60c8a12f80c397a91c6ae0323f420e609", 
 "whisper-private-key" "123123123123123123123", 
 "wallet-root-public-key" "04eb9d01990a106a65a6dfaa48300f72aecfeabe502d9f4f7aeaccb146dc2f16e2dec81dcec0a1a52c1df4450f441a48c210e1a73777c0161030378df22e4ae015", 
 "encryption-public-key" "045ee42f012d72be74b31a28ce320df617e0cd5b9b343fad34fcd61e2f5dfa89ab23d880473ba4e95401a191764c7f872b7af92ea0d8c39462147df6f3f05c2a11", 
 "wallet-root-address" "132dd67ff47cc1c376879c474fd2afd0f1eee6de", 
 "whisper-public-key" "0450ad84bb95f32c64f4e5027cc11d1b363a0566a0cfc475c5653e8af9964c5c9b0661129b75e6e1bc6e96ba2443238e53e7f49f2c5f2d16fcf04aca4826765d46", 
 "address" "bf93eb43fea2ce94bf3a6463c16680b56aa4a08a", 
 "wallet-address" "7eee1060d8e4722d36c99f30ff8291caa3cfc40c", 
 "key-uid" "472d8436ccedb64bcbd897bed5895ec3458b306352e1bcee377df87db32ef2c2", 
 "wallet-public-key" "0495ab02978ea1f8b059140e0be5a87aad9b64bb7d9706735c47dda6e182fd5ca41744ca37583b9a10c316b01d4321d6c85760c61301874089acab041037246294", 
 "public-key" "0465d452d12171711f32bb931f9ea26fe1b88fe2511a7909a042b914fde10a99719136365d506e2d1694fc14627f9d557da33865efc6001da3942fc1d4d2469ca1", 
 "instance-uid" "9f149d438988a7af5e1a186f650c9328"}
</code></pre>
</li>
</ol>
<h2 id="multiaccount-unlocking"><a class="header" href="#multiaccount-unlocking">Multiaccount unlocking</a></h2>
<ol>
<li>
<p><code>status-im.hardwallet.card/get-application-info</code>
params:</p>
<pre><code class="language-clojure">{:pairing nil, :on-success nil}
</code></pre>
<p>response:</p>
<pre><code class="language-clojure">{"free-pairing-slots" 4, 
 "app-version" "2.2", 
 "secure-channel-pub-key" "04b079ac513d5e0ebbe9becbae1618503419f5cb59edddc7d7bb09ce0db069a8e6dec1fb40c6b8e5454f7e1fcd0bb4a0b9750256afb4e4390e169109f3ea3ba91d", 
 "key-uid" "a5424fb033f5cc66dce9cbbe464426b6feff70ca40aa952c56247aaeaf4764a9", 
 "instance-uid" "2268254e3ed7898839abe0b40e1b4200", 
 "paired?" false, 
 "has-master-key?" true, 
 "initialized?" true}
</code></pre>
</li>
<li>
<p><code>status-im.hardwallet.card/get-keys</code>
params:</p>
<pre><code class="language-clojure">{:pairing "ACEWbvUlordYWOE6M1Narn/AXICRltjyuKIAn4kkPXQG",
 :pin "123123"}
</code></pre>
<p>response:</p>
<pre><code class="language-clojure">{"whisper-address" "ec83f7354ca112203d2ce3e0b77b47e6e33258aa", 
 "whisper-private-key" "123123123123123123123123",
 "wallet-root-public-key" "0424a93fe62a271ad230eb2957bf221b4644670589f5c0d69bd11f3371034674bf7875495816095006c2c0d5f834d628b87691a8bbe3bcc2225269020febd65a19", 
 "encryption-public-key" "0437eef85e669f800570f444e64baa2d0580e61cf60c0e9236b4108455ec1943f385043f759fcb5bd8348e32d6d6550a844cf24e57f68e9397a0f7c824a8caee2d", 
 "wallet-root-address" "6ff915f9f31f365511b1b8c1e40ce7f266caa5ce", 
 "whisper-public-key" "04b195df4336c596cca1b89555dc55dd6bb4c5c4491f352f6fdfae140a2349213423042023410f73a862aa188f6faa05c80b0344a1e39c253756cb30d8753f9f8324", 
 "address" "73509a1bb5f3b74d0dba143705cd9b4b55b8bba1", 
 "wallet-address" "2f0cc0e0859e7a05f319d902624649c7e0f48955", 
 "key-uid" "a5424fb033f5cc66dce9cbbe464426b6feff70ca40aa952c56247aaeaf4764a9", 
 "wallet-public-key" "04d6fab73772933215872c239787b2281f3b10907d099d04b88c861e713bd2b95883e0b1710a266830da29e76bbf6b87ed034ab139e36cc235a1b2a5b5ddfd4e91", 
 "public-key" "0437eef85e669f800570f444e64baa2d0580e61cf60c0e9236b4108455ec1943f385043f759fcb5bd8348e32d6d6550a844cf24e57f68e9397a0f7c824a8caee2d", 
 "instance-uid" "2268254e3ed7898839abe0b40e1b4200"}
</code></pre>
</li>
<li>
<p><code>status-im.hardwallet.card/get-application-info</code>
params:</p>
<pre><code class="language-clojure">{:pairing "ACEWbvUlordYWOE6M1Narn/AXICRltjyuKIAn4kkPXQG"}
</code></pre>
<p>response:</p>
<pre><code class="language-clojure">{"paired?" true, 
 "has-master-key?" true, 
 "app-version" "2.2", 
 "free-pairing-slots" 4, 
 "pin-retry-counter" 3, 
 "puk-retry-counter" 5, 
 "initialized?" true, 
 "secure-channel-pub-key" "04b079ac513d5e0ebbe9becbae1618503419f5cb59edddc7d7bb09ce0db069a8e6dec1fb40c6b8e5454f7e1fcd0bb4a0b9750256afb4e4390e169109f3ea3ba91d", 
 "key-uid" "a5424fb033f5cc66dce9cbbe464426b6feff70ca40aa952c56247aaeaf4764a9", 
 "instance-uid" "2268254e3ed7898839abe0b40e1b4200"}
</code></pre>
</li>
</ol>
<h2 id="transaction-signing"><a class="header" href="#transaction-signing">Transaction signing</a></h2>
<ol>
<li>
<p><code>status-im.hardwallet.card/get-application-info</code></p>
<p>params:</p>
<pre><code class="language-clojure">{:pairing "ALecvegKyOW4szknl01yYWx60GLDK5gDhxMgJECRZ+7h", 
 :on-success :hardwallet/sign}
</code></pre>
<p>response:</p>
<pre><code class="language-clojure"> {"paired?" true, 
  "has-master-key?" true, 
  "app-version" "2.2", 
  "free-pairing-slots" 4, 
  "pin-retry-counter" 3, 
  "puk-retry-counter" 5, 
  "initialized?" true, 
  "secure-channel-pub-key" "0476d11f2ccdad4e7779b95a1ce063d7280cb6c09afe2c0e48ca0c64ab9cf2b3c901d12029d6c266bfbe227c73a802561302b2330ac07a3270fc638ad258fced4a", 
  "key-uid" "d5c8cde8085e7a3fcf95aafbcbd7b3cfe32f61b85c2a8f662f60e76bdc100718", 
  "instance-uid" "e20e27bfee115b431e6e81b8e9dcf04c"}
</code></pre>
</li>
<li>
<p><code>status-im.hardwallet.card/sign</code>
params:</p>
<pre><code class="language-clojure">{:hash "92fc7ef54c3e0c42de256b93fbf2c49dc6948ee089406e204dec943b7a0142a9", 
 :pairing "ALecvegKyOW4szknl01yYWx60GLDK5gDhxMgJECRZ+7h", 
 :pin "123123", 
 :path "m/44'/60'/0'/0/0"}
</code></pre>
<p>response: <code>5d2ca075593cf50aa34007a0a1df7df14a369534450fce4a2ae8d023a9d9c0e216b5e5e3f64f81bee91613318d01601573fdb15c11887a3b8371e3291e894de600</code></p>
</li>
</ol>
<h2 id="account-derivation"><a class="header" href="#account-derivation">Account derivation</a></h2>
<ol>
<li>
<p><code>status-im.hardwallet.card/verify-pin</code>
params:</p>
<pre><code class="language-clojure">{:pin "123123", 
 :pairing "ALecvegKyOW4szknl01yYWx60GLDK5gDhxMgJECRZ+7h"}
</code></pre>
<p>response: <code>3</code></p>
</li>
<li>
<p><code>status-im.hardwallet.card/export-key</code>
params:</p>
<pre><code class="language-clojure">{:pin "123123", 
 :pairing "ALecvegKyOW4szknl01yYWx60GLDK5gDhxMgJECRZ+7h", 
 :path "m/44'/60'/0'/0/1"}
</code></pre>
<p>response: <code>046d1bcd2310a5e0094bc515b0ec995a8cb59e23d564094443af10011b6c00bdde44d160cdd32b4b6341ddd7dc83a4f31fdf60ec2276455649ccd7a22fa4ea01d8</code> (account's <code>public-key</code>)</p>
</li>
</ol>
<h2 id="reset-pin"><a class="header" href="#reset-pin">Reset pin</a></h2>
<ol>
<li>
<p><code>status-im.hardwallet.card/change-pin</code>
params:</p>
<pre><code class="language-clojure">{:new-pin "111111", 
 :current-pin "222222", 
 :pairing "AA0sKxPkN+jMHXZZeI8Rgz04AaY5Fg0CzVbm9189Khob"}
</code></pre>
<p>response:
<code>true</code></p>
</li>
</ol>
<h2 id="unblock-pin"><a class="header" href="#unblock-pin">Unblock pin</a></h2>
<p>If user enters a wrong pin three times in a row a card gets blocked. The user can use puk code then to unblock the card and set a new pin.</p>
<ol>
<li>
<p><code>status-im.hardwallet.card/unblock-pin</code>
params:</p>
<pre><code class="language-clojure">{:puk "120702722103", 
 :new-pin "111111", 
 :pairing "AIoQl0OtCL0/uSN7Ct1/FHRMEk/eM2Lrhn0bw7f8sgOe"}
</code></pre>
<p>response
<code>true</code></p>
</li>
</ol>
<h2 id="status-go-calls"><a class="header" href="#status-go-calls">Status go calls</a></h2>
<p>In order to use the card in the app we need to use some parts of status-go API, specifically:</p>
<ol>
<li><a href="https://github.com/status-im/status-go/blob/b33ad8147d23a932064f241e575511d70a601dcc/mobile/status.go#L337"><code>SaveAccountAndLoginWithKeycard</code></a> after multiaccount creation/restoring to store multiaccount and login into it</li>
<li><a href="https://github.com/status-im/status-go/blob/b33ad8147d23a932064f241e575511d70a601dcc/mobile/status.go#L373"><code>LoginWithKeycard</code></a> to log into already existing account</li>
<li><a href="https://github.com/status-im/status-go/blob/b33ad8147d23a932064f241e575511d70a601dcc/mobile/status.go#L492"><code>HashTransaction</code></a> and <a href="https://github.com/status-im/status-go/blob/b33ad8147d23a932064f241e575511d70a601dcc/mobile/status.go#L520"><code>HashMessage</code></a> for hashing transaction/message before signing</li>
<li><a href="https://github.com/status-im/status-go/blob/b33ad8147d23a932064f241e575511d70a601dcc/mobile/status.go#L471"><code>SendTransactionWithSignature</code></a> to send transaction</li>
</ol>
<h2 id="where-are-the-keys-stored"><a class="header" href="#where-are-the-keys-stored">Where are the keys stored?</a></h2>
<ol>
<li>When we create a regular multiaccount all its keys are stored on device and are encrypted via key which is derived from user's password. In case if account was created using keycard all keys are stored on the card and are retrieved from it during signing into multiaccount.</li>
<li>When we create a regular multiaccount we also create a separate database for it and this database is encrypted using key which is derived from user's password. For a keycard account we use <code>encryption-public-key</code> (returned by <code>status-im.hardwallet.card/get-keys</code>/<code>status-im.hardwallet.card/generate-and-load-keys</code>) as a password.</li>
</ol>
<h2 id="copyright-78"><a class="header" href="#copyright-78">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-65"><a class="header" href="#references-65">References</a></h2>
<ul>
<li><a href="https://keycard.tech/docs/">Keycard Hardwallet Documentation</a></li>
<li><a href="https://github.com/status-im/status-go/blob/b33ad8147d23a932064f241e575511d70a601dcc/mobile/status.go">Keycard Codebase</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="notifications"><a class="header" href="#notifications">NOTIFICATIONS</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Notifications</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Eric Dvorsak &lt;eric@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-83"><a class="header" href="#timeline-83">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/deprecated/notifications.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/deprecated/notifications.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/614348a4982aa9e519ccff8b8fbcd4c554683288/status/deprecated/notifications.md"><code>614348a</code></a> — Status deprecated update2 (#134)</li>
</ul>
<!-- timeline:end -->
<h2 id="local-notifications"><a class="header" href="#local-notifications">Local Notifications</a></h2>
<p>A client should implement local notifications to offer notifications
for any event in the app without the privacy cost and dependency on third party services.
This means that the client should run a background service to continuously or periodically check for updates.</p>
<h3 id="android"><a class="header" href="#android">Android</a></h3>
<p>Android allows running services on the device. When the user enables notifications,
the client may start a ``Foreground Service`,
and display a permanent notification indicating that the service is running,
as required by Android guidelines.
The service will simply keep the app from being killed by the system when it is in the background.
The client will then be able to run in the background
and display local notifications on events such as receiving a message in a one to one chat.</p>
<p>To facilitate the implementation of local notifications,
a node implementation such as <code>status-go</code> may provide a specific <code>notification</code> signal.</p>
<p>Notifications are a separate process in Android, and interaction with a notification generates an <code>Intent</code>.
To handle intents, the <code>NewMessageSignalHandler</code> may use a <code>BroadcastReceiver</code>,
in order to update the state of local notifications when the user dismisses or tap a notification.
If the user taps on a notification, the <code>BroadcastReceiver</code> generates a new intent to open the app should use universal links to get the user to the right place.</p>
<h3 id="ios"><a class="header" href="#ios">iOS</a></h3>
<p>We are not able to offer local notifications on iOS because there is no concept of services in iOS.
It offers background updates but they’re not consistently triggered, and cannot be relied upon.
The system decides when the background updates are triggered and the heuristics aren't known.</p>
<h2 id="why-is-there-no-push-notifications"><a class="header" href="#why-is-there-no-push-notifications">Why is there no Push Notifications?</a></h2>
<p>Push Notifications, as offered by Apple and Google are a privacy concern,
they require a centralized service that is aware of who the notification needs to be delivered to.</p>
<h2 id="copyright-79"><a class="header" href="#copyright-79">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-66"><a class="header" href="#references-66">References</a></h2>
<ul>
<li>None</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="payloads-7"><a class="header" href="#payloads-7">PAYLOADS</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Payloads</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Adam Babik &lt;adam@status.im&gt;<br>Andrea Maria Piana &lt;andreap@status.im&gt;<br>Oskar Thorén &lt;oskar@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-84"><a class="header" href="#timeline-84">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/deprecated/payloads.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/deprecated/payloads.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/614348a4982aa9e519ccff8b8fbcd4c554683288/status/deprecated/payloads.md"><code>614348a</code></a> — Status deprecated update2 (#134)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-58"><a class="header" href="#abstract-58">Abstract</a></h2>
<p>This specification describes how the payload of each message in Status looks like.
It is primarily centered around chat and chat-related use cases.</p>
<p>The payloads aims to be flexible enough to support messaging but also cases
described in the <a href="https://status.im/whitepaper.pdf">Status Whitepaper</a>
as well as various clients created using different technologies.</p>
<h2 id="introduction-12"><a class="header" href="#introduction-12">Introduction</a></h2>
<p>This document describes the payload format and some special considerations.</p>
<h2 id="payload-wrapper-1"><a class="header" href="#payload-wrapper-1">Payload wrapper</a></h2>
<p>The node wraps all payloads in a <a href="https://developers.google.com/protocol-buffers/">protobuf record</a>:</p>
<pre><code class="language-protobuf">message ApplicationMetadataMessage {
  bytes signature = 1;
  bytes payload = 2;

  Type type = 3;

  enum Type {
    UNKNOWN = 0;
    CHAT_MESSAGE = 1;
    CONTACT_UPDATE = 2;
    MEMBERSHIP_UPDATE_MESSAGE = 3;
    PAIR_INSTALLATION = 4;
    SYNC_INSTALLATION = 5;
    REQUEST_ADDRESS_FOR_TRANSACTION = 6;
    ACCEPT_REQUEST_ADDRESS_FOR_TRANSACTION = 7;
    DECLINE_REQUEST_ADDRESS_FOR_TRANSACTION = 8;
    REQUEST_TRANSACTION = 9;
    SEND_TRANSACTION = 10;
    DECLINE_REQUEST_TRANSACTION = 11;
    SYNC_INSTALLATION_CONTACT = 12;
    SYNC_INSTALLATION_ACCOUNT = 13;
    SYNC_INSTALLATION_PUBLIC_CHAT = 14;
    CONTACT_CODE_ADVERTISEMENT = 15;
    PUSH_NOTIFICATION_REGISTRATION = 16;
    PUSH_NOTIFICATION_REGISTRATION_RESPONSE = 17;
    PUSH_NOTIFICATION_QUERY = 18;
    PUSH_NOTIFICATION_QUERY_RESPONSE = 19;
    PUSH_NOTIFICATION_REQUEST = 20;
    PUSH_NOTIFICATION_RESPONSE = 21;
  }
}
</code></pre>
<p><code>signature</code> is the bytes of the signed <code>SHA3-256</code> of the payload,
signed with the key of the author of the message.
The node needs the signature to validate authorship of the message,
so that the message can be relayed to third parties.
If a signature is not present, but an author is provided by a layer below,
the message is not to be relayed to third parties, and it is considered plausibly deniable.</p>
<p><code>payload</code> is the protobuf encoded content of the message, with the corresponding <code>type</code> set.</p>
<h2 id="encoding-1"><a class="header" href="#encoding-1">Encoding</a></h2>
<p>The node encodes the payload using <a href="https://developers.google.com/protocol-buffers">Protobuf</a></p>
<h2 id="types-of-messages-1"><a class="header" href="#types-of-messages-1">Types of messages</a></h2>
<h3 id="message-2"><a class="header" href="#message-2">Message</a></h3>
<p>The type <code>ChatMessage</code> represents a chat message exchanged between clients.</p>
<h4 id="payload-1"><a class="header" href="#payload-1">Payload</a></h4>
<p>The protobuf description is:</p>
<pre><code class="language-protobuf">message ChatMessage {
  // Lamport timestamp of the chat message
  uint64 clock = 1;
  // Unix timestamps in milliseconds, currently not used as we use Whisper/Waku as more reliable, but here
  // so that we don't rely on it
  uint64 timestamp = 2;
  // Text of the message
  string text = 3;
  // Id of the message that we are replying to
  string response_to = 4;
  // Ens name of the sender
  string ens_name = 5;
  // Chat id, this field is symmetric for public-chats and private group chats,
  // but asymmetric in case of one-to-ones, as the sender will use the chat-id
  // of the received, while the receiver will use the chat-id of the sender.
  // Probably should be the concatenation of sender-pk &amp; receiver-pk in alphabetical order
  string chat_id = 6;

  // The type of message (public/one-to-one/private-group-chat)
  MessageType message_type = 7;
  // The type of the content of the message
  ContentType content_type = 8;

  oneof payload {
    StickerMessage sticker = 9;
  }

  enum MessageType {
    UNKNOWN_MESSAGE_TYPE = 0;
    ONE_TO_ONE = 1;
    PUBLIC_GROUP = 2;
    PRIVATE_GROUP = 3;
    // Only local
    SYSTEM_MESSAGE_PRIVATE_GROUP = 4;}
  enum ContentType {
    UNKNOWN_CONTENT_TYPE = 0;
    TEXT_PLAIN = 1;
    STICKER = 2;
    STATUS = 3;
    EMOJI = 4;
    TRANSACTION_COMMAND = 5;
    // Only local
    SYSTEM_MESSAGE_CONTENT_PRIVATE_GROUP = 6;
  }
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>The clock of the chat</td></tr>
<tr><td>2</td><td>timestamp</td><td><code>uint64</code></td><td>The sender timestamp at message creation</td></tr>
<tr><td>3</td><td>text</td><td><code>string</code></td><td>The content of the message</td></tr>
<tr><td>4</td><td>response_to</td><td><code>string</code></td><td>The ID of the message replied to</td></tr>
<tr><td>5</td><td>ens_name</td><td><code>string</code></td><td>The ENS name of the user sending the message</td></tr>
<tr><td>6</td><td>chat_id</td><td><code>string</code></td><td>The local ID of the chat the message is sent to</td></tr>
<tr><td>7</td><td>message_type</td><td><code>MessageType</code></td><td>The type of message, different for one-to-one, public or group chats</td></tr>
<tr><td>8</td><td>content_type</td><td><code>ContentType</code></td><td>The type of the content of the message</td></tr>
<tr><td>9</td><td>payload</td><td><code>Sticker|nil</code></td><td>The payload of the message based on the content type</td></tr>
</tbody></table>
</div>
<h4 id="content-types-1"><a class="header" href="#content-types-1">Content types</a></h4>
<p>A node requires content types for a proper interpretation of incoming messages. Not each message is plain text but may carry different information.</p>
<p>The following content types MUST be supported:</p>
<ul>
<li><code>TEXT_PLAIN</code> identifies a message which content is a plaintext.</li>
</ul>
<p>There are other content types that MAY be implemented by the client:</p>
<ul>
<li><code>STICKER</code></li>
<li><code>STATUS</code></li>
<li><code>EMOJI</code></li>
<li><code>TRANSACTION_COMMAND</code></li>
</ul>
<h5 id="mentions-1"><a class="header" href="#mentions-1">Mentions</a></h5>
<p>A mention MUST be represented as a string with the <code>@0xpk</code> format, where <code>pk</code> is the public key of the <a href="status/deprecated//status/deprecated/account.html">user account</a> to be mentioned,
within the <code>text</code> field of a message with content_type <code>TEXT_PLAIN</code>.
A message MAY contain more than one mention.
This specification RECOMMENDs that the application does not require the user to enter the entire pk.
This specification RECOMMENDs that the application allows the user to create a mention
by typing @ followed by the related ENS or 3-word pseudonym.
This specification RECOMMENDs that the application provides the user auto-completion functionality to create a mention.
For better user experience, the client SHOULD display a known <a href="status/deprecated//status/deprecated/account.html#contact-verification">ens name or the 3-word pseudonym corresponding to the key</a> instead of the <code>pk</code>.</p>
<h5 id="sticker-content-type-1"><a class="header" href="#sticker-content-type-1">Sticker content type</a></h5>
<p>A <code>ChatMessage</code> with <code>STICKER</code> <code>Content/Type</code> MUST also specify the ID of the <code>Pack</code> and
the <code>Hash</code> of the pack, in the <code>Sticker</code> field of <code>ChatMessage</code></p>
<pre><code class="language-protobuf">message StickerMessage {
  string hash = 1;
  int32 pack = 2;
}
</code></pre>
<h4 id="message-types-3"><a class="header" href="#message-types-3">Message types</a></h4>
<p>A node requires message types to decide how to encrypt a particular message
and what metadata needs to be attached when passing a message to the transport layer.
For more on this, see <a href="status/deprecated//status/deprecated/whisper-usage.html">WHISPER-USAGE</a>
and <a href="status/deprecated//status/deprecated/waku-usage.html">WAKU-USAGE</a>.</p>
<!-- TODO: This reference is a bit odd, considering the layer payloads should interact with is Secure Transport, and not Whisper/Waku. This requires more detail -->
<p>The following messages types MUST be supported:</p>
<ul>
<li><code>ONE_TO_ONE</code> is a message to the public group</li>
<li><code>PUBLIC_GROUP</code> is a private message</li>
<li><code>PRIVATE_GROUP</code> is a message to the private group.</li>
</ul>
<h4 id="clock-vs-timestamp-and-message-ordering-1"><a class="header" href="#clock-vs-timestamp-and-message-ordering-1">Clock vs Timestamp and message ordering</a></h4>
<p>If a user sends a new message before the messages sent
while the user was offline are received,
the newmessage is supposed to be displayed last in a chat.
This is where the basic algorithm of Lamport timestamp would fall short
as it's only meant to order causally related events.</p>
<p>The status client therefore makes a "bid", speculating that it will beat the current chat-timestamp, s.t. the status client's
Lamport timestamp format is: <code>clock = max({timestamp}, chat_clock + 1)</code></p>
<p>This will satisfy the Lamport requirement, namely: a -&gt; b then T(a) &lt; T(b)</p>
<p><code>timestamp</code> MUST be Unix time calculated, when the node creates the message, in milliseconds.
This field SHOULD not be relied upon for message ordering.</p>
<p><code>clock</code> SHOULD be calculated using the algorithm of <a href="https://en.wikipedia.org/wiki/Lamport_timestamps">Lamport timestamps</a>.
When there are messages available in a chat,
the node calculates <code>clock</code>'s value based on the last received message in a particular chat: <code>max(timeNowInMs, last-message-clock-value + 1)</code>.
If there are no messages, <code>clock</code> is initialized with <code>timestamp</code>'s value.</p>
<p>Messages with a <code>clock</code> greater than <code>120</code> seconds over the Whisper/Waku timestamp SHOULD be discarded,
in order to avoid malicious users to increase the <code>clock</code> of a chat arbitrarily.</p>
<p>Messages with a <code>clock</code> less than <code>120</code> seconds under the Whisper/Waku timestamp
might indicate an attempt to insert messages in the chat history which is not distinguishable from a <code>datasync</code> layer re-transit event.
A client MAY mark this messages with a warning to the user, or discard them.</p>
<p>The node uses <code>clock</code> value for the message ordering.
The algorithm used, and the distributed nature of the system produces casual ordering, which might produce counter-intuitive results in some edge cases.
For example, when a user joins a public chat and sends a message
before receiving the exist messages, their message <code>clock</code> value might be lower
and the message will end up in the past when the historical messages are fetched.</p>
<h4 id="chats-1"><a class="header" href="#chats-1">Chats</a></h4>
<p>Chat is a structure that helps organize messages.
It's usually desired to display messages only from a single recipient,
or a group of recipients at a time and chats help to achieve that.</p>
<p>All incoming messages can be matched against a chat.
The below table describes how to calculate a chat ID for each message type.</p>
<div class="table-wrapper"><table><thead><tr><th>Message Type</th><th>Chat ID Calculation</th><th>Direction</th><th>Comment</th></tr></thead><tbody>
<tr><td>PUBLIC_GROUP</td><td>chat ID is equal to a public channel name; it should equal <code>chatId</code> from the message</td><td>Incoming/Outgoing</td><td></td></tr>
<tr><td>ONE_TO_ONE</td><td>let <code>P</code> be a public key of the recipient; <code>hex-encode(P)</code> is a chat ID; use it as <code>chatId</code> value in the message</td><td>Outgoing</td><td></td></tr>
<tr><td>user-message</td><td>let <code>P</code> be a public key of message's signature; <code>hex-encode(P)</code> is a chat ID; discard <code>chat-id</code> from message</td><td>Incoming</td><td>if there is no matched chat, it might be the first message from public key <code>P</code>; the node MAY discard the message or MAY create a new chat; Status official clients create a new chat</td></tr>
<tr><td>PRIVATE_GROUP</td><td>use <code>chatId</code> from the message</td><td>Incoming/Outgoing</td><td>find an existing chat by <code>chatId</code>; if none is found, the user is not a member of that chat or the user hasn't joined that chat, the message MUST be discarded</td></tr>
</tbody></table>
</div>
<h3 id="contact-update-1"><a class="header" href="#contact-update-1">Contact Update</a></h3>
<p><code>ContactUpdate</code> is a message exchange to notify peers that either the
user has been added as a contact, or that information about the sending user have
changed.</p>
<pre><code class="language-protobuf">message ContactUpdate {
  uint64 clock = 1;
  string ens_name = 2;
  string profile_image = 3;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>The clock of the chat with the user</td></tr>
<tr><td>2</td><td>ens_name</td><td><code>string</code></td><td>The ENS name if set</td></tr>
<tr><td>3</td><td>profile_image</td><td><code>string</code></td><td>The base64 encoded profile picture of the user</td></tr>
</tbody></table>
</div>
<h4 id="contact-update-2"><a class="header" href="#contact-update-2">Contact update</a></h4>
<p>A client SHOULD send a <code>ContactUpdate</code> to all the contacts each time:</p>
<ul>
<li>The ens_name has changed</li>
<li>A user edits the profile image</li>
</ul>
<p>A client SHOULD also periodically send a <code>ContactUpdate</code> to all the contacts, the interval is up to the client,
the Status official client sends these updates every 48 hours.</p>
<h3 id="syncinstallationcontact"><a class="header" href="#syncinstallationcontact">SyncInstallationContact</a></h3>
<p>The node uses <code>SyncInstallationContact</code> messages to synchronize in a best-effort the contacts to other devices.</p>
<pre><code class="language-protobuf">message SyncInstallationContact {
  uint64 clock = 1;
  string id = 2;
  string profile_image = 3;
  string ens_name = 4;
  uint64 last_updated = 5;
  repeated string system_tags = 6;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>clock value of the chat</td></tr>
<tr><td>2</td><td>id</td><td><code>string</code></td><td>id of the contact synced</td></tr>
<tr><td>3</td><td>profile_image</td><td><code>string</code></td><td><code>base64</code> encoded profile picture of the user</td></tr>
<tr><td>4</td><td>ens_name</td><td><code>string</code></td><td>ENS name of the contact</td></tr>
<tr><td>5</td><td><code>array[string]</code></td><td>Array of <code>system_tags</code> for the user, this can currently be: <code>":contact/added", ":contact/blocked", ":contact/request-received"</code></td><td></td></tr>
</tbody></table>
</div>
<h3 id="syncinstallationpublicchat-1"><a class="header" href="#syncinstallationpublicchat-1">SyncInstallationPublicChat</a></h3>
<p>The node uses <code>SyncInstallationPublicChat</code> message to synchronize in a best-effort the public chats to other devices.</p>
<pre><code class="language-protobuf">message SyncInstallationPublicChat {
  uint64 clock = 1;
  string id = 2;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>clock value of the chat</td></tr>
<tr><td>2</td><td>id</td><td><code>string</code></td><td>id of the chat synced</td></tr>
</tbody></table>
</div>
<h3 id="pairinstallation"><a class="header" href="#pairinstallation">PairInstallation</a></h3>
<p>The node uses <code>PairInstallation</code> messages to propagate information about a device to its paired devices.</p>
<pre><code class="language-protobuf">message PairInstallation {
  uint64 clock = 1;
  string installation_id = 2;
  string device_type = 3;
  string name = 4;
}
</code></pre>
<p>Payload</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td>clock</td><td><code>uint64</code></td><td>clock value of the chat</td></tr>
<tr><td>2</td><td>installation_id</td><td><code>string</code></td><td>A randomly generated id that identifies this device</td></tr>
<tr><td>3</td><td>device_type</td><td><code>string</code></td><td>The OS of the device <code>ios</code>,<code>android</code> or <code>desktop</code></td></tr>
<tr><td>4</td><td>name</td><td><code>string</code></td><td>The self-assigned name of the device</td></tr>
</tbody></table>
</div>
<h3 id="membershipupdatemessage-and-membershipupdateevent-1"><a class="header" href="#membershipupdatemessage-and-membershipupdateevent-1">MembershipUpdateMessage and MembershipUpdateEvent</a></h3>
<p><code>MembershipUpdateEvent</code> is a message used to propagate information about group membership changes in a group chat.
The details are in the <a href="status/deprecated//status/deprecated/group-chat.html">Group chats specs</a>.</p>
<h2 id="upgradability-1"><a class="header" href="#upgradability-1">Upgradability</a></h2>
<p>There are two ways to upgrade the protocol without breaking compatibility:</p>
<ul>
<li>A node always supports accretion</li>
<li>A node does not support deletion of existing fields or messages, which might break compatibility</li>
</ul>
<h2 id="security-considerations-25"><a class="header" href="#security-considerations-25">Security Considerations</a></h2>
<h2 id="changelog-9"><a class="header" href="#changelog-9">Changelog</a></h2>
<h3 id="version-03-5"><a class="header" href="#version-03-5">Version 0.3</a></h3>
<p>Released <a href="https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8">May 22, 2020</a></p>
<ul>
<li>Added language to include Waku in all relevant places</li>
</ul>
<h2 id="copyright-80"><a class="header" href="#copyright-80">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-67"><a class="header" href="#references-67">References</a></h2>
<p><a href="https://status.im/whitepaper.pdf">Status Whitepaper</a><br />
<a href="https://developers.google.com/protocol-buffers/">protobuf record</a><br />
<a href="https://developers.google.com/protocol-buffers">Protobuf</a><br />
<a href="status/deprecated//status/deprecated/account.html">Status user account</a><br />
<a href="status/deprecated/deprecated/account/#contact-verification">ens name or the 3-word pseudonym corresponding to the key</a><br />
<a href="status/deprecated//status/deprecated/whisper-usage.html">WHISPER-USAGE</a><br />
<a href="status/deprecated//status/deprecated/waku-usage.html">WAKU-USAGE</a><br />
<a href="https://en.wikipedia.org/wiki/Lamport_timestamps">Lamport timestamps</a><br />
<a href="status/deprecated//status/deprecated/group-chat.html">Group chats specs</a><br />
<a href="https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8">May 22, 2020 change commit</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="push-notification-server-1"><a class="header" href="#push-notification-server-1">PUSH-NOTIFICATION-SERVER</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Push notification server</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Andrea Maria Piana &lt;andreap@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-85"><a class="header" href="#timeline-85">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/deprecated/push-notification-server.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/deprecated/push-notification-server.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/614348a4982aa9e519ccff8b8fbcd4c554683288/status/deprecated/push-notification-server.md"><code>614348a</code></a> — Status deprecated update2 (#134)</li>
</ul>
<!-- timeline:end -->
<h2 id="reason"><a class="header" href="#reason">Reason</a></h2>
<p>Push notifications for iOS devices and some Android devices can only be implemented by relying on <a href="https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/APNSOverview.html#//apple_ref/doc/uid/TP40008194-CH8-SW1">APN service</a> for iOS or <a href="https://firebase.google.com/">Firebase</a>.</p>
<p>This is useful for Android devices that do not support foreground services
or that often kill the foreground service.</p>
<p>iOS only allows certain kind of applications to keep a connection open when in the
background, VoIP for example, which current status client does not qualify for.</p>
<p>Applications on iOS can also request execution time when they are in the <a href="https://developer.apple.com/documentation/uikit/app_and_environment/scenes/preparing_your_ui_to_run_in_the_background/updating_your_app_with_background_app_refresh">background</a>
but it has a limited set of use cases, for example it won't schedule any time
if the application was force quit,
and generally is not responsive enough to implement a push notification system.</p>
<p>Therefore Status provides a set of Push notification services
that can be used to achieve this functionality.</p>
<p>Because this can't be safely implemented in a privacy preserving manner,
clients MUST be given an option to opt-in to receiving and sending push notifications.
They are disabled by default.</p>
<h2 id="requirements-4"><a class="header" href="#requirements-4">Requirements</a></h2>
<p>The party releasing the app MUST possess a certificate for the Apple Push Notification service
and its has to run a <a href="https://github.com/appleboy/gorush">gorush</a> publicly accessible server for sending the actual notification.
The party releasing the app, Status in this case, needs to run its own <a href="https://github.com/appleboy/gorush">gorush</a></p>
<h2 id="components-2"><a class="header" href="#components-2">Components</a></h2>
<h3 id="gorush-instance"><a class="header" href="#gorush-instance">Gorush instance</a></h3>
<p>A <a href="https://github.com/appleboy/gorush">gorush</a> instance MUST be publicly available,
this will be used only by push notification servers.</p>
<h3 id="push-notification-server-2"><a class="header" href="#push-notification-server-2">Push notification server</a></h3>
<p>A push notification server used by clients to register for receiving and sending push notifications.</p>
<h3 id="registering-client-1"><a class="header" href="#registering-client-1">Registering client</a></h3>
<p>A Status client that wants to receive push notifications</p>
<h3 id="sending-client-1"><a class="header" href="#sending-client-1">Sending client</a></h3>
<p>A Status client that wants to send push notifications</p>
<h2 id="registering-with-the-push-notification-service"><a class="header" href="#registering-with-the-push-notification-service">Registering with the push notification service</a></h2>
<p>A client MAY register with one or more Push Notification services of their choice.</p>
<p>A <code>PNR message</code> (Push Notification Registration) MUST be sent to the <a href="status/deprecated/status/deprecated/waku-usage/#partitioned-topic">partitioned topic</a>
for the public key of the node, encrypted with this key.</p>
<p>The message MUST be wrapped in a <a href="status/deprecated/status/deprecated/payload/#payload-wrapper"><code>ApplicationMetadataMessage</code></a> with type set to <code>PUSH_NOTIFICATION_REGISTRATION</code>.</p>
<p>The marshaled protobuf payload MUST also be encrypted with AES-GCM
using the Diffie–Hellman key generated from the client and server identity.</p>
<p>This is done in order to ensure that the extracted key from the signature will be
considered invalid if it can't decrypt the payload.</p>
<p>The content of the message MUST contain the following <a href="https://developers.google.com/protocol-buffers/">protobuf record</a>:</p>
<pre><code class="language-protobuf">message PushNotificationRegistration {
  enum TokenType {
    UNKNOWN_TOKEN_TYPE = 0;
    APN_TOKEN = 1;
    FIREBASE_TOKEN = 2;
  }
  TokenType token_type = 1;
  string device_token = 2;
  string installation_id = 3;
  string access_token = 4;
  bool enabled = 5;
  uint64 version = 6;
  repeated bytes allowed_key_list = 7;
  repeated bytes blocked_chat_list = 8;
  bool unregister = 9;
  bytes grant = 10;
  bool allow_from_contacts_only = 11;
  string apn_topic = 12;
  bool block_mentions = 13;
  repeated bytes allowed_mentions_chat_list = 14;
}
</code></pre>
<p>A push notification server will handle the message according to the following rules:</p>
<ul>
<li>it MUST extract the public key of the sender from the signature and verify that
the payload can be decrypted successfully.</li>
<li>it MUST verify that <code>token_type</code> is supported</li>
<li>it MUST verify that <code>device_token</code> is non empty</li>
<li>it MUST verify that <code>installation_id</code> is non empty</li>
<li>it MUST verify that <code>version</code> is non-zero and greater than the currently stored version for the public key and installation id of the sender, if any</li>
<li>it MUST verify that <code>grant</code> is non empty and according to the <a href="status/deprecated/push-notification-server.html#server-grant">specs</a></li>
<li>it MUST verify that <code>access_token</code> is a valid <a href="https://tools.ietf.org/html/rfc4122"><code>uuid</code></a></li>
<li>it MUST verify that <code>apn_topic</code> is set if <code>token_type</code> is <code>APN_TOKEN</code></li>
</ul>
<p>If the message can't be decrypted, the message MUST be discarded.</p>
<p>If <code>token_type</code> is not supported, a response MUST be sent with <code>error</code> set to
<code>UNSUPPORTED_TOKEN_TYPE</code>.</p>
<p>If <code>token</code>,<code>installation_id</code>,<code>device_tokens</code>,<code>version</code> are empty, a response MUST
be sent with <code>error</code> set to <code>MALFORMED_MESSAGE</code>.</p>
<p>If the <code>version</code> is equal or less than the currently stored version, a response MUST
be sent with <code>error</code> set to <code>VERSION_MISMATCH</code>.</p>
<p>If any other error occurs the <code>error</code> should be set to <code>INTERNAL_ERROR</code>.</p>
<p>If the response is successful <code>success</code> MUST be set to <code>true</code> otherwise a response MUST be sent with <code>success</code> set to <code>false</code>.</p>
<p><code>request_id</code> should be set to the <code>SHAKE-256</code> of the encrypted payload.</p>
<p>The response MUST be sent on the <a href="status/deprecated/status/deprecated/waku-usage.html#partitioned-topic">partitioned topic</a> of the sender
and MUST not be encrypted using the <a href="status/deprecated/status/deprecated/secure-transport">secure transport</a> to facilitate the usage of ephemeral keys.</p>
<p>The payload of the response is:</p>
<pre><code class="language-protobuf">message PushNotificationRegistrationResponse {
  bool success = 1;
  ErrorType error = 2;
  bytes request_id = 3;

  enum ErrorType {
    UNKNOWN_ERROR_TYPE = 0;
    MALFORMED_MESSAGE = 1;
    VERSION_MISMATCH = 2;
    UNSUPPORTED_TOKEN_TYPE = 3;
    INTERNAL_ERROR = 4;
  }
}
</code></pre>
<p>The message MUST be wrapped in a <a href="status/deprecated/status/deprecated/payloads.html#payload-wrapper"><code>ApplicationMetadataMessage</code></a> with type set to <code>PUSH_NOTIFICATION_REGISTRATION_RESPONSE</code>.</p>
<p>A client SHOULD listen for a response sent on the <a href="status/deprecated/status/deprecated/waku-usage/#partitioned-topic">partitioned topic</a>
that the key used to register.</p>
<p>If <code>success</code> is <code>true</code> the client has registered successfully.</p>
<p>If <code>success</code> is <code>false</code>:</p>
<ul>
<li>If <code>MALFORMED_MESSAGE</code> is returned, the request SHOULD NOT be retried without ensuring that it is correctly formed.</li>
<li>If <code>INTERNAL_ERROR</code> is returned, the request MAY be retried, but the client MUST backoff exponentially</li>
</ul>
<p>A client MAY register with multiple Push Notification Servers in order to increase availability.</p>
<p>A client SHOULD make sure that all the notification services they registered with have the same information about their tokens.</p>
<p>If no response is returned the request SHOULD be considered failed and MAY be retried with the same server or a different one, but clients MUST exponentially backoff after each trial.</p>
<p>If the request is successful the token SHOULD be <a href="status/deprecated/push-notification-server.html#advertising-a-push-notification-server">advertised</a> as described below</p>
<h3 id="query-topic-1"><a class="header" href="#query-topic-1">Query topic</a></h3>
<p>On successful registration the server MUST be listening to the topic derived from:</p>
<pre><code class="language-protobuf">   0XHexEncode(Shake256(CompressedClientPublicKey))
</code></pre>
<p>Using the topic derivation algorithm described <a href="status/deprecated/status/deprecated/waku-usage/#public-chats">here</a>
and listen for client queries.</p>
<h3 id="server-grant-1"><a class="header" href="#server-grant-1">Server grant</a></h3>
<p>A push notification server needs to demonstrate to a client that it was authorized
by the client to send them push notifications. This is done by building
a grant which is specific to a given client-server pair.
The grant is built as follow:</p>
<pre><code class="language-protobuf">   Signature(Keccak256(CompressedPublicKeyOfClient . CompressedPublicKeyOfServer . AccessToken), PrivateKeyOfClient)
</code></pre>
<p>When receiving a grant the server MUST be validate that the signature matches the registering client.</p>
<h2 id="re-registering-with-the-push-notification-server"><a class="header" href="#re-registering-with-the-push-notification-server">Re-registering with the push notification server</a></h2>
<p>A client SHOULD re-register with the node if the APN or FIREBASE token changes.</p>
<p>When re-registering a client SHOULD ensure that it has the most up-to-date
<code>PushNotificationRegistration</code> and increment <code>version</code> if necessary.</p>
<p>Once re-registered, a client SHOULD advertise the changes.</p>
<h2 id="changing-options"><a class="header" href="#changing-options">Changing options</a></h2>
<p>This is handled in exactly the same way as re-registering above.</p>
<h2 id="unregistering-from-push-notifications"><a class="header" href="#unregistering-from-push-notifications">Unregistering from push notifications</a></h2>
<p>To unregister a client MUST send a <code>PushNotificationRegistration</code> request as described
above with <code>unregister</code> set to <code>true</code>, or removing
their device information.</p>
<p>The server MUST remove all data about this user if <code>unregistering</code> is <code>true</code>,
apart from the <code>hash</code> of the public key and the <code>version</code> of the last options,
in order to make sure that old messages are not processed.</p>
<p>A client MAY unregister from a server on explicit logout if multiple chat keys
are used on a single device.</p>
<h2 id="advertising-a-push-notification-server"><a class="header" href="#advertising-a-push-notification-server">Advertising a push notification server</a></h2>
<p>Each user registered with one or more push notification servers SHOULD
advertise periodically the push notification services that they have registered with for each device they own.</p>
<pre><code class="language-protobuf">message PushNotificationQueryInfo {
  string access_token = 1;
  string installation_id = 2;
  bytes public_key = 3;
  repeated bytes allowed_user_list = 4;
  bytes grant = 5;
  uint64 version = 6;
  bytes server_public_key = 7;
}

message ContactCodeAdvertisement {
  repeated PushNotificationQueryInfo push_notification_info = 1;
}
</code></pre>
<p>The message MUST be wrapped in a <a href="status/deprecated/status/deprecated/payloads/#payload-wrapper"><code>ApplicationMetadataMessage</code></a> with type set to <code>PUSH_NOTIFICATION_QUERY_INFO</code>.</p>
<p>If no filtering is done based on public keys,
the access token SHOULD be included in the advertisement.
Otherwise it SHOULD be left empty.</p>
<p>This SHOULD be advertised on the <a href="status/deprecated//status/deprecated/waku-usage.html#contact-code-topic">contact code topic</a>
and SHOULD be coupled with normal contact-code advertisement.</p>
<p>Every time a user register or re-register with a push notification service, their
contact-code SHOULD be re-advertised.</p>
<p>Multiple servers MAY be advertised for the same <code>installation_id</code> for redundancy reasons.</p>
<h2 id="discovering-a-push-notification-server"><a class="header" href="#discovering-a-push-notification-server">Discovering a push notification server</a></h2>
<p>To discover a push notification service for a given user, their <a href="status/deprecated/status/deprecated/waku-usage/#contact-code-topic">contact code topic</a>
SHOULD be listened to.
A mailserver can be queried for the specific topic to retrieve the most up-to-date
contact code.</p>
<h2 id="querying-the-push-notification-server"><a class="header" href="#querying-the-push-notification-server">Querying the push notification server</a></h2>
<p>If a token is not present in the latest advertisement for a user, the server
SHOULD be queried directly.</p>
<p>To query a server a message:</p>
<pre><code class="language-protobuf">message PushNotificationQuery {
  repeated bytes public_keys = 1;
}
</code></pre>
<p>The message MUST be wrapped in a <a href="status/deprecated/status/deprecated/payloads/#payload-wrapper"><code>ApplicationMetadataMessage</code></a> with type set to <code>PUSH_NOTIFICATION_QUERY</code>.</p>
<p>MUST be sent to the server on the topic derived from the hashed public key of the
key we are querying, as <a href="status/deprecated/push-notification-server.html#query-topic">described above</a>.</p>
<p>An ephemeral key SHOULD be used and SHOULD NOT be encrypted using the <a href="status/deprecated/status/deprecated/secure-transport.html">secure transport</a>.</p>
<p>If the server has information about the client a response MUST be sent:</p>
<pre><code class="language-protobuf">message PushNotificationQueryInfo {
  string access_token = 1;
  string installation_id = 2;
  bytes public_key = 3;
  repeated bytes allowed_user_list = 4;
  bytes grant = 5;
  uint64 version = 6;
  bytes server_public_key = 7;
}

message PushNotificationQueryResponse {
  repeated PushNotificationQueryInfo info = 1;
  bytes message_id = 2;
  bool success = 3;
}
</code></pre>
<p>A <code>PushNotificationQueryResponse</code> message MUST be wrapped in a <a href="status/deprecated/status/deprecated/payloads.html#payload-wrapper"><code>ApplicationMetadataMessage</code></a> with type set to <code>PUSH_NOTIFICATION_QUERY_RESPONSE</code>.</p>
<p>Otherwise a response MUST NOT be sent.</p>
<p>If <code>allowed_key_list</code> is not set <code>access_token</code> MUST be set and <code>allowed_key_list</code> MUST NOT
be set.</p>
<p>If <code>allowed_key_list</code> is set <code>allowed_key_list</code> MUST be set and <code>access_token</code> MUST NOT be set.</p>
<p>If <code>access_token</code> is returned, the <code>access_token</code> SHOULD be used to send push notifications.</p>
<p>If <code>allowed_key_list</code> are returned, the client SHOULD decrypt each
token by generating an <code>AES-GCM</code> symmetric key from the Diffie–Hellman between the
target client and itself
If AES decryption succeeds it will return a valid <a href="https://tools.ietf.org/html/rfc4122"><code>uuid</code></a> which is what is used for access_token.
The token SHOULD be used to send push notifications.</p>
<p>The response MUST be sent on the <a href="status/deprecated/status/deprecated/waku-usage/#partitioned-topic">partitioned topic</a> of the sender
and MUST not be encrypted using the <a href="status/deprecated/status/deprecated/secure-transport.html">secure transport</a> to facilitate
the usage of ephemeral keys.</p>
<p>On receiving a response a client MUST verify <code>grant</code> to ensure that the server
has been authorized to send push notification to a given client.</p>
<h2 id="sending-a-push-notification"><a class="header" href="#sending-a-push-notification">Sending a push notification</a></h2>
<p>When sending a push notification, only the <code>installation_id</code> for the devices targeted
by the message SHOULD be used.</p>
<p>If a message is for all the user devices, all the <code>installation_id</code> known to the client MAY be used.</p>
<p>The number of devices MAY be capped in order to reduce resource consumption.</p>
<p>At least 3 devices SHOULD be targeted, ordered by last activity.</p>
<p>For any device that a token is available, or that a token is successfully queried,
a push notification message SHOULD be sent to the corresponding push notification server.</p>
<pre><code class="language-protobuf">message PushNotification {
  string access_token = 1;
  string chat_id = 2;
  bytes public_key = 3;
  string installation_id = 4;
  bytes message = 5;
  PushNotificationType type = 6;
  enum PushNotificationType {
    UNKNOWN_PUSH_NOTIFICATION_TYPE = 0;
    MESSAGE = 1;
    MENTION = 2;
  }
  bytes author = 7;
}

message PushNotificationRequest {
  repeated PushNotification requests = 1;
  bytes message_id = 2;
}
</code></pre>
<p>A <code>PushNotificationRequest</code> message MUST be wrapped in a <a href="status/deprecated//status/deprecated/payloads.html#payload-wrapper"><code>ApplicationMetadataMessage</code></a> with type set to <code>PUSH_NOTIFICATION_REQUEST</code>.</p>
<p>Where <code>message</code> is the encrypted payload of the message and <code>chat_id</code> is the
<code>SHAKE-256</code> of the <code>chat_id</code>.
<code>message_id</code> is the id of the message
<code>author</code> is the <code>SHAKE-256</code> of the public key of the sender.</p>
<p>If multiple server are available for a given push notification, only one notification
MUST be sent.</p>
<p>If no response is received
a client SHOULD wait at least 3 seconds, after which the request MAY be retried against a different server</p>
<p>This message SHOULD be sent using an ephemeral key.</p>
<p>On receiving the message, the push notification server MUST validate the access token.
If the access token is valid, a notification MUST be sent to the gorush instance with the
following data:</p>
<pre><code class="language-protobuf">{
  "notifications": [
    {
      "tokens": ["token_a", "token_b"],
      "platform": 1,
      "message": "You have a new message",
      "data": {
        "chat_id": chat_id,
        "message": message,
        "installation_ids": [installation_id_1, installation_id_2]
      }
    }
  ]
}
</code></pre>
<p>Where platform is <code>1</code> for IOS and <code>2</code> for Firebase, according to the <a href="https://github.com/appleboy/gorush">gorush documentation</a></p>
<p>A server MUST return a response message:</p>
<pre><code class="language-protobuf">message PushNotificationReport {
  bool success = 1;
  ErrorType error = 2;
  enum ErrorType {
    UNKNOWN_ERROR_TYPE = 0;
    WRONG_TOKEN = 1;
    INTERNAL_ERROR = 2;
    NOT_REGISTERED = 3;
  }
  bytes public_key = 3;
  string installation_id = 4;
}

message PushNotificationResponse {
  bytes message_id = 1;
  repeated PushNotificationReport reports = 2;
}
</code></pre>
<p>A <code>PushNotificationResponse</code> message MUST be wrapped in a <a href="status/deprecated//status/deprecated/payloads.html#payload-wrapper"><code>ApplicationMetadataMessage</code></a> with type set to <code>PUSH_NOTIFICATION_RESPONSE</code>.</p>
<p>Where <code>message_id</code> is the <code>message_id</code> sent by the client.</p>
<p>The response MUST be sent on the <a href="status/deprecated//status/deprecated/waku-usage.html#partitioned-topic">partitioned topic</a> of the sender
and MUST not be encrypted using the <a href="status/deprecated//status/deprecated/secure-transport.html">secure transport</a> to facilitate
the usage of ephemeral keys.</p>
<p>If the request is accepted <code>success</code> MUST be set to <code>true</code>.
Otherwise <code>success</code> MUST be set to <code>false</code>.</p>
<p>If <code>error</code> is <code>BAD_TOKEN</code> the client MAY query again the server for the token and
retry the request.</p>
<p>If <code>error</code> is <code>INTERNAL_ERROR</code> the client MAY retry the request.</p>
<h2 id="flow-10"><a class="header" href="#flow-10">Flow</a></h2>
<h3 id="registration-process-1"><a class="header" href="#registration-process-1">Registration process</a></h3>
<ul>
<li>A client will generate a notification token through <code>APN</code> or <code>Firebase</code>.</li>
<li>The client will <a href="status/deprecated/push-notification-server.html#registering-with-the-push-notification-service">register</a> with one or more push notification server of their choosing.</li>
<li>The server should process the response and respond according to the success of the operation</li>
<li>If the request is not successful it might be retried, and adjusted according to the response. A different server can be also used.</li>
<li>Once the request is successful the client should <a href="status/deprecated/push-notification-server.html#advertising-a-push-notification-server">advertise</a> the new coordinates</li>
</ul>
<h3 id="sending-a-notification"><a class="header" href="#sending-a-notification">Sending a notification</a></h3>
<ul>
<li>A client should prepare a message and extract the targeted installation-ids</li>
<li>It should retrieve the most up to date information for a given user, either by
querying a push notification server, a mailserver if not listening already to the given topic, or checking
the database locally</li>
<li>It should then <a href="status/deprecated/push-notification-server.html#sending-a-push-notification">send</a> a push notification according
to the rules described</li>
<li>The server should then send a request to the gorush server including all the required
information</li>
</ul>
<h3 id="receiving-a-push-notification"><a class="header" href="#receiving-a-push-notification">Receiving a push notification</a></h3>
<ul>
<li>On receiving the notification, a client can open the right account by checking the
<code>installation_id</code> included. The <code>chat_id</code> MAY be used to open the chat if present.</li>
<li><code>message</code> can be decrypted and presented to the user. Otherwise messages can be pulled from the mailserver if the <code>message_id</code> is no already present.</li>
</ul>
<h2 id="protobuf-description-1"><a class="header" href="#protobuf-description-1">Protobuf description</a></h2>
<h3 id="pushnotificationregistration-1"><a class="header" href="#pushnotificationregistration-1">PushNotificationRegistration</a></h3>
<p><code>token_type</code>: the type of token. Currently supported is <code>APN_TOKEN</code> for Apple Push
<code>device_token</code>: the actual push notification token sent by <code>Firebase</code> or <code>APN</code>
and <code>FIREBASE_TOKEN</code> for firebase.
<code>installation_id</code>: the <a href="status/deprecated//status/deprecated/account.html"><code>installation_id</code></a> of the device
<code>access_token</code>: the access token that will be given to clients to send push notifications
<code>enabled</code>: whether the device wants to be sent push notifications
<code>version</code>: a monotonically increasing number identifying the current <code>PushNotificationRegistration</code>. Any time anything is changed in the record it MUST be increased by the client, otherwise the request will not be accepted.
<code>allowed_key_list</code>: a list of <code>access_token</code> encrypted with the AES key generated
by Diffie–Hellman between the publisher and the allowed
contact.
<code>blocked_chat_list</code>: a list of <code>SHA2-256</code> hashes of chat ids.
Any chat id in this list will not trigger a notification.
<code>unregister</code>: whether the account should be unregistered
<code>grant</code>: the grant for this specific server
<code>allow_from_contacts_only</code>: whether the client only wants push notifications from contacts
<code>apn_topic</code>: the APN topic for the push notification
<code>block_mentions</code>: whether the client does not want to be notified on mentions
<code>allowed_mentions_chat_list</code>:  a list of <code>SHA2-256</code> hashes of chat ids where we want to receive mentions</p>
<h4 id="data-disclosed"><a class="header" href="#data-disclosed">Data disclosed</a></h4>
<ul>
<li>Type of device owned by a given user</li>
<li>The <code>FIREBASE</code> or <code>APN</code> push notification token</li>
<li>Hash of the chat_id a user is not interested in for notifications</li>
<li>The times a push notification record has been modified by the user</li>
<li>The number of contacts a client has, in case <code>allowed_key_list</code> is set</li>
</ul>
<h3 id="pushnotificationregistrationresponse-1"><a class="header" href="#pushnotificationregistrationresponse-1">PushNotificationRegistrationResponse</a></h3>
<p><code>success</code>: whether the registration was successful
<code>error</code>: the error type, if any
<code>request_id</code>: the <code>SHAKE-256</code> hash of the <code>signature</code> of the request
<code>preferences</code>: the server stored preferences in case of an error</p>
<h3 id="contactcodeadvertisement-1"><a class="header" href="#contactcodeadvertisement-1">ContactCodeAdvertisement</a></h3>
<p><code>push_notification_info</code>: the information for each device advertised</p>
<p>Data disclosed</p>
<ul>
<li>The chat key of the sender</li>
</ul>
<h3 id="pushnotificationquery-1"><a class="header" href="#pushnotificationquery-1">PushNotificationQuery</a></h3>
<p><code>public_keys</code>: the <code>SHAKE-256</code> of the public keys the client is interested in</p>
<p>Data disclosed</p>
<ul>
<li>The hash of the public keys the client is interested in</li>
</ul>
<h3 id="pushnotificationqueryinfo-1"><a class="header" href="#pushnotificationqueryinfo-1">PushNotificationQueryInfo</a></h3>
<p><code>access_token</code>: the access token used to send a push notification
<code>installation_id</code>: the <code>installation_id</code> of the device associated with the <code>access_token</code>
<code>public_key</code>: the <code>SHAKE-256</code> of the public key associated with this <code>access_token</code> and <code>installation_id</code>
<code>allowed_key_list</code>: a list of encrypted access tokens to be returned
to the client in case there's any filtering on public keys in place.
<code>grant</code>: the grant used to register with this server.
<code>version</code>: the version of the registration on the server.
<code>server_public_key</code>: the compressed public key of the server.</p>
<h3 id="pushnotificationqueryresponse-1"><a class="header" href="#pushnotificationqueryresponse-1">PushNotificationQueryResponse</a></h3>
<p><code>info</code>:  a list of <code>PushNotificationQueryInfo</code>.
<code>message_id</code>: the message id of the <code>PushNotificationQueryInfo</code> the server is replying to.
<code>success</code>: whether the query was successful.</p>
<h3 id="pushnotification-1"><a class="header" href="#pushnotification-1">PushNotification</a></h3>
<p><code>access_token</code>: the access token used to send a push notification.
<code>chat_id</code>: the <code>SHAKE-256</code> of the <code>chat_id</code>.
<code>public_key</code>: the <code>SHAKE-256</code> of the compressed public key of the receiving client.
<code>installation_id</code>: the installation id of the receiving client.
<code>message</code>: the encrypted message that is being notified on.
<code>type</code>: the type of the push notification, either <code>MESSAGE</code> or <code>MENTION</code>
<code>author</code>: the <code>SHAKE-256</code> of the public key of the sender</p>
<p>Data disclosed</p>
<ul>
<li>The <code>SHAKE-256</code> of the <code>chat_id</code> the notification is to be sent for</li>
<li>The cypher text of the message</li>
<li>The <code>SHAKE-256</code> of the public key of the sender</li>
<li>The type of notification</li>
</ul>
<h3 id="pushnotificationrequest-1"><a class="header" href="#pushnotificationrequest-1">PushNotificationRequest</a></h3>
<p><code>requests</code>: a list of <code>PushNotification</code>
<code>message_id</code>: the <a href="status/deprecated//status/deprecated/payloads.html">status message id</a></p>
<p>Data disclosed</p>
<ul>
<li>The status message id for which the notification is for</li>
</ul>
<h3 id="pushnotificationresponse-1"><a class="header" href="#pushnotificationresponse-1">PushNotificationResponse</a></h3>
<p><code>message_id</code>: the <code>message_id</code> being notified on.
<code>reports</code>: a list of <code>PushNotificationReport</code></p>
<h3 id="pushnotificationreport-1"><a class="header" href="#pushnotificationreport-1">PushNotificationReport</a></h3>
<p><code>success</code>: whether the push notification was successful.
<code>error</code>: the type of the error in case of failure.
<code>public_key</code>: the public key of the user being notified.
<code>installation_id</code>: the installation id of the user being notified.</p>
<h2 id="anonymous-mode-of-operations"><a class="header" href="#anonymous-mode-of-operations">Anonymous mode of operations</a></h2>
<p>An anonymous mode of operations MAY be provided by the client, where the
responsibility of propagating information about the user is left to the client,
in order to preserve privacy.</p>
<p>A client in anonymous mode can register with the server using a key different
from their chat key.
This will hide their real chat key.</p>
<p>This public key is effectively a secret and SHOULD only be disclosed to clients that you the user wants to be notified by.</p>
<p>A client MAY advertise the access token on the contact-code topic of the key generated.
A client MAY share their public key through <a href="status/deprecated//status/deprecated/payloads.html#contact-update">contact updates</a></p>
<p>A client receiving a push notification public key SHOULD listen to the contact code
topic of the push notification public key for updates.</p>
<p>The method described above effectively does not share the identity of the sender
nor the receiver to the server, but MAY result in missing push notifications as
the propagation of the secret is left to the client.</p>
<p>This can be mitigated by <a href="status/deprecated//status/deprecated/payloads.html">device syncing</a>, but not completely
addressed.</p>
<h2 id="security-considerations-26"><a class="header" href="#security-considerations-26">Security considerations</a></h2>
<p>If no anonymous mode is used, when registering with a push notification service a client discloses:</p>
<ul>
<li>The chat key</li>
<li>The devices that will receive notifications</li>
</ul>
<p>A client MAY disclose:</p>
<ul>
<li>The hash of the chat_ids they want to filter out</li>
</ul>
<p>When running in anonymous mode, the client's chat key is not disclosed.</p>
<p>When querying a push notification server a client will disclose:</p>
<ul>
<li>That it is interested in sending push notification to another client,
but the querying client's chat key is not disclosed</li>
</ul>
<p>When sending a push notification a client discloses:</p>
<ul>
<li>The <code>SHAKE-256</code> of the chat id</li>
</ul>
<p>[//]: This section can be removed, for now leaving it here in order to help with the
review process. Point can be integrated, suggestion welcome.</p>
<h2 id="faq"><a class="header" href="#faq">FAQ</a></h2>
<h3 id="why-having-acl-done-at-the-server-side-and-not-the-client"><a class="header" href="#why-having-acl-done-at-the-server-side-and-not-the-client">Why having ACL done at the server side and not the client?</a></h3>
<p>We looked into silent notification for
<a href="https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/pushing_background_updates_to_your_app">IOS</a> (android has no equivalent)
but can't be used as it's expected to receive maximum 2/3 per hour, so not our use case. There
are also issue when the user force quit the app.</p>
<h3 id="why-using-an-access-token"><a class="header" href="#why-using-an-access-token">Why using an access token?</a></h3>
<p>The access token is used to decouple the requesting information from the user from
actually sending the push notification.</p>
<p>Some ACL is necessary otherwise it would be too easy to spam users (it's still fairly
trivial, but with this method you could allow only contacts to send you push notifications).</p>
<p>Therefore your identity must be revealed to the server either when sending or querying.</p>
<p>By using an access token we increase deniability, as the server would know
who requested the token but not necessarily who sent a push notification.
Correlation between the two can be trivial in some cases.</p>
<p>This also allows a mode of use as we had before, where the server does not propagate
info at all, and it's left to the user to propagate the token, through contact requests
for example.</p>
<h3 id="why-advertise-with-the-bundle"><a class="header" href="#why-advertise-with-the-bundle">Why advertise with the bundle?</a></h3>
<p>Advertising with the bundle allows us to piggy-back on an already implemented behavior
and save some bandwidth in cases where is not filtering by public keys</p>
<h3 id="whats-the--bandwidth-impact-for-this"><a class="header" href="#whats-the--bandwidth-impact-for-this">What's the  bandwidth impact for this?</a></h3>
<p>Generally speaking, for each 1-to-1 message and group chat message you will sending
1 and <code>number of participants</code> push notifications. This can be optimized if
multiple users are using the same push notification server. Queries have also
a bandwidth impact but they are made only when actually needed</p>
<h3 id="whats-the-information-disclosed"><a class="header" href="#whats-the-information-disclosed">What's the information disclosed?</a></h3>
<p>The data disclosed with each message sent by the client is above, but for a summary:</p>
<p>When you register with a push notification service you may disclose:</p>
<ol>
<li>Your chat key</li>
<li>Which devices you have</li>
<li>The hash of the chat_ids you want to filter out</li>
<li>The hash of the public keys you are interested/not interested in</li>
</ol>
<p>When you query a notification service you may disclose:</p>
<ol>
<li>Your chat key</li>
<li>The fact that you are interested in sending push notification to a given user</li>
</ol>
<p>Effectively this is fairly revealing if the user has a whitelist implemented.
Therefore sending notification should be optional.</p>
<h3 id="what-prevents-a-user-from-generating-a-random-key-and-getting-an-access-token-and-spamming"><a class="header" href="#what-prevents-a-user-from-generating-a-random-key-and-getting-an-access-token-and-spamming">What prevents a user from generating a random key and getting an access token and spamming?</a></h3>
<p>Nothing really, that's the same as the status app as a whole. the only mechanism that prevents
this is using a white-list as described above,
but that implies disclosing your true identity to the push notification server.</p>
<h3 id="why-not-0-knowledge-proofsquantum-computing"><a class="header" href="#why-not-0-knowledge-proofsquantum-computing">Why not 0-knowledge proofs/quantum computing</a></h3>
<p>We start simple, we can iterate</p>
<h3 id="how-to-handle-backwardforward-compatibility"><a class="header" href="#how-to-handle-backwardforward-compatibility">How to handle backward/forward compatibility</a></h3>
<p>Most of the request have a target, so protocol negotiation can happen. We cannot negotiated
the advertisement as that's effectively a broadcast, but those info should not change and we can
always accrete the message.</p>
<h3 id="why-ack_key"><a class="header" href="#why-ack_key">Why ack_key?</a></h3>
<p>That's necessary to avoid duplicated push notifications and allow for the retry
in case the notification is not successful.</p>
<p>Deduplication of the push notification is done on the client side, to reduce a bit
of centralization and also in order not to have to modify gorush.</p>
<h3 id="can-i-run-my-own-node"><a class="header" href="#can-i-run-my-own-node">Can I run my own node?</a></h3>
<p>Sure, the methods allow that</p>
<h3 id="can-i-register-with-multiple-nodes-for-redundancy"><a class="header" href="#can-i-register-with-multiple-nodes-for-redundancy">Can I register with multiple nodes for redundancy</a></h3>
<p>Yep</p>
<h3 id="what-does-my-node-disclose"><a class="header" href="#what-does-my-node-disclose">What does my node disclose?</a></h3>
<p>Your node will disclose the IP address is running from, as it makes an HTTP post to
gorush. A waku adapter could be used, but please not now.</p>
<h3 id="does-this-have-high-reliability-requirements"><a class="header" href="#does-this-have-high-reliability-requirements">Does this have high-reliability requirements?</a></h3>
<p>The gorush server yes, no way around it.</p>
<p>The rest, kind of, at least one node having your token needs to be up for you to receive notifications.
But you can register with multiple servers (desktop, status, etc) if that's a concern.</p>
<h3 id="can-someone-else-ie-not-status-run-this"><a class="header" href="#can-someone-else-ie-not-status-run-this">Can someone else (i.e not status) run this?</a></h3>
<p>Push notification servers can be run by anyone. Gorush can be run by anyone I take,
but we are in charge of the certificate, so they would not be able to notify status-clients.</p>
<h2 id="changelog-10"><a class="header" href="#changelog-10">Changelog</a></h2>
<h3 id="version-01-2"><a class="header" href="#version-01-2">Version 0.1</a></h3>
<p><a href="https://github.com/status-im/specs/commit/">Released</a></p>
<ul>
<li>Initial version</li>
</ul>
<h2 id="copyright-81"><a class="header" href="#copyright-81">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-68"><a class="header" href="#references-68">References</a></h2>
<ul>
<li><a href="https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/APNSOverview.html#//apple_ref/doc/uid/TP40008194-CH8-SW1">APN Service</a></li>
<li><a href="https://developer.apple.com/documentation/uikit/app_and_environment/scenes/preparing_your_ui_to_run_in_the_background/updating_your_app_with_background_app_refresh">Background Execution on iOS</a></li>
<li><a href="https://firebase.google.com/">Firebase</a></li>
<li><a href="https://github.com/appleboy/gorush">Gorush</a></li>
<li><a href="https://tools.ietf.org/html/rfc4122">UUID Specification</a></li>
<li><a href="status/deprecated//status/deprecated/secure-transport.html">Secure Transport</a></li>
<li><a href="https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/pushing_background_updates_to_your_app">Silent Notifications on iOS</a></li>
<li><a href="status/deprecated//status/deprecated/waku-usage.html">Waku Usage</a></li>
<li><a href="https://github.com/ensdomains/ens">ENS Contract</a></li>
<li><a href="status/deprecated//status/deprecated/payloads.html">Payloads</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="secure-transport-2"><a class="header" href="#secure-transport-2">SECURE-TRANSPORT</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Secure Transport</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Andrea Maria Piana &lt;andreap@status.im&gt;<br>Corey Petty &lt;corey@status.im&gt;<br>Dean Eigenmann &lt;dean@status.im&gt;<br>Oskar Thorén &lt;oskar@status.im&gt;<br>Pedro Pombeiro &lt;pedro@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-86"><a class="header" href="#timeline-86">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/deprecated/secure-transport.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/deprecated/secure-transport.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/614348a4982aa9e519ccff8b8fbcd4c554683288/status/deprecated/secure-transport.md"><code>614348a</code></a> — Status deprecated update2 (#134)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-59"><a class="header" href="#abstract-59">Abstract</a></h2>
<p>This document describes how Status provides a secure channel between two peers,
and thus provide confidentiality, integrity, authenticity and forward secrecy.
It is transport-agnostic and works over asynchronous networks.</p>
<p>It builds on the <a href="https://signal.org/docs/specifications/x3dh/">X3DH</a> and <a href="https://signal.org/docs/specifications/doubleratchet/">Double Ratchet</a> specifications, with some adaptations to operate in a decentralized environment.</p>
<h2 id="introduction-13"><a class="header" href="#introduction-13">Introduction</a></h2>
<p>This document describes how nodes establish a secure channel,
and how various conversational security properties are achieved.</p>
<h3 id="definitions-13"><a class="header" href="#definitions-13">Definitions</a></h3>
<ul>
<li>
<p><strong>Perfect Forward Secrecy</strong> is a feature of specific key-agreement protocols
which provide assurances that session keys will not be compromised even if the private keys of the participants are compromised.
Specifically, past messages cannot be decrypted by a third-party who manages to get a hold of a private key.</p>
</li>
<li>
<p><strong>Secret channel</strong> describes a communication channel where Double Ratchet algorithm is in use.</p>
</li>
</ul>
<h3 id="design-requirements-6"><a class="header" href="#design-requirements-6">Design Requirements</a></h3>
<ul>
<li><strong>Confidentiality</strong>: The adversary should not be able to learn what data is being exchanged between two Status clients.</li>
<li><strong>Authenticity</strong>: The adversary should not be able to cause either endpoint of a Status 1:1 chat
to accept data from any third party as though it came from the other endpoint.</li>
<li><strong>Forward Secrecy</strong>: The adversary should not be able to learn
what data was exchanged between two Status clients if, at some later time,
the adversary compromises one or both of the endpoint devices.</li>
<li><strong>Integrity</strong>: The adversary should not be able to cause either endpoint of a Status 1:1 chat
to accept data that has been tampered with.</li>
</ul>
<p>All of these properties are ensured by the use of <a href="https://signal.org/docs/specifications/doubleratchet/">Signal's Double Ratchet</a></p>
<h3 id="conventions-2"><a class="header" href="#conventions-2">Conventions</a></h3>
<p>Types used in this specification are defined using <a href="https://developers.google.com/protocol-buffers/">Protobuf</a>.</p>
<h3 id="transport-layer"><a class="header" href="#transport-layer">Transport Layer</a></h3>
<p><a href="status/deprecated/status/deprecated/whisper-usage">Whisper</a> and <a href="status/deprecated/status/deprecated/waku-usage">Waku</a> serves as the transport layers for the Status chat protocol.</p>
<h3 id="user-flow-for-1-to-1-communications"><a class="header" href="#user-flow-for-1-to-1-communications">User flow for 1-to-1 communications</a></h3>
<h4 id="account-generation"><a class="header" href="#account-generation">Account generation</a></h4>
<p>See <a href="status/deprecated/status/deprecated/account">Account specification</a></p>
<h4 id="account-recovery-1"><a class="header" href="#account-recovery-1">Account recovery</a></h4>
<p>If Alice later recovers her account, the Double Ratchet state information will not be available,
so she is no longer able to decrypt any messages received from existing contacts.</p>
<p>If an incoming message (on the same Whisper/Waku topic) fails to decrypt,
the node replies a message with the current bundle, so that the node notifies the other end of the new device.
Subsequent communications will use this new bundle.</p>
<h2 id="messaging"><a class="header" href="#messaging">Messaging</a></h2>
<p>All 1:1 and group chat messaging in Status is subject to end-to-end encryption
to provide users with a strong degree of privacy and security.
Public chat messages are publicly readable by anyone since there's no permission model
for who is participating in a public chat.</p>
<p>The rest of this document is purely about 1:1 and private group chat.
Private group chat largely reduces to 1:1 chat, since there's a secure channel between each pair-wise participant.</p>
<h3 id="end-to-end-encryption-1"><a class="header" href="#end-to-end-encryption-1">End-to-end encryption</a></h3>
<p>End-to-end encryption (E2EE) takes place between two clients.
The main cryptographic protocol is a <a href="https://github.com/status-im/doubleratchet/">Status implementation</a> of the Double Ratchet protocol,
which is in turn derived from the <a href="https://otr.cypherpunks.ca/Protocol-v3-4.1.1.html">Off-the-Record protocol</a>, using a different ratchet.
The transport protocol subsequently encrypt the message payload - Whisper/Waku (see section <a href="status/deprecated/secure-transport.html#transport-layer">Transport Layer</a>) -, using symmetric key encryption.
Furthermore, Status uses the concept of prekeys (through the use of <a href="https://signal.org/docs/specifications/x3dh/">X3DH</a>)
to allow the protocol to operate in an asynchronous environment.
It is not necessary for two parties to be online at the same time to initiate an encrypted conversation.</p>
<p>Status uses the following cryptographic primitives:</p>
<ul>
<li>
<p>Whisper/Waku</p>
<ul>
<li>AES-256-GCM</li>
<li>ECIES</li>
<li>ECDSA</li>
<li>KECCAK-256</li>
</ul>
</li>
<li>
<p>X3DH</p>
<ul>
<li>Elliptic curve Diffie-Hellman key exchange (secp256k1)</li>
<li>KECCAK-256</li>
<li>ECDSA</li>
<li>ECIES</li>
</ul>
</li>
<li>
<p>Double Ratchet</p>
<ul>
<li>HMAC-SHA-256 as MAC</li>
<li>Elliptic curve Diffie-Hellman key exchange (Curve25519)</li>
<li>AES-256-CTR with HMAC-SHA-256 and IV derived alongside an encryption key</li>
</ul>
<p>The node achieves key derivation using HKDF.</p>
</li>
</ul>
<h3 id="prekeys"><a class="header" href="#prekeys">Prekeys</a></h3>
<p>Every client initially generates some key material which is stored locally:</p>
<ul>
<li>Identity keypair based on secp256k1 - <code>IK</code></li>
<li>A signed prekey based on secp256k1 - <code>SPK</code></li>
<li>A prekey signature - <code>Sig(IK, Encode(SPK))</code></li>
</ul>
<p>More details can be found in the <code>X3DH Prekey bundle creation</code> section of <a href="status/deprecated//status/deprecated/account.html#x3dh-prekey-bundles">2/ACCOUNT</a>.</p>
<p>Prekey bundles can be extracted from any user's messages,
or found via searching for their specific topic, <code>{IK}-contact-code</code>.</p>
<p>TODO: See below on bundle retrieval, this seems like enhancement and parameter for recommendation</p>
<h3 id="bundle-retrieval"><a class="header" href="#bundle-retrieval">Bundle retrieval</a></h3>
<!-- TODO: Potentially move this completely over to [Trust Establishment](./status-account-spec.md) -->
<p>X3DH works by having client apps create and make available a bundle of prekeys (the X3DH bundle)
that can later be requested by other interlocutors when they wish to start a conversation with a given user.</p>
<p>In the X3DH specification, nodes typically use a shared server
to store bundles and allow other users to download them upon request.
Given Status' goal of decentralization,
Status chat clients cannot rely on the same type of infrastructure
and must achieve the same result using other means.
By growing order of convenience and security, the considered approaches are:</p>
<ul>
<li>contact codes;</li>
<li>public and one-to-one chats;</li>
<li>QR codes;</li>
<li>ENS record;</li>
<li>Decentralized permanent storage (e.g. Swarm, IPFS).</li>
<li>Whisper/Waku</li>
</ul>
<!-- TODO: Comment, it isn't clear what we actually _do_. It seems as if this is exploring the problem space. From a protocol point of view, it might make sense to describe the interface, and then have a recommendation section later on that specifies what we do. See e.g. Signal's specs where they specify specifics later on.  -->
<p>Currently, only public and one-to-one message exchanges and Whisper/Waku is used to exchange bundles.</p>
<p>Since bundles stored in QR codes or ENS records cannot be updated to delete already used keys,
the approach taken is to rotate more frequently the bundle (once every 24 hours),
which will be propagated by the app through the channel available.</p>
<h3 id="11-chat-contact-request"><a class="header" href="#11-chat-contact-request">1:1 chat contact request</a></h3>
<p>There are two phases in the initial negotiation of a 1:1 chat:</p>
<ol>
<li><strong>Identity verification</strong> (e.g., face-to-face contact exchange through QR code, Identicon matching).
A QR code serves two purposes simultaneously - identity verification and initial bundle retrieval;</li>
<li><strong>Asynchronous initial key exchange</strong>, using X3DH.</li>
</ol>
<p>For more information on account generation and trust establishment, see <a href="status/deprecated//status/deprecated/account.html">2/ACCOUNT</a></p>
<h4 id="initial-key-exchange-flow-x3dh"><a class="header" href="#initial-key-exchange-flow-x3dh">Initial key exchange flow (X3DH)</a></h4>
<p><a href="https://signal.org/docs/specifications/x3dh/#sending-the-initial-message">Section 3 of the X3DH protocol</a> describes the initial key exchange flow, with some additional context:</p>
<ul>
<li>The users' identity keys <code>IK_A</code> and <code>IK_B</code> correspond to their respective Status chat public keys;</li>
<li>Since it is not possible to guarantee that a prekey will be used only once in a decentralized world,
the one-time prekey <code>OPK_B</code> is not used in this scenario;</li>
<li>Nodes do not send Bundles to a centralized server, but instead served in a decentralized way as described in <a href="status/deprecated/secure-transport.html#bundle-retrieval">bundle retrieval</a>.</li>
</ul>
<p>Alice retrieves Bob's prekey bundle, however it is not specific to Alice. It contains:</p>
<p>(<a href="https://github.com/status-im/status-go/blob/a904d9325e76f18f54d59efc099b63293d3dcad3/services/shhext/chat/encryption.proto#L12">protobuf</a>)</p>
<pre><code class="language-protobuf">// X3DH prekey bundle
message Bundle {

  bytes identity = 1;

  map&lt;string,SignedPreKey&gt; signed_pre_keys = 2;

  bytes signature = 4;

  int64 timestamp = 5;
}

```golang
- `identity`: Identity key `IK_B`
- `signed_pre_keys`: Signed prekey `SPK_B` for each device, indexed by `installation-id`
- `signature`: Prekey signature &lt;i&gt;Sig(`IK_B`, Encode(`SPK_B`))&lt;/i&gt;
- `timestamp`: When the bundle was created locally

([protobuf](https://github.com/status-im/status-go/blob/a904d9325e76f18f54d59efc099b63293d3dcad3/services/shhext/chat/encryption.proto#L5))

``` protobuf
message SignedPreKey {
  bytes signed_pre_key = 1;
  uint32 version = 2;
}
</code></pre>
<p>The <code>signature</code> is generated by sorting <code>installation-id</code> in lexicographical order, and concatenating the <code>signed-pre-key</code> and <code>version</code>:</p>
<p><code>installation-id-1signed-pre-key1version1installation-id2signed-pre-key2-version-2</code></p>
<h4 id="double-ratchet"><a class="header" href="#double-ratchet">Double Ratchet</a></h4>
<p>Having established the initial shared secret <code>SK</code> through X3DH, it can be used to seed a Double Ratchet exchange between Alice and Bob.</p>
<p>Please refer to the <a href="https://signal.org/docs/specifications/doubleratchet/">Double Ratchet spec</a> for more details.</p>
<p>The initial message sent by Alice to Bob is sent as a top-level <code>ProtocolMessage</code> (<a href="https://github.com/status-im/status-go/blob/a904d9325e76f18f54d59efc099b63293d3dcad3/services/shhext/chat/encryption.proto#L65">protobuf</a>)
containing a map of <code>DirectMessageProtocol</code> indexed by <code>installation-id</code> (<a href="https://github.com/status-im/status-go/blob/1ac9dd974415c3f6dee95145b6644aeadf02f02c/services/shhext/chat/encryption.proto#L56">protobuf</a>):</p>
<pre><code class="language-protobuf">message ProtocolMessage {

  string installation_id = 2;

  repeated Bundle bundles = 3;

  // One to one message, encrypted, indexed by installation_id
  map&lt;string,DirectMessageProtocol&gt; direct_message = 101;

  // Public chats, not encrypted
  bytes public_message = 102;

}
</code></pre>
<ul>
<li><code>bundles</code>: a sequence of bundles</li>
<li><code>installation_id</code>: the installation id of the sender</li>
<li><code>direct_message</code> is a map of <code>DirectMessageProtocol</code> indexed by <code>installation-id</code></li>
<li><code>public_message</code>: unencrypted public chat message.</li>
</ul>
<pre><code class="language-protobuf">message DirectMessageProtocol {
  X3DHHeader X3DH_header = 1;
  DRHeader DR_header = 2;
  DHHeader DH_header = 101;
  // Encrypted payload
  bytes payload = 3;
}
</code></pre>
<pre><code class="language-protobuf">- `X3DH_header`: the `X3DHHeader` field in `DirectMessageProtocol` contains:

    ([protobuf](https://github.com/status-im/status-go/blob/a904d9325e76f18f54d59efc099b63293d3dcad3/services/shhext/chat/encryption.proto#L47))
    ``` protobuf
    message X3DHHeader {
      bytes key = 1;
      bytes id = 4;
    }
    ```

    - `key`: Alice's ephemeral key `EK_A`;
    - `id`: Identifier stating which of Bob's prekeys Alice used, in this case Bob's bundle signed prekey.

    Alice's identity key `IK_A` is sent at the transport layer level (Whisper/Waku);

- `DR_header`: Double ratchet header ([protobuf](https://github.com/status-im/status-go/blob/a904d9325e76f18f54d59efc099b63293d3dcad3/services/shhext/chat/encryption.proto#L31)). Used when Bob's public bundle is available:
    ``` protobuf
    message DRHeader {
      bytes key = 1;
      uint32 n = 2;
      uint32 pn = 3;
      bytes id = 4;
    }
    ```
    - `key`: Alice's current ratchet public key (as mentioned in [DR spec section 2.2](https://signal.org/docs/specifications/doubleratchet/#symmetric-key-ratchet));
    - `n`: number of the message in the sending chain;
    - `pn`: length of the previous sending chain;
    - `id`: Bob's bundle ID.

- `DH_header`: Diffie-Helman header (used when Bob's bundle is not available):
    ([protobuf](https://github.com/status-im/status-go/blob/a904d9325e76f18f54d59efc099b63293d3dcad3/services/shhext/chat/encryption.proto#L42))
    ``` protobuf
    message DHHeader {
      bytes key = 1;
    }
    ```
    - `key`: Alice's compressed ephemeral public key.

- `payload`:
    - if a bundle is available, contains payload encrypted with the Double Ratchet algorithm;
    - otherwise, payload encrypted with output key of DH exchange (no Perfect Forward Secrecy).
</code></pre>
<!-- TODO: A lot of links to status-go, seems likely these should be updated to status-protocol-go -->
<h2 id="security-considerations-27"><a class="header" href="#security-considerations-27">Security Considerations</a></h2>
<p>The same considerations apply as in <a href="https://signal.org/docs/specifications/x3dh/#security-considerations">section 4 of the X3DH spec</a> and <a href="https://signal.org/docs/specifications/doubleratchet/#security-considerations">section 6 of the Double Ratchet spec</a>, with some additions detailed below.</p>
<!-- TODO: Add any additional context here not covered in the X3DH and DR specs -->
<!--
TODO: description here

### --- Security  and Privacy Features
#### Confidentiality (YES)
> Only the intended recipients are able to read a message. Specifically, the message must not be readable by a server operator that is not a conversation participant

- Yes.
- There's a layer of encryption at Whisper as well as above with Double Ratchet
- Relay nodes and Mailservers can only read a topic of a Whisper message, and nothing within the payload.

#### Integrity (YES)
> No honest party will accept a message that has been modified in transit.

- Yes.
- Assuming a user validates (TODO: Check this assumption) every message they are able to decrypt and validate its signature from the sender, then it is not able to be altered in transit.
    * [igorm] i'm really not sure about it, Whisper provides a signature, but I'm not sure we check it anywhere (simple grepping didn't give anything)
    * [andrea] Whisper checks the signature and a public key is derived from it, we check the public key is a meaningful public key. The pk itself is not in the content of the message for public chats/1-to-1 so potentially you could send a message from a random account without having access to the private key, but that would not be much of a deal, as you might just as easily create a random account)

#### Authentication (YES)
>  Each participant in the conversation receives proof of possession of a known long-term secret from all other participants that they believe to be participating in the conversation. In addition, each participant is able to verify that a message was sent from the claimed source

- 1:1 --- one-to-one messages are encrypted with the recipient's public key, and digitally signed by the sender's.  In order to provide Perfect Forward Secrecy, we build on the X3DH and Double Ratchet specifications from Open Whisper Systems, with some adaptations to operate in a decentralized environment.
- group --- group chat is pairwise
- public --- A user subscribes to a public channel topic and the decryption key is derived from the topic name

**TODO:** Need to verify that this is actually the case
**TODO:** Fill in explicit details here

#### Participant Consistency (YES?)
> At any point when a message is accepted by an honest party, all honest parties are guaranteed to have the same view of the participant list

- **TODO:** Need details here

#### Destination Validation (YES?)
> When a message is accepted by an honest party, they can verify that they were included in the set of intended recipients for the message.

- Users are aware of the topic that a message was sent to, and that they have the ability to decrypt it.
- 

#### Forward Secrecy (PARTIAL)
> Compromising all key material does not enable decryption of previously encrypted data

- After first back and forth between two contacts with PFS enabled, yes.

#### Backward Secrecy (YES)
> Compromising all key material does not enable decryption of succeeding encrypted data

- PFS requires both backward and forwards secrecy
[Andrea: This is not true, (Perfect) Forward Secrecy does not imply backward secrecy (which is also called post-compromise security, as signal calls it, or future secrecy, it's not well defined). Technically this is a NO , double ratchet offers good Backward secrecy, but not perfect. Effectively if all the key material is compromised, any future message received will be also compromised (due to the hash ratchet), until a DH ratchet step is completed (i.e. the compromised party generate a new random key and ratchet)]

#### Anonymity Preserving (PARTIAL)
> Any anonymity features provided by the underlying transport privacy architecture are not undermined (e.g., if the transport privacy system provides anonymity, the conversation security level does not de-anonymize users by linking key identifiers).

- by default, yes
- ENS Naming system attaches an identifier to a given public key

#### Speaker Consistency (PARTIAL)
> All participants agree on the sequence of messages sent by each participant. A protocol might perform consistency checks on blocks of messages during the protocol, or after every message is sent.

- We use Lamport timestamps for ordering of events.
- In addition to this, we use local timestamps to attempt a more intuitive ordering. [Andrea: currently this was introduced as a regression during performance optimization and might result in out-of-order messages if sent across day boundaries, so I consider it a bug and not part of the specs (it does not make the order more intuitive, quite the opposite as it might result in causally related messages being out-of-order, but helps dividing the messages in days)]
- Fundamentally, there's no single source of truth, nor consensus process for global ordering [Andrea: Global ordering does not need a consensus process i.e. if you order messages alphabetically, and you break ties consistently, you have global ordering, as all the participants will see the same ordering (as opposed to say order by the time the message was received locally),  of course is not useful, you want to have causal + global to be meaningful]

TODO: Understand how this is different from Global Transcript
[Andrea: This is basically Global transcript for a single participants, we offer global transcript]

#### Causality Preserving (PARTIAL)
> Implementations can avoid displaying a message before messages that causally precede it

- Not yet, but in pipeline (data sync layer)

[Andrea: Messages are already causally ordered, we don't display messages that are causally related out-of-order, that's already granted by lamport timestamps]

TODO: Verify if this can be done already by looking at Lamport clock difference

#### Global Transcript (PARTIAL)
> All participants see all messages in the same order

- See directly above

[Andrea: messages are globally (total) ordered, so all participants see the same ordering]

#### Message Unlinkability (NO)
> If a judge is convinced that a participant authored one message in the conversation, this does not provide evidence that they authored other messages

- Currently, the Status software signs every messages sent with the user's public key, thus making it unable to provide unlinkability.  
- This is not necessary though, and could be built in to have an option to not sign. 
- Side note: moot account allows for this but is a function of the anonymity set that uses it.  The more people that use this account the stronger the unlinkability.

#### Message Repudiation (NO)
> Given a conversation transcript and all cryptographic keys, there is no evidence that a given message was authored by any particular user

- All messages are digitally signed by their sender.
- The underlying transport, Whisper/Waku, does allow for unsigned messages, but we don't use it.

#### Participant Repudiation (NO)
> Given a conversation transcript and all cryptographic key material for all but one accused (honest) participant, there is no evidence that the honest participant was in a conversation with any of the other participants.

### --- Group related features
#### Computational Equality (YES)
>  All chat participants share an equal computational load

- One a message is sent, all participants in a group chat perform the same steps to retrieve and decrypt it. 
- If proof of work is actually used at the Whisper layer (basically turned off in Status) then the sender would have to do additional computational work to send messages.

#### Trust Equality (PARTIAL)
> No participant is more trusted or takes on more responsibility than any other

- 1:1 chats and public chats are equal
- group chats have admins (on purpose)
- Private Group chats have Administrators and Members.  Upon construction, the creator is made an admin. These groups have the following privileges:
    - Admins:
        - Add group members
        - Promote group members to admin
        - Change group name
    - Members:
        - Accept invitation to group
        - Leave group
    - Non-Members:
        - Invited by admins show up as "invited" in group; this leaks contact information
        - Invited people don't opt-in to being invited

TODO: Group chat dynamics should have a documented state diagram
TODO: create issues for identity leak of invited members as well as current members of a group showing up who have not accepted yet [Andrea: that's an interesting point, didn't think of that. Currently we have this behavior for 2 reasons, backward compatibility with previous releases, which had no concept of joining, and also because we rely on other peers to propagate group info, so we don't have a single-message point of failure (the invitation), the first can be addressed easily, the second is trickier, without giving up the propagation mechanism (if we choose to give this up, then it's trivial)]

#### Subgroup Messaging (NO)
> Messages can be sent to a subset of participants without forming a new conversation

- This would require a new topic and either a new public chat or a new group chat
[Andrea: This is a YES, as messages are pairwise encrypted, and client-side fanout, so anyone could potentially send a message only to a subset of the group]

#### Contractible Membership (PARTIAL)
> After the conversation begins, participants can leave without restarting the protocol

- For 1:1, there is no way to ignore or block a user from sending you a message.  This is currently in the pipeline.
- For public chats, Yes. A member simply stops subscribing to a specific topic and will no longer receive messages. 
- For group chats: this assumes pairwise encryption OR key is renegotiated
- This only currently works on the identity level, and not the device level.  A ghost device will have access to anything other devices have.
[Andrea: For group chats, that's possible as using pairwise encryption, also with group chats (which use device-to-device encryption), ghost devices is a bit more complicated, in general, they don't have access to the messages you send, i.e. If I send a message from device A1 to the group chat and there is a ghost device A2, it will not be able to decrypt the content, but will see that a message has been sent (as only paired devices are kept in sync, and those are explicitly approved by the user). Messages that you receive are different, so a ghost device (A2) will potentially be able to decrypt the message, but A1 can detect the ghost device (in most cases, it's complicated :), the pfs docs describe multi-device support), for one-to-one ghost devices are undetectable]

#### Expandable Membership (PARTIAL)
> After the conversation begins, participants can join without restarting the protocol.

- 1:1: no, only 1:1
- private group: yes, since it is pair-wise, each person in the group just creates a pair with the new member
- public: yes, as members of a public chat are only subscribing to a topic and receiving anyone sending messages to it. 

### --- Usability and Adoption

#### Out-of-Order Resilient (PARTIAL)
> If a message is delayed in transit, but eventually arrives, its contents are accessible upon arrival

- Due to asynchronous forward secrecy and no additional services, private keys might be rotated

[Andrea: That's correct, in some cases if the message is delayed for too long, or really out-of-order, the specific message key might have been deleted, as we only keep the last 3000 message keys]
[Igor: TTL of a Whisper message can expire, so any node-in-transit will drop it. Also, I believe we ignore messages with skewed timestamps]

#### Dropped Message Resilient (PARTIAL)
> Messages can be decrypted without receipt of all previous messages. This is desirable for asynchronous and unreliable network services

- Public chats: yes, users are able to decrypt any message received at any time.
- 1-to-1/group chat also, this is a YES in my opinion

#### Asynchronous (PARTIAL)
> Messages can be sent securely to disconnected recipients and received upon their next connection

- The semantics around message reliability are currently poor
    * [Igor: messages are stored on mailservers for way longer than TTL (30 days), but that requires Status infrastructure]
- There's a TTL in Whisper and mailserver can deliver messages after the fact

TODO: this requires more detail

#### Multi-Device Support (YES)
> A user can participate in the conversation using multiple devices at once. Each device must be able to send and receive messages. Ideally, all devices have identical views of the conversation. The devices might use a synchronized long-term key or distinct keys.

- Yes
- There is currently work being done to improve the syncing process between a user's devices. 

#### No Additional Service (NO)
> The protocol does not require any infrastructure other than the protocol participants. Specifically, the protocol must not require additional servers for relaying messages or storing any kind of key material.

- The protocol requires Whisper/Waku relay servers and mailservers currently. 
- The larger the number of Whisper/Waku relay servers, the better the transport security but there might be potential scaling problems.
- Mailservers act to provide asynchronicity so users can retrieve messages after coming back from an offline period. 

-->
<h2 id="session-management-1"><a class="header" href="#session-management-1">Session management</a></h2>
<p>A node identifies a peer by two pieces of data:</p>
<ol>
<li>An <code>installation-id</code> which is generated upon creating a new account in the <code>Status</code> application</li>
<li>Their identity Whisper/Waku key</li>
</ol>
<h3 id="initialization-1"><a class="header" href="#initialization-1">Initialization</a></h3>
<p>A node initializes a new session once a successful X3DH exchange has taken place. Subsequent messages will use the established session until re-keying is necessary.</p>
<h3 id="concurrent-sessions-1"><a class="header" href="#concurrent-sessions-1">Concurrent sessions</a></h3>
<p>If a node creates two sessions concurrently between two peers, the one with the symmetric key first in byte order SHOULD be used, this marks that the other has expired.</p>
<h3 id="re-keying-1"><a class="header" href="#re-keying-1">Re-keying</a></h3>
<p>On receiving a bundle from a given peer with a higher version, the old bundle SHOULD be marked as expired and a new session SHOULD be established on the next message sent.</p>
<h3 id="multi-device-support-1"><a class="header" href="#multi-device-support-1">Multi-device support</a></h3>
<p>Multi-device support is quite challenging as there is not a central place
where information on which and how many devices (identified by their respective <code>installation-id</code>) belongs to a whisper-identity / waku-identity.</p>
<p>Furthermore, account recovery always needs to be taken into consideration,
where a user wipes clean the whole device and the nodes loses all the information about any previous sessions.</p>
<p>Taking these considerations into account, the way the network propagates multi-device information using x3dh bundles,
which will contain information about paired devices as well as information about the sending device.</p>
<p>This means that every time a new device is paired, the bundle needs to be updated and propagated with the new information,
the user has the responsibility to make sure the pairing is successful.</p>
<p>The method is loosely based on <a href="https://signal.org/docs/specifications/sesame/">Sesame</a>.</p>
<h3 id="pairing-1"><a class="header" href="#pairing-1">Pairing</a></h3>
<p>When a user adds a new account in the <code>Status</code> application, a new <code>installation-id</code> will be generated.
The device should be paired as soon as possible if other devices are present.
Once paired the contacts will be notified of the new device and it will be included in further communications.</p>
<p>If a bundle received from the <code>IK</code> is different to the <code>installation-id</code>,
the device will be shown to the user and will have to be manually approved, to a maximum of 3.
Once that is done any message sent by one device will also be sent to any other enabled device.</p>
<p>Once a user enables a new device, a new bundle will be generated which will include pairing information.</p>
<p>The bundle will be propagated to contacts through the usual channels.</p>
<p>Removal of paired devices is a manual step that needs to be applied on each device,
and consist simply in disabling the device, at which point pairing information will not be propagated anymore.</p>
<h3 id="sending-messages-to-a-paired-group-1"><a class="header" href="#sending-messages-to-a-paired-group-1">Sending messages to a paired group</a></h3>
<p>When sending a message, the peer will send a message to other <code>installation-id</code> that they have seen.
The node caps the number of devices to 3, ordered by last activity.
The node sends messages using pairwise encryption, including their own devices.</p>
<p>Account recovery</p>
<p>Account recovery is no different from adding a new device, and it is handled in exactly the same way.</p>
<h3 id="partitioned-devices-1"><a class="header" href="#partitioned-devices-1">Partitioned devices</a></h3>
<p>In some cases (i.e. account recovery when no other pairing device is available, device not paired),
it is possible that a device will receive a message that is not targeted to its own <code>installation-id</code>.
In this case an empty message containing bundle information is sent back,
which will notify the receiving end of including this device in any further communication.</p>
<h2 id="changelog-11"><a class="header" href="#changelog-11">Changelog</a></h2>
<h3 id="version-03-6"><a class="header" href="#version-03-6">Version 0.3</a></h3>
<p>Released <a href="https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8">May 22, 2020</a></p>
<ul>
<li>Added language to include Waku in all relevant places</li>
</ul>
<h2 id="copyright-82"><a class="header" href="#copyright-82">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-69"><a class="header" href="#references-69">References</a></h2>
<ul>
<li><a href="https://signal.org/docs/specifications/x3dh/">X3DH</a></li>
<li><a href="https://signal.org/docs/specifications/doubleratchet/">Double Ratchet</a></li>
<li><a href="https://developers.google.com/protocol-buffers/">Protobuf</a></li>
<li><a href="status/deprecated//status/deprecated/whisper-usage.html">Whisper</a></li>
<li><a href="status/deprecated//status/deprecated/waku-usage.html">Waku</a></li>
<li><a href="status/deprecated//status/deprecated/account.html">Account specification</a></li>
<li><a href="https://github.com/status-im/doubleratchet/">Status implementation</a></li>
<li><a href="https://otr.cypherpunks.ca/Protocol-v3-4.1.1.html">Off-the-Record protocol</a></li>
<li><a href="https://signal.org/docs/specifications/x3dh/">X3DH</a></li>
<li><a href="status/deprecated//status/deprecated/account.html">ACCOUNT</a></li>
<li><a href="https://signal.org/docs/specifications/sesame/">Sesame</a></li>
<li><a href="https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8">May 22, 2020 commit change</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="waku-mailserver"><a class="header" href="#waku-mailserver">WAKU-MAILSERVER</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku Mailserver</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Adam Babik &lt;adam@status.im&gt;<br>Oskar Thorén &lt;oskar@status.im&gt;<br>Samuel Hawksby-Robinson &lt;samuel@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-87"><a class="header" href="#timeline-87">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/deprecated/waku-mailserver.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/deprecated/waku-mailserver.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/614348a4982aa9e519ccff8b8fbcd4c554683288/status/deprecated/waku-mailserver.md"><code>614348a</code></a> — Status deprecated update2 (#134)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-60"><a class="header" href="#abstract-60">Abstract</a></h2>
<p>Being mostly offline is an intrinsic property of mobile clients.
They need to save network transfer and battery consumption to avoid spending too much money or constant charging.
Waku protocol, on the other hand, is an online protocol.
Messages are available in the Waku network only for short period of time calculate in seconds.</p>
<p>Waku Mailserver is a specification that allows messages to be stored permanently
and allows the stored messages to be delivered to requesting client nodes,
regardless if the messages are not available in the network due to the message TTL expiring.</p>
<h2 id="mailserver"><a class="header" href="#mailserver"><code>Mailserver</code></a></h2>
<p>From the network perspective, a <code>Mailserver</code> is just like any other Waku node.
The only difference is that a <code>Mailserver</code> has the capability of archiving messages
and delivering them to its peers on-demand.</p>
<p>It is important to notice that a <code>Mailserver</code> will only handle requests from its direct peers
and exchanged packets between a <code>Mailserver</code> and a peer are p2p messages.</p>
<h3 id="archiving-messages"><a class="header" href="#archiving-messages">Archiving messages</a></h3>
<p>A node which wants to provide <code>Mailserver</code> functionality MUST store envelopes from
incoming message packets (Waku packet-code <code>0x01</code>). The envelopes can be stored in any
format, however they MUST be serialized and deserialized to the Waku envelope format.</p>
<p>A <code>Mailserver</code> SHOULD store envelopes for all topics to be generally useful for any peer,
however for specific use cases it MAY store envelopes for a subset of topics.</p>
<h3 id="requesting-messages"><a class="header" href="#requesting-messages">Requesting messages</a></h3>
<p>In order to request historic messages, a node MUST send a packet P2P Request (<code>0x7e</code>) to a peer providing <code>Mailserver</code> functionality.
This packet requires one argument which MUST be a Waku envelope.</p>
<p>In the Waku envelope's payload section, there MUST be RLP-encoded information about the details of the request:</p>
<pre><code class="language-golang">[ Lower, Upper, Bloom, Limit, Cursor ]
</code></pre>
<p><code>Lower</code>: 4-byte wide unsigned integer (UNIX time in seconds; oldest requested envelope's creation time)<br />
<code>Upper</code>: 4-byte wide unsigned integer (UNIX time in seconds; newest requested envelope's creation time)<br />
<code>Bloom</code>: 64-byte wide array of Waku topics encoded in a bloom filter to filter envelopes<br />
<code>Limit</code>: 4-byte wide unsigned integer limiting the number of returned envelopes<br />
<code>Cursor</code>: an array of a cursor returned from the previous request (optional)</p>
<p>The <code>Cursor</code> field SHOULD be filled in if a number of envelopes between <code>Lower</code> and <code>Upper</code> is greater than <code>Limit</code>
so that the requester can send another request using the obtained <code>Cursor</code> value.
What exactly is in the <code>Cursor</code> is up to the implementation.
The requester SHOULD NOT use a <code>Cursor</code> obtained from one <code>Mailserver</code> in a request to another <code>Mailserver</code> because the format or the result MAY be different.</p>
<p>The envelope MUST be encrypted with a symmetric key agreed between the requester and the <code>Mailserver</code>.</p>
<h3 id="receiving-historic-messages"><a class="header" href="#receiving-historic-messages">Receiving historic messages</a></h3>
<p>Historic messages MUST be sent to a peer as a packet with a P2P Message code (<code>0x7f</code>) followed by an array of Waku envelopes.</p>
<p>In order to receive historic messages from a <code>Mailserver</code>, a node MUST trust the selected <code>Mailserver</code>,
that is allowed to send packets with the P2P Message code. By default, the node discards such packets.</p>
<p>Received envelopes MUST be passed through the Waku envelope pipelines
so that they are picked up by registered filters and passed to subscribers.</p>
<p>For a requester, to know that all messages have been sent by a <code>Mailserver</code>,
it SHOULD handle P2P Request Complete code (<code>0x7d</code>). This code is followed by the following parameters:</p>
<pre><code class="language-golang">[ RequestID, LastEnvelopeHash, Cursor ]
</code></pre>
<ul>
<li><code>RequestID</code>: 32-byte wide array with a Keccak-256 hash of the envelope containing the original request</li>
<li><code>LastEnvelopeHash</code>: 32-byte wide array with a Keccak-256 hash of the last sent envelope for the request</li>
<li><code>Cursor</code>: an array of a cursor returned from the previous request (optional)</li>
</ul>
<p>If <code>Cursor</code> is not empty, it means that not all messages were sent due to the set <code>Limit</code> in the request.
One or more consecutive requests MAY be sent with <code>Cursor</code> field filled in order to receive the rest of the messages.</p>
<h2 id="security-considerations-28"><a class="header" href="#security-considerations-28">Security considerations</a></h2>
<h3 id="confidentiality"><a class="header" href="#confidentiality">Confidentiality</a></h3>
<p>The node encrypts all Waku envelopes. A <code>Mailserver</code> node can not inspect their contents.</p>
<h3 id="altruistic-and-centralized-operator-risk"><a class="header" href="#altruistic-and-centralized-operator-risk">Altruistic and centralized operator risk</a></h3>
<p>In order to be useful, a <code>Mailserver</code> SHOULD be online most of time.
That means users either have to be a bit tech-savvy to run their own node,
or rely on someone else to run it for them.</p>
<p>Currently, one of Status's legal entities provides <code>Mailservers</code> in an altruistic manner,
but this is suboptimal from a decentralization, continuance and risk point of view.
Coming up with a better system for this is ongoing research.</p>
<p>A Status client SHOULD allow the <code>Mailserver</code> selection to be customizable.</p>
<h3 id="privacy-concerns"><a class="header" href="#privacy-concerns">Privacy concerns</a></h3>
<p>In order to use a <code>Mailserver</code>, a given node needs to connect to it directly,
i.e. add the <code>Mailserver</code> as its peer and mark it as trusted.
This means that the <code>Mailserver</code> is able to send direct p2p messages to the node instead of broadcasting them.
Effectively, it will have access to the bloom filter of topics that the user is interested in,
when it is online as well as many metadata like IP address.</p>
<h3 id="denial-of-service"><a class="header" href="#denial-of-service">Denial-of-service</a></h3>
<p>Since a <code>Mailserver</code> is delivering expired envelopes and has a direct TCP connection with the recipient,
the recipient is vulnerable to DoS attacks from a malicious <code>Mailserver</code> node.</p>
<h2 id="changelog-12"><a class="header" href="#changelog-12">Changelog</a></h2>
<h3 id="version-01-3"><a class="header" href="#version-01-3">Version 0.1</a></h3>
<p>Released <a href="https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8">May 22, 2020</a></p>
<ul>
<li>Created document</li>
<li>Forked from <a href="status/deprecated//status/deprecated/whisper-mailserver.html">whisper-mailserver</a></li>
<li>Change to keep <code>Mailserver</code> term consistent</li>
<li>Replaced Whisper references with Waku</li>
</ul>
<h2 id="copyright-83"><a class="header" href="#copyright-83">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-70"><a class="header" href="#references-70">References</a></h2>
<ul>
<li><a href="https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8">May 22, 2020 change commit</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="waku-usage"><a class="header" href="#waku-usage">WAKU-USAGE</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Waku Usage</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Adam Babik &lt;adam@status.im&gt;<br>Corey Petty &lt;corey@status.im&gt;<br>Oskar Thorén &lt;oskar@status.im&gt;<br>Samuel Hawksby-Robinson &lt;samuel@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-88"><a class="header" href="#timeline-88">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/deprecated/waku-usage.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/deprecated/waku-usage.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/614348a4982aa9e519ccff8b8fbcd4c554683288/status/deprecated/waku-usage.md"><code>614348a</code></a> — Status deprecated update2 (#134)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-61"><a class="header" href="#abstract-61">Abstract</a></h2>
<p>Status uses <a href="status/deprecated//waku/standards/legacy/6/waku1.html">Waku</a> to provide privacy-preserving routing
and messaging on top of devP2P.
Waku uses topics to partition its messages,
and these are leveraged for all chat capabilities.
In the case of public chats, the channel name maps directly to its Waku topic.
This allows anyone to listen on a single channel.</p>
<p>Additionally, since anyone can receive Waku envelopes,
it relies on the ability to decrypt messages to decide who is the correct recipient.
Status nodes do not rely upon this property,
and implement another secure transport layer on top of Whisper.</p>
<h2 id="reason-1"><a class="header" href="#reason-1">Reason</a></h2>
<p>Provide routing, metadata protection, topic-based multicasting and basic
encryption properties to support asynchronous chat.</p>
<h2 id="terminology-10"><a class="header" href="#terminology-10">Terminology</a></h2>
<ul>
<li><em>Waku node</em>: an Ethereum node with Waku V1 enabled</li>
<li><em>Waku network</em>: a group of Waku nodes connected together through the internet connection and forming a graph</li>
<li><em>Message</em>: a decrypted Waku message</li>
<li><em>Offline message</em>: an archived envelope</li>
<li><em>Envelope</em>: an encrypted message with metadata like topic and Time-To-Live</li>
</ul>
<h2 id="waku-packets"><a class="header" href="#waku-packets">Waku packets</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Packet Name</th><th style="text-align: right">Code</th><th>References</th></tr></thead><tbody>
<tr><td>Status</td><td style="text-align: right">0</td><td><a href="status/deprecated/status">Status</a>, <a href="status/deprecated//waku/standards/legacy/6/waku1.html#status">WAKU-1</a></td></tr>
<tr><td>Messages</td><td style="text-align: right">1</td><td><a href="status/deprecated//waku/standards/legacy/6/waku1.html#messages">WAKU-1</a></td></tr>
<tr><td>Batch Ack</td><td style="text-align: right">11</td><td>Undocumented. Marked for Deprecation</td></tr>
<tr><td>Message Response</td><td style="text-align: right">12</td><td><a href="status/deprecated//waku/standards/legacy/6/waku1.html#batch-ack-and-message-response">WAKU-1</a></td></tr>
<tr><td>Status Update</td><td style="text-align: right">22</td><td><a href="status/deprecated//waku/standards/legacy/6/waku1.html#status-update">WAKU-1</a></td></tr>
<tr><td>P2P Request Complete</td><td style="text-align: right">125</td><td><a href="status/deprecated//status/deprecated/waku-mailserver.html">4/WAKU-MAILSERVER</a></td></tr>
<tr><td>P2P Request</td><td style="text-align: right">126</td><td><a href="status/deprecated//status/deprecated/waku-mailserver.html">4/WAKU-MAILSERVER</a>, <a href="status/deprecated//waku/standards/legacy/6/waku1.html#p2p-request">WAKU-1</a></td></tr>
<tr><td>P2P Messages</td><td style="text-align: right">127</td><td><a href="status/deprecated//status/deprecated/waku-mailserver.html">4/WAKU-MAILSERVER</a>, <a href="status/deprecated//waku/standards/legacy/6/waku1.html#p2p-request-complete">WAKU-1</a></td></tr>
</tbody></table>
</div>
<h2 id="waku-node-configuration"><a class="header" href="#waku-node-configuration">Waku node configuration</a></h2>
<p>A Waku node must be properly configured to receive messages from Status clients.</p>
<p>Nodes use Waku's Proof Of Work algorithm to deter denial of service and various spam/flood attacks against the Whisper network.
The sender of a message must perform some work which in this case means processing time.
Because Status' main client is a mobile client, this easily leads to battery draining and poor performance of the app itself.
Hence, all clients MUST use the following Whisper node settings:</p>
<ul>
<li>proof-of-work requirement not larger than <code>0.002</code> for payloads less than 50,000 bytes</li>
<li>proof-of-work requirement not larger than <code>0.000002</code> for payloads greater than or equal to 50,000 bytes</li>
<li>time-to-live not lower than <code>10</code> (in seconds)</li>
</ul>
<h2 id="status-3"><a class="header" href="#status-3">Status</a></h2>
<p>Handshake is a RLP-encoded packet sent to a newly connected peer. It MUST start with a Status Code (<code>0x00</code>) and follow up with items:</p>
<pre><code class="language-golang">[
  [ pow-requirement-key pow-requirement ]
  [ bloom-filter-key bloom-filter ]
  [ light-node-key light-node ]
  [ confirmations-enabled-key confirmations-enabled ]
  [ rate-limits-key rate-limits ]
  [ topic-interest-key topic-interest ]
]
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>Option Name</th><th>Key</th><th>Type</th><th>Description</th><th>References</th></tr></thead><tbody>
<tr><td><code>pow-requirement</code></td><td><code>0x00</code></td><td><code>uint64</code></td><td>minimum PoW accepted by the peer</td><td><a href="status/deprecated//waku/standards/legacy/6/waku1.html#pow-requirement-field">WAKU-1#pow-requirement</a></td></tr>
<tr><td><code>bloom-filter</code></td><td><code>0x01</code></td><td><code>[]byte</code></td><td>bloom filter of Waku topic accepted by the peer</td><td><a href="status/deprecated//waku/standards/legacy/6/waku1.html#bloom-filter-field">WAKU-1#bloom-filter</a></td></tr>
<tr><td><code>light-node</code></td><td><code>0x02</code></td><td><code>bool</code></td><td>when true, the peer won't forward envelopes through the Messages packet.</td><td><a href="status/deprecated//waku/standards/legacy/6/waku1.html#light-node">WAKU-1#light-node</a></td></tr>
<tr><td><code>confirmations-enabled</code></td><td><code>0x03</code></td><td><code>bool</code></td><td>when true, the peer will send message confirmations</td><td><a href="status/deprecated//waku/standards/legacy/6/waku1.html#confirmations-enabled-field">WAKU-1#confirmations-enabled-field</a></td></tr>
<tr><td><code>rate-limits</code></td><td><code>0x04</code></td><td></td><td>See <a href="status/deprecated//waku/standards/legacy/6/waku1.html#rate-limits-field">Rate limiting</a></td><td><a href="status/deprecated//waku/standards/legacy/6/waku1.html#rate-limits-field">WAKU-1#rate-limits</a></td></tr>
<tr><td><code>topic-interest</code></td><td><code>0x05</code></td><td><code>[10000][4]byte</code></td><td>Topic interest is used to share a node's interest in envelopes with specific topics. It does this in a more bandwidth considerate way, at the expense of some metadata protection. Peers MUST only send envelopes with specified topics.</td><td><a href="status/deprecated//waku/standards/legacy/6/waku1.html#topic-interest-field">WAKU-1#topic-interest</a>, <a href="https://github.com/vacp2p/research/tree/dcc71f4779be832d3b5ece9c4e11f1f7ec24aac2/whisper_scalability">the theoretical scaling model</a></td></tr>
</tbody></table>
</div><!-- TODO Add `light-node` and `confirmations-enabled` links when https://github.com/vacp2p/specs/pull/128 is merged -->
<h2 id="rate-limiting"><a class="header" href="#rate-limiting">Rate limiting</a></h2>
<p>In order to provide an optional very basic Denial-of-Service attack protection, each node SHOULD define its own rate limits.
The rate limits SHOULD be applied on IPs, peer IDs, and envelope topics.</p>
<p>Each node MAY decide to whitelist, i.e. do not rate limit, selected IPs or peer IDs.</p>
<p>If a peer exceeds node's rate limits, the connection between them MAY be dropped.</p>
<p>Each node SHOULD broadcast its rate limits to its peers using <code>rate limits</code> in <code>status-options</code> via packet code <code>0x00</code> or <code>0x22</code>. The rate limits is RLP-encoded information:</p>
<pre><code class="language-golang">[ IP limits, PeerID limits, Topic limits ]
</code></pre>
<p><code>IP limits</code>: 4-byte wide unsigned integer
<code>PeerID limits</code>: 4-byte wide unsigned integer
<code>Topic limits</code>: 4-byte wide unsigned integer</p>
<p>The rate limits MAY also be sent as an optional parameter in the handshake.</p>
<p>Each node SHOULD respect rate limits advertised by its peers. The number of packets SHOULD be throttled in order not to exceed peer's rate limits.
If the limit gets exceeded, the connection MAY be dropped by the peer.</p>
<h2 id="keys-management"><a class="header" href="#keys-management">Keys management</a></h2>
<p>The protocol requires a key (symmetric or asymmetric) for the following actions:</p>
<ul>
<li>signing &amp; verifying messages (asymmetric key)</li>
<li>encrypting &amp; decrypting messages (asymmetric or symmetric key).</li>
</ul>
<p>As nodes require asymmetric keys and symmetric keys to process incoming messages,
they must be available all the time and are stored in memory.</p>
<p>Keys management for PFS is described in <a href="status/deprecated//status/deprecated/secure-transport.html">5/SECURE-TRANSPORT</a>.</p>
<p>The Status protocols uses a few particular Waku topics to achieve its goals.</p>
<h3 id="contact-code-topic"><a class="header" href="#contact-code-topic">Contact code topic</a></h3>
<p>Nodes use the contact code topic to facilitate the discovery of X3DH bundles so that the first message can be PFS-encrypted.</p>
<p>Each user publishes periodically to this topic. If user A wants to contact user B, she SHOULD look for their bundle on this contact code topic.</p>
<p>Contact code topic MUST be created following the algorithm below:</p>
<pre><code class="language-golang">contactCode := "0x" + hexEncode(activePublicKey) + "-contact-code"

var hash []byte = keccak256(contactCode)
var topicLen int = 4

if len(hash) &lt; topicLen {
    topicLen = len(hash)
}

var topic [4]byte
for i = 0; i &lt; topicLen; i++ {
    topic[i] = hash[i]
}
</code></pre>
<h3 id="partitioned-topic"><a class="header" href="#partitioned-topic">Partitioned topic</a></h3>
<p>Waku is broadcast-based protocol. In theory, everyone could communicate using a single topic but that would be extremely inefficient.
Opposite would be using a unique topic for each conversation, however,
this brings privacy concerns because it would be much easier to detect whether and when two parties have an active conversation.</p>
<p>Nodes use partitioned topics to broadcast private messages efficiently.
By selecting a number of topic, it is possible to balance efficiency and privacy.</p>
<p>Currently, nodes set the number of partitioned topics to <code>5000</code>. They MUST be generated following the algorithm below:</p>
<pre><code class="language-golang">var partitionsNum *big.Int = big.NewInt(5000)
var partition *big.Int = big.NewInt(0).Mod(publicKey.X, partitionsNum)

partitionTopic := "contact-discovery-" + strconv.FormatInt(partition.Int64(), 10)

var hash []byte = keccak256(partitionTopic)
var topicLen int = 4

if len(hash) &lt; topicLen {
    topicLen = len(hash)
}

var topic [4]byte
for i = 0; i &lt; topicLen; i++ {
    topic[i] = hash[i]
}
</code></pre>
<h3 id="public-chats"><a class="header" href="#public-chats">Public chats</a></h3>
<p>A public chat MUST use a topic derived from a public chat name following the algorithm below:</p>
<pre><code class="language-golang">var hash []byte
hash = keccak256(name)

topicLen = 4
if len(hash) &lt; topicLen {
    topicLen = len(hash)
}

var topic [4]byte
for i = 0; i &lt; topicLen; i++ {
    topic[i] = hash[i]
}
</code></pre>
<!-- NOTE: commented out as it is currently not used.  In code for potential future use. - C.P. Oct 8, 2019
### Personal discovery topic

 Personal discovery topic is used to ???

A client MUST implement it following the algorithm below:
```golang
personalDiscoveryTopic := "contact-discovery-" + hexEncode(publicKey)

var hash []byte = keccak256(personalDiscoveryTopic)
var topicLen int = 4

if len(hash) < topicLen {
    topicLen = len(hash)
}

var topic [4]byte
for i = 0; i < topicLen; i++ {
    topic[i] = hash[i]
}
```

Each Status Client SHOULD listen to this topic in order to receive ??? -->
<h3 id="group-chat-topic"><a class="header" href="#group-chat-topic">Group chat topic</a></h3>
<p>Group chats does not have a dedicated topic.
All group chat messages (including membership updates) are sent as one-to-one messages to multiple recipients.</p>
<h3 id="negotiated-topic"><a class="header" href="#negotiated-topic">Negotiated topic</a></h3>
<p>When a client sends a one to one message to another client, it MUST listen to their negotiated topic.
This is computed by generating a diffie-hellman key exchange between two members
and taking the first four bytes of the <code>SHA3-256</code> of the key generated.</p>
<pre><code class="language-golang">
sharedKey, err := ecies.ImportECDSA(myPrivateKey).GenerateShared(
      ecies.ImportECDSAPublic(theirPublicKey),
      16,
      16,
)


hexEncodedKey := hex.EncodeToString(sharedKey)

var hash []byte = keccak256(hexEncodedKey)
var topicLen int = 4

if len(hash) &lt; topicLen {
    topicLen = len(hash)
}

var topic [4]byte
for i = 0; i &lt; topicLen; i++ {
    topic[i] = hash[i]
}
</code></pre>
<p>A client SHOULD send to the negotiated topic only if it has received a message from all the devices included in the conversation.</p>
<h3 id="flow-11"><a class="header" href="#flow-11">Flow</a></h3>
<p>To exchange messages with client <code>B</code>, a client <code>A</code> SHOULD:</p>
<ul>
<li>Listen to client's <code>B</code> Contact Code Topic to retrieve their bundle information, including a list of active devices</li>
<li>Send a message on client's <code>B</code> partitioned topic</li>
<li>Listen to the Negotiated Topic between <code>A</code> &amp; <code>B</code></li>
<li>Once client <code>A</code> receives a message from <code>B</code>, the Negotiated Topic SHOULD be used</li>
</ul>
<h2 id="message-encryption"><a class="header" href="#message-encryption">Message encryption</a></h2>
<p>Even though, the protocol specifies an encryption layer that encrypts messages before passing them to the transport layer,
Waku protocol requires each Waku message to be encrypted anyway.</p>
<p>The node encrypts public and group messages using symmetric encryption, and creates the key from a channel name string.
The implementation is available in <a href="https://github.com/ethereum/go-ethereum/wiki/Whisper-v6-RPC-API#shh_generatesymkeyfrompassword"><code>shh_generateSymKeyFromPassword</code></a> JSON-RPC method of go-ethereum Whisper implementation.</p>
<p>The node encrypts one-to-one messages using asymmetric encryption.</p>
<h2 id="message-confirmations"><a class="header" href="#message-confirmations">Message confirmations</a></h2>
<p>Sending a message is a complex process where many things can go wrong.
Message confirmations tell a node that a message originating from it has been seen by its direct peers.</p>
<p>A node MAY send a message confirmation for any batch of messages received in a packet Messages Code (<code>0x01</code>).</p>
<p>A node sends a message confirmation using Batch Acknowledge packet (<code>0x0b</code>) or Message Response packet (<code>0x0c</code>).</p>
<p>The Batch Acknowledge packet is followed by a keccak256 hash of the envelopes batch data (raw bytes).</p>
<p>The Message Response packet is more complex and is followed by a Versioned Message Response:</p>
<pre><code class="language-golang">[ Version, Response]
</code></pre>
<p><code>Version</code>: a version of the Message Response, equal to <code>1</code>,
<code>Response</code>: <code>[ Hash, Errors ]</code> where <code>Hash</code> is a keccak256 hash of the envelopes batch data (raw bytes)
for which the confirmation is sent and <code>Errors</code> is a list of envelope errors when processing the batch.
A single error contains <code>[ Hash, Code, Description ]</code> where <code>Hash</code> is a hash of the processed envelope,
<code>Code</code> is an error code and <code>Description</code> is a descriptive error message.</p>
<p>The supported codes:
<code>1</code>: means time sync error which happens when an envelope is too old
or created in the future (the root cause is no time sync between nodes).</p>
<p>The drawback of sending message confirmations is that it increases the noise in the network because for each sent message,
one or more peers broadcast a corresponding confirmation. To limit that, both Batch Acknowledge packet (<code>0x0b</code>)
and Message Response packet (<code>0x0c</code>) are not broadcast to peers of the peers, i.e. they do not follow epidemic spread.</p>
<p>In the current Status network setup, only <code>Mailservers</code> support message confirmations.
A client posting a message to the network and after receiving a confirmation can be sure that the message got processed by the <code>Mailserver</code>.
If additionally, sending a message is limited to non-<code>Mailserver</code> peers,
it also guarantees that the message got broadcast through the network and it reached the selected <code>Mailserver</code>.</p>
<h2 id="waku-v1-extensions"><a class="header" href="#waku-v1-extensions">Waku V1 extensions</a></h2>
<h3 id="request-historic-messages"><a class="header" href="#request-historic-messages">Request historic messages</a></h3>
<p>Sends a request for historic messages to a <code>Mailserver</code>.
The <code>Mailserver</code> node MUST be a direct peer and MUST be marked as trusted (using <code>waku_markTrustedPeer</code>).</p>
<p>The request does not wait for the response.
It merely sends a peer-to-peer message to the <code>Mailserver</code> and it's up to <code>Mailserver</code> to process it and start sending historic messages.</p>
<p>The drawback of this approach is that it is impossible to tell which historic messages are the result of which request.</p>
<p>It's recommended to return messages from newest to oldest.
To move further back in time, use <code>cursor</code> and <code>limit</code>.</p>
<h4 id="wakuext_requestmessages"><a class="header" href="#wakuext_requestmessages">wakuext_requestMessages</a></h4>
<p><strong>Parameters</strong>:</p>
<ul>
<li>Object - The message request object:
<ul>
<li><code>mailServerPeer</code> - <code>String</code>: <code>Mailserver</code>'s enode address.</li>
<li><code>from</code> - <code>Number</code> (optional): Lower bound of time range as unix timestamp, default is 24 hours back from now.</li>
<li><code>to</code> - <code>Number</code> (optional): Upper bound of time range as unix timestamp, default is now.</li>
<li><code>limit</code> - <code>Number</code> (optional): Limit the number of messages sent back, default is no limit.</li>
<li><code>cursor</code> - <code>String</code> (optional): Used for paginated requests.</li>
<li><code>topics</code> - <code>Array</code>: hex-encoded message topics.</li>
<li><code>symKeyID</code> - <code>String</code>: an ID of a symmetric key used to authenticate with the <code>Mailserver</code>, derived from the <code>Mailserver</code> password.</li>
</ul>
</li>
</ul>
<p><strong>Returns</strong>:
<code>Boolean</code> - returns <code>true</code> if the request was sent.</p>
<p>The above <code>topics</code> is then converted into a bloom filter and then and sent to the <code>Mailserver</code>.</p>
<!-- TODO: Clarify actual request with bloom filter to mailserver -->
<h2 id="changelog-13"><a class="header" href="#changelog-13">Changelog</a></h2>
<h3 id="version-01-4"><a class="header" href="#version-01-4">Version 0.1</a></h3>
<p>Released <a href="https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8">May 22, 2020</a></p>
<ul>
<li>Created document</li>
<li>Forked from <a href="status/deprecated/3-whisper-usage.html">3-whisper-usage</a></li>
<li>Change to keep <code>Mailserver</code> term consistent</li>
<li>Replaced Whisper references with Waku</li>
<li>Added <a href="status/deprecated/waku-usage.html#status">Status options</a> section</li>
<li>Updated <a href="status/deprecated/waku-usage.html#waku-packets">Waku packets</a> section to match Waku</li>
<li>Added that <code>Batch Ack</code> is marked for deprecation</li>
<li>Changed <code>shh_generateSymKeyFromPassword</code> to <code>waku_generateSymKeyFromPassword</code>
<ul>
<li><a href="https://github.com/status-im/status-go/blob/2d13ccf5ec3db7e48d7a96a7954be57edb96f12f/waku/api.go#L172-L175">Exists here</a></li>
<li><a href="https://github.com/status-im/status-go/blob/2d13ccf5ec3db7e48d7a96a7954be57edb96f12f/eth-node/bridge/geth/public_waku_api.go#L33-L36">Exists here</a></li>
</ul>
</li>
<li>Changed <code>shh_markTrustedPeer</code> to <code>waku_markTrustedPeer</code>
<ul>
<li><a href="https://github.com/status-im/status-go/blob/2d13ccf5ec3db7e48d7a96a7954be57edb96f12f/waku/api.go#L100-L108">Exists here</a></li>
</ul>
</li>
<li>Changed <code>shhext_requestMessages</code> to <code>wakuext_requestMessages</code>
<ul>
<li><a href="https://github.com/status-im/status-go/blob/2d13ccf5ec3db7e48d7a96a7954be57edb96f12f/services/wakuext/api.go#L76-L139">Exists here</a></li>
</ul>
</li>
</ul>
<h2 id="copyright-84"><a class="header" href="#copyright-84">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-71"><a class="header" href="#references-71">References</a></h2>
<ul>
<li><a href="status/deprecated/waku">Waku</a></li>
<li><a href="status/deprecated//waku/standards/legacy/6/waku1.html">WAKU1</a></li>
<li><a href="status/deprecated//status/deprecated/waku-mailserver.html">WAKU-MAILSERVER</a></li>
<li><a href="https://github.com/vacp2p/research/tree/dcc71f4779be832d3b5ece9c4e11f1f7ec24aac2/whisper_scalability">The theoretical scaling model</a></li>
<li><a href="status/deprecated//status/deprecated/secure-transport.html">SECURE-TRANSPORT</a></li>
<li><a href="https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8">May 22, 2020 commit</a></li>
<li><a href="https://github.com/ethereum/go-ethereum/wiki/Whisper-v6-RPC-API#shh_generatesymkeyfrompassword"><code>shh_generateSymKeyFromPassword</code></a></li>
<li><a href="https://github.com/status-im/status-go/blob/2d13ccf5ec3db7e48d7a96a7954be57edb96f12f/waku/api.go#L172-L175">Key Change #1</a></li>
<li><a href="https://github.com/status-im/status-go/blob/2d13ccf5ec3db7e48d7a96a7954be57edb96f12f/eth-node/bridge/geth/public_waku_api.go#L33-L36">Key Change #2</a></li>
<li><a href="https://github.com/status-im/status-go/blob/2d13ccf5ec3db7e48d7a96a7954be57edb96f12f/waku/api.go#L100-L108">Key Change #3</a></li>
<li><a href="https://github.com/status-im/status-go/blob/2d13ccf5ec3db7e48d7a96a7954be57edb96f12f/services/wakuext/api.go#L76-L139">Key Change #4</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="whisper-mailserver"><a class="header" href="#whisper-mailserver">WHISPER-MAILSERVER</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Whisper mailserver</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Adam Babik &lt;adam@status.im&gt;<br>Oskar Thorén &lt;oskar@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-89"><a class="header" href="#timeline-89">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/deprecated/whisper-mailserver.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/deprecated/whisper-mailserver.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/614348a4982aa9e519ccff8b8fbcd4c554683288/status/deprecated/whisper-mailserver.md"><code>614348a</code></a> — Status deprecated update2 (#134)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-62"><a class="header" href="#abstract-62">Abstract</a></h2>
<p>Being mostly offline is an intrinsic property of mobile clients.
They need to save network transfer and battery consumption
to avoid spending too much money or constant charging.
Whisper protocol, on the other hand, is an online protocol.
Messages are available in the Whisper network only for short period of time calculate in seconds.</p>
<p>Whisper <code>Mailserver</code> is a Whisper extension that allows to store messages permanently
and deliver them to the clients even though they are already not available in the network and expired.</p>
<h2 id="mailserver-1"><a class="header" href="#mailserver-1"><code>Mailserver</code></a></h2>
<p>From the network perspective, <code>Mailserver</code> is just like any other Whisper node.
The only difference is that it has a capability of archiving messages and delivering them to its peers on-demand.</p>
<p>It is important to notice that <code>Mailserver</code> will only handle requests from its direct peers
and exchanged packets between <code>Mailserver</code> and a peer are p2p messages.</p>
<h3 id="archiving-messages-1"><a class="header" href="#archiving-messages-1">Archiving messages</a></h3>
<p>A node which wants to provide <code>Mailserver</code> functionality MUST store envelopes
from incoming message packets (Whisper packet-code <code>0x01</code>).
The envelopes can be stored in any format,
however they MUST be serialized and deserialized to the Whisper envelope format.</p>
<p>A <code>Mailserver</code> SHOULD store envelopes for all topics to be generally useful for any peer,
however for specific use cases it MAY store envelopes for a subset of topics.</p>
<h3 id="requesting-messages-1"><a class="header" href="#requesting-messages-1">Requesting messages</a></h3>
<p>In order to request historic messages, a node MUST send a packet P2P Request (<code>0x7e</code>) to a peer providing <code>Mailserver</code> functionality.
This packet requires one argument which MUST be a Whisper envelope.</p>
<p>In the Whisper envelope's payload section, there MUST be RLP-encoded information about the details of the request:</p>
<pre><code class="language-golang">[ Lower, Upper, Bloom, Limit, Cursor ]
</code></pre>
<p><code>Lower</code>: 4-byte wide unsigned integer (UNIX time in seconds; oldest requested envelope's creation time)<br />
<code>Upper</code>: 4-byte wide unsigned integer (UNIX time in seconds; newest requested envelope's creation time)<br />
<code>Bloom</code>: 64-byte wide array of Whisper topics encoded in a bloom filter to filter envelopes<br />
<code>Limit</code>: 4-byte wide unsigned integer limiting the number of returned envelopes<br />
<code>Cursor</code>: an array of a cursor returned from the previous request (optional)</p>
<p>The <code>Cursor</code> field SHOULD be filled in
if a number of envelopes between <code>Lower</code> and <code>Upper</code> is greater than <code>Limit</code>
so that the requester can send another request using the obtained <code>Cursor</code> value.
What exactly is in the <code>Cursor</code> is up to the implementation.
The requester SHOULD NOT use a <code>Cursor</code> obtained from one <code>Mailserver</code> in a request to another <code>Mailserver</code>
because the format or the result MAY be different.</p>
<p>The envelope MUST be encrypted with a symmetric key agreed between the requester and <code>Mailserver</code>.</p>
<h3 id="receiving-historic-messages-1"><a class="header" href="#receiving-historic-messages-1">Receiving historic messages</a></h3>
<p>Historic messages MUST be sent to a peer as a packet with a P2P Message code (<code>0x7f</code>)
followed by an array of Whisper envelopes.
It is incompatible with the original Whisper spec (EIP-627) because it allows only a single envelope,
however, an array of envelopes is much more performant.
In order to stay compatible with EIP-627, a peer receiving historic message MUST handle both cases.</p>
<p>In order to receive historic messages from a <code>Mailserver</code>, a node MUST trust the selected <code>Mailserver</code>,
that is allowed to send packets with the P2P Message code. By default, the node discards such packets.</p>
<p>Received envelopes MUST be passed through the Whisper envelope pipelines
so that they are picked up by registered filters and passed to subscribers.</p>
<p>For a requester, to know that all messages have been sent by <code>Mailserver</code>,
it SHOULD handle P2P Request Complete code (<code>0x7d</code>). This code is followed by the following parameters:</p>
<pre><code class="language-golang">[ RequestID, LastEnvelopeHash, Cursor ]
</code></pre>
<p><code>RequestID</code>: 32-byte wide array with a Keccak-256 hash of the envelope containing the original request<br />
<code>LastEnvelopeHash</code>: 32-byte wide array with a Keccak-256 hash of the last sent envelope for the request<br />
<code>Cursor</code>: an array of a cursor returned from the previous request (optional)</p>
<p>If <code>Cursor</code> is not empty, it means that not all messages were sent due to the set <code>Limit</code> in the request.
One or more consecutive requests MAY be sent with <code>Cursor</code> field filled in order to receive the rest of the messages.</p>
<h2 id="security-considerations-29"><a class="header" href="#security-considerations-29">Security considerations</a></h2>
<h3 id="confidentiality-1"><a class="header" href="#confidentiality-1">Confidentiality</a></h3>
<p>The node encrypts all Whisper envelopes. A <code>Mailserver</code> node can not inspect their contents.</p>
<h3 id="altruistic-and-centralized-operator-risk-1"><a class="header" href="#altruistic-and-centralized-operator-risk-1">Altruistic and centralized operator risk</a></h3>
<p>In order to be useful, a <code>Mailserver</code> SHOULD be online most of the time. That means
users either have to be a bit tech-savvy to run their own node, or rely on someone
else to run it for them.</p>
<p>Currently, one of Status's legal entities provides <code>Mailservers</code> in an altruistic manner, but this is
suboptimal from a decentralization, continuance and risk point of view. Coming
up with a better system for this is ongoing research.</p>
<p>A Status client SHOULD allow the <code>Mailserver</code> selection to be customizable.</p>
<h3 id="privacy-concerns-1"><a class="header" href="#privacy-concerns-1">Privacy concerns</a></h3>
<p>In order to use a <code>Mailserver</code>, a given node needs to connect to it directly,
i.e. add the <code>Mailserver</code> as its peer and mark it as trusted.
This means that the <code>Mailserver</code> is able to send direct p2p messages to the node instead of broadcasting them.
Effectively, it will have access to the bloom filter of topics
that the user is interested in,
when it is online as well as many metadata like IP address.</p>
<h3 id="denial-of-service-1"><a class="header" href="#denial-of-service-1">Denial-of-service</a></h3>
<p>Since a <code>Mailserver</code> is delivering expired envelopes and has a direct TCP connection with the recipient,
the recipient is vulnerable to DoS attacks from a malicious <code>Mailserver</code> node.</p>
<h2 id="changelog-14"><a class="header" href="#changelog-14">Changelog</a></h2>
<h3 id="version-03-7"><a class="header" href="#version-03-7">Version 0.3</a></h3>
<p>Released <a href="https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8">May 22, 2020</a></p>
<ul>
<li>Change to keep <code>Mailserver</code> term consistent</li>
</ul>
<h2 id="copyright-85"><a class="header" href="#copyright-85">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-72"><a class="header" href="#references-72">References</a></h2>
<ul>
<li><a href="https://eips.ethereum.org/EIPS/eip-627">Whisper</a></li>
<li><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-627.md">EIP-627</a></li>
<li><a href="status/deprecated//status/deprecated/secure-transport.html">SECURE-TRANSPORT</a></li>
<li><a href="https://github.com/ethereum/go-ethereum/wiki/Whisper-v6-RPC-API#shh_generatesymkeyfrompassword"><code>shh_generateSymKeyFromPassword</code></a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-627">Whisper v6</a></li>
<li><a href="status/deprecated//waku/deprecated/5/waku0.html">Waku V0</a></li>
<li><a href="status/deprecated//waku/standards/legacy/6/waku1.html">Waku V1</a></li>
<li><a href="https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8">May 22, 2020 change commit</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="whisper-usage"><a class="header" href="#whisper-usage">WHISPER-USAGE</a></h1>
<div class="rfc-meta">
<table>
<tr><th>Name</th><td>Whisper Usage</td></tr>
<tr><th>Status</th><td>deprecated</td></tr>
<tr><th>Editor</th><td>Filip Dimitrijevic &lt;filip@status.im&gt;</td></tr>
<tr><th>Contributors</th><td>Adam Babik &lt;adam@status.im&gt;<br>Andrea Piana &lt;andreap@status.im&gt;<br>Corey Petty &lt;corey@status.im&gt;<br>Oskar Thorén &lt;oskar@status.im&gt;</td></tr>
</table>
</div>
<!-- timeline:start -->
<h2 id="timeline-90"><a class="header" href="#timeline-90">Timeline</a></h2>
<ul>
<li><strong>2025-12-22</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/b1a578393edf8487ccc97a5f25b25af9bf41efb3/docs/status/deprecated/whisper-usage.md"><code>b1a5783</code></a> — Chore/mdbook updates (#237)</li>
<li><strong>2025-12-18</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/d03e699084774ebecef9c6d4662498907c5e2080/docs/status/deprecated/whisper-usage.md"><code>d03e699</code></a> — ci: add mdBook configuration (#233)</li>
<li><strong>2025-04-29</strong> — <a href="https://github.com/vacp2p/rfc-index/blob/614348a4982aa9e519ccff8b8fbcd4c554683288/status/deprecated/whisper-usage.md"><code>614348a</code></a> — Status deprecated update2 (#134)</li>
</ul>
<!-- timeline:end -->
<h2 id="abstract-63"><a class="header" href="#abstract-63">Abstract</a></h2>
<p>Status uses <a href="https://eips.ethereum.org/EIPS/eip-627">Whisper</a> to provide
privacy-preserving routing and messaging on top of devP2P.
Whisper uses topics to partition its messages,
and these are leveraged for all chat capabilities.
In the case of public chats, the channel name maps directly to its Whisper topic.
This allows anyone to listen on a single channel.</p>
<p>Additionally, since anyone can receive Whisper envelopes,
it relies on the ability to decrypt messages to decide who is the correct recipient.
Status nodes do not rely upon this property,
and implement another secure transport layer on top of Whisper.</p>
<p>Finally, using an extension of Whisper provides the ability to do offline messaging.</p>
<h2 id="reason-2"><a class="header" href="#reason-2">Reason</a></h2>
<p>Provide routing, metadata protection, topic-based multicasting and basic
encryption properties to support asynchronous chat.</p>
<h2 id="terminology-11"><a class="header" href="#terminology-11">Terminology</a></h2>
<ul>
<li><em>Whisper node</em>: an Ethereum node with Whisper V6 enabled (in the case of go-ethereum, it's <code>--shh</code> option)</li>
<li><em>Whisper network</em>: a group of Whisper nodes connected together through the internet connection and forming a graph</li>
<li><em>Message</em>: a decrypted Whisper message</li>
<li><em>Offline message</em>: an archived envelope</li>
<li><em>Envelope</em>: an encrypted message with metadata like topic and Time-To-Live</li>
</ul>
<h2 id="whisper-packets"><a class="header" href="#whisper-packets">Whisper packets</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Packet Name</th><th style="text-align: right">Code</th><th>EIP-627</th><th>References</th></tr></thead><tbody>
<tr><td>Status</td><td style="text-align: right">0</td><td>✔</td><td><a href="status/deprecated/whisper-usage.html#handshake">Handshake</a></td></tr>
<tr><td>Messages</td><td style="text-align: right">1</td><td>✔</td><td><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-627.md">EIP-627</a></td></tr>
<tr><td>PoW Requirement</td><td style="text-align: right">2</td><td>✔</td><td><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-627.md">EIP-627</a></td></tr>
<tr><td>Bloom Filter</td><td style="text-align: right">3</td><td>✔</td><td><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-627.md">EIP-627</a></td></tr>
<tr><td>Batch Ack</td><td style="text-align: right">11</td><td>𝘅</td><td>Undocumented</td></tr>
<tr><td>Message Response</td><td style="text-align: right">12</td><td>𝘅</td><td>Undocumented</td></tr>
<tr><td>P2P Sync Request</td><td style="text-align: right">123</td><td>𝘅</td><td>Undocumented</td></tr>
<tr><td>P2P Sync Response</td><td style="text-align: right">124</td><td>𝘅</td><td>Undocumented</td></tr>
<tr><td>P2P Request Complete</td><td style="text-align: right">125</td><td>𝘅</td><td><a href="status/deprecated//status/deprecated/whisper-mailserver.html">4/WHISPER-MAILSERVER</a></td></tr>
<tr><td>P2P Request</td><td style="text-align: right">126</td><td>✔</td><td><a href="status/deprecated//status/deprecated/whisper-mailserver.html">4/WHISPER-MAILSERVER</a></td></tr>
<tr><td>P2P Messages</td><td style="text-align: right">127</td><td>✔/𝘅 (EIP-627 supports only single envelope in a packet)</td><td><a href="status/deprecated//status/deprecated/whisper-mailserver.html">4/WHISPER-MAILSERVER</a></td></tr>
</tbody></table>
</div>
<h2 id="whisper-node-configuration"><a class="header" href="#whisper-node-configuration">Whisper node configuration</a></h2>
<p>A Whisper node must be properly configured to receive messages from Status clients.</p>
<p>Nodes use Whisper's Proof Of Work algorithm to deter denial of service
and various spam/flood attacks against the Whisper network.
The sender of a message must perform some work which in this case means processing time.
Because Status' main client is a mobile client, this easily leads to battery draining and poor performance of the app itself.
Hence, all clients MUST use the following Whisper node settings:</p>
<ul>
<li>proof-of-work requirement not larger than <code>0.002</code></li>
<li>time-to-live not lower than <code>10</code> (in seconds)</li>
</ul>
<h2 id="handshake"><a class="header" href="#handshake">Handshake</a></h2>
<p>Handshake is a RLP-encoded packet sent to a newly connected peer. It MUST start with a Status Code (<code>0x00</code>) and follow up with items:</p>
<pre><code class="language-golang">[ protocolVersion, PoW, bloom, isLightNode, confirmationsEnabled, rateLimits ]
</code></pre>
<p><code>protocolVersion</code>: version of the Whisper protocol
<code>PoW</code>: minimum PoW accepted by the peer
<code>bloom</code>: bloom filter of Whisper topic accepted by the peer
<code>isLightNode</code>: when true, the peer won't forward messages
<code>confirmationsEnabled</code>: when true, the peer will send message confirmations
<code>rateLimits</code>: is <code>[ RateLimitIP, RateLimitPeerID, RateLimitTopic ]</code> where each values is an integer with a number of accepted packets per second per IP, Peer ID, and Topic respectively</p>
<p><code>bloom, isLightNode, confirmationsEnabled, and rateLimits</code> are all optional arguments in the handshake. However, if an optional field is specified, all optional fields preceding it MUST also be specified in order to be unambiguous.</p>
<h2 id="rate-limiting-1"><a class="header" href="#rate-limiting-1">Rate limiting</a></h2>
<p>In order to provide an optional very basic Denial-of-Service attack protection, each node SHOULD define its own rate limits.
The rate limits SHOULD be applied on IPs, peer IDs, and envelope topics.</p>
<p>Each node MAY decide to whitelist, i.e. do not rate limit, selected IPs or peer IDs.</p>
<p>If a peer exceeds node's rate limits, the connection between them MAY be dropped.</p>
<p>Each node SHOULD broadcast its rate limits to its peers using rate limits packet code (<code>0x14</code>). The rate limits is RLP-encoded information:</p>
<pre><code class="language-golang">[ IP limits, PeerID limits, Topic limits ]
</code></pre>
<p><code>IP limits</code>: 4-byte wide unsigned integer
<code>PeerID limits</code>: 4-byte wide unsigned integer
<code>Topic limits</code>: 4-byte wide unsigned integer</p>
<p>The rate limits MAY also be sent as an optional parameter in the handshake.</p>
<p>Each node SHOULD respect rate limits advertised by its peers.
The number of packets SHOULD be throttled in order not to exceed peer's rate limits.
If the limit gets exceeded, the connection MAY be dropped by the peer.</p>
<h2 id="keys-management-1"><a class="header" href="#keys-management-1">Keys management</a></h2>
<p>The protocol requires a key (symmetric or asymmetric) for the following actions:</p>
<ul>
<li>signing &amp; verifying messages (asymmetric key)</li>
<li>encrypting &amp; decrypting messages (asymmetric or symmetric key).</li>
</ul>
<p>As nodes require asymmetric keys and symmetric keys to process incoming messages,
they must be available all the time and are stored in memory.</p>
<p>Keys management for PFS is described in <a href="status/deprecated//status/deprecated/whisper-mailserver.html">5/SECURE-TRANSPORT</a>.</p>
<p>The Status protocols uses a few particular Whisper topics to achieve its goals.</p>
<h3 id="contact-code-topic-1"><a class="header" href="#contact-code-topic-1">Contact code topic</a></h3>
<p>Nodes use the contact code topic to facilitate the discovery of X3DH bundles so that the first message can be PFS-encrypted.</p>
<p>Each user publishes periodically to this topic.
If user A wants to contact user B, she SHOULD look for their bundle on this contact code topic.</p>
<p>Contact code topic MUST be created following the algorithm below:</p>
<pre><code class="language-golang">contactCode := "0x" + hexEncode(activePublicKey) + "-contact-code"

var hash []byte = keccak256(contactCode)
var topicLen int = 4

if len(hash) &lt; topicLen {
    topicLen = len(hash)
}

var topic [4]byte
for i = 0; i &lt; topicLen; i++ {
    topic[i] = hash[i]
}
</code></pre>
<h3 id="partitioned-topic-1"><a class="header" href="#partitioned-topic-1">Partitioned topic</a></h3>
<p>Whisper is broadcast-based protocol.
In theory, everyone could communicate using a single topic but that would be extremely inefficient.
Opposite would be using a unique topic for each conversation,
however, this brings privacy concerns because it would be much easier to detect whether
and when two parties have an active conversation.</p>
<p>Nodes use partitioned topics to broadcast private messages efficiently.
By selecting a number of topic, it is possible to balance efficiency and privacy.</p>
<p>Currently, nodes set the number of partitioned topics to <code>5000</code>.
They MUST be generated following the algorithm below:</p>
<pre><code class="language-golang">var partitionsNum *big.Int = big.NewInt(5000)
var partition *big.Int = big.NewInt(0).Mod(publicKey.X, partitionsNum)

partitionTopic := "contact-discovery-" + strconv.FormatInt(partition.Int64(), 10)

var hash []byte = keccak256(partitionTopic)
var topicLen int = 4

if len(hash) &lt; topicLen {
    topicLen = len(hash)
}

var topic [4]byte
for i = 0; i &lt; topicLen; i++ {
    topic[i] = hash[i]
}
</code></pre>
<h3 id="public-chats-1"><a class="header" href="#public-chats-1">Public chats</a></h3>
<p>A public chat MUST use a topic derived from a public chat name following the algorithm below:</p>
<pre><code class="language-golang">var hash []byte
hash = keccak256(name)

topicLen = 4
if len(hash) &lt; topicLen {
    topicLen = len(hash)
}

var topic [4]byte
for i = 0; i &lt; topicLen; i++ {
    topic[i] = hash[i]
}
</code></pre>
<!-- NOTE: commented out as it is currently not used.  In code for potential future use. - C.P. Oct 8, 2019
### Personal discovery topic

 Personal discovery topic is used to ???

A client MUST implement it following the algorithm below:
```golang
personalDiscoveryTopic := "contact-discovery-" + hexEncode(publicKey)

var hash []byte = keccak256(personalDiscoveryTopic)
var topicLen int = 4

if len(hash) < topicLen {
    topicLen = len(hash)
}

var topic [4]byte
for i = 0; i < topicLen; i++ {
    topic[i] = hash[i]
}
```

Each Status Client SHOULD listen to this topic in order to receive ??? -->
<!-- NOTE: commented out as it is no longer valid as of V1. - C.P. Oct 8, 2019
### Generic discovery topic

Generic discovery topic is a legacy topic used to handle all one-to-one chats. The newer implementation should rely on [Partitioned Topic](#partitioned-topic) and [Personal discovery topic](#personal-discovery-topic).

Generic discovery topic MUST be created following [Public chats](#public-chats) topic algorithm using string `contact-discovery` as a name. -->
<h3 id="group-chat-topic-1"><a class="header" href="#group-chat-topic-1">Group chat topic</a></h3>
<p>Group chats does not have a dedicated topic.
All group chat messages (including membership updates) are sent as one-to-one messages to multiple recipients.</p>
<h3 id="negotiated-topic-1"><a class="header" href="#negotiated-topic-1">Negotiated topic</a></h3>
<p>When a client sends a one to one message to another client, it MUST listen to their negotiated topic.
This is computed by generating a diffie-hellman key exchange between two members
and taking the first four bytes of the <code>SHA3-256</code> of the key generated.</p>
<pre><code class="language-golang">
sharedKey, err := ecies.ImportECDSA(myPrivateKey).GenerateShared(
      ecies.ImportECDSAPublic(theirPublicKey),
      16,
      16,
)


hexEncodedKey := hex.EncodeToString(sharedKey)

var hash []byte = keccak256(hexEncodedKey)
var topicLen int = 4

if len(hash) &lt; topicLen {
    topicLen = len(hash)
}

var topic [4]byte
for i = 0; i &lt; topicLen; i++ {
    topic[i] = hash[i]
}
</code></pre>
<p>A client SHOULD send to the negotiated topic only if it has received a message from all the devices included in the conversation.</p>
<h3 id="flow-12"><a class="header" href="#flow-12">Flow</a></h3>
<p>To exchange messages with client <code>B</code>, a client <code>A</code> SHOULD:</p>
<ul>
<li>Listen to client's <code>B</code> Contact Code Topic to retrieve their bundle information, including a list of active devices</li>
<li>Send a message on client's <code>B</code> partitioned topic</li>
<li>Listen to the Negotiated Topic between <code>A</code> &amp; <code>B</code></li>
<li>Once client <code>A</code> receives a message from <code>B</code>, the Negotiated Topic SHOULD be used</li>
</ul>
<h2 id="message-encryption-1"><a class="header" href="#message-encryption-1">Message encryption</a></h2>
<p>Even though, the protocol specifies an encryption layer that encrypts messages before passing them to the transport layer,
Whisper protocol requires each Whisper message to be encrypted anyway.</p>
<p>The node encrypts public and group messages using symmetric encryption, and creates the key from a channel name string.
The implementation is available in <a href="https://github.com/ethereum/go-ethereum/wiki/Whisper-v6-RPC-API#shh_generatesymkeyfrompassword"><code>shh_generateSymKeyFromPassword</code></a> JSON-RPC method of go-ethereum Whisper implementation.</p>
<p>The node encrypts one-to-one messages using asymmetric encryption.</p>
<h2 id="message-confirmations-1"><a class="header" href="#message-confirmations-1">Message confirmations</a></h2>
<p>Sending a message is a complex process where many things can go wrong.
Message confirmations tell a node that a message originating from it has been seen by its direct peers.</p>
<p>A node MAY send a message confirmation for any batch of messages received in a packet Messages Code (<code>0x01</code>).</p>
<p>A node sends a message confirmation using Batch Acknowledge packet (<code>0x0b</code>) or Message Response packet (<code>0x0c</code>).</p>
<p>The Batch Acknowledge packet is followed by a keccak256 hash of the envelopes batch data (raw bytes).</p>
<p>The Message Response packet is more complex and is followed by a Versioned Message Response:</p>
<pre><code class="language-golang">[ Version, Response]
</code></pre>
<p><code>Version</code>: a version of the Message Response, equal to <code>1</code>,
<code>Response</code>: <code>[ Hash, Errors ]</code> where <code>Hash</code> is a keccak256 hash of the envelopes batch data (raw bytes)
for which the confirmation is sent and <code>Errors</code> is a list of envelope errors when processing the batch.
A single error contains <code>[ Hash, Code, Description ]</code> where <code>Hash</code> is a hash of the processed envelope,
<code>Code</code> is an error code and <code>Description</code> is a descriptive error message.</p>
<p>The supported codes:
<code>1</code>: means time sync error which happens when an envelope is too old
or created in the future (the root cause is no time sync between nodes).</p>
<p>The drawback of sending message confirmations is that it increases the noise in the network because for each sent message,
one or more peers broadcast a corresponding confirmation.
To limit that, both Batch Acknowledge packet (<code>0x0b</code>) and Message Response packet (<code>0x0c</code>) are not broadcast to peers of the peers,
i.e. they do not follow epidemic spread.</p>
<p>In the current Status network setup, only <code>Mailservers</code> support message confirmations.
A client posting a message to the network and after receiving a confirmation can be sure that the message got processed by the <code>Mailserver</code>.
If additionally, sending a message is limited to non-<code>Mailserver</code> peers,
it also guarantees that the message got broadcast through the network and it reached the selected <code>Mailserver</code>.</p>
<h2 id="whisper--waku-bridging"><a class="header" href="#whisper--waku-bridging">Whisper / Waku bridging</a></h2>
<p>In order to maintain compatibility between Whisper and Waku nodes,
a Status network that implements both Whisper and Waku messaging protocols
MUST have at least one node that is capable of discovering peers and implements
<a href="https://eips.ethereum.org/EIPS/eip-627">Whisper v6</a>,
<a href="status/deprecated//waku/deprecated/5/waku0.html">Waku V0</a> and
<a href="status/deprecated//waku/standards/legacy/6/waku1.html">Waku V1</a> specifications.</p>
<p>Additionally, any Status network that implements both Whisper and Waku messaging protocols
MUST implement bridging capabilities as detailed in
<a href="status/deprecated//waku/standards/legacy/6/waku1.html#waku-whisper-bridging">Waku V1#Bridging</a>.</p>
<h2 id="whisper-v6-extensions"><a class="header" href="#whisper-v6-extensions">Whisper V6 extensions</a></h2>
<h3 id="request-historic-messages-1"><a class="header" href="#request-historic-messages-1">Request historic messages</a></h3>
<p>Sends a request for historic messages to a <code>Mailserver</code>.
The <code>Mailserver</code> node MUST be a direct peer and MUST be marked as trusted (using <code>shh_markTrustedPeer</code>).</p>
<p>The request does not wait for the response.
It merely sends a peer-to-peer message to the <code>Mailserver</code>
and it's up to <code>Mailserver</code> to process it and start sending historic messages.</p>
<p>The drawback of this approach is that it is impossible to tell
which historic messages are the result of which request.</p>
<p>It's recommended to return messages from newest to oldest.
To move further back in time, use <code>cursor</code> and <code>limit</code>.</p>
<h4 id="shhext_requestmessages"><a class="header" href="#shhext_requestmessages">shhext_requestMessages</a></h4>
<p><strong>Parameters</strong>:</p>
<ol>
<li>Object - The message request object:
<ul>
<li><code>mailServerPeer</code> - <code>String</code>: <code>Mailserver</code>'s enode address.</li>
<li><code>from</code> - <code>Number</code> (optional): Lower bound of time range as unix timestamp, default is 24 hours back from now.</li>
<li><code>to</code> - <code>Number</code> (optional): Upper bound of time range as unix timestamp, default is now.</li>
<li><code>limit</code> - <code>Number</code> (optional): Limit the number of messages sent back, default is no limit.</li>
<li><code>cursor</code> - <code>String</code> (optional): Used for paginated requests.</li>
<li><code>topics</code> - <code>Array</code>: hex-encoded message topics.</li>
<li><code>symKeyID</code> - <code>String</code>: an ID of a symmetric key used to authenticate with the <code>Mailserver</code>, derived from Mailserver password.</li>
</ul>
</li>
</ol>
<p><strong>Returns</strong>:
<code>Boolean</code> - returns <code>true</code> if the request was sent.</p>
<p>The above <code>topics</code> is then converted into a bloom filter and then and sent to the <code>Mailserver</code>.</p>
<!-- TODO: Clarify actual request with bloom filter to mailserver -->
<h2 id="changelog-15"><a class="header" href="#changelog-15">Changelog</a></h2>
<h3 id="version-03-8"><a class="header" href="#version-03-8">Version 0.3</a></h3>
<p>Released <a href="https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8">May 22, 2020</a></p>
<ul>
<li>Added Whisper / Waku Bridging section</li>
<li>Change to keep <code>Mailserver</code> term consistent</li>
</ul>
<h2 id="copyright-86"><a class="header" href="#copyright-86">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
<h2 id="references-73"><a class="header" href="#references-73">References</a></h2>
<ul>
<li><a href="https://eips.ethereum.org/EIPS/eip-627">Whisper</a></li>
<li><a href="status/deprecated//status/deprecated/whisper-mailserver.html">WHISPER-MAILSERVER</a></li>
<li><a href="status/deprecated//status/deprecated/secure-transport.html">SECURE-TRANSPORT</a></li>
<li><a href="https://github.com/ethereum/go-ethereum/wiki/Whisper-v6-RPC-API#shh_generatesymkeyfrompassword"><code>shh_generateSymKeyFromPassword</code></a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-627">Whisper v6</a></li>
<li><a href="status/deprecated//waku/deprecated/5/waku0.html">Waku V0</a></li>
<li><a href="status/deprecated//waku/standards/legacy/6/waku1.html">Waku V1</a></li>
<li><a href="https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8">May 22, 2020 change commit</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="scripts/rfc-index.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
